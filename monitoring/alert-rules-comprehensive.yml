# Comprehensive Alert Rules for Titan Trading System
# Requirements: 7.3 - Comprehensive monitoring dashboards and alerting

groups:
  # ============================================================================
  # System Health Alerts
  # ============================================================================
  - name: titan.system.health
    rules:
      - alert: ServiceDown
        expr: up{job=~"titan-.*"} == 0
        for: 30s
        labels:
          severity: critical
          component: "{{ $labels.job }}"
        annotations:
          summary: "Titan service {{ $labels.job }} is down"
          description: "Service {{ $labels.job }} on {{ $labels.instance }} has been down for more than 30 seconds"
          runbook_url: "https://docs.titan.com/runbooks/service-down"

      - alert: HighMemoryUsage
        expr: (titan_process_resident_memory_bytes / 1024 / 1024) > 400
        for: 5m
        labels:
          severity: warning
          component: "{{ $labels.job }}"
        annotations:
          summary: "High memory usage on {{ $labels.job }}"
          description: "Memory usage is {{ $value }}MB on {{ $labels.instance }}"
          runbook_url: "https://docs.titan.com/runbooks/high-memory"

      - alert: HighCPUUsage
        expr: rate(titan_process_cpu_seconds_total[5m]) * 100 > 80
        for: 5m
        labels:
          severity: warning
          component: "{{ $labels.job }}"
        annotations:
          summary: "High CPU usage on {{ $labels.job }}"
          description: "CPU usage is {{ $value }}% on {{ $labels.instance }}"
          runbook_url: "https://docs.titan.com/runbooks/high-cpu"

  # ============================================================================
  # Trading System Alerts
  # ============================================================================
  - name: titan.trading.alerts
    rules:
      - alert: CircuitBreakerActivated
        expr: titan_brain_circuit_breaker_active == 1
        for: 0s
        labels:
          severity: critical
          component: brain
        annotations:
          summary: "Circuit breaker activated"
          description: "Emergency circuit breaker has been activated, all trading halted"
          runbook_url: "https://docs.titan.com/runbooks/circuit-breaker"

      - alert: HighDrawdown
        expr: titan_brain_daily_drawdown_percent > 5
        for: 1m
        labels:
          severity: critical
          component: brain
        annotations:
          summary: "High drawdown detected"
          description: "Daily drawdown is {{ $value }}%, exceeding 5% threshold"
          runbook_url: "https://docs.titan.com/runbooks/high-drawdown"

      - alert: DrawdownWarning
        expr: titan_brain_daily_drawdown_percent > 3
        for: 2m
        labels:
          severity: warning
          component: brain
        annotations:
          summary: "Drawdown warning"
          description: "Daily drawdown is {{ $value }}%, approaching warning threshold"
          runbook_url: "https://docs.titan.com/runbooks/drawdown-warning"

      - alert: LowEquity
        expr: titan_brain_current_equity < 200
        for: 1m
        labels:
          severity: critical
          component: brain
        annotations:
          summary: "Low equity alert"
          description: "Current equity is ${{ $value }}, below minimum threshold"
          runbook_url: "https://docs.titan.com/runbooks/low-equity"

  # ============================================================================
  # Performance Alerts
  # ============================================================================
  - name: titan.performance.alerts
    rules:
      - alert: HighSignalLatency
        expr: histogram_quantile(0.95, rate(titan_brain_signal_processing_latency_ms_bucket[5m])) > 100
        for: 2m
        labels:
          severity: warning
          component: brain
        annotations:
          summary: "High signal processing latency"
          description: "95th percentile signal processing latency is {{ $value }}ms"
          runbook_url: "https://docs.titan.com/runbooks/high-latency"

      - alert: HighOrderLatency
        expr: histogram_quantile(0.95, rate(titan_order_latency_seconds_bucket[5m])) > 1
        for: 2m
        labels:
          severity: warning
          component: execution
        annotations:
          summary: "High order execution latency"
          description: "95th percentile order latency is {{ $value }}s"
          runbook_url: "https://docs.titan.com/runbooks/order-latency"

      - alert: LowOrderFillRate
        expr: titan_order_fill_rate < 80
        for: 5m
        labels:
          severity: warning
          component: execution
        annotations:
          summary: "Low order fill rate"
          description: "Order fill rate is {{ $value }}%, below 80% threshold"
          runbook_url: "https://docs.titan.com/runbooks/low-fill-rate"

      - alert: DatabaseSlowQueries
        expr: histogram_quantile(0.95, rate(titan_brain_database_query_duration_ms_bucket[5m])) > 1000
        for: 3m
        labels:
          severity: warning
          component: brain
        annotations:
          summary: "Slow database queries detected"
          description: "95th percentile query time is {{ $value }}ms"
          runbook_url: "https://docs.titan.com/runbooks/slow-queries"

  # ============================================================================
  # Connection and Integration Alerts
  # ============================================================================
  - name: titan.connections.alerts
    rules:
      - alert: WebSocketDisconnected
        expr: titan_health_status{component="websocket"} == 0
        for: 30s
        labels:
          severity: warning
          component: "{{ $labels.job }}"
        annotations:
          summary: "WebSocket connection lost"
          description: "WebSocket connection is down on {{ $labels.instance }}"
          runbook_url: "https://docs.titan.com/runbooks/websocket-down"

      - alert: BrokerConnectionLost
        expr: titan_health_status{component="broker"} == 0
        for: 1m
        labels:
          severity: critical
          component: execution
        annotations:
          summary: "Broker connection lost"
          description: "Connection to trading broker is down"
          runbook_url: "https://docs.titan.com/runbooks/broker-connection"

      - alert: DatabaseConnectionLost
        expr: titan_brain_health_status{component="database"} == 0
        for: 30s
        labels:
          severity: critical
          component: brain
        annotations:
          summary: "Database connection lost"
          description: "Connection to PostgreSQL database is down"
          runbook_url: "https://docs.titan.com/runbooks/database-connection"

      - alert: IPCConnectionLost
        expr: titan_scavenger_health_status{component="ipc"} == 0
        for: 1m
        labels:
          severity: warning
          component: scavenger
        annotations:
          summary: "IPC connection lost"
          description: "Fast Path IPC connection between scavenger and execution is down"
          runbook_url: "https://docs.titan.com/runbooks/ipc-connection"

  # ============================================================================
  # Business Logic Alerts
  # ============================================================================
  - name: titan.business.alerts
    rules:
      - alert: NoSignalsGenerated
        expr: rate(titan_scavenger_signals_generated_total[10m]) == 0
        for: 10m
        labels:
          severity: warning
          component: scavenger
        annotations:
          summary: "No signals generated"
          description: "Scavenger has not generated any signals in the last 10 minutes"
          runbook_url: "https://docs.titan.com/runbooks/no-signals"

      - alert: HighSignalRejectionRate
        expr: rate(titan_brain_decisions_total{approved="false"}[5m]) / rate(titan_brain_decisions_total[5m]) > 0.8
        for: 5m
        labels:
          severity: warning
          component: brain
        annotations:
          summary: "High signal rejection rate"
          description: "Brain is rejecting {{ $value | humanizePercentage }} of signals"
          runbook_url: "https://docs.titan.com/runbooks/high-rejection"

      - alert: ExcessiveLeverage
        expr: titan_brain_current_leverage > 40
        for: 1m
        labels:
          severity: warning
          component: brain
        annotations:
          summary: "Excessive leverage detected"
          description: "Current leverage is {{ $value }}x, approaching maximum"
          runbook_url: "https://docs.titan.com/runbooks/excessive-leverage"

      - alert: TooManyOpenPositions
        expr: titan_active_positions > 10
        for: 2m
        labels:
          severity: warning
          component: execution
        annotations:
          summary: "Too many open positions"
          description: "Currently {{ $value }} open positions, may indicate risk concentration"
          runbook_url: "https://docs.titan.com/runbooks/too-many-positions"

  # ============================================================================
  # Cache and Performance Alerts
  # ============================================================================
  - name: titan.cache.alerts
    rules:
      - alert: LowCacheHitRate
        expr: rate(titan_brain_cache_requests_total{result="hit"}[5m]) / rate(titan_brain_cache_requests_total[5m]) < 0.7
        for: 5m
        labels:
          severity: warning
          component: brain
        annotations:
          summary: "Low cache hit rate"
          description: "Cache hit rate is {{ $value | humanizePercentage }}, below 70%"
          runbook_url: "https://docs.titan.com/runbooks/low-cache-hit"

      - alert: HighErrorRate
        expr: rate(titan_errors_total[5m]) > 0.1
        for: 2m
        labels:
          severity: warning
          component: "{{ $labels.job }}"
        annotations:
          summary: "High error rate"
          description: "Error rate is {{ $value }} errors/second on {{ $labels.instance }}"
          runbook_url: "https://docs.titan.com/runbooks/high-errors"

  # ============================================================================
  # Disk and Storage Alerts
  # ============================================================================
  - name: titan.storage.alerts
    rules:
      - alert: LowDiskSpace
        expr: (node_filesystem_avail_bytes{mountpoint="/"} / node_filesystem_size_bytes{mountpoint="/"}) * 100 < 10
        for: 5m
        labels:
          severity: critical
          component: system
        annotations:
          summary: "Low disk space"
          description: "Disk space is {{ $value }}% full"
          runbook_url: "https://docs.titan.com/runbooks/low-disk-space"

      - alert: DatabaseSizeGrowth
        expr: increase(titan_database_size_bytes[1h]) > 100000000  # 100MB growth per hour
        for: 0s
        labels:
          severity: warning
          component: brain
        annotations:
          summary: "Rapid database growth"
          description: "Database grew by {{ $value | humanizeBytes }} in the last hour"
          runbook_url: "https://docs.titan.com/runbooks/database-growth"

  # ============================================================================
  # Configuration and Deployment Alerts
  # ============================================================================
  - name: titan.config.alerts
    rules:
      - alert: ConfigurationReloadFailed
        expr: increase(titan_config_reload_failures_total[5m]) > 0
        for: 0s
        labels:
          severity: warning
          component: "{{ $labels.job }}"
        annotations:
          summary: "Configuration reload failed"
          description: "Failed to reload configuration on {{ $labels.instance }}"
          runbook_url: "https://docs.titan.com/runbooks/config-reload-failed"

      - alert: ServiceRestartLoop
        expr: increase(titan_service_restarts_total[10m]) > 3
        for: 0s
        labels:
          severity: critical
          component: "{{ $labels.job }}"
        annotations:
          summary: "Service restart loop detected"
          description: "Service {{ $labels.job }} has restarted {{ $value }} times in 10 minutes"
          runbook_url: "https://docs.titan.com/runbooks/restart-loop"
name: Rust Services Pipeline

on:
  workflow_call:
    inputs:
      rust-version:
        type: string
        default: '1.89.0'
    outputs:
      status:
        description: "Status of the Rust services job"
        value: ${{ jobs.rust-services.result }}

jobs:
  rust-services:
    name: Canonical Rust
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.1.3

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: ${{ inputs.rust-version }}
          components: rustfmt, clippy

      - name: Rust Cache
        uses: swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2.7.3
        with:
          workspaces: services/titan-execution-rs
          cache-on-failure: true
          shared-key: titan-execution-rs-${{ hashFiles('services/titan-execution-rs/Cargo.lock') }}

      - name: Canonical Rust Pipeline
        env:
          NATS_URL: nats://localhost:4222
          RUST_LOG: info
        run: ./scripts/ci/rust.sh all

      - name: Verify Docker Build
        run: docker build -t titan-execution-rs:${{ github.sha }} services/titan-execution-rs

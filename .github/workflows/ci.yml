name: Titan Monorepo CI

on:
  push:
    branches: [main, develop, 'codex/**']
    paths-ignore:
      - 'docs/**'
      - '**.md'
      - 'LICENSE'
  pull_request:
    branches: [main, develop]
    paths-ignore:
      - 'docs/**'
      - '**.md'
      - 'LICENSE'
  merge_group:
    types: [checks_requested]
  schedule:
    - cron: '17 7 * * *'
  workflow_dispatch:

concurrency:
  group: ci-${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

env:
  NODE_VERSION: '22.19.0'
  NPM_VERSION: '11.6.2'
  RUST_VERSION: '1.89.0'

jobs:
  changes:
    name: changes
    runs-on: ubuntu-latest
    outputs:
      tier: ${{ steps.detect.outputs.tier }}
      run_node: ${{ steps.detect.outputs.run_node }}
      run_rust: ${{ steps.detect.outputs.run_rust }}
      run_docs: ${{ steps.detect.outputs.run_docs }}
      run_security: ${{ steps.detect.outputs.run_security }}
      run_contracts: ${{ steps.detect.outputs.run_contracts }}
      run_hygiene: ${{ steps.detect.outputs.run_hygiene }}
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.1.3
        with:
          fetch-depth: 2 # improved depth for diffing

      - name: Detect changed scopes
        id: detect
        shell: bash
        run: ./scripts/ci/changed_paths.sh

  preflight:
    name: preflight
    needs: changes
    if: ${{ github.event_name != 'schedule' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.1.3
        with:
          fetch-depth: 0

      - name: Setup Environment
        uses: ./.github/actions/setup
        with:
          node-version: ${{ env.NODE_VERSION }}
          npm-version: ${{ env.NPM_VERSION }}

      - name: Validate configuration
        if: ${{ needs.changes.outputs.tier != 'A' }}
        run: ./scripts/ci/config_validate.sh

      - name: Check Contracts & Schemas
        if: ${{ needs.changes.outputs.run_contracts == 'true' }}
        run: ./scripts/ci/contracts.sh

      - name: SOTA Hygiene & Docs
        if: ${{ needs.changes.outputs.run_hygiene == 'true' || needs.changes.outputs.run_docs == 'true' }}
        run: ./scripts/ci/sota.sh

      - name: Verify Documentation Invariants
        if: ${{ needs.changes.outputs.run_docs == 'true' }}
        run: ./scripts/verify-docs.sh

  node-services:
    name: node-services
    needs: [changes, preflight]
    if: ${{ github.event_name != 'schedule' && needs.changes.outputs.run_node == 'true' }}
    uses: ./.github/workflows/reusable-node.yml
    with:
      node-version: '22.19.0'
      npm-version: '11.6.2'

  quality-gate:
    name: quality-gate
    needs: [changes, preflight]
    if: ${{ github.event_name != 'schedule' }}
    uses: ./.github/workflows/quality-gate.yml
    with:
      node-version: '22.19.0'
      npm-version: '11.6.2'
      risk-tier: ${{ needs.changes.outputs.tier }}

  rust-services:
    name: titan-execution-rs
    needs: [changes]
    if: ${{ github.event_name != 'schedule' && needs.changes.outputs.run_rust == 'true' }}
    uses: ./.github/workflows/reusable-rust.yml
    with:
      rust-version: '1.89.0'

  security-scan:
    name: security-scan
    needs: [changes]
    if: ${{ github.event_name != 'schedule' && needs.changes.outputs.run_security == 'true' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.1.3

      - name: Setup Environment
        uses: ./.github/actions/setup
        with:
          node-version: ${{ env.NODE_VERSION }}
          npm-version: ${{ env.NPM_VERSION }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache cargo-audit
        id: cache-cargo-audit
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v4.0.1
        with:
          path: ~/.cargo/bin/cargo-audit
          key: cargo-audit-0.22.1

      - name: Install cargo-audit
        if: steps.cache-cargo-audit.outputs.cache-hit != 'true'
        run: cargo install --locked cargo-audit --version 0.22.1

      - name: Canonical Security Scan
        run: ./scripts/ci/security.sh

  nightly-security:
    name: nightly-security
    if: ${{ github.event_name == 'schedule' }}
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.1.3

      - name: Setup Environment
        uses: ./.github/actions/setup
        with:
          node-version: ${{ env.NODE_VERSION }}
          npm-version: ${{ env.NPM_VERSION }}

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@f7ccc83f9ed1e5b9c81d8a67d7ad1a747e22a561 # master
        with:
          toolchain: ${{ env.RUST_VERSION }}

      - name: Cache cargo-audit
        id: cache-cargo-audit
        uses: actions/cache@cdf6c1fa76f9f475f3d7449005a359c84ca0f306 # v4.0.1
        with:
          path: ~/.cargo/bin/cargo-audit
          key: cargo-audit-0.22.1

      - name: Install cargo-audit
        if: steps.cache-cargo-audit.outputs.cache-hit != 'true'
        run: cargo install --locked cargo-audit --version 0.22.1

      - name: Run full dependency audits
        run: |
          mkdir -p .generated/ci
          npm audit --json > .generated/ci/npm-audit.json || true
          (cd services/titan-execution-rs && cargo audit > ../../.generated/ci/cargo-audit.txt) || true

      - name: Generate SBOM
        uses: anchore/sbom-action@28d71544de8eaf1b958d335707167c5f783590ad # v0.15.9
        with:
          path: .
          format: cyclonedx-json
          output-file: .generated/ci/sbom.cdx.json

      - name: Upload nightly security artifacts
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4.3.1
        with:
          name: nightly-security-${{ github.run_id }}
          path: .generated/ci

  status-check:
    name: CI Pipeline Status
    runs-on: ubuntu-latest
    if: ${{ always() && github.event_name != 'schedule' }}
    needs: [changes, preflight, node-services, rust-services, security-scan, quality-gate]
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.1.3

      - name: Canonical Status Gate
        shell: bash
        env:
          STATUS_PREFLIGHT: ${{ needs.preflight.result }}
          STATUS_NODE: ${{ needs.node-services.result }}
          STATUS_RUST: ${{ needs.rust-services.result }}
          STATUS_SECURITY: ${{ needs.security-scan.result }}
        run: ./scripts/ci/status_gate.sh

name: Titan Monorepo CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ===========================================================================
  # Preflight: Fail Fast (Config, Contracts, Hygiene)
  # ===========================================================================
  preflight:
    name: preflight
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Required for git diff in Turbo

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies (Root)
        run: npm ci

      - name: Validate configuration
        run: npm run validate:config

      - name: Validate environment variables (Dry Run)
        run: npx ts-node scripts/ops/validate_env.ts
        env:
          HMAC_SECRET: 'ci_secret'
          TITAN_MASTER_PASSWORD: 'ci_password'
          DATABASE_URL: 'postgres://user:pass@localhost:5432/db'
          NATS_SYS_PASSWORD: 'ci_sys_pass'
          NATS_BRAIN_PASSWORD: 'ci_brain_pass'
          NATS_EXECUTION_PASSWORD: 'ci_exec_pass'
          NATS_SCAVENGER_PASSWORD: 'ci_scav_pass'
          NATS_HUNTER_PASSWORD: 'ci_hunter_pass'
          NATS_SENTINEL_PASSWORD: 'ci_sentinel_pass'
          NATS_POWERLAW_PASSWORD: 'ci_powerlaw_pass'
          NATS_QUANT_PASSWORD: 'ci_quant_pass'
          NATS_CONSOLE_PASSWORD: 'ci_console_pass'

      - name: Check Contract Drift
        # Only run if relevant files changed, or just run it (it's fast enough if no regen)
        run: ./scripts/ci/check_contracts.sh

      - name: SOTA Hygiene Checks
        run: |
            npm run sota:zombie
            npm run sota:circular
            npm run sota:immutability
            
      - name: Check Dead Code (knip)
        run: |
          UNUSED=$(npx knip --no-progress 2>&1 | grep -c "^Unused files" || true)
          if npx knip --no-progress 2>&1 | grep -q "^Unused files"; then
            echo "‚ùå Dead code detected!"
            npx knip --no-progress 2>&1 | head -30
            exit 1
          fi

  # ===========================================================================
  # Node.js: Selective Build & Test (Turbo)
  # ===========================================================================
  node-services:
    name: node-services
    needs: preflight
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies (Root)
        run: npm ci

      - name: Start NATS (for integration tests)
        run: |
          docker run -d --name nats -p 4222:4222 -p 8222:8222 nats:2.10.22-alpine -js -m 8222
          # Wait loop
          for i in {1..30}; do
            if wget --no-verbose --spider --tries=1 http://localhost:8222/varz; then exit 0; fi
            sleep 1
          done
          exit 1

      - name: Turbo Build & Test
        env:
          NATS_URL: nats://localhost:4222
        run: |
          # Determine filter argument
          if [ "${{ github.event_name }}" == "pull_request" ]; then
            FILTER="--filter=...[origin/main...HEAD]"
            echo "üîé PR Detected: Running only affected packages ($FILTER)"
          else
            FILTER="" # Run all on main
            echo "üåç Main/Push Detected: Running all packages"
          fi
          
          # Run build, lint, test
          # Note: We rely on Turbo caching to skip work on main if unchanged
          npx turbo run build lint test $FILTER

  # ===========================================================================
  # Rust Services (Pinned & Cached)
  # ===========================================================================
  rust-services:
    name: titan-execution-rs
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/titan-execution-rs
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.89.0
          components: rustfmt, clippy

      - name: Rust Cache
        uses: swatinem/rust-cache@v2
        with:
            workspaces: services/titan-execution-rs

      - name: Check Formatting
        run: cargo fmt -- --check

      - name: Lint (Clippy)
        run: cargo clippy -- -D warnings

      - name: Start NATS
        run: |
          docker run -d --name nats -p 4222:4222 -p 8222:8222 nats:2.10.22-alpine -js -m 8222
          for i in {1..30}; do if wget --no-verbose --spider --tries=1 http://localhost:8222/varz; then exit 0; fi; sleep 0.5; done
          exit 1

      - name: Run Tests
        env:
          NATS_URL: nats://localhost:4222
          RUST_LOG: info
        run: cargo test

      - name: Build
        run: cargo build --release

  # ===========================================================================
  # Security Scan (Policy Gate)
  # ===========================================================================
  security-scan:
    name: security-scan
    runs-on: ubuntu-latest
    # Run on PRs and Push, but maybe skip if only docs changed? 
    # For now, keep it simple.
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
      - uses: dtolnay/rust-toolchain@master
        with:
          toolchain: 1.89.0
      - run: npm ci
      - name: NPM Audit (High/Critical)
        run: npm audit --audit-level=high
      - name: Cargo Audit
        working-directory: services/titan-execution-rs
        run: |
            cargo install cargo-audit
            cargo audit

  # ===========================================================================
  # Status Aggregator (Required Check)
  # ===========================================================================
  status-check:
    name: CI Pipeline Status
    runs-on: ubuntu-latest
    if: always()
    needs: [preflight, node-services, rust-services, security-scan]
    steps:
      - name: Check Results
        run: |
           # Helper to check status
           check_status() {
             if [ "$1" == "failure" ] || [ "$1" == "cancelled" ]; then 
               echo "‚ùå Job failed or cancelled"
               exit 1
             fi
           }
           
           check_status "${{ needs.preflight.result }}"
           check_status "${{ needs.node-services.result }}"
           check_status "${{ needs.rust-services.result }}"
           check_status "${{ needs.security-scan.result }}"
           
           echo "‚úÖ All Checks Passed"

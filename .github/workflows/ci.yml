name: Titan Monorepo CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  # ===========================================================================
  # Configuration Validation
  # ===========================================================================
  config-validation:
    name: config-validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies (Root)
        run: npm ci

      - name: Validate configuration
        run: npm run validate:config

  # ===========================================================================
  # SOTA Standards Check (Architecture & Hygiene)
  # ===========================================================================
  sota-checks:
    name: sota-checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies (Root)
        run: npm ci

      - name: Install Python dependencies
        run: pip install pyyaml

      - name: Check Zombie Dependencies
        run: npm run sota:zombie

      - name: Check Circular Dependencies
        run: npm run sota:circular

      - name: Check Immutability Violations
        run: npm run sota:immutability -- --max-warnings=0

      - name: Check Dead Code (knip)
        run: |
          UNUSED=$(npx knip --no-progress 2>&1 | grep -c "^Unused files" || true)
          if npx knip --no-progress 2>&1 | grep -q "^Unused files"; then
            echo "❌ Dead code detected! Run 'npx knip' locally to see details."
            npx knip --no-progress 2>&1 | head -30
            exit 1
          fi
          echo "✅ No unused files detected"

  # ===========================================================================
  # Security Vulnerability Scanning (P0-003)
  # ===========================================================================
  security-scan:
    name: security-scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true

      - name: Install cargo-audit
        run: cargo install cargo-audit

      - name: Install dependencies (Root)
        run: npm ci

      - name: NPM Audit (High/Critical only)
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Cargo Audit
        working-directory: services/titan-execution-rs
        run: cargo audit
        continue-on-error: true

      - name: Generate SBOM (Node.js)
        run: |
          npx @cyclonedx/cyclonedx-npm --output-file sbom-nodejs.json
          echo "✅ Node.js SBOM generated: sbom-nodejs.json"

      - name: Generate SBOM (Rust)
        working-directory: services/titan-execution-rs
        run: |
          cargo install cargo-sbom || true
          cargo sbom > sbom-rust.json 2>/dev/null || echo '{"note": "cargo-sbom not available"}' > sbom-rust.json
          echo "✅ Rust SBOM generated: sbom-rust.json"

      - name: Upload SBOMs
        uses: actions/upload-artifact@v3
        with:
          name: sbom-artifacts
          path: |
            sbom-nodejs.json
            services/titan-execution-rs/sbom-rust.json

  # ===========================================================================
  # Contract Drift Check (Shipping Gate)
  # ===========================================================================
  contract-check:
    name: contract-check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Check Contract Drift
        run: ./scripts/ci/check_contracts.sh

  # ===========================================================================
  # Node.js Services Matrix (Lint, Test, Build)
  # ===========================================================================
  node-services:
    name: ${{ matrix.service }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - services/titan-brain
          - services/titan-phase1-scavenger
          - services/titan-phase2-hunter
          - services/titan-phase3-sentinel
          - services/titan-ai-quant
          - services/shared
          - services/titan-console

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies (Root)
        run: npm ci

      - name: Install dependencies (${{ matrix.service }})
        working-directory: ${{ matrix.service }}
        run: npm ci

      - name: Lint
        working-directory: ${{ matrix.service }}
        run: npm run lint --if-present

      - name: Test
        working-directory: ${{ matrix.service }}
        # Run test:unit if available, otherwise test, or skip if neither exists
        run: |
          if npm run | grep -q "test:unit"; then
            npm run test:unit
          elif npm run | grep -q "test"; then
            npm run test
          else
            echo "No test script found, skipping"
          fi

      - name: Build
        working-directory: ${{ matrix.service }}
        run: npm run build --if-present

  # ===========================================================================
  # Rust Services (Separate Job)
  # ===========================================================================
  rust-services:
    name: titan-execution-rs
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/titan-execution-rs

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
          components: rustfmt, clippy

      - name: Check Formatting
        run: cargo fmt -- --check

      - name: Lint (Clippy)
        run: cargo clippy -- -D warnings

      - name: Start NATS
        run: |
          docker run -d --name nats -p 4222:4222 nats:2.10.22-alpine -js -m 8222
          echo "Waiting for NATS..."
          for i in {1..30}; do
            if wget --no-verbose --spider --tries=1 http://localhost:8222/varz; then
              echo "NATS is up"
              exit 0
            fi
            sleep 1
          done
          echo "NATS failed to start"
          docker logs nats
          exit 1

      - name: Run Tests
        env:
          NATS_URL: nats://localhost:4222
          RUST_LOG: info
        run: cargo test

      - name: Build
        run: cargo build --release

  # ===========================================================================
  # Final Status Check
  # ===========================================================================
  status-check:
    name: CI Pipeline Status
    runs-on: ubuntu-latest
    needs: [config-validation, sota-checks, security-scan, contract-check, node-services, rust-services]
    if: always()
    steps:
      - name: Check Results
        run: |
          if [ "${{ needs.config-validation.result }}" == "failure" ] || \
             [ "${{ needs.sota-checks.result }}" == "failure" ] || \
             [ "${{ needs.security-scan.result }}" == "failure" ] || \
             [ "${{ needs.contract-check.result }}" == "failure" ] || \
             [ "${{ needs.node-services.result }}" == "failure" ] || \
             [ "${{ needs.rust-services.result }}" == "failure" ]; then
            echo "❌ CI Pipeline Failed"
            exit 1
          else
            echo "✅ CI Pipeline Passed"
            exit 0
          fi


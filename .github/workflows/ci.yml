name: Titan Monorepo CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ===========================================================================
  # Configuration Validation
  # ===========================================================================
  config-validation:
    name: config-validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies (Root)
        run: npm ci

      - name: Validate configuration
        run: npm run validate:config

  # ===========================================================================
  # Node.js Services Matrix (Lint, Test, Build)
  # ===========================================================================
  node-services:
    name: ${{ matrix.service }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - services/titan-brain
          - services/titan-phase1-scavenger
          - services/titan-phase2-hunter
          - services/titan-phase3-sentinel
          - services/titan-ai-quant
          - services/shared
          - services/titan-console

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies (Root)
        run: npm ci

      - name: Install dependencies (${{ matrix.service }})
        working-directory: ${{ matrix.service }}
        run: npm ci

      - name: Lint
        working-directory: ${{ matrix.service }}
        run: npm run lint --if-present

      - name: Test
        working-directory: ${{ matrix.service }}
        # Run test:unit if available, otherwise test, or skip if neither exists
        run: |
          if npm run | grep -q "test:unit"; then
            npm run test:unit
          elif npm run | grep -q "test"; then
            npm run test
          else
            echo "No test script found, skipping"
          fi

      - name: Build
        working-directory: ${{ matrix.service }}
        run: npm run build --if-present

  # ===========================================================================
  # Rust Services (Separate Job)
  # ===========================================================================
  rust-services:
    name: titan-execution-rs
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/titan-execution-rs

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
          components: rustfmt, clippy

      - name: Check Formatting
        run: cargo fmt -- --check

      - name: Lint (Clippy)
        run: cargo clippy -- -D warnings

      - name: Run Tests
        run: cargo test

      - name: Build
        run: cargo build --release

  # ===========================================================================
  # Final Status Check
  # ===========================================================================
  status-check:
    name: CI Pipeline Status
    runs-on: ubuntu-latest
    needs: [config-validation, node-services, rust-services]
    if: always()
    steps:
      - name: Check Results
        run: |
          if [ "${{ needs.config-validation.result }}" == "failure" ] || \
             [ "${{ needs.node-services.result }}" == "failure" ] || \
             [ "${{ needs.rust-services.result }}" == "failure" ]; then
            echo "❌ CI Pipeline Failed"
            exit 1
          else
            echo "✅ CI Pipeline Passed"
            exit 0
          fi

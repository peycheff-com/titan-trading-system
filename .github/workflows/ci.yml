name: Titan Monorepo CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  # ===========================================================================
  # Configuration Validation
  # ===========================================================================
  config-validation:
    name: config-validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies (Root)
        run: npm ci

      - name: Validate configuration
        run: npm run validate:config

  # ===========================================================================
  # SOTA Standards Check (Architecture & Hygiene)
  # ===========================================================================
  sota-checks:
    name: sota-checks
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies (Root)
        run: npm ci

      - name: Install Python dependencies
        run: pip install pyyaml

      - name: Check Zombie Dependencies
        run: npm run sota:zombie

      - name: Check Circular Dependencies
        run: npm run sota:circular

      - name: Check Immutability Violations
        run: npm run sota:immutability -- --max-warnings=0

  # ===========================================================================
  # Contract Drift Check (Shipping Gate)
  # ===========================================================================
  contract-check:
    name: contract-check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Check Contract Drift
        run: ./scripts/ci/check_contracts.sh


  # ===========================================================================
  # Node.js Services Matrix (Lint, Test, Build)
  # ===========================================================================
  node-services:
    name: ${{ matrix.service }}
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        service:
          - services/titan-brain
          - services/titan-phase1-scavenger
          - services/titan-phase2-hunter
          - services/titan-phase3-sentinel
          - services/titan-ai-quant
          - services/shared
          - services/titan-console

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Node.js
        uses: actions/setup-node@v3
        with:
          node-version: '22'
          cache: 'npm'
          cache-dependency-path: '**/package-lock.json'

      - name: Install dependencies (Root)
        run: npm ci

      - name: Install dependencies (${{ matrix.service }})
        working-directory: ${{ matrix.service }}
        run: npm ci

      - name: Lint
        working-directory: ${{ matrix.service }}
        run: npm run lint --if-present

      - name: Test
        working-directory: ${{ matrix.service }}
        # Run test:unit if available, otherwise test, or skip if neither exists
        run: |
          if npm run | grep -q "test:unit"; then
            npm run test:unit
          elif npm run | grep -q "test"; then
            npm run test
          else
            echo "No test script found, skipping"
          fi

      - name: Build
        working-directory: ${{ matrix.service }}
        run: npm run build --if-present

  # ===========================================================================
  # Rust Services (Separate Job)
  # ===========================================================================
  rust-services:
    name: titan-execution-rs
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: services/titan-execution-rs

    services:
      nats:
        image: nats:2.10.22-alpine
        ports:
          - 4222:4222
        options: >-
          --health-cmd "wget --no-verbose --tries=1 --spider http://localhost:8222/varz || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
          --cmd "-js -m 8222"

    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Setup Rust
        uses: actions-rs/toolchain@v1
        with:
          profile: minimal
          toolchain: stable
          override: true
          components: rustfmt, clippy

      - name: Check Formatting
        run: cargo fmt -- --check

      - name: Lint (Clippy)
        run: cargo clippy -- -D warnings

      - name: Run Tests
        env:
           NATS_URL: nats://localhost:4222
           RUST_LOG: info
        run: cargo test

      - name: Build
        run: cargo build --release

  # ===========================================================================
  # Final Status Check
  # ===========================================================================
  status-check:
    name: CI Pipeline Status
    runs-on: ubuntu-latest
    needs: [config-validation, sota-checks, contract-check, node-services, rust-services]
    if: always()
    steps:
      - name: Check Results
        run: |
          if [ "${{ needs.config-validation.result }}" == "failure" ] || \
             [ "${{ needs.sota-checks.result }}" == "failure" ] || \
             [ "${{ needs.contract-check.result }}" == "failure" ] || \
             [ "${{ needs.node-services.result }}" == "failure" ] || \
             [ "${{ needs.node-services.result }}" == "failure" ] || \
             [ "${{ needs.rust-services.result }}" == "failure" ]; then
            echo "❌ CI Pipeline Failed"
            exit 1
          else
            echo "✅ CI Pipeline Passed"
            exit 0
          fi

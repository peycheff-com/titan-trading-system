
> titan-brain@1.0.0 test:unit
> jest --config jest.config.cjs tests/unit/PowerLawPolicyModule.test.ts

FAIL tests/unit/PowerLawPolicyModule.test.ts
  ● PowerLawPolicyModule › should enforce fit quality confidence threshold

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "titan.data.execution.constraints.v1", ObjectContaining {"limits": ObjectContaining {"max_leverage": 2.25, "max_pos_notional": 375000}, "origin": ObjectContaining {"reason_codes": ArrayContaining ["LOW_CONFIDENCE"]}}
    Received: "titan.signal.execution.constraints.v1.binance.default.BTCUSDT", {"account": "default", "execution_profile": {"cancel_on_burst": {"enabled": false, "timeout_ms": 5000}, "maker_bias": 0.5, "price_band_bps": 50, "slicing": {"cadence_ms": 2000, "max_slice_notional": 18750, "min_slice_notional": 100}, "tif": {"ttl_ms": 60000, "type": "GTC"}}, "issued_ts": 1770131444448, "limits": {"max_leverage": 2.25, "max_order_notional": 75000, "max_pos_notional": 375000, "reduce_only": false}, "mode": "ENFORCEMENT", "origin": {"brain_decision_id": "powerlaw-1770131444448", "derived_from_metrics": {"model_id": "hill-v1", "provenance_hash": "xyz", "window_end_ts": 1000}, "reason_codes": ["LOW_CONFIDENCE"]}, "provenance": {"calc_ts": 1770131444448, "code_hash": "unknown", "config_hash": "unknown", "trace_id": "uuid"}, "risk_mode": "NORMAL", "schema_version": "1", "symbol": "BTCUSDT", "ttl_ms": 60000, "venue": "binance"}

    Number of calls: 1

      65 |         );
      66 |
    > 67 |         expect(mockNats.publish).toHaveBeenCalledWith(
         |                                  ^
      68 |             expect.stringContaining("titan.data.execution.constraints.v1"),
      69 |             expect.objectContaining({
      70 |                 limits: expect.objectContaining({

      at Object.<anonymous> (tests/unit/PowerLawPolicyModule.test.ts:67:34)

  ● PowerLawPolicyModule › should enforce critical alpha constraints

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "titan.data.execution.constraints.v1", ObjectContaining {"limits": ObjectContaining {"max_leverage": 1.5, "max_pos_notional": 125000}, "risk_mode": "EMERGENCY"}
    Received
           1: "titan.signal.execution.constraints.v1.binance.default.BTCUSDT", {"account": "default", "execution_profile": {"cancel_on_burst": {"enabled": false, "timeout_ms": 5000}, "maker_bias": 0.5, "price_band_bps": 50, "slicing": {"cadence_ms": 2000, "max_slice_notional": 6250, "min_slice_notional": 100}, "tif": {"ttl_ms": 60000, "type": "GTC"}}, "issued_ts": 1770131444452, "limits": {"max_leverage": 1.5, "max_order_notional": 25000, "max_pos_notional": 125000, "reduce_only": true}, "mode": "ENFORCEMENT", "origin": {"brain_decision_id": "powerlaw-1770131444452", "derived_from_metrics": {"model_id": "hill-v1", "provenance_hash": "xyz", "window_end_ts": 1000}, "reason_codes": ["ALPHA_CRITICAL"]}, "provenance": {"calc_ts": 1770131444452, "code_hash": "unknown", "config_hash": "unknown", "trace_id": "uuid"}, "risk_mode": "EMERGENCY", "schema_version": "1", "symbol": "BTCUSDT", "ttl_ms": 60000, "venue": "binance"}
           2: "titan.evt.powerlaw.impact.v1", {"constraintsApplied": {"maxLeverage": 1.5, "maxOrderNotional": 25000, "reduceOnly": true}, "impactType": "CONSTRAINT_TIGHTENED", "metricsProvenanceHash": "xyz", "metricsSnapshot": {"alpha": 1.5, "confidence": 0.9, "exceedanceProbability": 0.01, "volClusterState": "stable"}, "reason": "Tail alpha 1.500 below critical threshold 2", "reasonCodes": ["ALPHA_CRITICAL"], "severity": "CRITICAL", "symbol": "BTCUSDT", "timestamp": 1770131444452, "venue": "binance"}

    Number of calls: 2

      91 |         await module.processMetrics(metrics);
      92 |
    > 93 |         expect(mockNats.publish).toHaveBeenCalledWith(
         |                                  ^
      94 |             expect.stringContaining("titan.data.execution.constraints.v1"),
      95 |             expect.objectContaining({
      96 |                 limits: expect.objectContaining({

      at Object.<anonymous> (tests/unit/PowerLawPolicyModule.test.ts:93:34)

  ● PowerLawPolicyModule › should enforce volatility cluster constraints

    expect(jest.fn()).toHaveBeenCalledWith(...expected)

    Expected: StringContaining "titan.data.execution.constraints.v1", ObjectContaining {"execution_profile": ObjectContaining {"tif": {"ttl_ms": 5000, "type": "IOC"}}, "limits": ObjectContaining {"max_pos_notional": 250000}, "origin": ObjectContaining {"reason_codes": ArrayContaining ["VOL_EXPANDING"]}}
    Received: "titan.signal.execution.constraints.v1.binance.default.BTCUSDT", {"account": "default", "execution_profile": {"cancel_on_burst": {"enabled": true, "timeout_ms": 5000}, "maker_bias": 1, "price_band_bps": 10, "slicing": {"cadence_ms": 10000, "max_slice_notional": 12500, "min_slice_notional": 100}, "tif": {"ttl_ms": 5000, "type": "IOC"}}, "issued_ts": 1770131444454, "limits": {"max_leverage": 3, "max_order_notional": 50000, "max_pos_notional": 250000, "reduce_only": false}, "mode": "ENFORCEMENT", "origin": {"brain_decision_id": "powerlaw-1770131444454", "derived_from_metrics": {"model_id": "hill-v1", "provenance_hash": "xyz", "window_end_ts": 1000}, "reason_codes": ["VOL_EXPANDING"]}, "provenance": {"calc_ts": 1770131444454, "code_hash": "unknown", "config_hash": "unknown", "trace_id": "uuid"}, "risk_mode": "DEFENSIVE", "schema_version": "1", "symbol": "BTCUSDT", "ttl_ms": 60000, "venue": "binance"}

    Number of calls: 1

      114 |         await module.processMetrics(metrics);
      115 |
    > 116 |         expect(mockNats.publish).toHaveBeenCalledWith(
          |                                  ^
      117 |             expect.stringContaining("titan.data.execution.constraints.v1"),
      118 |             expect.objectContaining({
      119 |                 limits: expect.objectContaining({

      at Object.<anonymous> (tests/unit/PowerLawPolicyModule.test.ts:116:34)

Test Suites: 1 failed, 1 total
Tests:       3 failed, 2 passed, 5 total
Snapshots:   0 total
Time:        0.81 s, estimated 2 s
Ran all test suites matching /tests\/unit\/PowerLawPolicyModule.test.ts/i.
npm error Lifecycle script `test:unit` failed with error:
npm error code 1
npm error path /Users/ivan/Code/trading/titan/services/titan-brain
npm error workspace titan-brain@1.0.0
npm error location /Users/ivan/Code/trading/titan/services/titan-brain
npm error command failed
npm error command sh -c jest --config jest.config.cjs tests/unit/PowerLawPolicyModule.test.ts

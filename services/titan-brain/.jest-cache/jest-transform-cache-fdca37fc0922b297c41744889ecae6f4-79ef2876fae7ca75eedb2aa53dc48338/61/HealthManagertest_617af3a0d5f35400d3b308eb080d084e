25dc42f1247566580119aeaa1902fbc1
"use strict";
/**
 * HealthManager Tests
 *
 * Tests for the enhanced health management system
 */
Object.defineProperty(exports, "__esModule", { value: true });
const HealthManager_js_1 = require("../../src/health/HealthManager.js");
// Mock TitanBrain for testing
class MockTitanBrain {
    async getHealthStatus() {
        return {
            healthy: true,
            components: {
                database: { healthy: true, error: null },
                redis: { healthy: true, error: null }
            },
            errors: []
        };
    }
}
describe('HealthManager', () => {
    let healthManager;
    let mockBrain;
    const originalEnv = process.env;
    beforeEach(() => {
        // Set up required environment variables for ConfigHealthComponent
        process.env = {
            ...originalEnv,
            NODE_ENV: 'test',
            SERVER_PORT: '3100',
            DB_HOST: 'localhost',
            DB_NAME: 'test_db',
            DB_USER: 'test_user',
            DB_PASSWORD: 'test_password'
        };
        mockBrain = new MockTitanBrain();
        healthManager = new HealthManager_js_1.HealthManager(); // No managers, only config and memory components
    });
    afterEach(() => {
        process.env = originalEnv;
    });
    describe('startup state', () => {
        it('should return unhealthy status when startup is not complete', async () => {
            const health = await healthManager.checkHealth();
            expect(health.status).toBe('starting');
            expect(health.code).toBe(503);
            expect(health.errors).toContain('Service is starting up');
        });
        it('should return healthy status after startup is marked complete', async () => {
            healthManager.markStartupComplete();
            const health = await healthManager.checkHealth();
            expect(health.status).toBe('healthy');
            expect(health.code).toBe(200);
            expect(health.components).toBeDefined();
        });
    });
    describe('component health checks', () => {
        beforeEach(() => {
            healthManager.markStartupComplete();
        });
        it('should include all registered components in health check', async () => {
            const health = await healthManager.checkHealth();
            expect(health.components).toHaveProperty('configuration');
            expect(health.components).toHaveProperty('memory');
            // Note: database and redis components not registered since no managers provided
        });
        it('should include metadata in health response', async () => {
            const health = await healthManager.checkHealth();
            expect(health.metadata).toBeDefined();
            expect(health.metadata?.version).toBeDefined();
            expect(health.metadata?.environment).toBeDefined();
            expect(health.metadata?.nodeVersion).toBeDefined();
            expect(health.metadata?.memoryUsage).toBeDefined();
        });
        it('should include uptime in health response', async () => {
            const health = await healthManager.checkHealth();
            expect(health.uptime).toBeGreaterThan(0);
            expect(typeof health.uptime).toBe('number');
        });
    });
    describe('quick health check', () => {
        it('should return unhealthy when startup not complete', async () => {
            const quickHealth = await healthManager.getQuickHealth();
            expect(quickHealth.healthy).toBe(false);
            expect(quickHealth.message).toBe('Starting up');
        });
        it('should return healthy when startup complete and config valid', async () => {
            // Set required environment variables for config validation
            process.env.NODE_ENV = 'test';
            process.env.SERVER_PORT = '3100';
            process.env.DB_HOST = 'localhost';
            process.env.DB_NAME = 'test';
            process.env.DB_USER = 'test';
            process.env.DB_PASSWORD = 'test';
            healthManager.markStartupComplete();
            const quickHealth = await healthManager.getQuickHealth();
            expect(quickHealth.healthy).toBe(true);
            expect(quickHealth.message).toBe('Service operational');
        });
    });
});
describe('ConfigHealthComponent', () => {
    let configComponent;
    beforeEach(() => {
        configComponent = new HealthManager_js_1.ConfigHealthComponent();
    });
    it('should pass when all required environment variables are present', async () => {
        // Set required environment variables
        process.env.NODE_ENV = 'test';
        process.env.SERVER_PORT = '3100';
        process.env.DB_HOST = 'localhost';
        process.env.DB_NAME = 'test';
        process.env.DB_USER = 'test';
        process.env.DB_PASSWORD = 'test';
        const health = await configComponent.check();
        expect(health.healthy).toBe(true);
        expect(health.message).toBe('Configuration valid');
    });
    it('should fail when required environment variables are missing', async () => {
        // Clear environment variables
        delete process.env.DB_PASSWORD;
        const health = await configComponent.check();
        expect(health.healthy).toBe(false);
        expect(health.message).toContain('Missing required environment variables');
        expect(health.message).toContain('DB_PASSWORD');
    });
});
describe('MemoryHealthComponent', () => {
    let memoryComponent;
    beforeEach(() => {
        memoryComponent = new HealthManager_js_1.MemoryHealthComponent();
    });
    it('should return memory usage information', async () => {
        const health = await memoryComponent.check();
        expect(health.healthy).toBeDefined();
        expect(health.message).toContain('Memory usage:');
        expect(health.message).toContain('MB');
        expect(health.responseTime).toBeGreaterThan(0);
    });
    it('should complete within timeout', async () => {
        const startTime = Date.now();
        await memoryComponent.check();
        const duration = Date.now() - startTime;
        expect(duration).toBeLessThan(memoryComponent.timeout);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLWJyYWluL3Rlc3RzL2hlYWx0aC9IZWFsdGhNYW5hZ2VyLnRlc3QudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7O0dBSUc7O0FBRUgsd0VBQXlJO0FBRXpJLDhCQUE4QjtBQUM5QixNQUFNLGNBQWM7SUFDbEIsS0FBSyxDQUFDLGVBQWU7UUFDbkIsT0FBTztZQUNMLE9BQU8sRUFBRSxJQUFJO1lBQ2IsVUFBVSxFQUFFO2dCQUNWLFFBQVEsRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRTtnQkFDeEMsS0FBSyxFQUFFLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFO2FBQ3RDO1lBQ0QsTUFBTSxFQUFFLEVBQUU7U0FDWCxDQUFDO0lBQ0osQ0FBQztDQUNGO0FBRUQsUUFBUSxDQUFDLGVBQWUsRUFBRSxHQUFHLEVBQUU7SUFDN0IsSUFBSSxhQUE0QixDQUFDO0lBQ2pDLElBQUksU0FBeUIsQ0FBQztJQUM5QixNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDO0lBRWhDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxrRUFBa0U7UUFDbEUsT0FBTyxDQUFDLEdBQUcsR0FBRztZQUNaLEdBQUcsV0FBVztZQUNkLFFBQVEsRUFBRSxNQUFNO1lBQ2hCLFdBQVcsRUFBRSxNQUFNO1lBQ25CLE9BQU8sRUFBRSxXQUFXO1lBQ3BCLE9BQU8sRUFBRSxTQUFTO1lBQ2xCLE9BQU8sRUFBRSxXQUFXO1lBQ3BCLFdBQVcsRUFBRSxlQUFlO1NBQzdCLENBQUM7UUFFRixTQUFTLEdBQUcsSUFBSSxjQUFjLEVBQUUsQ0FBQztRQUNqQyxhQUFhLEdBQUcsSUFBSSxnQ0FBYSxFQUFFLENBQUMsQ0FBQyxpREFBaUQ7SUFDeEYsQ0FBQyxDQUFDLENBQUM7SUFFSCxTQUFTLENBQUMsR0FBRyxFQUFFO1FBQ2IsT0FBTyxDQUFDLEdBQUcsR0FBRyxXQUFX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LENBQUMsZUFBZSxDQUFDLE9BQU8sQ0FBQyxDQUFDO0lBQ3pELENBQUMsQ0FBQyxDQUFDO0FBQ0wsQ0FBQyxDQUFDLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLWJyYWluL3Rlc3RzL2hlYWx0aC9IZWFsdGhNYW5hZ2VyLnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBIZWFsdGhNYW5hZ2VyIFRlc3RzXG4gKiBcbiAqIFRlc3RzIGZvciB0aGUgZW5oYW5jZWQgaGVhbHRoIG1hbmFnZW1lbnQgc3lzdGVtXG4gKi9cblxuaW1wb3J0IHsgSGVhbHRoTWFuYWdlciwgRGF0YWJhc2VIZWFsdGhDb21wb25lbnQsIENvbmZpZ0hlYWx0aENvbXBvbmVudCwgTWVtb3J5SGVhbHRoQ29tcG9uZW50IH0gZnJvbSAnLi4vLi4vc3JjL2hlYWx0aC9IZWFsdGhNYW5hZ2VyLmpzJztcblxuLy8gTW9jayBUaXRhbkJyYWluIGZvciB0ZXN0aW5nXG5jbGFzcyBNb2NrVGl0YW5CcmFpbiB7XG4gIGFzeW5jIGdldEhlYWx0aFN0YXR1cygpIHtcbiAgICByZXR1cm4ge1xuICAgICAgaGVhbHRoeTogdHJ1ZSxcbiAgICAgIGNvbXBvbmVudHM6IHtcbiAgICAgICAgZGF0YWJhc2U6IHsgaGVhbHRoeTogdHJ1ZSwgZXJyb3I6IG51bGwgfSxcbiAgICAgICAgcmVkaXM6IHsgaGVhbHRoeTogdHJ1ZSwgZXJyb3I6IG51bGwgfVxuICAgICAgfSxcbiAgICAgIGVycm9yczogW11cbiAgICB9O1xuICB9XG59XG5cbmRlc2NyaWJlKCdIZWFsdGhNYW5hZ2VyJywgKCkgPT4ge1xuICBsZXQgaGVhbHRoTWFuYWdlcjogSGVhbHRoTWFuYWdlcjtcbiAgbGV0IG1vY2tCcmFpbjogTW9ja1RpdGFuQnJhaW47XG4gIGNvbnN0IG9yaWdpbmFsRW52ID0gcHJvY2Vzcy5lbnY7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgLy8gU2V0IHVwIHJlcXVpcmVkIGVudmlyb25tZW50IHZhcmlhYmxlcyBmb3IgQ29uZmlnSGVhbHRoQ29tcG9uZW50XG4gICAgcHJvY2Vzcy5lbnYgPSB7XG4gICAgICAuLi5vcmlnaW5hbEVudixcbiAgICAgIE5PREVfRU5WOiAndGVzdCcsXG4gICAgICBTRVJWRVJfUE9SVDogJzMxMDAnLFxuICAgICAgREJfSE9TVDogJ2xvY2FsaG9zdCcsXG4gICAgICBEQl9OQU1FOiAndGVzdF9kYicsXG4gICAgICBEQl9VU0VSOiAndGVzdF91c2VyJyxcbiAgICAgIERCX1BBU1NXT1JEOiAndGVzdF9wYXNzd29yZCdcbiAgICB9O1xuXG4gICAgbW9ja0JyYWluID0gbmV3IE1vY2tUaXRhbkJyYWluKCk7XG4gICAgaGVhbHRoTWFuYWdlciA9IG5ldyBIZWFsdGhNYW5hZ2VyKCk7IC8vIE5vIG1hbmFnZXJzLCBvbmx5IGNvbmZpZyBhbmQgbWVtb3J5IGNvbXBvbmVudHNcbiAgfSk7XG5cbiAgYWZ0ZXJFYWNoKCgpID0+IHtcbiAgICBwcm9jZXNzLmVudiA9IG9yaWdpbmFsRW52O1xuICB9KTtcblxuICBkZXNjcmliZSgnc3RhcnR1cCBzdGF0ZScsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHJldHVybiB1bmhlYWx0aHkgc3RhdHVzIHdoZW4gc3RhcnR1cCBpcyBub3QgY29tcGxldGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBoZWFsdGggPSBhd2FpdCBoZWFsdGhNYW5hZ2VyLmNoZWNrSGVhbHRoKCk7XG4gICAgICBcbiAgICAgIGV4cGVjdChoZWFsdGguc3RhdHVzKS50b0JlKCdzdGFydGluZycpO1xuICAgICAgZXhwZWN0KGhlYWx0aC5jb2RlKS50b0JlKDUwMyk7XG4gICAgICBleHBlY3QoaGVhbHRoLmVycm9ycykudG9Db250YWluKCdTZXJ2aWNlIGlzIHN0YXJ0aW5nIHVwJyk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIHJldHVybiBoZWFsdGh5IHN0YXR1cyBhZnRlciBzdGFydHVwIGlzIG1hcmtlZCBjb21wbGV0ZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGhlYWx0aE1hbmFnZXIubWFya1N0YXJ0dXBDb21wbGV0ZSgpO1xuICAgICAgXG4gICAgICBjb25zdCBoZWFsdGggPSBhd2FpdCBoZWFsdGhNYW5hZ2VyLmNoZWNrSGVhbHRoKCk7XG4gICAgICBcbiAgICAgIGV4cGVjdChoZWFsdGguc3RhdHVzKS50b0JlKCdoZWFsdGh5Jyk7XG4gICAgICBleHBlY3QoaGVhbHRoLmNvZGUpLnRvQmUoMjAwKTtcbiAgICAgIGV4cGVjdChoZWFsdGguY29tcG9uZW50cykudG9CZURlZmluZWQoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2NvbXBvbmVudCBoZWFsdGggY2hlY2tzJywgKCkgPT4ge1xuICAgIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgICAgaGVhbHRoTWFuYWdlci5tYXJrU3RhcnR1cENvbXBsZXRlKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGluY2x1ZGUgYWxsIHJlZ2lzdGVyZWQgY29tcG9uZW50cyBpbiBoZWFsdGggY2hlY2snLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBoZWFsdGggPSBhd2FpdCBoZWFsdGhNYW5hZ2VyLmNoZWNrSGVhbHRoKCk7XG4gICAgICBcbiAgICAgIGV4cGVjdChoZWFsdGguY29tcG9uZW50cykudG9IYXZlUHJvcGVydHkoJ2NvbmZpZ3VyYXRpb24nKTtcbiAgICAgIGV4cGVjdChoZWFsdGguY29tcG9uZW50cykudG9IYXZlUHJvcGVydHkoJ21lbW9yeScpO1xuICAgICAgLy8gTm90ZTogZGF0YWJhc2UgYW5kIHJlZGlzIGNvbXBvbmVudHMgbm90IHJlZ2lzdGVyZWQgc2luY2Ugbm8gbWFuYWdlcnMgcHJvdmlkZWRcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaW5jbHVkZSBtZXRhZGF0YSBpbiBoZWFsdGggcmVzcG9uc2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBoZWFsdGggPSBhd2FpdCBoZWFsdGhNYW5hZ2VyLmNoZWNrSGVhbHRoKCk7XG4gICAgICBcbiAgICAgIGV4cGVjdChoZWFsdGgubWV0YWRhdGEpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QoaGVhbHRoLm1ldGFkYXRhPy52ZXJzaW9uKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KGhlYWx0aC5tZXRhZGF0YT8uZW52aXJvbm1lbnQpLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QoaGVhbHRoLm1ldGFkYXRhPy5ub2RlVmVyc2lvbikudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChoZWFsdGgubWV0YWRhdGE/Lm1lbW9yeVVzYWdlKS50b0JlRGVmaW5lZCgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBpbmNsdWRlIHVwdGltZSBpbiBoZWFsdGggcmVzcG9uc2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBoZWFsdGggPSBhd2FpdCBoZWFsdGhNYW5hZ2VyLmNoZWNrSGVhbHRoKCk7XG4gICAgICBcbiAgICAgIGV4cGVjdChoZWFsdGgudXB0aW1lKS50b0JlR3JlYXRlclRoYW4oMCk7XG4gICAgICBleHBlY3QodHlwZW9mIGhlYWx0aC51cHRpbWUpLnRvQmUoJ251bWJlcicpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgncXVpY2sgaGVhbHRoIGNoZWNrJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIHVuaGVhbHRoeSB3aGVuIHN0YXJ0dXAgbm90IGNvbXBsZXRlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcXVpY2tIZWFsdGggPSBhd2FpdCBoZWFsdGhNYW5hZ2VyLmdldFF1aWNrSGVhbHRoKCk7XG4gICAgICBcbiAgICAgIGV4cGVjdChxdWlja0hlYWx0aC5oZWFsdGh5KS50b0JlKGZhbHNlKTtcbiAgICAgIGV4cGVjdChxdWlja0hlYWx0aC5tZXNzYWdlKS50b0JlKCdTdGFydGluZyB1cCcpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gaGVhbHRoeSB3aGVuIHN0YXJ0dXAgY29tcGxldGUgYW5kIGNvbmZpZyB2YWxpZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIFNldCByZXF1aXJlZCBlbnZpcm9ubWVudCB2YXJpYWJsZXMgZm9yIGNvbmZpZyB2YWxpZGF0aW9uXG4gICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViA9ICd0ZXN0JztcbiAgICAgIHByb2Nlc3MuZW52LlNFUlZFUl9QT1JUID0gJzMxMDAnO1xuICAgICAgcHJvY2Vzcy5lbnYuREJfSE9TVCA9ICdsb2NhbGhvc3QnO1xuICAgICAgcHJvY2Vzcy5lbnYuREJfTkFNRSA9ICd0ZXN0JztcbiAgICAgIHByb2Nlc3MuZW52LkRCX1VTRVIgPSAndGVzdCc7XG4gICAgICBwcm9jZXNzLmVudi5EQl9QQVNTV09SRCA9ICd0ZXN0JztcbiAgICAgIFxuICAgICAgaGVhbHRoTWFuYWdlci5tYXJrU3RhcnR1cENvbXBsZXRlKCk7XG4gICAgICBcbiAgICAgIGNvbnN0IHF1aWNrSGVhbHRoID0gYXdhaXQgaGVhbHRoTWFuYWdlci5nZXRRdWlja0hlYWx0aCgpO1xuICAgICAgXG4gICAgICBleHBlY3QocXVpY2tIZWFsdGguaGVhbHRoeSkudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdChxdWlja0hlYWx0aC5tZXNzYWdlKS50b0JlKCdTZXJ2aWNlIG9wZXJhdGlvbmFsJyk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG5cbmRlc2NyaWJlKCdDb25maWdIZWFsdGhDb21wb25lbnQnLCAoKSA9PiB7XG4gIGxldCBjb25maWdDb21wb25lbnQ6IENvbmZpZ0hlYWx0aENvbXBvbmVudDtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBjb25maWdDb21wb25lbnQgPSBuZXcgQ29uZmlnSGVhbHRoQ29tcG9uZW50KCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgcGFzcyB3aGVuIGFsbCByZXF1aXJlZCBlbnZpcm9ubWVudCB2YXJpYWJsZXMgYXJlIHByZXNlbnQnLCBhc3luYyAoKSA9PiB7XG4gICAgLy8gU2V0IHJlcXVpcmVkIGVudmlyb25tZW50IHZhcmlhYmxlc1xuICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WID0gJ3Rlc3QnO1xuICAgIHByb2Nlc3MuZW52LlNFUlZFUl9QT1JUID0gJzMxMDAnO1xuICAgIHByb2Nlc3MuZW52LkRCX0hPU1QgPSAnbG9jYWxob3N0JztcbiAgICBwcm9jZXNzLmVudi5EQl9OQU1FID0gJ3Rlc3QnO1xuICAgIHByb2Nlc3MuZW52LkRCX1VTRVIgPSAndGVzdCc7XG4gICAgcHJvY2Vzcy5lbnYuREJfUEFTU1dPUkQgPSAndGVzdCc7XG5cbiAgICBjb25zdCBoZWFsdGggPSBhd2FpdCBjb25maWdDb21wb25lbnQuY2hlY2soKTtcbiAgICBcbiAgICBleHBlY3QoaGVhbHRoLmhlYWx0aHkpLnRvQmUodHJ1ZSk7XG4gICAgZXhwZWN0KGhlYWx0aC5tZXNzYWdlKS50b0JlKCdDb25maWd1cmF0aW9uIHZhbGlkJyk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgZmFpbCB3aGVuIHJlcXVpcmVkIGVudmlyb25tZW50IHZhcmlhYmxlcyBhcmUgbWlzc2luZycsIGFzeW5jICgpID0+IHtcbiAgICAvLyBDbGVhciBlbnZpcm9ubWVudCB2YXJpYWJsZXNcbiAgICBkZWxldGUgcHJvY2Vzcy5lbnYuREJfUEFTU1dPUkQ7XG5cbiAgICBjb25zdCBoZWFsdGggPSBhd2FpdCBjb25maWdDb21wb25lbnQuY2hlY2soKTtcbiAgICBcbiAgICBleHBlY3QoaGVhbHRoLmhlYWx0aHkpLnRvQmUoZmFsc2UpO1xuICAgIGV4cGVjdChoZWFsdGgubWVzc2FnZSkudG9Db250YWluKCdNaXNzaW5nIHJlcXVpcmVkIGVudmlyb25tZW50IHZhcmlhYmxlcycpO1xuICAgIGV4cGVjdChoZWFsdGgubWVzc2FnZSkudG9Db250YWluKCdEQl9QQVNTV09SRCcpO1xuICB9KTtcbn0pO1xuXG5kZXNjcmliZSgnTWVtb3J5SGVhbHRoQ29tcG9uZW50JywgKCkgPT4ge1xuICBsZXQgbWVtb3J5Q29tcG9uZW50OiBNZW1vcnlIZWFsdGhDb21wb25lbnQ7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgbWVtb3J5Q29tcG9uZW50ID0gbmV3IE1lbW9yeUhlYWx0aENvbXBvbmVudCgpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHJldHVybiBtZW1vcnkgdXNhZ2UgaW5mb3JtYXRpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgaGVhbHRoID0gYXdhaXQgbWVtb3J5Q29tcG9uZW50LmNoZWNrKCk7XG4gICAgXG4gICAgZXhwZWN0KGhlYWx0aC5oZWFsdGh5KS50b0JlRGVmaW5lZCgpO1xuICAgIGV4cGVjdChoZWFsdGgubWVzc2FnZSkudG9Db250YWluKCdNZW1vcnkgdXNhZ2U6Jyk7XG4gICAgZXhwZWN0KGhlYWx0aC5tZXNzYWdlKS50b0NvbnRhaW4oJ01CJyk7XG4gICAgZXhwZWN0KGhlYWx0aC5yZXNwb25zZVRpbWUpLnRvQmVHcmVhdGVyVGhhbigwKTtcbiAgfSk7XG5cbiAgaXQoJ3Nob3VsZCBjb21wbGV0ZSB3aXRoaW4gdGltZW91dCcsIGFzeW5jICgpID0+IHtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIFxuICAgIGF3YWl0IG1lbW9yeUNvbXBvbmVudC5jaGVjaygpO1xuICAgIFxuICAgIGNvbnN0IGR1cmF0aW9uID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcbiAgICBleHBlY3QoZHVyYXRpb24pLnRvQmVMZXNzVGhhbihtZW1vcnlDb21wb25lbnQudGltZW91dCk7XG4gIH0pO1xufSk7Il0sInZlcnNpb24iOjN9
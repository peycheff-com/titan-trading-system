50e4b37c761e0be8abc5bdc13e1ace6d
"use strict";
/**
 * DatabaseManager - Reliable database connection pooling with health monitoring
 *
 * Provides robust database connectivity with connection pooling, health monitoring,
 * automatic reconnection, and comprehensive error handling for Railway deployment.
 *
 * Requirements: 3.1.1, 3.1.2, 3.1.3, 3.1.4, 3.1.5
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.DatabaseManager = void 0;
const pg_1 = require("pg");
const events_1 = require("events");
/**
 * Database connection pool manager with health monitoring
 */
class DatabaseManager extends events_1.EventEmitter {
    pool = null;
    config;
    metrics;
    healthCheckInterval = null;
    reconnectAttempts = 0;
    isShuttingDown = false;
    queryHistory = []; // Query times for average calculation
    constructor(config) {
        super();
        this.config = config;
        this.metrics = this.initializeMetrics();
    }
    /**
     * Initialize metrics object
     */
    initializeMetrics() {
        return {
            totalConnections: 0,
            idleConnections: 0,
            waitingClients: 0,
            totalQueries: 0,
            successfulQueries: 0,
            failedQueries: 0,
            averageQueryTime: 0,
            connectionErrors: 0,
            lastHealthCheck: 0,
            isHealthy: false
        };
    }
    /**
     * Create database configuration from environment variables
     */
    static createConfigFromEnv() {
        // Parse Railway DATABASE_URL if available
        const databaseUrl = process.env.DATABASE_URL;
        let parsedConfig = {};
        if (databaseUrl) {
            try {
                const url = new URL(databaseUrl);
                parsedConfig = {
                    host: url.hostname,
                    port: parseInt(url.port) || 5432,
                    database: url.pathname.slice(1), // Remove leading slash
                    user: url.username,
                    password: url.password,
                    ssl: url.searchParams.get('sslmode') !== 'disable'
                };
            }
            catch (error) {
                console.warn('Failed to parse DATABASE_URL, falling back to individual env vars');
            }
        }
        return {
            host: parsedConfig.host || process.env.DB_HOST || 'localhost',
            port: parsedConfig.port || parseInt(process.env.DB_PORT || '5432'),
            database: parsedConfig.database || process.env.DB_NAME || 'titan_brain',
            user: parsedConfig.user || process.env.DB_USER || 'postgres',
            password: parsedConfig.password || process.env.DB_PASSWORD || '',
            ssl: parsedConfig.ssl !== undefined ? parsedConfig.ssl : (process.env.DB_SSL === 'true'),
            // Connection pool settings
            min: parseInt(process.env.DB_POOL_MIN || '2'),
            max: parseInt(process.env.DB_POOL_MAX || '10'),
            idleTimeoutMillis: parseInt(process.env.DB_IDLE_TIMEOUT || '30000'),
            connectionTimeoutMillis: parseInt(process.env.DB_CONNECTION_TIMEOUT || '10000'),
            acquireTimeoutMillis: parseInt(process.env.DB_ACQUIRE_TIMEOUT || '5000'),
            // Health check settings
            healthCheckIntervalMs: parseInt(process.env.DB_HEALTH_CHECK_INTERVAL || '30000'),
            healthCheckTimeoutMs: parseInt(process.env.DB_HEALTH_CHECK_TIMEOUT || '5000'),
            maxReconnectAttempts: parseInt(process.env.DB_MAX_RECONNECT_ATTEMPTS || '5'),
            reconnectDelayMs: parseInt(process.env.DB_RECONNECT_DELAY || '5000')
        };
    }
    /**
     * Initialize database connection pool
     */
    async initialize() {
        if (this.pool) {
            throw new Error('DatabaseManager already initialized');
        }
        const poolConfig = {
            host: this.config.host,
            port: this.config.port,
            database: this.config.database,
            user: this.config.user,
            password: this.config.password,
            ssl: this.config.ssl,
            min: this.config.min,
            max: this.config.max,
            idleTimeoutMillis: this.config.idleTimeoutMillis,
            connectionTimeoutMillis: this.config.connectionTimeoutMillis
        };
        this.pool = new pg_1.Pool(poolConfig);
        // Set up pool event listeners
        this.setupPoolEventListeners();
        // Test initial connection
        await this.testConnection();
        // Start health check monitoring
        this.startHealthCheckMonitoring();
        this.emit('initialized');
    }
    /**
     * Set up pool event listeners for monitoring
     */
    setupPoolEventListeners() {
        if (!this.pool)
            return;
        this.pool.on('connect', (client) => {
            this.metrics.totalConnections++;
            this.emit('connection:established', { totalConnections: this.metrics.totalConnections });
        });
        this.pool.on('acquire', (client) => {
            this.updatePoolMetrics();
        });
        this.pool.on('release', (client) => {
            this.updatePoolMetrics();
        });
        this.pool.on('remove', (client) => {
            this.metrics.totalConnections--;
            this.emit('connection:removed', { totalConnections: this.metrics.totalConnections });
        });
        this.pool.on('error', (error, client) => {
            this.metrics.connectionErrors++;
            this.metrics.isHealthy = false;
            this.emit('connection:error', { error: error.message, connectionErrors: this.metrics.connectionErrors });
            // Attempt reconnection if not shutting down
            if (!this.isShuttingDown) {
                this.attemptReconnection();
            }
        });
    }
    /**
     * Update pool metrics from current pool state
     */
    updatePoolMetrics() {
        if (!this.pool)
            return;
        this.metrics.totalConnections = this.pool.totalCount;
        this.metrics.idleConnections = this.pool.idleCount;
        this.metrics.waitingClients = this.pool.waitingCount;
    }
    /**
     * Test database connection
     */
    async testConnection() {
        if (!this.pool) {
            throw new Error('Pool not initialized');
        }
        const client = await this.pool.connect();
        try {
            await client.query('SELECT 1');
            this.metrics.isHealthy = true;
            this.reconnectAttempts = 0; // Reset on successful connection
        }
        finally {
            client.release();
        }
    }
    /**
     * Start health check monitoring
     */
    startHealthCheckMonitoring() {
        if (this.healthCheckInterval) {
            clearInterval(this.healthCheckInterval);
        }
        this.healthCheckInterval = setInterval(async () => {
            await this.performHealthCheck();
        }, this.config.healthCheckIntervalMs);
    }
    /**
     * Perform health check
     */
    async performHealthCheck() {
        if (this.isShuttingDown)
            return;
        const startTime = Date.now();
        try {
            await Promise.race([
                this.testConnection(),
                new Promise((_, reject) => setTimeout(() => reject(new Error('Health check timeout')), this.config.healthCheckTimeoutMs))
            ]);
            this.metrics.lastHealthCheck = Date.now();
            this.metrics.isHealthy = true;
            this.emit('health:check:success', { duration: Date.now() - startTime });
        }
        catch (error) {
            this.metrics.lastHealthCheck = Date.now();
            this.metrics.isHealthy = false;
            this.emit('health:check:failure', {
                error: error instanceof Error ? error.message : 'Unknown error',
                duration: Date.now() - startTime
            });
            // Attempt reconnection on health check failure
            this.attemptReconnection();
        }
    }
    /**
     * Attempt database reconnection with exponential backoff
     */
    async attemptReconnection() {
        if (this.isShuttingDown || this.reconnectAttempts >= this.config.maxReconnectAttempts) {
            return;
        }
        this.reconnectAttempts++;
        const delay = this.config.reconnectDelayMs * Math.pow(2, this.reconnectAttempts - 1);
        this.emit('reconnection:attempt', {
            attempt: this.reconnectAttempts,
            maxAttempts: this.config.maxReconnectAttempts,
            delay
        });
        setTimeout(async () => {
            try {
                await this.testConnection();
                this.emit('reconnection:success', { attempts: this.reconnectAttempts });
                this.reconnectAttempts = 0;
            }
            catch (error) {
                this.emit('reconnection:failure', {
                    attempt: this.reconnectAttempts,
                    error: error instanceof Error ? error.message : 'Unknown error'
                });
                // Continue attempting if we haven't reached max attempts
                if (this.reconnectAttempts < this.config.maxReconnectAttempts) {
                    this.attemptReconnection();
                }
                else {
                    this.emit('reconnection:exhausted', { maxAttempts: this.config.maxReconnectAttempts });
                }
            }
        }, delay);
    }
    /**
     * Execute a query with timing and error handling
     */
    async query(text, params) {
        if (!this.pool) {
            throw new Error('DatabaseManager not initialized');
        }
        if (!this.metrics.isHealthy) {
            throw new Error('Database is not healthy');
        }
        const startTime = Date.now();
        this.metrics.totalQueries++;
        try {
            const result = await this.pool.query(text, params);
            const duration = Date.now() - startTime;
            // Update metrics
            this.metrics.successfulQueries++;
            this.updateQueryTimeMetrics(duration);
            this.emit('query:success', {
                command: result.command,
                rowCount: result.rowCount,
                duration
            });
            return {
                rows: result.rows,
                rowCount: result.rowCount || 0,
                duration,
                command: result.command || 'UNKNOWN'
            };
        }
        catch (error) {
            const duration = Date.now() - startTime;
            this.metrics.failedQueries++;
            this.emit('query:failure', {
                error: error instanceof Error ? error.message : 'Unknown error',
                duration,
                query: text.substring(0, 100) // Log first 100 chars for debugging
            });
            throw error;
        }
    }
    /**
     * Execute a query with a specific client (for transactions)
     */
    async queryWithClient(client, text, params) {
        const startTime = Date.now();
        this.metrics.totalQueries++;
        try {
            const result = await client.query(text, params);
            const duration = Date.now() - startTime;
            // Update metrics
            this.metrics.successfulQueries++;
            this.updateQueryTimeMetrics(duration);
            this.emit('query:success', {
                command: result.command,
                rowCount: result.rowCount,
                duration
            });
            return {
                rows: result.rows,
                rowCount: result.rowCount || 0,
                duration,
                command: result.command || 'UNKNOWN'
            };
        }
        catch (error) {
            const duration = Date.now() - startTime;
            this.metrics.failedQueries++;
            this.emit('query:failure', {
                error: error instanceof Error ? error.message : 'Unknown error',
                duration,
                query: text.substring(0, 100)
            });
            throw error;
        }
    }
    /**
     * Get a client from the pool for transactions
     */
    async getClient() {
        if (!this.pool) {
            throw new Error('DatabaseManager not initialized');
        }
        if (!this.metrics.isHealthy) {
            throw new Error('Database is not healthy');
        }
        return await this.pool.connect();
    }
    /**
     * Execute a transaction with automatic rollback on error
     */
    async transaction(callback) {
        const client = await this.getClient();
        try {
            await client.query('BEGIN');
            const result = await callback(client);
            await client.query('COMMIT');
            this.emit('transaction:success');
            return result;
        }
        catch (error) {
            await client.query('ROLLBACK');
            this.emit('transaction:rollback', {
                error: error instanceof Error ? error.message : 'Unknown error'
            });
            throw error;
        }
        finally {
            client.release();
        }
    }
    /**
     * Update query time metrics
     */
    updateQueryTimeMetrics(duration) {
        this.queryHistory.push(duration);
        // Keep only last 100 queries for average calculation
        if (this.queryHistory.length > 100) {
            this.queryHistory.shift();
        }
        // Calculate average query time
        this.metrics.averageQueryTime = this.queryHistory.reduce((sum, time) => sum + time, 0) / this.queryHistory.length;
    }
    /**
     * Get current database metrics
     */
    getMetrics() {
        this.updatePoolMetrics();
        return { ...this.metrics };
    }
    /**
     * Check if database is healthy
     */
    isHealthy() {
        return this.metrics.isHealthy && this.pool !== null;
    }
    /**
     * Get connection pool status
     */
    getPoolStatus() {
        this.updatePoolMetrics();
        return {
            totalConnections: this.metrics.totalConnections,
            idleConnections: this.metrics.idleConnections,
            waitingClients: this.metrics.waitingClients,
            isHealthy: this.metrics.isHealthy
        };
    }
    /**
     * Gracefully shutdown the database manager
     */
    async shutdown() {
        this.isShuttingDown = true;
        // Stop health check monitoring
        if (this.healthCheckInterval) {
            clearInterval(this.healthCheckInterval);
            this.healthCheckInterval = null;
        }
        // Close connection pool
        if (this.pool) {
            await this.pool.end();
            this.pool = null;
        }
        this.emit('shutdown');
    }
}
exports.DatabaseManager = DatabaseManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLWJyYWluL3NyYy9kYXRhYmFzZS9EYXRhYmFzZU1hbmFnZXIudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7O0dBT0c7OztBQUVILDJCQUFrRDtBQUNsRCxtQ0FBc0M7QUFxRHRDOztHQUVHO0FBQ0gsTUFBYSxlQUFnQixTQUFRLHFCQUFZO0lBQ3ZDLElBQUksR0FBZ0IsSUFBSSxDQUFDO0lBQ3pCLE1BQU0sQ0FBaUI7SUFDdkIsT0FBTyxDQUFrQjtJQUN6QixtQkFBbUIsR0FBMEIsSUFBSSxDQUFDO0lBQ2xELGlCQUFpQixHQUFXLENBQUMsQ0FBQztJQUM5QixjQUFjLEdBQVksS0FBSyxDQUFDO0lBQ2hDLFlBQVksR0FBYSxFQUFFLENBQUMsQ0FBQyxzQ0FBc0M7SUFFM0UsWUFBWSxNQUFzQjtRQUNoQyxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxPQUFPLEdBQUcsSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7SUFDMUMsQ0FBQztJQUVEOztPQUVHO0lBQ0ssaUJBQWlCO1FBQ3ZCLE9BQU87WUFDTCxnQkFBZ0IsRUFBRSxDQUFDO1lBQ25CLGVBQWUsRUFBRSxDQUFDO1lBQ2xCLGNBQWMsRUFBRSxDQUFDO1lBQ2pCLFlBQVksRUFBRSxDQUFDO1lBQ2YsaUJBQWlCLEVBQUUsQ0FBQztZQUNwQixhQUFhLEVBQUUsQ0FBQztZQUNoQixnQkFBZ0IsRUFBRSxDQUFDO1lBQ25CLGdCQUFnQixFQUFFLENBQUM7WUFDbkIsZUFBZSxFQUFFLENBQUM7WUFDbEIsU0FBUyxFQUFFLEtBQUs7U0FDakIsQ0FBQztJQUNKLENBQUM7SUFFRDs7T0FFRztJQUNILE1BQU0sQ0FBQyxtQkFBbUI7UUFDeEIsMENBQTBDO1FBQzFDLE1BQU0sV0FBVyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsWUFBWSxDQUFDO1FBQzdDLElBQUksWUFBWSxHQUE0QixF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Q0FBQztJQUNKLENBQUM7SUFFRDs7T0FFRztJQUNILEtBQUssQ0FBQyxRQUFRO1FBQ1osSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFJLENBQUM7UUFFM0IsK0JBQStCO1FBQy9CLElBQUksSUFBSSxDQUFDLG1CQUFtQixFQUFFLENBQUM7WUFDN0IsYUFBYSxDQUFDLElBQUksQ0FBQyxtQkFBbUIsQ0FBQyxDQUFDO1lBQ3hDLElBQUksQ0FBQyxtQkFBbUIsR0FBRyxJQUFJLENBQUM7UUFDbEMsQ0FBQztRQUVELHdCQUF3QjtRQUN4QixJQUFJLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNkLE1BQU0sSUFBSSxDQUFDLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztZQUN0QixJQUFJLENBQUMsSUFBSSxHQUFHLElBQUksQ0FBQztRQUNuQixDQUFDO1FBRUQsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUN4QixDQUFDO0NBQ0Y7QUE1Y0QsMENBNGNDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9pdmFuL0NvZGUvdHJhZGluZy90aXRhbi9zZXJ2aWNlcy90aXRhbi1icmFpbi9zcmMvZGF0YWJhc2UvRGF0YWJhc2VNYW5hZ2VyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogRGF0YWJhc2VNYW5hZ2VyIC0gUmVsaWFibGUgZGF0YWJhc2UgY29ubmVjdGlvbiBwb29saW5nIHdpdGggaGVhbHRoIG1vbml0b3JpbmdcbiAqIFxuICogUHJvdmlkZXMgcm9idXN0IGRhdGFiYXNlIGNvbm5lY3Rpdml0eSB3aXRoIGNvbm5lY3Rpb24gcG9vbGluZywgaGVhbHRoIG1vbml0b3JpbmcsXG4gKiBhdXRvbWF0aWMgcmVjb25uZWN0aW9uLCBhbmQgY29tcHJlaGVuc2l2ZSBlcnJvciBoYW5kbGluZyBmb3IgUmFpbHdheSBkZXBsb3ltZW50LlxuICogXG4gKiBSZXF1aXJlbWVudHM6IDMuMS4xLCAzLjEuMiwgMy4xLjMsIDMuMS40LCAzLjEuNVxuICovXG5cbmltcG9ydCB7IFBvb2wsIFBvb2xDbGllbnQsIFBvb2xDb25maWcgfSBmcm9tICdwZyc7XG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdldmVudHMnO1xuXG4vKipcbiAqIERhdGFiYXNlIGNvbm5lY3Rpb24gY29uZmlndXJhdGlvblxuICovXG5leHBvcnQgaW50ZXJmYWNlIERhdGFiYXNlQ29uZmlnIHtcbiAgaG9zdDogc3RyaW5nO1xuICBwb3J0OiBudW1iZXI7XG4gIGRhdGFiYXNlOiBzdHJpbmc7XG4gIHVzZXI6IHN0cmluZztcbiAgcGFzc3dvcmQ6IHN0cmluZztcbiAgc3NsPzogYm9vbGVhbiB8IG9iamVjdDtcbiAgXG4gIC8vIENvbm5lY3Rpb24gcG9vbCBzZXR0aW5nc1xuICBtaW46IG51bWJlcjtcbiAgbWF4OiBudW1iZXI7XG4gIGlkbGVUaW1lb3V0TWlsbGlzOiBudW1iZXI7XG4gIGNvbm5lY3Rpb25UaW1lb3V0TWlsbGlzOiBudW1iZXI7XG4gIGFjcXVpcmVUaW1lb3V0TWlsbGlzOiBudW1iZXI7XG4gIFxuICAvLyBIZWFsdGggY2hlY2sgc2V0dGluZ3NcbiAgaGVhbHRoQ2hlY2tJbnRlcnZhbE1zOiBudW1iZXI7XG4gIGhlYWx0aENoZWNrVGltZW91dE1zOiBudW1iZXI7XG4gIG1heFJlY29ubmVjdEF0dGVtcHRzOiBudW1iZXI7XG4gIHJlY29ubmVjdERlbGF5TXM6IG51bWJlcjtcbn1cblxuLyoqXG4gKiBEYXRhYmFzZSBjb25uZWN0aW9uIG1ldHJpY3NcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBEYXRhYmFzZU1ldHJpY3Mge1xuICB0b3RhbENvbm5lY3Rpb25zOiBudW1iZXI7XG4gIGlkbGVDb25uZWN0aW9uczogbnVtYmVyO1xuICB3YWl0aW5nQ2xpZW50czogbnVtYmVyO1xuICB0b3RhbFF1ZXJpZXM6IG51bWJlcjtcbiAgc3VjY2Vzc2Z1bFF1ZXJpZXM6IG51bWJlcjtcbiAgZmFpbGVkUXVlcmllczogbnVtYmVyO1xuICBhdmVyYWdlUXVlcnlUaW1lOiBudW1iZXI7XG4gIGNvbm5lY3Rpb25FcnJvcnM6IG51bWJlcjtcbiAgbGFzdEhlYWx0aENoZWNrOiBudW1iZXI7XG4gIGlzSGVhbHRoeTogYm9vbGVhbjtcbn1cblxuLyoqXG4gKiBRdWVyeSBleGVjdXRpb24gcmVzdWx0IHdpdGggdGltaW5nXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgUXVlcnlSZXN1bHQ8VCA9IGFueT4ge1xuICByb3dzOiBUW107XG4gIHJvd0NvdW50OiBudW1iZXI7XG4gIGR1cmF0aW9uOiBudW1iZXI7XG4gIGNvbW1hbmQ6IHN0cmluZztcbn1cblxuLyoqXG4gKiBEYXRhYmFzZSBjb25uZWN0aW9uIHBvb2wgbWFuYWdlciB3aXRoIGhlYWx0aCBtb25pdG9yaW5nXG4gKi9cbmV4cG9ydCBjbGFzcyBEYXRhYmFzZU1hbmFnZXIgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICBwcml2YXRlIHBvb2w6IFBvb2wgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBjb25maWc6IERhdGFiYXNlQ29uZmlnO1xuICBwcml2YXRlIG1ldHJpY3M6IERhdGFiYXNlTWV0cmljcztcbiAgcHJpdmF0ZSBoZWFsdGhDaGVja0ludGVydmFsOiBOb2RlSlMuVGltZW91dCB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIHJlY29ubmVjdEF0dGVtcHRzOiBudW1iZXIgPSAwO1xuICBwcml2YXRlIGlzU2h1dHRpbmdEb3duOiBib29sZWFuID0gZmFsc2U7XG4gIHByaXZhdGUgcXVlcnlIaXN0b3J5OiBudW1iZXJbXSA9IFtdOyAvLyBRdWVyeSB0aW1lcyBmb3IgYXZlcmFnZSBjYWxjdWxhdGlvblxuXG4gIGNvbnN0cnVjdG9yKGNvbmZpZzogRGF0YWJhc2VDb25maWcpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuICAgIHRoaXMubWV0cmljcyA9IHRoaXMuaW5pdGlhbGl6ZU1ldHJpY3MoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplIG1ldHJpY3Mgb2JqZWN0XG4gICAqL1xuICBwcml2YXRlIGluaXRpYWxpemVNZXRyaWNzKCk6IERhdGFiYXNlTWV0cmljcyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIHRvdGFsQ29ubmVjdGlvbnM6IDAsXG4gICAgICBpZGxlQ29ubmVjdGlvbnM6IDAsXG4gICAgICB3YWl0aW5nQ2xpZW50czogMCxcbiAgICAgIHRvdGFsUXVlcmllczogMCxcbiAgICAgIHN1Y2Nlc3NmdWxRdWVyaWVzOiAwLFxuICAgICAgZmFpbGVkUXVlcmllczogMCxcbiAgICAgIGF2ZXJhZ2VRdWVyeVRpbWU6IDAsXG4gICAgICBjb25uZWN0aW9uRXJyb3JzOiAwLFxuICAgICAgbGFzdEhlYWx0aENoZWNrOiAwLFxuICAgICAgaXNIZWFsdGh5OiBmYWxzZVxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGRhdGFiYXNlIGNvbmZpZ3VyYXRpb24gZnJvbSBlbnZpcm9ubWVudCB2YXJpYWJsZXNcbiAgICovXG4gIHN0YXRpYyBjcmVhdGVDb25maWdGcm9tRW52KCk6IERhdGFiYXNlQ29uZmlnIHtcbiAgICAvLyBQYXJzZSBSYWlsd2F5IERBVEFCQVNFX1VSTCBpZiBhdmFpbGFibGVcbiAgICBjb25zdCBkYXRhYmFzZVVybCA9IHByb2Nlc3MuZW52LkRBVEFCQVNFX1VSTDtcbiAgICBsZXQgcGFyc2VkQ29uZmlnOiBQYXJ0aWFsPERhdGFiYXNlQ29uZmlnPiA9IHt9O1xuXG4gICAgaWYgKGRhdGFiYXNlVXJsKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCB1cmwgPSBuZXcgVVJMKGRhdGFiYXNlVXJsKTtcbiAgICAgICAgcGFyc2VkQ29uZmlnID0ge1xuICAgICAgICAgIGhvc3Q6IHVybC5ob3N0bmFtZSxcbiAgICAgICAgICBwb3J0OiBwYXJzZUludCh1cmwucG9ydCkgfHwgNTQzMixcbiAgICAgICAgICBkYXRhYmFzZTogdXJsLnBhdGhuYW1lLnNsaWNlKDEpLCAvLyBSZW1vdmUgbGVhZGluZyBzbGFzaFxuICAgICAgICAgIHVzZXI6IHVybC51c2VybmFtZSxcbiAgICAgICAgICBwYXNzd29yZDogdXJsLnBhc3N3b3JkLFxuICAgICAgICAgIHNzbDogdXJsLnNlYXJjaFBhcmFtcy5nZXQoJ3NzbG1vZGUnKSAhPT0gJ2Rpc2FibGUnXG4gICAgICAgIH07XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLndhcm4oJ0ZhaWxlZCB0byBwYXJzZSBEQVRBQkFTRV9VUkwsIGZhbGxpbmcgYmFjayB0byBpbmRpdmlkdWFsIGVudiB2YXJzJyk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIGhvc3Q6IHBhcnNlZENvbmZpZy5ob3N0IHx8IHByb2Nlc3MuZW52LkRCX0hPU1QgfHwgJ2xvY2FsaG9zdCcsXG4gICAgICBwb3J0OiBwYXJzZWRDb25maWcucG9ydCB8fCBwYXJzZUludChwcm9jZXNzLmVudi5EQl9QT1JUIHx8ICc1NDMyJyksXG4gICAgICBkYXRhYmFzZTogcGFyc2VkQ29uZmlnLmRhdGFiYXNlIHx8IHByb2Nlc3MuZW52LkRCX05BTUUgfHwgJ3RpdGFuX2JyYWluJyxcbiAgICAgIHVzZXI6IHBhcnNlZENvbmZpZy51c2VyIHx8IHByb2Nlc3MuZW52LkRCX1VTRVIgfHwgJ3Bvc3RncmVzJyxcbiAgICAgIHBhc3N3b3JkOiBwYXJzZWRDb25maWcucGFzc3dvcmQgfHwgcHJvY2Vzcy5lbnYuREJfUEFTU1dPUkQgfHwgJycsXG4gICAgICBzc2w6IHBhcnNlZENvbmZpZy5zc2wgIT09IHVuZGVmaW5lZCA/IHBhcnNlZENvbmZpZy5zc2wgOiAocHJvY2Vzcy5lbnYuREJfU1NMID09PSAndHJ1ZScpLFxuICAgICAgXG4gICAgICAvLyBDb25uZWN0aW9uIHBvb2wgc2V0dGluZ3NcbiAgICAgIG1pbjogcGFyc2VJbnQocHJvY2Vzcy5lbnYuREJfUE9PTF9NSU4gfHwgJzInKSxcbiAgICAgIG1heDogcGFyc2VJbnQocHJvY2Vzcy5lbnYuREJfUE9PTF9NQVggfHwgJzEwJyksXG4gICAgICBpZGxlVGltZW91dE1pbGxpczogcGFyc2VJbnQocHJvY2Vzcy5lbnYuREJfSURMRV9USU1FT1VUIHx8ICczMDAwMCcpLFxuICAgICAgY29ubmVjdGlvblRpbWVvdXRNaWxsaXM6IHBhcnNlSW50KHByb2Nlc3MuZW52LkRCX0NPTk5FQ1RJT05fVElNRU9VVCB8fCAnMTAwMDAnKSxcbiAgICAgIGFjcXVpcmVUaW1lb3V0TWlsbGlzOiBwYXJzZUludChwcm9jZXNzLmVudi5EQl9BQ1FVSVJFX1RJTUVPVVQgfHwgJzUwMDAnKSxcbiAgICAgIFxuICAgICAgLy8gSGVhbHRoIGNoZWNrIHNldHRpbmdzXG4gICAgICBoZWFsdGhDaGVja0ludGVydmFsTXM6IHBhcnNlSW50KHByb2Nlc3MuZW52LkRCX0hFQUxUSF9DSEVDS19JTlRFUlZBTCB8fCAnMzAwMDAnKSxcbiAgICAgIGhlYWx0aENoZWNrVGltZW91dE1zOiBwYXJzZUludChwcm9jZXNzLmVudi5EQl9IRUFMVEhfQ0hFQ0tfVElNRU9VVCB8fCAnNTAwMCcpLFxuICAgICAgbWF4UmVjb25uZWN0QXR0ZW1wdHM6IHBhcnNlSW50KHByb2Nlc3MuZW52LkRCX01BWF9SRUNPTk5FQ1RfQVRURU1QVFMgfHwgJzUnKSxcbiAgICAgIHJlY29ubmVjdERlbGF5TXM6IHBhcnNlSW50KHByb2Nlc3MuZW52LkRCX1JFQ09OTkVDVF9ERUxBWSB8fCAnNTAwMCcpXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBJbml0aWFsaXplIGRhdGFiYXNlIGNvbm5lY3Rpb24gcG9vbFxuICAgKi9cbiAgYXN5bmMgaW5pdGlhbGl6ZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAodGhpcy5wb29sKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RhdGFiYXNlTWFuYWdlciBhbHJlYWR5IGluaXRpYWxpemVkJyk7XG4gICAgfVxuXG4gICAgY29uc3QgcG9vbENvbmZpZzogUG9vbENvbmZpZyA9IHtcbiAgICAgIGhvc3Q6IHRoaXMuY29uZmlnLmhvc3QsXG4gICAgICBwb3J0OiB0aGlzLmNvbmZpZy5wb3J0LFxuICAgICAgZGF0YWJhc2U6IHRoaXMuY29uZmlnLmRhdGFiYXNlLFxuICAgICAgdXNlcjogdGhpcy5jb25maWcudXNlcixcbiAgICAgIHBhc3N3b3JkOiB0aGlzLmNvbmZpZy5wYXNzd29yZCxcbiAgICAgIHNzbDogdGhpcy5jb25maWcuc3NsLFxuICAgICAgbWluOiB0aGlzLmNvbmZpZy5taW4sXG4gICAgICBtYXg6IHRoaXMuY29uZmlnLm1heCxcbiAgICAgIGlkbGVUaW1lb3V0TWlsbGlzOiB0aGlzLmNvbmZpZy5pZGxlVGltZW91dE1pbGxpcyxcbiAgICAgIGNvbm5lY3Rpb25UaW1lb3V0TWlsbGlzOiB0aGlzLmNvbmZpZy5jb25uZWN0aW9uVGltZW91dE1pbGxpc1xuICAgIH07XG5cbiAgICB0aGlzLnBvb2wgPSBuZXcgUG9vbChwb29sQ29uZmlnKTtcblxuICAgIC8vIFNldCB1cCBwb29sIGV2ZW50IGxpc3RlbmVyc1xuICAgIHRoaXMuc2V0dXBQb29sRXZlbnRMaXN0ZW5lcnMoKTtcblxuICAgIC8vIFRlc3QgaW5pdGlhbCBjb25uZWN0aW9uXG4gICAgYXdhaXQgdGhpcy50ZXN0Q29ubmVjdGlvbigpO1xuXG4gICAgLy8gU3RhcnQgaGVhbHRoIGNoZWNrIG1vbml0b3JpbmdcbiAgICB0aGlzLnN0YXJ0SGVhbHRoQ2hlY2tNb25pdG9yaW5nKCk7XG5cbiAgICB0aGlzLmVtaXQoJ2luaXRpYWxpemVkJyk7XG4gIH1cblxuICAvKipcbiAgICogU2V0IHVwIHBvb2wgZXZlbnQgbGlzdGVuZXJzIGZvciBtb25pdG9yaW5nXG4gICAqL1xuICBwcml2YXRlIHNldHVwUG9vbEV2ZW50TGlzdGVuZXJzKCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5wb29sKSByZXR1cm47XG5cbiAgICB0aGlzLnBvb2wub24oJ2Nvbm5lY3QnLCAoY2xpZW50KSA9PiB7XG4gICAgICB0aGlzLm1ldHJpY3MudG90YWxDb25uZWN0aW9ucysrO1xuICAgICAgdGhpcy5lbWl0KCdjb25uZWN0aW9uOmVzdGFibGlzaGVkJywgeyB0b3RhbENvbm5lY3Rpb25zOiB0aGlzLm1ldHJpY3MudG90YWxDb25uZWN0aW9ucyB9KTtcbiAgICB9KTtcblxuICAgIHRoaXMucG9vbC5vbignYWNxdWlyZScsIChjbGllbnQpID0+IHtcbiAgICAgIHRoaXMudXBkYXRlUG9vbE1ldHJpY3MoKTtcbiAgICB9KTtcblxuICAgIHRoaXMucG9vbC5vbigncmVsZWFzZScsIChjbGllbnQpID0+IHtcbiAgICAgIHRoaXMudXBkYXRlUG9vbE1ldHJpY3MoKTtcbiAgICB9KTtcblxuICAgIHRoaXMucG9vbC5vbigncmVtb3ZlJywgKGNsaWVudCkgPT4ge1xuICAgICAgdGhpcy5tZXRyaWNzLnRvdGFsQ29ubmVjdGlvbnMtLTtcbiAgICAgIHRoaXMuZW1pdCgnY29ubmVjdGlvbjpyZW1vdmVkJywgeyB0b3RhbENvbm5lY3Rpb25zOiB0aGlzLm1ldHJpY3MudG90YWxDb25uZWN0aW9ucyB9KTtcbiAgICB9KTtcblxuICAgIHRoaXMucG9vbC5vbignZXJyb3InLCAoZXJyb3IsIGNsaWVudCkgPT4ge1xuICAgICAgdGhpcy5tZXRyaWNzLmNvbm5lY3Rpb25FcnJvcnMrKztcbiAgICAgIHRoaXMubWV0cmljcy5pc0hlYWx0aHkgPSBmYWxzZTtcbiAgICAgIHRoaXMuZW1pdCgnY29ubmVjdGlvbjplcnJvcicsIHsgZXJyb3I6IGVycm9yLm1lc3NhZ2UsIGNvbm5lY3Rpb25FcnJvcnM6IHRoaXMubWV0cmljcy5jb25uZWN0aW9uRXJyb3JzIH0pO1xuICAgICAgXG4gICAgICAvLyBBdHRlbXB0IHJlY29ubmVjdGlvbiBpZiBub3Qgc2h1dHRpbmcgZG93blxuICAgICAgaWYgKCF0aGlzLmlzU2h1dHRpbmdEb3duKSB7XG4gICAgICAgIHRoaXMuYXR0ZW1wdFJlY29ubmVjdGlvbigpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSBwb29sIG1ldHJpY3MgZnJvbSBjdXJyZW50IHBvb2wgc3RhdGVcbiAgICovXG4gIHByaXZhdGUgdXBkYXRlUG9vbE1ldHJpY3MoKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLnBvb2wpIHJldHVybjtcblxuICAgIHRoaXMubWV0cmljcy50b3RhbENvbm5lY3Rpb25zID0gdGhpcy5wb29sLnRvdGFsQ291bnQ7XG4gICAgdGhpcy5tZXRyaWNzLmlkbGVDb25uZWN0aW9ucyA9IHRoaXMucG9vbC5pZGxlQ291bnQ7XG4gICAgdGhpcy5tZXRyaWNzLndhaXRpbmdDbGllbnRzID0gdGhpcy5wb29sLndhaXRpbmdDb3VudDtcbiAgfVxuXG4gIC8qKlxuICAgKiBUZXN0IGRhdGFiYXNlIGNvbm5lY3Rpb25cbiAgICovXG4gIHByaXZhdGUgYXN5bmMgdGVzdENvbm5lY3Rpb24oKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCF0aGlzLnBvb2wpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignUG9vbCBub3QgaW5pdGlhbGl6ZWQnKTtcbiAgICB9XG5cbiAgICBjb25zdCBjbGllbnQgPSBhd2FpdCB0aGlzLnBvb2wuY29ubmVjdCgpO1xuICAgIHRyeSB7XG4gICAgICBhd2FpdCBjbGllbnQucXVlcnkoJ1NFTEVDVCAxJyk7XG4gICAgICB0aGlzLm1ldHJpY3MuaXNIZWFsdGh5ID0gdHJ1ZTtcbiAgICAgIHRoaXMucmVjb25uZWN0QXR0ZW1wdHMgPSAwOyAvLyBSZXNldCBvbiBzdWNjZXNzZnVsIGNvbm5lY3Rpb25cbiAgICB9IGZpbmFsbHkge1xuICAgICAgY2xpZW50LnJlbGVhc2UoKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU3RhcnQgaGVhbHRoIGNoZWNrIG1vbml0b3JpbmdcbiAgICovXG4gIHByaXZhdGUgc3RhcnRIZWFsdGhDaGVja01vbml0b3JpbmcoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaGVhbHRoQ2hlY2tJbnRlcnZhbCkge1xuICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLmhlYWx0aENoZWNrSW50ZXJ2YWwpO1xuICAgIH1cblxuICAgIHRoaXMuaGVhbHRoQ2hlY2tJbnRlcnZhbCA9IHNldEludGVydmFsKGFzeW5jICgpID0+IHtcbiAgICAgIGF3YWl0IHRoaXMucGVyZm9ybUhlYWx0aENoZWNrKCk7XG4gICAgfSwgdGhpcy5jb25maWcuaGVhbHRoQ2hlY2tJbnRlcnZhbE1zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBQZXJmb3JtIGhlYWx0aCBjaGVja1xuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBwZXJmb3JtSGVhbHRoQ2hlY2soKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKHRoaXMuaXNTaHV0dGluZ0Rvd24pIHJldHVybjtcblxuICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgXG4gICAgdHJ5IHtcbiAgICAgIGF3YWl0IFByb21pc2UucmFjZShbXG4gICAgICAgIHRoaXMudGVzdENvbm5lY3Rpb24oKSxcbiAgICAgICAgbmV3IFByb21pc2UoKF8sIHJlamVjdCkgPT4gXG4gICAgICAgICAgc2V0VGltZW91dCgoKSA9PiByZWplY3QobmV3IEVycm9yKCdIZWFsdGggY2hlY2sgdGltZW91dCcpKSwgdGhpcy5jb25maWcuaGVhbHRoQ2hlY2tUaW1lb3V0TXMpXG4gICAgICAgIClcbiAgICAgIF0pO1xuXG4gICAgICB0aGlzLm1ldHJpY3MubGFzdEhlYWx0aENoZWNrID0gRGF0ZS5ub3coKTtcbiAgICAgIHRoaXMubWV0cmljcy5pc0hlYWx0aHkgPSB0cnVlO1xuICAgICAgdGhpcy5lbWl0KCdoZWFsdGg6Y2hlY2s6c3VjY2VzcycsIHsgZHVyYXRpb246IERhdGUubm93KCkgLSBzdGFydFRpbWUgfSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubWV0cmljcy5sYXN0SGVhbHRoQ2hlY2sgPSBEYXRlLm5vdygpO1xuICAgICAgdGhpcy5tZXRyaWNzLmlzSGVhbHRoeSA9IGZhbHNlO1xuICAgICAgdGhpcy5lbWl0KCdoZWFsdGg6Y2hlY2s6ZmFpbHVyZScsIHsgXG4gICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICAgICAgZHVyYXRpb246IERhdGUubm93KCkgLSBzdGFydFRpbWVcbiAgICAgIH0pO1xuXG4gICAgICAvLyBBdHRlbXB0IHJlY29ubmVjdGlvbiBvbiBoZWFsdGggY2hlY2sgZmFpbHVyZVxuICAgICAgdGhpcy5hdHRlbXB0UmVjb25uZWN0aW9uKCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEF0dGVtcHQgZGF0YWJhc2UgcmVjb25uZWN0aW9uIHdpdGggZXhwb25lbnRpYWwgYmFja29mZlxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBhdHRlbXB0UmVjb25uZWN0aW9uKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICh0aGlzLmlzU2h1dHRpbmdEb3duIHx8IHRoaXMucmVjb25uZWN0QXR0ZW1wdHMgPj0gdGhpcy5jb25maWcubWF4UmVjb25uZWN0QXR0ZW1wdHMpIHtcbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLnJlY29ubmVjdEF0dGVtcHRzKys7XG4gICAgY29uc3QgZGVsYXkgPSB0aGlzLmNvbmZpZy5yZWNvbm5lY3REZWxheU1zICogTWF0aC5wb3coMiwgdGhpcy5yZWNvbm5lY3RBdHRlbXB0cyAtIDEpO1xuICAgIFxuICAgIHRoaXMuZW1pdCgncmVjb25uZWN0aW9uOmF0dGVtcHQnLCB7IFxuICAgICAgYXR0ZW1wdDogdGhpcy5yZWNvbm5lY3RBdHRlbXB0cywgXG4gICAgICBtYXhBdHRlbXB0czogdGhpcy5jb25maWcubWF4UmVjb25uZWN0QXR0ZW1wdHMsXG4gICAgICBkZWxheSBcbiAgICB9KTtcblxuICAgIHNldFRpbWVvdXQoYXN5bmMgKCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy50ZXN0Q29ubmVjdGlvbigpO1xuICAgICAgICB0aGlzLmVtaXQoJ3JlY29ubmVjdGlvbjpzdWNjZXNzJywgeyBhdHRlbXB0czogdGhpcy5yZWNvbm5lY3RBdHRlbXB0cyB9KTtcbiAgICAgICAgdGhpcy5yZWNvbm5lY3RBdHRlbXB0cyA9IDA7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICB0aGlzLmVtaXQoJ3JlY29ubmVjdGlvbjpmYWlsdXJlJywgeyBcbiAgICAgICAgICBhdHRlbXB0OiB0aGlzLnJlY29ubmVjdEF0dGVtcHRzLFxuICAgICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJ1xuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIC8vIENvbnRpbnVlIGF0dGVtcHRpbmcgaWYgd2UgaGF2ZW4ndCByZWFjaGVkIG1heCBhdHRlbXB0c1xuICAgICAgICBpZiAodGhpcy5yZWNvbm5lY3RBdHRlbXB0cyA8IHRoaXMuY29uZmlnLm1heFJlY29ubmVjdEF0dGVtcHRzKSB7XG4gICAgICAgICAgdGhpcy5hdHRlbXB0UmVjb25uZWN0aW9uKCk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5lbWl0KCdyZWNvbm5lY3Rpb246ZXhoYXVzdGVkJywgeyBtYXhBdHRlbXB0czogdGhpcy5jb25maWcubWF4UmVjb25uZWN0QXR0ZW1wdHMgfSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9LCBkZWxheSk7XG4gIH1cblxuICAvKipcbiAgICogRXhlY3V0ZSBhIHF1ZXJ5IHdpdGggdGltaW5nIGFuZCBlcnJvciBoYW5kbGluZ1xuICAgKi9cbiAgYXN5bmMgcXVlcnk8VCA9IGFueT4odGV4dDogc3RyaW5nLCBwYXJhbXM/OiBhbnlbXSk6IFByb21pc2U8UXVlcnlSZXN1bHQ8VD4+IHtcbiAgICBpZiAoIXRoaXMucG9vbCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdEYXRhYmFzZU1hbmFnZXIgbm90IGluaXRpYWxpemVkJyk7XG4gICAgfVxuXG4gICAgaWYgKCF0aGlzLm1ldHJpY3MuaXNIZWFsdGh5KSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RhdGFiYXNlIGlzIG5vdCBoZWFsdGh5Jyk7XG4gICAgfVxuXG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICB0aGlzLm1ldHJpY3MudG90YWxRdWVyaWVzKys7XG5cbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5wb29sLnF1ZXJ5KHRleHQsIHBhcmFtcyk7XG4gICAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG4gICAgICBcbiAgICAgIC8vIFVwZGF0ZSBtZXRyaWNzXG4gICAgICB0aGlzLm1ldHJpY3Muc3VjY2Vzc2Z1bFF1ZXJpZXMrKztcbiAgICAgIHRoaXMudXBkYXRlUXVlcnlUaW1lTWV0cmljcyhkdXJhdGlvbik7XG4gICAgICBcbiAgICAgIHRoaXMuZW1pdCgncXVlcnk6c3VjY2VzcycsIHsgXG4gICAgICAgIGNvbW1hbmQ6IHJlc3VsdC5jb21tYW5kLFxuICAgICAgICByb3dDb3VudDogcmVzdWx0LnJvd0NvdW50LFxuICAgICAgICBkdXJhdGlvbiBcbiAgICAgIH0pO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICByb3dzOiByZXN1bHQucm93cyxcbiAgICAgICAgcm93Q291bnQ6IHJlc3VsdC5yb3dDb3VudCB8fCAwLFxuICAgICAgICBkdXJhdGlvbixcbiAgICAgICAgY29tbWFuZDogcmVzdWx0LmNvbW1hbmQgfHwgJ1VOS05PV04nXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG4gICAgICB0aGlzLm1ldHJpY3MuZmFpbGVkUXVlcmllcysrO1xuICAgICAgXG4gICAgICB0aGlzLmVtaXQoJ3F1ZXJ5OmZhaWx1cmUnLCB7IFxuICAgICAgICBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcicsXG4gICAgICAgIGR1cmF0aW9uLFxuICAgICAgICBxdWVyeTogdGV4dC5zdWJzdHJpbmcoMCwgMTAwKSAvLyBMb2cgZmlyc3QgMTAwIGNoYXJzIGZvciBkZWJ1Z2dpbmdcbiAgICAgIH0pO1xuICAgICAgXG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRXhlY3V0ZSBhIHF1ZXJ5IHdpdGggYSBzcGVjaWZpYyBjbGllbnQgKGZvciB0cmFuc2FjdGlvbnMpXG4gICAqL1xuICBhc3luYyBxdWVyeVdpdGhDbGllbnQ8VCA9IGFueT4oY2xpZW50OiBQb29sQ2xpZW50LCB0ZXh0OiBzdHJpbmcsIHBhcmFtcz86IGFueVtdKTogUHJvbWlzZTxRdWVyeVJlc3VsdDxUPj4ge1xuICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgdGhpcy5tZXRyaWNzLnRvdGFsUXVlcmllcysrO1xuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IGNsaWVudC5xdWVyeSh0ZXh0LCBwYXJhbXMpO1xuICAgICAgY29uc3QgZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xuICAgICAgXG4gICAgICAvLyBVcGRhdGUgbWV0cmljc1xuICAgICAgdGhpcy5tZXRyaWNzLnN1Y2Nlc3NmdWxRdWVyaWVzKys7XG4gICAgICB0aGlzLnVwZGF0ZVF1ZXJ5VGltZU1ldHJpY3MoZHVyYXRpb24pO1xuICAgICAgXG4gICAgICB0aGlzLmVtaXQoJ3F1ZXJ5OnN1Y2Nlc3MnLCB7IFxuICAgICAgICBjb21tYW5kOiByZXN1bHQuY29tbWFuZCxcbiAgICAgICAgcm93Q291bnQ6IHJlc3VsdC5yb3dDb3VudCxcbiAgICAgICAgZHVyYXRpb24gXG4gICAgICB9KTtcblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcm93czogcmVzdWx0LnJvd3MsXG4gICAgICAgIHJvd0NvdW50OiByZXN1bHQucm93Q291bnQgfHwgMCxcbiAgICAgICAgZHVyYXRpb24sXG4gICAgICAgIGNvbW1hbmQ6IHJlc3VsdC5jb21tYW5kIHx8ICdVTktOT1dOJ1xuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc3QgZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xuICAgICAgdGhpcy5tZXRyaWNzLmZhaWxlZFF1ZXJpZXMrKztcbiAgICAgIFxuICAgICAgdGhpcy5lbWl0KCdxdWVyeTpmYWlsdXJlJywgeyBcbiAgICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InLFxuICAgICAgICBkdXJhdGlvbixcbiAgICAgICAgcXVlcnk6IHRleHQuc3Vic3RyaW5nKDAsIDEwMClcbiAgICAgIH0pO1xuICAgICAgXG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IGEgY2xpZW50IGZyb20gdGhlIHBvb2wgZm9yIHRyYW5zYWN0aW9uc1xuICAgKi9cbiAgYXN5bmMgZ2V0Q2xpZW50KCk6IFByb21pc2U8UG9vbENsaWVudD4ge1xuICAgIGlmICghdGhpcy5wb29sKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0RhdGFiYXNlTWFuYWdlciBub3QgaW5pdGlhbGl6ZWQnKTtcbiAgICB9XG5cbiAgICBpZiAoIXRoaXMubWV0cmljcy5pc0hlYWx0aHkpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignRGF0YWJhc2UgaXMgbm90IGhlYWx0aHknKTtcbiAgICB9XG5cbiAgICByZXR1cm4gYXdhaXQgdGhpcy5wb29sLmNvbm5lY3QoKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFeGVjdXRlIGEgdHJhbnNhY3Rpb24gd2l0aCBhdXRvbWF0aWMgcm9sbGJhY2sgb24gZXJyb3JcbiAgICovXG4gIGFzeW5jIHRyYW5zYWN0aW9uPFQ+KGNhbGxiYWNrOiAoY2xpZW50OiBQb29sQ2xpZW50KSA9PiBQcm9taXNlPFQ+KTogUHJvbWlzZTxUPiB7XG4gICAgY29uc3QgY2xpZW50ID0gYXdhaXQgdGhpcy5nZXRDbGllbnQoKTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgYXdhaXQgY2xpZW50LnF1ZXJ5KCdCRUdJTicpO1xuICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgY2FsbGJhY2soY2xpZW50KTtcbiAgICAgIGF3YWl0IGNsaWVudC5xdWVyeSgnQ09NTUlUJyk7XG4gICAgICBcbiAgICAgIHRoaXMuZW1pdCgndHJhbnNhY3Rpb246c3VjY2VzcycpO1xuICAgICAgcmV0dXJuIHJlc3VsdDtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgYXdhaXQgY2xpZW50LnF1ZXJ5KCdST0xMQkFDSycpO1xuICAgICAgdGhpcy5lbWl0KCd0cmFuc2FjdGlvbjpyb2xsYmFjaycsIHsgXG4gICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyBcbiAgICAgIH0pO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfSBmaW5hbGx5IHtcbiAgICAgIGNsaWVudC5yZWxlYXNlKCk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSBxdWVyeSB0aW1lIG1ldHJpY3NcbiAgICovXG4gIHByaXZhdGUgdXBkYXRlUXVlcnlUaW1lTWV0cmljcyhkdXJhdGlvbjogbnVtYmVyKTogdm9pZCB7XG4gICAgdGhpcy5xdWVyeUhpc3RvcnkucHVzaChkdXJhdGlvbik7XG4gICAgXG4gICAgLy8gS2VlcCBvbmx5IGxhc3QgMTAwIHF1ZXJpZXMgZm9yIGF2ZXJhZ2UgY2FsY3VsYXRpb25cbiAgICBpZiAodGhpcy5xdWVyeUhpc3RvcnkubGVuZ3RoID4gMTAwKSB7XG4gICAgICB0aGlzLnF1ZXJ5SGlzdG9yeS5zaGlmdCgpO1xuICAgIH1cbiAgICBcbiAgICAvLyBDYWxjdWxhdGUgYXZlcmFnZSBxdWVyeSB0aW1lXG4gICAgdGhpcy5tZXRyaWNzLmF2ZXJhZ2VRdWVyeVRpbWUgPSB0aGlzLnF1ZXJ5SGlzdG9yeS5yZWR1Y2UoKHN1bSwgdGltZSkgPT4gc3VtICsgdGltZSwgMCkgLyB0aGlzLnF1ZXJ5SGlzdG9yeS5sZW5ndGg7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGN1cnJlbnQgZGF0YWJhc2UgbWV0cmljc1xuICAgKi9cbiAgZ2V0TWV0cmljcygpOiBEYXRhYmFzZU1ldHJpY3Mge1xuICAgIHRoaXMudXBkYXRlUG9vbE1ldHJpY3MoKTtcbiAgICByZXR1cm4geyAuLi50aGlzLm1ldHJpY3MgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBkYXRhYmFzZSBpcyBoZWFsdGh5XG4gICAqL1xuICBpc0hlYWx0aHkoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMubWV0cmljcy5pc0hlYWx0aHkgJiYgdGhpcy5wb29sICE9PSBudWxsO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBjb25uZWN0aW9uIHBvb2wgc3RhdHVzXG4gICAqL1xuICBnZXRQb29sU3RhdHVzKCk6IHtcbiAgICB0b3RhbENvbm5lY3Rpb25zOiBudW1iZXI7XG4gICAgaWRsZUNvbm5lY3Rpb25zOiBudW1iZXI7XG4gICAgd2FpdGluZ0NsaWVudHM6IG51bWJlcjtcbiAgICBpc0hlYWx0aHk6IGJvb2xlYW47XG4gIH0ge1xuICAgIHRoaXMudXBkYXRlUG9vbE1ldHJpY3MoKTtcbiAgICByZXR1cm4ge1xuICAgICAgdG90YWxDb25uZWN0aW9uczogdGhpcy5tZXRyaWNzLnRvdGFsQ29ubmVjdGlvbnMsXG4gICAgICBpZGxlQ29ubmVjdGlvbnM6IHRoaXMubWV0cmljcy5pZGxlQ29ubmVjdGlvbnMsXG4gICAgICB3YWl0aW5nQ2xpZW50czogdGhpcy5tZXRyaWNzLndhaXRpbmdDbGllbnRzLFxuICAgICAgaXNIZWFsdGh5OiB0aGlzLm1ldHJpY3MuaXNIZWFsdGh5XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHcmFjZWZ1bGx5IHNodXRkb3duIHRoZSBkYXRhYmFzZSBtYW5hZ2VyXG4gICAqL1xuICBhc3luYyBzaHV0ZG93bigpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0aGlzLmlzU2h1dHRpbmdEb3duID0gdHJ1ZTtcblxuICAgIC8vIFN0b3AgaGVhbHRoIGNoZWNrIG1vbml0b3JpbmdcbiAgICBpZiAodGhpcy5oZWFsdGhDaGVja0ludGVydmFsKSB7XG4gICAgICBjbGVhckludGVydmFsKHRoaXMuaGVhbHRoQ2hlY2tJbnRlcnZhbCk7XG4gICAgICB0aGlzLmhlYWx0aENoZWNrSW50ZXJ2YWwgPSBudWxsO1xuICAgIH1cblxuICAgIC8vIENsb3NlIGNvbm5lY3Rpb24gcG9vbFxuICAgIGlmICh0aGlzLnBvb2wpIHtcbiAgICAgIGF3YWl0IHRoaXMucG9vbC5lbmQoKTtcbiAgICAgIHRoaXMucG9vbCA9IG51bGw7XG4gICAgfVxuXG4gICAgdGhpcy5lbWl0KCdzaHV0ZG93bicpO1xuICB9XG59Il0sInZlcnNpb24iOjN9
cc7c2a088b76910ae862136f509e9d4e
"use strict";
/**
 * RiskGuardian - Monitors portfolio-level risk metrics and enforces correlation guards
 * Validates signals against leverage limits and correlation constraints
 *
 * Requirements: 3.1, 3.2, 3.3, 3.5, 3.6, 3.7
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.RiskGuardian = void 0;
/**
 * RiskGuardian monitors portfolio-level risk metrics and enforces
 * correlation guards and leverage limits on incoming signals.
 */
class RiskGuardian {
    config;
    allocationEngine;
    /** Price history for correlation calculations */
    priceHistory = new Map();
    /** Cached correlation matrix */
    correlationCache = new Map();
    /** Cached portfolio beta */
    portfolioBetaCache = null;
    /** Current equity for leverage calculations */
    currentEquity = 0;
    /** High correlation notifier */
    correlationNotifier = null;
    constructor(config, allocationEngine) {
        this.config = config;
        this.allocationEngine = allocationEngine;
    }
    /**
     * Set the high correlation notifier
     */
    setCorrelationNotifier(notifier) {
        this.correlationNotifier = notifier;
    }
    /**
     * Set current equity for leverage calculations
     * @param equity - Current account equity in USD
     */
    setEquity(equity) {
        this.currentEquity = Math.max(0, equity);
    }
    /**
     * Get current equity
     */
    getEquity() {
        return this.currentEquity;
    }
    /**
     * Check a signal against risk rules
     *
     * Validation steps:
     * 1. Check if Phase 3 hedge that reduces delta (auto-approve)
     * 2. Calculate projected leverage
     * 3. Check leverage cap for equity tier
     * 4. Check correlation with existing positions
     * 5. Apply size reduction if high correlation
     *
     * @param signal - Intent signal from a phase
     * @param currentPositions - Array of current open positions
     * @returns RiskDecision with approval status and metrics
     */
    checkSignal(signal, currentPositions) {
        const currentLeverage = this.calculateCombinedLeverage(currentPositions);
        const portfolioDelta = this.calculatePortfolioDelta(currentPositions);
        const portfolioBeta = this.getPortfolioBeta(currentPositions);
        // Calculate projected leverage if signal is executed
        const projectedLeverage = this.calculateProjectedLeverage(signal, currentPositions);
        // Calculate correlation with existing positions
        const maxCorrelation = this.calculateMaxCorrelationWithPositions(signal, currentPositions);
        const riskMetrics = {
            currentLeverage,
            projectedLeverage,
            correlation: maxCorrelation,
            portfolioDelta,
            portfolioBeta,
        };
        // Requirement 3.5: Phase 3 hedge auto-approval
        if (this.isPhase3HedgeThatReducesDelta(signal, portfolioDelta)) {
            return {
                approved: true,
                reason: 'Phase 3 hedge approved: reduces global delta',
                adjustedSize: signal.requestedSize,
                riskMetrics,
            };
        }
        // Requirement 3.3: Check leverage cap
        const maxLeverage = this.allocationEngine.getMaxLeverage(this.currentEquity);
        if (projectedLeverage > maxLeverage) {
            return {
                approved: false,
                reason: `Leverage cap exceeded: projected ${projectedLeverage.toFixed(2)}x > max ${maxLeverage}x`,
                riskMetrics,
            };
        }
        // Requirement 3.7: High correlation check
        if (maxCorrelation > this.config.maxCorrelation) {
            // Send high correlation warning notification
            if (this.correlationNotifier) {
                const affectedPositions = this.getCorrelatedPositions(signal, currentPositions);
                this.correlationNotifier.sendHighCorrelationWarning(maxCorrelation, this.config.maxCorrelation, affectedPositions).catch(error => {
                    console.error('Failed to send high correlation warning:', error);
                });
            }
            // Check if same direction as correlated position
            const hasCorrelatedSameDirection = this.hasCorrelatedSameDirectionPosition(signal, currentPositions);
            if (hasCorrelatedSameDirection) {
                // Apply 50% size reduction
                const adjustedSize = signal.requestedSize * (1 - this.config.correlationPenalty);
                return {
                    approved: true,
                    reason: `High correlation (${maxCorrelation.toFixed(2)}) with same direction: size reduced by ${this.config.correlationPenalty * 100}%`,
                    adjustedSize,
                    riskMetrics,
                };
            }
        }
        // Signal approved without modification
        return {
            approved: true,
            reason: 'Signal approved: within risk limits',
            adjustedSize: signal.requestedSize,
            riskMetrics,
        };
    }
    /**
     * Calculate portfolio delta (net directional exposure)
     * Positive = net long, Negative = net short
     *
     * @param positions - Array of current positions
     * @returns Net delta in USD
     */
    calculatePortfolioDelta(positions) {
        return positions.reduce((delta, pos) => {
            const positionDelta = pos.side === 'LONG' ? pos.size : -pos.size;
            return delta + positionDelta;
        }, 0);
    }
    /**
     * Calculate combined leverage across all positions
     * Combined Leverage = Total Notional / Equity
     *
     * @param positions - Array of current positions
     * @returns Combined leverage ratio
     */
    calculateCombinedLeverage(positions) {
        if (this.currentEquity <= 0) {
            return 0;
        }
        const totalNotional = positions.reduce((sum, pos) => sum + pos.size, 0);
        return totalNotional / this.currentEquity;
    }
    /**
     * Calculate projected leverage if a signal is executed
     *
     * @param signal - Intent signal to evaluate
     * @param currentPositions - Current open positions
     * @returns Projected leverage ratio
     */
    calculateProjectedLeverage(signal, currentPositions) {
        if (this.currentEquity <= 0) {
            return 0;
        }
        // Check if signal is for an existing position (same symbol)
        const existingPosition = currentPositions.find((p) => p.symbol === signal.symbol);
        let projectedNotional;
        if (existingPosition) {
            // If same direction, add to position
            // If opposite direction, reduce or flip position
            const existingSide = existingPosition.side === 'LONG' ? 'BUY' : 'SELL';
            if (signal.side === existingSide) {
                // Adding to position
                projectedNotional = currentPositions.reduce((sum, pos) => {
                    if (pos.symbol === signal.symbol) {
                        return sum + pos.size + signal.requestedSize;
                    }
                    return sum + pos.size;
                }, 0);
            }
            else {
                // Reducing or flipping position
                const netSize = Math.abs(existingPosition.size - signal.requestedSize);
                projectedNotional = currentPositions.reduce((sum, pos) => {
                    if (pos.symbol === signal.symbol) {
                        return sum + netSize;
                    }
                    return sum + pos.size;
                }, 0);
            }
        }
        else {
            // New position
            projectedNotional =
                currentPositions.reduce((sum, pos) => sum + pos.size, 0) +
                    signal.requestedSize;
        }
        return projectedNotional / this.currentEquity;
    }
    /**
     * Calculate correlation between two assets using price history
     * Uses Pearson correlation coefficient
     *
     * @param assetA - First asset symbol
     * @param assetB - Second asset symbol
     * @returns Correlation coefficient (-1 to 1)
     */
    calculateCorrelation(assetA, assetB) {
        // Check cache first
        const cacheKey = this.getCorrelationCacheKey(assetA, assetB);
        const cached = this.correlationCache.get(cacheKey);
        if (cached && Date.now() - cached.timestamp < this.config.correlationUpdateInterval) {
            return cached.correlation;
        }
        const historyA = this.priceHistory.get(assetA) ?? [];
        const historyB = this.priceHistory.get(assetB) ?? [];
        if (historyA.length < 2 || historyB.length < 2) {
            // Insufficient data - assume moderate correlation
            return 0.5;
        }
        // Align timestamps and calculate returns
        const returnsA = this.calculateReturns(historyA);
        const returnsB = this.calculateReturns(historyB);
        // Need at least 2 data points for correlation
        const minLength = Math.min(returnsA.length, returnsB.length);
        if (minLength < 2) {
            return 0.5;
        }
        // Use the most recent aligned data
        const alignedA = returnsA.slice(-minLength);
        const alignedB = returnsB.slice(-minLength);
        const correlation = this.pearsonCorrelation(alignedA, alignedB);
        // Cache the result
        this.correlationCache.set(cacheKey, {
            correlation,
            timestamp: Date.now(),
        });
        return correlation;
    }
    /**
     * Get portfolio beta (correlation to BTC)
     * Beta measures how the portfolio moves relative to BTC
     *
     * @param positions - Current positions
     * @returns Portfolio beta coefficient
     */
    getPortfolioBeta(positions) {
        // Check cache
        if (this.portfolioBetaCache &&
            Date.now() - this.portfolioBetaCache.timestamp < this.config.betaUpdateInterval) {
            return this.portfolioBetaCache.value;
        }
        if (positions.length === 0) {
            return 0;
        }
        const totalNotional = positions.reduce((sum, pos) => sum + pos.size, 0);
        if (totalNotional === 0) {
            return 0;
        }
        // Calculate weighted average beta
        let weightedBeta = 0;
        for (const pos of positions) {
            const weight = pos.size / totalNotional;
            const assetBeta = this.calculateCorrelation(pos.symbol, 'BTCUSDT');
            // Adjust for position direction
            const directionMultiplier = pos.side === 'LONG' ? 1 : -1;
            weightedBeta += weight * assetBeta * directionMultiplier;
        }
        // Cache the result
        this.portfolioBetaCache = {
            value: weightedBeta,
            timestamp: Date.now(),
        };
        return weightedBeta;
    }
    /**
     * Update price history for an asset
     *
     * @param symbol - Asset symbol
     * @param price - Current price
     * @param timestamp - Price timestamp
     */
    updatePriceHistory(symbol, price, timestamp) {
        const entry = {
            symbol,
            price,
            timestamp: timestamp ?? Date.now(),
        };
        const history = this.priceHistory.get(symbol) ?? [];
        history.push(entry);
        // Keep only last 100 entries (for correlation calculation)
        if (history.length > 100) {
            history.shift();
        }
        this.priceHistory.set(symbol, history);
    }
    /**
     * Clear correlation cache (for testing or forced recalculation)
     */
    clearCorrelationCache() {
        this.correlationCache.clear();
        this.portfolioBetaCache = null;
    }
    /**
     * Get current risk metrics snapshot
     *
     * @param positions - Current positions
     * @returns RiskMetrics object
     */
    getRiskMetrics(positions) {
        return {
            currentLeverage: this.calculateCombinedLeverage(positions),
            projectedLeverage: this.calculateCombinedLeverage(positions),
            correlation: this.getMaxCorrelationAcrossPositions(positions),
            portfolioDelta: this.calculatePortfolioDelta(positions),
            portfolioBeta: this.getPortfolioBeta(positions),
        };
    }
    /**
     * Get configuration
     */
    getConfig() {
        return { ...this.config };
    }
    // ============ Private Helper Methods ============
    /**
     * Check if signal is a Phase 3 hedge that reduces global delta
     */
    isPhase3HedgeThatReducesDelta(signal, currentDelta) {
        if (signal.phaseId !== 'phase3') {
            return false;
        }
        // Determine if signal reduces delta
        const signalDelta = signal.side === 'BUY' ? signal.requestedSize : -signal.requestedSize;
        const newDelta = currentDelta + signalDelta;
        // Signal reduces delta if it moves closer to zero
        return Math.abs(newDelta) < Math.abs(currentDelta);
    }
    /**
     * Calculate maximum correlation between signal and existing positions
     */
    calculateMaxCorrelationWithPositions(signal, positions) {
        if (positions.length === 0) {
            return 0;
        }
        let maxCorrelation = 0;
        for (const pos of positions) {
            if (pos.symbol !== signal.symbol) {
                const correlation = Math.abs(this.calculateCorrelation(signal.symbol, pos.symbol));
                maxCorrelation = Math.max(maxCorrelation, correlation);
            }
        }
        // If same symbol exists, correlation is 1.0
        const sameSymbolExists = positions.some((p) => p.symbol === signal.symbol);
        if (sameSymbolExists) {
            maxCorrelation = 1.0;
        }
        return maxCorrelation;
    }
    /**
     * Check if there's a highly correlated position in the same direction
     */
    hasCorrelatedSameDirectionPosition(signal, positions) {
        const signalDirection = signal.side === 'BUY' ? 'LONG' : 'SHORT';
        for (const pos of positions) {
            // Same symbol, same direction
            if (pos.symbol === signal.symbol && pos.side === signalDirection) {
                return true;
            }
            // Different symbol but high correlation and same direction
            if (pos.symbol !== signal.symbol && pos.side === signalDirection) {
                const correlation = Math.abs(this.calculateCorrelation(signal.symbol, pos.symbol));
                if (correlation > this.config.maxCorrelation) {
                    return true;
                }
            }
        }
        return false;
    }
    /**
     * Get maximum correlation across all position pairs
     */
    getMaxCorrelationAcrossPositions(positions) {
        if (positions.length < 2) {
            return 0;
        }
        let maxCorrelation = 0;
        for (let i = 0; i < positions.length; i++) {
            for (let j = i + 1; j < positions.length; j++) {
                const correlation = Math.abs(this.calculateCorrelation(positions[i].symbol, positions[j].symbol));
                maxCorrelation = Math.max(maxCorrelation, correlation);
            }
        }
        return maxCorrelation;
    }
    /**
     * Calculate returns from price history
     */
    calculateReturns(history) {
        if (history.length < 2) {
            return [];
        }
        const returns = [];
        for (let i = 1; i < history.length; i++) {
            const prevPrice = history[i - 1].price;
            const currPrice = history[i].price;
            if (prevPrice > 0) {
                returns.push((currPrice - prevPrice) / prevPrice);
            }
        }
        return returns;
    }
    /**
     * Calculate Pearson correlation coefficient
     */
    pearsonCorrelation(x, y) {
        const n = Math.min(x.length, y.length);
        if (n < 2) {
            return 0;
        }
        const meanX = x.slice(0, n).reduce((a, b) => a + b, 0) / n;
        const meanY = y.slice(0, n).reduce((a, b) => a + b, 0) / n;
        let numerator = 0;
        let denomX = 0;
        let denomY = 0;
        for (let i = 0; i < n; i++) {
            const dx = x[i] - meanX;
            const dy = y[i] - meanY;
            numerator += dx * dy;
            denomX += dx * dx;
            denomY += dy * dy;
        }
        const denominator = Math.sqrt(denomX * denomY);
        if (denominator === 0) {
            return 0;
        }
        return numerator / denominator;
    }
    /**
     * Generate cache key for correlation pair
     */
    getCorrelationCacheKey(assetA, assetB) {
        // Sort to ensure consistent key regardless of order
        const sorted = [assetA, assetB].sort();
        return `${sorted[0]}:${sorted[1]}`;
    }
    /**
     * Get list of positions that are correlated with the signal
     */
    getCorrelatedPositions(signal, positions) {
        const correlatedPositions = [];
        for (const pos of positions) {
            if (pos.symbol === signal.symbol) {
                correlatedPositions.push(pos.symbol);
            }
            else {
                const correlation = Math.abs(this.calculateCorrelation(signal.symbol, pos.symbol));
                if (correlation > this.config.maxCorrelation) {
                    correlatedPositions.push(pos.symbol);
                }
            }
        }
        return correlatedPositions;
    }
}
exports.RiskGuardian = RiskGuardian;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLWJyYWluL3NyYy9lbmdpbmUvUmlza0d1YXJkaWFuLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7R0FLRzs7O0FBd0NIOzs7R0FHRztBQUNILE1BQWEsWUFBWTtJQUNOLE1BQU0sQ0FBcUI7SUFDM0IsZ0JBQWdCLENBQW1CO0lBRXBELGlEQUFpRDtJQUN6QyxZQUFZLEdBQXFDLElBQUksR0FBRyxFQUFFLENBQUM7SUFFbkUsZ0NBQWdDO0lBQ3hCLGdCQUFnQixHQUF1QyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBRXpFLDRCQUE0QjtJQUNwQixrQkFBa0IsR0FBZ0QsSUFBSSxDQUFDO0lBRS9FLCtDQUErQztJQUN2QyxhQUFhLEdBQVcsQ0FBQyxDQUFDO0lBRWxDLGdDQUFnQztJQUN4QixtQkFBbUIsR0FBbUMsSUFBSSxDQUFDO0lBRW5FLFlBQVksTUFBMEIsRUFBRSxnQkFBa0M7UUFDeEUsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLGdCQUFnQixHQUFHLGdCQUFnQixDQUFDO0lBQzNDLENBQUM7SUFFRDs7T0FFRztJQUNILHNCQUFzQixDQUFDLFFBQWlDO1FBQ3RELElBQUksQ0FBQyxtQkFBbUIsR0FBRyxRQUFRLENBQUM7SUFDdEMsQ0FBQztJQUVEOzs7T0FHRztJQUNILFNBQVMsQ0FBQyxNQUFjO1FBQ3RCLElBQUksQ0FBQyxhQUFhLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7SUFDM0MsQ0FBQztJQUVEOztPQUVHO0lBQ0gsU0FBUztRQUNQLE9BQU8sSUFBSSxDQUFDLGFBQWEsQ0FBQztJQUM1QixDQUFDO0lBRUQ7Ozs7Ozs7Ozs7Ozs7T0FhRztJQUNILFdBQVcsQ0FBQyxNQUFvQixFQUFFLGdCQUE0QjtRQUM1RCxNQUFNLGVBQWUsR0FBRyxJQUFJLENBQUMseUJBQXlCLENBQUMsZ0JBQWdCLENBQUMsQ0FBQztRQUN6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LENBQUMsQ0FBQztRQUNYLENBQUM7UUFFRCxPQUFPLFNBQVMsR0FBRyxXQUFXLENBQUM7SUFDakMsQ0FBQztJQUVEOztPQUVHO0lBQ0ssc0JBQXNCLENBQUMsTUFBYyxFQUFFLE1BQWM7UUFDM0Qsb0RBQW9EO1FBQ3BELE1BQU0sTUFBTSxHQUFHLENBQUMsTUFBTSxFQUFFLE1BQU0sQ0FBQyxDQUFDLElBQUksRUFBRSxDQUFDO1FBQ3ZDLE9BQU8sR0FBRyxNQUFNLENBQUMsQ0FBQyxDQUFDLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUM7SUFDckMsQ0FBQztJQUVEOztPQUVHO0lBQ0ssc0JBQXNCLENBQUMsTUFBb0IsRUFBRSxTQUFxQjtRQUN4RSxNQUFNLG1CQUFtQixHQUFhLEVBQUUsQ0FBQztRQUV6QyxLQUFLLE1BQU0sR0FBRyxJQUFJLFNBQVMsRUFBRSxDQUFDO1lBQzVCLElBQUksR0FBRyxDQUFDLE1BQU0sS0FBSyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7Z0JBQ2pDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7WUFDdkMsQ0FBQztpQkFBTSxDQUFDO2dCQUNOLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsSUFBSSxDQUFDLG9CQUFvQixDQUFDLE1BQU0sQ0FBQyxNQUFNLEVBQUUsR0FBRyxDQUFDLE1BQU0sQ0FBQyxDQUFDLENBQUM7Z0JBQ25GLElBQUksV0FBVyxHQUFHLElBQUksQ0FBQyxNQUFNLENBQUMsY0FBYyxFQUFFLENBQUM7b0JBQzdDLG1CQUFtQixDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsTUFBTSxDQUFDLENBQUM7Z0JBQ3ZDLENBQUM7WUFDSCxDQUFDO1FBQ0gsQ0FBQztRQUVELE9BQU8sbUJBQW1CLENBQUM7SUFDN0IsQ0FBQztDQUNGO0FBOWlCRCxvQ0E4aUJDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9pdmFuL0NvZGUvdHJhZGluZy90aXRhbi9zZXJ2aWNlcy90aXRhbi1icmFpbi9zcmMvZW5naW5lL1Jpc2tHdWFyZGlhbi50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFJpc2tHdWFyZGlhbiAtIE1vbml0b3JzIHBvcnRmb2xpby1sZXZlbCByaXNrIG1ldHJpY3MgYW5kIGVuZm9yY2VzIGNvcnJlbGF0aW9uIGd1YXJkc1xuICogVmFsaWRhdGVzIHNpZ25hbHMgYWdhaW5zdCBsZXZlcmFnZSBsaW1pdHMgYW5kIGNvcnJlbGF0aW9uIGNvbnN0cmFpbnRzXG4gKiBcbiAqIFJlcXVpcmVtZW50czogMy4xLCAzLjIsIDMuMywgMy41LCAzLjYsIDMuN1xuICovXG5cbmltcG9ydCB7XG4gIEludGVudFNpZ25hbCxcbiAgUG9zaXRpb24sXG4gIFJpc2tEZWNpc2lvbixcbiAgUmlza01ldHJpY3MsXG4gIFJpc2tHdWFyZGlhbkNvbmZpZyxcbiAgRXF1aXR5VGllcixcbn0gZnJvbSAnLi4vdHlwZXMvaW5kZXguanMnO1xuaW1wb3J0IHsgQWxsb2NhdGlvbkVuZ2luZSB9IGZyb20gJy4vQWxsb2NhdGlvbkVuZ2luZS5qcyc7XG5cbi8qKlxuICogSW50ZXJmYWNlIGZvciBoaWdoIGNvcnJlbGF0aW9uIG5vdGlmaWNhdGlvbiBjYWxsYmFja1xuICovXG5leHBvcnQgaW50ZXJmYWNlIEhpZ2hDb3JyZWxhdGlvbk5vdGlmaWVyIHtcbiAgc2VuZEhpZ2hDb3JyZWxhdGlvbldhcm5pbmcoXG4gICAgY29ycmVsYXRpb25TY29yZTogbnVtYmVyLFxuICAgIHRocmVzaG9sZDogbnVtYmVyLFxuICAgIGFmZmVjdGVkUG9zaXRpb25zOiBzdHJpbmdbXVxuICApOiBQcm9taXNlPHZvaWQ+O1xufVxuXG4vKipcbiAqIFByaWNlIGhpc3RvcnkgZW50cnkgZm9yIGNvcnJlbGF0aW9uIGNhbGN1bGF0aW9uXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgUHJpY2VIaXN0b3J5RW50cnkge1xuICBzeW1ib2w6IHN0cmluZztcbiAgdGltZXN0YW1wOiBudW1iZXI7XG4gIHByaWNlOiBudW1iZXI7XG59XG5cbi8qKlxuICogQ29ycmVsYXRpb24gbWF0cml4IGNhY2hlIGVudHJ5XG4gKi9cbmludGVyZmFjZSBDb3JyZWxhdGlvbkNhY2hlRW50cnkge1xuICBjb3JyZWxhdGlvbjogbnVtYmVyO1xuICB0aW1lc3RhbXA6IG51bWJlcjtcbn1cblxuLyoqXG4gKiBSaXNrR3VhcmRpYW4gbW9uaXRvcnMgcG9ydGZvbGlvLWxldmVsIHJpc2sgbWV0cmljcyBhbmQgZW5mb3JjZXNcbiAqIGNvcnJlbGF0aW9uIGd1YXJkcyBhbmQgbGV2ZXJhZ2UgbGltaXRzIG9uIGluY29taW5nIHNpZ25hbHMuXG4gKi9cbmV4cG9ydCBjbGFzcyBSaXNrR3VhcmRpYW4ge1xuICBwcml2YXRlIHJlYWRvbmx5IGNvbmZpZzogUmlza0d1YXJkaWFuQ29uZmlnO1xuICBwcml2YXRlIHJlYWRvbmx5IGFsbG9jYXRpb25FbmdpbmU6IEFsbG9jYXRpb25FbmdpbmU7XG4gIFxuICAvKiogUHJpY2UgaGlzdG9yeSBmb3IgY29ycmVsYXRpb24gY2FsY3VsYXRpb25zICovXG4gIHByaXZhdGUgcHJpY2VIaXN0b3J5OiBNYXA8c3RyaW5nLCBQcmljZUhpc3RvcnlFbnRyeVtdPiA9IG5ldyBNYXAoKTtcbiAgXG4gIC8qKiBDYWNoZWQgY29ycmVsYXRpb24gbWF0cml4ICovXG4gIHByaXZhdGUgY29ycmVsYXRpb25DYWNoZTogTWFwPHN0cmluZywgQ29ycmVsYXRpb25DYWNoZUVudHJ5PiA9IG5ldyBNYXAoKTtcbiAgXG4gIC8qKiBDYWNoZWQgcG9ydGZvbGlvIGJldGEgKi9cbiAgcHJpdmF0ZSBwb3J0Zm9saW9CZXRhQ2FjaGU6IHsgdmFsdWU6IG51bWJlcjsgdGltZXN0YW1wOiBudW1iZXIgfSB8IG51bGwgPSBudWxsO1xuICBcbiAgLyoqIEN1cnJlbnQgZXF1aXR5IGZvciBsZXZlcmFnZSBjYWxjdWxhdGlvbnMgKi9cbiAgcHJpdmF0ZSBjdXJyZW50RXF1aXR5OiBudW1iZXIgPSAwO1xuICBcbiAgLyoqIEhpZ2ggY29ycmVsYXRpb24gbm90aWZpZXIgKi9cbiAgcHJpdmF0ZSBjb3JyZWxhdGlvbk5vdGlmaWVyOiBIaWdoQ29ycmVsYXRpb25Ob3RpZmllciB8IG51bGwgPSBudWxsO1xuXG4gIGNvbnN0cnVjdG9yKGNvbmZpZzogUmlza0d1YXJkaWFuQ29uZmlnLCBhbGxvY2F0aW9uRW5naW5lOiBBbGxvY2F0aW9uRW5naW5lKSB7XG4gICAgdGhpcy5jb25maWcgPSBjb25maWc7XG4gICAgdGhpcy5hbGxvY2F0aW9uRW5naW5lID0gYWxsb2NhdGlvbkVuZ2luZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgdGhlIGhpZ2ggY29ycmVsYXRpb24gbm90aWZpZXJcbiAgICovXG4gIHNldENvcnJlbGF0aW9uTm90aWZpZXIobm90aWZpZXI6IEhpZ2hDb3JyZWxhdGlvbk5vdGlmaWVyKTogdm9pZCB7XG4gICAgdGhpcy5jb3JyZWxhdGlvbk5vdGlmaWVyID0gbm90aWZpZXI7XG4gIH1cblxuICAvKipcbiAgICogU2V0IGN1cnJlbnQgZXF1aXR5IGZvciBsZXZlcmFnZSBjYWxjdWxhdGlvbnNcbiAgICogQHBhcmFtIGVxdWl0eSAtIEN1cnJlbnQgYWNjb3VudCBlcXVpdHkgaW4gVVNEXG4gICAqL1xuICBzZXRFcXVpdHkoZXF1aXR5OiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLmN1cnJlbnRFcXVpdHkgPSBNYXRoLm1heCgwLCBlcXVpdHkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBjdXJyZW50IGVxdWl0eVxuICAgKi9cbiAgZ2V0RXF1aXR5KCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuY3VycmVudEVxdWl0eTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBhIHNpZ25hbCBhZ2FpbnN0IHJpc2sgcnVsZXNcbiAgICogXG4gICAqIFZhbGlkYXRpb24gc3RlcHM6XG4gICAqIDEuIENoZWNrIGlmIFBoYXNlIDMgaGVkZ2UgdGhhdCByZWR1Y2VzIGRlbHRhIChhdXRvLWFwcHJvdmUpXG4gICAqIDIuIENhbGN1bGF0ZSBwcm9qZWN0ZWQgbGV2ZXJhZ2VcbiAgICogMy4gQ2hlY2sgbGV2ZXJhZ2UgY2FwIGZvciBlcXVpdHkgdGllclxuICAgKiA0LiBDaGVjayBjb3JyZWxhdGlvbiB3aXRoIGV4aXN0aW5nIHBvc2l0aW9uc1xuICAgKiA1LiBBcHBseSBzaXplIHJlZHVjdGlvbiBpZiBoaWdoIGNvcnJlbGF0aW9uXG4gICAqIFxuICAgKiBAcGFyYW0gc2lnbmFsIC0gSW50ZW50IHNpZ25hbCBmcm9tIGEgcGhhc2VcbiAgICogQHBhcmFtIGN1cnJlbnRQb3NpdGlvbnMgLSBBcnJheSBvZiBjdXJyZW50IG9wZW4gcG9zaXRpb25zXG4gICAqIEByZXR1cm5zIFJpc2tEZWNpc2lvbiB3aXRoIGFwcHJvdmFsIHN0YXR1cyBhbmQgbWV0cmljc1xuICAgKi9cbiAgY2hlY2tTaWduYWwoc2lnbmFsOiBJbnRlbnRTaWduYWwsIGN1cnJlbnRQb3NpdGlvbnM6IFBvc2l0aW9uW10pOiBSaXNrRGVjaXNpb24ge1xuICAgIGNvbnN0IGN1cnJlbnRMZXZlcmFnZSA9IHRoaXMuY2FsY3VsYXRlQ29tYmluZWRMZXZlcmFnZShjdXJyZW50UG9zaXRpb25zKTtcbiAgICBjb25zdCBwb3J0Zm9saW9EZWx0YSA9IHRoaXMuY2FsY3VsYXRlUG9ydGZvbGlvRGVsdGEoY3VycmVudFBvc2l0aW9ucyk7XG4gICAgY29uc3QgcG9ydGZvbGlvQmV0YSA9IHRoaXMuZ2V0UG9ydGZvbGlvQmV0YShjdXJyZW50UG9zaXRpb25zKTtcbiAgICBcbiAgICAvLyBDYWxjdWxhdGUgcHJvamVjdGVkIGxldmVyYWdlIGlmIHNpZ25hbCBpcyBleGVjdXRlZFxuICAgIGNvbnN0IHByb2plY3RlZExldmVyYWdlID0gdGhpcy5jYWxjdWxhdGVQcm9qZWN0ZWRMZXZlcmFnZShcbiAgICAgIHNpZ25hbCxcbiAgICAgIGN1cnJlbnRQb3NpdGlvbnNcbiAgICApO1xuICAgIFxuICAgIC8vIENhbGN1bGF0ZSBjb3JyZWxhdGlvbiB3aXRoIGV4aXN0aW5nIHBvc2l0aW9uc1xuICAgIGNvbnN0IG1heENvcnJlbGF0aW9uID0gdGhpcy5jYWxjdWxhdGVNYXhDb3JyZWxhdGlvbldpdGhQb3NpdGlvbnMoXG4gICAgICBzaWduYWwsXG4gICAgICBjdXJyZW50UG9zaXRpb25zXG4gICAgKTtcblxuICAgIGNvbnN0IHJpc2tNZXRyaWNzOiBSaXNrTWV0cmljcyA9IHtcbiAgICAgIGN1cnJlbnRMZXZlcmFnZSxcbiAgICAgIHByb2plY3RlZExldmVyYWdlLFxuICAgICAgY29ycmVsYXRpb246IG1heENvcnJlbGF0aW9uLFxuICAgICAgcG9ydGZvbGlvRGVsdGEsXG4gICAgICBwb3J0Zm9saW9CZXRhLFxuICAgIH07XG5cbiAgICAvLyBSZXF1aXJlbWVudCAzLjU6IFBoYXNlIDMgaGVkZ2UgYXV0by1hcHByb3ZhbFxuICAgIGlmICh0aGlzLmlzUGhhc2UzSGVkZ2VUaGF0UmVkdWNlc0RlbHRhKHNpZ25hbCwgcG9ydGZvbGlvRGVsdGEpKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBhcHByb3ZlZDogdHJ1ZSxcbiAgICAgICAgcmVhc29uOiAnUGhhc2UgMyBoZWRnZSBhcHByb3ZlZDogcmVkdWNlcyBnbG9iYWwgZGVsdGEnLFxuICAgICAgICBhZGp1c3RlZFNpemU6IHNpZ25hbC5yZXF1ZXN0ZWRTaXplLFxuICAgICAgICByaXNrTWV0cmljcyxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gUmVxdWlyZW1lbnQgMy4zOiBDaGVjayBsZXZlcmFnZSBjYXBcbiAgICBjb25zdCBtYXhMZXZlcmFnZSA9IHRoaXMuYWxsb2NhdGlvbkVuZ2luZS5nZXRNYXhMZXZlcmFnZSh0aGlzLmN1cnJlbnRFcXVpdHkpO1xuICAgIGlmIChwcm9qZWN0ZWRMZXZlcmFnZSA+IG1heExldmVyYWdlKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBhcHByb3ZlZDogZmFsc2UsXG4gICAgICAgIHJlYXNvbjogYExldmVyYWdlIGNhcCBleGNlZWRlZDogcHJvamVjdGVkICR7cHJvamVjdGVkTGV2ZXJhZ2UudG9GaXhlZCgyKX14ID4gbWF4ICR7bWF4TGV2ZXJhZ2V9eGAsXG4gICAgICAgIHJpc2tNZXRyaWNzLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICAvLyBSZXF1aXJlbWVudCAzLjc6IEhpZ2ggY29ycmVsYXRpb24gY2hlY2tcbiAgICBpZiAobWF4Q29ycmVsYXRpb24gPiB0aGlzLmNvbmZpZy5tYXhDb3JyZWxhdGlvbikge1xuICAgICAgLy8gU2VuZCBoaWdoIGNvcnJlbGF0aW9uIHdhcm5pbmcgbm90aWZpY2F0aW9uXG4gICAgICBpZiAodGhpcy5jb3JyZWxhdGlvbk5vdGlmaWVyKSB7XG4gICAgICAgIGNvbnN0IGFmZmVjdGVkUG9zaXRpb25zID0gdGhpcy5nZXRDb3JyZWxhdGVkUG9zaXRpb25zKHNpZ25hbCwgY3VycmVudFBvc2l0aW9ucyk7XG4gICAgICAgIHRoaXMuY29ycmVsYXRpb25Ob3RpZmllci5zZW5kSGlnaENvcnJlbGF0aW9uV2FybmluZyhcbiAgICAgICAgICBtYXhDb3JyZWxhdGlvbixcbiAgICAgICAgICB0aGlzLmNvbmZpZy5tYXhDb3JyZWxhdGlvbixcbiAgICAgICAgICBhZmZlY3RlZFBvc2l0aW9uc1xuICAgICAgICApLmNhdGNoKGVycm9yID0+IHtcbiAgICAgICAgICBjb25zb2xlLmVycm9yKCdGYWlsZWQgdG8gc2VuZCBoaWdoIGNvcnJlbGF0aW9uIHdhcm5pbmc6JywgZXJyb3IpO1xuICAgICAgICB9KTtcbiAgICAgIH1cblxuICAgICAgLy8gQ2hlY2sgaWYgc2FtZSBkaXJlY3Rpb24gYXMgY29ycmVsYXRlZCBwb3NpdGlvblxuICAgICAgY29uc3QgaGFzQ29ycmVsYXRlZFNhbWVEaXJlY3Rpb24gPSB0aGlzLmhhc0NvcnJlbGF0ZWRTYW1lRGlyZWN0aW9uUG9zaXRpb24oXG4gICAgICAgIHNpZ25hbCxcbiAgICAgICAgY3VycmVudFBvc2l0aW9uc1xuICAgICAgKTtcblxuICAgICAgaWYgKGhhc0NvcnJlbGF0ZWRTYW1lRGlyZWN0aW9uKSB7XG4gICAgICAgIC8vIEFwcGx5IDUwJSBzaXplIHJlZHVjdGlvblxuICAgICAgICBjb25zdCBhZGp1c3RlZFNpemUgPSBzaWduYWwucmVxdWVzdGVkU2l6ZSAqICgxIC0gdGhpcy5jb25maWcuY29ycmVsYXRpb25QZW5hbHR5KTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBhcHByb3ZlZDogdHJ1ZSxcbiAgICAgICAgICByZWFzb246IGBIaWdoIGNvcnJlbGF0aW9uICgke21heENvcnJlbGF0aW9uLnRvRml4ZWQoMil9KSB3aXRoIHNhbWUgZGlyZWN0aW9uOiBzaXplIHJlZHVjZWQgYnkgJHt0aGlzLmNvbmZpZy5jb3JyZWxhdGlvblBlbmFsdHkgKiAxMDB9JWAsXG4gICAgICAgICAgYWRqdXN0ZWRTaXplLFxuICAgICAgICAgIHJpc2tNZXRyaWNzLFxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFNpZ25hbCBhcHByb3ZlZCB3aXRob3V0IG1vZGlmaWNhdGlvblxuICAgIHJldHVybiB7XG4gICAgICBhcHByb3ZlZDogdHJ1ZSxcbiAgICAgIHJlYXNvbjogJ1NpZ25hbCBhcHByb3ZlZDogd2l0aGluIHJpc2sgbGltaXRzJyxcbiAgICAgIGFkanVzdGVkU2l6ZTogc2lnbmFsLnJlcXVlc3RlZFNpemUsXG4gICAgICByaXNrTWV0cmljcyxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGN1bGF0ZSBwb3J0Zm9saW8gZGVsdGEgKG5ldCBkaXJlY3Rpb25hbCBleHBvc3VyZSlcbiAgICogUG9zaXRpdmUgPSBuZXQgbG9uZywgTmVnYXRpdmUgPSBuZXQgc2hvcnRcbiAgICogXG4gICAqIEBwYXJhbSBwb3NpdGlvbnMgLSBBcnJheSBvZiBjdXJyZW50IHBvc2l0aW9uc1xuICAgKiBAcmV0dXJucyBOZXQgZGVsdGEgaW4gVVNEXG4gICAqL1xuICBjYWxjdWxhdGVQb3J0Zm9saW9EZWx0YShwb3NpdGlvbnM6IFBvc2l0aW9uW10pOiBudW1iZXIge1xuICAgIHJldHVybiBwb3NpdGlvbnMucmVkdWNlKChkZWx0YSwgcG9zKSA9PiB7XG4gICAgICBjb25zdCBwb3NpdGlvbkRlbHRhID0gcG9zLnNpZGUgPT09ICdMT05HJyA/IHBvcy5zaXplIDogLXBvcy5zaXplO1xuICAgICAgcmV0dXJuIGRlbHRhICsgcG9zaXRpb25EZWx0YTtcbiAgICB9LCAwKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxjdWxhdGUgY29tYmluZWQgbGV2ZXJhZ2UgYWNyb3NzIGFsbCBwb3NpdGlvbnNcbiAgICogQ29tYmluZWQgTGV2ZXJhZ2UgPSBUb3RhbCBOb3Rpb25hbCAvIEVxdWl0eVxuICAgKiBcbiAgICogQHBhcmFtIHBvc2l0aW9ucyAtIEFycmF5IG9mIGN1cnJlbnQgcG9zaXRpb25zXG4gICAqIEByZXR1cm5zIENvbWJpbmVkIGxldmVyYWdlIHJhdGlvXG4gICAqL1xuICBjYWxjdWxhdGVDb21iaW5lZExldmVyYWdlKHBvc2l0aW9uczogUG9zaXRpb25bXSk6IG51bWJlciB7XG4gICAgaWYgKHRoaXMuY3VycmVudEVxdWl0eSA8PSAwKSB7XG4gICAgICByZXR1cm4gMDtcbiAgICB9XG5cbiAgICBjb25zdCB0b3RhbE5vdGlvbmFsID0gcG9zaXRpb25zLnJlZHVjZSgoc3VtLCBwb3MpID0+IHN1bSArIHBvcy5zaXplLCAwKTtcbiAgICByZXR1cm4gdG90YWxOb3Rpb25hbCAvIHRoaXMuY3VycmVudEVxdWl0eTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxjdWxhdGUgcHJvamVjdGVkIGxldmVyYWdlIGlmIGEgc2lnbmFsIGlzIGV4ZWN1dGVkXG4gICAqIFxuICAgKiBAcGFyYW0gc2lnbmFsIC0gSW50ZW50IHNpZ25hbCB0byBldmFsdWF0ZVxuICAgKiBAcGFyYW0gY3VycmVudFBvc2l0aW9ucyAtIEN1cnJlbnQgb3BlbiBwb3NpdGlvbnNcbiAgICogQHJldHVybnMgUHJvamVjdGVkIGxldmVyYWdlIHJhdGlvXG4gICAqL1xuICBwcml2YXRlIGNhbGN1bGF0ZVByb2plY3RlZExldmVyYWdlKFxuICAgIHNpZ25hbDogSW50ZW50U2lnbmFsLFxuICAgIGN1cnJlbnRQb3NpdGlvbnM6IFBvc2l0aW9uW11cbiAgKTogbnVtYmVyIHtcbiAgICBpZiAodGhpcy5jdXJyZW50RXF1aXR5IDw9IDApIHtcbiAgICAgIHJldHVybiAwO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIHNpZ25hbCBpcyBmb3IgYW4gZXhpc3RpbmcgcG9zaXRpb24gKHNhbWUgc3ltYm9sKVxuICAgIGNvbnN0IGV4aXN0aW5nUG9zaXRpb24gPSBjdXJyZW50UG9zaXRpb25zLmZpbmQoXG4gICAgICAocCkgPT4gcC5zeW1ib2wgPT09IHNpZ25hbC5zeW1ib2xcbiAgICApO1xuXG4gICAgbGV0IHByb2plY3RlZE5vdGlvbmFsOiBudW1iZXI7XG5cbiAgICBpZiAoZXhpc3RpbmdQb3NpdGlvbikge1xuICAgICAgLy8gSWYgc2FtZSBkaXJlY3Rpb24sIGFkZCB0byBwb3NpdGlvblxuICAgICAgLy8gSWYgb3Bwb3NpdGUgZGlyZWN0aW9uLCByZWR1Y2Ugb3IgZmxpcCBwb3NpdGlvblxuICAgICAgY29uc3QgZXhpc3RpbmdTaWRlID0gZXhpc3RpbmdQb3NpdGlvbi5zaWRlID09PSAnTE9ORycgPyAnQlVZJyA6ICdTRUxMJztcbiAgICAgIFxuICAgICAgaWYgKHNpZ25hbC5zaWRlID09PSBleGlzdGluZ1NpZGUpIHtcbiAgICAgICAgLy8gQWRkaW5nIHRvIHBvc2l0aW9uXG4gICAgICAgIHByb2plY3RlZE5vdGlvbmFsID0gY3VycmVudFBvc2l0aW9ucy5yZWR1Y2UoKHN1bSwgcG9zKSA9PiB7XG4gICAgICAgICAgaWYgKHBvcy5zeW1ib2wgPT09IHNpZ25hbC5zeW1ib2wpIHtcbiAgICAgICAgICAgIHJldHVybiBzdW0gKyBwb3Muc2l6ZSArIHNpZ25hbC5yZXF1ZXN0ZWRTaXplO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gc3VtICsgcG9zLnNpemU7XG4gICAgICAgIH0sIDApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgLy8gUmVkdWNpbmcgb3IgZmxpcHBpbmcgcG9zaXRpb25cbiAgICAgICAgY29uc3QgbmV0U2l6ZSA9IE1hdGguYWJzKGV4aXN0aW5nUG9zaXRpb24uc2l6ZSAtIHNpZ25hbC5yZXF1ZXN0ZWRTaXplKTtcbiAgICAgICAgcHJvamVjdGVkTm90aW9uYWwgPSBjdXJyZW50UG9zaXRpb25zLnJlZHVjZSgoc3VtLCBwb3MpID0+IHtcbiAgICAgICAgICBpZiAocG9zLnN5bWJvbCA9PT0gc2lnbmFsLnN5bWJvbCkge1xuICAgICAgICAgICAgcmV0dXJuIHN1bSArIG5ldFNpemU7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiBzdW0gKyBwb3Muc2l6ZTtcbiAgICAgICAgfSwgMCk7XG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIC8vIE5ldyBwb3NpdGlvblxuICAgICAgcHJvamVjdGVkTm90aW9uYWwgPVxuICAgICAgICBjdXJyZW50UG9zaXRpb25zLnJlZHVjZSgoc3VtLCBwb3MpID0+IHN1bSArIHBvcy5zaXplLCAwKSArXG4gICAgICAgIHNpZ25hbC5yZXF1ZXN0ZWRTaXplO1xuICAgIH1cblxuICAgIHJldHVybiBwcm9qZWN0ZWROb3Rpb25hbCAvIHRoaXMuY3VycmVudEVxdWl0eTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDYWxjdWxhdGUgY29ycmVsYXRpb24gYmV0d2VlbiB0d28gYXNzZXRzIHVzaW5nIHByaWNlIGhpc3RvcnlcbiAgICogVXNlcyBQZWFyc29uIGNvcnJlbGF0aW9uIGNvZWZmaWNpZW50XG4gICAqIFxuICAgKiBAcGFyYW0gYXNzZXRBIC0gRmlyc3QgYXNzZXQgc3ltYm9sXG4gICAqIEBwYXJhbSBhc3NldEIgLSBTZWNvbmQgYXNzZXQgc3ltYm9sXG4gICAqIEByZXR1cm5zIENvcnJlbGF0aW9uIGNvZWZmaWNpZW50ICgtMSB0byAxKVxuICAgKi9cbiAgY2FsY3VsYXRlQ29ycmVsYXRpb24oYXNzZXRBOiBzdHJpbmcsIGFzc2V0Qjogc3RyaW5nKTogbnVtYmVyIHtcbiAgICAvLyBDaGVjayBjYWNoZSBmaXJzdFxuICAgIGNvbnN0IGNhY2hlS2V5ID0gdGhpcy5nZXRDb3JyZWxhdGlvbkNhY2hlS2V5KGFzc2V0QSwgYXNzZXRCKTtcbiAgICBjb25zdCBjYWNoZWQgPSB0aGlzLmNvcnJlbGF0aW9uQ2FjaGUuZ2V0KGNhY2hlS2V5KTtcbiAgICBcbiAgICBpZiAoY2FjaGVkICYmIERhdGUubm93KCkgLSBjYWNoZWQudGltZXN0YW1wIDwgdGhpcy5jb25maWcuY29ycmVsYXRpb25VcGRhdGVJbnRlcnZhbCkge1xuICAgICAgcmV0dXJuIGNhY2hlZC5jb3JyZWxhdGlvbjtcbiAgICB9XG5cbiAgICBjb25zdCBoaXN0b3J5QSA9IHRoaXMucHJpY2VIaXN0b3J5LmdldChhc3NldEEpID8/IFtdO1xuICAgIGNvbnN0IGhpc3RvcnlCID0gdGhpcy5wcmljZUhpc3RvcnkuZ2V0KGFzc2V0QikgPz8gW107XG5cbiAgICBpZiAoaGlzdG9yeUEubGVuZ3RoIDwgMiB8fCBoaXN0b3J5Qi5sZW5ndGggPCAyKSB7XG4gICAgICAvLyBJbnN1ZmZpY2llbnQgZGF0YSAtIGFzc3VtZSBtb2RlcmF0ZSBjb3JyZWxhdGlvblxuICAgICAgcmV0dXJuIDAuNTtcbiAgICB9XG5cbiAgICAvLyBBbGlnbiB0aW1lc3RhbXBzIGFuZCBjYWxjdWxhdGUgcmV0dXJuc1xuICAgIGNvbnN0IHJldHVybnNBID0gdGhpcy5jYWxjdWxhdGVSZXR1cm5zKGhpc3RvcnlBKTtcbiAgICBjb25zdCByZXR1cm5zQiA9IHRoaXMuY2FsY3VsYXRlUmV0dXJucyhoaXN0b3J5Qik7XG5cbiAgICAvLyBOZWVkIGF0IGxlYXN0IDIgZGF0YSBwb2ludHMgZm9yIGNvcnJlbGF0aW9uXG4gICAgY29uc3QgbWluTGVuZ3RoID0gTWF0aC5taW4ocmV0dXJuc0EubGVuZ3RoLCByZXR1cm5zQi5sZW5ndGgpO1xuICAgIGlmIChtaW5MZW5ndGggPCAyKSB7XG4gICAgICByZXR1cm4gMC41O1xuICAgIH1cblxuICAgIC8vIFVzZSB0aGUgbW9zdCByZWNlbnQgYWxpZ25lZCBkYXRhXG4gICAgY29uc3QgYWxpZ25lZEEgPSByZXR1cm5zQS5zbGljZSgtbWluTGVuZ3RoKTtcbiAgICBjb25zdCBhbGlnbmVkQiA9IHJldHVybnNCLnNsaWNlKC1taW5MZW5ndGgpO1xuXG4gICAgY29uc3QgY29ycmVsYXRpb24gPSB0aGlzLnBlYXJzb25Db3JyZWxhdGlvbihhbGlnbmVkQSwgYWxpZ25lZEIpO1xuXG4gICAgLy8gQ2FjaGUgdGhlIHJlc3VsdFxuICAgIHRoaXMuY29ycmVsYXRpb25DYWNoZS5zZXQoY2FjaGVLZXksIHtcbiAgICAgIGNvcnJlbGF0aW9uLFxuICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgIH0pO1xuXG4gICAgcmV0dXJuIGNvcnJlbGF0aW9uO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBwb3J0Zm9saW8gYmV0YSAoY29ycmVsYXRpb24gdG8gQlRDKVxuICAgKiBCZXRhIG1lYXN1cmVzIGhvdyB0aGUgcG9ydGZvbGlvIG1vdmVzIHJlbGF0aXZlIHRvIEJUQ1xuICAgKiBcbiAgICogQHBhcmFtIHBvc2l0aW9ucyAtIEN1cnJlbnQgcG9zaXRpb25zXG4gICAqIEByZXR1cm5zIFBvcnRmb2xpbyBiZXRhIGNvZWZmaWNpZW50XG4gICAqL1xuICBnZXRQb3J0Zm9saW9CZXRhKHBvc2l0aW9uczogUG9zaXRpb25bXSk6IG51bWJlciB7XG4gICAgLy8gQ2hlY2sgY2FjaGVcbiAgICBpZiAoXG4gICAgICB0aGlzLnBvcnRmb2xpb0JldGFDYWNoZSAmJlxuICAgICAgRGF0ZS5ub3coKSAtIHRoaXMucG9ydGZvbGlvQmV0YUNhY2hlLnRpbWVzdGFtcCA8IHRoaXMuY29uZmlnLmJldGFVcGRhdGVJbnRlcnZhbFxuICAgICkge1xuICAgICAgcmV0dXJuIHRoaXMucG9ydGZvbGlvQmV0YUNhY2hlLnZhbHVlO1xuICAgIH1cblxuICAgIGlmIChwb3NpdGlvbnMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gMDtcbiAgICB9XG5cbiAgICBjb25zdCB0b3RhbE5vdGlvbmFsID0gcG9zaXRpb25zLnJlZHVjZSgoc3VtLCBwb3MpID0+IHN1bSArIHBvcy5zaXplLCAwKTtcbiAgICBpZiAodG90YWxOb3Rpb25hbCA9PT0gMCkge1xuICAgICAgcmV0dXJuIDA7XG4gICAgfVxuXG4gICAgLy8gQ2FsY3VsYXRlIHdlaWdodGVkIGF2ZXJhZ2UgYmV0YVxuICAgIGxldCB3ZWlnaHRlZEJldGEgPSAwO1xuICAgIGZvciAoY29uc3QgcG9zIG9mIHBvc2l0aW9ucykge1xuICAgICAgY29uc3Qgd2VpZ2h0ID0gcG9zLnNpemUgLyB0b3RhbE5vdGlvbmFsO1xuICAgICAgY29uc3QgYXNzZXRCZXRhID0gdGhpcy5jYWxjdWxhdGVDb3JyZWxhdGlvbihwb3Muc3ltYm9sLCAnQlRDVVNEVCcpO1xuICAgICAgLy8gQWRqdXN0IGZvciBwb3NpdGlvbiBkaXJlY3Rpb25cbiAgICAgIGNvbnN0IGRpcmVjdGlvbk11bHRpcGxpZXIgPSBwb3Muc2lkZSA9PT0gJ0xPTkcnID8gMSA6IC0xO1xuICAgICAgd2VpZ2h0ZWRCZXRhICs9IHdlaWdodCAqIGFzc2V0QmV0YSAqIGRpcmVjdGlvbk11bHRpcGxpZXI7XG4gICAgfVxuXG4gICAgLy8gQ2FjaGUgdGhlIHJlc3VsdFxuICAgIHRoaXMucG9ydGZvbGlvQmV0YUNhY2hlID0ge1xuICAgICAgdmFsdWU6IHdlaWdodGVkQmV0YSxcbiAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICB9O1xuXG4gICAgcmV0dXJuIHdlaWdodGVkQmV0YTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGUgcHJpY2UgaGlzdG9yeSBmb3IgYW4gYXNzZXRcbiAgICogXG4gICAqIEBwYXJhbSBzeW1ib2wgLSBBc3NldCBzeW1ib2xcbiAgICogQHBhcmFtIHByaWNlIC0gQ3VycmVudCBwcmljZVxuICAgKiBAcGFyYW0gdGltZXN0YW1wIC0gUHJpY2UgdGltZXN0YW1wXG4gICAqL1xuICB1cGRhdGVQcmljZUhpc3Rvcnkoc3ltYm9sOiBzdHJpbmcsIHByaWNlOiBudW1iZXIsIHRpbWVzdGFtcD86IG51bWJlcik6IHZvaWQge1xuICAgIGNvbnN0IGVudHJ5OiBQcmljZUhpc3RvcnlFbnRyeSA9IHtcbiAgICAgIHN5bWJvbCxcbiAgICAgIHByaWNlLFxuICAgICAgdGltZXN0YW1wOiB0aW1lc3RhbXAgPz8gRGF0ZS5ub3coKSxcbiAgICB9O1xuXG4gICAgY29uc3QgaGlzdG9yeSA9IHRoaXMucHJpY2VIaXN0b3J5LmdldChzeW1ib2wpID8/IFtdO1xuICAgIGhpc3RvcnkucHVzaChlbnRyeSk7XG5cbiAgICAvLyBLZWVwIG9ubHkgbGFzdCAxMDAgZW50cmllcyAoZm9yIGNvcnJlbGF0aW9uIGNhbGN1bGF0aW9uKVxuICAgIGlmIChoaXN0b3J5Lmxlbmd0aCA+IDEwMCkge1xuICAgICAgaGlzdG9yeS5zaGlmdCgpO1xuICAgIH1cblxuICAgIHRoaXMucHJpY2VIaXN0b3J5LnNldChzeW1ib2wsIGhpc3RvcnkpO1xuICB9XG5cbiAgLyoqXG4gICAqIENsZWFyIGNvcnJlbGF0aW9uIGNhY2hlIChmb3IgdGVzdGluZyBvciBmb3JjZWQgcmVjYWxjdWxhdGlvbilcbiAgICovXG4gIGNsZWFyQ29ycmVsYXRpb25DYWNoZSgpOiB2b2lkIHtcbiAgICB0aGlzLmNvcnJlbGF0aW9uQ2FjaGUuY2xlYXIoKTtcbiAgICB0aGlzLnBvcnRmb2xpb0JldGFDYWNoZSA9IG51bGw7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGN1cnJlbnQgcmlzayBtZXRyaWNzIHNuYXBzaG90XG4gICAqIFxuICAgKiBAcGFyYW0gcG9zaXRpb25zIC0gQ3VycmVudCBwb3NpdGlvbnNcbiAgICogQHJldHVybnMgUmlza01ldHJpY3Mgb2JqZWN0XG4gICAqL1xuICBnZXRSaXNrTWV0cmljcyhwb3NpdGlvbnM6IFBvc2l0aW9uW10pOiBSaXNrTWV0cmljcyB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGN1cnJlbnRMZXZlcmFnZTogdGhpcy5jYWxjdWxhdGVDb21iaW5lZExldmVyYWdlKHBvc2l0aW9ucyksXG4gICAgICBwcm9qZWN0ZWRMZXZlcmFnZTogdGhpcy5jYWxjdWxhdGVDb21iaW5lZExldmVyYWdlKHBvc2l0aW9ucyksXG4gICAgICBjb3JyZWxhdGlvbjogdGhpcy5nZXRNYXhDb3JyZWxhdGlvbkFjcm9zc1Bvc2l0aW9ucyhwb3NpdGlvbnMpLFxuICAgICAgcG9ydGZvbGlvRGVsdGE6IHRoaXMuY2FsY3VsYXRlUG9ydGZvbGlvRGVsdGEocG9zaXRpb25zKSxcbiAgICAgIHBvcnRmb2xpb0JldGE6IHRoaXMuZ2V0UG9ydGZvbGlvQmV0YShwb3NpdGlvbnMpLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogR2V0IGNvbmZpZ3VyYXRpb25cbiAgICovXG4gIGdldENvbmZpZygpOiBSaXNrR3VhcmRpYW5Db25maWcge1xuICAgIHJldHVybiB7IC4uLnRoaXMuY29uZmlnIH07XG4gIH1cblxuICAvLyA9PT09PT09PT09PT0gUHJpdmF0ZSBIZWxwZXIgTWV0aG9kcyA9PT09PT09PT09PT1cblxuICAvKipcbiAgICogQ2hlY2sgaWYgc2lnbmFsIGlzIGEgUGhhc2UgMyBoZWRnZSB0aGF0IHJlZHVjZXMgZ2xvYmFsIGRlbHRhXG4gICAqL1xuICBwcml2YXRlIGlzUGhhc2UzSGVkZ2VUaGF0UmVkdWNlc0RlbHRhKFxuICAgIHNpZ25hbDogSW50ZW50U2lnbmFsLFxuICAgIGN1cnJlbnREZWx0YTogbnVtYmVyXG4gICk6IGJvb2xlYW4ge1xuICAgIGlmIChzaWduYWwucGhhc2VJZCAhPT0gJ3BoYXNlMycpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyBEZXRlcm1pbmUgaWYgc2lnbmFsIHJlZHVjZXMgZGVsdGFcbiAgICBjb25zdCBzaWduYWxEZWx0YSA9IHNpZ25hbC5zaWRlID09PSAnQlVZJyA/IHNpZ25hbC5yZXF1ZXN0ZWRTaXplIDogLXNpZ25hbC5yZXF1ZXN0ZWRTaXplO1xuICAgIGNvbnN0IG5ld0RlbHRhID0gY3VycmVudERlbHRhICsgc2lnbmFsRGVsdGE7XG5cbiAgICAvLyBTaWduYWwgcmVkdWNlcyBkZWx0YSBpZiBpdCBtb3ZlcyBjbG9zZXIgdG8gemVyb1xuICAgIHJldHVybiBNYXRoLmFicyhuZXdEZWx0YSkgPCBNYXRoLmFicyhjdXJyZW50RGVsdGEpO1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGN1bGF0ZSBtYXhpbXVtIGNvcnJlbGF0aW9uIGJldHdlZW4gc2lnbmFsIGFuZCBleGlzdGluZyBwb3NpdGlvbnNcbiAgICovXG4gIHByaXZhdGUgY2FsY3VsYXRlTWF4Q29ycmVsYXRpb25XaXRoUG9zaXRpb25zKFxuICAgIHNpZ25hbDogSW50ZW50U2lnbmFsLFxuICAgIHBvc2l0aW9uczogUG9zaXRpb25bXVxuICApOiBudW1iZXIge1xuICAgIGlmIChwb3NpdGlvbnMubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm4gMDtcbiAgICB9XG5cbiAgICBsZXQgbWF4Q29ycmVsYXRpb24gPSAwO1xuICAgIGZvciAoY29uc3QgcG9zIG9mIHBvc2l0aW9ucykge1xuICAgICAgaWYgKHBvcy5zeW1ib2wgIT09IHNpZ25hbC5zeW1ib2wpIHtcbiAgICAgICAgY29uc3QgY29ycmVsYXRpb24gPSBNYXRoLmFicyh0aGlzLmNhbGN1bGF0ZUNvcnJlbGF0aW9uKHNpZ25hbC5zeW1ib2wsIHBvcy5zeW1ib2wpKTtcbiAgICAgICAgbWF4Q29ycmVsYXRpb24gPSBNYXRoLm1heChtYXhDb3JyZWxhdGlvbiwgY29ycmVsYXRpb24pO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIElmIHNhbWUgc3ltYm9sIGV4aXN0cywgY29ycmVsYXRpb24gaXMgMS4wXG4gICAgY29uc3Qgc2FtZVN5bWJvbEV4aXN0cyA9IHBvc2l0aW9ucy5zb21lKChwKSA9PiBwLnN5bWJvbCA9PT0gc2lnbmFsLnN5bWJvbCk7XG4gICAgaWYgKHNhbWVTeW1ib2xFeGlzdHMpIHtcbiAgICAgIG1heENvcnJlbGF0aW9uID0gMS4wO1xuICAgIH1cblxuICAgIHJldHVybiBtYXhDb3JyZWxhdGlvbjtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiB0aGVyZSdzIGEgaGlnaGx5IGNvcnJlbGF0ZWQgcG9zaXRpb24gaW4gdGhlIHNhbWUgZGlyZWN0aW9uXG4gICAqL1xuICBwcml2YXRlIGhhc0NvcnJlbGF0ZWRTYW1lRGlyZWN0aW9uUG9zaXRpb24oXG4gICAgc2lnbmFsOiBJbnRlbnRTaWduYWwsXG4gICAgcG9zaXRpb25zOiBQb3NpdGlvbltdXG4gICk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IHNpZ25hbERpcmVjdGlvbiA9IHNpZ25hbC5zaWRlID09PSAnQlVZJyA/ICdMT05HJyA6ICdTSE9SVCc7XG5cbiAgICBmb3IgKGNvbnN0IHBvcyBvZiBwb3NpdGlvbnMpIHtcbiAgICAgIC8vIFNhbWUgc3ltYm9sLCBzYW1lIGRpcmVjdGlvblxuICAgICAgaWYgKHBvcy5zeW1ib2wgPT09IHNpZ25hbC5zeW1ib2wgJiYgcG9zLnNpZGUgPT09IHNpZ25hbERpcmVjdGlvbikge1xuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH1cblxuICAgICAgLy8gRGlmZmVyZW50IHN5bWJvbCBidXQgaGlnaCBjb3JyZWxhdGlvbiBhbmQgc2FtZSBkaXJlY3Rpb25cbiAgICAgIGlmIChwb3Muc3ltYm9sICE9PSBzaWduYWwuc3ltYm9sICYmIHBvcy5zaWRlID09PSBzaWduYWxEaXJlY3Rpb24pIHtcbiAgICAgICAgY29uc3QgY29ycmVsYXRpb24gPSBNYXRoLmFicyh0aGlzLmNhbGN1bGF0ZUNvcnJlbGF0aW9uKHNpZ25hbC5zeW1ib2wsIHBvcy5zeW1ib2wpKTtcbiAgICAgICAgaWYgKGNvcnJlbGF0aW9uID4gdGhpcy5jb25maWcubWF4Q29ycmVsYXRpb24pIHtcbiAgICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiBmYWxzZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgbWF4aW11bSBjb3JyZWxhdGlvbiBhY3Jvc3MgYWxsIHBvc2l0aW9uIHBhaXJzXG4gICAqL1xuICBwcml2YXRlIGdldE1heENvcnJlbGF0aW9uQWNyb3NzUG9zaXRpb25zKHBvc2l0aW9uczogUG9zaXRpb25bXSk6IG51bWJlciB7XG4gICAgaWYgKHBvc2l0aW9ucy5sZW5ndGggPCAyKSB7XG4gICAgICByZXR1cm4gMDtcbiAgICB9XG5cbiAgICBsZXQgbWF4Q29ycmVsYXRpb24gPSAwO1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgcG9zaXRpb25zLmxlbmd0aDsgaSsrKSB7XG4gICAgICBmb3IgKGxldCBqID0gaSArIDE7IGogPCBwb3NpdGlvbnMubGVuZ3RoOyBqKyspIHtcbiAgICAgICAgY29uc3QgY29ycmVsYXRpb24gPSBNYXRoLmFicyhcbiAgICAgICAgICB0aGlzLmNhbGN1bGF0ZUNvcnJlbGF0aW9uKHBvc2l0aW9uc1tpXS5zeW1ib2wsIHBvc2l0aW9uc1tqXS5zeW1ib2wpXG4gICAgICAgICk7XG4gICAgICAgIG1heENvcnJlbGF0aW9uID0gTWF0aC5tYXgobWF4Q29ycmVsYXRpb24sIGNvcnJlbGF0aW9uKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gbWF4Q29ycmVsYXRpb247XG4gIH1cblxuICAvKipcbiAgICogQ2FsY3VsYXRlIHJldHVybnMgZnJvbSBwcmljZSBoaXN0b3J5XG4gICAqL1xuICBwcml2YXRlIGNhbGN1bGF0ZVJldHVybnMoaGlzdG9yeTogUHJpY2VIaXN0b3J5RW50cnlbXSk6IG51bWJlcltdIHtcbiAgICBpZiAoaGlzdG9yeS5sZW5ndGggPCAyKSB7XG4gICAgICByZXR1cm4gW107XG4gICAgfVxuXG4gICAgY29uc3QgcmV0dXJuczogbnVtYmVyW10gPSBbXTtcbiAgICBmb3IgKGxldCBpID0gMTsgaSA8IGhpc3RvcnkubGVuZ3RoOyBpKyspIHtcbiAgICAgIGNvbnN0IHByZXZQcmljZSA9IGhpc3RvcnlbaSAtIDFdLnByaWNlO1xuICAgICAgY29uc3QgY3VyclByaWNlID0gaGlzdG9yeVtpXS5wcmljZTtcbiAgICAgIGlmIChwcmV2UHJpY2UgPiAwKSB7XG4gICAgICAgIHJldHVybnMucHVzaCgoY3VyclByaWNlIC0gcHJldlByaWNlKSAvIHByZXZQcmljZSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHJldHVybnM7XG4gIH1cblxuICAvKipcbiAgICogQ2FsY3VsYXRlIFBlYXJzb24gY29ycmVsYXRpb24gY29lZmZpY2llbnRcbiAgICovXG4gIHByaXZhdGUgcGVhcnNvbkNvcnJlbGF0aW9uKHg6IG51bWJlcltdLCB5OiBudW1iZXJbXSk6IG51bWJlciB7XG4gICAgY29uc3QgbiA9IE1hdGgubWluKHgubGVuZ3RoLCB5Lmxlbmd0aCk7XG4gICAgaWYgKG4gPCAyKSB7XG4gICAgICByZXR1cm4gMDtcbiAgICB9XG5cbiAgICBjb25zdCBtZWFuWCA9IHguc2xpY2UoMCwgbikucmVkdWNlKChhLCBiKSA9PiBhICsgYiwgMCkgLyBuO1xuICAgIGNvbnN0IG1lYW5ZID0geS5zbGljZSgwLCBuKS5yZWR1Y2UoKGEsIGIpID0+IGEgKyBiLCAwKSAvIG47XG5cbiAgICBsZXQgbnVtZXJhdG9yID0gMDtcbiAgICBsZXQgZGVub21YID0gMDtcbiAgICBsZXQgZGVub21ZID0gMDtcblxuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbjsgaSsrKSB7XG4gICAgICBjb25zdCBkeCA9IHhbaV0gLSBtZWFuWDtcbiAgICAgIGNvbnN0IGR5ID0geVtpXSAtIG1lYW5ZO1xuICAgICAgbnVtZXJhdG9yICs9IGR4ICogZHk7XG4gICAgICBkZW5vbVggKz0gZHggKiBkeDtcbiAgICAgIGRlbm9tWSArPSBkeSAqIGR5O1xuICAgIH1cblxuICAgIGNvbnN0IGRlbm9taW5hdG9yID0gTWF0aC5zcXJ0KGRlbm9tWCAqIGRlbm9tWSk7XG4gICAgaWYgKGRlbm9taW5hdG9yID09PSAwKSB7XG4gICAgICByZXR1cm4gMDtcbiAgICB9XG5cbiAgICByZXR1cm4gbnVtZXJhdG9yIC8gZGVub21pbmF0b3I7XG4gIH1cblxuICAvKipcbiAgICogR2VuZXJhdGUgY2FjaGUga2V5IGZvciBjb3JyZWxhdGlvbiBwYWlyXG4gICAqL1xuICBwcml2YXRlIGdldENvcnJlbGF0aW9uQ2FjaGVLZXkoYXNzZXRBOiBzdHJpbmcsIGFzc2V0Qjogc3RyaW5nKTogc3RyaW5nIHtcbiAgICAvLyBTb3J0IHRvIGVuc3VyZSBjb25zaXN0ZW50IGtleSByZWdhcmRsZXNzIG9mIG9yZGVyXG4gICAgY29uc3Qgc29ydGVkID0gW2Fzc2V0QSwgYXNzZXRCXS5zb3J0KCk7XG4gICAgcmV0dXJuIGAke3NvcnRlZFswXX06JHtzb3J0ZWRbMV19YDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgbGlzdCBvZiBwb3NpdGlvbnMgdGhhdCBhcmUgY29ycmVsYXRlZCB3aXRoIHRoZSBzaWduYWxcbiAgICovXG4gIHByaXZhdGUgZ2V0Q29ycmVsYXRlZFBvc2l0aW9ucyhzaWduYWw6IEludGVudFNpZ25hbCwgcG9zaXRpb25zOiBQb3NpdGlvbltdKTogc3RyaW5nW10ge1xuICAgIGNvbnN0IGNvcnJlbGF0ZWRQb3NpdGlvbnM6IHN0cmluZ1tdID0gW107XG5cbiAgICBmb3IgKGNvbnN0IHBvcyBvZiBwb3NpdGlvbnMpIHtcbiAgICAgIGlmIChwb3Muc3ltYm9sID09PSBzaWduYWwuc3ltYm9sKSB7XG4gICAgICAgIGNvcnJlbGF0ZWRQb3NpdGlvbnMucHVzaChwb3Muc3ltYm9sKTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIGNvbnN0IGNvcnJlbGF0aW9uID0gTWF0aC5hYnModGhpcy5jYWxjdWxhdGVDb3JyZWxhdGlvbihzaWduYWwuc3ltYm9sLCBwb3Muc3ltYm9sKSk7XG4gICAgICAgIGlmIChjb3JyZWxhdGlvbiA+IHRoaXMuY29uZmlnLm1heENvcnJlbGF0aW9uKSB7XG4gICAgICAgICAgY29ycmVsYXRlZFBvc2l0aW9ucy5wdXNoKHBvcy5zeW1ib2wpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGNvcnJlbGF0ZWRQb3NpdGlvbnM7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==
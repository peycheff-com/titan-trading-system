b6ef85f30fc5dfd7c57890d874fef59f
"use strict";
/**
 * Logger - Structured logging with correlation IDs and performance tracking
 *
 * Provides JSON structured logging with correlation IDs, configurable log levels,
 * sensitive data masking, and performance tracking for Railway deployment.
 *
 * Requirements: 4.1.1, 4.1.2, 4.1.3, 4.1.4, 4.1.5
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.Logger = exports.LogLevel = void 0;
const crypto_1 = require("crypto");
/**
 * Log levels in order of severity
 */
var LogLevel;
(function (LogLevel) {
    LogLevel[LogLevel["DEBUG"] = 0] = "DEBUG";
    LogLevel[LogLevel["INFO"] = 1] = "INFO";
    LogLevel[LogLevel["WARN"] = 2] = "WARN";
    LogLevel[LogLevel["ERROR"] = 3] = "ERROR";
    LogLevel[LogLevel["FATAL"] = 4] = "FATAL";
})(LogLevel || (exports.LogLevel = LogLevel = {}));
/**
 * Structured logger with correlation IDs and performance tracking
 */
class Logger {
    config;
    static instance = null;
    activeTimers = new Map();
    constructor(config) {
        this.config = config;
    }
    /**
     * Create logger configuration from environment variables
     */
    static createConfigFromEnv(component = 'titan-brain') {
        const logLevelStr = process.env.LOG_LEVEL || 'INFO';
        const logLevel = LogLevel[logLevelStr.toUpperCase()] ?? LogLevel.INFO;
        return {
            level: logLevel,
            component,
            enableConsole: process.env.LOG_ENABLE_CONSOLE !== 'false',
            enableFile: process.env.LOG_ENABLE_FILE === 'true',
            filePath: process.env.LOG_FILE_PATH || './logs/titan-brain.log',
            enablePerformanceLogging: process.env.LOG_ENABLE_PERFORMANCE !== 'false',
            sensitiveFields: (process.env.LOG_SENSITIVE_FIELDS || 'password,secret,token,key,authorization').split(','),
            maxStackTraceLines: parseInt(process.env.LOG_MAX_STACK_LINES || '10')
        };
    }
    /**
     * Get or create singleton logger instance
     */
    static getInstance(component) {
        if (!Logger.instance) {
            const config = Logger.createConfigFromEnv(component);
            Logger.instance = new Logger(config);
        }
        return Logger.instance;
    }
    /**
     * Generate a new correlation ID
     */
    static generateCorrelationId() {
        return (0, crypto_1.randomUUID)();
    }
    /**
     * Mask sensitive data in objects
     */
    maskSensitiveData(obj) {
        if (obj === null || obj === undefined) {
            return obj;
        }
        if (typeof obj === 'string') {
            // Check if the string looks like a sensitive value
            const lowerStr = obj.toLowerCase();
            if (lowerStr.includes('password') || lowerStr.includes('secret') || lowerStr.includes('token')) {
                return '[MASKED]';
            }
            return obj;
        }
        if (Array.isArray(obj)) {
            return obj.map(item => this.maskSensitiveData(item));
        }
        if (typeof obj === 'object') {
            const masked = {};
            for (const [key, value] of Object.entries(obj)) {
                const lowerKey = key.toLowerCase();
                if (this.config.sensitiveFields.some(field => lowerKey.includes(field.toLowerCase()))) {
                    masked[key] = '[MASKED]';
                }
                else {
                    masked[key] = this.maskSensitiveData(value);
                }
            }
            return masked;
        }
        return obj;
    }
    /**
     * Format error for logging
     */
    formatError(error) {
        const stackLines = error.stack?.split('\n').slice(0, this.config.maxStackTraceLines);
        return {
            name: error.name,
            message: error.message,
            stack: stackLines?.join('\n'),
            code: error.code || error.statusCode
        };
    }
    /**
     * Create log entry
     */
    createLogEntry(level, message, correlationId, operation, duration, metadata, error) {
        const entry = {
            timestamp: new Date().toISOString(),
            level: LogLevel[level],
            message,
            component: this.config.component
        };
        if (correlationId) {
            entry.correlationId = correlationId;
        }
        if (operation) {
            entry.operation = operation;
        }
        if (duration !== undefined) {
            entry.duration = duration;
        }
        if (metadata) {
            entry.metadata = this.maskSensitiveData(metadata);
        }
        if (error) {
            entry.error = this.formatError(error);
        }
        return entry;
    }
    /**
     * Write log entry to outputs
     */
    writeLog(entry) {
        const logString = JSON.stringify(entry);
        // Console output
        if (this.config.enableConsole) {
            switch (entry.level) {
                case 'DEBUG':
                    console.debug(logString);
                    break;
                case 'INFO':
                    console.info(logString);
                    break;
                case 'WARN':
                    console.warn(logString);
                    break;
                case 'ERROR':
                case 'FATAL':
                    console.error(logString);
                    break;
                default:
                    console.log(logString);
            }
        }
        // File output (if enabled)
        if (this.config.enableFile && this.config.filePath) {
            // In a production environment, you might want to use a proper logging library
            // like winston or pino for file rotation and better performance
            try {
                const fs = require('fs');
                const path = require('path');
                // Ensure log directory exists
                const logDir = path.dirname(this.config.filePath);
                if (!fs.existsSync(logDir)) {
                    fs.mkdirSync(logDir, { recursive: true });
                }
                fs.appendFileSync(this.config.filePath, logString + '\n');
            }
            catch (error) {
                console.error('Failed to write to log file:', error);
            }
        }
    }
    /**
     * Check if log level should be logged
     */
    shouldLog(level) {
        return level >= this.config.level;
    }
    /**
     * Debug logging
     */
    debug(message, correlationId, metadata) {
        if (!this.shouldLog(LogLevel.DEBUG))
            return;
        const entry = this.createLogEntry(LogLevel.DEBUG, message, correlationId, undefined, undefined, metadata);
        this.writeLog(entry);
    }
    /**
     * Info logging
     */
    info(message, correlationId, metadata) {
        if (!this.shouldLog(LogLevel.INFO))
            return;
        const entry = this.createLogEntry(LogLevel.INFO, message, correlationId, undefined, undefined, metadata);
        this.writeLog(entry);
    }
    /**
     * Warning logging
     */
    warn(message, correlationId, metadata) {
        if (!this.shouldLog(LogLevel.WARN))
            return;
        const entry = this.createLogEntry(LogLevel.WARN, message, correlationId, undefined, undefined, metadata);
        this.writeLog(entry);
    }
    /**
     * Error logging
     */
    error(message, error, correlationId, metadata) {
        if (!this.shouldLog(LogLevel.ERROR))
            return;
        const entry = this.createLogEntry(LogLevel.ERROR, message, correlationId, undefined, undefined, metadata, error);
        this.writeLog(entry);
    }
    /**
     * Fatal error logging
     */
    fatal(message, error, correlationId, metadata) {
        if (!this.shouldLog(LogLevel.FATAL))
            return;
        const entry = this.createLogEntry(LogLevel.FATAL, message, correlationId, undefined, undefined, metadata, error);
        this.writeLog(entry);
    }
    /**
     * Start performance timer
     */
    startTimer(operation, correlationId, metadata) {
        const timerId = (0, crypto_1.randomUUID)();
        const timer = {
            operation,
            startTime: Date.now(),
            correlationId,
            metadata
        };
        this.activeTimers.set(timerId, timer);
        if (this.config.enablePerformanceLogging) {
            this.debug(`Started operation: ${operation}`, correlationId, {
                timerId,
                ...metadata
            });
        }
        return timerId;
    }
    /**
     * End performance timer and log duration
     */
    endTimer(timerId, additionalMetadata) {
        const timer = this.activeTimers.get(timerId);
        if (!timer) {
            this.warn(`Timer not found: ${timerId}`);
            return null;
        }
        const duration = Date.now() - timer.startTime;
        this.activeTimers.delete(timerId);
        if (this.config.enablePerformanceLogging) {
            const metadata = {
                timerId,
                ...timer.metadata,
                ...additionalMetadata
            };
            const entry = this.createLogEntry(LogLevel.INFO, `Completed operation: ${timer.operation}`, timer.correlationId, timer.operation, duration, metadata);
            this.writeLog(entry);
        }
        return duration;
    }
    /**
     * Log HTTP request
     */
    logHttpRequest(method, url, statusCode, duration, correlationId, metadata) {
        const level = statusCode >= 400 ? LogLevel.WARN : LogLevel.INFO;
        if (!this.shouldLog(level))
            return;
        const entry = this.createLogEntry(level, `HTTP ${method} ${url} - ${statusCode}`, correlationId, 'http_request', duration, {
            method,
            url,
            statusCode,
            ...metadata
        });
        this.writeLog(entry);
    }
    /**
     * Log database operation
     */
    logDatabaseOperation(operation, table, duration, rowCount, correlationId, metadata) {
        if (!this.shouldLog(LogLevel.DEBUG))
            return;
        const entry = this.createLogEntry(LogLevel.DEBUG, `Database ${operation} on ${table}`, correlationId, 'database_operation', duration, {
            operation,
            table,
            rowCount,
            ...metadata
        });
        this.writeLog(entry);
    }
    /**
     * Log cache operation
     */
    logCacheOperation(operation, key, hit, duration, correlationId, metadata) {
        if (!this.shouldLog(LogLevel.DEBUG))
            return;
        const entry = this.createLogEntry(LogLevel.DEBUG, `Cache ${operation} for ${key} - ${hit ? 'HIT' : 'MISS'}`, correlationId, 'cache_operation', duration, {
            operation,
            key,
            hit,
            ...metadata
        });
        this.writeLog(entry);
    }
    /**
     * Log security event
     */
    logSecurityEvent(event, severity, correlationId, metadata) {
        const level = severity === 'critical' ? LogLevel.FATAL :
            severity === 'high' ? LogLevel.ERROR :
                severity === 'medium' ? LogLevel.WARN : LogLevel.INFO;
        if (!this.shouldLog(level))
            return;
        const entry = this.createLogEntry(level, `Security event: ${event}`, correlationId, 'security_event', undefined, {
            event,
            severity,
            ...metadata
        });
        this.writeLog(entry);
    }
    /**
     * Get current configuration
     */
    getConfig() {
        return { ...this.config };
    }
    /**
     * Update log level
     */
    setLogLevel(level) {
        this.config.level = level;
        this.info(`Log level changed to ${LogLevel[level]}`);
    }
    /**
     * Get active timer count
     */
    getActiveTimerCount() {
        return this.activeTimers.size;
    }
    /**
     * Clear all active timers (useful for testing)
     */
    clearTimers() {
        this.activeTimers.clear();
    }
}
exports.Logger = Logger;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLWJyYWluL3NyYy9sb2dnaW5nL0xvZ2dlci50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7R0FPRzs7O0FBRUgsbUNBQW9DO0FBRXBDOztHQUVHO0FBQ0gsSUFBWSxRQU1YO0FBTkQsV0FBWSxRQUFRO0lBQ2xCLHlDQUFTLENBQUE7SUFDVCx1Q0FBUSxDQUFBO0lBQ1IsdUNBQVEsQ0FBQTtJQUNSLHlDQUFTLENBQUE7SUFDVCx5Q0FBUyxDQUFBO0FBQ1gsQ0FBQyxFQU5XLFFBQVEsd0JBQVIsUUFBUSxRQU1uQjtBQThDRDs7R0FFRztBQUNILE1BQWEsTUFBTTtJQUNULE1BQU0sQ0FBZTtJQUNyQixNQUFNLENBQUMsUUFBUSxHQUFrQixJQUFJLENBQUM7SUFDdEMsWUFBWSxHQUFrQyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBRWhFLFlBQVksTUFBb0I7UUFDOUIsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7SUFDdkIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLG1CQUFtQixDQUFDLFlBQW9CLGFBQWE7UUFDMUQsTUFBTSxXQUFXLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxTQUFTLElBQUksTUFBTSxDQUFDO1FBQ3BELE1BQU0sUUFBUSxHQUFHLFFBQVEsQ0FBQyxXQUFXLENBQUMsV0FBVyxFQUEyQixDQUFDLElBQUksUUFBUSxDQUFDLElBQUksQ0FBQztRQUUvRixPQUFPO1lBQ0wsS0FBSyxFQUFFLFFBQVE7WUFDZixTQUFTO1lBQ1QsYUFBYSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLEtBQUssT0FBTztZQUN6RCxVQUFVLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLEtBQUssTUFBTTtZQUNsRCxRQUFRLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxhQUFhLElBQUksd0JBQXdCO1lBQy9ELHdCQUF3QixFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNC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Q0FBQyxDQUFDLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQyxDQUFDO2dCQUN0QyxRQUFRLEtBQUssUUFBUSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDLENBQUMsQ0FBQyxRQUFRLENBQUMsSUFBSSxDQUFDO1FBRXBFLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxDQUFDLEtBQUssQ0FBQztZQUFFLE9BQU87UUFFbkMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FDL0IsS0FBSyxFQUNMLG1CQUFtQixLQUFLLEVBQUUsRUFDMUIsYUFBYSxFQUNiLGdCQUFnQixFQUNoQixTQUFTLEVBQ1Q7WUFDRSxLQUFLO1lBQ0wsUUFBUTtZQUNSLEdBQUcsUUFBUTtTQUNaLENBQ0YsQ0FBQztRQUVGLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7SUFDdkIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsU0FBUztRQUNQLE9BQU8sRUFBRSxHQUFHLElBQUksQ0FBQyxNQUFNLEVBQUUsQ0FBQztJQUM1QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxXQUFXLENBQUMsS0FBZTtRQUN6QixJQUFJLENBQUMsTUFBTSxDQUFDLEtBQUssR0FBRyxLQUFLLENBQUM7UUFDMUIsSUFBSSxDQUFDLElBQUksQ0FBQyx3QkFBd0IsUUFBUSxDQUFDLEtBQUssQ0FBQyxFQUFFLENBQUMsQ0FBQztJQUN2RCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxtQkFBbUI7UUFDakIsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQztJQUNoQyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxXQUFXO1FBQ1QsSUFBSSxDQUFDLFlBQVksQ0FBQyxLQUFLLEVBQUUsQ0FBQztJQUM1QixDQUFDOztBQXBjSCx3QkFxY0MiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLWJyYWluL3NyYy9sb2dnaW5nL0xvZ2dlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIExvZ2dlciAtIFN0cnVjdHVyZWQgbG9nZ2luZyB3aXRoIGNvcnJlbGF0aW9uIElEcyBhbmQgcGVyZm9ybWFuY2UgdHJhY2tpbmdcbiAqIFxuICogUHJvdmlkZXMgSlNPTiBzdHJ1Y3R1cmVkIGxvZ2dpbmcgd2l0aCBjb3JyZWxhdGlvbiBJRHMsIGNvbmZpZ3VyYWJsZSBsb2cgbGV2ZWxzLFxuICogc2Vuc2l0aXZlIGRhdGEgbWFza2luZywgYW5kIHBlcmZvcm1hbmNlIHRyYWNraW5nIGZvciBSYWlsd2F5IGRlcGxveW1lbnQuXG4gKiBcbiAqIFJlcXVpcmVtZW50czogNC4xLjEsIDQuMS4yLCA0LjEuMywgNC4xLjQsIDQuMS41XG4gKi9cblxuaW1wb3J0IHsgcmFuZG9tVVVJRCB9IGZyb20gJ2NyeXB0byc7XG5cbi8qKlxuICogTG9nIGxldmVscyBpbiBvcmRlciBvZiBzZXZlcml0eVxuICovXG5leHBvcnQgZW51bSBMb2dMZXZlbCB7XG4gIERFQlVHID0gMCxcbiAgSU5GTyA9IDEsXG4gIFdBUk4gPSAyLFxuICBFUlJPUiA9IDMsXG4gIEZBVEFMID0gNFxufVxuXG4vKipcbiAqIExvZyBlbnRyeSBzdHJ1Y3R1cmVcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBMb2dFbnRyeSB7XG4gIHRpbWVzdGFtcDogc3RyaW5nO1xuICBsZXZlbDogc3RyaW5nO1xuICBtZXNzYWdlOiBzdHJpbmc7XG4gIGNvcnJlbGF0aW9uSWQ/OiBzdHJpbmc7XG4gIGNvbXBvbmVudD86IHN0cmluZztcbiAgb3BlcmF0aW9uPzogc3RyaW5nO1xuICBkdXJhdGlvbj86IG51bWJlcjtcbiAgbWV0YWRhdGE/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xuICBlcnJvcj86IHtcbiAgICBuYW1lOiBzdHJpbmc7XG4gICAgbWVzc2FnZTogc3RyaW5nO1xuICAgIHN0YWNrPzogc3RyaW5nO1xuICAgIGNvZGU/OiBzdHJpbmcgfCBudW1iZXI7XG4gIH07XG59XG5cbi8qKlxuICogTG9nZ2VyIGNvbmZpZ3VyYXRpb25cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBMb2dnZXJDb25maWcge1xuICBsZXZlbDogTG9nTGV2ZWw7XG4gIGNvbXBvbmVudDogc3RyaW5nO1xuICBlbmFibGVDb25zb2xlOiBib29sZWFuO1xuICBlbmFibGVGaWxlOiBib29sZWFuO1xuICBmaWxlUGF0aD86IHN0cmluZztcbiAgZW5hYmxlUGVyZm9ybWFuY2VMb2dnaW5nOiBib29sZWFuO1xuICBzZW5zaXRpdmVGaWVsZHM6IHN0cmluZ1tdO1xuICBtYXhTdGFja1RyYWNlTGluZXM6IG51bWJlcjtcbn1cblxuLyoqXG4gKiBQZXJmb3JtYW5jZSB0aW1lciBmb3Igb3BlcmF0aW9uIHRyYWNraW5nXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgUGVyZm9ybWFuY2VUaW1lciB7XG4gIG9wZXJhdGlvbjogc3RyaW5nO1xuICBzdGFydFRpbWU6IG51bWJlcjtcbiAgY29ycmVsYXRpb25JZD86IHN0cmluZztcbiAgbWV0YWRhdGE/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+O1xufVxuXG4vKipcbiAqIFN0cnVjdHVyZWQgbG9nZ2VyIHdpdGggY29ycmVsYXRpb24gSURzIGFuZCBwZXJmb3JtYW5jZSB0cmFja2luZ1xuICovXG5leHBvcnQgY2xhc3MgTG9nZ2VyIHtcbiAgcHJpdmF0ZSBjb25maWc6IExvZ2dlckNvbmZpZztcbiAgcHJpdmF0ZSBzdGF0aWMgaW5zdGFuY2U6IExvZ2dlciB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIGFjdGl2ZVRpbWVyczogTWFwPHN0cmluZywgUGVyZm9ybWFuY2VUaW1lcj4gPSBuZXcgTWFwKCk7XG5cbiAgY29uc3RydWN0b3IoY29uZmlnOiBMb2dnZXJDb25maWcpIHtcbiAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgbG9nZ2VyIGNvbmZpZ3VyYXRpb24gZnJvbSBlbnZpcm9ubWVudCB2YXJpYWJsZXNcbiAgICovXG4gIHN0YXRpYyBjcmVhdGVDb25maWdGcm9tRW52KGNvbXBvbmVudDogc3RyaW5nID0gJ3RpdGFuLWJyYWluJyk6IExvZ2dlckNvbmZpZyB7XG4gICAgY29uc3QgbG9nTGV2ZWxTdHIgPSBwcm9jZXNzLmVudi5MT0dfTEVWRUwgfHwgJ0lORk8nO1xuICAgIGNvbnN0IGxvZ0xldmVsID0gTG9nTGV2ZWxbbG9nTGV2ZWxTdHIudG9VcHBlckNhc2UoKSBhcyBrZXlvZiB0eXBlb2YgTG9nTGV2ZWxdID8/IExvZ0xldmVsLklORk87XG5cbiAgICByZXR1cm4ge1xuICAgICAgbGV2ZWw6IGxvZ0xldmVsLFxuICAgICAgY29tcG9uZW50LFxuICAgICAgZW5hYmxlQ29uc29sZTogcHJvY2Vzcy5lbnYuTE9HX0VOQUJMRV9DT05TT0xFICE9PSAnZmFsc2UnLFxuICAgICAgZW5hYmxlRmlsZTogcHJvY2Vzcy5lbnYuTE9HX0VOQUJMRV9GSUxFID09PSAndHJ1ZScsXG4gICAgICBmaWxlUGF0aDogcHJvY2Vzcy5lbnYuTE9HX0ZJTEVfUEFUSCB8fCAnLi9sb2dzL3RpdGFuLWJyYWluLmxvZycsXG4gICAgICBlbmFibGVQZXJmb3JtYW5jZUxvZ2dpbmc6IHByb2Nlc3MuZW52LkxPR19FTkFCTEVfUEVSRk9STUFOQ0UgIT09ICdmYWxzZScsXG4gICAgICBzZW5zaXRpdmVGaWVsZHM6IChwcm9jZXNzLmVudi5MT0dfU0VOU0lUSVZFX0ZJRUxEUyB8fCAncGFzc3dvcmQsc2VjcmV0LHRva2VuLGtleSxhdXRob3JpemF0aW9uJykuc3BsaXQoJywnKSxcbiAgICAgIG1heFN0YWNrVHJhY2VMaW5lczogcGFyc2VJbnQocHJvY2Vzcy5lbnYuTE9HX01BWF9TVEFDS19MSU5FUyB8fCAnMTAnKVxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogR2V0IG9yIGNyZWF0ZSBzaW5nbGV0b24gbG9nZ2VyIGluc3RhbmNlXG4gICAqL1xuICBzdGF0aWMgZ2V0SW5zdGFuY2UoY29tcG9uZW50Pzogc3RyaW5nKTogTG9nZ2VyIHtcbiAgICBpZiAoIUxvZ2dlci5pbnN0YW5jZSkge1xuICAgICAgY29uc3QgY29uZmlnID0gTG9nZ2VyLmNyZWF0ZUNvbmZpZ0Zyb21FbnYoY29tcG9uZW50KTtcbiAgICAgIExvZ2dlci5pbnN0YW5jZSA9IG5ldyBMb2dnZXIoY29uZmlnKTtcbiAgICB9XG4gICAgcmV0dXJuIExvZ2dlci5pbnN0YW5jZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZSBhIG5ldyBjb3JyZWxhdGlvbiBJRFxuICAgKi9cbiAgc3RhdGljIGdlbmVyYXRlQ29ycmVsYXRpb25JZCgpOiBzdHJpbmcge1xuICAgIHJldHVybiByYW5kb21VVUlEKCk7XG4gIH1cblxuICAvKipcbiAgICogTWFzayBzZW5zaXRpdmUgZGF0YSBpbiBvYmplY3RzXG4gICAqL1xuICBwcml2YXRlIG1hc2tTZW5zaXRpdmVEYXRhKG9iajogYW55KTogYW55IHtcbiAgICBpZiAob2JqID09PSBudWxsIHx8IG9iaiA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICByZXR1cm4gb2JqO1xuICAgIH1cblxuICAgIGlmICh0eXBlb2Ygb2JqID09PSAnc3RyaW5nJykge1xuICAgICAgLy8gQ2hlY2sgaWYgdGhlIHN0cmluZyBsb29rcyBsaWtlIGEgc2Vuc2l0aXZlIHZhbHVlXG4gICAgICBjb25zdCBsb3dlclN0ciA9IG9iai50b0xvd2VyQ2FzZSgpO1xuICAgICAgaWYgKGxvd2VyU3RyLmluY2x1ZGVzKCdwYXNzd29yZCcpIHx8IGxvd2VyU3RyLmluY2x1ZGVzKCdzZWNyZXQnKSB8fCBsb3dlclN0ci5pbmNsdWRlcygndG9rZW4nKSkge1xuICAgICAgICByZXR1cm4gJ1tNQVNLRURdJztcbiAgICAgIH1cbiAgICAgIHJldHVybiBvYmo7XG4gICAgfVxuXG4gICAgaWYgKEFycmF5LmlzQXJyYXkob2JqKSkge1xuICAgICAgcmV0dXJuIG9iai5tYXAoaXRlbSA9PiB0aGlzLm1hc2tTZW5zaXRpdmVEYXRhKGl0ZW0pKTtcbiAgICB9XG5cbiAgICBpZiAodHlwZW9mIG9iaiA9PT0gJ29iamVjdCcpIHtcbiAgICAgIGNvbnN0IG1hc2tlZDogYW55ID0ge307XG4gICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbHVlXSBvZiBPYmplY3QuZW50cmllcyhvYmopKSB7XG4gICAgICAgIGNvbnN0IGxvd2VyS2V5ID0ga2V5LnRvTG93ZXJDYXNlKCk7XG4gICAgICAgIGlmICh0aGlzLmNvbmZpZy5zZW5zaXRpdmVGaWVsZHMuc29tZShmaWVsZCA9PiBsb3dlcktleS5pbmNsdWRlcyhmaWVsZC50b0xvd2VyQ2FzZSgpKSkpIHtcbiAgICAgICAgICBtYXNrZWRba2V5XSA9ICdbTUFTS0VEXSc7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgbWFza2VkW2tleV0gPSB0aGlzLm1hc2tTZW5zaXRpdmVEYXRhKHZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIG1hc2tlZDtcbiAgICB9XG5cbiAgICByZXR1cm4gb2JqO1xuICB9XG5cbiAgLyoqXG4gICAqIEZvcm1hdCBlcnJvciBmb3IgbG9nZ2luZ1xuICAgKi9cbiAgcHJpdmF0ZSBmb3JtYXRFcnJvcihlcnJvcjogRXJyb3IpOiBMb2dFbnRyeVsnZXJyb3InXSB7XG4gICAgY29uc3Qgc3RhY2tMaW5lcyA9IGVycm9yLnN0YWNrPy5zcGxpdCgnXFxuJykuc2xpY2UoMCwgdGhpcy5jb25maWcubWF4U3RhY2tUcmFjZUxpbmVzKTtcbiAgICBcbiAgICByZXR1cm4ge1xuICAgICAgbmFtZTogZXJyb3IubmFtZSxcbiAgICAgIG1lc3NhZ2U6IGVycm9yLm1lc3NhZ2UsXG4gICAgICBzdGFjazogc3RhY2tMaW5lcz8uam9pbignXFxuJyksXG4gICAgICBjb2RlOiAoZXJyb3IgYXMgYW55KS5jb2RlIHx8IChlcnJvciBhcyBhbnkpLnN0YXR1c0NvZGVcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBsb2cgZW50cnlcbiAgICovXG4gIHByaXZhdGUgY3JlYXRlTG9nRW50cnkoXG4gICAgbGV2ZWw6IExvZ0xldmVsLFxuICAgIG1lc3NhZ2U6IHN0cmluZyxcbiAgICBjb3JyZWxhdGlvbklkPzogc3RyaW5nLFxuICAgIG9wZXJhdGlvbj86IHN0cmluZyxcbiAgICBkdXJhdGlvbj86IG51bWJlcixcbiAgICBtZXRhZGF0YT86IFJlY29yZDxzdHJpbmcsIGFueT4sXG4gICAgZXJyb3I/OiBFcnJvclxuICApOiBMb2dFbnRyeSB7XG4gICAgY29uc3QgZW50cnk6IExvZ0VudHJ5ID0ge1xuICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKCksXG4gICAgICBsZXZlbDogTG9nTGV2ZWxbbGV2ZWxdLFxuICAgICAgbWVzc2FnZSxcbiAgICAgIGNvbXBvbmVudDogdGhpcy5jb25maWcuY29tcG9uZW50XG4gICAgfTtcblxuICAgIGlmIChjb3JyZWxhdGlvbklkKSB7XG4gICAgICBlbnRyeS5jb3JyZWxhdGlvbklkID0gY29ycmVsYXRpb25JZDtcbiAgICB9XG5cbiAgICBpZiAob3BlcmF0aW9uKSB7XG4gICAgICBlbnRyeS5vcGVyYXRpb24gPSBvcGVyYXRpb247XG4gICAgfVxuXG4gICAgaWYgKGR1cmF0aW9uICE9PSB1bmRlZmluZWQpIHtcbiAgICAgIGVudHJ5LmR1cmF0aW9uID0gZHVyYXRpb247XG4gICAgfVxuXG4gICAgaWYgKG1ldGFkYXRhKSB7XG4gICAgICBlbnRyeS5tZXRhZGF0YSA9IHRoaXMubWFza1NlbnNpdGl2ZURhdGEobWV0YWRhdGEpO1xuICAgIH1cblxuICAgIGlmIChlcnJvcikge1xuICAgICAgZW50cnkuZXJyb3IgPSB0aGlzLmZvcm1hdEVycm9yKGVycm9yKTtcbiAgICB9XG5cbiAgICByZXR1cm4gZW50cnk7XG4gIH1cblxuICAvKipcbiAgICogV3JpdGUgbG9nIGVudHJ5IHRvIG91dHB1dHNcbiAgICovXG4gIHByaXZhdGUgd3JpdGVMb2coZW50cnk6IExvZ0VudHJ5KTogdm9pZCB7XG4gICAgY29uc3QgbG9nU3RyaW5nID0gSlNPTi5zdHJpbmdpZnkoZW50cnkpO1xuXG4gICAgLy8gQ29uc29sZSBvdXRwdXRcbiAgICBpZiAodGhpcy5jb25maWcuZW5hYmxlQ29uc29sZSkge1xuICAgICAgc3dpdGNoIChlbnRyeS5sZXZlbCkge1xuICAgICAgICBjYXNlICdERUJVRyc6XG4gICAgICAgICAgY29uc29sZS5kZWJ1Zyhsb2dTdHJpbmcpO1xuICAgICAgICAgIGJyZWFrO1xuICAgICAgICBjYXNlICdJTkZPJzpcbiAgICAgICAgICBjb25zb2xlLmluZm8obG9nU3RyaW5nKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgY2FzZSAnV0FSTic6XG4gICAgICAgICAgY29uc29sZS53YXJuKGxvZ1N0cmluZyk7XG4gICAgICAgICAgYnJlYWs7XG4gICAgICAgIGNhc2UgJ0VSUk9SJzpcbiAgICAgICAgY2FzZSAnRkFUQUwnOlxuICAgICAgICAgIGNvbnNvbGUuZXJyb3IobG9nU3RyaW5nKTtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgZGVmYXVsdDpcbiAgICAgICAgICBjb25zb2xlLmxvZyhsb2dTdHJpbmcpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIEZpbGUgb3V0cHV0IChpZiBlbmFibGVkKVxuICAgIGlmICh0aGlzLmNvbmZpZy5lbmFibGVGaWxlICYmIHRoaXMuY29uZmlnLmZpbGVQYXRoKSB7XG4gICAgICAvLyBJbiBhIHByb2R1Y3Rpb24gZW52aXJvbm1lbnQsIHlvdSBtaWdodCB3YW50IHRvIHVzZSBhIHByb3BlciBsb2dnaW5nIGxpYnJhcnlcbiAgICAgIC8vIGxpa2Ugd2luc3RvbiBvciBwaW5vIGZvciBmaWxlIHJvdGF0aW9uIGFuZCBiZXR0ZXIgcGVyZm9ybWFuY2VcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IGZzID0gcmVxdWlyZSgnZnMnKTtcbiAgICAgICAgY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbiAgICAgICAgXG4gICAgICAgIC8vIEVuc3VyZSBsb2cgZGlyZWN0b3J5IGV4aXN0c1xuICAgICAgICBjb25zdCBsb2dEaXIgPSBwYXRoLmRpcm5hbWUodGhpcy5jb25maWcuZmlsZVBhdGgpO1xuICAgICAgICBpZiAoIWZzLmV4aXN0c1N5bmMobG9nRGlyKSkge1xuICAgICAgICAgIGZzLm1rZGlyU3luYyhsb2dEaXIsIHsgcmVjdXJzaXZlOiB0cnVlIH0pO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBmcy5hcHBlbmRGaWxlU3luYyh0aGlzLmNvbmZpZy5maWxlUGF0aCwgbG9nU3RyaW5nICsgJ1xcbicpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIHdyaXRlIHRvIGxvZyBmaWxlOicsIGVycm9yKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgaWYgbG9nIGxldmVsIHNob3VsZCBiZSBsb2dnZWRcbiAgICovXG4gIHByaXZhdGUgc2hvdWxkTG9nKGxldmVsOiBMb2dMZXZlbCk6IGJvb2xlYW4ge1xuICAgIHJldHVybiBsZXZlbCA+PSB0aGlzLmNvbmZpZy5sZXZlbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWJ1ZyBsb2dnaW5nXG4gICAqL1xuICBkZWJ1ZyhtZXNzYWdlOiBzdHJpbmcsIGNvcnJlbGF0aW9uSWQ/OiBzdHJpbmcsIG1ldGFkYXRhPzogUmVjb3JkPHN0cmluZywgYW55Pik6IHZvaWQge1xuICAgIGlmICghdGhpcy5zaG91bGRMb2coTG9nTGV2ZWwuREVCVUcpKSByZXR1cm47XG4gICAgXG4gICAgY29uc3QgZW50cnkgPSB0aGlzLmNyZWF0ZUxvZ0VudHJ5KExvZ0xldmVsLkRFQlVHLCBtZXNzYWdlLCBjb3JyZWxhdGlvbklkLCB1bmRlZmluZWQsIHVuZGVmaW5lZCwgbWV0YWRhdGEpO1xuICAgIHRoaXMud3JpdGVMb2coZW50cnkpO1xuICB9XG5cbiAgLyoqXG4gICAqIEluZm8gbG9nZ2luZ1xuICAgKi9cbiAgaW5mbyhtZXNzYWdlOiBzdHJpbmcsIGNvcnJlbGF0aW9uSWQ/OiBzdHJpbmcsIG1ldGFkYXRhPzogUmVjb3JkPHN0cmluZywgYW55Pik6IHZvaWQge1xuICAgIGlmICghdGhpcy5zaG91bGRMb2coTG9nTGV2ZWwuSU5GTykpIHJldHVybjtcbiAgICBcbiAgICBjb25zdCBlbnRyeSA9IHRoaXMuY3JlYXRlTG9nRW50cnkoTG9nTGV2ZWwuSU5GTywgbWVzc2FnZSwgY29ycmVsYXRpb25JZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIG1ldGFkYXRhKTtcbiAgICB0aGlzLndyaXRlTG9nKGVudHJ5KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBXYXJuaW5nIGxvZ2dpbmdcbiAgICovXG4gIHdhcm4obWVzc2FnZTogc3RyaW5nLCBjb3JyZWxhdGlvbklkPzogc3RyaW5nLCBtZXRhZGF0YT86IFJlY29yZDxzdHJpbmcsIGFueT4pOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuc2hvdWxkTG9nKExvZ0xldmVsLldBUk4pKSByZXR1cm47XG4gICAgXG4gICAgY29uc3QgZW50cnkgPSB0aGlzLmNyZWF0ZUxvZ0VudHJ5KExvZ0xldmVsLldBUk4sIG1lc3NhZ2UsIGNvcnJlbGF0aW9uSWQsIHVuZGVmaW5lZCwgdW5kZWZpbmVkLCBtZXRhZGF0YSk7XG4gICAgdGhpcy53cml0ZUxvZyhlbnRyeSk7XG4gIH1cblxuICAvKipcbiAgICogRXJyb3IgbG9nZ2luZ1xuICAgKi9cbiAgZXJyb3IobWVzc2FnZTogc3RyaW5nLCBlcnJvcj86IEVycm9yLCBjb3JyZWxhdGlvbklkPzogc3RyaW5nLCBtZXRhZGF0YT86IFJlY29yZDxzdHJpbmcsIGFueT4pOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuc2hvdWxkTG9nKExvZ0xldmVsLkVSUk9SKSkgcmV0dXJuO1xuICAgIFxuICAgIGNvbnN0IGVudHJ5ID0gdGhpcy5jcmVhdGVMb2dFbnRyeShMb2dMZXZlbC5FUlJPUiwgbWVzc2FnZSwgY29ycmVsYXRpb25JZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIG1ldGFkYXRhLCBlcnJvcik7XG4gICAgdGhpcy53cml0ZUxvZyhlbnRyeSk7XG4gIH1cblxuICAvKipcbiAgICogRmF0YWwgZXJyb3IgbG9nZ2luZ1xuICAgKi9cbiAgZmF0YWwobWVzc2FnZTogc3RyaW5nLCBlcnJvcj86IEVycm9yLCBjb3JyZWxhdGlvbklkPzogc3RyaW5nLCBtZXRhZGF0YT86IFJlY29yZDxzdHJpbmcsIGFueT4pOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuc2hvdWxkTG9nKExvZ0xldmVsLkZBVEFMKSkgcmV0dXJuO1xuICAgIFxuICAgIGNvbnN0IGVudHJ5ID0gdGhpcy5jcmVhdGVMb2dFbnRyeShMb2dMZXZlbC5GQVRBTCwgbWVzc2FnZSwgY29ycmVsYXRpb25JZCwgdW5kZWZpbmVkLCB1bmRlZmluZWQsIG1ldGFkYXRhLCBlcnJvcik7XG4gICAgdGhpcy53cml0ZUxvZyhlbnRyeSk7XG4gIH1cblxuICAvKipcbiAgICogU3RhcnQgcGVyZm9ybWFuY2UgdGltZXJcbiAgICovXG4gIHN0YXJ0VGltZXIob3BlcmF0aW9uOiBzdHJpbmcsIGNvcnJlbGF0aW9uSWQ/OiBzdHJpbmcsIG1ldGFkYXRhPzogUmVjb3JkPHN0cmluZywgYW55Pik6IHN0cmluZyB7XG4gICAgY29uc3QgdGltZXJJZCA9IHJhbmRvbVVVSUQoKTtcbiAgICBjb25zdCB0aW1lcjogUGVyZm9ybWFuY2VUaW1lciA9IHtcbiAgICAgIG9wZXJhdGlvbixcbiAgICAgIHN0YXJ0VGltZTogRGF0ZS5ub3coKSxcbiAgICAgIGNvcnJlbGF0aW9uSWQsXG4gICAgICBtZXRhZGF0YVxuICAgIH07XG4gICAgXG4gICAgdGhpcy5hY3RpdmVUaW1lcnMuc2V0KHRpbWVySWQsIHRpbWVyKTtcbiAgICBcbiAgICBpZiAodGhpcy5jb25maWcuZW5hYmxlUGVyZm9ybWFuY2VMb2dnaW5nKSB7XG4gICAgICB0aGlzLmRlYnVnKGBTdGFydGVkIG9wZXJhdGlvbjogJHtvcGVyYXRpb259YCwgY29ycmVsYXRpb25JZCwgeyBcbiAgICAgICAgdGltZXJJZCwgXG4gICAgICAgIC4uLm1ldGFkYXRhIFxuICAgICAgfSk7XG4gICAgfVxuICAgIFxuICAgIHJldHVybiB0aW1lcklkO1xuICB9XG5cbiAgLyoqXG4gICAqIEVuZCBwZXJmb3JtYW5jZSB0aW1lciBhbmQgbG9nIGR1cmF0aW9uXG4gICAqL1xuICBlbmRUaW1lcih0aW1lcklkOiBzdHJpbmcsIGFkZGl0aW9uYWxNZXRhZGF0YT86IFJlY29yZDxzdHJpbmcsIGFueT4pOiBudW1iZXIgfCBudWxsIHtcbiAgICBjb25zdCB0aW1lciA9IHRoaXMuYWN0aXZlVGltZXJzLmdldCh0aW1lcklkKTtcbiAgICBpZiAoIXRpbWVyKSB7XG4gICAgICB0aGlzLndhcm4oYFRpbWVyIG5vdCBmb3VuZDogJHt0aW1lcklkfWApO1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3QgZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gdGltZXIuc3RhcnRUaW1lO1xuICAgIHRoaXMuYWN0aXZlVGltZXJzLmRlbGV0ZSh0aW1lcklkKTtcblxuICAgIGlmICh0aGlzLmNvbmZpZy5lbmFibGVQZXJmb3JtYW5jZUxvZ2dpbmcpIHtcbiAgICAgIGNvbnN0IG1ldGFkYXRhID0ge1xuICAgICAgICB0aW1lcklkLFxuICAgICAgICAuLi50aW1lci5tZXRhZGF0YSxcbiAgICAgICAgLi4uYWRkaXRpb25hbE1ldGFkYXRhXG4gICAgICB9O1xuXG4gICAgICBjb25zdCBlbnRyeSA9IHRoaXMuY3JlYXRlTG9nRW50cnkoXG4gICAgICAgIExvZ0xldmVsLklORk8sXG4gICAgICAgIGBDb21wbGV0ZWQgb3BlcmF0aW9uOiAke3RpbWVyLm9wZXJhdGlvbn1gLFxuICAgICAgICB0aW1lci5jb3JyZWxhdGlvbklkLFxuICAgICAgICB0aW1lci5vcGVyYXRpb24sXG4gICAgICAgIGR1cmF0aW9uLFxuICAgICAgICBtZXRhZGF0YVxuICAgICAgKTtcbiAgICAgIFxuICAgICAgdGhpcy53cml0ZUxvZyhlbnRyeSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGR1cmF0aW9uO1xuICB9XG5cbiAgLyoqXG4gICAqIExvZyBIVFRQIHJlcXVlc3RcbiAgICovXG4gIGxvZ0h0dHBSZXF1ZXN0KFxuICAgIG1ldGhvZDogc3RyaW5nLFxuICAgIHVybDogc3RyaW5nLFxuICAgIHN0YXR1c0NvZGU6IG51bWJlcixcbiAgICBkdXJhdGlvbjogbnVtYmVyLFxuICAgIGNvcnJlbGF0aW9uSWQ/OiBzdHJpbmcsXG4gICAgbWV0YWRhdGE/OiBSZWNvcmQ8c3RyaW5nLCBhbnk+XG4gICk6IHZvaWQge1xuICAgIGNvbnN0IGxldmVsID0gc3RhdHVzQ29kZSA+PSA0MDAgPyBMb2dMZXZlbC5XQVJOIDogTG9nTGV2ZWwuSU5GTztcbiAgICBpZiAoIXRoaXMuc2hvdWxkTG9nKGxldmVsKSkgcmV0dXJuO1xuXG4gICAgY29uc3QgZW50cnkgPSB0aGlzLmNyZWF0ZUxvZ0VudHJ5KFxuICAgICAgbGV2ZWwsXG4gICAgICBgSFRUUCAke21ldGhvZH0gJHt1cmx9IC0gJHtzdGF0dXNDb2RlfWAsXG4gICAgICBjb3JyZWxhdGlvbklkLFxuICAgICAgJ2h0dHBfcmVxdWVzdCcsXG4gICAgICBkdXJhdGlvbixcbiAgICAgIHtcbiAgICAgICAgbWV0aG9kLFxuICAgICAgICB1cmwsXG4gICAgICAgIHN0YXR1c0NvZGUsXG4gICAgICAgIC4uLm1ldGFkYXRhXG4gICAgICB9XG4gICAgKTtcblxuICAgIHRoaXMud3JpdGVMb2coZW50cnkpO1xuICB9XG5cbiAgLyoqXG4gICAqIExvZyBkYXRhYmFzZSBvcGVyYXRpb25cbiAgICovXG4gIGxvZ0RhdGFiYXNlT3BlcmF0aW9uKFxuICAgIG9wZXJhdGlvbjogc3RyaW5nLFxuICAgIHRhYmxlOiBzdHJpbmcsXG4gICAgZHVyYXRpb246IG51bWJlcixcbiAgICByb3dDb3VudD86IG51bWJlcixcbiAgICBjb3JyZWxhdGlvbklkPzogc3RyaW5nLFxuICAgIG1ldGFkYXRhPzogUmVjb3JkPHN0cmluZywgYW55PlxuICApOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMuc2hvdWxkTG9nKExvZ0xldmVsLkRFQlVHKSkgcmV0dXJuO1xuXG4gICAgY29uc3QgZW50cnkgPSB0aGlzLmNyZWF0ZUxvZ0VudHJ5KFxuICAgICAgTG9nTGV2ZWwuREVCVUcsXG4gICAgICBgRGF0YWJhc2UgJHtvcGVyYXRpb259IG9uICR7dGFibGV9YCxcbiAgICAgIGNvcnJlbGF0aW9uSWQsXG4gICAgICAnZGF0YWJhc2Vfb3BlcmF0aW9uJyxcbiAgICAgIGR1cmF0aW9uLFxuICAgICAge1xuICAgICAgICBvcGVyYXRpb24sXG4gICAgICAgIHRhYmxlLFxuICAgICAgICByb3dDb3VudCxcbiAgICAgICAgLi4ubWV0YWRhdGFcbiAgICAgIH1cbiAgICApO1xuXG4gICAgdGhpcy53cml0ZUxvZyhlbnRyeSk7XG4gIH1cblxuICAvKipcbiAgICogTG9nIGNhY2hlIG9wZXJhdGlvblxuICAgKi9cbiAgbG9nQ2FjaGVPcGVyYXRpb24oXG4gICAgb3BlcmF0aW9uOiBzdHJpbmcsXG4gICAga2V5OiBzdHJpbmcsXG4gICAgaGl0OiBib29sZWFuLFxuICAgIGR1cmF0aW9uOiBudW1iZXIsXG4gICAgY29ycmVsYXRpb25JZD86IHN0cmluZyxcbiAgICBtZXRhZGF0YT86IFJlY29yZDxzdHJpbmcsIGFueT5cbiAgKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLnNob3VsZExvZyhMb2dMZXZlbC5ERUJVRykpIHJldHVybjtcblxuICAgIGNvbnN0IGVudHJ5ID0gdGhpcy5jcmVhdGVMb2dFbnRyeShcbiAgICAgIExvZ0xldmVsLkRFQlVHLFxuICAgICAgYENhY2hlICR7b3BlcmF0aW9ufSBmb3IgJHtrZXl9IC0gJHtoaXQgPyAnSElUJyA6ICdNSVNTJ31gLFxuICAgICAgY29ycmVsYXRpb25JZCxcbiAgICAgICdjYWNoZV9vcGVyYXRpb24nLFxuICAgICAgZHVyYXRpb24sXG4gICAgICB7XG4gICAgICAgIG9wZXJhdGlvbixcbiAgICAgICAga2V5LFxuICAgICAgICBoaXQsXG4gICAgICAgIC4uLm1ldGFkYXRhXG4gICAgICB9XG4gICAgKTtcblxuICAgIHRoaXMud3JpdGVMb2coZW50cnkpO1xuICB9XG5cbiAgLyoqXG4gICAqIExvZyBzZWN1cml0eSBldmVudFxuICAgKi9cbiAgbG9nU2VjdXJpdHlFdmVudChcbiAgICBldmVudDogc3RyaW5nLFxuICAgIHNldmVyaXR5OiAnbG93JyB8ICdtZWRpdW0nIHwgJ2hpZ2gnIHwgJ2NyaXRpY2FsJyxcbiAgICBjb3JyZWxhdGlvbklkPzogc3RyaW5nLFxuICAgIG1ldGFkYXRhPzogUmVjb3JkPHN0cmluZywgYW55PlxuICApOiB2b2lkIHtcbiAgICBjb25zdCBsZXZlbCA9IHNldmVyaXR5ID09PSAnY3JpdGljYWwnID8gTG9nTGV2ZWwuRkFUQUwgOiBcbiAgICAgICAgICAgICAgICAgIHNldmVyaXR5ID09PSAnaGlnaCcgPyBMb2dMZXZlbC5FUlJPUiA6XG4gICAgICAgICAgICAgICAgICBzZXZlcml0eSA9PT0gJ21lZGl1bScgPyBMb2dMZXZlbC5XQVJOIDogTG9nTGV2ZWwuSU5GTztcblxuICAgIGlmICghdGhpcy5zaG91bGRMb2cobGV2ZWwpKSByZXR1cm47XG5cbiAgICBjb25zdCBlbnRyeSA9IHRoaXMuY3JlYXRlTG9nRW50cnkoXG4gICAgICBsZXZlbCxcbiAgICAgIGBTZWN1cml0eSBldmVudDogJHtldmVudH1gLFxuICAgICAgY29ycmVsYXRpb25JZCxcbiAgICAgICdzZWN1cml0eV9ldmVudCcsXG4gICAgICB1bmRlZmluZWQsXG4gICAgICB7XG4gICAgICAgIGV2ZW50LFxuICAgICAgICBzZXZlcml0eSxcbiAgICAgICAgLi4ubWV0YWRhdGFcbiAgICAgIH1cbiAgICApO1xuXG4gICAgdGhpcy53cml0ZUxvZyhlbnRyeSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGN1cnJlbnQgY29uZmlndXJhdGlvblxuICAgKi9cbiAgZ2V0Q29uZmlnKCk6IExvZ2dlckNvbmZpZyB7XG4gICAgcmV0dXJuIHsgLi4udGhpcy5jb25maWcgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGUgbG9nIGxldmVsXG4gICAqL1xuICBzZXRMb2dMZXZlbChsZXZlbDogTG9nTGV2ZWwpOiB2b2lkIHtcbiAgICB0aGlzLmNvbmZpZy5sZXZlbCA9IGxldmVsO1xuICAgIHRoaXMuaW5mbyhgTG9nIGxldmVsIGNoYW5nZWQgdG8gJHtMb2dMZXZlbFtsZXZlbF19YCk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGFjdGl2ZSB0aW1lciBjb3VudFxuICAgKi9cbiAgZ2V0QWN0aXZlVGltZXJDb3VudCgpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLmFjdGl2ZVRpbWVycy5zaXplO1xuICB9XG5cbiAgLyoqXG4gICAqIENsZWFyIGFsbCBhY3RpdmUgdGltZXJzICh1c2VmdWwgZm9yIHRlc3RpbmcpXG4gICAqL1xuICBjbGVhclRpbWVycygpOiB2b2lkIHtcbiAgICB0aGlzLmFjdGl2ZVRpbWVycy5jbGVhcigpO1xuICB9XG59Il0sInZlcnNpb24iOjN9
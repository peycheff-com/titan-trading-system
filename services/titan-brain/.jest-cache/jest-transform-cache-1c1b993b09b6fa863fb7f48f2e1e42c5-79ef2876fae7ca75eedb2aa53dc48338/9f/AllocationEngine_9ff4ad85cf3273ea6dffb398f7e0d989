afd41b9f28f6e816fb23ae6e31a09f73
"use strict";
/**
 * AllocationEngine - Calculates base allocation weights for each phase
 * Uses sigmoid transition functions for smooth phase transitions
 *
 * Requirements: 1.2, 1.3, 1.4, 1.5, 1.6, 3.4
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.AllocationEngine = void 0;
const index_js_1 = require("../types/index.js");
/**
 * AllocationEngine calculates capital allocation across Titan phases
 * based on current equity using sigmoid transition functions.
 */
class AllocationEngine {
    transitionPoints;
    leverageCaps;
    constructor(config) {
        this.transitionPoints = config.transitionPoints;
        this.leverageCaps = config.leverageCaps;
    }
    /**
     * Sigmoid function for smooth transitions
     * Returns value between 0 and 1
     * @param x - Input value
     * @param midpoint - Center of transition
     * @param steepness - How sharp the transition is (higher = sharper)
     */
    sigmoid(x, midpoint, steepness = 0.002) {
        return 1 / (1 + Math.exp(-steepness * (x - midpoint)));
    }
    /**
     * Calculate allocation weights for each phase based on current equity
     *
     * Transition logic:
     * - Below $1,500: 100% Phase 1
     * - $1,500 - $5,000: Sigmoid transition from Phase 1 to Phase 2
     * - $5,000 - $25,000: 20% Phase 1, 80% Phase 2
     * - Above $25,000: Begin transition to Phase 3
     *
     * @param equity - Current account equity in USD
     * @returns AllocationVector with weights summing to 1.0
     */
    getWeights(equity) {
        const { startP2, fullP2, startP3 } = this.transitionPoints;
        const timestamp = Date.now();
        // Ensure equity is non-negative
        const safeEquity = Math.max(0, equity);
        // Phase 1 only (MICRO tier)
        if (safeEquity < startP2) {
            return { w1: 1.0, w2: 0.0, w3: 0.0, timestamp };
        }
        // Transition zone: Phase 1 â†’ Phase 2
        if (safeEquity < fullP2) {
            // Sigmoid transition from 100% P1 to 20% P1 / 80% P2
            const transitionMidpoint = (startP2 + fullP2) / 2;
            const progress = this.sigmoid(safeEquity, transitionMidpoint, 0.003);
            // w1 goes from 1.0 to 0.2, w2 goes from 0.0 to 0.8
            const w1 = 1.0 - (0.8 * progress);
            const w2 = 0.8 * progress;
            const w3 = 0.0;
            return this.normalizeWeights({ w1, w2, w3, timestamp });
        }
        // Stable zone: 20% P1, 80% P2 (before P3 transition)
        if (safeEquity < startP3) {
            return { w1: 0.2, w2: 0.8, w3: 0.0, timestamp };
        }
        // Transition to Phase 3 (above $25,000)
        // P3 gradually takes from P2, P1 stays at 20%
        const p3TransitionMidpoint = startP3 + 12500; // $37,500 midpoint
        const p3Progress = this.sigmoid(safeEquity, p3TransitionMidpoint, 0.0002);
        // w3 goes from 0 to 0.5 (max 50% to P3)
        // w2 goes from 0.8 to 0.3
        // w1 stays at 0.2
        const w1 = 0.2;
        const w3 = 0.5 * p3Progress;
        const w2 = 0.8 - w3;
        return this.normalizeWeights({ w1, w2, w3, timestamp });
    }
    /**
     * Normalize weights to ensure they sum to exactly 1.0
     * Handles floating point precision issues
     */
    normalizeWeights(vector) {
        const sum = vector.w1 + vector.w2 + vector.w3;
        if (sum === 0) {
            // Fallback to Phase 1 only if all weights are 0
            return { w1: 1.0, w2: 0.0, w3: 0.0, timestamp: vector.timestamp };
        }
        return {
            w1: vector.w1 / sum,
            w2: vector.w2 / sum,
            w3: vector.w3 / sum,
            timestamp: vector.timestamp,
        };
    }
    /**
     * Determine the equity tier based on current equity
     *
     * Tier boundaries:
     * - MICRO: < $1,500
     * - SMALL: $1,500 - $5,000
     * - MEDIUM: $5,000 - $25,000
     * - LARGE: $25,000 - $50,000
     * - INSTITUTIONAL: > $50,000
     *
     * @param equity - Current account equity in USD
     * @returns EquityTier classification
     */
    getEquityTier(equity) {
        const safeEquity = Math.max(0, equity);
        if (safeEquity < 1500) {
            return index_js_1.EquityTier.MICRO;
        }
        if (safeEquity < 5000) {
            return index_js_1.EquityTier.SMALL;
        }
        if (safeEquity < 25000) {
            return index_js_1.EquityTier.MEDIUM;
        }
        if (safeEquity < 50000) {
            return index_js_1.EquityTier.LARGE;
        }
        return index_js_1.EquityTier.INSTITUTIONAL;
    }
    /**
     * Get maximum allowed leverage for the current equity tier
     *
     * Leverage caps by tier:
     * - MICRO: 20x
     * - SMALL: 10x
     * - MEDIUM: 5x
     * - LARGE: 3x
     * - INSTITUTIONAL: 2x
     *
     * @param equity - Current account equity in USD
     * @returns Maximum leverage multiplier
     */
    getMaxLeverage(equity) {
        const tier = this.getEquityTier(equity);
        return this.leverageCaps[tier];
    }
    /**
     * Get the transition points configuration
     */
    getTransitionPoints() {
        return { ...this.transitionPoints };
    }
    /**
     * Get the leverage caps configuration
     */
    getLeverageCaps() {
        return { ...this.leverageCaps };
    }
}
exports.AllocationEngine = AllocationEngine;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLWJyYWluL3NyYy9lbmdpbmUvQWxsb2NhdGlvbkVuZ2luZS50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7O0dBS0c7OztBQUVILGdEQU0yQjtBQUUzQjs7O0dBR0c7QUFDSCxNQUFhLGdCQUFnQjtJQUNWLGdCQUFnQixDQUFtQjtJQUNuQyxZQUFZLENBQWU7SUFFNUMsWUFBWSxNQUE4QjtRQUN4QyxJQUFJLENBQUMsZ0JBQWdCLEdBQUcsTUFBTSxDQUFDLGdCQUFnQixDQUFDO1FBQ2hELElBQUksQ0FBQyxZQUFZLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQztJQUMxQyxDQUFDO0lBRUQ7Ozs7OztPQU1HO0lBQ0ssT0FBTyxDQUFDLENBQVMsRUFBRSxRQUFnQixFQUFFLFlBQW9CLEtBQUs7UUFDcEUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLFNBQVMsR0FBRyxDQUFDLENBQUMsR0FBRyxRQUFRLENBQUMsQ0FBQyxDQUFDLENBQUM7SUFDekQsQ0FBQztJQUVEOzs7Ozs7Ozs7OztPQVdHO0lBQ0gsVUFBVSxDQUFDLE1BQWM7UUFDdkIsTUFBTSxFQUFFLE9BQU8sRUFBRSxNQUFNLEVBQUUsT0FBTyxFQUFFLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixDQUFDO1FBQzNELE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUU3QixnQ0FBZ0M7UUFDaEMsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsTUFBTSxDQUFDLENBQUM7UUFFdkMsNEJBQTRCO1FBQzVCLElBQUksVUFBVSxHQUFHLE9BQU8sRUFBRSxDQUFDO1lBQ3pCLE9BQU8sRUFBRSxFQUFFLEVBQUUsR0FBRyxFQUFFLEVBQUUsRUFBRSxHQUFHLEVBQUUsRUFBRSxFQUFFLEdBQUcsRUFBRSxTQUFTLEVBQUUsQ0FBQztRQUNsRCxDQUFDO1FBRUQs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UUFDM0IsQ0FBQztRQUNELElBQUksVUFBVSxHQUFHLEtBQUssRUFBRSxDQUFDO1lBQ3ZCLE9BQU8scUJBQVUsQ0FBQyxLQUFLLENBQUM7UUFDMUIsQ0FBQztRQUNELE9BQU8scUJBQVUsQ0FBQyxhQUFhLENBQUM7SUFDbEMsQ0FBQztJQUVEOzs7Ozs7Ozs7Ozs7T0FZRztJQUNILGNBQWMsQ0FBQyxNQUFjO1FBQzNCLE1BQU0sSUFBSSxHQUFHLElBQUksQ0FBQyxhQUFhLENBQUMsTUFBTSxDQUFDLENBQUM7UUFDeEMsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLElBQUksQ0FBQyxDQUFDO0lBQ2pDLENBQUM7SUFFRDs7T0FFRztJQUNILG1CQUFtQjtRQUNqQixPQUFPLEVBQUUsR0FBRyxJQUFJLENBQUMsZ0JBQWdCLEVBQUUsQ0FBQztJQUN0QyxDQUFDO0lBRUQ7O09BRUc7SUFDSCxlQUFlO1FBQ2IsT0FBTyxFQUFFLEdBQUcsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDO0lBQ2xDLENBQUM7Q0FDRjtBQWhLRCw0Q0FnS0MiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLWJyYWluL3NyYy9lbmdpbmUvQWxsb2NhdGlvbkVuZ2luZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEFsbG9jYXRpb25FbmdpbmUgLSBDYWxjdWxhdGVzIGJhc2UgYWxsb2NhdGlvbiB3ZWlnaHRzIGZvciBlYWNoIHBoYXNlXG4gKiBVc2VzIHNpZ21vaWQgdHJhbnNpdGlvbiBmdW5jdGlvbnMgZm9yIHNtb290aCBwaGFzZSB0cmFuc2l0aW9uc1xuICogXG4gKiBSZXF1aXJlbWVudHM6IDEuMiwgMS4zLCAxLjQsIDEuNSwgMS42LCAzLjRcbiAqL1xuXG5pbXBvcnQge1xuICBBbGxvY2F0aW9uVmVjdG9yLFxuICBBbGxvY2F0aW9uRW5naW5lQ29uZmlnLFxuICBFcXVpdHlUaWVyLFxuICBMZXZlcmFnZUNhcHMsXG4gIFRyYW5zaXRpb25Qb2ludHMsXG59IGZyb20gJy4uL3R5cGVzL2luZGV4LmpzJztcblxuLyoqXG4gKiBBbGxvY2F0aW9uRW5naW5lIGNhbGN1bGF0ZXMgY2FwaXRhbCBhbGxvY2F0aW9uIGFjcm9zcyBUaXRhbiBwaGFzZXNcbiAqIGJhc2VkIG9uIGN1cnJlbnQgZXF1aXR5IHVzaW5nIHNpZ21vaWQgdHJhbnNpdGlvbiBmdW5jdGlvbnMuXG4gKi9cbmV4cG9ydCBjbGFzcyBBbGxvY2F0aW9uRW5naW5lIHtcbiAgcHJpdmF0ZSByZWFkb25seSB0cmFuc2l0aW9uUG9pbnRzOiBUcmFuc2l0aW9uUG9pbnRzO1xuICBwcml2YXRlIHJlYWRvbmx5IGxldmVyYWdlQ2FwczogTGV2ZXJhZ2VDYXBzO1xuXG4gIGNvbnN0cnVjdG9yKGNvbmZpZzogQWxsb2NhdGlvbkVuZ2luZUNvbmZpZykge1xuICAgIHRoaXMudHJhbnNpdGlvblBvaW50cyA9IGNvbmZpZy50cmFuc2l0aW9uUG9pbnRzO1xuICAgIHRoaXMubGV2ZXJhZ2VDYXBzID0gY29uZmlnLmxldmVyYWdlQ2FwcztcbiAgfVxuXG4gIC8qKlxuICAgKiBTaWdtb2lkIGZ1bmN0aW9uIGZvciBzbW9vdGggdHJhbnNpdGlvbnNcbiAgICogUmV0dXJucyB2YWx1ZSBiZXR3ZWVuIDAgYW5kIDFcbiAgICogQHBhcmFtIHggLSBJbnB1dCB2YWx1ZVxuICAgKiBAcGFyYW0gbWlkcG9pbnQgLSBDZW50ZXIgb2YgdHJhbnNpdGlvblxuICAgKiBAcGFyYW0gc3RlZXBuZXNzIC0gSG93IHNoYXJwIHRoZSB0cmFuc2l0aW9uIGlzIChoaWdoZXIgPSBzaGFycGVyKVxuICAgKi9cbiAgcHJpdmF0ZSBzaWdtb2lkKHg6IG51bWJlciwgbWlkcG9pbnQ6IG51bWJlciwgc3RlZXBuZXNzOiBudW1iZXIgPSAwLjAwMik6IG51bWJlciB7XG4gICAgcmV0dXJuIDEgLyAoMSArIE1hdGguZXhwKC1zdGVlcG5lc3MgKiAoeCAtIG1pZHBvaW50KSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGN1bGF0ZSBhbGxvY2F0aW9uIHdlaWdodHMgZm9yIGVhY2ggcGhhc2UgYmFzZWQgb24gY3VycmVudCBlcXVpdHlcbiAgICogXG4gICAqIFRyYW5zaXRpb24gbG9naWM6XG4gICAqIC0gQmVsb3cgJDEsNTAwOiAxMDAlIFBoYXNlIDFcbiAgICogLSAkMSw1MDAgLSAkNSwwMDA6IFNpZ21vaWQgdHJhbnNpdGlvbiBmcm9tIFBoYXNlIDEgdG8gUGhhc2UgMlxuICAgKiAtICQ1LDAwMCAtICQyNSwwMDA6IDIwJSBQaGFzZSAxLCA4MCUgUGhhc2UgMlxuICAgKiAtIEFib3ZlICQyNSwwMDA6IEJlZ2luIHRyYW5zaXRpb24gdG8gUGhhc2UgM1xuICAgKiBcbiAgICogQHBhcmFtIGVxdWl0eSAtIEN1cnJlbnQgYWNjb3VudCBlcXVpdHkgaW4gVVNEXG4gICAqIEByZXR1cm5zIEFsbG9jYXRpb25WZWN0b3Igd2l0aCB3ZWlnaHRzIHN1bW1pbmcgdG8gMS4wXG4gICAqL1xuICBnZXRXZWlnaHRzKGVxdWl0eTogbnVtYmVyKTogQWxsb2NhdGlvblZlY3RvciB7XG4gICAgY29uc3QgeyBzdGFydFAyLCBmdWxsUDIsIHN0YXJ0UDMgfSA9IHRoaXMudHJhbnNpdGlvblBvaW50cztcbiAgICBjb25zdCB0aW1lc3RhbXAgPSBEYXRlLm5vdygpO1xuXG4gICAgLy8gRW5zdXJlIGVxdWl0eSBpcyBub24tbmVnYXRpdmVcbiAgICBjb25zdCBzYWZlRXF1aXR5ID0gTWF0aC5tYXgoMCwgZXF1aXR5KTtcblxuICAgIC8vIFBoYXNlIDEgb25seSAoTUlDUk8gdGllcilcbiAgICBpZiAoc2FmZUVxdWl0eSA8IHN0YXJ0UDIpIHtcbiAgICAgIHJldHVybiB7IHcxOiAxLjAsIHcyOiAwLjAsIHczOiAwLjAsIHRpbWVzdGFtcCB9O1xuICAgIH1cblxuICAgIC8vIFRyYW5zaXRpb24gem9uZTogUGhhc2UgMSDihpIgUGhhc2UgMlxuICAgIGlmIChzYWZlRXF1aXR5IDwgZnVsbFAyKSB7XG4gICAgICAvLyBTaWdtb2lkIHRyYW5zaXRpb24gZnJvbSAxMDAlIFAxIHRvIDIwJSBQMSAvIDgwJSBQMlxuICAgICAgY29uc3QgdHJhbnNpdGlvbk1pZHBvaW50ID0gKHN0YXJ0UDIgKyBmdWxsUDIpIC8gMjtcbiAgICAgIGNvbnN0IHByb2dyZXNzID0gdGhpcy5zaWdtb2lkKHNhZmVFcXVpdHksIHRyYW5zaXRpb25NaWRwb2ludCwgMC4wMDMpO1xuICAgICAgXG4gICAgICAvLyB3MSBnb2VzIGZyb20gMS4wIHRvIDAuMiwgdzIgZ29lcyBmcm9tIDAuMCB0byAwLjhcbiAgICAgIGNvbnN0IHcxID0gMS4wIC0gKDAuOCAqIHByb2dyZXNzKTtcbiAgICAgIGNvbnN0IHcyID0gMC44ICogcHJvZ3Jlc3M7XG4gICAgICBjb25zdCB3MyA9IDAuMDtcblxuICAgICAgcmV0dXJuIHRoaXMubm9ybWFsaXplV2VpZ2h0cyh7IHcxLCB3MiwgdzMsIHRpbWVzdGFtcCB9KTtcbiAgICB9XG5cbiAgICAvLyBTdGFibGUgem9uZTogMjAlIFAxLCA4MCUgUDIgKGJlZm9yZSBQMyB0cmFuc2l0aW9uKVxuICAgIGlmIChzYWZlRXF1aXR5IDwgc3RhcnRQMykge1xuICAgICAgcmV0dXJuIHsgdzE6IDAuMiwgdzI6IDAuOCwgdzM6IDAuMCwgdGltZXN0YW1wIH07XG4gICAgfVxuXG4gICAgLy8gVHJhbnNpdGlvbiB0byBQaGFzZSAzIChhYm92ZSAkMjUsMDAwKVxuICAgIC8vIFAzIGdyYWR1YWxseSB0YWtlcyBmcm9tIFAyLCBQMSBzdGF5cyBhdCAyMCVcbiAgICBjb25zdCBwM1RyYW5zaXRpb25NaWRwb2ludCA9IHN0YXJ0UDMgKyAxMjUwMDsgLy8gJDM3LDUwMCBtaWRwb2ludFxuICAgIGNvbnN0IHAzUHJvZ3Jlc3MgPSB0aGlzLnNpZ21vaWQoc2FmZUVxdWl0eSwgcDNUcmFuc2l0aW9uTWlkcG9pbnQsIDAuMDAwMik7XG5cbiAgICAvLyB3MyBnb2VzIGZyb20gMCB0byAwLjUgKG1heCA1MCUgdG8gUDMpXG4gICAgLy8gdzIgZ29lcyBmcm9tIDAuOCB0byAwLjNcbiAgICAvLyB3MSBzdGF5cyBhdCAwLjJcbiAgICBjb25zdCB3MSA9IDAuMjtcbiAgICBjb25zdCB3MyA9IDAuNSAqIHAzUHJvZ3Jlc3M7XG4gICAgY29uc3QgdzIgPSAwLjggLSB3MztcblxuICAgIHJldHVybiB0aGlzLm5vcm1hbGl6ZVdlaWdodHMoeyB3MSwgdzIsIHczLCB0aW1lc3RhbXAgfSk7XG4gIH1cblxuICAvKipcbiAgICogTm9ybWFsaXplIHdlaWdodHMgdG8gZW5zdXJlIHRoZXkgc3VtIHRvIGV4YWN0bHkgMS4wXG4gICAqIEhhbmRsZXMgZmxvYXRpbmcgcG9pbnQgcHJlY2lzaW9uIGlzc3Vlc1xuICAgKi9cbiAgcHJpdmF0ZSBub3JtYWxpemVXZWlnaHRzKHZlY3RvcjogQWxsb2NhdGlvblZlY3Rvcik6IEFsbG9jYXRpb25WZWN0b3Ige1xuICAgIGNvbnN0IHN1bSA9IHZlY3Rvci53MSArIHZlY3Rvci53MiArIHZlY3Rvci53MztcbiAgICBcbiAgICBpZiAoc3VtID09PSAwKSB7XG4gICAgICAvLyBGYWxsYmFjayB0byBQaGFzZSAxIG9ubHkgaWYgYWxsIHdlaWdodHMgYXJlIDBcbiAgICAgIHJldHVybiB7IHcxOiAxLjAsIHcyOiAwLjAsIHczOiAwLjAsIHRpbWVzdGFtcDogdmVjdG9yLnRpbWVzdGFtcCB9O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICB3MTogdmVjdG9yLncxIC8gc3VtLFxuICAgICAgdzI6IHZlY3Rvci53MiAvIHN1bSxcbiAgICAgIHczOiB2ZWN0b3IudzMgLyBzdW0sXG4gICAgICB0aW1lc3RhbXA6IHZlY3Rvci50aW1lc3RhbXAsXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZXRlcm1pbmUgdGhlIGVxdWl0eSB0aWVyIGJhc2VkIG9uIGN1cnJlbnQgZXF1aXR5XG4gICAqIFxuICAgKiBUaWVyIGJvdW5kYXJpZXM6XG4gICAqIC0gTUlDUk86IDwgJDEsNTAwXG4gICAqIC0gU01BTEw6ICQxLDUwMCAtICQ1LDAwMFxuICAgKiAtIE1FRElVTTogJDUsMDAwIC0gJDI1LDAwMFxuICAgKiAtIExBUkdFOiAkMjUsMDAwIC0gJDUwLDAwMFxuICAgKiAtIElOU1RJVFVUSU9OQUw6ID4gJDUwLDAwMFxuICAgKiBcbiAgICogQHBhcmFtIGVxdWl0eSAtIEN1cnJlbnQgYWNjb3VudCBlcXVpdHkgaW4gVVNEXG4gICAqIEByZXR1cm5zIEVxdWl0eVRpZXIgY2xhc3NpZmljYXRpb25cbiAgICovXG4gIGdldEVxdWl0eVRpZXIoZXF1aXR5OiBudW1iZXIpOiBFcXVpdHlUaWVyIHtcbiAgICBjb25zdCBzYWZlRXF1aXR5ID0gTWF0aC5tYXgoMCwgZXF1aXR5KTtcblxuICAgIGlmIChzYWZlRXF1aXR5IDwgMTUwMCkge1xuICAgICAgcmV0dXJuIEVxdWl0eVRpZXIuTUlDUk87XG4gICAgfVxuICAgIGlmIChzYWZlRXF1aXR5IDwgNTAwMCkge1xuICAgICAgcmV0dXJuIEVxdWl0eVRpZXIuU01BTEw7XG4gICAgfVxuICAgIGlmIChzYWZlRXF1aXR5IDwgMjUwMDApIHtcbiAgICAgIHJldHVybiBFcXVpdHlUaWVyLk1FRElVTTtcbiAgICB9XG4gICAgaWYgKHNhZmVFcXVpdHkgPCA1MDAwMCkge1xuICAgICAgcmV0dXJuIEVxdWl0eVRpZXIuTEFSR0U7XG4gICAgfVxuICAgIHJldHVybiBFcXVpdHlUaWVyLklOU1RJVFVUSU9OQUw7XG4gIH1cblxuICAvKipcbiAgICogR2V0IG1heGltdW0gYWxsb3dlZCBsZXZlcmFnZSBmb3IgdGhlIGN1cnJlbnQgZXF1aXR5IHRpZXJcbiAgICogXG4gICAqIExldmVyYWdlIGNhcHMgYnkgdGllcjpcbiAgICogLSBNSUNSTzogMjB4XG4gICAqIC0gU01BTEw6IDEweFxuICAgKiAtIE1FRElVTTogNXhcbiAgICogLSBMQVJHRTogM3hcbiAgICogLSBJTlNUSVRVVElPTkFMOiAyeFxuICAgKiBcbiAgICogQHBhcmFtIGVxdWl0eSAtIEN1cnJlbnQgYWNjb3VudCBlcXVpdHkgaW4gVVNEXG4gICAqIEByZXR1cm5zIE1heGltdW0gbGV2ZXJhZ2UgbXVsdGlwbGllclxuICAgKi9cbiAgZ2V0TWF4TGV2ZXJhZ2UoZXF1aXR5OiBudW1iZXIpOiBudW1iZXIge1xuICAgIGNvbnN0IHRpZXIgPSB0aGlzLmdldEVxdWl0eVRpZXIoZXF1aXR5KTtcbiAgICByZXR1cm4gdGhpcy5sZXZlcmFnZUNhcHNbdGllcl07XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSB0cmFuc2l0aW9uIHBvaW50cyBjb25maWd1cmF0aW9uXG4gICAqL1xuICBnZXRUcmFuc2l0aW9uUG9pbnRzKCk6IFRyYW5zaXRpb25Qb2ludHMge1xuICAgIHJldHVybiB7IC4uLnRoaXMudHJhbnNpdGlvblBvaW50cyB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCB0aGUgbGV2ZXJhZ2UgY2FwcyBjb25maWd1cmF0aW9uXG4gICAqL1xuICBnZXRMZXZlcmFnZUNhcHMoKTogTGV2ZXJhZ2VDYXBzIHtcbiAgICByZXR1cm4geyAuLi50aGlzLmxldmVyYWdlQ2FwcyB9O1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=
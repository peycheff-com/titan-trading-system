{"file":"/Users/ivan/Code/trading/titan/services/titan-brain/tests/unit/RiskGuardian.test.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-brain/tests/unit/RiskGuardian.test.ts"],"sourcesContent":["/**\n * Unit Tests for RiskGuardian\n * \n * Tests leverage calculation, correlation calculation, Phase 3 hedge auto-approval,\n * and high correlation size reduction.\n * Requirements: 3.1, 3.2, 3.3, 3.5, 3.6, 3.7\n */\n\nimport { RiskGuardian } from '../../src/engine/RiskGuardian.js';\nimport { AllocationEngine } from '../../src/engine/AllocationEngine.js';\nimport { IntentSignal, Position, RiskGuardianConfig } from '../../src/types/index.js';\nimport { defaultConfig } from '../../src/config/defaults.js';\n\ndescribe('RiskGuardian', () => {\n  let riskGuardian: RiskGuardian;\n  let allocationEngine: AllocationEngine;\n\n  const defaultRiskConfig: RiskGuardianConfig = {\n    maxCorrelation: 0.8,\n    correlationPenalty: 0.5,\n    betaUpdateInterval: 300000,\n    correlationUpdateInterval: 300000,\n  };\n\n  beforeEach(() => {\n    allocationEngine = new AllocationEngine(defaultConfig.allocationEngine);\n    riskGuardian = new RiskGuardian(defaultRiskConfig, allocationEngine);\n    riskGuardian.setEquity(10000); // Default equity for tests\n  });\n\n  describe('constructor', () => {\n    it('should initialize with provided configuration', () => {\n      const config = riskGuardian.getConfig();\n      expect(config.maxCorrelation).toBe(0.8);\n      expect(config.correlationPenalty).toBe(0.5);\n      expect(config.betaUpdateInterval).toBe(300000);\n    });\n  });\n\n  describe('setEquity / getEquity', () => {\n    it('should set and get equity correctly', () => {\n      riskGuardian.setEquity(5000);\n      expect(riskGuardian.getEquity()).toBe(5000);\n    });\n\n    it('should handle negative equity as 0', () => {\n      riskGuardian.setEquity(-1000);\n      expect(riskGuardian.getEquity()).toBe(0);\n    });\n  });\n\n  describe('calculatePortfolioDelta', () => {\n    it('should return 0 for empty positions', () => {\n      const delta = riskGuardian.calculatePortfolioDelta([]);\n      expect(delta).toBe(0);\n    });\n\n    it('should return positive delta for long positions', () => {\n      const positions: Position[] = [\n        { symbol: 'BTCUSDT', side: 'LONG', size: 1000, entryPrice: 50000, unrealizedPnL: 0, leverage: 10, phaseId: 'phase1' },\n        { symbol: 'ETHUSDT', side: 'LONG', size: 500, entryPrice: 3000, unrealizedPnL: 0, leverage: 10, phaseId: 'phase1' },\n      ];\n      const delta = riskGuardian.calculatePortfolioDelta(positions);\n      expect(delta).toBe(1500);\n    });\n\n    it('should return negative delta for short positions', () => {\n      const positions: Position[] = [\n        { symbol: 'BTCUSDT', side: 'SHORT', size: 1000, entryPrice: 50000, unrealizedPnL: 0, leverage: 10, phaseId: 'phase1' },\n      ];\n      const delta = riskGuardian.calculatePortfolioDelta(positions);\n      expect(delta).toBe(-1000);\n    });\n\n    it('should calculate net delta for mixed positions', () => {\n      const positions: Position[] = [\n        { symbol: 'BTCUSDT', side: 'LONG', size: 1000, entryPrice: 50000, unrealizedPnL: 0, leverage: 10, phaseId: 'phase1' },\n        { symbol: 'ETHUSDT', side: 'SHORT', size: 600, entryPrice: 3000, unrealizedPnL: 0, leverage: 10, phaseId: 'phase2' },\n      ];\n      const delta = riskGuardian.calculatePortfolioDelta(positions);\n      expect(delta).toBe(400); // 1000 - 600\n    });\n  });\n\n  describe('calculateCombinedLeverage', () => {\n    it('should return 0 for empty positions', () => {\n      const leverage = riskGuardian.calculateCombinedLeverage([]);\n      expect(leverage).toBe(0);\n    });\n\n    it('should return 0 when equity is 0', () => {\n      riskGuardian.setEquity(0);\n      const positions: Position[] = [\n        { symbol: 'BTCUSDT', side: 'LONG', size: 1000, entryPrice: 50000, unrealizedPnL: 0, leverage: 10, phaseId: 'phase1' },\n      ];\n      const leverage = riskGuardian.calculateCombinedLeverage(positions);\n      expect(leverage).toBe(0);\n    });\n\n    it('should calculate leverage correctly', () => {\n      riskGuardian.setEquity(10000);\n      const positions: Position[] = [\n        { symbol: 'BTCUSDT', side: 'LONG', size: 20000, entryPrice: 50000, unrealizedPnL: 0, leverage: 10, phaseId: 'phase1' },\n        { symbol: 'ETHUSDT', side: 'SHORT', size: 10000, entryPrice: 3000, unrealizedPnL: 0, leverage: 5, phaseId: 'phase2' },\n      ];\n      const leverage = riskGuardian.calculateCombinedLeverage(positions);\n      expect(leverage).toBe(3); // (20000 + 10000) / 10000\n    });\n  });\n\n  describe('calculateCorrelation', () => {\n    beforeEach(() => {\n      // Add price history for correlation calculation\n      const btcPrices = [50000, 50100, 50200, 50150, 50300, 50250, 50400, 50350, 50500, 50450];\n      const ethPrices = [3000, 3010, 3020, 3015, 3030, 3025, 3040, 3035, 3050, 3045];\n      \n      btcPrices.forEach((price, i) => {\n        riskGuardian.updatePriceHistory('BTCUSDT', price, Date.now() - (10 - i) * 60000);\n      });\n      \n      ethPrices.forEach((price, i) => {\n        riskGuardian.updatePriceHistory('ETHUSDT', price, Date.now() - (10 - i) * 60000);\n      });\n    });\n\n    it('should return 0.5 for assets with no price history', () => {\n      const correlation = riskGuardian.calculateCorrelation('UNKNOWN1', 'UNKNOWN2');\n      expect(correlation).toBe(0.5);\n    });\n\n    it('should calculate positive correlation for correlated assets', () => {\n      const correlation = riskGuardian.calculateCorrelation('BTCUSDT', 'ETHUSDT');\n      expect(correlation).toBeGreaterThan(0);\n    });\n\n    it('should cache correlation results', () => {\n      const correlation1 = riskGuardian.calculateCorrelation('BTCUSDT', 'ETHUSDT');\n      const correlation2 = riskGuardian.calculateCorrelation('BTCUSDT', 'ETHUSDT');\n      expect(correlation1).toBe(correlation2);\n    });\n\n    it('should return same correlation regardless of asset order', () => {\n      const correlation1 = riskGuardian.calculateCorrelation('BTCUSDT', 'ETHUSDT');\n      riskGuardian.clearCorrelationCache();\n      const correlation2 = riskGuardian.calculateCorrelation('ETHUSDT', 'BTCUSDT');\n      expect(correlation1).toBeCloseTo(correlation2, 10);\n    });\n  });\n\n  describe('getPortfolioBeta', () => {\n    it('should return 0 for empty positions', () => {\n      const beta = riskGuardian.getPortfolioBeta([]);\n      expect(beta).toBe(0);\n    });\n\n    it('should calculate weighted beta for positions', () => {\n      // Add BTC price history\n      for (let i = 0; i < 10; i++) {\n        riskGuardian.updatePriceHistory('BTCUSDT', 50000 + i * 100, Date.now() - (10 - i) * 60000);\n        riskGuardian.updatePriceHistory('ETHUSDT', 3000 + i * 10, Date.now() - (10 - i) * 60000);\n      }\n\n      const positions: Position[] = [\n        { symbol: 'ETHUSDT', side: 'LONG', size: 1000, entryPrice: 3000, unrealizedPnL: 0, leverage: 10, phaseId: 'phase1' },\n      ];\n      \n      const beta = riskGuardian.getPortfolioBeta(positions);\n      expect(typeof beta).toBe('number');\n    });\n\n    it('should cache portfolio beta', () => {\n      const positions: Position[] = [\n        { symbol: 'BTCUSDT', side: 'LONG', size: 1000, entryPrice: 50000, unrealizedPnL: 0, leverage: 10, phaseId: 'phase1' },\n      ];\n      \n      const beta1 = riskGuardian.getPortfolioBeta(positions);\n      const beta2 = riskGuardian.getPortfolioBeta(positions);\n      expect(beta1).toBe(beta2);\n    });\n  });\n\n  describe('checkSignal', () => {\n    describe('leverage cap enforcement', () => {\n      it('should approve signal within leverage limits', () => {\n        riskGuardian.setEquity(10000); // MEDIUM tier, 5x max leverage\n        \n        const signal: IntentSignal = {\n          signalId: 'test-1',\n          phaseId: 'phase1',\n          symbol: 'BTCUSDT',\n          side: 'BUY',\n          requestedSize: 20000, // 2x leverage\n          timestamp: Date.now(),\n        };\n\n        const decision = riskGuardian.checkSignal(signal, []);\n        expect(decision.approved).toBe(true);\n        expect(decision.adjustedSize).toBe(20000);\n      });\n\n      it('should veto signal exceeding leverage cap', () => {\n        riskGuardian.setEquity(10000); // MEDIUM tier, 5x max leverage\n        \n        const signal: IntentSignal = {\n          signalId: 'test-2',\n          phaseId: 'phase1',\n          symbol: 'BTCUSDT',\n          side: 'BUY',\n          requestedSize: 60000, // 6x leverage\n          timestamp: Date.now(),\n        };\n\n        const decision = riskGuardian.checkSignal(signal, []);\n        expect(decision.approved).toBe(false);\n        expect(decision.reason).toContain('Leverage cap exceeded');\n      });\n\n      it('should consider existing positions in leverage calculation', () => {\n        riskGuardian.setEquity(10000); // MEDIUM tier, 5x max leverage\n        \n        const existingPositions: Position[] = [\n          { symbol: 'ETHUSDT', side: 'LONG', size: 30000, entryPrice: 3000, unrealizedPnL: 0, leverage: 10, phaseId: 'phase1' },\n        ];\n\n        const signal: IntentSignal = {\n          signalId: 'test-3',\n          phaseId: 'phase1',\n          symbol: 'BTCUSDT',\n          side: 'BUY',\n          requestedSize: 25000, // Would bring total to 5.5x\n          timestamp: Date.now(),\n        };\n\n        const decision = riskGuardian.checkSignal(signal, existingPositions);\n        expect(decision.approved).toBe(false);\n        expect(decision.reason).toContain('Leverage cap exceeded');\n      });\n    });\n\n    describe('Phase 3 hedge auto-approval', () => {\n      it('should auto-approve Phase 3 hedge that reduces delta', () => {\n        riskGuardian.setEquity(50000); // INSTITUTIONAL tier, 2x max leverage\n        \n        const existingPositions: Position[] = [\n          { symbol: 'BTCUSDT', side: 'LONG', size: 100000, entryPrice: 50000, unrealizedPnL: 0, leverage: 2, phaseId: 'phase1' },\n        ];\n\n        // Phase 3 short to reduce delta\n        const signal: IntentSignal = {\n          signalId: 'test-4',\n          phaseId: 'phase3',\n          symbol: 'BTCUSDT',\n          side: 'SELL',\n          requestedSize: 50000, // Reduces delta from 100k to 50k\n          timestamp: Date.now(),\n        };\n\n        const decision = riskGuardian.checkSignal(signal, existingPositions);\n        expect(decision.approved).toBe(true);\n        expect(decision.reason).toContain('Phase 3 hedge approved');\n      });\n\n      it('should not auto-approve Phase 3 signal that increases delta', () => {\n        riskGuardian.setEquity(50000);\n        \n        const existingPositions: Position[] = [\n          { symbol: 'BTCUSDT', side: 'LONG', size: 50000, entryPrice: 50000, unrealizedPnL: 0, leverage: 1, phaseId: 'phase1' },\n        ];\n\n        // Phase 3 long would increase delta\n        const signal: IntentSignal = {\n          signalId: 'test-5',\n          phaseId: 'phase3',\n          symbol: 'BTCUSDT',\n          side: 'BUY',\n          requestedSize: 50000,\n          timestamp: Date.now(),\n        };\n\n        const decision = riskGuardian.checkSignal(signal, existingPositions);\n        // Should go through normal validation, not auto-approve\n        expect(decision.reason).not.toContain('Phase 3 hedge approved');\n      });\n\n      it('should not auto-approve non-Phase 3 signals', () => {\n        riskGuardian.setEquity(50000);\n        \n        const existingPositions: Position[] = [\n          { symbol: 'BTCUSDT', side: 'LONG', size: 50000, entryPrice: 50000, unrealizedPnL: 0, leverage: 1, phaseId: 'phase1' },\n        ];\n\n        const signal: IntentSignal = {\n          signalId: 'test-6',\n          phaseId: 'phase1', // Not Phase 3\n          symbol: 'BTCUSDT',\n          side: 'SELL',\n          requestedSize: 25000,\n          timestamp: Date.now(),\n        };\n\n        const decision = riskGuardian.checkSignal(signal, existingPositions);\n        expect(decision.reason).not.toContain('Phase 3 hedge approved');\n      });\n    });\n\n    describe('high correlation size reduction', () => {\n      beforeEach(() => {\n        // Set up highly correlated price history\n        for (let i = 0; i < 20; i++) {\n          const btcPrice = 50000 + i * 100;\n          const ethPrice = 3000 + i * 6; // Highly correlated movement\n          riskGuardian.updatePriceHistory('BTCUSDT', btcPrice, Date.now() - (20 - i) * 60000);\n          riskGuardian.updatePriceHistory('ETHUSDT', ethPrice, Date.now() - (20 - i) * 60000);\n        }\n      });\n\n      it('should reduce size for high correlation same direction', () => {\n        riskGuardian.setEquity(10000);\n        \n        const existingPositions: Position[] = [\n          { symbol: 'BTCUSDT', side: 'LONG', size: 10000, entryPrice: 50000, unrealizedPnL: 0, leverage: 1, phaseId: 'phase1' },\n        ];\n\n        // Same symbol, same direction = correlation 1.0\n        const signal: IntentSignal = {\n          signalId: 'test-7',\n          phaseId: 'phase1',\n          symbol: 'BTCUSDT',\n          side: 'BUY',\n          requestedSize: 10000,\n          timestamp: Date.now(),\n        };\n\n        const decision = riskGuardian.checkSignal(signal, existingPositions);\n        expect(decision.approved).toBe(true);\n        expect(decision.adjustedSize).toBe(5000); // 50% reduction\n        expect(decision.reason).toContain('High correlation');\n      });\n\n      it('should not reduce size for opposite direction', () => {\n        riskGuardian.setEquity(10000);\n        \n        const existingPositions: Position[] = [\n          { symbol: 'BTCUSDT', side: 'LONG', size: 10000, entryPrice: 50000, unrealizedPnL: 0, leverage: 1, phaseId: 'phase1' },\n        ];\n\n        // Same symbol, opposite direction\n        const signal: IntentSignal = {\n          signalId: 'test-8',\n          phaseId: 'phase1',\n          symbol: 'BTCUSDT',\n          side: 'SELL',\n          requestedSize: 5000,\n          timestamp: Date.now(),\n        };\n\n        const decision = riskGuardian.checkSignal(signal, existingPositions);\n        expect(decision.approved).toBe(true);\n        // Should not have size reduction for opposite direction\n        expect(decision.adjustedSize).toBe(5000);\n      });\n    });\n\n    describe('risk metrics in decision', () => {\n      it('should include all risk metrics in decision', () => {\n        riskGuardian.setEquity(10000);\n        \n        const positions: Position[] = [\n          { symbol: 'BTCUSDT', side: 'LONG', size: 10000, entryPrice: 50000, unrealizedPnL: 100, leverage: 1, phaseId: 'phase1' },\n        ];\n\n        const signal: IntentSignal = {\n          signalId: 'test-9',\n          phaseId: 'phase1',\n          symbol: 'ETHUSDT',\n          side: 'BUY',\n          requestedSize: 5000,\n          timestamp: Date.now(),\n        };\n\n        const decision = riskGuardian.checkSignal(signal, positions);\n        \n        expect(decision.riskMetrics).toBeDefined();\n        expect(typeof decision.riskMetrics.currentLeverage).toBe('number');\n        expect(typeof decision.riskMetrics.projectedLeverage).toBe('number');\n        expect(typeof decision.riskMetrics.correlation).toBe('number');\n        expect(typeof decision.riskMetrics.portfolioDelta).toBe('number');\n        expect(typeof decision.riskMetrics.portfolioBeta).toBe('number');\n      });\n    });\n  });\n\n  describe('getRiskMetrics', () => {\n    it('should return current risk metrics snapshot', () => {\n      riskGuardian.setEquity(10000);\n      \n      const positions: Position[] = [\n        { symbol: 'BTCUSDT', side: 'LONG', size: 20000, entryPrice: 50000, unrealizedPnL: 0, leverage: 2, phaseId: 'phase1' },\n        { symbol: 'ETHUSDT', side: 'SHORT', size: 10000, entryPrice: 3000, unrealizedPnL: 0, leverage: 1, phaseId: 'phase2' },\n      ];\n\n      const metrics = riskGuardian.getRiskMetrics(positions);\n      \n      expect(metrics.currentLeverage).toBe(3); // (20000 + 10000) / 10000\n      expect(metrics.portfolioDelta).toBe(10000); // 20000 - 10000\n      expect(typeof metrics.portfolioBeta).toBe('number');\n      expect(typeof metrics.correlation).toBe('number');\n    });\n  });\n\n  describe('updatePriceHistory', () => {\n    it('should add price entries', () => {\n      riskGuardian.updatePriceHistory('BTCUSDT', 50000);\n      riskGuardian.updatePriceHistory('BTCUSDT', 50100);\n      \n      // Verify by checking correlation calculation works\n      riskGuardian.updatePriceHistory('ETHUSDT', 3000);\n      riskGuardian.updatePriceHistory('ETHUSDT', 3010);\n      \n      const correlation = riskGuardian.calculateCorrelation('BTCUSDT', 'ETHUSDT');\n      expect(typeof correlation).toBe('number');\n    });\n\n    it('should use provided timestamp', () => {\n      const timestamp = Date.now() - 60000;\n      riskGuardian.updatePriceHistory('BTCUSDT', 50000, timestamp);\n      // No error means success\n    });\n  });\n\n  describe('clearCorrelationCache', () => {\n    it('should clear cached correlations', () => {\n      // Add price history\n      for (let i = 0; i < 10; i++) {\n        riskGuardian.updatePriceHistory('BTCUSDT', 50000 + i * 100, Date.now() - (10 - i) * 60000);\n        riskGuardian.updatePriceHistory('ETHUSDT', 3000 + i * 10, Date.now() - (10 - i) * 60000);\n      }\n\n      // Calculate and cache\n      const correlation1 = riskGuardian.calculateCorrelation('BTCUSDT', 'ETHUSDT');\n      \n      // Clear cache\n      riskGuardian.clearCorrelationCache();\n      \n      // Should recalculate\n      const correlation2 = riskGuardian.calculateCorrelation('BTCUSDT', 'ETHUSDT');\n      \n      // Values should be the same (same data)\n      expect(correlation1).toBeCloseTo(correlation2, 10);\n    });\n  });\n\n  describe('edge cases', () => {\n    it('should handle signal for same symbol reducing position', () => {\n      riskGuardian.setEquity(10000);\n      \n      const existingPositions: Position[] = [\n        { symbol: 'BTCUSDT', side: 'LONG', size: 20000, entryPrice: 50000, unrealizedPnL: 0, leverage: 2, phaseId: 'phase1' },\n      ];\n\n      // Sell signal to reduce long position\n      const signal: IntentSignal = {\n        signalId: 'test-10',\n        phaseId: 'phase1',\n        symbol: 'BTCUSDT',\n        side: 'SELL',\n        requestedSize: 10000,\n        timestamp: Date.now(),\n      };\n\n      const decision = riskGuardian.checkSignal(signal, existingPositions);\n      expect(decision.approved).toBe(true);\n      // Projected leverage should be lower\n      expect(decision.riskMetrics.projectedLeverage).toBeLessThan(decision.riskMetrics.currentLeverage);\n    });\n\n    it('should handle zero equity gracefully', () => {\n      riskGuardian.setEquity(0);\n      \n      const signal: IntentSignal = {\n        signalId: 'test-11',\n        phaseId: 'phase1',\n        symbol: 'BTCUSDT',\n        side: 'BUY',\n        requestedSize: 1000,\n        timestamp: Date.now(),\n      };\n\n      const decision = riskGuardian.checkSignal(signal, []);\n      expect(decision.riskMetrics.currentLeverage).toBe(0);\n      expect(decision.riskMetrics.projectedLeverage).toBe(0);\n    });\n  });\n});\n"],"version":3}
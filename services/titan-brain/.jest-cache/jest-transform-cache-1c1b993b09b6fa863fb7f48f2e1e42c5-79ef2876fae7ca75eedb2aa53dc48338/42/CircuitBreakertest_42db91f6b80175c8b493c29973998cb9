038bd2b13c7d68a4b6e1a164e91d27f2
"use strict";
/**
 * Unit tests for CircuitBreaker
 */
Object.defineProperty(exports, "__esModule", { value: true });
const CircuitBreaker_1 = require("../../src/services/CircuitBreaker");
describe('CircuitBreaker', () => {
    let circuitBreaker;
    beforeEach(() => {
        // Use a configuration that won't open immediately on single failure
        const config = {
            failureThreshold: 5,
            successThreshold: 3,
            timeout: 60000,
            monitoringWindow: 300000,
            expectedFailureRate: 1.0 // 100% failure rate threshold (never open based on rate alone)
        };
        circuitBreaker = new CircuitBreaker_1.CircuitBreaker('test-service', config);
    });
    describe('constructor', () => {
        it('should initialize with correct name and config', () => {
            expect(circuitBreaker.getName()).toBe('test-service');
            expect(circuitBreaker.getStats().state).toBe(CircuitBreaker_1.CircuitBreakerState.CLOSED);
        });
    });
    describe('execute - CLOSED state', () => {
        it('should execute function successfully when circuit is closed', async () => {
            const mockFn = jest.fn().mockResolvedValue('success');
            const result = await circuitBreaker.execute(mockFn);
            expect(result).toBe('success');
            expect(mockFn).toHaveBeenCalledTimes(1);
            expect(circuitBreaker.getStats().state).toBe(CircuitBreaker_1.CircuitBreakerState.CLOSED);
        });
        it('should handle function failure and increment failure count', async () => {
            const mockFn = jest.fn().mockRejectedValue(new Error('test error'));
            await expect(circuitBreaker.execute(mockFn)).rejects.toThrow('test error');
            const stats = circuitBreaker.getStats();
            expect(stats.failedRequests).toBe(1);
            expect(stats.totalRequests).toBe(1);
            // Note: failureCount might be 0 if circuit opened due to failure rate
            expect(stats.state).toBe(CircuitBreaker_1.CircuitBreakerState.CLOSED);
        });
        it('should open circuit after reaching failure threshold', async () => {
            const mockFn = jest.fn().mockRejectedValue(new Error('test error'));
            const config = CircuitBreaker_1.CircuitBreakerDefaults.IMPORTANT;
            // Execute failures up to threshold
            for (let i = 0; i < config.failureThreshold; i++) {
                try {
                    await circuitBreaker.execute(mockFn);
                }
                catch (error) {
                    // Expected to fail
                }
            }
            expect(circuitBreaker.getStats().state).toBe(CircuitBreaker_1.CircuitBreakerState.OPEN);
        });
    });
    describe('execute - OPEN state', () => {
        beforeEach(async () => {
            // Force circuit to open
            circuitBreaker.forceOpen();
        });
        it('should reject requests immediately when circuit is open', async () => {
            const mockFn = jest.fn().mockResolvedValue('success');
            await expect(circuitBreaker.execute(mockFn)).rejects.toThrow(CircuitBreaker_1.CircuitBreakerError);
            expect(mockFn).not.toHaveBeenCalled();
            expect(circuitBreaker.getStats().state).toBe(CircuitBreaker_1.CircuitBreakerState.OPEN);
        });
        it('should transition to HALF_OPEN after timeout', async () => {
            const config = { ...CircuitBreaker_1.CircuitBreakerDefaults.IMPORTANT, timeout: 100 };
            const cb = new CircuitBreaker_1.CircuitBreaker('test', config);
            cb.forceOpen();
            // Wait for timeout
            await new Promise(resolve => setTimeout(resolve, 150));
            const mockFn = jest.fn().mockResolvedValue('success');
            await cb.execute(mockFn);
            expect(cb.getStats().state).toBe(CircuitBreaker_1.CircuitBreakerState.HALF_OPEN);
        });
    });
    describe('execute - HALF_OPEN state', () => {
        beforeEach(() => {
            circuitBreaker.forceOpen();
            // Manually set to half-open for testing
            circuitBreaker.state = CircuitBreaker_1.CircuitBreakerState.HALF_OPEN;
            circuitBreaker.successCount = 0;
        });
        it('should close circuit after success threshold in half-open state', async () => {
            const mockFn = jest.fn().mockResolvedValue('success');
            const config = CircuitBreaker_1.CircuitBreakerDefaults.IMPORTANT;
            // Execute successful requests up to success threshold
            for (let i = 0; i < config.successThreshold; i++) {
                await circuitBreaker.execute(mockFn);
            }
            expect(circuitBreaker.getStats().state).toBe(CircuitBreaker_1.CircuitBreakerState.CLOSED);
        });
        it('should open circuit on failure in half-open state', async () => {
            const mockFn = jest.fn().mockRejectedValue(new Error('test error'));
            try {
                await circuitBreaker.execute(mockFn);
            }
            catch (error) {
                // Expected to fail
            }
            expect(circuitBreaker.getStats().state).toBe(CircuitBreaker_1.CircuitBreakerState.OPEN);
        });
    });
    describe('failure rate monitoring', () => {
        it('should track failure rate within monitoring window', async () => {
            const config = {
                failureThreshold: 100, // High threshold to prevent opening due to count
                successThreshold: 3,
                timeout: 60000,
                monitoringWindow: 1000,
                expectedFailureRate: 1.0 // 100% failure rate threshold (won't trigger)
            };
            const cb = new CircuitBreaker_1.CircuitBreaker('test', config);
            // Execute mixed success/failure requests
            const successFn = jest.fn().mockResolvedValue('success');
            const failureFn = jest.fn().mockRejectedValue(new Error('failure'));
            await cb.execute(successFn);
            try {
                await cb.execute(failureFn);
            }
            catch (e) { }
            await cb.execute(successFn);
            try {
                await cb.execute(failureFn);
            }
            catch (e) { }
            try {
                await cb.execute(failureFn);
            }
            catch (e) { }
            const failureRate = cb.getCurrentFailureRate();
            expect(failureRate).toBe(0.6); // 3 failures out of 5 requests
            expect(cb.getStats().state).toBe(CircuitBreaker_1.CircuitBreakerState.CLOSED);
        });
        it('should open circuit when failure rate exceeds threshold', async () => {
            const config = {
                ...CircuitBreaker_1.CircuitBreakerDefaults.IMPORTANT,
                failureThreshold: 10, // High threshold
                expectedFailureRate: 0.5, // 50% failure rate threshold
                monitoringWindow: 1000
            };
            const cb = new CircuitBreaker_1.CircuitBreaker('test', config);
            const failureFn = jest.fn().mockRejectedValue(new Error('failure'));
            // Execute enough failures to exceed rate threshold
            for (let i = 0; i < 6; i++) {
                try {
                    await cb.execute(failureFn);
                }
                catch (error) {
                    // Expected to fail
                }
            }
            expect(cb.getStats().state).toBe(CircuitBreaker_1.CircuitBreakerState.OPEN);
        });
    });
    describe('statistics', () => {
        it('should track request statistics correctly', async () => {
            const successFn = jest.fn().mockResolvedValue('success');
            const failureFn = jest.fn().mockRejectedValue(new Error('failure'));
            await circuitBreaker.execute(successFn);
            await circuitBreaker.execute(successFn);
            try {
                await circuitBreaker.execute(failureFn);
            }
            catch (e) { }
            const stats = circuitBreaker.getStats();
            expect(stats.totalRequests).toBe(3);
            expect(stats.failedRequests).toBe(1);
            expect(stats.lastSuccessTime).toBeTruthy();
            expect(stats.lastFailureTime).toBeTruthy();
        });
    });
    describe('manual control', () => {
        it('should allow forcing circuit open', () => {
            circuitBreaker.forceOpen();
            expect(circuitBreaker.getStats().state).toBe(CircuitBreaker_1.CircuitBreakerState.OPEN);
        });
        it('should allow forcing circuit closed', () => {
            circuitBreaker.forceOpen();
            circuitBreaker.forceClose();
            expect(circuitBreaker.getStats().state).toBe(CircuitBreaker_1.CircuitBreakerState.CLOSED);
        });
    });
    describe('error handling', () => {
        it('should throw CircuitBreakerError when circuit is open', async () => {
            circuitBreaker.forceOpen();
            const mockFn = jest.fn();
            await expect(circuitBreaker.execute(mockFn)).rejects.toThrow(CircuitBreaker_1.CircuitBreakerError);
            await expect(circuitBreaker.execute(mockFn)).rejects.toThrow(/Circuit breaker 'test-service' is OPEN/);
        });
    });
});
describe('CircuitBreakerDefaults', () => {
    it('should provide different configurations for different service types', () => {
        expect(CircuitBreaker_1.CircuitBreakerDefaults.CRITICAL.failureThreshold).toBeLessThan(CircuitBreaker_1.CircuitBreakerDefaults.IMPORTANT.failureThreshold);
        expect(CircuitBreaker_1.CircuitBreakerDefaults.IMPORTANT.failureThreshold).toBeLessThan(CircuitBreaker_1.CircuitBreakerDefaults.OPTIONAL.failureThreshold);
        expect(CircuitBreaker_1.CircuitBreakerDefaults.CRITICAL.timeout).toBeGreaterThan(CircuitBreaker_1.CircuitBreakerDefaults.OPTIONAL.timeout);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLWJyYWluL3Rlc3RzL3NlcnZpY2VzL0NpcmN1aXRCcmVha2VyLnRlc3QudHMiLCJtYXBwaW5ncyI6IjtBQUFBOztHQUVHOztBQUVILHNFQUFxSTtBQUVySSxRQUFRLENBQUMsZ0JBQWdCLEVBQUUsR0FBRyxFQUFFO0lBQzlCLElBQUksY0FBOEIsQ0FBQztJQUVuQyxVQUFVLENBQUMsR0FBRyxFQUFFO1FBQ2Qsb0VBQW9FO1FBQ3BFLE1BQU0sTUFBTSxHQUFHO1lBQ2IsZ0JBQWdCLEVBQUUsQ0FBQztZQUNuQixnQkFBZ0IsRUFBRSxDQUFDO1lBQ25CLE9BQU8sRUFBRSxLQUFLO1lBQ2QsZ0JBQWdCLEVBQUUsTUFBTTtZQUN4QixtQkFBbUIsRUFBRSxHQUFHLENBQUMsK0RBQStEO1NBQ3pGLENBQUM7UUFDRixjQUFjLEdBQUcsSUFBSSwrQkFBYyxDQUFDLGNBQWMsRUFBRSxNQUFNLENBQUMsQ0FBQztJQUM5RCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxhQUFhLEVBQUUsR0FBRyxFQUFFO1FBQzNCLEVBQUUsQ0FBQyxnREFBZ0QsRUFBRSxHQUFHLEVBQUU7WUFDeEQsTUFBTSxDQUFDLGNBQWMsQ0FBQyxPQUFPLEVBQUUsQ0FBQyxDQUFDLElBQUksQ0FBQyxjQUFjLENBQUMsQ0FBQztZQUN0RCxNQUFNLENBQUMsY0FBYyxDQUFDLFFBQVEsRUFBRSxDQUFDLEtBQUssQ0FBQyxDQUFDLElBQUksQ0FBQyxvQ0FBbUIsQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUMzRSxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUMsQ0FBQyxDQUFDO0lBRUgsUUFBUSxDQUFDLHdCQUF3QixFQUFFLEdBQUcsRUFBRTtRQUN0QyxFQUFFLENBQUMsNkRBQTZELEVBQUUsS0FBSyxJQUFJLEVBQUU7WUFDM0UsTUFBTSxNQUFNLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxDQUFDO1lB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cEUsdUNBQXNCLENBQUMsUUFBUSxDQUFDLGdCQUFnQixDQUNqRCxDQUFDO1FBRUYsTUFBTSxDQUFDLHVDQUFzQixDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxlQUFlLENBQzdELHVDQUFzQixDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQ3hDLENBQUM7SUFDSixDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9pdmFuL0NvZGUvdHJhZGluZy90aXRhbi9zZXJ2aWNlcy90aXRhbi1icmFpbi90ZXN0cy9zZXJ2aWNlcy9DaXJjdWl0QnJlYWtlci50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogVW5pdCB0ZXN0cyBmb3IgQ2lyY3VpdEJyZWFrZXJcbiAqL1xuXG5pbXBvcnQgeyBDaXJjdWl0QnJlYWtlciwgQ2lyY3VpdEJyZWFrZXJTdGF0ZSwgQ2lyY3VpdEJyZWFrZXJEZWZhdWx0cywgQ2lyY3VpdEJyZWFrZXJFcnJvciB9IGZyb20gJy4uLy4uL3NyYy9zZXJ2aWNlcy9DaXJjdWl0QnJlYWtlcic7XG5cbmRlc2NyaWJlKCdDaXJjdWl0QnJlYWtlcicsICgpID0+IHtcbiAgbGV0IGNpcmN1aXRCcmVha2VyOiBDaXJjdWl0QnJlYWtlcjtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAvLyBVc2UgYSBjb25maWd1cmF0aW9uIHRoYXQgd29uJ3Qgb3BlbiBpbW1lZGlhdGVseSBvbiBzaW5nbGUgZmFpbHVyZVxuICAgIGNvbnN0IGNvbmZpZyA9IHtcbiAgICAgIGZhaWx1cmVUaHJlc2hvbGQ6IDUsXG4gICAgICBzdWNjZXNzVGhyZXNob2xkOiAzLFxuICAgICAgdGltZW91dDogNjAwMDAsXG4gICAgICBtb25pdG9yaW5nV2luZG93OiAzMDAwMDAsXG4gICAgICBleHBlY3RlZEZhaWx1cmVSYXRlOiAxLjAgLy8gMTAwJSBmYWlsdXJlIHJhdGUgdGhyZXNob2xkIChuZXZlciBvcGVuIGJhc2VkIG9uIHJhdGUgYWxvbmUpXG4gICAgfTtcbiAgICBjaXJjdWl0QnJlYWtlciA9IG5ldyBDaXJjdWl0QnJlYWtlcigndGVzdC1zZXJ2aWNlJywgY29uZmlnKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2NvbnN0cnVjdG9yJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgaW5pdGlhbGl6ZSB3aXRoIGNvcnJlY3QgbmFtZSBhbmQgY29uZmlnJywgKCkgPT4ge1xuICAgICAgZXhwZWN0KGNpcmN1aXRCcmVha2VyLmdldE5hbWUoKSkudG9CZSgndGVzdC1zZXJ2aWNlJyk7XG4gICAgICBleHBlY3QoY2lyY3VpdEJyZWFrZXIuZ2V0U3RhdHMoKS5zdGF0ZSkudG9CZShDaXJjdWl0QnJlYWtlclN0YXRlLkNMT1NFRCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdleGVjdXRlIC0gQ0xPU0VEIHN0YXRlJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgZXhlY3V0ZSBmdW5jdGlvbiBzdWNjZXNzZnVsbHkgd2hlbiBjaXJjdWl0IGlzIGNsb3NlZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tGbiA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSgnc3VjY2VzcycpO1xuICAgICAgXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBjaXJjdWl0QnJlYWtlci5leGVjdXRlKG1vY2tGbik7XG4gICAgICBcbiAgICAgIGV4cGVjdChyZXN1bHQpLnRvQmUoJ3N1Y2Nlc3MnKTtcbiAgICAgIGV4cGVjdChtb2NrRm4pLnRvSGF2ZUJlZW5DYWxsZWRUaW1lcygxKTtcbiAgICAgIGV4cGVjdChjaXJjdWl0QnJlYWtlci5nZXRTdGF0cygpLnN0YXRlKS50b0JlKENpcmN1aXRCcmVha2VyU3RhdGUuQ0xPU0VEKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIGZ1bmN0aW9uIGZhaWx1cmUgYW5kIGluY3JlbWVudCBmYWlsdXJlIGNvdW50JywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgbW9ja0ZuID0gamVzdC5mbigpLm1vY2tSZWplY3RlZFZhbHVlKG5ldyBFcnJvcigndGVzdCBlcnJvcicpKTtcbiAgICAgIFxuICAgICAgYXdhaXQgZXhwZWN0KGNpcmN1aXRCcmVha2VyLmV4ZWN1dGUobW9ja0ZuKSkucmVqZWN0cy50b1Rocm93KCd0ZXN0IGVycm9yJyk7XG4gICAgICBcbiAgICAgIGNvbnN0IHN0YXRzID0gY2lyY3VpdEJyZWFrZXIuZ2V0U3RhdHMoKTtcbiAgICAgIGV4cGVjdChzdGF0cy5mYWlsZWRSZXF1ZXN0cykudG9CZSgxKTtcbiAgICAgIGV4cGVjdChzdGF0cy50b3RhbFJlcXVlc3RzKS50b0JlKDEpO1xuICAgICAgLy8gTm90ZTogZmFpbHVyZUNvdW50IG1pZ2h0IGJlIDAgaWYgY2lyY3VpdCBvcGVuZWQgZHVlIHRvIGZhaWx1cmUgcmF0ZVxuICAgICAgZXhwZWN0KHN0YXRzLnN0YXRlKS50b0JlKENpcmN1aXRCcmVha2VyU3RhdGUuQ0xPU0VEKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgb3BlbiBjaXJjdWl0IGFmdGVyIHJlYWNoaW5nIGZhaWx1cmUgdGhyZXNob2xkJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgbW9ja0ZuID0gamVzdC5mbigpLm1vY2tSZWplY3RlZFZhbHVlKG5ldyBFcnJvcigndGVzdCBlcnJvcicpKTtcbiAgICAgIGNvbnN0IGNvbmZpZyA9IENpcmN1aXRCcmVha2VyRGVmYXVsdHMuSU1QT1JUQU5UO1xuICAgICAgXG4gICAgICAvLyBFeGVjdXRlIGZhaWx1cmVzIHVwIHRvIHRocmVzaG9sZFxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb25maWcuZmFpbHVyZVRocmVzaG9sZDsgaSsrKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgYXdhaXQgY2lyY3VpdEJyZWFrZXIuZXhlY3V0ZShtb2NrRm4pO1xuICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgIC8vIEV4cGVjdGVkIHRvIGZhaWxcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgXG4gICAgICBleHBlY3QoY2lyY3VpdEJyZWFrZXIuZ2V0U3RhdHMoKS5zdGF0ZSkudG9CZShDaXJjdWl0QnJlYWtlclN0YXRlLk9QRU4pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnZXhlY3V0ZSAtIE9QRU4gc3RhdGUnLCAoKSA9PiB7XG4gICAgYmVmb3JlRWFjaChhc3luYyAoKSA9PiB7XG4gICAgICAvLyBGb3JjZSBjaXJjdWl0IHRvIG9wZW5cbiAgICAgIGNpcmN1aXRCcmVha2VyLmZvcmNlT3BlbigpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZWplY3QgcmVxdWVzdHMgaW1tZWRpYXRlbHkgd2hlbiBjaXJjdWl0IGlzIG9wZW4nLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrRm4gPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoJ3N1Y2Nlc3MnKTtcbiAgICAgIFxuICAgICAgYXdhaXQgZXhwZWN0KGNpcmN1aXRCcmVha2VyLmV4ZWN1dGUobW9ja0ZuKSkucmVqZWN0cy50b1Rocm93KENpcmN1aXRCcmVha2VyRXJyb3IpO1xuICAgICAgXG4gICAgICBleHBlY3QobW9ja0ZuKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgZXhwZWN0KGNpcmN1aXRCcmVha2VyLmdldFN0YXRzKCkuc3RhdGUpLnRvQmUoQ2lyY3VpdEJyZWFrZXJTdGF0ZS5PUEVOKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgdHJhbnNpdGlvbiB0byBIQUxGX09QRU4gYWZ0ZXIgdGltZW91dCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGNvbmZpZyA9IHsgLi4uQ2lyY3VpdEJyZWFrZXJEZWZhdWx0cy5JTVBPUlRBTlQsIHRpbWVvdXQ6IDEwMCB9O1xuICAgICAgY29uc3QgY2IgPSBuZXcgQ2lyY3VpdEJyZWFrZXIoJ3Rlc3QnLCBjb25maWcpO1xuICAgICAgY2IuZm9yY2VPcGVuKCk7XG4gICAgICBcbiAgICAgIC8vIFdhaXQgZm9yIHRpbWVvdXRcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAxNTApKTtcbiAgICAgIFxuICAgICAgY29uc3QgbW9ja0ZuID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKCdzdWNjZXNzJyk7XG4gICAgICBhd2FpdCBjYi5leGVjdXRlKG1vY2tGbik7XG4gICAgICBcbiAgICAgIGV4cGVjdChjYi5nZXRTdGF0cygpLnN0YXRlKS50b0JlKENpcmN1aXRCcmVha2VyU3RhdGUuSEFMRl9PUEVOKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2V4ZWN1dGUgLSBIQUxGX09QRU4gc3RhdGUnLCAoKSA9PiB7XG4gICAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgICBjaXJjdWl0QnJlYWtlci5mb3JjZU9wZW4oKTtcbiAgICAgIC8vIE1hbnVhbGx5IHNldCB0byBoYWxmLW9wZW4gZm9yIHRlc3RpbmdcbiAgICAgIChjaXJjdWl0QnJlYWtlciBhcyBhbnkpLnN0YXRlID0gQ2lyY3VpdEJyZWFrZXJTdGF0ZS5IQUxGX09QRU47XG4gICAgICAoY2lyY3VpdEJyZWFrZXIgYXMgYW55KS5zdWNjZXNzQ291bnQgPSAwO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBjbG9zZSBjaXJjdWl0IGFmdGVyIHN1Y2Nlc3MgdGhyZXNob2xkIGluIGhhbGYtb3BlbiBzdGF0ZScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IG1vY2tGbiA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSgnc3VjY2VzcycpO1xuICAgICAgY29uc3QgY29uZmlnID0gQ2lyY3VpdEJyZWFrZXJEZWZhdWx0cy5JTVBPUlRBTlQ7XG4gICAgICBcbiAgICAgIC8vIEV4ZWN1dGUgc3VjY2Vzc2Z1bCByZXF1ZXN0cyB1cCB0byBzdWNjZXNzIHRocmVzaG9sZFxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCBjb25maWcuc3VjY2Vzc1RocmVzaG9sZDsgaSsrKSB7XG4gICAgICAgIGF3YWl0IGNpcmN1aXRCcmVha2VyLmV4ZWN1dGUobW9ja0ZuKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgZXhwZWN0KGNpcmN1aXRCcmVha2VyLmdldFN0YXRzKCkuc3RhdGUpLnRvQmUoQ2lyY3VpdEJyZWFrZXJTdGF0ZS5DTE9TRUQpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBvcGVuIGNpcmN1aXQgb24gZmFpbHVyZSBpbiBoYWxmLW9wZW4gc3RhdGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBtb2NrRm4gPSBqZXN0LmZuKCkubW9ja1JlamVjdGVkVmFsdWUobmV3IEVycm9yKCd0ZXN0IGVycm9yJykpO1xuICAgICAgXG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBjaXJjdWl0QnJlYWtlci5leGVjdXRlKG1vY2tGbik7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAvLyBFeHBlY3RlZCB0byBmYWlsXG4gICAgICB9XG4gICAgICBcbiAgICAgIGV4cGVjdChjaXJjdWl0QnJlYWtlci5nZXRTdGF0cygpLnN0YXRlKS50b0JlKENpcmN1aXRCcmVha2VyU3RhdGUuT1BFTik7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdmYWlsdXJlIHJhdGUgbW9uaXRvcmluZycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHRyYWNrIGZhaWx1cmUgcmF0ZSB3aXRoaW4gbW9uaXRvcmluZyB3aW5kb3cnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBjb25maWcgPSB7XG4gICAgICAgIGZhaWx1cmVUaHJlc2hvbGQ6IDEwMCwgLy8gSGlnaCB0aHJlc2hvbGQgdG8gcHJldmVudCBvcGVuaW5nIGR1ZSB0byBjb3VudFxuICAgICAgICBzdWNjZXNzVGhyZXNob2xkOiAzLFxuICAgICAgICB0aW1lb3V0OiA2MDAwMCxcbiAgICAgICAgbW9uaXRvcmluZ1dpbmRvdzogMTAwMCxcbiAgICAgICAgZXhwZWN0ZWRGYWlsdXJlUmF0ZTogMS4wIC8vIDEwMCUgZmFpbHVyZSByYXRlIHRocmVzaG9sZCAod29uJ3QgdHJpZ2dlcilcbiAgICAgIH07XG4gICAgICBjb25zdCBjYiA9IG5ldyBDaXJjdWl0QnJlYWtlcigndGVzdCcsIGNvbmZpZyk7XG4gICAgICBcbiAgICAgIC8vIEV4ZWN1dGUgbWl4ZWQgc3VjY2Vzcy9mYWlsdXJlIHJlcXVlc3RzXG4gICAgICBjb25zdCBzdWNjZXNzRm4gPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoJ3N1Y2Nlc3MnKTtcbiAgICAgIGNvbnN0IGZhaWx1cmVGbiA9IGplc3QuZm4oKS5tb2NrUmVqZWN0ZWRWYWx1ZShuZXcgRXJyb3IoJ2ZhaWx1cmUnKSk7XG4gICAgICBcbiAgICAgIGF3YWl0IGNiLmV4ZWN1dGUoc3VjY2Vzc0ZuKTtcbiAgICAgIHRyeSB7IGF3YWl0IGNiLmV4ZWN1dGUoZmFpbHVyZUZuKTsgfSBjYXRjaCAoZSkge31cbiAgICAgIGF3YWl0IGNiLmV4ZWN1dGUoc3VjY2Vzc0ZuKTtcbiAgICAgIHRyeSB7IGF3YWl0IGNiLmV4ZWN1dGUoZmFpbHVyZUZuKTsgfSBjYXRjaCAoZSkge31cbiAgICAgIHRyeSB7IGF3YWl0IGNiLmV4ZWN1dGUoZmFpbHVyZUZuKTsgfSBjYXRjaCAoZSkge31cbiAgICAgIFxuICAgICAgY29uc3QgZmFpbHVyZVJhdGUgPSBjYi5nZXRDdXJyZW50RmFpbHVyZVJhdGUoKTtcbiAgICAgIGV4cGVjdChmYWlsdXJlUmF0ZSkudG9CZSgwLjYpOyAvLyAzIGZhaWx1cmVzIG91dCBvZiA1IHJlcXVlc3RzXG4gICAgICBleHBlY3QoY2IuZ2V0U3RhdHMoKS5zdGF0ZSkudG9CZShDaXJjdWl0QnJlYWtlclN0YXRlLkNMT1NFRCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIG9wZW4gY2lyY3VpdCB3aGVuIGZhaWx1cmUgcmF0ZSBleGNlZWRzIHRocmVzaG9sZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGNvbmZpZyA9IHtcbiAgICAgICAgLi4uQ2lyY3VpdEJyZWFrZXJEZWZhdWx0cy5JTVBPUlRBTlQsXG4gICAgICAgIGZhaWx1cmVUaHJlc2hvbGQ6IDEwLCAvLyBIaWdoIHRocmVzaG9sZFxuICAgICAgICBleHBlY3RlZEZhaWx1cmVSYXRlOiAwLjUsIC8vIDUwJSBmYWlsdXJlIHJhdGUgdGhyZXNob2xkXG4gICAgICAgIG1vbml0b3JpbmdXaW5kb3c6IDEwMDBcbiAgICAgIH07XG4gICAgICBjb25zdCBjYiA9IG5ldyBDaXJjdWl0QnJlYWtlcigndGVzdCcsIGNvbmZpZyk7XG4gICAgICBcbiAgICAgIGNvbnN0IGZhaWx1cmVGbiA9IGplc3QuZm4oKS5tb2NrUmVqZWN0ZWRWYWx1ZShuZXcgRXJyb3IoJ2ZhaWx1cmUnKSk7XG4gICAgICBcbiAgICAgIC8vIEV4ZWN1dGUgZW5vdWdoIGZhaWx1cmVzIHRvIGV4Y2VlZCByYXRlIHRocmVzaG9sZFxuICAgICAgZm9yIChsZXQgaSA9IDA7IGkgPCA2OyBpKyspIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBhd2FpdCBjYi5leGVjdXRlKGZhaWx1cmVGbik7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgLy8gRXhwZWN0ZWQgdG8gZmFpbFxuICAgICAgICB9XG4gICAgICB9XG4gICAgICBcbiAgICAgIGV4cGVjdChjYi5nZXRTdGF0cygpLnN0YXRlKS50b0JlKENpcmN1aXRCcmVha2VyU3RhdGUuT1BFTik7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdzdGF0aXN0aWNzJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgdHJhY2sgcmVxdWVzdCBzdGF0aXN0aWNzIGNvcnJlY3RseScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHN1Y2Nlc3NGbiA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSgnc3VjY2VzcycpO1xuICAgICAgY29uc3QgZmFpbHVyZUZuID0gamVzdC5mbigpLm1vY2tSZWplY3RlZFZhbHVlKG5ldyBFcnJvcignZmFpbHVyZScpKTtcbiAgICAgIFxuICAgICAgYXdhaXQgY2lyY3VpdEJyZWFrZXIuZXhlY3V0ZShzdWNjZXNzRm4pO1xuICAgICAgYXdhaXQgY2lyY3VpdEJyZWFrZXIuZXhlY3V0ZShzdWNjZXNzRm4pO1xuICAgICAgdHJ5IHsgYXdhaXQgY2lyY3VpdEJyZWFrZXIuZXhlY3V0ZShmYWlsdXJlRm4pOyB9IGNhdGNoIChlKSB7fVxuICAgICAgXG4gICAgICBjb25zdCBzdGF0cyA9IGNpcmN1aXRCcmVha2VyLmdldFN0YXRzKCk7XG4gICAgICBleHBlY3Qoc3RhdHMudG90YWxSZXF1ZXN0cykudG9CZSgzKTtcbiAgICAgIGV4cGVjdChzdGF0cy5mYWlsZWRSZXF1ZXN0cykudG9CZSgxKTtcbiAgICAgIGV4cGVjdChzdGF0cy5sYXN0U3VjY2Vzc1RpbWUpLnRvQmVUcnV0aHkoKTtcbiAgICAgIGV4cGVjdChzdGF0cy5sYXN0RmFpbHVyZVRpbWUpLnRvQmVUcnV0aHkoKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ21hbnVhbCBjb250cm9sJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgYWxsb3cgZm9yY2luZyBjaXJjdWl0IG9wZW4nLCAoKSA9PiB7XG4gICAgICBjaXJjdWl0QnJlYWtlci5mb3JjZU9wZW4oKTtcbiAgICAgIGV4cGVjdChjaXJjdWl0QnJlYWtlci5nZXRTdGF0cygpLnN0YXRlKS50b0JlKENpcmN1aXRCcmVha2VyU3RhdGUuT1BFTik7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGFsbG93IGZvcmNpbmcgY2lyY3VpdCBjbG9zZWQnLCAoKSA9PiB7XG4gICAgICBjaXJjdWl0QnJlYWtlci5mb3JjZU9wZW4oKTtcbiAgICAgIGNpcmN1aXRCcmVha2VyLmZvcmNlQ2xvc2UoKTtcbiAgICAgIGV4cGVjdChjaXJjdWl0QnJlYWtlci5nZXRTdGF0cygpLnN0YXRlKS50b0JlKENpcmN1aXRCcmVha2VyU3RhdGUuQ0xPU0VEKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2Vycm9yIGhhbmRsaW5nJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgdGhyb3cgQ2lyY3VpdEJyZWFrZXJFcnJvciB3aGVuIGNpcmN1aXQgaXMgb3BlbicsIGFzeW5jICgpID0+IHtcbiAgICAgIGNpcmN1aXRCcmVha2VyLmZvcmNlT3BlbigpO1xuICAgICAgY29uc3QgbW9ja0ZuID0gamVzdC5mbigpO1xuICAgICAgXG4gICAgICBhd2FpdCBleHBlY3QoY2lyY3VpdEJyZWFrZXIuZXhlY3V0ZShtb2NrRm4pKS5yZWplY3RzLnRvVGhyb3coQ2lyY3VpdEJyZWFrZXJFcnJvcik7XG4gICAgICBhd2FpdCBleHBlY3QoY2lyY3VpdEJyZWFrZXIuZXhlY3V0ZShtb2NrRm4pKS5yZWplY3RzLnRvVGhyb3coL0NpcmN1aXQgYnJlYWtlciAndGVzdC1zZXJ2aWNlJyBpcyBPUEVOLyk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG5cbmRlc2NyaWJlKCdDaXJjdWl0QnJlYWtlckRlZmF1bHRzJywgKCkgPT4ge1xuICBpdCgnc2hvdWxkIHByb3ZpZGUgZGlmZmVyZW50IGNvbmZpZ3VyYXRpb25zIGZvciBkaWZmZXJlbnQgc2VydmljZSB0eXBlcycsICgpID0+IHtcbiAgICBleHBlY3QoQ2lyY3VpdEJyZWFrZXJEZWZhdWx0cy5DUklUSUNBTC5mYWlsdXJlVGhyZXNob2xkKS50b0JlTGVzc1RoYW4oXG4gICAgICBDaXJjdWl0QnJlYWtlckRlZmF1bHRzLklNUE9SVEFOVC5mYWlsdXJlVGhyZXNob2xkXG4gICAgKTtcbiAgICBleHBlY3QoQ2lyY3VpdEJyZWFrZXJEZWZhdWx0cy5JTVBPUlRBTlQuZmFpbHVyZVRocmVzaG9sZCkudG9CZUxlc3NUaGFuKFxuICAgICAgQ2lyY3VpdEJyZWFrZXJEZWZhdWx0cy5PUFRJT05BTC5mYWlsdXJlVGhyZXNob2xkXG4gICAgKTtcbiAgICBcbiAgICBleHBlY3QoQ2lyY3VpdEJyZWFrZXJEZWZhdWx0cy5DUklUSUNBTC50aW1lb3V0KS50b0JlR3JlYXRlclRoYW4oXG4gICAgICBDaXJjdWl0QnJlYWtlckRlZmF1bHRzLk9QVElPTkFMLnRpbWVvdXRcbiAgICApO1xuICB9KTtcbn0pOyJdLCJ2ZXJzaW9uIjozfQ==
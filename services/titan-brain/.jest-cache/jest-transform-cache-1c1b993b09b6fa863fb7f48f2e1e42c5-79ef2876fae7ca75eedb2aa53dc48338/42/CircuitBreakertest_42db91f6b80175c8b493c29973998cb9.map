{"file":"/Users/ivan/Code/trading/titan/services/titan-brain/tests/services/CircuitBreaker.test.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-brain/tests/services/CircuitBreaker.test.ts"],"sourcesContent":["/**\n * Unit tests for CircuitBreaker\n */\n\nimport { CircuitBreaker, CircuitBreakerState, CircuitBreakerDefaults, CircuitBreakerError } from '../../src/services/CircuitBreaker';\n\ndescribe('CircuitBreaker', () => {\n  let circuitBreaker: CircuitBreaker;\n\n  beforeEach(() => {\n    // Use a configuration that won't open immediately on single failure\n    const config = {\n      failureThreshold: 5,\n      successThreshold: 3,\n      timeout: 60000,\n      monitoringWindow: 300000,\n      expectedFailureRate: 1.0 // 100% failure rate threshold (never open based on rate alone)\n    };\n    circuitBreaker = new CircuitBreaker('test-service', config);\n  });\n\n  describe('constructor', () => {\n    it('should initialize with correct name and config', () => {\n      expect(circuitBreaker.getName()).toBe('test-service');\n      expect(circuitBreaker.getStats().state).toBe(CircuitBreakerState.CLOSED);\n    });\n  });\n\n  describe('execute - CLOSED state', () => {\n    it('should execute function successfully when circuit is closed', async () => {\n      const mockFn = jest.fn().mockResolvedValue('success');\n      \n      const result = await circuitBreaker.execute(mockFn);\n      \n      expect(result).toBe('success');\n      expect(mockFn).toHaveBeenCalledTimes(1);\n      expect(circuitBreaker.getStats().state).toBe(CircuitBreakerState.CLOSED);\n    });\n\n    it('should handle function failure and increment failure count', async () => {\n      const mockFn = jest.fn().mockRejectedValue(new Error('test error'));\n      \n      await expect(circuitBreaker.execute(mockFn)).rejects.toThrow('test error');\n      \n      const stats = circuitBreaker.getStats();\n      expect(stats.failedRequests).toBe(1);\n      expect(stats.totalRequests).toBe(1);\n      // Note: failureCount might be 0 if circuit opened due to failure rate\n      expect(stats.state).toBe(CircuitBreakerState.CLOSED);\n    });\n\n    it('should open circuit after reaching failure threshold', async () => {\n      const mockFn = jest.fn().mockRejectedValue(new Error('test error'));\n      const config = CircuitBreakerDefaults.IMPORTANT;\n      \n      // Execute failures up to threshold\n      for (let i = 0; i < config.failureThreshold; i++) {\n        try {\n          await circuitBreaker.execute(mockFn);\n        } catch (error) {\n          // Expected to fail\n        }\n      }\n      \n      expect(circuitBreaker.getStats().state).toBe(CircuitBreakerState.OPEN);\n    });\n  });\n\n  describe('execute - OPEN state', () => {\n    beforeEach(async () => {\n      // Force circuit to open\n      circuitBreaker.forceOpen();\n    });\n\n    it('should reject requests immediately when circuit is open', async () => {\n      const mockFn = jest.fn().mockResolvedValue('success');\n      \n      await expect(circuitBreaker.execute(mockFn)).rejects.toThrow(CircuitBreakerError);\n      \n      expect(mockFn).not.toHaveBeenCalled();\n      expect(circuitBreaker.getStats().state).toBe(CircuitBreakerState.OPEN);\n    });\n\n    it('should transition to HALF_OPEN after timeout', async () => {\n      const config = { ...CircuitBreakerDefaults.IMPORTANT, timeout: 100 };\n      const cb = new CircuitBreaker('test', config);\n      cb.forceOpen();\n      \n      // Wait for timeout\n      await new Promise(resolve => setTimeout(resolve, 150));\n      \n      const mockFn = jest.fn().mockResolvedValue('success');\n      await cb.execute(mockFn);\n      \n      expect(cb.getStats().state).toBe(CircuitBreakerState.HALF_OPEN);\n    });\n  });\n\n  describe('execute - HALF_OPEN state', () => {\n    beforeEach(() => {\n      circuitBreaker.forceOpen();\n      // Manually set to half-open for testing\n      (circuitBreaker as any).state = CircuitBreakerState.HALF_OPEN;\n      (circuitBreaker as any).successCount = 0;\n    });\n\n    it('should close circuit after success threshold in half-open state', async () => {\n      const mockFn = jest.fn().mockResolvedValue('success');\n      const config = CircuitBreakerDefaults.IMPORTANT;\n      \n      // Execute successful requests up to success threshold\n      for (let i = 0; i < config.successThreshold; i++) {\n        await circuitBreaker.execute(mockFn);\n      }\n      \n      expect(circuitBreaker.getStats().state).toBe(CircuitBreakerState.CLOSED);\n    });\n\n    it('should open circuit on failure in half-open state', async () => {\n      const mockFn = jest.fn().mockRejectedValue(new Error('test error'));\n      \n      try {\n        await circuitBreaker.execute(mockFn);\n      } catch (error) {\n        // Expected to fail\n      }\n      \n      expect(circuitBreaker.getStats().state).toBe(CircuitBreakerState.OPEN);\n    });\n  });\n\n  describe('failure rate monitoring', () => {\n    it('should track failure rate within monitoring window', async () => {\n      const config = {\n        failureThreshold: 100, // High threshold to prevent opening due to count\n        successThreshold: 3,\n        timeout: 60000,\n        monitoringWindow: 1000,\n        expectedFailureRate: 1.0 // 100% failure rate threshold (won't trigger)\n      };\n      const cb = new CircuitBreaker('test', config);\n      \n      // Execute mixed success/failure requests\n      const successFn = jest.fn().mockResolvedValue('success');\n      const failureFn = jest.fn().mockRejectedValue(new Error('failure'));\n      \n      await cb.execute(successFn);\n      try { await cb.execute(failureFn); } catch (e) {}\n      await cb.execute(successFn);\n      try { await cb.execute(failureFn); } catch (e) {}\n      try { await cb.execute(failureFn); } catch (e) {}\n      \n      const failureRate = cb.getCurrentFailureRate();\n      expect(failureRate).toBe(0.6); // 3 failures out of 5 requests\n      expect(cb.getStats().state).toBe(CircuitBreakerState.CLOSED);\n    });\n\n    it('should open circuit when failure rate exceeds threshold', async () => {\n      const config = {\n        ...CircuitBreakerDefaults.IMPORTANT,\n        failureThreshold: 10, // High threshold\n        expectedFailureRate: 0.5, // 50% failure rate threshold\n        monitoringWindow: 1000\n      };\n      const cb = new CircuitBreaker('test', config);\n      \n      const failureFn = jest.fn().mockRejectedValue(new Error('failure'));\n      \n      // Execute enough failures to exceed rate threshold\n      for (let i = 0; i < 6; i++) {\n        try {\n          await cb.execute(failureFn);\n        } catch (error) {\n          // Expected to fail\n        }\n      }\n      \n      expect(cb.getStats().state).toBe(CircuitBreakerState.OPEN);\n    });\n  });\n\n  describe('statistics', () => {\n    it('should track request statistics correctly', async () => {\n      const successFn = jest.fn().mockResolvedValue('success');\n      const failureFn = jest.fn().mockRejectedValue(new Error('failure'));\n      \n      await circuitBreaker.execute(successFn);\n      await circuitBreaker.execute(successFn);\n      try { await circuitBreaker.execute(failureFn); } catch (e) {}\n      \n      const stats = circuitBreaker.getStats();\n      expect(stats.totalRequests).toBe(3);\n      expect(stats.failedRequests).toBe(1);\n      expect(stats.lastSuccessTime).toBeTruthy();\n      expect(stats.lastFailureTime).toBeTruthy();\n    });\n  });\n\n  describe('manual control', () => {\n    it('should allow forcing circuit open', () => {\n      circuitBreaker.forceOpen();\n      expect(circuitBreaker.getStats().state).toBe(CircuitBreakerState.OPEN);\n    });\n\n    it('should allow forcing circuit closed', () => {\n      circuitBreaker.forceOpen();\n      circuitBreaker.forceClose();\n      expect(circuitBreaker.getStats().state).toBe(CircuitBreakerState.CLOSED);\n    });\n  });\n\n  describe('error handling', () => {\n    it('should throw CircuitBreakerError when circuit is open', async () => {\n      circuitBreaker.forceOpen();\n      const mockFn = jest.fn();\n      \n      await expect(circuitBreaker.execute(mockFn)).rejects.toThrow(CircuitBreakerError);\n      await expect(circuitBreaker.execute(mockFn)).rejects.toThrow(/Circuit breaker 'test-service' is OPEN/);\n    });\n  });\n});\n\ndescribe('CircuitBreakerDefaults', () => {\n  it('should provide different configurations for different service types', () => {\n    expect(CircuitBreakerDefaults.CRITICAL.failureThreshold).toBeLessThan(\n      CircuitBreakerDefaults.IMPORTANT.failureThreshold\n    );\n    expect(CircuitBreakerDefaults.IMPORTANT.failureThreshold).toBeLessThan(\n      CircuitBreakerDefaults.OPTIONAL.failureThreshold\n    );\n    \n    expect(CircuitBreakerDefaults.CRITICAL.timeout).toBeGreaterThan(\n      CircuitBreakerDefaults.OPTIONAL.timeout\n    );\n  });\n});"],"version":3}
017e35c282612e562e77d29a2336a3dc
"use strict";
/**
 * InMemoryCache - High-performance in-memory cache with TTL support
 *
 * Provides fast in-memory caching with automatic expiration and LRU eviction.
 * Used as fallback when Redis is unavailable.
 *
 * Requirements: 3.2.1, 3.2.2, 3.2.3
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.InMemoryCache = void 0;
const events_1 = require("events");
/**
 * High-performance in-memory cache with TTL and LRU eviction
 */
class InMemoryCache extends events_1.EventEmitter {
    cache = new Map();
    maxSize;
    defaultTtlMs;
    cleanupInterval = null;
    stats = {
        hits: 0,
        misses: 0,
        evictions: 0,
        expired: 0
    };
    constructor(maxSize = 1000, defaultTtlMs = 300000) {
        super();
        this.maxSize = maxSize;
        this.defaultTtlMs = defaultTtlMs;
    }
    /**
     * Initialize the cache with cleanup interval
     */
    initialize() {
        // Start cleanup interval to remove expired entries
        this.startCleanupInterval();
        this.emit('initialized', { maxSize: this.maxSize, defaultTtlMs: this.defaultTtlMs });
    }
    /**
     * Start cleanup interval for expired entries
     */
    startCleanupInterval() {
        if (this.cleanupInterval) {
            clearInterval(this.cleanupInterval);
        }
        // Run cleanup every 30 seconds
        this.cleanupInterval = setInterval(() => {
            this.cleanupExpired();
        }, 30000);
    }
    /**
     * Clean up expired entries
     */
    cleanupExpired() {
        const now = Date.now();
        const expiredKeys = [];
        for (const [key, entry] of this.cache.entries()) {
            if (entry.expiresAt <= now) {
                expiredKeys.push(key);
            }
        }
        for (const key of expiredKeys) {
            this.cache.delete(key);
            this.stats.expired++;
        }
        if (expiredKeys.length > 0) {
            this.emit('cleanup', { expiredCount: expiredKeys.length, remainingSize: this.cache.size });
        }
    }
    /**
     * Evict least recently used entries to make space
     */
    evictLRU(count = 1) {
        if (this.cache.size === 0)
            return;
        // Sort entries by last accessed time (ascending)
        const entries = Array.from(this.cache.entries()).sort(([, a], [, b]) => a.lastAccessed - b.lastAccessed);
        // Remove the oldest entries
        const actualEvictCount = Math.min(count, entries.length);
        for (let i = 0; i < actualEvictCount; i++) {
            const [key] = entries[i];
            this.cache.delete(key);
            this.stats.evictions++;
        }
        this.emit('eviction', { evictedCount: actualEvictCount, remainingSize: this.cache.size });
    }
    /**
     * Get a value from cache
     */
    get(key) {
        const entry = this.cache.get(key);
        if (!entry) {
            this.stats.misses++;
            this.emit('miss', { key });
            return undefined;
        }
        // Check if entry has expired
        if (entry.expiresAt <= Date.now()) {
            this.cache.delete(key);
            this.stats.expired++;
            this.stats.misses++;
            this.emit('expired', { key });
            return undefined;
        }
        // Update access statistics
        entry.accessCount++;
        entry.lastAccessed = Date.now();
        this.stats.hits++;
        this.emit('hit', { key, accessCount: entry.accessCount });
        return entry.value;
    }
    /**
     * Set a value in cache
     */
    set(key, value, ttlMs) {
        const now = Date.now();
        const effectiveTtl = ttlMs !== undefined ? ttlMs : this.defaultTtlMs;
        const expiresAt = effectiveTtl > 0 ? now + effectiveTtl : now; // If TTL is 0, expire immediately
        // Check if we need to make space
        if (!this.cache.has(key) && this.cache.size >= this.maxSize) {
            // Evict 10% of entries or at least 1
            const evictCount = Math.max(1, Math.floor(this.maxSize * 0.1));
            this.evictLRU(evictCount);
        }
        // Set the entry
        this.cache.set(key, {
            value,
            expiresAt,
            accessCount: 0,
            lastAccessed: now
        });
        this.emit('set', {
            key,
            ttlMs: effectiveTtl,
            size: this.cache.size,
            expiresAt: new Date(expiresAt).toISOString()
        });
    }
    /**
     * Delete a value from cache
     */
    delete(key) {
        const existed = this.cache.delete(key);
        if (existed) {
            this.emit('delete', { key, remainingSize: this.cache.size });
        }
        return existed;
    }
    /**
     * Check if a key exists in cache (without updating access stats)
     */
    has(key) {
        const entry = this.cache.get(key);
        if (!entry) {
            return false;
        }
        // Check if entry has expired
        if (entry.expiresAt <= Date.now()) {
            this.cache.delete(key);
            this.stats.expired++;
            return false;
        }
        return true;
    }
    /**
     * Get multiple values from cache
     */
    getMultiple(keys) {
        const result = new Map();
        for (const key of keys) {
            const value = this.get(key);
            if (value !== undefined) {
                result.set(key, value);
            }
        }
        return result;
    }
    /**
     * Set multiple values in cache
     */
    setMultiple(entries, ttlMs) {
        for (const [key, value] of entries.entries()) {
            this.set(key, value, ttlMs);
        }
    }
    /**
     * Delete multiple values from cache
     */
    deleteMultiple(keys) {
        let deletedCount = 0;
        for (const key of keys) {
            if (this.delete(key)) {
                deletedCount++;
            }
        }
        return deletedCount;
    }
    /**
     * Clear all entries from cache
     */
    clear() {
        const previousSize = this.cache.size;
        this.cache.clear();
        // Reset stats
        this.stats = {
            hits: 0,
            misses: 0,
            evictions: 0,
            expired: 0
        };
        this.emit('clear', { previousSize });
    }
    /**
     * Get all keys in cache (excluding expired)
     */
    keys() {
        const now = Date.now();
        const validKeys = [];
        for (const [key, entry] of this.cache.entries()) {
            if (entry.expiresAt > now) {
                validKeys.push(key);
            }
        }
        return validKeys;
    }
    /**
     * Get cache statistics
     */
    getStats() {
        const totalRequests = this.stats.hits + this.stats.misses;
        const hitRate = totalRequests > 0 ? (this.stats.hits / totalRequests) * 100 : 0;
        // Estimate memory usage (rough calculation)
        let estimatedMemoryUsage = 0;
        for (const [key, entry] of this.cache.entries()) {
            // Rough estimation: key size + JSON serialized value size + overhead
            estimatedMemoryUsage += key.length * 2; // UTF-16 characters
            estimatedMemoryUsage += JSON.stringify(entry.value).length * 2;
            estimatedMemoryUsage += 64; // Estimated overhead per entry
        }
        return {
            size: this.cache.size,
            maxSize: this.maxSize,
            hits: this.stats.hits,
            misses: this.stats.misses,
            evictions: this.stats.evictions,
            expired: this.stats.expired,
            hitRate,
            memoryUsage: estimatedMemoryUsage
        };
    }
    /**
     * Get entries that will expire soon
     */
    getExpiringEntries(withinMs = 60000) {
        const now = Date.now();
        const threshold = now + withinMs;
        const expiringEntries = [];
        for (const [key, entry] of this.cache.entries()) {
            if (entry.expiresAt <= threshold && entry.expiresAt > now) {
                expiringEntries.push({
                    key,
                    expiresAt: entry.expiresAt,
                    timeLeft: entry.expiresAt - now
                });
            }
        }
        return expiringEntries.sort((a, b) => a.timeLeft - b.timeLeft);
    }
    /**
     * Get most accessed entries
     */
    getMostAccessed(limit = 10) {
        const entries = Array.from(this.cache.entries())
            .map(([key, entry]) => ({
            key,
            accessCount: entry.accessCount,
            lastAccessed: entry.lastAccessed
        }))
            .sort((a, b) => b.accessCount - a.accessCount)
            .slice(0, limit);
        return entries;
    }
    /**
     * Update TTL for an existing entry
     */
    updateTTL(key, ttlMs) {
        const entry = this.cache.get(key);
        if (!entry) {
            return false;
        }
        // Check if entry has expired
        if (entry.expiresAt <= Date.now()) {
            this.cache.delete(key);
            this.stats.expired++;
            return false;
        }
        // Update expiration time
        entry.expiresAt = Date.now() + ttlMs;
        this.emit('ttl_updated', {
            key,
            newTtlMs: ttlMs,
            expiresAt: new Date(entry.expiresAt).toISOString()
        });
        return true;
    }
    /**
     * Get TTL for an entry (in milliseconds)
     */
    getTTL(key) {
        const entry = this.cache.get(key);
        if (!entry) {
            return null;
        }
        const now = Date.now();
        // Check if entry has expired
        if (entry.expiresAt <= now) {
            this.cache.delete(key);
            this.stats.expired++;
            return null;
        }
        return entry.expiresAt - now;
    }
    /**
     * Shutdown the cache and cleanup resources
     */
    shutdown() {
        if (this.cleanupInterval) {
            clearInterval(this.cleanupInterval);
            this.cleanupInterval = null;
        }
        this.clear();
        this.emit('shutdown');
    }
    /**
     * Get current size
     */
    size() {
        return this.cache.size;
    }
    /**
     * Check if cache is empty
     */
    isEmpty() {
        return this.cache.size === 0;
    }
    /**
     * Check if cache is full
     */
    isFull() {
        return this.cache.size >= this.maxSize;
    }
}
exports.InMemoryCache = InMemoryCache;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLWJyYWluL3NyYy9jYWNoZS9Jbk1lbW9yeUNhY2hlLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7OztHQU9HOzs7QUFFSCxtQ0FBc0M7QUEwQnRDOztHQUVHO0FBQ0gsTUFBYSxhQUFjLFNBQVEscUJBQVk7SUFDckMsS0FBSyxHQUE0QixJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQzNDLE9BQU8sQ0FBUztJQUNoQixZQUFZLENBQVM7SUFDckIsZUFBZSxHQUEwQixJQUFJLENBQUM7SUFDOUMsS0FBSyxHQUtUO1FBQ0YsSUFBSSxFQUFFLENBQUM7UUFDUCxNQUFNLEVBQUUsQ0FBQztRQUNULFNBQVMsRUFBRSxDQUFDO1FBQ1osT0FBTyxFQUFFLENBQUM7S0FDWCxDQUFDO0lBRUYsWUFBWSxVQUFrQixJQUFJLEVBQUUsZUFBdUIsTUFBTTtRQUMvRCxLQUFLLEVBQUUsQ0FBQztRQUNSLElBQUksQ0FBQyxPQUFPLEdBQUcsT0FBTyxDQUFDO1FBQ3ZCLElBQUksQ0FBQyxZQUFZLEdBQUcsWUFBWSxDQUFDO0lBQ25DLENBQUM7SUFFRDs7T0FFRztJQUNILFVBQVU7UUFDUixtREFBbUQ7UUFDbkQsSUFBSSxDQUFDLG9CQUFvQixFQUFFLENBQUM7UUFDNUIsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUUsRUFBRSxPQUFPLEVBQUUsSUFBSSxDQUFDLE9BQU8sRUFBRSxZQUFZLEVBQUUsSUFBSSxDQUFDLFlBQVksRUFBRSxDQUFDLENBQUM7SUFDdkYsQ0FBQztJQUVEOztPQUVHO0lBQ0ssb0JBQW9CO1FBQzFCLElBQUksSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1lBQ3pCLGFBQWEsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7UUFDdEMsQ0FBQztRQUVELCtCQUErQjtRQUMvQixJQUFJLENBQUMsZUFBZSxHQUFHLFdBQVcsQ0FBQyxHQUFHLEVBQUU7WUFDdEMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1FBQ3hCLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztJQUNaLENBQUM7SUFFRDs7T0FFRztJQUNLLGNBQWM7UUFDcEIsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBQ3ZCLE1BQU0sV0FBVyxHQUFhLEVBQUUsQ0FBQztRQUVqQyxLQUFLLE1BQU0sQ0FBQyxHQUFHLEVBQUUsS0FBSyxDQUFDLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDO1lBQ2hELElBQUksS0FBSyxDQUFDLFNBQVMsSUFBSSxHQUFHLEVBQUUsQ0FBQztnQkFDM0IsV0FBVyxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN4QixDQUFDO1FBQ0gsQ0FBQztRQUVELEtBQUssTUFBTSxHQUFHLElBQUksV0FBVyxFQUFFLENBQUM7WUFDOUIsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDdkIsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQztRQUN2QixDQUFDO1FBRUQsSUFBSSxXQUFXLENBQUMsTUFBTSxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQzNCLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLEVBQUUsWUFBWSxFQUFFLFdBQVcsQ0FBQyxNQUFNLEVBQUUsYUFBYSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxFQUFFLENBQUMsQ0FBQztRQUM3RixDQUFDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0ssUUFBUSxDQUFDLFFBQWdCLENBQUM7UUFDaEMsSUFBSSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksS0FBSyxDQUFDO1lBQUUsT0FBTztRQUVsQyxpREFBaUQ7UUFDakQsTUFBTSxPQUFPLEdBQUcsS0FBSyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDLENBQUMsSUFBSSxDQUNuRCxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxZQUFZLEdBQUcsQ0FBQyxDQUFDLFlBQVksQ0FDbEQsQ0FBQztRQUVGLDRCQUE0QjtRQUM1QixNQUFNLGdCQUFnQixHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsS0FBSyxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQztRQUN6RCxLQUFLLElBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEdBQUcsZ0JBQWdCLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUMxQyxNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsT0FBTyxDQUFDLENBQUMsQ0FBQyxDQUFDO1lBQ3pCLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1lBQ3ZCLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUyxFQUFFLENBQUM7UUFDekIsQ0FBQztRQUVELElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxFQUFFLEVBQUUsWUFBWSxFQUFFLGdCQUFnQixFQUFFLGFBQWEsRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDLENBQUM7SUFDNUYsQ0FBQztJQUVEOztPQUVHO0lBQ0gsR0FBRyxDQUFVLEdBQVc7UUFDdEIsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFbEMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ1gsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLEVBQUUsQ0FBQztZQUNwQixJQUFJLENBQUMsSUFBSSxDQUFDLE1BQU0sRUFBRSxFQUFFLEdBQUcsRUFBRSxDQUFDLENBQUM7WUFDM0IsT0FBTyxTQUFTLENBQUM7UUFDbkIsQ0FBQztRQUVELDZCQUE2QjtRQUM3QixJQUFJLEtBQUssQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUM7WUFDbEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDdkIsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNyQixJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sRUFBRSxDQUFDO1lBQ3BCLElBQUksQ0FBQyxJQUFJLENBQUMsU0FBUyxFQUFFLEVBQUUsR0FBRyxFQUFFLENBQUMsQ0FBQztZQUM5QixPQUFPLFNBQVMsQ0FBQztRQUNuQixDQUFDO1FBRUQsMkJBQTJCO1FBQzNCLEtBQUssQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUNwQixLQUFLLENBQUMsWUFBWSxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUNoQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksRUFBRSxDQUFDO1FBRWxCLElBQUksQ0FBQyxJQUFJLENBQUMsS0FBSyxFQUFFLEVBQUUsR0FBRyxFQUFFLFdBQVcsRUFBRSxLQUFLLENBQUMsV0FBVyxFQUFFLENBQUMsQ0FBQztRQUMxRCxPQUFPLEtBQUssQ0FBQyxLQUFVLENBQUM7SUFDMUIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsR0FBRyxDQUFVLEdBQVcsRUFBRSxLQUFRLEVBQUUsS0FBYztRQUNoRCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFDdkIsTUFBTSxZQUFZLEdBQUcsS0FBSyxLQUFLLFNBQVMsQ0FBQyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDO1FBQ3JFLE1BQU0sU0FBUyxHQUFHLFlBQVksR0FBRyxDQUFDLENBQUMsQ0FBQyxDQUFDLEdBQUcsR0FBRyxZQUFZLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxDQUFDLGtDQUFrQztRQUVqRyxpQ0FBaUM7UUFDakMsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUM1RCxxQ0FBcUM7WUFDckMsTUFBTSxVQUFVLEdBQUcsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUMsT0FBTyxHQUFHLEdBQUcsQ0FBQyxDQUFDLENBQUM7WUFDL0QsSUFBSSxDQUFDLFFBQVEsQ0FBQyxVQUFVLENBQUMsQ0FBQztRQUM1QixDQUFDO1FBRUQsZ0JBQWdCO1FBQ2hCLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRTtZQUNsQixLQUFLO1lBQ0wsU0FBUztZQUNULFdBQVcsRUFBRSxDQUFDO1lBQ2QsWUFBWSxFQUFFLEdBQUc7U0FDbEIsQ0FBQyxDQUFDO1FBRUgsSUFBSSxDQUFDLElBQUksQ0FBQyxLQUFLLEVBQUU7WUFDZixHQUFHO1lBQ0gsS0FBSyxFQUFFLFlBQVk7WUFDbkIsSUFBSSxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSTtZQUNyQixTQUFTLEVBQUUsSUFBSSxJQUFJLENBQUMsU0FBUyxDQUFDLENBQUMsV0FBVyxFQUFFO1NBQzdDLENBQUMsQ0FBQztJQUNMLENBQUM7SUFFRDs7T0FFRztJQUNILE1BQU0sQ0FBQyxHQUFXO1FBQ2hCLE1BQU0sT0FBTyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRXZDLElBQUksT0FBTyxFQUFFLENBQUM7WUFDWixJQUFJLENBQUMsSUFBSSxDQUFDLFFBQVEsRUFBRSxFQUFFLEdBQUcsRUFBRSxhQUFhLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEVBQUUsQ0FBQyxDQUFDO1FBQy9ELENBQUM7UUFFRCxPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDO0lBRUQ7O09BRUc7SUFDSCxHQUFHLENBQUMsR0FBVztRQUNiLE1BQU0sS0FBSyxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBRWxDLElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUNYLE9BQU8sS0FBSyxDQUFDO1FBQ2YsQ0FBQztRQUVELDZCQUE2QjtRQUM3QixJQUFJLEtBQUssQ0FBQyxTQUFTLElBQUksSUFBSSxDQUFDLEdBQUcsRUFBRSxFQUFFLENBQUM7WUFDbEMsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDdkIsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQztZQUNyQixPQUFPLEtBQUssQ0FBQztRQUNmLENBQUM7UUFFRCxPQUFPLElBQUksQ0FBQztJQUNkLENBQUM7SUFFRDs7T0FFRztJQUNILFdBQVcsQ0FBVSxJQUFjO1FBQ2pDLE1BQU0sTUFBTSxHQUFHLElBQUksR0FBRyxFQUFhLENBQUM7UUFFcEMsS0FBSyxNQUFNLEdBQUcsSUFBSSxJQUFJLEVBQUUsQ0FBQztZQUN2QixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFJLEdBQUcsQ0FBQyxDQUFDO1lBQy9CLElBQUksS0FBSyxLQUFLLFNBQVMsRUFBRSxDQUFDO2dCQUN4QixNQUFNLENBQUMsR0FBRyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUN6QixDQUFDO1FBQ0gsQ0FBQztRQUVELE9BQU8sTUFBTSxDQUFDO0lBQ2hCLENBQUM7SUFFRDs7T0FFRztJQUNILFdBQVcsQ0FBVSxPQUF1QixFQUFFLEtBQWM7UUFDMUQsS0FBSyxNQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxJQUFJLE9BQU8sQ0FBQyxPQUFPLEVBQUUsRUFBRSxDQUFDO1lBQzdDLElBQUksQ0FBQyxHQUFHLENBQUMsR0FBRyxFQUFFLEtBQUssRUFBRSxLQUFLLENBQUMsQ0FBQztRQUM5QixDQUFDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0gsY0FBYyxDQUFDLElBQWM7UUFDM0IsSUFBSSxZQUFZLEdBQUcsQ0FBQyxDQUFDO1FBRXJCLEtBQUssTUFBTSxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7WUFDdkIsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLEdBQUcsQ0FBQyxFQUFFLENBQUM7Z0JBQ3JCLFlBQVksRUFBRSxDQUFDO1lBQ2pCLENBQUM7UUFDSCxDQUFDO1FBRUQsT0FBTyxZQUFZLENBQUM7SUFDdEIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSztRQUNILE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxDQUFDO1FBQ3JDLElBQUksQ0FBQyxLQUFLLENBQUMsS0FBSyxFQUFFLENBQUM7UUFFbkIsY0FBYztRQUNkLElBQUksQ0FBQyxLQUFLLEdBQUc7WUFDWCxJQUFJLEVBQUUsQ0FBQztZQUNQLE1BQU0sRUFBRSxDQUFDO1lBQ1QsU0FBUyxFQUFFLENBQUM7WUFDWixPQUFPLEVBQUUsQ0FBQztTQUNYLENBQUM7UUFFRixJQUFJLENBQUMsSUFBSSxDQUFDLE9BQU8sRUFBRSxFQUFFLFlBQVksRUFBRSxDQUFDLENBQUM7SUFDdkMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsSUFBSTtRQUNGLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUN2QixNQUFNLFNBQVMsR0FBYSxFQUFFLENBQUM7UUFFL0IsS0FBSyxNQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQztZQUNoRCxJQUFJLEtBQUssQ0FBQyxTQUFTLEdBQUcsR0FBRyxFQUFFLENBQUM7Z0JBQzFCLFNBQVMsQ0FBQyxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUM7WUFDdEIsQ0FBQztRQUNILENBQUM7UUFFRCxPQUFPLFNBQVMsQ0FBQztJQUNuQixDQUFDO0lBRUQ7O09BRUc7SUFDSCxRQUFRO1FBQ04sTUFBTSxhQUFhLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUM7UUFDMUQsTUFBTSxPQUFPLEdBQUcsYUFBYSxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxhQUFhLENBQUMsR0FBRyxHQUFHLENBQUMsQ0FBQyxDQUFDLENBQUMsQ0FBQztRQUVoRiw0Q0FBNEM7UUFDNUMsSUFBSSxvQkFBb0IsR0FBRyxDQUFDLENBQUM7UUFDN0IsS0FBSyxNQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQztZQUNoRCxxRUFBcUU7WUFDckUsb0JBQW9CLElBQUksR0FBRyxDQUFDLE1BQU0sR0FBRyxDQUFDLENBQUMsQ0FBQyxvQkFBb0I7WUFDNUQsb0JBQW9CLElBQUksSUFBSSxDQUFDLFNBQVMsQ0FBQyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsTUFBTSxHQUFHLENBQUMsQ0FBQztZQUMvRCxvQkFBb0IsSUFBSSxFQUFFLENBQUMsQ0FBQywrQkFBK0I7UUFDN0QsQ0FBQztRQUVELE9BQU87WUFDTCxJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJO1lBQ3JCLE9BQU8sRUFBRSxJQUFJLENBQUMsT0FBTztZQUNyQixJQUFJLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJO1lBQ3JCLE1BQU0sRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU07WUFDekIsU0FBUyxFQUFFLElBQUksQ0FBQyxLQUFLLENBQUMsU0FBUztZQUMvQixPQUFPLEVBQUUsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPO1lBQzNCLE9BQU87WUFDUCxXQUFXLEVBQUUsb0JBQW9CO1NBQ2xDLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxrQkFBa0IsQ0FBQyxXQUFtQixLQUFLO1FBQ3pDLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUN2QixNQUFNLFNBQVMsR0FBRyxHQUFHLEdBQUcsUUFBUSxDQUFDO1FBQ2pDLE1BQU0sZUFBZSxHQUFnRSxFQUFFLENBQUM7UUFFeEYsS0FBSyxNQUFNLENBQUMsR0FBRyxFQUFFLEtBQUssQ0FBQyxJQUFJLElBQUksQ0FBQyxLQUFLLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQztZQUNoRCxJQUFJLEtBQUssQ0FBQyxTQUFTLElBQUksU0FBUyxJQUFJLEtBQUssQ0FBQyxTQUFTLEdBQUcsR0FBRyxFQUFFLENBQUM7Z0JBQzFELGVBQWUsQ0FBQyxJQUFJLENBQUM7b0JBQ25CLEdBQUc7b0JBQ0gsU0FBUyxFQUFFLEtBQUssQ0FBQyxTQUFTO29CQUMxQixRQUFRLEVBQUUsS0FBSyxDQUFDLFNBQVMsR0FBRyxHQUFHO2lCQUNoQyxDQUFDLENBQUM7WUFDTCxDQUFDO1FBQ0gsQ0FBQztRQUVELE9BQU8sZUFBZSxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLEVBQUUsRUFBRSxDQUFDLENBQUMsQ0FBQyxRQUFRLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxDQUFDO0lBQ2pFLENBQUM7SUFFRDs7T0FFRztJQUNILGVBQWUsQ0FBQyxRQUFnQixFQUFFO1FBQ2hDLE1BQU0sT0FBTyxHQUFHLEtBQUssQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEtBQUssQ0FBQyxPQUFPLEVBQUUsQ0FBQzthQUM3QyxHQUFHLENBQUMsQ0FBQyxDQUFDLEdBQUcsRUFBRSxLQUFLLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUN0QixHQUFHO1lBQ0gsV0FBVyxFQUFFLEtBQUssQ0FBQyxXQUFXO1lBQzlCLFlBQVksRUFBRSxLQUFLLENBQUMsWUFBWTtTQUNqQyxDQUFDLENBQUM7YUFDRixJQUFJLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUMsV0FBVyxHQUFHLENBQUMsQ0FBQyxXQUFXLENBQUM7YUFDN0MsS0FBSyxDQUFDLENBQUMsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUVuQixPQUFPLE9BQU8sQ0FBQztJQUNqQixDQUFDO0lBRUQ7O09BRUc7SUFDSCxTQUFTLENBQUMsR0FBVyxFQUFFLEtBQWE7UUFDbEMsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFbEMsSUFBSSxDQUFDLEtBQUssRUFBRSxDQUFDO1lBQ1gsT0FBTyxLQUFLLENBQUM7UUFDZixDQUFDO1FBRUQsNkJBQTZCO1FBQzdCLElBQUksS0FBSyxDQUFDLFNBQVMsSUFBSSxJQUFJLENBQUMsR0FBRyxFQUFFLEVBQUUsQ0FBQztZQUNsQyxJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN2QixJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ3JCLE9BQU8sS0FBSyxDQUFDO1FBQ2YsQ0FBQztRQUVELHlCQUF5QjtRQUN6QixLQUFLLENBQUMsU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxLQUFLLENBQUM7UUFFckMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUU7WUFDdkIsR0FBRztZQUNILFFBQVEsRUFBRSxLQUFLO1lBQ2YsU0FBUyxFQUFFLElBQUksSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQyxXQUFXLEVBQUU7U0FDbkQsQ0FBQyxDQUFDO1FBRUgsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsR0FBVztRQUNoQixNQUFNLEtBQUssR0FBRyxJQUFJLENBQUMsS0FBSyxDQUFDLEdBQUcsQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUVsQyxJQUFJLENBQUMsS0FBSyxFQUFFLENBQUM7WUFDWCxPQUFPLElBQUksQ0FBQztRQUNkLENBQUM7UUFFRCxNQUFNLEdBQUcsR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLENBQUM7UUFFdkIsNkJBQTZCO1FBQzdCLElBQUksS0FBSyxDQUFDLFNBQVMsSUFBSSxHQUFHLEVBQUUsQ0FBQztZQUMzQixJQUFJLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxHQUFHLENBQUMsQ0FBQztZQUN2QixJQUFJLENBQUMsS0FBSyxDQUFDLE9BQU8sRUFBRSxDQUFDO1lBQ3JCLE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUVELE9BQU8sS0FBSyxDQUFDLFNBQVMsR0FBRyxHQUFHLENBQUM7SUFDL0IsQ0FBQztJQUVEOztPQUVHO0lBQ0gsUUFBUTtRQUNOLElBQUksSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1lBQ3pCLGFBQWEsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDcEMsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFJLENBQUM7UUFDOUIsQ0FBQztRQUVELElBQUksQ0FBQyxLQUFLLEVBQUUsQ0FBQztRQUNiLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDeEIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsSUFBSTtRQUNGLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLENBQUM7SUFDekIsQ0FBQztJQUVEOztPQUVHO0lBQ0gsT0FBTztRQUNMLE9BQU8sSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJLEtBQUssQ0FBQyxDQUFDO0lBQy9CLENBQUM7SUFFRDs7T0FFRztJQUNILE1BQU07UUFDSixPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsSUFBSSxJQUFJLElBQUksQ0FBQyxPQUFPLENBQUM7SUFDekMsQ0FBQztDQUNGO0FBeFpELHNDQXdaQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvaXZhbi9Db2RlL3RyYWRpbmcvdGl0YW4vc2VydmljZXMvdGl0YW4tYnJhaW4vc3JjL2NhY2hlL0luTWVtb3J5Q2FjaGUudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBJbk1lbW9yeUNhY2hlIC0gSGlnaC1wZXJmb3JtYW5jZSBpbi1tZW1vcnkgY2FjaGUgd2l0aCBUVEwgc3VwcG9ydFxuICogXG4gKiBQcm92aWRlcyBmYXN0IGluLW1lbW9yeSBjYWNoaW5nIHdpdGggYXV0b21hdGljIGV4cGlyYXRpb24gYW5kIExSVSBldmljdGlvbi5cbiAqIFVzZWQgYXMgZmFsbGJhY2sgd2hlbiBSZWRpcyBpcyB1bmF2YWlsYWJsZS5cbiAqIFxuICogUmVxdWlyZW1lbnRzOiAzLjIuMSwgMy4yLjIsIDMuMi4zXG4gKi9cblxuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnZXZlbnRzJztcblxuLyoqXG4gKiBDYWNoZSBlbnRyeSB3aXRoIFRUTCBzdXBwb3J0XG4gKi9cbmludGVyZmFjZSBDYWNoZUVudHJ5PFQgPSBhbnk+IHtcbiAgdmFsdWU6IFQ7XG4gIGV4cGlyZXNBdDogbnVtYmVyO1xuICBhY2Nlc3NDb3VudDogbnVtYmVyO1xuICBsYXN0QWNjZXNzZWQ6IG51bWJlcjtcbn1cblxuLyoqXG4gKiBJbi1tZW1vcnkgY2FjaGUgc3RhdGlzdGljc1xuICovXG5leHBvcnQgaW50ZXJmYWNlIEluTWVtb3J5Q2FjaGVTdGF0cyB7XG4gIHNpemU6IG51bWJlcjtcbiAgbWF4U2l6ZTogbnVtYmVyO1xuICBoaXRzOiBudW1iZXI7XG4gIG1pc3NlczogbnVtYmVyO1xuICBldmljdGlvbnM6IG51bWJlcjtcbiAgZXhwaXJlZDogbnVtYmVyO1xuICBoaXRSYXRlOiBudW1iZXI7XG4gIG1lbW9yeVVzYWdlOiBudW1iZXI7IC8vIEVzdGltYXRlZCBpbiBieXRlc1xufVxuXG4vKipcbiAqIEhpZ2gtcGVyZm9ybWFuY2UgaW4tbWVtb3J5IGNhY2hlIHdpdGggVFRMIGFuZCBMUlUgZXZpY3Rpb25cbiAqL1xuZXhwb3J0IGNsYXNzIEluTWVtb3J5Q2FjaGUgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICBwcml2YXRlIGNhY2hlOiBNYXA8c3RyaW5nLCBDYWNoZUVudHJ5PiA9IG5ldyBNYXAoKTtcbiAgcHJpdmF0ZSBtYXhTaXplOiBudW1iZXI7XG4gIHByaXZhdGUgZGVmYXVsdFR0bE1zOiBudW1iZXI7XG4gIHByaXZhdGUgY2xlYW51cEludGVydmFsOiBOb2RlSlMuVGltZW91dCB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIHN0YXRzOiB7XG4gICAgaGl0czogbnVtYmVyO1xuICAgIG1pc3NlczogbnVtYmVyO1xuICAgIGV2aWN0aW9uczogbnVtYmVyO1xuICAgIGV4cGlyZWQ6IG51bWJlcjtcbiAgfSA9IHtcbiAgICBoaXRzOiAwLFxuICAgIG1pc3NlczogMCxcbiAgICBldmljdGlvbnM6IDAsXG4gICAgZXhwaXJlZDogMFxuICB9O1xuXG4gIGNvbnN0cnVjdG9yKG1heFNpemU6IG51bWJlciA9IDEwMDAsIGRlZmF1bHRUdGxNczogbnVtYmVyID0gMzAwMDAwKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLm1heFNpemUgPSBtYXhTaXplO1xuICAgIHRoaXMuZGVmYXVsdFR0bE1zID0gZGVmYXVsdFR0bE1zO1xuICB9XG5cbiAgLyoqXG4gICAqIEluaXRpYWxpemUgdGhlIGNhY2hlIHdpdGggY2xlYW51cCBpbnRlcnZhbFxuICAgKi9cbiAgaW5pdGlhbGl6ZSgpOiB2b2lkIHtcbiAgICAvLyBTdGFydCBjbGVhbnVwIGludGVydmFsIHRvIHJlbW92ZSBleHBpcmVkIGVudHJpZXNcbiAgICB0aGlzLnN0YXJ0Q2xlYW51cEludGVydmFsKCk7XG4gICAgdGhpcy5lbWl0KCdpbml0aWFsaXplZCcsIHsgbWF4U2l6ZTogdGhpcy5tYXhTaXplLCBkZWZhdWx0VHRsTXM6IHRoaXMuZGVmYXVsdFR0bE1zIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFN0YXJ0IGNsZWFudXAgaW50ZXJ2YWwgZm9yIGV4cGlyZWQgZW50cmllc1xuICAgKi9cbiAgcHJpdmF0ZSBzdGFydENsZWFudXBJbnRlcnZhbCgpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5jbGVhbnVwSW50ZXJ2YWwpIHtcbiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5jbGVhbnVwSW50ZXJ2YWwpO1xuICAgIH1cblxuICAgIC8vIFJ1biBjbGVhbnVwIGV2ZXJ5IDMwIHNlY29uZHNcbiAgICB0aGlzLmNsZWFudXBJbnRlcnZhbCA9IHNldEludGVydmFsKCgpID0+IHtcbiAgICAgIHRoaXMuY2xlYW51cEV4cGlyZWQoKTtcbiAgICB9LCAzMDAwMCk7XG4gIH1cblxuICAvKipcbiAgICogQ2xlYW4gdXAgZXhwaXJlZCBlbnRyaWVzXG4gICAqL1xuICBwcml2YXRlIGNsZWFudXBFeHBpcmVkKCk6IHZvaWQge1xuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgY29uc3QgZXhwaXJlZEtleXM6IHN0cmluZ1tdID0gW107XG5cbiAgICBmb3IgKGNvbnN0IFtrZXksIGVudHJ5XSBvZiB0aGlzLmNhY2hlLmVudHJpZXMoKSkge1xuICAgICAgaWYgKGVudHJ5LmV4cGlyZXNBdCA8PSBub3cpIHtcbiAgICAgICAgZXhwaXJlZEtleXMucHVzaChrZXkpO1xuICAgICAgfVxuICAgIH1cblxuICAgIGZvciAoY29uc3Qga2V5IG9mIGV4cGlyZWRLZXlzKSB7XG4gICAgICB0aGlzLmNhY2hlLmRlbGV0ZShrZXkpO1xuICAgICAgdGhpcy5zdGF0cy5leHBpcmVkKys7XG4gICAgfVxuXG4gICAgaWYgKGV4cGlyZWRLZXlzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMuZW1pdCgnY2xlYW51cCcsIHsgZXhwaXJlZENvdW50OiBleHBpcmVkS2V5cy5sZW5ndGgsIHJlbWFpbmluZ1NpemU6IHRoaXMuY2FjaGUuc2l6ZSB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRXZpY3QgbGVhc3QgcmVjZW50bHkgdXNlZCBlbnRyaWVzIHRvIG1ha2Ugc3BhY2VcbiAgICovXG4gIHByaXZhdGUgZXZpY3RMUlUoY291bnQ6IG51bWJlciA9IDEpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5jYWNoZS5zaXplID09PSAwKSByZXR1cm47XG5cbiAgICAvLyBTb3J0IGVudHJpZXMgYnkgbGFzdCBhY2Nlc3NlZCB0aW1lIChhc2NlbmRpbmcpXG4gICAgY29uc3QgZW50cmllcyA9IEFycmF5LmZyb20odGhpcy5jYWNoZS5lbnRyaWVzKCkpLnNvcnQoXG4gICAgICAoWywgYV0sIFssIGJdKSA9PiBhLmxhc3RBY2Nlc3NlZCAtIGIubGFzdEFjY2Vzc2VkXG4gICAgKTtcblxuICAgIC8vIFJlbW92ZSB0aGUgb2xkZXN0IGVudHJpZXNcbiAgICBjb25zdCBhY3R1YWxFdmljdENvdW50ID0gTWF0aC5taW4oY291bnQsIGVudHJpZXMubGVuZ3RoKTtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGFjdHVhbEV2aWN0Q291bnQ7IGkrKykge1xuICAgICAgY29uc3QgW2tleV0gPSBlbnRyaWVzW2ldO1xuICAgICAgdGhpcy5jYWNoZS5kZWxldGUoa2V5KTtcbiAgICAgIHRoaXMuc3RhdHMuZXZpY3Rpb25zKys7XG4gICAgfVxuXG4gICAgdGhpcy5lbWl0KCdldmljdGlvbicsIHsgZXZpY3RlZENvdW50OiBhY3R1YWxFdmljdENvdW50LCByZW1haW5pbmdTaXplOiB0aGlzLmNhY2hlLnNpemUgfSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGEgdmFsdWUgZnJvbSBjYWNoZVxuICAgKi9cbiAgZ2V0PFQgPSBhbnk+KGtleTogc3RyaW5nKTogVCB8IHVuZGVmaW5lZCB7XG4gICAgY29uc3QgZW50cnkgPSB0aGlzLmNhY2hlLmdldChrZXkpO1xuICAgIFxuICAgIGlmICghZW50cnkpIHtcbiAgICAgIHRoaXMuc3RhdHMubWlzc2VzKys7XG4gICAgICB0aGlzLmVtaXQoJ21pc3MnLCB7IGtleSB9KTtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgaWYgZW50cnkgaGFzIGV4cGlyZWRcbiAgICBpZiAoZW50cnkuZXhwaXJlc0F0IDw9IERhdGUubm93KCkpIHtcbiAgICAgIHRoaXMuY2FjaGUuZGVsZXRlKGtleSk7XG4gICAgICB0aGlzLnN0YXRzLmV4cGlyZWQrKztcbiAgICAgIHRoaXMuc3RhdHMubWlzc2VzKys7XG4gICAgICB0aGlzLmVtaXQoJ2V4cGlyZWQnLCB7IGtleSB9KTtcbiAgICAgIHJldHVybiB1bmRlZmluZWQ7XG4gICAgfVxuXG4gICAgLy8gVXBkYXRlIGFjY2VzcyBzdGF0aXN0aWNzXG4gICAgZW50cnkuYWNjZXNzQ291bnQrKztcbiAgICBlbnRyeS5sYXN0QWNjZXNzZWQgPSBEYXRlLm5vdygpO1xuICAgIHRoaXMuc3RhdHMuaGl0cysrO1xuICAgIFxuICAgIHRoaXMuZW1pdCgnaGl0JywgeyBrZXksIGFjY2Vzc0NvdW50OiBlbnRyeS5hY2Nlc3NDb3VudCB9KTtcbiAgICByZXR1cm4gZW50cnkudmFsdWUgYXMgVDtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgYSB2YWx1ZSBpbiBjYWNoZVxuICAgKi9cbiAgc2V0PFQgPSBhbnk+KGtleTogc3RyaW5nLCB2YWx1ZTogVCwgdHRsTXM/OiBudW1iZXIpOiB2b2lkIHtcbiAgICBjb25zdCBub3cgPSBEYXRlLm5vdygpO1xuICAgIGNvbnN0IGVmZmVjdGl2ZVR0bCA9IHR0bE1zICE9PSB1bmRlZmluZWQgPyB0dGxNcyA6IHRoaXMuZGVmYXVsdFR0bE1zO1xuICAgIGNvbnN0IGV4cGlyZXNBdCA9IGVmZmVjdGl2ZVR0bCA+IDAgPyBub3cgKyBlZmZlY3RpdmVUdGwgOiBub3c7IC8vIElmIFRUTCBpcyAwLCBleHBpcmUgaW1tZWRpYXRlbHlcblxuICAgIC8vIENoZWNrIGlmIHdlIG5lZWQgdG8gbWFrZSBzcGFjZVxuICAgIGlmICghdGhpcy5jYWNoZS5oYXMoa2V5KSAmJiB0aGlzLmNhY2hlLnNpemUgPj0gdGhpcy5tYXhTaXplKSB7XG4gICAgICAvLyBFdmljdCAxMCUgb2YgZW50cmllcyBvciBhdCBsZWFzdCAxXG4gICAgICBjb25zdCBldmljdENvdW50ID0gTWF0aC5tYXgoMSwgTWF0aC5mbG9vcih0aGlzLm1heFNpemUgKiAwLjEpKTtcbiAgICAgIHRoaXMuZXZpY3RMUlUoZXZpY3RDb3VudCk7XG4gICAgfVxuXG4gICAgLy8gU2V0IHRoZSBlbnRyeVxuICAgIHRoaXMuY2FjaGUuc2V0KGtleSwge1xuICAgICAgdmFsdWUsXG4gICAgICBleHBpcmVzQXQsXG4gICAgICBhY2Nlc3NDb3VudDogMCxcbiAgICAgIGxhc3RBY2Nlc3NlZDogbm93XG4gICAgfSk7XG5cbiAgICB0aGlzLmVtaXQoJ3NldCcsIHsgXG4gICAgICBrZXksIFxuICAgICAgdHRsTXM6IGVmZmVjdGl2ZVR0bCwgXG4gICAgICBzaXplOiB0aGlzLmNhY2hlLnNpemUsXG4gICAgICBleHBpcmVzQXQ6IG5ldyBEYXRlKGV4cGlyZXNBdCkudG9JU09TdHJpbmcoKVxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIERlbGV0ZSBhIHZhbHVlIGZyb20gY2FjaGVcbiAgICovXG4gIGRlbGV0ZShrZXk6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGNvbnN0IGV4aXN0ZWQgPSB0aGlzLmNhY2hlLmRlbGV0ZShrZXkpO1xuICAgIFxuICAgIGlmIChleGlzdGVkKSB7XG4gICAgICB0aGlzLmVtaXQoJ2RlbGV0ZScsIHsga2V5LCByZW1haW5pbmdTaXplOiB0aGlzLmNhY2hlLnNpemUgfSk7XG4gICAgfVxuICAgIFxuICAgIHJldHVybiBleGlzdGVkO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIGEga2V5IGV4aXN0cyBpbiBjYWNoZSAod2l0aG91dCB1cGRhdGluZyBhY2Nlc3Mgc3RhdHMpXG4gICAqL1xuICBoYXMoa2V5OiBzdHJpbmcpOiBib29sZWFuIHtcbiAgICBjb25zdCBlbnRyeSA9IHRoaXMuY2FjaGUuZ2V0KGtleSk7XG4gICAgXG4gICAgaWYgKCFlbnRyeSkge1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIENoZWNrIGlmIGVudHJ5IGhhcyBleHBpcmVkXG4gICAgaWYgKGVudHJ5LmV4cGlyZXNBdCA8PSBEYXRlLm5vdygpKSB7XG4gICAgICB0aGlzLmNhY2hlLmRlbGV0ZShrZXkpO1xuICAgICAgdGhpcy5zdGF0cy5leHBpcmVkKys7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKipcbiAgICogR2V0IG11bHRpcGxlIHZhbHVlcyBmcm9tIGNhY2hlXG4gICAqL1xuICBnZXRNdWx0aXBsZTxUID0gYW55PihrZXlzOiBzdHJpbmdbXSk6IE1hcDxzdHJpbmcsIFQ+IHtcbiAgICBjb25zdCByZXN1bHQgPSBuZXcgTWFwPHN0cmluZywgVD4oKTtcbiAgICBcbiAgICBmb3IgKGNvbnN0IGtleSBvZiBrZXlzKSB7XG4gICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuZ2V0PFQ+KGtleSk7XG4gICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICByZXN1bHQuc2V0KGtleSwgdmFsdWUpO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICByZXR1cm4gcmVzdWx0O1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCBtdWx0aXBsZSB2YWx1ZXMgaW4gY2FjaGVcbiAgICovXG4gIHNldE11bHRpcGxlPFQgPSBhbnk+KGVudHJpZXM6IE1hcDxzdHJpbmcsIFQ+LCB0dGxNcz86IG51bWJlcik6IHZvaWQge1xuICAgIGZvciAoY29uc3QgW2tleSwgdmFsdWVdIG9mIGVudHJpZXMuZW50cmllcygpKSB7XG4gICAgICB0aGlzLnNldChrZXksIHZhbHVlLCB0dGxNcyk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIERlbGV0ZSBtdWx0aXBsZSB2YWx1ZXMgZnJvbSBjYWNoZVxuICAgKi9cbiAgZGVsZXRlTXVsdGlwbGUoa2V5czogc3RyaW5nW10pOiBudW1iZXIge1xuICAgIGxldCBkZWxldGVkQ291bnQgPSAwO1xuICAgIFxuICAgIGZvciAoY29uc3Qga2V5IG9mIGtleXMpIHtcbiAgICAgIGlmICh0aGlzLmRlbGV0ZShrZXkpKSB7XG4gICAgICAgIGRlbGV0ZWRDb3VudCsrO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICByZXR1cm4gZGVsZXRlZENvdW50O1xuICB9XG5cbiAgLyoqXG4gICAqIENsZWFyIGFsbCBlbnRyaWVzIGZyb20gY2FjaGVcbiAgICovXG4gIGNsZWFyKCk6IHZvaWQge1xuICAgIGNvbnN0IHByZXZpb3VzU2l6ZSA9IHRoaXMuY2FjaGUuc2l6ZTtcbiAgICB0aGlzLmNhY2hlLmNsZWFyKCk7XG4gICAgXG4gICAgLy8gUmVzZXQgc3RhdHNcbiAgICB0aGlzLnN0YXRzID0ge1xuICAgICAgaGl0czogMCxcbiAgICAgIG1pc3NlczogMCxcbiAgICAgIGV2aWN0aW9uczogMCxcbiAgICAgIGV4cGlyZWQ6IDBcbiAgICB9O1xuICAgIFxuICAgIHRoaXMuZW1pdCgnY2xlYXInLCB7IHByZXZpb3VzU2l6ZSB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgYWxsIGtleXMgaW4gY2FjaGUgKGV4Y2x1ZGluZyBleHBpcmVkKVxuICAgKi9cbiAga2V5cygpOiBzdHJpbmdbXSB7XG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICBjb25zdCB2YWxpZEtleXM6IHN0cmluZ1tdID0gW107XG4gICAgXG4gICAgZm9yIChjb25zdCBba2V5LCBlbnRyeV0gb2YgdGhpcy5jYWNoZS5lbnRyaWVzKCkpIHtcbiAgICAgIGlmIChlbnRyeS5leHBpcmVzQXQgPiBub3cpIHtcbiAgICAgICAgdmFsaWRLZXlzLnB1c2goa2V5KTtcbiAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIHZhbGlkS2V5cztcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY2FjaGUgc3RhdGlzdGljc1xuICAgKi9cbiAgZ2V0U3RhdHMoKTogSW5NZW1vcnlDYWNoZVN0YXRzIHtcbiAgICBjb25zdCB0b3RhbFJlcXVlc3RzID0gdGhpcy5zdGF0cy5oaXRzICsgdGhpcy5zdGF0cy5taXNzZXM7XG4gICAgY29uc3QgaGl0UmF0ZSA9IHRvdGFsUmVxdWVzdHMgPiAwID8gKHRoaXMuc3RhdHMuaGl0cyAvIHRvdGFsUmVxdWVzdHMpICogMTAwIDogMDtcbiAgICBcbiAgICAvLyBFc3RpbWF0ZSBtZW1vcnkgdXNhZ2UgKHJvdWdoIGNhbGN1bGF0aW9uKVxuICAgIGxldCBlc3RpbWF0ZWRNZW1vcnlVc2FnZSA9IDA7XG4gICAgZm9yIChjb25zdCBba2V5LCBlbnRyeV0gb2YgdGhpcy5jYWNoZS5lbnRyaWVzKCkpIHtcbiAgICAgIC8vIFJvdWdoIGVzdGltYXRpb246IGtleSBzaXplICsgSlNPTiBzZXJpYWxpemVkIHZhbHVlIHNpemUgKyBvdmVyaGVhZFxuICAgICAgZXN0aW1hdGVkTWVtb3J5VXNhZ2UgKz0ga2V5Lmxlbmd0aCAqIDI7IC8vIFVURi0xNiBjaGFyYWN0ZXJzXG4gICAgICBlc3RpbWF0ZWRNZW1vcnlVc2FnZSArPSBKU09OLnN0cmluZ2lmeShlbnRyeS52YWx1ZSkubGVuZ3RoICogMjtcbiAgICAgIGVzdGltYXRlZE1lbW9yeVVzYWdlICs9IDY0OyAvLyBFc3RpbWF0ZWQgb3ZlcmhlYWQgcGVyIGVudHJ5XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHNpemU6IHRoaXMuY2FjaGUuc2l6ZSxcbiAgICAgIG1heFNpemU6IHRoaXMubWF4U2l6ZSxcbiAgICAgIGhpdHM6IHRoaXMuc3RhdHMuaGl0cyxcbiAgICAgIG1pc3NlczogdGhpcy5zdGF0cy5taXNzZXMsXG4gICAgICBldmljdGlvbnM6IHRoaXMuc3RhdHMuZXZpY3Rpb25zLFxuICAgICAgZXhwaXJlZDogdGhpcy5zdGF0cy5leHBpcmVkLFxuICAgICAgaGl0UmF0ZSxcbiAgICAgIG1lbW9yeVVzYWdlOiBlc3RpbWF0ZWRNZW1vcnlVc2FnZVxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogR2V0IGVudHJpZXMgdGhhdCB3aWxsIGV4cGlyZSBzb29uXG4gICAqL1xuICBnZXRFeHBpcmluZ0VudHJpZXMod2l0aGluTXM6IG51bWJlciA9IDYwMDAwKTogQXJyYXk8eyBrZXk6IHN0cmluZzsgZXhwaXJlc0F0OiBudW1iZXI7IHRpbWVMZWZ0OiBudW1iZXIgfT4ge1xuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgY29uc3QgdGhyZXNob2xkID0gbm93ICsgd2l0aGluTXM7XG4gICAgY29uc3QgZXhwaXJpbmdFbnRyaWVzOiBBcnJheTx7IGtleTogc3RyaW5nOyBleHBpcmVzQXQ6IG51bWJlcjsgdGltZUxlZnQ6IG51bWJlciB9PiA9IFtdO1xuXG4gICAgZm9yIChjb25zdCBba2V5LCBlbnRyeV0gb2YgdGhpcy5jYWNoZS5lbnRyaWVzKCkpIHtcbiAgICAgIGlmIChlbnRyeS5leHBpcmVzQXQgPD0gdGhyZXNob2xkICYmIGVudHJ5LmV4cGlyZXNBdCA+IG5vdykge1xuICAgICAgICBleHBpcmluZ0VudHJpZXMucHVzaCh7XG4gICAgICAgICAga2V5LFxuICAgICAgICAgIGV4cGlyZXNBdDogZW50cnkuZXhwaXJlc0F0LFxuICAgICAgICAgIHRpbWVMZWZ0OiBlbnRyeS5leHBpcmVzQXQgLSBub3dcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGV4cGlyaW5nRW50cmllcy5zb3J0KChhLCBiKSA9PiBhLnRpbWVMZWZ0IC0gYi50aW1lTGVmdCk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IG1vc3QgYWNjZXNzZWQgZW50cmllc1xuICAgKi9cbiAgZ2V0TW9zdEFjY2Vzc2VkKGxpbWl0OiBudW1iZXIgPSAxMCk6IEFycmF5PHsga2V5OiBzdHJpbmc7IGFjY2Vzc0NvdW50OiBudW1iZXI7IGxhc3RBY2Nlc3NlZDogbnVtYmVyIH0+IHtcbiAgICBjb25zdCBlbnRyaWVzID0gQXJyYXkuZnJvbSh0aGlzLmNhY2hlLmVudHJpZXMoKSlcbiAgICAgIC5tYXAoKFtrZXksIGVudHJ5XSkgPT4gKHtcbiAgICAgICAga2V5LFxuICAgICAgICBhY2Nlc3NDb3VudDogZW50cnkuYWNjZXNzQ291bnQsXG4gICAgICAgIGxhc3RBY2Nlc3NlZDogZW50cnkubGFzdEFjY2Vzc2VkXG4gICAgICB9KSlcbiAgICAgIC5zb3J0KChhLCBiKSA9PiBiLmFjY2Vzc0NvdW50IC0gYS5hY2Nlc3NDb3VudClcbiAgICAgIC5zbGljZSgwLCBsaW1pdCk7XG5cbiAgICByZXR1cm4gZW50cmllcztcbiAgfVxuXG4gIC8qKlxuICAgKiBVcGRhdGUgVFRMIGZvciBhbiBleGlzdGluZyBlbnRyeVxuICAgKi9cbiAgdXBkYXRlVFRMKGtleTogc3RyaW5nLCB0dGxNczogbnVtYmVyKTogYm9vbGVhbiB7XG4gICAgY29uc3QgZW50cnkgPSB0aGlzLmNhY2hlLmdldChrZXkpO1xuICAgIFxuICAgIGlmICghZW50cnkpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICAvLyBDaGVjayBpZiBlbnRyeSBoYXMgZXhwaXJlZFxuICAgIGlmIChlbnRyeS5leHBpcmVzQXQgPD0gRGF0ZS5ub3coKSkge1xuICAgICAgdGhpcy5jYWNoZS5kZWxldGUoa2V5KTtcbiAgICAgIHRoaXMuc3RhdHMuZXhwaXJlZCsrO1xuICAgICAgcmV0dXJuIGZhbHNlO1xuICAgIH1cblxuICAgIC8vIFVwZGF0ZSBleHBpcmF0aW9uIHRpbWVcbiAgICBlbnRyeS5leHBpcmVzQXQgPSBEYXRlLm5vdygpICsgdHRsTXM7XG4gICAgXG4gICAgdGhpcy5lbWl0KCd0dGxfdXBkYXRlZCcsIHsgXG4gICAgICBrZXksIFxuICAgICAgbmV3VHRsTXM6IHR0bE1zLCBcbiAgICAgIGV4cGlyZXNBdDogbmV3IERhdGUoZW50cnkuZXhwaXJlc0F0KS50b0lTT1N0cmluZygpIFxuICAgIH0pO1xuICAgIFxuICAgIHJldHVybiB0cnVlO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBUVEwgZm9yIGFuIGVudHJ5IChpbiBtaWxsaXNlY29uZHMpXG4gICAqL1xuICBnZXRUVEwoa2V5OiBzdHJpbmcpOiBudW1iZXIgfCBudWxsIHtcbiAgICBjb25zdCBlbnRyeSA9IHRoaXMuY2FjaGUuZ2V0KGtleSk7XG4gICAgXG4gICAgaWYgKCFlbnRyeSkge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgY29uc3Qgbm93ID0gRGF0ZS5ub3coKTtcbiAgICBcbiAgICAvLyBDaGVjayBpZiBlbnRyeSBoYXMgZXhwaXJlZFxuICAgIGlmIChlbnRyeS5leHBpcmVzQXQgPD0gbm93KSB7XG4gICAgICB0aGlzLmNhY2hlLmRlbGV0ZShrZXkpO1xuICAgICAgdGhpcy5zdGF0cy5leHBpcmVkKys7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICByZXR1cm4gZW50cnkuZXhwaXJlc0F0IC0gbm93O1xuICB9XG5cbiAgLyoqXG4gICAqIFNodXRkb3duIHRoZSBjYWNoZSBhbmQgY2xlYW51cCByZXNvdXJjZXNcbiAgICovXG4gIHNodXRkb3duKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmNsZWFudXBJbnRlcnZhbCkge1xuICAgICAgY2xlYXJJbnRlcnZhbCh0aGlzLmNsZWFudXBJbnRlcnZhbCk7XG4gICAgICB0aGlzLmNsZWFudXBJbnRlcnZhbCA9IG51bGw7XG4gICAgfVxuXG4gICAgdGhpcy5jbGVhcigpO1xuICAgIHRoaXMuZW1pdCgnc2h1dGRvd24nKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY3VycmVudCBzaXplXG4gICAqL1xuICBzaXplKCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuY2FjaGUuc2l6ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBjYWNoZSBpcyBlbXB0eVxuICAgKi9cbiAgaXNFbXB0eSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5jYWNoZS5zaXplID09PSAwO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIGNhY2hlIGlzIGZ1bGxcbiAgICovXG4gIGlzRnVsbCgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5jYWNoZS5zaXplID49IHRoaXMubWF4U2l6ZTtcbiAgfVxufSJdLCJ2ZXJzaW9uIjozfQ==
{"file":"/Users/ivan/Code/trading/titan/services/titan-brain/src/cache/CacheManager.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-brain/src/cache/CacheManager.ts"],"sourcesContent":["/**\n * CacheManager - Redis with in-memory fallback strategy\n * \n * Provides reliable caching with Redis as primary and in-memory as fallback.\n * Handles Redis unavailability gracefully for Railway deployment.\n * \n * Requirements: 3.2.1, 3.2.2, 3.2.3, 3.2.4, 3.2.5\n */\n\nimport { EventEmitter } from 'events';\nimport { createClient, RedisClientType } from 'redis';\nimport { InMemoryCache } from './InMemoryCache.js';\n\n/**\n * Cache configuration\n */\nexport interface CacheConfig {\n  redis?: {\n    url?: string;\n    host?: string;\n    port?: number;\n    password?: string;\n    db?: number;\n    connectTimeout?: number;\n    commandTimeout?: number;\n    retryDelayOnFailover?: number;\n    maxRetriesPerRequest?: number;\n  };\n  \n  // Fallback settings\n  enableInMemoryFallback: boolean;\n  inMemoryMaxSize: number;\n  inMemoryTtlMs: number;\n  \n  // Health check settings\n  healthCheckIntervalMs: number;\n  healthCheckTimeoutMs: number;\n  maxReconnectAttempts: number;\n  reconnectDelayMs: number;\n}\n\n/**\n * Cache operation result\n */\nexport interface CacheResult<T = any> {\n  success: boolean;\n  value?: T;\n  source: 'redis' | 'memory' | 'none';\n  error?: string;\n  duration: number;\n}\n\n/**\n * Cache metrics\n */\nexport interface CacheMetrics {\n  redisConnected: boolean;\n  redisHits: number;\n  redisMisses: number;\n  redisErrors: number;\n  memoryHits: number;\n  memoryMisses: number;\n  totalOperations: number;\n  averageResponseTime: number;\n  lastHealthCheck: number;\n  fallbackActive: boolean;\n}\n\n/**\n * Cache manager with Redis primary and in-memory fallback\n */\nexport class CacheManager extends EventEmitter {\n  private redisClient: RedisClientType | null = null;\n  private inMemoryCache: InMemoryCache;\n  private config: CacheConfig;\n  private metrics: CacheMetrics;\n  private healthCheckInterval: NodeJS.Timeout | null = null;\n  private reconnectAttempts: number = 0;\n  private isShuttingDown: boolean = false;\n  private responseTimeHistory: number[] = [];\n\n  constructor(config: CacheConfig) {\n    super();\n    this.config = config;\n    this.inMemoryCache = new InMemoryCache(config.inMemoryMaxSize, config.inMemoryTtlMs);\n    this.metrics = this.initializeMetrics();\n  }\n\n  /**\n   * Initialize metrics object\n   */\n  private initializeMetrics(): CacheMetrics {\n    return {\n      redisConnected: false,\n      redisHits: 0,\n      redisMisses: 0,\n      redisErrors: 0,\n      memoryHits: 0,\n      memoryMisses: 0,\n      totalOperations: 0,\n      averageResponseTime: 0,\n      lastHealthCheck: 0,\n      fallbackActive: false\n    };\n  }\n\n  /**\n   * Create cache configuration from environment variables\n   */\n  static createConfigFromEnv(): CacheConfig {\n    // Parse Railway REDIS_URL if available\n    const redisUrl = process.env.REDIS_URL;\n    let redisConfig: CacheConfig['redis'] = undefined;\n\n    if (redisUrl) {\n      redisConfig = { url: redisUrl };\n    } else if (process.env.REDIS_HOST) {\n      redisConfig = {\n        host: process.env.REDIS_HOST,\n        port: parseInt(process.env.REDIS_PORT || '6379'),\n        password: process.env.REDIS_PASSWORD,\n        db: parseInt(process.env.REDIS_DB || '0'),\n        connectTimeout: parseInt(process.env.REDIS_CONNECT_TIMEOUT || '10000'),\n        commandTimeout: parseInt(process.env.REDIS_COMMAND_TIMEOUT || '5000'),\n        retryDelayOnFailover: parseInt(process.env.REDIS_RETRY_DELAY || '100'),\n        maxRetriesPerRequest: parseInt(process.env.REDIS_MAX_RETRIES || '3')\n      };\n    }\n\n    return {\n      redis: redisConfig,\n      enableInMemoryFallback: process.env.CACHE_ENABLE_MEMORY_FALLBACK !== 'false',\n      inMemoryMaxSize: parseInt(process.env.CACHE_MEMORY_MAX_SIZE || '1000'),\n      inMemoryTtlMs: parseInt(process.env.CACHE_MEMORY_TTL || '300000'), // 5 minutes\n      healthCheckIntervalMs: parseInt(process.env.CACHE_HEALTH_CHECK_INTERVAL || '30000'),\n      healthCheckTimeoutMs: parseInt(process.env.CACHE_HEALTH_CHECK_TIMEOUT || '5000'),\n      maxReconnectAttempts: parseInt(process.env.CACHE_MAX_RECONNECT_ATTEMPTS || '5'),\n      reconnectDelayMs: parseInt(process.env.CACHE_RECONNECT_DELAY || '5000')\n    };\n  }\n\n  /**\n   * Initialize cache manager\n   */\n  async initialize(): Promise<void> {\n    // Initialize in-memory cache (always available)\n    this.inMemoryCache.initialize();\n\n    // Initialize Redis if configured\n    if (this.config.redis) {\n      await this.initializeRedis();\n    } else {\n      console.log('Redis not configured, using in-memory cache only');\n      this.metrics.fallbackActive = true;\n    }\n\n    // Start health check monitoring\n    this.startHealthCheckMonitoring();\n\n    this.emit('initialized', { \n      redisEnabled: !!this.config.redis,\n      fallbackActive: this.metrics.fallbackActive \n    });\n  }\n\n  /**\n   * Initialize Redis connection\n   */\n  private async initializeRedis(): Promise<void> {\n    if (!this.config.redis) return;\n\n    try {\n      // Create Redis client\n      this.redisClient = createClient({\n        url: this.config.redis.url,\n        socket: {\n          host: this.config.redis.host,\n          port: this.config.redis.port,\n          connectTimeout: this.config.redis.connectTimeout,\n          reconnectStrategy: (retries) => {\n            if (retries > this.config.maxReconnectAttempts) {\n              return false; // Stop reconnecting\n            }\n            return Math.min(retries * this.config.reconnectDelayMs, 30000);\n          }\n        },\n        commandsQueueMaxLength: this.config.redis.maxRetriesPerRequest || 3,\n        password: this.config.redis.password,\n        database: this.config.redis.db\n      });\n\n      // Set up Redis event listeners\n      this.setupRedisEventListeners();\n\n      // Connect to Redis\n      await this.redisClient.connect();\n      \n      this.metrics.redisConnected = true;\n      this.metrics.fallbackActive = false;\n      this.reconnectAttempts = 0;\n\n      this.emit('redis:connected');\n    } catch (error) {\n      console.warn('Failed to connect to Redis, using in-memory fallback:', error);\n      this.metrics.redisConnected = false;\n      this.metrics.fallbackActive = true;\n      this.redisClient = null;\n      \n      this.emit('redis:connection:failed', { \n        error: error instanceof Error ? error.message : 'Unknown error' \n      });\n    }\n  }\n\n  /**\n   * Set up Redis event listeners\n   */\n  private setupRedisEventListeners(): void {\n    if (!this.redisClient) return;\n\n    this.redisClient.on('connect', () => {\n      this.metrics.redisConnected = true;\n      this.metrics.fallbackActive = false;\n      this.reconnectAttempts = 0;\n      this.emit('redis:connected');\n    });\n\n    this.redisClient.on('ready', () => {\n      this.emit('redis:ready');\n    });\n\n    this.redisClient.on('error', (error) => {\n      this.metrics.redisErrors++;\n      this.metrics.redisConnected = false;\n      this.metrics.fallbackActive = true;\n      \n      this.emit('redis:error', { \n        error: error.message,\n        totalErrors: this.metrics.redisErrors \n      });\n    });\n\n    this.redisClient.on('end', () => {\n      this.metrics.redisConnected = false;\n      this.metrics.fallbackActive = true;\n      this.emit('redis:disconnected');\n    });\n\n    this.redisClient.on('reconnecting', () => {\n      this.reconnectAttempts++;\n      this.emit('redis:reconnecting', { \n        attempt: this.reconnectAttempts,\n        maxAttempts: this.config.maxReconnectAttempts \n      });\n    });\n  }\n\n  /**\n   * Start health check monitoring\n   */\n  private startHealthCheckMonitoring(): void {\n    if (this.healthCheckInterval) {\n      clearInterval(this.healthCheckInterval);\n    }\n\n    this.healthCheckInterval = setInterval(async () => {\n      await this.performHealthCheck();\n    }, this.config.healthCheckIntervalMs);\n  }\n\n  /**\n   * Perform health check\n   */\n  private async performHealthCheck(): Promise<void> {\n    if (this.isShuttingDown) return;\n\n    const startTime = Date.now();\n    \n    try {\n      if (this.redisClient && this.metrics.redisConnected) {\n        // Test Redis connection\n        await Promise.race([\n          this.redisClient.ping(),\n          new Promise((_, reject) => \n            setTimeout(() => reject(new Error('Redis health check timeout')), this.config.healthCheckTimeoutMs)\n          )\n        ]);\n        \n        this.metrics.lastHealthCheck = Date.now();\n        this.emit('health:check:success', { \n          source: 'redis',\n          duration: Date.now() - startTime \n        });\n      } else {\n        // Test in-memory cache\n        const testKey = '__health_check__';\n        const testValue = Date.now().toString();\n        \n        this.inMemoryCache.set(testKey, testValue, 1000); // 1 second TTL\n        const retrieved = this.inMemoryCache.get(testKey);\n        \n        if (retrieved !== testValue) {\n          throw new Error('In-memory cache health check failed');\n        }\n        \n        this.inMemoryCache.delete(testKey);\n        this.metrics.lastHealthCheck = Date.now();\n        \n        this.emit('health:check:success', { \n          source: 'memory',\n          duration: Date.now() - startTime \n        });\n      }\n    } catch (error) {\n      this.metrics.lastHealthCheck = Date.now();\n      this.emit('health:check:failure', { \n        error: error instanceof Error ? error.message : 'Unknown error',\n        duration: Date.now() - startTime\n      });\n    }\n  }\n\n  /**\n   * Get a value from cache\n   */\n  async get<T = any>(key: string): Promise<CacheResult<T>> {\n    const startTime = Date.now();\n    this.metrics.totalOperations++;\n\n    // Try Redis first if available\n    if (this.redisClient && this.metrics.redisConnected) {\n      try {\n        const value = await this.redisClient.get(key);\n        const duration = Date.now() - startTime;\n        this.updateResponseTimeMetrics(duration);\n\n        if (value !== null) {\n          this.metrics.redisHits++;\n          this.emit('cache:hit', { source: 'redis', key, duration });\n          \n          return {\n            success: true,\n            value: JSON.parse(value),\n            source: 'redis',\n            duration\n          };\n        } else {\n          this.metrics.redisMisses++;\n          this.emit('cache:miss', { source: 'redis', key, duration });\n          \n          return {\n            success: false,\n            source: 'redis',\n            duration\n          };\n        }\n      } catch (error) {\n        this.metrics.redisErrors++;\n        this.emit('cache:error', { \n          source: 'redis', \n          key, \n          error: error instanceof Error ? error.message : 'Unknown error' \n        });\n        \n        // Fall through to in-memory cache\n      }\n    }\n\n    // Use in-memory cache as fallback\n    if (this.config.enableInMemoryFallback) {\n      const value = this.inMemoryCache.get<T>(key);\n      const duration = Date.now() - startTime;\n      this.updateResponseTimeMetrics(duration);\n\n      if (value !== undefined) {\n        this.metrics.memoryHits++;\n        this.emit('cache:hit', { source: 'memory', key, duration });\n        \n        return {\n          success: true,\n          value,\n          source: 'memory',\n          duration\n        };\n      } else {\n        this.metrics.memoryMisses++;\n        this.emit('cache:miss', { source: 'memory', key, duration });\n        \n        return {\n          success: false,\n          source: 'memory',\n          duration\n        };\n      }\n    }\n\n    // No cache available\n    return {\n      success: false,\n      source: 'none',\n      duration: Date.now() - startTime\n    };\n  }\n\n  /**\n   * Set a value in cache\n   */\n  async set<T = any>(key: string, value: T, ttlSeconds?: number): Promise<CacheResult<void>> {\n    const startTime = Date.now();\n    this.metrics.totalOperations++;\n\n    // Try Redis first if available\n    if (this.redisClient && this.metrics.redisConnected) {\n      try {\n        const serializedValue = JSON.stringify(value);\n        \n        if (ttlSeconds) {\n          await this.redisClient.setEx(key, ttlSeconds, serializedValue);\n        } else {\n          await this.redisClient.set(key, serializedValue);\n        }\n        \n        const duration = Date.now() - startTime;\n        this.updateResponseTimeMetrics(duration);\n        this.emit('cache:set', { source: 'redis', key, duration });\n        \n        return {\n          success: true,\n          source: 'redis',\n          duration\n        };\n      } catch (error) {\n        this.metrics.redisErrors++;\n        this.emit('cache:error', { \n          source: 'redis', \n          key, \n          error: error instanceof Error ? error.message : 'Unknown error' \n        });\n        \n        // Fall through to in-memory cache\n      }\n    }\n\n    // Use in-memory cache as fallback\n    if (this.config.enableInMemoryFallback) {\n      const ttlMs = ttlSeconds ? ttlSeconds * 1000 : this.config.inMemoryTtlMs;\n      this.inMemoryCache.set(key, value, ttlMs);\n      \n      const duration = Date.now() - startTime;\n      this.updateResponseTimeMetrics(duration);\n      this.emit('cache:set', { source: 'memory', key, duration });\n      \n      return {\n        success: true,\n        source: 'memory',\n        duration\n      };\n    }\n\n    // No cache available\n    return {\n      success: false,\n      source: 'none',\n      duration: Date.now() - startTime,\n      error: 'No cache backend available'\n    };\n  }\n\n  /**\n   * Delete a value from cache\n   */\n  async delete(key: string): Promise<CacheResult<void>> {\n    const startTime = Date.now();\n    this.metrics.totalOperations++;\n\n    let redisSuccess = false;\n    let memorySuccess = false;\n\n    // Try Redis first if available\n    if (this.redisClient && this.metrics.redisConnected) {\n      try {\n        await this.redisClient.del(key);\n        redisSuccess = true;\n        this.emit('cache:delete', { source: 'redis', key });\n      } catch (error) {\n        this.metrics.redisErrors++;\n        this.emit('cache:error', { \n          source: 'redis', \n          key, \n          error: error instanceof Error ? error.message : 'Unknown error' \n        });\n      }\n    }\n\n    // Also delete from in-memory cache\n    if (this.config.enableInMemoryFallback) {\n      memorySuccess = this.inMemoryCache.delete(key);\n      if (memorySuccess) {\n        this.emit('cache:delete', { source: 'memory', key });\n      }\n    }\n\n    const duration = Date.now() - startTime;\n    this.updateResponseTimeMetrics(duration);\n\n    return {\n      success: redisSuccess || memorySuccess,\n      source: redisSuccess ? 'redis' : (memorySuccess ? 'memory' : 'none'),\n      duration\n    };\n  }\n\n  /**\n   * Clear all cache entries\n   */\n  async clear(): Promise<CacheResult<void>> {\n    const startTime = Date.now();\n    this.metrics.totalOperations++;\n\n    let redisSuccess = false;\n    let memorySuccess = false;\n\n    // Clear Redis if available\n    if (this.redisClient && this.metrics.redisConnected) {\n      try {\n        await this.redisClient.flushDb();\n        redisSuccess = true;\n        this.emit('cache:clear', { source: 'redis' });\n      } catch (error) {\n        this.metrics.redisErrors++;\n        this.emit('cache:error', { \n          source: 'redis', \n          error: error instanceof Error ? error.message : 'Unknown error' \n        });\n      }\n    }\n\n    // Clear in-memory cache\n    if (this.config.enableInMemoryFallback) {\n      this.inMemoryCache.clear();\n      memorySuccess = true;\n      this.emit('cache:clear', { source: 'memory' });\n    }\n\n    const duration = Date.now() - startTime;\n    this.updateResponseTimeMetrics(duration);\n\n    return {\n      success: redisSuccess || memorySuccess,\n      source: redisSuccess ? 'redis' : (memorySuccess ? 'memory' : 'none'),\n      duration\n    };\n  }\n\n  /**\n   * Update response time metrics\n   */\n  private updateResponseTimeMetrics(duration: number): void {\n    this.responseTimeHistory.push(duration);\n    \n    // Keep only last 100 operations for average calculation\n    if (this.responseTimeHistory.length > 100) {\n      this.responseTimeHistory.shift();\n    }\n    \n    // Calculate average response time\n    this.metrics.averageResponseTime = this.responseTimeHistory.reduce((sum, time) => sum + time, 0) / this.responseTimeHistory.length;\n  }\n\n  /**\n   * Get current cache metrics\n   */\n  getMetrics(): CacheMetrics {\n    return { ...this.metrics };\n  }\n\n  /**\n   * Check if cache is healthy\n   */\n  isHealthy(): boolean {\n    return this.metrics.redisConnected || this.metrics.fallbackActive;\n  }\n\n  /**\n   * Get cache status\n   */\n  getStatus(): {\n    redisConnected: boolean;\n    fallbackActive: boolean;\n    totalOperations: number;\n    hitRate: number;\n    averageResponseTime: number;\n  } {\n    const totalHits = this.metrics.redisHits + this.metrics.memoryHits;\n    const totalMisses = this.metrics.redisMisses + this.metrics.memoryMisses;\n    const hitRate = totalHits + totalMisses > 0 ? (totalHits / (totalHits + totalMisses)) * 100 : 0;\n\n    return {\n      redisConnected: this.metrics.redisConnected,\n      fallbackActive: this.metrics.fallbackActive,\n      totalOperations: this.metrics.totalOperations,\n      hitRate,\n      averageResponseTime: this.metrics.averageResponseTime\n    };\n  }\n\n  /**\n   * Gracefully shutdown the cache manager\n   */\n  async shutdown(): Promise<void> {\n    this.isShuttingDown = true;\n\n    // Stop health check monitoring\n    if (this.healthCheckInterval) {\n      clearInterval(this.healthCheckInterval);\n      this.healthCheckInterval = null;\n    }\n\n    // Disconnect Redis\n    if (this.redisClient) {\n      try {\n        await this.redisClient.disconnect();\n      } catch (error) {\n        console.warn('Error disconnecting Redis:', error);\n      }\n      this.redisClient = null;\n    }\n\n    // Clear in-memory cache\n    this.inMemoryCache.clear();\n\n    this.emit('shutdown');\n  }\n}"],"version":3}
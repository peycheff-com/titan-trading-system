{"file":"/Users/ivan/Code/trading/titan/services/titan-brain/src/services/CircuitBreaker.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-brain/src/services/CircuitBreaker.ts"],"sourcesContent":["/**\n * Circuit Breaker Implementation\n * \n * Implements the circuit breaker pattern to prevent cascade failures\n * when calling external services. The circuit breaker has three states:\n * - CLOSED: Normal operation, requests pass through\n * - OPEN: Circuit is open, requests fail fast\n * - HALF_OPEN: Testing if service has recovered\n */\n\nexport enum CircuitBreakerState {\n  CLOSED = 'CLOSED',\n  OPEN = 'OPEN',\n  HALF_OPEN = 'HALF_OPEN'\n}\n\nexport interface CircuitBreakerConfig {\n  /** Failure threshold to open circuit */\n  failureThreshold: number;\n  /** Success threshold to close circuit from half-open */\n  successThreshold: number;\n  /** Timeout in ms before trying half-open */\n  timeout: number;\n  /** Monitor window in ms for failure rate calculation */\n  monitoringWindow: number;\n  /** Expected failure rate (0-1) to trigger circuit opening */\n  expectedFailureRate: number;\n}\n\nexport interface CircuitBreakerStats {\n  state: CircuitBreakerState;\n  failureCount: number;\n  successCount: number;\n  lastFailureTime: number | null;\n  lastSuccessTime: number | null;\n  totalRequests: number;\n  failedRequests: number;\n  circuitOpenTime: number | null;\n}\n\nexport class CircuitBreakerError extends Error {\n  constructor(message: string, public readonly state: CircuitBreakerState) {\n    super(message);\n    this.name = 'CircuitBreakerError';\n  }\n}\n\nexport class CircuitBreaker {\n  private state: CircuitBreakerState = CircuitBreakerState.CLOSED;\n  private failureCount: number = 0;\n  private successCount: number = 0;\n  private lastFailureTime: number | null = null;\n  private lastSuccessTime: number | null = null;\n  private circuitOpenTime: number | null = null;\n  private totalRequests: number = 0;\n  private failedRequests: number = 0;\n  private readonly requestHistory: Array<{ timestamp: number; success: boolean }> = [];\n\n  constructor(\n    private readonly name: string,\n    private readonly config: CircuitBreakerConfig\n  ) {}\n\n  /**\n   * Execute a function with circuit breaker protection\n   */\n  async execute<T>(fn: () => Promise<T>): Promise<T> {\n    const canExecute = this.canExecute();\n    \n    if (!canExecute) {\n      throw new CircuitBreakerError(\n        `Circuit breaker '${this.name}' is ${this.state}. Request rejected.`,\n        this.state\n      );\n    }\n\n    this.totalRequests++;\n    const startTime = Date.now();\n\n    try {\n      const result = await fn();\n      this.onSuccess();\n      return result;\n    } catch (error) {\n      this.onFailure();\n      throw error;\n    }\n  }\n\n  /**\n   * Check if requests can be executed\n   */\n  private canExecute(): boolean {\n    const now = Date.now();\n\n    switch (this.state) {\n      case CircuitBreakerState.CLOSED:\n        return true;\n\n      case CircuitBreakerState.OPEN:\n        if (this.circuitOpenTime && (now - this.circuitOpenTime) >= this.config.timeout) {\n          this.state = CircuitBreakerState.HALF_OPEN;\n          this.successCount = 0;\n          return true;\n        }\n        return false;\n\n      case CircuitBreakerState.HALF_OPEN:\n        return true;\n\n      default:\n        return false;\n    }\n  }\n\n  /**\n   * Handle successful request\n   */\n  private onSuccess(): void {\n    this.lastSuccessTime = Date.now();\n    this.addToHistory(true);\n\n    switch (this.state) {\n      case CircuitBreakerState.HALF_OPEN:\n        this.successCount++;\n        if (this.successCount >= this.config.successThreshold) {\n          this.reset();\n        }\n        break;\n\n      case CircuitBreakerState.CLOSED:\n        this.failureCount = 0;\n        break;\n    }\n  }\n\n  /**\n   * Handle failed request\n   */\n  private onFailure(): void {\n    this.lastFailureTime = Date.now();\n    this.failedRequests++;\n    this.addToHistory(false);\n\n    switch (this.state) {\n      case CircuitBreakerState.CLOSED:\n        this.failureCount++;\n        if (this.shouldOpenCircuit()) {\n          this.openCircuit();\n        }\n        break;\n\n      case CircuitBreakerState.HALF_OPEN:\n        this.openCircuit();\n        break;\n    }\n  }\n\n  /**\n   * Add request result to history for monitoring\n   */\n  private addToHistory(success: boolean): void {\n    const now = Date.now();\n    this.requestHistory.push({ timestamp: now, success });\n\n    // Clean old entries outside monitoring window\n    const cutoff = now - this.config.monitoringWindow;\n    while (this.requestHistory.length > 0 && this.requestHistory[0].timestamp < cutoff) {\n      this.requestHistory.shift();\n    }\n  }\n\n  /**\n   * Determine if circuit should be opened based on failure rate\n   */\n  private shouldOpenCircuit(): boolean {\n    // Check failure count threshold\n    if (this.failureCount >= this.config.failureThreshold) {\n      return true;\n    }\n\n    // Check failure rate within monitoring window\n    if (this.requestHistory.length === 0) {\n      return false;\n    }\n\n    const recentFailures = this.requestHistory.filter(req => !req.success).length;\n    const failureRate = recentFailures / this.requestHistory.length;\n\n    return failureRate >= this.config.expectedFailureRate;\n  }\n\n  /**\n   * Open the circuit breaker\n   */\n  private openCircuit(): void {\n    this.state = CircuitBreakerState.OPEN;\n    this.circuitOpenTime = Date.now();\n    this.failureCount = 0;\n    this.successCount = 0;\n  }\n\n  /**\n   * Reset circuit breaker to closed state\n   */\n  private reset(): void {\n    this.state = CircuitBreakerState.CLOSED;\n    this.failureCount = 0;\n    this.successCount = 0;\n    this.circuitOpenTime = null;\n  }\n\n  /**\n   * Get current circuit breaker statistics\n   */\n  getStats(): CircuitBreakerStats {\n    return {\n      state: this.state,\n      failureCount: this.failureCount,\n      successCount: this.successCount,\n      lastFailureTime: this.lastFailureTime,\n      lastSuccessTime: this.lastSuccessTime,\n      totalRequests: this.totalRequests,\n      failedRequests: this.failedRequests,\n      circuitOpenTime: this.circuitOpenTime\n    };\n  }\n\n  /**\n   * Get current failure rate within monitoring window\n   */\n  getCurrentFailureRate(): number {\n    if (this.requestHistory.length === 0) {\n      return 0;\n    }\n\n    const failures = this.requestHistory.filter(req => !req.success).length;\n    return failures / this.requestHistory.length;\n  }\n\n  /**\n   * Force circuit breaker to open (for testing or manual intervention)\n   */\n  forceOpen(): void {\n    this.openCircuit();\n  }\n\n  /**\n   * Force circuit breaker to close (for testing or manual intervention)\n   */\n  forceClose(): void {\n    this.reset();\n  }\n\n  /**\n   * Get circuit breaker name\n   */\n  getName(): string {\n    return this.name;\n  }\n}\n\n/**\n * Default circuit breaker configurations for different service types\n */\nexport const CircuitBreakerDefaults = {\n  /** Configuration for critical services (database, auth) */\n  CRITICAL: {\n    failureThreshold: 5,\n    successThreshold: 3,\n    timeout: 60000, // 1 minute\n    monitoringWindow: 300000, // 5 minutes\n    expectedFailureRate: 0.5 // 50% failure rate\n  } as CircuitBreakerConfig,\n\n  /** Configuration for important services (external APIs) */\n  IMPORTANT: {\n    failureThreshold: 10,\n    successThreshold: 5,\n    timeout: 30000, // 30 seconds\n    monitoringWindow: 180000, // 3 minutes\n    expectedFailureRate: 0.6 // 60% failure rate\n  } as CircuitBreakerConfig,\n\n  /** Configuration for optional services (metrics, logging) */\n  OPTIONAL: {\n    failureThreshold: 15,\n    successThreshold: 3,\n    timeout: 10000, // 10 seconds\n    monitoringWindow: 60000, // 1 minute\n    expectedFailureRate: 0.8 // 80% failure rate\n  } as CircuitBreakerConfig\n};"],"version":3}
{"file":"/Users/ivan/Code/trading/titan/services/titan-brain/src/engine/AllocationEngine.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-brain/src/engine/AllocationEngine.ts"],"sourcesContent":["/**\n * AllocationEngine - Calculates base allocation weights for each phase\n * Uses sigmoid transition functions for smooth phase transitions\n * \n * Requirements: 1.2, 1.3, 1.4, 1.5, 1.6, 3.4\n */\n\nimport {\n  AllocationVector,\n  AllocationEngineConfig,\n  EquityTier,\n  LeverageCaps,\n  TransitionPoints,\n} from '../types/index.js';\n\n/**\n * AllocationEngine calculates capital allocation across Titan phases\n * based on current equity using sigmoid transition functions.\n */\nexport class AllocationEngine {\n  private readonly transitionPoints: TransitionPoints;\n  private readonly leverageCaps: LeverageCaps;\n\n  constructor(config: AllocationEngineConfig) {\n    this.transitionPoints = config.transitionPoints;\n    this.leverageCaps = config.leverageCaps;\n  }\n\n  /**\n   * Sigmoid function for smooth transitions\n   * Returns value between 0 and 1\n   * @param x - Input value\n   * @param midpoint - Center of transition\n   * @param steepness - How sharp the transition is (higher = sharper)\n   */\n  private sigmoid(x: number, midpoint: number, steepness: number = 0.002): number {\n    return 1 / (1 + Math.exp(-steepness * (x - midpoint)));\n  }\n\n  /**\n   * Calculate allocation weights for each phase based on current equity\n   * \n   * Transition logic:\n   * - Below $1,500: 100% Phase 1\n   * - $1,500 - $5,000: Sigmoid transition from Phase 1 to Phase 2\n   * - $5,000 - $25,000: 20% Phase 1, 80% Phase 2\n   * - Above $25,000: Begin transition to Phase 3\n   * \n   * @param equity - Current account equity in USD\n   * @returns AllocationVector with weights summing to 1.0\n   */\n  getWeights(equity: number): AllocationVector {\n    const { startP2, fullP2, startP3 } = this.transitionPoints;\n    const timestamp = Date.now();\n\n    // Ensure equity is non-negative\n    const safeEquity = Math.max(0, equity);\n\n    // Phase 1 only (MICRO tier)\n    if (safeEquity < startP2) {\n      return { w1: 1.0, w2: 0.0, w3: 0.0, timestamp };\n    }\n\n    // Transition zone: Phase 1 â†’ Phase 2\n    if (safeEquity < fullP2) {\n      // Sigmoid transition from 100% P1 to 20% P1 / 80% P2\n      const transitionMidpoint = (startP2 + fullP2) / 2;\n      const progress = this.sigmoid(safeEquity, transitionMidpoint, 0.003);\n      \n      // w1 goes from 1.0 to 0.2, w2 goes from 0.0 to 0.8\n      const w1 = 1.0 - (0.8 * progress);\n      const w2 = 0.8 * progress;\n      const w3 = 0.0;\n\n      return this.normalizeWeights({ w1, w2, w3, timestamp });\n    }\n\n    // Stable zone: 20% P1, 80% P2 (before P3 transition)\n    if (safeEquity < startP3) {\n      return { w1: 0.2, w2: 0.8, w3: 0.0, timestamp };\n    }\n\n    // Transition to Phase 3 (above $25,000)\n    // P3 gradually takes from P2, P1 stays at 20%\n    const p3TransitionMidpoint = startP3 + 12500; // $37,500 midpoint\n    const p3Progress = this.sigmoid(safeEquity, p3TransitionMidpoint, 0.0002);\n\n    // w3 goes from 0 to 0.5 (max 50% to P3)\n    // w2 goes from 0.8 to 0.3\n    // w1 stays at 0.2\n    const w1 = 0.2;\n    const w3 = 0.5 * p3Progress;\n    const w2 = 0.8 - w3;\n\n    return this.normalizeWeights({ w1, w2, w3, timestamp });\n  }\n\n  /**\n   * Normalize weights to ensure they sum to exactly 1.0\n   * Handles floating point precision issues\n   */\n  private normalizeWeights(vector: AllocationVector): AllocationVector {\n    const sum = vector.w1 + vector.w2 + vector.w3;\n    \n    if (sum === 0) {\n      // Fallback to Phase 1 only if all weights are 0\n      return { w1: 1.0, w2: 0.0, w3: 0.0, timestamp: vector.timestamp };\n    }\n\n    return {\n      w1: vector.w1 / sum,\n      w2: vector.w2 / sum,\n      w3: vector.w3 / sum,\n      timestamp: vector.timestamp,\n    };\n  }\n\n  /**\n   * Determine the equity tier based on current equity\n   * \n   * Tier boundaries:\n   * - MICRO: < $1,500\n   * - SMALL: $1,500 - $5,000\n   * - MEDIUM: $5,000 - $25,000\n   * - LARGE: $25,000 - $50,000\n   * - INSTITUTIONAL: > $50,000\n   * \n   * @param equity - Current account equity in USD\n   * @returns EquityTier classification\n   */\n  getEquityTier(equity: number): EquityTier {\n    const safeEquity = Math.max(0, equity);\n\n    if (safeEquity < 1500) {\n      return EquityTier.MICRO;\n    }\n    if (safeEquity < 5000) {\n      return EquityTier.SMALL;\n    }\n    if (safeEquity < 25000) {\n      return EquityTier.MEDIUM;\n    }\n    if (safeEquity < 50000) {\n      return EquityTier.LARGE;\n    }\n    return EquityTier.INSTITUTIONAL;\n  }\n\n  /**\n   * Get maximum allowed leverage for the current equity tier\n   * \n   * Leverage caps by tier:\n   * - MICRO: 20x\n   * - SMALL: 10x\n   * - MEDIUM: 5x\n   * - LARGE: 3x\n   * - INSTITUTIONAL: 2x\n   * \n   * @param equity - Current account equity in USD\n   * @returns Maximum leverage multiplier\n   */\n  getMaxLeverage(equity: number): number {\n    const tier = this.getEquityTier(equity);\n    return this.leverageCaps[tier];\n  }\n\n  /**\n   * Get the transition points configuration\n   */\n  getTransitionPoints(): TransitionPoints {\n    return { ...this.transitionPoints };\n  }\n\n  /**\n   * Get the leverage caps configuration\n   */\n  getLeverageCaps(): LeverageCaps {\n    return { ...this.leverageCaps };\n  }\n}\n"],"version":3}
b62ae79707eaf8f1ac8ac39269153b04
"use strict";
/**
 * CapitalFlowManager - Manages profit sweeping from futures to spot wallet
 * Implements ratchet mechanism to lock in profits
 *
 * Requirements: 4.1, 4.2, 4.3, 4.4, 4.5
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.CapitalFlowManager = void 0;
/**
 * CapitalFlowManager manages profit sweeping from the risky futures wallet
 * to the safe spot wallet using a ratchet mechanism.
 */
class CapitalFlowManager {
    config;
    db;
    exchangeAPI;
    /** Cached high watermark value */
    highWatermark = 0;
    /** Cached total swept amount */
    totalSwept = 0;
    /** Target allocation for futures wallet (set externally) */
    targetAllocation = 0;
    /** Sweep notifier */
    sweepNotifier = null;
    constructor(config, db, exchangeAPI) {
        this.config = config;
        this.db = db ?? null;
        this.exchangeAPI = exchangeAPI ?? null;
    }
    /**
     * Set the sweep notifier
     */
    setSweepNotifier(notifier) {
        this.sweepNotifier = notifier;
    }
    /**
     * Initialize the manager by loading state from database
     */
    async initialize() {
        if (this.db) {
            await this.loadHighWatermark();
            await this.loadTotalSwept();
        }
    }
    /**
     * Load high watermark from database
     */
    async loadHighWatermark() {
        if (!this.db)
            return;
        const result = await this.db.query(`SELECT value FROM high_watermark ORDER BY updated_at DESC LIMIT 1`);
        if (result.rows.length > 0) {
            this.highWatermark = parseFloat(result.rows[0].value);
        }
    }
    /**
     * Load total swept amount from database
     */
    async loadTotalSwept() {
        if (!this.db)
            return;
        const result = await this.db.query(`SELECT COALESCE(SUM(amount), 0) as total 
       FROM treasury_operations 
       WHERE operation_type = 'SWEEP' AND to_wallet = 'SPOT'`);
        if (result.rows.length > 0) {
            this.totalSwept = parseFloat(result.rows[0].total);
        }
    }
    /**
     * Set the target allocation for futures wallet
     * This is typically set by the Brain based on current equity and allocation
     *
     * @param amount - Target allocation in USD
     */
    setTargetAllocation(amount) {
        this.targetAllocation = Math.max(0, amount);
    }
    /**
     * Get the current high watermark
     *
     * @returns High watermark value in USD
     */
    getHighWatermark() {
        return this.highWatermark;
    }
    /**
     * Set high watermark value (for state recovery)
     *
     * @param value - High watermark value in USD
     */
    async setHighWatermark(value) {
        if (value <= 0) {
            console.warn(`Invalid high watermark value: ${value}`);
            return;
        }
        this.highWatermark = value;
        // Persist to database
        if (this.db) {
            await this.db.query(`INSERT INTO high_watermark (value, updated_at) VALUES ($1, $2)`, [value, Date.now()]);
        }
        console.log(`High watermark set to $${value}`);
    }
    /**
     * Update the high watermark if equity exceeds current watermark
     * Requirement 4.1: Track High Watermark for Futures Wallet balance
     *
     * Property 10: High Watermark Monotonicity - watermark should never decrease
     *
     * @param equity - Current equity in USD
     * @returns true if watermark was updated
     */
    async updateHighWatermark(equity) {
        // Only update if new equity exceeds current watermark
        if (equity <= this.highWatermark) {
            return false;
        }
        const previousWatermark = this.highWatermark;
        this.highWatermark = equity;
        // Persist to database
        if (this.db) {
            await this.db.query(`INSERT INTO high_watermark (value, updated_at) VALUES ($1, $2)`, [equity, Date.now()]);
        }
        return true;
    }
    /**
     * Check if sweep conditions are met
     * Requirement 4.2: Sweep when Futures Wallet exceeds Target Allocation by 20%
     *
     * @returns SweepDecision with sweep details
     */
    async checkSweepConditions() {
        // Get current futures balance
        const futuresBalance = await this.getFuturesBalance();
        // Calculate threshold (target allocation * sweep threshold)
        const sweepTriggerLevel = this.targetAllocation * this.config.sweepThreshold;
        // Check if we exceed the threshold
        if (futuresBalance <= sweepTriggerLevel) {
            return {
                shouldSweep: false,
                amount: 0,
                reason: 'Futures balance does not exceed sweep threshold',
                futuresBalance,
                targetAllocation: this.targetAllocation,
            };
        }
        // Requirement 4.3: Calculate excess profit
        const excessAmount = futuresBalance - sweepTriggerLevel;
        // Requirement 4.5: Ensure reserve limit is maintained
        // Property 5: Reserve Limit Protection - remaining balance >= reserveLimit
        const maxSweepable = futuresBalance - this.config.reserveLimit;
        if (maxSweepable <= 0) {
            return {
                shouldSweep: false,
                amount: 0,
                reason: `Cannot sweep: would violate reserve limit of $${this.config.reserveLimit}`,
                futuresBalance,
                targetAllocation: this.targetAllocation,
            };
        }
        // Sweep amount is the minimum of excess and max sweepable
        const sweepAmount = Math.min(excessAmount, maxSweepable);
        if (sweepAmount <= 0) {
            return {
                shouldSweep: false,
                amount: 0,
                reason: 'No excess to sweep after reserve limit',
                futuresBalance,
                targetAllocation: this.targetAllocation,
            };
        }
        return {
            shouldSweep: true,
            amount: sweepAmount,
            reason: `Excess of $${sweepAmount.toFixed(2)} detected (${((futuresBalance / this.targetAllocation - 1) * 100).toFixed(1)}% over target)`,
            futuresBalance,
            targetAllocation: this.targetAllocation,
        };
    }
    /**
     * Execute a profit sweep from futures to spot wallet
     * Requirement 4.4: Transfer excess USDT to Spot Wallet
     * Requirement 4.8: Retry up to 3 times with exponential backoff
     *
     * Property 4: Sweep Monotonicity - totalSwept should only increase
     *
     * @param amount - Amount to sweep in USD
     * @returns SweepResult with transaction details
     */
    async executeSweep(amount) {
        const timestamp = Date.now();
        // Validate amount
        if (amount <= 0) {
            return {
                success: false,
                amount: 0,
                error: 'Invalid sweep amount: must be positive',
                timestamp,
            };
        }
        // Check reserve limit before sweep
        const futuresBalance = await this.getFuturesBalance();
        const remainingAfterSweep = futuresBalance - amount;
        if (remainingAfterSweep < this.config.reserveLimit) {
            return {
                success: false,
                amount: 0,
                error: `Sweep would violate reserve limit: $${remainingAfterSweep.toFixed(2)} < $${this.config.reserveLimit}`,
                timestamp,
            };
        }
        // Execute transfer with retry logic
        let lastError;
        for (let attempt = 1; attempt <= this.config.maxRetries; attempt++) {
            try {
                const result = await this.executeTransfer(amount);
                if (result.success) {
                    // Update total swept (monotonically increasing)
                    this.totalSwept += amount;
                    // Log the operation
                    await this.logTreasuryOperation({
                        timestamp,
                        operationType: 'SWEEP',
                        amount,
                        fromWallet: 'FUTURES',
                        toWallet: 'SPOT',
                        reason: `Automated profit sweep (attempt ${attempt})`,
                        highWatermark: this.highWatermark,
                    });
                    // Send sweep notification
                    if (this.sweepNotifier) {
                        try {
                            const newBalance = await this.getFuturesBalance();
                            await this.sweepNotifier.sendSweepNotification(amount, 'FUTURES', 'SPOT', `Automated profit sweep (attempt ${attempt})`, newBalance);
                        }
                        catch (error) {
                            console.error('Failed to send sweep notification:', error);
                        }
                    }
                    return {
                        success: true,
                        amount,
                        transactionId: result.transactionId,
                        timestamp,
                    };
                }
                lastError = result.error;
            }
            catch (error) {
                lastError = error instanceof Error ? error.message : 'Unknown error';
            }
            // Exponential backoff before retry
            if (attempt < this.config.maxRetries) {
                const delay = this.config.retryBaseDelay * Math.pow(2, attempt - 1);
                await this.sleep(delay);
            }
        }
        return {
            success: false,
            amount: 0,
            error: `Sweep failed after ${this.config.maxRetries} attempts: ${lastError}`,
            timestamp,
        };
    }
    /**
     * Execute the actual transfer via exchange API
     */
    async executeTransfer(amount) {
        if (!this.exchangeAPI) {
            // Mock success for testing without exchange API
            return {
                success: true,
                transactionId: `mock-${Date.now()}`,
            };
        }
        return this.exchangeAPI.transferToSpot(amount);
    }
    /**
     * Get current treasury status
     * Requirement 8.1-8.7: Treasury management visibility
     *
     * @returns TreasuryStatus with all wallet balances and metrics
     */
    async getTreasuryStatus() {
        const futuresWallet = await this.getFuturesBalance();
        const spotWallet = await this.getSpotBalance();
        return {
            futuresWallet,
            spotWallet,
            totalSwept: this.totalSwept,
            highWatermark: this.highWatermark,
            lockedProfit: this.totalSwept, // Locked profit equals total swept
            riskCapital: futuresWallet, // Risk capital is futures balance
        };
    }
    /**
     * Get futures wallet balance
     */
    async getFuturesBalance() {
        if (!this.exchangeAPI) {
            // Return 0 if no exchange API configured
            return 0;
        }
        return this.exchangeAPI.getFuturesBalance();
    }
    /**
     * Get spot wallet balance
     */
    async getSpotBalance() {
        if (!this.exchangeAPI) {
            // Return 0 if no exchange API configured
            return 0;
        }
        return this.exchangeAPI.getSpotBalance();
    }
    /**
     * Log a treasury operation to the database
     * Requirement 4.7: Log all sweep transactions
     */
    async logTreasuryOperation(operation) {
        if (!this.db)
            return;
        await this.db.query(`INSERT INTO treasury_operations 
       (timestamp, operation_type, amount, from_wallet, to_wallet, reason, high_watermark)
       VALUES ($1, $2, $3, $4, $5, $6, $7)`, [
            operation.timestamp,
            operation.operationType,
            operation.amount,
            operation.fromWallet,
            operation.toWallet,
            operation.reason ?? null,
            operation.highWatermark,
        ]);
    }
    /**
     * Get sweep history from database
     *
     * @param limit - Maximum number of records to return
     * @returns Array of treasury operations
     */
    async getSweepHistory(limit = 100) {
        if (!this.db)
            return [];
        const result = await this.db.query(`SELECT id, timestamp, operation_type, amount, from_wallet, to_wallet, reason, high_watermark
       FROM treasury_operations
       WHERE operation_type = 'SWEEP'
       ORDER BY timestamp DESC
       LIMIT $1`, [limit]);
        return result.rows.map((row) => ({
            id: row.id,
            timestamp: parseInt(row.timestamp, 10),
            operationType: row.operation_type,
            amount: parseFloat(row.amount),
            fromWallet: row.from_wallet,
            toWallet: row.to_wallet,
            reason: row.reason ?? undefined,
            highWatermark: parseFloat(row.high_watermark),
        }));
    }
    /**
     * Calculate the next sweep trigger level
     *
     * @returns The futures balance level that would trigger a sweep
     */
    getNextSweepTriggerLevel() {
        return this.targetAllocation * this.config.sweepThreshold;
    }
    /**
     * Get the total amount swept since inception
     *
     * @returns Total swept amount in USD
     */
    getTotalSwept() {
        return this.totalSwept;
    }
    /**
     * Get the current target allocation
     *
     * @returns Target allocation in USD
     */
    getTargetAllocation() {
        return this.targetAllocation;
    }
    /**
     * Get the reserve limit
     *
     * @returns Reserve limit in USD
     */
    getReserveLimit() {
        return this.config.reserveLimit;
    }
    /**
     * Get configuration
     */
    getConfig() {
        return { ...this.config };
    }
    /**
     * Sleep utility for retry delays
     */
    sleep(ms) {
        return new Promise((resolve) => setTimeout(resolve, ms));
    }
    /**
     * Check if a sweep should be triggered based on equity increase
     * Requirement 4.6: Sweep after trades that increase equity by > 10%
     *
     * @param previousEquity - Equity before the trade
     * @param currentEquity - Equity after the trade
     * @returns true if equity increased by more than 10%
     */
    shouldTriggerSweepOnEquityIncrease(previousEquity, currentEquity) {
        if (previousEquity <= 0)
            return false;
        const percentIncrease = (currentEquity - previousEquity) / previousEquity;
        return percentIncrease > 0.10; // 10% threshold
    }
    /**
     * Perform a full sweep check and execution if conditions are met
     * Convenience method that combines checkSweepConditions and executeSweep
     *
     * @returns SweepResult if sweep was attempted, null if conditions not met
     */
    async performSweepIfNeeded() {
        const decision = await this.checkSweepConditions();
        if (!decision.shouldSweep) {
            return null;
        }
        return this.executeSweep(decision.amount);
    }
}
exports.CapitalFlowManager = CapitalFlowManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLWJyYWluL3NyYy9lbmdpbmUvQ2FwaXRhbEZsb3dNYW5hZ2VyLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7R0FLRzs7O0FBcUNIOzs7R0FHRztBQUNILE1BQWEsa0JBQWtCO0lBQ1osTUFBTSxDQUFvQjtJQUMxQixFQUFFLENBQXlCO0lBQzNCLFdBQVcsQ0FBMkI7SUFFdkQsa0NBQWtDO0lBQzFCLGFBQWEsR0FBVyxDQUFDLENBQUM7SUFDbEMsZ0NBQWdDO0lBQ3hCLFVBQVUsR0FBVyxDQUFDLENBQUM7SUFDL0IsNERBQTREO0lBQ3BELGdCQUFnQixHQUFXLENBQUMsQ0FBQztJQUNyQyxxQkFBcUI7SUFDYixhQUFhLEdBQXlCLElBQUksQ0FBQztJQUVuRCxZQUNFLE1BQXlCLEVBQ3pCLEVBQW9CLEVBQ3BCLFdBQStCO1FBRS9CLElBQUksQ0FBQyxNQUFNLEdBQUcsTUFBTSxDQUFDO1FBQ3JCLElBQUksQ0FBQyxFQUFFLEdBQUcsRUFBRSxJQUFJLElBQUksQ0FBQztRQUNyQixJQUFJLENBQUMsV0FBVyxHQUFHLFdBQVcsSUFBSSxJQUFJLENBQUM7SUFDekMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsZ0JBQWdCLENBQUMsUUFBdUI7UUFDdEMsSUFBSSxDQUFDLGFBQWEsR0FBRyxRQUFRLENBQUM7SUFDaEMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsS0FBSyxDQUFDLFVBQVU7UUFDZCxJQUFJLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQztZQUNaLE1BQU0sSUFBSSxDQUFDLGlCQUFpQixFQUFFLENBQUM7WUFDL0IsTUFBTSxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDOUIsQ0FBQztJQUNILENBQUM7SUFHRDs7T0FFRztJQUNLLEtBQUssQ0FBQyxpQkFBaUI7UUFDN0IsSUFBSSxDQUFDLElBQUksQ0FBQyxFQUFFO1lBQUUsT0FBTztRQUVyQixNQUFNLE1BQU0sR0FBRyxNQUFNLElBQUksQ0FBQyxFQUFFLENB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LElBQUksT0FBTyxDQUFDLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxVQUFVLENBQUMsT0FBTyxFQUFFLEVBQUUsQ0FBQyxDQUFDLENBQUM7SUFDM0QsQ0FBQztJQUVEOzs7Ozs7O09BT0c7SUFDSCxrQ0FBa0MsQ0FDaEMsY0FBc0IsRUFDdEIsYUFBcUI7UUFFckIsSUFBSSxjQUFjLElBQUksQ0FBQztZQUFFLE9BQU8sS0FBSyxDQUFDO1FBRXRDLE1BQU0sZUFBZSxHQUFHLENBQUMsYUFBYSxHQUFHLGNBQWMsQ0FBQyxHQUFHLGNBQWMsQ0FBQztRQUMxRSxPQUFPLGVBQWUsR0FBRyxJQUFJLENBQUMsQ0FBQyxnQkFBZ0I7SUFDakQsQ0FBQztJQUVEOzs7OztPQUtHO0lBQ0gsS0FBSyxDQUFDLG9CQUFvQjtRQUN4QixNQUFNLFFBQVEsR0FBRyxNQUFNLElBQUksQ0FBQyxvQkFBb0IsRUFBRSxDQUFDO1FBRW5ELElBQUksQ0FBQyxRQUFRLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDMUIsT0FBTyxJQUFJLENBQUM7UUFDZCxDQUFDO1FBRUQsT0FBTyxJQUFJLENBQUMsWUFBWSxDQUFDLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztJQUM1QyxDQUFDO0NBQ0Y7QUFyZ0JELGdEQXFnQkMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLWJyYWluL3NyYy9lbmdpbmUvQ2FwaXRhbEZsb3dNYW5hZ2VyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ2FwaXRhbEZsb3dNYW5hZ2VyIC0gTWFuYWdlcyBwcm9maXQgc3dlZXBpbmcgZnJvbSBmdXR1cmVzIHRvIHNwb3Qgd2FsbGV0XG4gKiBJbXBsZW1lbnRzIHJhdGNoZXQgbWVjaGFuaXNtIHRvIGxvY2sgaW4gcHJvZml0c1xuICogXG4gKiBSZXF1aXJlbWVudHM6IDQuMSwgNC4yLCA0LjMsIDQuNCwgNC41XG4gKi9cblxuaW1wb3J0IHtcbiAgU3dlZXBEZWNpc2lvbixcbiAgU3dlZXBSZXN1bHQsXG4gIFRyZWFzdXJ5U3RhdHVzLFxuICBUcmVhc3VyeU9wZXJhdGlvbixcbiAgQ2FwaXRhbEZsb3dDb25maWcsXG59IGZyb20gJy4uL3R5cGVzL2luZGV4LmpzJztcbmltcG9ydCB7IERhdGFiYXNlTWFuYWdlciB9IGZyb20gJy4uL2RiL0RhdGFiYXNlTWFuYWdlci5qcyc7XG5cbi8qKlxuICogRXhjaGFuZ2UgQVBJIGludGVyZmFjZSBmb3Igd2FsbGV0IG9wZXJhdGlvbnNcbiAqIFRoaXMgaW50ZXJmYWNlIHNob3VsZCBiZSBpbXBsZW1lbnRlZCBieSB0aGUgYWN0dWFsIGV4Y2hhbmdlIGFkYXB0ZXJcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBFeGNoYW5nZVdhbGxldEFQSSB7XG4gIC8qKiBHZXQgZnV0dXJlcyB3YWxsZXQgYmFsYW5jZSAqL1xuICBnZXRGdXR1cmVzQmFsYW5jZSgpOiBQcm9taXNlPG51bWJlcj47XG4gIC8qKiBHZXQgc3BvdCB3YWxsZXQgYmFsYW5jZSAqL1xuICBnZXRTcG90QmFsYW5jZSgpOiBQcm9taXNlPG51bWJlcj47XG4gIC8qKiBUcmFuc2ZlciBmdW5kcyBmcm9tIGZ1dHVyZXMgdG8gc3BvdCB3YWxsZXQgKi9cbiAgdHJhbnNmZXJUb1Nwb3QoYW1vdW50OiBudW1iZXIpOiBQcm9taXNlPHsgc3VjY2VzczogYm9vbGVhbjsgdHJhbnNhY3Rpb25JZD86IHN0cmluZzsgZXJyb3I/OiBzdHJpbmcgfT47XG59XG5cbi8qKlxuICogSW50ZXJmYWNlIGZvciBzd2VlcCBub3RpZmljYXRpb24gY2FsbGJhY2tcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBTd2VlcE5vdGlmaWVyIHtcbiAgc2VuZFN3ZWVwTm90aWZpY2F0aW9uKFxuICAgIGFtb3VudDogbnVtYmVyLFxuICAgIGZyb21XYWxsZXQ6IHN0cmluZyxcbiAgICB0b1dhbGxldDogc3RyaW5nLFxuICAgIHJlYXNvbjogc3RyaW5nLFxuICAgIG5ld0JhbGFuY2U6IG51bWJlclxuICApOiBQcm9taXNlPHZvaWQ+O1xufVxuXG4vKipcbiAqIENhcGl0YWxGbG93TWFuYWdlciBtYW5hZ2VzIHByb2ZpdCBzd2VlcGluZyBmcm9tIHRoZSByaXNreSBmdXR1cmVzIHdhbGxldFxuICogdG8gdGhlIHNhZmUgc3BvdCB3YWxsZXQgdXNpbmcgYSByYXRjaGV0IG1lY2hhbmlzbS5cbiAqL1xuZXhwb3J0IGNsYXNzIENhcGl0YWxGbG93TWFuYWdlciB7XG4gIHByaXZhdGUgcmVhZG9ubHkgY29uZmlnOiBDYXBpdGFsRmxvd0NvbmZpZztcbiAgcHJpdmF0ZSByZWFkb25seSBkYjogRGF0YWJhc2VNYW5hZ2VyIHwgbnVsbDtcbiAgcHJpdmF0ZSByZWFkb25seSBleGNoYW5nZUFQSTogRXhjaGFuZ2VXYWxsZXRBUEkgfCBudWxsO1xuICBcbiAgLyoqIENhY2hlZCBoaWdoIHdhdGVybWFyayB2YWx1ZSAqL1xuICBwcml2YXRlIGhpZ2hXYXRlcm1hcms6IG51bWJlciA9IDA7XG4gIC8qKiBDYWNoZWQgdG90YWwgc3dlcHQgYW1vdW50ICovXG4gIHByaXZhdGUgdG90YWxTd2VwdDogbnVtYmVyID0gMDtcbiAgLyoqIFRhcmdldCBhbGxvY2F0aW9uIGZvciBmdXR1cmVzIHdhbGxldCAoc2V0IGV4dGVybmFsbHkpICovXG4gIHByaXZhdGUgdGFyZ2V0QWxsb2NhdGlvbjogbnVtYmVyID0gMDtcbiAgLyoqIFN3ZWVwIG5vdGlmaWVyICovXG4gIHByaXZhdGUgc3dlZXBOb3RpZmllcjogU3dlZXBOb3RpZmllciB8IG51bGwgPSBudWxsO1xuXG4gIGNvbnN0cnVjdG9yKFxuICAgIGNvbmZpZzogQ2FwaXRhbEZsb3dDb25maWcsXG4gICAgZGI/OiBEYXRhYmFzZU1hbmFnZXIsXG4gICAgZXhjaGFuZ2VBUEk/OiBFeGNoYW5nZVdhbGxldEFQSVxuICApIHtcbiAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbiAgICB0aGlzLmRiID0gZGIgPz8gbnVsbDtcbiAgICB0aGlzLmV4Y2hhbmdlQVBJID0gZXhjaGFuZ2VBUEkgPz8gbnVsbDtcbiAgfVxuXG4gIC8qKlxuICAgKiBTZXQgdGhlIHN3ZWVwIG5vdGlmaWVyXG4gICAqL1xuICBzZXRTd2VlcE5vdGlmaWVyKG5vdGlmaWVyOiBTd2VlcE5vdGlmaWVyKTogdm9pZCB7XG4gICAgdGhpcy5zd2VlcE5vdGlmaWVyID0gbm90aWZpZXI7XG4gIH1cblxuICAvKipcbiAgICogSW5pdGlhbGl6ZSB0aGUgbWFuYWdlciBieSBsb2FkaW5nIHN0YXRlIGZyb20gZGF0YWJhc2VcbiAgICovXG4gIGFzeW5jIGluaXRpYWxpemUoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKHRoaXMuZGIpIHtcbiAgICAgIGF3YWl0IHRoaXMubG9hZEhpZ2hXYXRlcm1hcmsoKTtcbiAgICAgIGF3YWl0IHRoaXMubG9hZFRvdGFsU3dlcHQoKTtcbiAgICB9XG4gIH1cblxuXG4gIC8qKlxuICAgKiBMb2FkIGhpZ2ggd2F0ZXJtYXJrIGZyb20gZGF0YWJhc2VcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgbG9hZEhpZ2hXYXRlcm1hcmsoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCF0aGlzLmRiKSByZXR1cm47XG5cbiAgICBjb25zdCByZXN1bHQgPSBhd2FpdCB0aGlzLmRiLnF1ZXJ5PHsgdmFsdWU6IHN0cmluZyB9PihcbiAgICAgIGBTRUxFQ1QgdmFsdWUgRlJPTSBoaWdoX3dhdGVybWFyayBPUkRFUiBCWSB1cGRhdGVkX2F0IERFU0MgTElNSVQgMWBcbiAgICApO1xuXG4gICAgaWYgKHJlc3VsdC5yb3dzLmxlbmd0aCA+IDApIHtcbiAgICAgIHRoaXMuaGlnaFdhdGVybWFyayA9IHBhcnNlRmxvYXQocmVzdWx0LnJvd3NbMF0udmFsdWUpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBMb2FkIHRvdGFsIHN3ZXB0IGFtb3VudCBmcm9tIGRhdGFiYXNlXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGxvYWRUb3RhbFN3ZXB0KCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghdGhpcy5kYikgcmV0dXJuO1xuXG4gICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5kYi5xdWVyeTx7IHRvdGFsOiBzdHJpbmcgfT4oXG4gICAgICBgU0VMRUNUIENPQUxFU0NFKFNVTShhbW91bnQpLCAwKSBhcyB0b3RhbCBcbiAgICAgICBGUk9NIHRyZWFzdXJ5X29wZXJhdGlvbnMgXG4gICAgICAgV0hFUkUgb3BlcmF0aW9uX3R5cGUgPSAnU1dFRVAnIEFORCB0b193YWxsZXQgPSAnU1BPVCdgXG4gICAgKTtcblxuICAgIGlmIChyZXN1bHQucm93cy5sZW5ndGggPiAwKSB7XG4gICAgICB0aGlzLnRvdGFsU3dlcHQgPSBwYXJzZUZsb2F0KHJlc3VsdC5yb3dzWzBdLnRvdGFsKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU2V0IHRoZSB0YXJnZXQgYWxsb2NhdGlvbiBmb3IgZnV0dXJlcyB3YWxsZXRcbiAgICogVGhpcyBpcyB0eXBpY2FsbHkgc2V0IGJ5IHRoZSBCcmFpbiBiYXNlZCBvbiBjdXJyZW50IGVxdWl0eSBhbmQgYWxsb2NhdGlvblxuICAgKiBcbiAgICogQHBhcmFtIGFtb3VudCAtIFRhcmdldCBhbGxvY2F0aW9uIGluIFVTRFxuICAgKi9cbiAgc2V0VGFyZ2V0QWxsb2NhdGlvbihhbW91bnQ6IG51bWJlcik6IHZvaWQge1xuICAgIHRoaXMudGFyZ2V0QWxsb2NhdGlvbiA9IE1hdGgubWF4KDAsIGFtb3VudCk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSBjdXJyZW50IGhpZ2ggd2F0ZXJtYXJrXG4gICAqIFxuICAgKiBAcmV0dXJucyBIaWdoIHdhdGVybWFyayB2YWx1ZSBpbiBVU0RcbiAgICovXG4gIGdldEhpZ2hXYXRlcm1hcmsoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy5oaWdoV2F0ZXJtYXJrO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldCBoaWdoIHdhdGVybWFyayB2YWx1ZSAoZm9yIHN0YXRlIHJlY292ZXJ5KVxuICAgKiBcbiAgICogQHBhcmFtIHZhbHVlIC0gSGlnaCB3YXRlcm1hcmsgdmFsdWUgaW4gVVNEXG4gICAqL1xuICBhc3luYyBzZXRIaWdoV2F0ZXJtYXJrKHZhbHVlOiBudW1iZXIpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAodmFsdWUgPD0gMCkge1xuICAgICAgY29uc29sZS53YXJuKGBJbnZhbGlkIGhpZ2ggd2F0ZXJtYXJrIHZhbHVlOiAke3ZhbHVlfWApO1xuICAgICAgcmV0dXJuO1xuICAgIH1cblxuICAgIHRoaXMuaGlnaFdhdGVybWFyayA9IHZhbHVlO1xuXG4gICAgLy8gUGVyc2lzdCB0byBkYXRhYmFzZVxuICAgIGlmICh0aGlzLmRiKSB7XG4gICAgICBhd2FpdCB0aGlzLmRiLnF1ZXJ5KFxuICAgICAgICBgSU5TRVJUIElOVE8gaGlnaF93YXRlcm1hcmsgKHZhbHVlLCB1cGRhdGVkX2F0KSBWQUxVRVMgKCQxLCAkMilgLFxuICAgICAgICBbdmFsdWUsIERhdGUubm93KCldXG4gICAgICApO1xuICAgIH1cblxuICAgIGNvbnNvbGUubG9nKGBIaWdoIHdhdGVybWFyayBzZXQgdG8gJCR7dmFsdWV9YCk7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIHRoZSBoaWdoIHdhdGVybWFyayBpZiBlcXVpdHkgZXhjZWVkcyBjdXJyZW50IHdhdGVybWFya1xuICAgKiBSZXF1aXJlbWVudCA0LjE6IFRyYWNrIEhpZ2ggV2F0ZXJtYXJrIGZvciBGdXR1cmVzIFdhbGxldCBiYWxhbmNlXG4gICAqIFxuICAgKiBQcm9wZXJ0eSAxMDogSGlnaCBXYXRlcm1hcmsgTW9ub3RvbmljaXR5IC0gd2F0ZXJtYXJrIHNob3VsZCBuZXZlciBkZWNyZWFzZVxuICAgKiBcbiAgICogQHBhcmFtIGVxdWl0eSAtIEN1cnJlbnQgZXF1aXR5IGluIFVTRFxuICAgKiBAcmV0dXJucyB0cnVlIGlmIHdhdGVybWFyayB3YXMgdXBkYXRlZFxuICAgKi9cbiAgYXN5bmMgdXBkYXRlSGlnaFdhdGVybWFyayhlcXVpdHk6IG51bWJlcik6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIC8vIE9ubHkgdXBkYXRlIGlmIG5ldyBlcXVpdHkgZXhjZWVkcyBjdXJyZW50IHdhdGVybWFya1xuICAgIGlmIChlcXVpdHkgPD0gdGhpcy5oaWdoV2F0ZXJtYXJrKSB7XG4gICAgICByZXR1cm4gZmFsc2U7XG4gICAgfVxuXG4gICAgY29uc3QgcHJldmlvdXNXYXRlcm1hcmsgPSB0aGlzLmhpZ2hXYXRlcm1hcms7XG4gICAgdGhpcy5oaWdoV2F0ZXJtYXJrID0gZXF1aXR5O1xuXG4gICAgLy8gUGVyc2lzdCB0byBkYXRhYmFzZVxuICAgIGlmICh0aGlzLmRiKSB7XG4gICAgICBhd2FpdCB0aGlzLmRiLnF1ZXJ5KFxuICAgICAgICBgSU5TRVJUIElOVE8gaGlnaF93YXRlcm1hcmsgKHZhbHVlLCB1cGRhdGVkX2F0KSBWQUxVRVMgKCQxLCAkMilgLFxuICAgICAgICBbZXF1aXR5LCBEYXRlLm5vdygpXVxuICAgICAgKTtcbiAgICB9XG5cbiAgICByZXR1cm4gdHJ1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBzd2VlcCBjb25kaXRpb25zIGFyZSBtZXRcbiAgICogUmVxdWlyZW1lbnQgNC4yOiBTd2VlcCB3aGVuIEZ1dHVyZXMgV2FsbGV0IGV4Y2VlZHMgVGFyZ2V0IEFsbG9jYXRpb24gYnkgMjAlXG4gICAqIFxuICAgKiBAcmV0dXJucyBTd2VlcERlY2lzaW9uIHdpdGggc3dlZXAgZGV0YWlsc1xuICAgKi9cbiAgYXN5bmMgY2hlY2tTd2VlcENvbmRpdGlvbnMoKTogUHJvbWlzZTxTd2VlcERlY2lzaW9uPiB7XG4gICAgLy8gR2V0IGN1cnJlbnQgZnV0dXJlcyBiYWxhbmNlXG4gICAgY29uc3QgZnV0dXJlc0JhbGFuY2UgPSBhd2FpdCB0aGlzLmdldEZ1dHVyZXNCYWxhbmNlKCk7XG4gICAgXG4gICAgLy8gQ2FsY3VsYXRlIHRocmVzaG9sZCAodGFyZ2V0IGFsbG9jYXRpb24gKiBzd2VlcCB0aHJlc2hvbGQpXG4gICAgY29uc3Qgc3dlZXBUcmlnZ2VyTGV2ZWwgPSB0aGlzLnRhcmdldEFsbG9jYXRpb24gKiB0aGlzLmNvbmZpZy5zd2VlcFRocmVzaG9sZDtcbiAgICBcbiAgICAvLyBDaGVjayBpZiB3ZSBleGNlZWQgdGhlIHRocmVzaG9sZFxuICAgIGlmIChmdXR1cmVzQmFsYW5jZSA8PSBzd2VlcFRyaWdnZXJMZXZlbCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc2hvdWxkU3dlZXA6IGZhbHNlLFxuICAgICAgICBhbW91bnQ6IDAsXG4gICAgICAgIHJlYXNvbjogJ0Z1dHVyZXMgYmFsYW5jZSBkb2VzIG5vdCBleGNlZWQgc3dlZXAgdGhyZXNob2xkJyxcbiAgICAgICAgZnV0dXJlc0JhbGFuY2UsXG4gICAgICAgIHRhcmdldEFsbG9jYXRpb246IHRoaXMudGFyZ2V0QWxsb2NhdGlvbixcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gUmVxdWlyZW1lbnQgNC4zOiBDYWxjdWxhdGUgZXhjZXNzIHByb2ZpdFxuICAgIGNvbnN0IGV4Y2Vzc0Ftb3VudCA9IGZ1dHVyZXNCYWxhbmNlIC0gc3dlZXBUcmlnZ2VyTGV2ZWw7XG4gICAgXG4gICAgLy8gUmVxdWlyZW1lbnQgNC41OiBFbnN1cmUgcmVzZXJ2ZSBsaW1pdCBpcyBtYWludGFpbmVkXG4gICAgLy8gUHJvcGVydHkgNTogUmVzZXJ2ZSBMaW1pdCBQcm90ZWN0aW9uIC0gcmVtYWluaW5nIGJhbGFuY2UgPj0gcmVzZXJ2ZUxpbWl0XG4gICAgY29uc3QgbWF4U3dlZXBhYmxlID0gZnV0dXJlc0JhbGFuY2UgLSB0aGlzLmNvbmZpZy5yZXNlcnZlTGltaXQ7XG4gICAgXG4gICAgaWYgKG1heFN3ZWVwYWJsZSA8PSAwKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzaG91bGRTd2VlcDogZmFsc2UsXG4gICAgICAgIGFtb3VudDogMCxcbiAgICAgICAgcmVhc29uOiBgQ2Fubm90IHN3ZWVwOiB3b3VsZCB2aW9sYXRlIHJlc2VydmUgbGltaXQgb2YgJCR7dGhpcy5jb25maWcucmVzZXJ2ZUxpbWl0fWAsXG4gICAgICAgIGZ1dHVyZXNCYWxhbmNlLFxuICAgICAgICB0YXJnZXRBbGxvY2F0aW9uOiB0aGlzLnRhcmdldEFsbG9jYXRpb24sXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIFN3ZWVwIGFtb3VudCBpcyB0aGUgbWluaW11bSBvZiBleGNlc3MgYW5kIG1heCBzd2VlcGFibGVcbiAgICBjb25zdCBzd2VlcEFtb3VudCA9IE1hdGgubWluKGV4Y2Vzc0Ftb3VudCwgbWF4U3dlZXBhYmxlKTtcbiAgICBcbiAgICBpZiAoc3dlZXBBbW91bnQgPD0gMCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc2hvdWxkU3dlZXA6IGZhbHNlLFxuICAgICAgICBhbW91bnQ6IDAsXG4gICAgICAgIHJlYXNvbjogJ05vIGV4Y2VzcyB0byBzd2VlcCBhZnRlciByZXNlcnZlIGxpbWl0JyxcbiAgICAgICAgZnV0dXJlc0JhbGFuY2UsXG4gICAgICAgIHRhcmdldEFsbG9jYXRpb246IHRoaXMudGFyZ2V0QWxsb2NhdGlvbixcbiAgICAgIH07XG4gICAgfVxuXG4gICAgcmV0dXJuIHtcbiAgICAgIHNob3VsZFN3ZWVwOiB0cnVlLFxuICAgICAgYW1vdW50OiBzd2VlcEFtb3VudCxcbiAgICAgIHJlYXNvbjogYEV4Y2VzcyBvZiAkJHtzd2VlcEFtb3VudC50b0ZpeGVkKDIpfSBkZXRlY3RlZCAoJHsoKGZ1dHVyZXNCYWxhbmNlIC8gdGhpcy50YXJnZXRBbGxvY2F0aW9uIC0gMSkgKiAxMDApLnRvRml4ZWQoMSl9JSBvdmVyIHRhcmdldClgLFxuICAgICAgZnV0dXJlc0JhbGFuY2UsXG4gICAgICB0YXJnZXRBbGxvY2F0aW9uOiB0aGlzLnRhcmdldEFsbG9jYXRpb24sXG4gICAgfTtcbiAgfVxuXG5cbiAgLyoqXG4gICAqIEV4ZWN1dGUgYSBwcm9maXQgc3dlZXAgZnJvbSBmdXR1cmVzIHRvIHNwb3Qgd2FsbGV0XG4gICAqIFJlcXVpcmVtZW50IDQuNDogVHJhbnNmZXIgZXhjZXNzIFVTRFQgdG8gU3BvdCBXYWxsZXRcbiAgICogUmVxdWlyZW1lbnQgNC44OiBSZXRyeSB1cCB0byAzIHRpbWVzIHdpdGggZXhwb25lbnRpYWwgYmFja29mZlxuICAgKiBcbiAgICogUHJvcGVydHkgNDogU3dlZXAgTW9ub3RvbmljaXR5IC0gdG90YWxTd2VwdCBzaG91bGQgb25seSBpbmNyZWFzZVxuICAgKiBcbiAgICogQHBhcmFtIGFtb3VudCAtIEFtb3VudCB0byBzd2VlcCBpbiBVU0RcbiAgICogQHJldHVybnMgU3dlZXBSZXN1bHQgd2l0aCB0cmFuc2FjdGlvbiBkZXRhaWxzXG4gICAqL1xuICBhc3luYyBleGVjdXRlU3dlZXAoYW1vdW50OiBudW1iZXIpOiBQcm9taXNlPFN3ZWVwUmVzdWx0PiB7XG4gICAgY29uc3QgdGltZXN0YW1wID0gRGF0ZS5ub3coKTtcblxuICAgIC8vIFZhbGlkYXRlIGFtb3VudFxuICAgIGlmIChhbW91bnQgPD0gMCkge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgIGFtb3VudDogMCxcbiAgICAgICAgZXJyb3I6ICdJbnZhbGlkIHN3ZWVwIGFtb3VudDogbXVzdCBiZSBwb3NpdGl2ZScsXG4gICAgICAgIHRpbWVzdGFtcCxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gQ2hlY2sgcmVzZXJ2ZSBsaW1pdCBiZWZvcmUgc3dlZXBcbiAgICBjb25zdCBmdXR1cmVzQmFsYW5jZSA9IGF3YWl0IHRoaXMuZ2V0RnV0dXJlc0JhbGFuY2UoKTtcbiAgICBjb25zdCByZW1haW5pbmdBZnRlclN3ZWVwID0gZnV0dXJlc0JhbGFuY2UgLSBhbW91bnQ7XG4gICAgXG4gICAgaWYgKHJlbWFpbmluZ0FmdGVyU3dlZXAgPCB0aGlzLmNvbmZpZy5yZXNlcnZlTGltaXQpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICBhbW91bnQ6IDAsXG4gICAgICAgIGVycm9yOiBgU3dlZXAgd291bGQgdmlvbGF0ZSByZXNlcnZlIGxpbWl0OiAkJHtyZW1haW5pbmdBZnRlclN3ZWVwLnRvRml4ZWQoMil9IDwgJCR7dGhpcy5jb25maWcucmVzZXJ2ZUxpbWl0fWAsXG4gICAgICAgIHRpbWVzdGFtcCxcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gRXhlY3V0ZSB0cmFuc2ZlciB3aXRoIHJldHJ5IGxvZ2ljXG4gICAgbGV0IGxhc3RFcnJvcjogc3RyaW5nIHwgdW5kZWZpbmVkO1xuICAgIFxuICAgIGZvciAobGV0IGF0dGVtcHQgPSAxOyBhdHRlbXB0IDw9IHRoaXMuY29uZmlnLm1heFJldHJpZXM7IGF0dGVtcHQrKykge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgcmVzdWx0ID0gYXdhaXQgdGhpcy5leGVjdXRlVHJhbnNmZXIoYW1vdW50KTtcbiAgICAgICAgXG4gICAgICAgIGlmIChyZXN1bHQuc3VjY2Vzcykge1xuICAgICAgICAgIC8vIFVwZGF0ZSB0b3RhbCBzd2VwdCAobW9ub3RvbmljYWxseSBpbmNyZWFzaW5nKVxuICAgICAgICAgIHRoaXMudG90YWxTd2VwdCArPSBhbW91bnQ7XG4gICAgICAgICAgXG4gICAgICAgICAgLy8gTG9nIHRoZSBvcGVyYXRpb25cbiAgICAgICAgICBhd2FpdCB0aGlzLmxvZ1RyZWFzdXJ5T3BlcmF0aW9uKHtcbiAgICAgICAgICAgIHRpbWVzdGFtcCxcbiAgICAgICAgICAgIG9wZXJhdGlvblR5cGU6ICdTV0VFUCcsXG4gICAgICAgICAgICBhbW91bnQsXG4gICAgICAgICAgICBmcm9tV2FsbGV0OiAnRlVUVVJFUycsXG4gICAgICAgICAgICB0b1dhbGxldDogJ1NQT1QnLFxuICAgICAgICAgICAgcmVhc29uOiBgQXV0b21hdGVkIHByb2ZpdCBzd2VlcCAoYXR0ZW1wdCAke2F0dGVtcHR9KWAsXG4gICAgICAgICAgICBoaWdoV2F0ZXJtYXJrOiB0aGlzLmhpZ2hXYXRlcm1hcmssXG4gICAgICAgICAgfSk7XG5cbiAgICAgICAgICAvLyBTZW5kIHN3ZWVwIG5vdGlmaWNhdGlvblxuICAgICAgICAgIGlmICh0aGlzLnN3ZWVwTm90aWZpZXIpIHtcbiAgICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICAgIGNvbnN0IG5ld0JhbGFuY2UgPSBhd2FpdCB0aGlzLmdldEZ1dHVyZXNCYWxhbmNlKCk7XG4gICAgICAgICAgICAgIGF3YWl0IHRoaXMuc3dlZXBOb3RpZmllci5zZW5kU3dlZXBOb3RpZmljYXRpb24oXG4gICAgICAgICAgICAgICAgYW1vdW50LFxuICAgICAgICAgICAgICAgICdGVVRVUkVTJyxcbiAgICAgICAgICAgICAgICAnU1BPVCcsXG4gICAgICAgICAgICAgICAgYEF1dG9tYXRlZCBwcm9maXQgc3dlZXAgKGF0dGVtcHQgJHthdHRlbXB0fSlgLFxuICAgICAgICAgICAgICAgIG5ld0JhbGFuY2VcbiAgICAgICAgICAgICAgKTtcbiAgICAgICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ0ZhaWxlZCB0byBzZW5kIHN3ZWVwIG5vdGlmaWNhdGlvbjonLCBlcnJvcik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgICBhbW91bnQsXG4gICAgICAgICAgICB0cmFuc2FjdGlvbklkOiByZXN1bHQudHJhbnNhY3Rpb25JZCxcbiAgICAgICAgICAgIHRpbWVzdGFtcCxcbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICBsYXN0RXJyb3IgPSByZXN1bHQuZXJyb3I7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBsYXN0RXJyb3IgPSBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJztcbiAgICAgIH1cblxuICAgICAgLy8gRXhwb25lbnRpYWwgYmFja29mZiBiZWZvcmUgcmV0cnlcbiAgICAgIGlmIChhdHRlbXB0IDwgdGhpcy5jb25maWcubWF4UmV0cmllcykge1xuICAgICAgICBjb25zdCBkZWxheSA9IHRoaXMuY29uZmlnLnJldHJ5QmFzZURlbGF5ICogTWF0aC5wb3coMiwgYXR0ZW1wdCAtIDEpO1xuICAgICAgICBhd2FpdCB0aGlzLnNsZWVwKGRlbGF5KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBhbW91bnQ6IDAsXG4gICAgICBlcnJvcjogYFN3ZWVwIGZhaWxlZCBhZnRlciAke3RoaXMuY29uZmlnLm1heFJldHJpZXN9IGF0dGVtcHRzOiAke2xhc3RFcnJvcn1gLFxuICAgICAgdGltZXN0YW1wLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogRXhlY3V0ZSB0aGUgYWN0dWFsIHRyYW5zZmVyIHZpYSBleGNoYW5nZSBBUElcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgZXhlY3V0ZVRyYW5zZmVyKFxuICAgIGFtb3VudDogbnVtYmVyXG4gICk6IFByb21pc2U8eyBzdWNjZXNzOiBib29sZWFuOyB0cmFuc2FjdGlvbklkPzogc3RyaW5nOyBlcnJvcj86IHN0cmluZyB9PiB7XG4gICAgaWYgKCF0aGlzLmV4Y2hhbmdlQVBJKSB7XG4gICAgICAvLyBNb2NrIHN1Y2Nlc3MgZm9yIHRlc3Rpbmcgd2l0aG91dCBleGNoYW5nZSBBUElcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgIHRyYW5zYWN0aW9uSWQ6IGBtb2NrLSR7RGF0ZS5ub3coKX1gLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICByZXR1cm4gdGhpcy5leGNoYW5nZUFQSS50cmFuc2ZlclRvU3BvdChhbW91bnQpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBjdXJyZW50IHRyZWFzdXJ5IHN0YXR1c1xuICAgKiBSZXF1aXJlbWVudCA4LjEtOC43OiBUcmVhc3VyeSBtYW5hZ2VtZW50IHZpc2liaWxpdHlcbiAgICogXG4gICAqIEByZXR1cm5zIFRyZWFzdXJ5U3RhdHVzIHdpdGggYWxsIHdhbGxldCBiYWxhbmNlcyBhbmQgbWV0cmljc1xuICAgKi9cbiAgYXN5bmMgZ2V0VHJlYXN1cnlTdGF0dXMoKTogUHJvbWlzZTxUcmVhc3VyeVN0YXR1cz4ge1xuICAgIGNvbnN0IGZ1dHVyZXNXYWxsZXQgPSBhd2FpdCB0aGlzLmdldEZ1dHVyZXNCYWxhbmNlKCk7XG4gICAgY29uc3Qgc3BvdFdhbGxldCA9IGF3YWl0IHRoaXMuZ2V0U3BvdEJhbGFuY2UoKTtcblxuICAgIHJldHVybiB7XG4gICAgICBmdXR1cmVzV2FsbGV0LFxuICAgICAgc3BvdFdhbGxldCxcbiAgICAgIHRvdGFsU3dlcHQ6IHRoaXMudG90YWxTd2VwdCxcbiAgICAgIGhpZ2hXYXRlcm1hcms6IHRoaXMuaGlnaFdhdGVybWFyayxcbiAgICAgIGxvY2tlZFByb2ZpdDogdGhpcy50b3RhbFN3ZXB0LCAvLyBMb2NrZWQgcHJvZml0IGVxdWFscyB0b3RhbCBzd2VwdFxuICAgICAgcmlza0NhcGl0YWw6IGZ1dHVyZXNXYWxsZXQsIC8vIFJpc2sgY2FwaXRhbCBpcyBmdXR1cmVzIGJhbGFuY2VcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBmdXR1cmVzIHdhbGxldCBiYWxhbmNlXG4gICAqL1xuICBwcml2YXRlIGFzeW5jIGdldEZ1dHVyZXNCYWxhbmNlKCk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgaWYgKCF0aGlzLmV4Y2hhbmdlQVBJKSB7XG4gICAgICAvLyBSZXR1cm4gMCBpZiBubyBleGNoYW5nZSBBUEkgY29uZmlndXJlZFxuICAgICAgcmV0dXJuIDA7XG4gICAgfVxuICAgIHJldHVybiB0aGlzLmV4Y2hhbmdlQVBJLmdldEZ1dHVyZXNCYWxhbmNlKCk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHNwb3Qgd2FsbGV0IGJhbGFuY2VcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgZ2V0U3BvdEJhbGFuY2UoKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICBpZiAoIXRoaXMuZXhjaGFuZ2VBUEkpIHtcbiAgICAgIC8vIFJldHVybiAwIGlmIG5vIGV4Y2hhbmdlIEFQSSBjb25maWd1cmVkXG4gICAgICByZXR1cm4gMDtcbiAgICB9XG4gICAgcmV0dXJuIHRoaXMuZXhjaGFuZ2VBUEkuZ2V0U3BvdEJhbGFuY2UoKTtcbiAgfVxuXG5cbiAgLyoqXG4gICAqIExvZyBhIHRyZWFzdXJ5IG9wZXJhdGlvbiB0byB0aGUgZGF0YWJhc2VcbiAgICogUmVxdWlyZW1lbnQgNC43OiBMb2cgYWxsIHN3ZWVwIHRyYW5zYWN0aW9uc1xuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBsb2dUcmVhc3VyeU9wZXJhdGlvbihvcGVyYXRpb246IFRyZWFzdXJ5T3BlcmF0aW9uKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCF0aGlzLmRiKSByZXR1cm47XG5cbiAgICBhd2FpdCB0aGlzLmRiLnF1ZXJ5KFxuICAgICAgYElOU0VSVCBJTlRPIHRyZWFzdXJ5X29wZXJhdGlvbnMgXG4gICAgICAgKHRpbWVzdGFtcCwgb3BlcmF0aW9uX3R5cGUsIGFtb3VudCwgZnJvbV93YWxsZXQsIHRvX3dhbGxldCwgcmVhc29uLCBoaWdoX3dhdGVybWFyaylcbiAgICAgICBWQUxVRVMgKCQxLCAkMiwgJDMsICQ0LCAkNSwgJDYsICQ3KWAsXG4gICAgICBbXG4gICAgICAgIG9wZXJhdGlvbi50aW1lc3RhbXAsXG4gICAgICAgIG9wZXJhdGlvbi5vcGVyYXRpb25UeXBlLFxuICAgICAgICBvcGVyYXRpb24uYW1vdW50LFxuICAgICAgICBvcGVyYXRpb24uZnJvbVdhbGxldCxcbiAgICAgICAgb3BlcmF0aW9uLnRvV2FsbGV0LFxuICAgICAgICBvcGVyYXRpb24ucmVhc29uID8/IG51bGwsXG4gICAgICAgIG9wZXJhdGlvbi5oaWdoV2F0ZXJtYXJrLFxuICAgICAgXVxuICAgICk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHN3ZWVwIGhpc3RvcnkgZnJvbSBkYXRhYmFzZVxuICAgKiBcbiAgICogQHBhcmFtIGxpbWl0IC0gTWF4aW11bSBudW1iZXIgb2YgcmVjb3JkcyB0byByZXR1cm5cbiAgICogQHJldHVybnMgQXJyYXkgb2YgdHJlYXN1cnkgb3BlcmF0aW9uc1xuICAgKi9cbiAgYXN5bmMgZ2V0U3dlZXBIaXN0b3J5KGxpbWl0OiBudW1iZXIgPSAxMDApOiBQcm9taXNlPFRyZWFzdXJ5T3BlcmF0aW9uW10+IHtcbiAgICBpZiAoIXRoaXMuZGIpIHJldHVybiBbXTtcblxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuZGIucXVlcnk8e1xuICAgICAgaWQ6IG51bWJlcjtcbiAgICAgIHRpbWVzdGFtcDogc3RyaW5nO1xuICAgICAgb3BlcmF0aW9uX3R5cGU6IHN0cmluZztcbiAgICAgIGFtb3VudDogc3RyaW5nO1xuICAgICAgZnJvbV93YWxsZXQ6IHN0cmluZztcbiAgICAgIHRvX3dhbGxldDogc3RyaW5nO1xuICAgICAgcmVhc29uOiBzdHJpbmcgfCBudWxsO1xuICAgICAgaGlnaF93YXRlcm1hcms6IHN0cmluZztcbiAgICB9PihcbiAgICAgIGBTRUxFQ1QgaWQsIHRpbWVzdGFtcCwgb3BlcmF0aW9uX3R5cGUsIGFtb3VudCwgZnJvbV93YWxsZXQsIHRvX3dhbGxldCwgcmVhc29uLCBoaWdoX3dhdGVybWFya1xuICAgICAgIEZST00gdHJlYXN1cnlfb3BlcmF0aW9uc1xuICAgICAgIFdIRVJFIG9wZXJhdGlvbl90eXBlID0gJ1NXRUVQJ1xuICAgICAgIE9SREVSIEJZIHRpbWVzdGFtcCBERVNDXG4gICAgICAgTElNSVQgJDFgLFxuICAgICAgW2xpbWl0XVxuICAgICk7XG5cbiAgICByZXR1cm4gcmVzdWx0LnJvd3MubWFwKChyb3cpID0+ICh7XG4gICAgICBpZDogcm93LmlkLFxuICAgICAgdGltZXN0YW1wOiBwYXJzZUludChyb3cudGltZXN0YW1wLCAxMCksXG4gICAgICBvcGVyYXRpb25UeXBlOiByb3cub3BlcmF0aW9uX3R5cGUgYXMgJ1NXRUVQJyB8ICdNQU5VQUxfVFJBTlNGRVInLFxuICAgICAgYW1vdW50OiBwYXJzZUZsb2F0KHJvdy5hbW91bnQpLFxuICAgICAgZnJvbVdhbGxldDogcm93LmZyb21fd2FsbGV0IGFzICdGVVRVUkVTJyB8ICdTUE9UJyxcbiAgICAgIHRvV2FsbGV0OiByb3cudG9fd2FsbGV0IGFzICdGVVRVUkVTJyB8ICdTUE9UJyxcbiAgICAgIHJlYXNvbjogcm93LnJlYXNvbiA/PyB1bmRlZmluZWQsXG4gICAgICBoaWdoV2F0ZXJtYXJrOiBwYXJzZUZsb2F0KHJvdy5oaWdoX3dhdGVybWFyayksXG4gICAgfSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGN1bGF0ZSB0aGUgbmV4dCBzd2VlcCB0cmlnZ2VyIGxldmVsXG4gICAqIFxuICAgKiBAcmV0dXJucyBUaGUgZnV0dXJlcyBiYWxhbmNlIGxldmVsIHRoYXQgd291bGQgdHJpZ2dlciBhIHN3ZWVwXG4gICAqL1xuICBnZXROZXh0U3dlZXBUcmlnZ2VyTGV2ZWwoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gdGhpcy50YXJnZXRBbGxvY2F0aW9uICogdGhpcy5jb25maWcuc3dlZXBUaHJlc2hvbGQ7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSB0b3RhbCBhbW91bnQgc3dlcHQgc2luY2UgaW5jZXB0aW9uXG4gICAqIFxuICAgKiBAcmV0dXJucyBUb3RhbCBzd2VwdCBhbW91bnQgaW4gVVNEXG4gICAqL1xuICBnZXRUb3RhbFN3ZXB0KCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMudG90YWxTd2VwdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdGhlIGN1cnJlbnQgdGFyZ2V0IGFsbG9jYXRpb25cbiAgICogXG4gICAqIEByZXR1cm5zIFRhcmdldCBhbGxvY2F0aW9uIGluIFVTRFxuICAgKi9cbiAgZ2V0VGFyZ2V0QWxsb2NhdGlvbigpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLnRhcmdldEFsbG9jYXRpb247XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSByZXNlcnZlIGxpbWl0XG4gICAqIFxuICAgKiBAcmV0dXJucyBSZXNlcnZlIGxpbWl0IGluIFVTRFxuICAgKi9cbiAgZ2V0UmVzZXJ2ZUxpbWl0KCk6IG51bWJlciB7XG4gICAgcmV0dXJuIHRoaXMuY29uZmlnLnJlc2VydmVMaW1pdDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY29uZmlndXJhdGlvblxuICAgKi9cbiAgZ2V0Q29uZmlnKCk6IENhcGl0YWxGbG93Q29uZmlnIHtcbiAgICByZXR1cm4geyAuLi50aGlzLmNvbmZpZyB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFNsZWVwIHV0aWxpdHkgZm9yIHJldHJ5IGRlbGF5c1xuICAgKi9cbiAgcHJpdmF0ZSBzbGVlcChtczogbnVtYmVyKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlKSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIG1zKSk7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgaWYgYSBzd2VlcCBzaG91bGQgYmUgdHJpZ2dlcmVkIGJhc2VkIG9uIGVxdWl0eSBpbmNyZWFzZVxuICAgKiBSZXF1aXJlbWVudCA0LjY6IFN3ZWVwIGFmdGVyIHRyYWRlcyB0aGF0IGluY3JlYXNlIGVxdWl0eSBieSA+IDEwJVxuICAgKiBcbiAgICogQHBhcmFtIHByZXZpb3VzRXF1aXR5IC0gRXF1aXR5IGJlZm9yZSB0aGUgdHJhZGVcbiAgICogQHBhcmFtIGN1cnJlbnRFcXVpdHkgLSBFcXVpdHkgYWZ0ZXIgdGhlIHRyYWRlXG4gICAqIEByZXR1cm5zIHRydWUgaWYgZXF1aXR5IGluY3JlYXNlZCBieSBtb3JlIHRoYW4gMTAlXG4gICAqL1xuICBzaG91bGRUcmlnZ2VyU3dlZXBPbkVxdWl0eUluY3JlYXNlKFxuICAgIHByZXZpb3VzRXF1aXR5OiBudW1iZXIsXG4gICAgY3VycmVudEVxdWl0eTogbnVtYmVyXG4gICk6IGJvb2xlYW4ge1xuICAgIGlmIChwcmV2aW91c0VxdWl0eSA8PSAwKSByZXR1cm4gZmFsc2U7XG4gICAgXG4gICAgY29uc3QgcGVyY2VudEluY3JlYXNlID0gKGN1cnJlbnRFcXVpdHkgLSBwcmV2aW91c0VxdWl0eSkgLyBwcmV2aW91c0VxdWl0eTtcbiAgICByZXR1cm4gcGVyY2VudEluY3JlYXNlID4gMC4xMDsgLy8gMTAlIHRocmVzaG9sZFxuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm0gYSBmdWxsIHN3ZWVwIGNoZWNrIGFuZCBleGVjdXRpb24gaWYgY29uZGl0aW9ucyBhcmUgbWV0XG4gICAqIENvbnZlbmllbmNlIG1ldGhvZCB0aGF0IGNvbWJpbmVzIGNoZWNrU3dlZXBDb25kaXRpb25zIGFuZCBleGVjdXRlU3dlZXBcbiAgICogXG4gICAqIEByZXR1cm5zIFN3ZWVwUmVzdWx0IGlmIHN3ZWVwIHdhcyBhdHRlbXB0ZWQsIG51bGwgaWYgY29uZGl0aW9ucyBub3QgbWV0XG4gICAqL1xuICBhc3luYyBwZXJmb3JtU3dlZXBJZk5lZWRlZCgpOiBQcm9taXNlPFN3ZWVwUmVzdWx0IHwgbnVsbD4ge1xuICAgIGNvbnN0IGRlY2lzaW9uID0gYXdhaXQgdGhpcy5jaGVja1N3ZWVwQ29uZGl0aW9ucygpO1xuICAgIFxuICAgIGlmICghZGVjaXNpb24uc2hvdWxkU3dlZXApIHtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cblxuICAgIHJldHVybiB0aGlzLmV4ZWN1dGVTd2VlcChkZWNpc2lvbi5hbW91bnQpO1xuICB9XG59XG4iXSwidmVyc2lvbiI6M30=
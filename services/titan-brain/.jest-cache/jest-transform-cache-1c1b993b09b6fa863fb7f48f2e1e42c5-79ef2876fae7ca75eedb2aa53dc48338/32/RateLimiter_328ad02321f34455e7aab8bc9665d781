8deffdade34d3c5d02b96f53156dcef1
"use strict";
/**
 * RateLimiter - Rate limiting middleware for Fastify
 *
 * Provides configurable rate limiting with Redis-based storage and in-memory fallback.
 * Supports different rate limits for different endpoints and includes proper headers.
 *
 * Requirements: 4.3.1, 4.3.2, 4.3.3, 4.3.4, 4.3.5
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.DEFAULT_ENDPOINT_CONFIGS = exports.RateLimiter = void 0;
exports.rateLimiterPlugin = rateLimiterPlugin;
/**
 * Rate limiter class
 */
class RateLimiter {
    cacheManager;
    logger;
    defaultConfig;
    constructor(cacheManager, logger, defaultConfig) {
        this.cacheManager = cacheManager;
        this.logger = logger;
        this.defaultConfig = defaultConfig;
    }
    /**
     * Create rate limiter from environment variables
     */
    static createFromEnvironment(cacheManager, logger) {
        const defaultConfig = {
            windowMs: parseInt(process.env.RATE_LIMIT_WINDOW_MS || '60000'), // 1 minute
            maxRequests: parseInt(process.env.RATE_LIMIT_MAX_REQUESTS || '100'), // 100 requests per minute
            skipSuccessfulRequests: process.env.RATE_LIMIT_SKIP_SUCCESS === 'true',
            skipFailedRequests: process.env.RATE_LIMIT_SKIP_FAILED === 'true'
        };
        return new RateLimiter(cacheManager, logger, defaultConfig);
    }
    /**
     * Default key generator using IP address
     */
    defaultKeyGenerator(request) {
        const ip = request.ip || 'unknown';
        const endpoint = request.url.split('?')[0]; // Remove query parameters
        return `rate_limit:${ip}:${endpoint}`;
    }
    /**
     * Check rate limit for a request
     */
    async checkRateLimit(request, config) {
        const finalConfig = { ...this.defaultConfig, ...config };
        const keyGenerator = finalConfig.keyGenerator || this.defaultKeyGenerator.bind(this);
        const key = keyGenerator(request);
        const now = Date.now();
        const windowStart = now - finalConfig.windowMs;
        try {
            // Get current hit count from cache
            const hitResult = await this.cacheManager.get(key);
            let hits = [];
            if (hitResult.success && hitResult.value) {
                try {
                    hits = JSON.parse(hitResult.value);
                    if (!Array.isArray(hits)) {
                        hits = [];
                    }
                }
                catch (error) {
                    this.logger.warn('Failed to parse rate limit data', undefined, { key, error: error instanceof Error ? error.message : String(error) });
                    hits = [];
                }
            }
            // Filter hits within the current window
            hits = hits.filter(hit => hit.timestamp > windowStart);
            // Count relevant hits based on configuration
            let relevantHits = hits.length;
            if (finalConfig.skipSuccessfulRequests || finalConfig.skipFailedRequests) {
                relevantHits = hits.filter(hit => {
                    if (finalConfig.skipSuccessfulRequests && hit.success === true) {
                        return false;
                    }
                    if (finalConfig.skipFailedRequests && hit.success === false) {
                        return false;
                    }
                    return true;
                }).length;
            }
            const allowed = relevantHits < finalConfig.maxRequests;
            const remaining = Math.max(0, finalConfig.maxRequests - relevantHits);
            const resetTime = windowStart + finalConfig.windowMs;
            // Add current request to hits if we're tracking it
            if (allowed) {
                hits.push({ timestamp: now });
                // Store updated hits with TTL
                const ttlMs = Math.ceil(finalConfig.windowMs / 1000);
                await this.cacheManager.set(key, JSON.stringify(hits), ttlMs);
            }
            return {
                allowed,
                remaining,
                resetTime,
                totalHits: hits.length
            };
        }
        catch (error) {
            this.logger.error('Rate limit check failed', error instanceof Error ? error : new Error(String(error)), undefined, { key });
            // On error, allow the request (fail open)
            return {
                allowed: true,
                remaining: finalConfig.maxRequests,
                resetTime: now + finalConfig.windowMs,
                totalHits: 0
            };
        }
    }
    /**
     * Update rate limit after response (for conditional counting)
     */
    async updateRateLimit(request, success, config) {
        const finalConfig = { ...this.defaultConfig, ...config };
        // Only update if we're conditionally counting requests
        if (!finalConfig.skipSuccessfulRequests && !finalConfig.skipFailedRequests) {
            return;
        }
        const keyGenerator = finalConfig.keyGenerator || this.defaultKeyGenerator.bind(this);
        const key = keyGenerator(request);
        try {
            const hitResult = await this.cacheManager.get(key);
            if (!hitResult.success || !hitResult.value)
                return;
            let hits = JSON.parse(hitResult.value);
            // Update the most recent hit with success status
            if (hits.length > 0) {
                hits[hits.length - 1].success = success;
                const ttlMs = Math.ceil(finalConfig.windowMs / 1000);
                await this.cacheManager.set(key, JSON.stringify(hits), ttlMs);
            }
        }
        catch (error) {
            this.logger.warn('Failed to update rate limit', undefined, {
                key,
                success,
                error: error instanceof Error ? error.message : String(error)
            });
        }
    }
    /**
     * Create rate limiting middleware
     */
    createMiddleware(config) {
        return async (request, reply, done) => {
            const startTime = Date.now();
            try {
                const result = await this.checkRateLimit(request, config);
                // Add rate limit headers
                reply.header('X-RateLimit-Limit', (config?.maxRequests || this.defaultConfig.maxRequests).toString());
                reply.header('X-RateLimit-Remaining', result.remaining.toString());
                reply.header('X-RateLimit-Reset', Math.ceil(result.resetTime / 1000).toString());
                if (!result.allowed) {
                    // Log rate limit exceeded
                    this.logger.logSecurityEvent('Rate limit exceeded', 'medium', request.correlationId, {
                        ip: request.ip,
                        endpoint: request.url,
                        method: request.method,
                        userAgent: request.headers['user-agent'],
                        totalHits: result.totalHits,
                        limit: config?.maxRequests || this.defaultConfig.maxRequests
                    });
                    // Call custom handler if provided
                    if (config?.onLimitReached) {
                        config.onLimitReached(request, reply);
                    }
                    else {
                        reply.status(429).send({
                            error: 'Too Many Requests',
                            message: 'Rate limit exceeded. Please try again later.',
                            retryAfter: Math.ceil((result.resetTime - Date.now()) / 1000),
                            timestamp: new Date().toISOString()
                        });
                    }
                    return;
                }
                // Add response hook to update rate limit if using conditional counting
                if (config?.skipSuccessfulRequests || config?.skipFailedRequests) {
                    // Note: Fastify doesn't have addHook on reply, we need to use a different approach
                    // For now, we'll skip this functionality in the middleware
                    // In a real implementation, this would be handled at the route level
                }
                // Log rate limit check
                const duration = Date.now() - startTime;
                this.logger.debug('Rate limit check completed', request.correlationId, {
                    ip: request.ip,
                    endpoint: request.url,
                    allowed: result.allowed,
                    remaining: result.remaining,
                    duration
                });
                done();
            }
            catch (error) {
                this.logger.error('Rate limit middleware error', error instanceof Error ? error : new Error(String(error)), request.correlationId, {
                    ip: request.ip,
                    endpoint: request.url
                });
                // On error, allow the request (fail open)
                done();
            }
        };
    }
    /**
     * Create endpoint-specific rate limiting middleware
     */
    createEndpointMiddleware(endpointConfigs) {
        return async (request, reply, done) => {
            const endpoint = request.url.split('?')[0]; // Remove query parameters
            const config = endpointConfigs[endpoint];
            if (!config) {
                // No specific config for this endpoint, use default
                const defaultMiddleware = this.createMiddleware();
                return defaultMiddleware(request, reply, done);
            }
            const endpointMiddleware = this.createMiddleware(config);
            return endpointMiddleware(request, reply, done);
        };
    }
    /**
     * Reset rate limit for a specific key
     */
    async resetRateLimit(key) {
        try {
            await this.cacheManager.delete(key);
            this.logger.info('Rate limit reset', undefined, { key });
        }
        catch (error) {
            this.logger.error('Failed to reset rate limit', error instanceof Error ? error : new Error(String(error)), undefined, { key });
        }
    }
    /**
     * Get rate limit status for a key
     */
    async getRateLimitStatus(key) {
        try {
            const hitResult = await this.cacheManager.get(key);
            if (!hitResult.success || !hitResult.value) {
                return {
                    hits: 0,
                    remaining: this.defaultConfig.maxRequests,
                    resetTime: Date.now() + this.defaultConfig.windowMs
                };
            }
            const hits = JSON.parse(hitResult.value);
            const now = Date.now();
            const windowStart = now - this.defaultConfig.windowMs;
            const validHits = hits.filter(hit => hit.timestamp > windowStart);
            return {
                hits: validHits.length,
                remaining: Math.max(0, this.defaultConfig.maxRequests - validHits.length),
                resetTime: windowStart + this.defaultConfig.windowMs
            };
        }
        catch (error) {
            this.logger.error('Failed to get rate limit status', error instanceof Error ? error : new Error(String(error)), undefined, { key });
            return null;
        }
    }
}
exports.RateLimiter = RateLimiter;
/**
 * Default rate limit configurations for different endpoints
 */
exports.DEFAULT_ENDPOINT_CONFIGS = {
    '/signal': {
        windowMs: 60000, // 1 minute
        maxRequests: 60, // 60 signals per minute
        skipFailedRequests: true // Don't count failed signals
    },
    '/webhook/phase1': {
        windowMs: 60000, // 1 minute
        maxRequests: 120, // 120 webhooks per minute
        skipFailedRequests: true
    },
    '/webhook/phase2': {
        windowMs: 60000, // 1 minute
        maxRequests: 60, // 60 webhooks per minute
        skipFailedRequests: true
    },
    '/webhook/phase3': {
        windowMs: 60000, // 1 minute
        maxRequests: 30, // 30 webhooks per minute
        skipFailedRequests: true
    },
    '/admin/override': {
        windowMs: 300000, // 5 minutes
        maxRequests: 5, // 5 override attempts per 5 minutes
        skipSuccessfulRequests: false,
        skipFailedRequests: false
    },
    '/breaker/reset': {
        windowMs: 300000, // 5 minutes
        maxRequests: 10, // 10 reset attempts per 5 minutes
        skipSuccessfulRequests: false,
        skipFailedRequests: false
    },
    '/dashboard': {
        windowMs: 60000, // 1 minute
        maxRequests: 300, // 300 dashboard requests per minute
        skipFailedRequests: true
    },
    '/metrics': {
        windowMs: 60000, // 1 minute
        maxRequests: 600, // 600 metrics requests per minute (for monitoring)
        skipFailedRequests: true
    }
};
/**
 * Rate limiter plugin for Fastify
 */
async function rateLimiterPlugin(fastify, options) {
    const rateLimiter = new RateLimiter(options.cacheManager, options.logger, options.defaultConfig || {
        windowMs: 60000,
        maxRequests: 100
    });
    const endpointConfigs = options.endpointConfigs || exports.DEFAULT_ENDPOINT_CONFIGS;
    const middleware = rateLimiter.createEndpointMiddleware(endpointConfigs);
    fastify.addHook('preHandler', middleware);
    // Add rate limiter instance to fastify for access in routes
    fastify.decorate('rateLimiter', rateLimiter);
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLWJyYWluL3NyYy9taWRkbGV3YXJlL1JhdGVMaW1pdGVyLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7OztHQU9HOzs7QUEyWkgsOENBeUJDO0FBeFpEOztHQUVHO0FBQ0gsTUFBYSxXQUFXO0lBQ2QsWUFBWSxDQUFlO0lBQzNCLE1BQU0sQ0FBUztJQUNmLGFBQWEsQ0FBa0I7SUFFdkMsWUFDRSxZQUEwQixFQUMxQixNQUFjLEVBQ2QsYUFBOEI7UUFFOUIsSUFBSSxDQUFDLFlBQVksR0FBRyxZQUFZLENBQUM7UUFDakMsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLGFBQWEsR0FBRyxhQUFhLENBQUM7SUFDckMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsTUFBTSxDQUFDLHFCQUFxQixDQUMxQixZQUEwQixFQUMxQixNQUFjO1FBRWQsTUFBTSxhQUFhLEdBQW9CO1lBQ3JDLFFBQVEsRUFBRSxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxvQkFBb0IsSUFBSSxPQUFPLENBQUMsRUFBRSxXQUFXO1lBQzVFLFdBQVcsRUFBRSxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsSUFBSSxLQUFLLENBQUMsRUFBRSwwQkFBMEI7WUFDL0Ysc0JBQXNCLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyx1QkFBdUIsS0FBSyxNQUFNO1lBQ3RFLGtCQUFrQixFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0JBQXNCLEtBQUssTUFBTTtTQUNsRSxDQUFDO1FBRUYsT0FBTyxJQUFJLFdBQVcsQ0FBQyxZQUFZLEVBQUUsTUFBTSxFQUFFLGFBQWEsQ0FBQyxDQUFDO0lBQzlELENBQUM7SUFFRDs7T0FFRztJQUNLLG1CQUFtQixDQUFDLE9BQXVCO1FBQ2pELE1BQU0sRUFBRSxHQUFHLE9BQU8sQ0FBQyxFQUFFLElBQUksU0FBUyxDQUFDO1FBQ25DLE1BQU0sUUFBUSxHQUFH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aUIsQ0FDckMsT0FBWSxFQUNaLE9BS0M7SUFFRCxNQUFNLFdBQVcsR0FBRyxJQUFJLFdBQVcsQ0FDakMsT0FBTyxDQUFDLFlBQVksRUFDcEIsT0FBTyxDQUFDLE1BQU0sRUFDZCxPQUFPLENBQUMsYUFBYSxJQUFJO1FBQ3ZCLFFBQVEsRUFBRSxLQUFLO1FBQ2YsV0FBVyxFQUFFLEdBQUc7S0FDakIsQ0FDRixDQUFDO0lBRUYsTUFBTSxlQUFlLEdBQUcsT0FBTyxDQUFDLGVBQWUsSUFBSSxnQ0FBd0IsQ0FBQztJQUM1RSxNQUFNLFVBQVUsR0FBRyxXQUFXLENBQUMsd0JBQXdCLENBQUMsZUFBZSxDQUFDLENBQUM7SUFFekUsT0FBTyxDQUFDLE9BQU8sQ0FBQyxZQUFZLEVBQUUsVUFBVSxDQUFDLENBQUM7SUFFMUMsNERBQTREO0lBQzVELE9BQU8sQ0FBQyxRQUFRLENBQUMsYUFBYSxFQUFFLFdBQVcsQ0FBQyxDQUFDO0FBQy9DLENBQUMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLWJyYWluL3NyYy9taWRkbGV3YXJlL1JhdGVMaW1pdGVyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogUmF0ZUxpbWl0ZXIgLSBSYXRlIGxpbWl0aW5nIG1pZGRsZXdhcmUgZm9yIEZhc3RpZnlcbiAqIFxuICogUHJvdmlkZXMgY29uZmlndXJhYmxlIHJhdGUgbGltaXRpbmcgd2l0aCBSZWRpcy1iYXNlZCBzdG9yYWdlIGFuZCBpbi1tZW1vcnkgZmFsbGJhY2suXG4gKiBTdXBwb3J0cyBkaWZmZXJlbnQgcmF0ZSBsaW1pdHMgZm9yIGRpZmZlcmVudCBlbmRwb2ludHMgYW5kIGluY2x1ZGVzIHByb3BlciBoZWFkZXJzLlxuICogXG4gKiBSZXF1aXJlbWVudHM6IDQuMy4xLCA0LjMuMiwgNC4zLjMsIDQuMy40LCA0LjMuNVxuICovXG5cbmltcG9ydCB7IEZhc3RpZnlSZXF1ZXN0LCBGYXN0aWZ5UmVwbHksIEhvb2tIYW5kbGVyRG9uZUZ1bmN0aW9uIH0gZnJvbSAnZmFzdGlmeSc7XG5pbXBvcnQgeyBDYWNoZU1hbmFnZXIgfSBmcm9tICcuLi9jYWNoZS9DYWNoZU1hbmFnZXIuanMnO1xuaW1wb3J0IHsgTG9nZ2VyIH0gZnJvbSAnLi4vbG9nZ2luZy9Mb2dnZXIuanMnO1xuXG4vKipcbiAqIFJhdGUgbGltaXQgY29uZmlndXJhdGlvbiBmb3IgYW4gZW5kcG9pbnRcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBSYXRlTGltaXRDb25maWcge1xuICB3aW5kb3dNczogbnVtYmVyOyAgICAgIC8vIFRpbWUgd2luZG93IGluIG1pbGxpc2Vjb25kc1xuICBtYXhSZXF1ZXN0czogbnVtYmVyOyAgIC8vIE1heGltdW0gcmVxdWVzdHMgcGVyIHdpbmRvd1xuICBza2lwU3VjY2Vzc2Z1bFJlcXVlc3RzPzogYm9vbGVhbjsgIC8vIERvbid0IGNvdW50IHN1Y2Nlc3NmdWwgcmVxdWVzdHNcbiAgc2tpcEZhaWxlZFJlcXVlc3RzPzogYm9vbGVhbjsgICAgICAvLyBEb24ndCBjb3VudCBmYWlsZWQgcmVxdWVzdHNcbiAga2V5R2VuZXJhdG9yPzogKHJlcXVlc3Q6IEZhc3RpZnlSZXF1ZXN0KSA9PiBzdHJpbmc7ICAvLyBDdXN0b20ga2V5IGdlbmVyYXRvclxuICBvbkxpbWl0UmVhY2hlZD86IChyZXF1ZXN0OiBGYXN0aWZ5UmVxdWVzdCwgcmVwbHk6IEZhc3RpZnlSZXBseSkgPT4gdm9pZDsgIC8vIEN1c3RvbSBsaW1pdCBoYW5kbGVyXG59XG5cbi8qKlxuICogUmF0ZSBsaW1pdCByZXN1bHRcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBSYXRlTGltaXRSZXN1bHQge1xuICBhbGxvd2VkOiBib29sZWFuO1xuICByZW1haW5pbmc6IG51bWJlcjtcbiAgcmVzZXRUaW1lOiBudW1iZXI7XG4gIHRvdGFsSGl0czogbnVtYmVyO1xufVxuXG4vKipcbiAqIFJhdGUgbGltaXRlciBjbGFzc1xuICovXG5leHBvcnQgY2xhc3MgUmF0ZUxpbWl0ZXIge1xuICBwcml2YXRlIGNhY2hlTWFuYWdlcjogQ2FjaGVNYW5hZ2VyO1xuICBwcml2YXRlIGxvZ2dlcjogTG9nZ2VyO1xuICBwcml2YXRlIGRlZmF1bHRDb25maWc6IFJhdGVMaW1pdENvbmZpZztcblxuICBjb25zdHJ1Y3RvcihcbiAgICBjYWNoZU1hbmFnZXI6IENhY2hlTWFuYWdlcixcbiAgICBsb2dnZXI6IExvZ2dlcixcbiAgICBkZWZhdWx0Q29uZmlnOiBSYXRlTGltaXRDb25maWdcbiAgKSB7XG4gICAgdGhpcy5jYWNoZU1hbmFnZXIgPSBjYWNoZU1hbmFnZXI7XG4gICAgdGhpcy5sb2dnZXIgPSBsb2dnZXI7XG4gICAgdGhpcy5kZWZhdWx0Q29uZmlnID0gZGVmYXVsdENvbmZpZztcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgcmF0ZSBsaW1pdGVyIGZyb20gZW52aXJvbm1lbnQgdmFyaWFibGVzXG4gICAqL1xuICBzdGF0aWMgY3JlYXRlRnJvbUVudmlyb25tZW50KFxuICAgIGNhY2hlTWFuYWdlcjogQ2FjaGVNYW5hZ2VyLFxuICAgIGxvZ2dlcjogTG9nZ2VyXG4gICk6IFJhdGVMaW1pdGVyIHtcbiAgICBjb25zdCBkZWZhdWx0Q29uZmlnOiBSYXRlTGltaXRDb25maWcgPSB7XG4gICAgICB3aW5kb3dNczogcGFyc2VJbnQocHJvY2Vzcy5lbnYuUkFURV9MSU1JVF9XSU5ET1dfTVMgfHwgJzYwMDAwJyksIC8vIDEgbWludXRlXG4gICAgICBtYXhSZXF1ZXN0czogcGFyc2VJbnQocHJvY2Vzcy5lbnYuUkFURV9MSU1JVF9NQVhfUkVRVUVTVFMgfHwgJzEwMCcpLCAvLyAxMDAgcmVxdWVzdHMgcGVyIG1pbnV0ZVxuICAgICAgc2tpcFN1Y2Nlc3NmdWxSZXF1ZXN0czogcHJvY2Vzcy5lbnYuUkFURV9MSU1JVF9TS0lQX1NVQ0NFU1MgPT09ICd0cnVlJyxcbiAgICAgIHNraXBGYWlsZWRSZXF1ZXN0czogcHJvY2Vzcy5lbnYuUkFURV9MSU1JVF9TS0lQX0ZBSUxFRCA9PT0gJ3RydWUnXG4gICAgfTtcblxuICAgIHJldHVybiBuZXcgUmF0ZUxpbWl0ZXIoY2FjaGVNYW5hZ2VyLCBsb2dnZXIsIGRlZmF1bHRDb25maWcpO1xuICB9XG5cbiAgLyoqXG4gICAqIERlZmF1bHQga2V5IGdlbmVyYXRvciB1c2luZyBJUCBhZGRyZXNzXG4gICAqL1xuICBwcml2YXRlIGRlZmF1bHRLZXlHZW5lcmF0b3IocmVxdWVzdDogRmFzdGlmeVJlcXVlc3QpOiBzdHJpbmcge1xuICAgIGNvbnN0IGlwID0gcmVxdWVzdC5pcCB8fCAndW5rbm93bic7XG4gICAgY29uc3QgZW5kcG9pbnQgPSByZXF1ZXN0LnVybC5zcGxpdCgnPycpWzBdOyAvLyBSZW1vdmUgcXVlcnkgcGFyYW1ldGVyc1xuICAgIHJldHVybiBgcmF0ZV9saW1pdDoke2lwfToke2VuZHBvaW50fWA7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgcmF0ZSBsaW1pdCBmb3IgYSByZXF1ZXN0XG4gICAqL1xuICBhc3luYyBjaGVja1JhdGVMaW1pdChcbiAgICByZXF1ZXN0OiBGYXN0aWZ5UmVxdWVzdCxcbiAgICBjb25maWc/OiBQYXJ0aWFsPFJhdGVMaW1pdENvbmZpZz5cbiAgKTogUHJvbWlzZTxSYXRlTGltaXRSZXN1bHQ+IHtcbiAgICBjb25zdCBmaW5hbENvbmZpZyA9IHsgLi4udGhpcy5kZWZhdWx0Q29uZmlnLCAuLi5jb25maWcgfTtcbiAgICBjb25zdCBrZXlHZW5lcmF0b3IgPSBmaW5hbENvbmZpZy5rZXlHZW5lcmF0b3IgfHwgdGhpcy5kZWZhdWx0S2V5R2VuZXJhdG9yLmJpbmQodGhpcyk7XG4gICAgY29uc3Qga2V5ID0ga2V5R2VuZXJhdG9yKHJlcXVlc3QpO1xuICAgIFxuICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgY29uc3Qgd2luZG93U3RhcnQgPSBub3cgLSBmaW5hbENvbmZpZy53aW5kb3dNcztcbiAgICBcbiAgICB0cnkge1xuICAgICAgLy8gR2V0IGN1cnJlbnQgaGl0IGNvdW50IGZyb20gY2FjaGVcbiAgICAgIGNvbnN0IGhpdFJlc3VsdCA9IGF3YWl0IHRoaXMuY2FjaGVNYW5hZ2VyLmdldChrZXkpO1xuICAgICAgbGV0IGhpdHM6IEFycmF5PHsgdGltZXN0YW1wOiBudW1iZXI7IHN1Y2Nlc3M/OiBib29sZWFuIH0+ID0gW107XG4gICAgICBcbiAgICAgIGlmIChoaXRSZXN1bHQuc3VjY2VzcyAmJiBoaXRSZXN1bHQudmFsdWUpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBoaXRzID0gSlNPTi5wYXJzZShoaXRSZXN1bHQudmFsdWUpO1xuICAgICAgICAgIGlmICghQXJyYXkuaXNBcnJheShoaXRzKSkge1xuICAgICAgICAgICAgaGl0cyA9IFtdO1xuICAgICAgICAgIH1cbiAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICB0aGlzLmxvZ2dlci53YXJuKCdGYWlsZWQgdG8gcGFyc2UgcmF0ZSBsaW1pdCBkYXRhJywgdW5kZWZpbmVkLCB7IGtleSwgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKSB9KTtcbiAgICAgICAgICBoaXRzID0gW107XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgLy8gRmlsdGVyIGhpdHMgd2l0aGluIHRoZSBjdXJyZW50IHdpbmRvd1xuICAgICAgaGl0cyA9IGhpdHMuZmlsdGVyKGhpdCA9PiBoaXQudGltZXN0YW1wID4gd2luZG93U3RhcnQpO1xuXG4gICAgICAvLyBDb3VudCByZWxldmFudCBoaXRzIGJhc2VkIG9uIGNvbmZpZ3VyYXRpb25cbiAgICAgIGxldCByZWxldmFudEhpdHMgPSBoaXRzLmxlbmd0aDtcbiAgICAgIGlmIChmaW5hbENvbmZpZy5za2lwU3VjY2Vzc2Z1bFJlcXVlc3RzIHx8IGZpbmFsQ29uZmlnLnNraXBGYWlsZWRSZXF1ZXN0cykge1xuICAgICAgICByZWxldmFudEhpdHMgPSBoaXRzLmZpbHRlcihoaXQgPT4ge1xuICAgICAgICAgIGlmIChmaW5hbENvbmZpZy5za2lwU3VjY2Vzc2Z1bFJlcXVlc3RzICYmIGhpdC5zdWNjZXNzID09PSB0cnVlKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgfVxuICAgICAgICAgIGlmIChmaW5hbENvbmZpZy5za2lwRmFpbGVkUmVxdWVzdHMgJiYgaGl0LnN1Y2Nlc3MgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICAgICAgfVxuICAgICAgICAgIHJldHVybiB0cnVlO1xuICAgICAgICB9KS5sZW5ndGg7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGFsbG93ZWQgPSByZWxldmFudEhpdHMgPCBmaW5hbENvbmZpZy5tYXhSZXF1ZXN0cztcbiAgICAgIGNvbnN0IHJlbWFpbmluZyA9IE1hdGgubWF4KDAsIGZpbmFsQ29uZmlnLm1heFJlcXVlc3RzIC0gcmVsZXZhbnRIaXRzKTtcbiAgICAgIGNvbnN0IHJlc2V0VGltZSA9IHdpbmRvd1N0YXJ0ICsgZmluYWxDb25maWcud2luZG93TXM7XG5cbiAgICAgIC8vIEFkZCBjdXJyZW50IHJlcXVlc3QgdG8gaGl0cyBpZiB3ZSdyZSB0cmFja2luZyBpdFxuICAgICAgaWYgKGFsbG93ZWQpIHtcbiAgICAgICAgaGl0cy5wdXNoKHsgdGltZXN0YW1wOiBub3cgfSk7XG4gICAgICAgIFxuICAgICAgICAvLyBTdG9yZSB1cGRhdGVkIGhpdHMgd2l0aCBUVExcbiAgICAgICAgY29uc3QgdHRsTXMgPSBNYXRoLmNlaWwoZmluYWxDb25maWcud2luZG93TXMgLyAxMDAwKTtcbiAgICAgICAgYXdhaXQgdGhpcy5jYWNoZU1hbmFnZXIuc2V0KGtleSwgSlNPTi5zdHJpbmdpZnkoaGl0cyksIHR0bE1zKTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgYWxsb3dlZCxcbiAgICAgICAgcmVtYWluaW5nLFxuICAgICAgICByZXNldFRpbWUsXG4gICAgICAgIHRvdGFsSGl0czogaGl0cy5sZW5ndGhcbiAgICAgIH07XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdSYXRlIGxpbWl0IGNoZWNrIGZhaWxlZCcsIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvciA6IG5ldyBFcnJvcihTdHJpbmcoZXJyb3IpKSwgdW5kZWZpbmVkLCB7IGtleSB9KTtcbiAgICAgIFxuICAgICAgLy8gT24gZXJyb3IsIGFsbG93IHRoZSByZXF1ZXN0IChmYWlsIG9wZW4pXG4gICAgICByZXR1cm4ge1xuICAgICAgICBhbGxvd2VkOiB0cnVlLFxuICAgICAgICByZW1haW5pbmc6IGZpbmFsQ29uZmlnLm1heFJlcXVlc3RzLFxuICAgICAgICByZXNldFRpbWU6IG5vdyArIGZpbmFsQ29uZmlnLndpbmRvd01zLFxuICAgICAgICB0b3RhbEhpdHM6IDBcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFVwZGF0ZSByYXRlIGxpbWl0IGFmdGVyIHJlc3BvbnNlIChmb3IgY29uZGl0aW9uYWwgY291bnRpbmcpXG4gICAqL1xuICBhc3luYyB1cGRhdGVSYXRlTGltaXQoXG4gICAgcmVxdWVzdDogRmFzdGlmeVJlcXVlc3QsXG4gICAgc3VjY2VzczogYm9vbGVhbixcbiAgICBjb25maWc/OiBQYXJ0aWFsPFJhdGVMaW1pdENvbmZpZz5cbiAgKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgZmluYWxDb25maWcgPSB7IC4uLnRoaXMuZGVmYXVsdENvbmZpZywgLi4uY29uZmlnIH07XG4gICAgXG4gICAgLy8gT25seSB1cGRhdGUgaWYgd2UncmUgY29uZGl0aW9uYWxseSBjb3VudGluZyByZXF1ZXN0c1xuICAgIGlmICghZmluYWxDb25maWcuc2tpcFN1Y2Nlc3NmdWxSZXF1ZXN0cyAmJiAhZmluYWxDb25maWcuc2tpcEZhaWxlZFJlcXVlc3RzKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgY29uc3Qga2V5R2VuZXJhdG9yID0gZmluYWxDb25maWcua2V5R2VuZXJhdG9yIHx8IHRoaXMuZGVmYXVsdEtleUdlbmVyYXRvci5iaW5kKHRoaXMpO1xuICAgIGNvbnN0IGtleSA9IGtleUdlbmVyYXRvcihyZXF1ZXN0KTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgY29uc3QgaGl0UmVzdWx0ID0gYXdhaXQgdGhpcy5jYWNoZU1hbmFnZXIuZ2V0KGtleSk7XG4gICAgICBpZiAoIWhpdFJlc3VsdC5zdWNjZXNzIHx8ICFoaXRSZXN1bHQudmFsdWUpIHJldHVybjtcblxuICAgICAgbGV0IGhpdHM6IEFycmF5PHsgdGltZXN0YW1wOiBudW1iZXI7IHN1Y2Nlc3M/OiBib29sZWFuIH0+ID0gSlNPTi5wYXJzZShoaXRSZXN1bHQudmFsdWUpO1xuICAgICAgXG4gICAgICAvLyBVcGRhdGUgdGhlIG1vc3QgcmVjZW50IGhpdCB3aXRoIHN1Y2Nlc3Mgc3RhdHVzXG4gICAgICBpZiAoaGl0cy5sZW5ndGggPiAwKSB7XG4gICAgICAgIGhpdHNbaGl0cy5sZW5ndGggLSAxXS5zdWNjZXNzID0gc3VjY2VzcztcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IHR0bE1zID0gTWF0aC5jZWlsKGZpbmFsQ29uZmlnLndpbmRvd01zIC8gMTAwMCk7XG4gICAgICAgIGF3YWl0IHRoaXMuY2FjaGVNYW5hZ2VyLnNldChrZXksIEpTT04uc3RyaW5naWZ5KGhpdHMpLCB0dGxNcyk7XG4gICAgICB9XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHRoaXMubG9nZ2VyLndhcm4oJ0ZhaWxlZCB0byB1cGRhdGUgcmF0ZSBsaW1pdCcsIHVuZGVmaW5lZCwgeyBcbiAgICAgICAga2V5LCBcbiAgICAgICAgc3VjY2VzcywgXG4gICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6IFN0cmluZyhlcnJvcikgXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIHJhdGUgbGltaXRpbmcgbWlkZGxld2FyZVxuICAgKi9cbiAgY3JlYXRlTWlkZGxld2FyZShjb25maWc/OiBQYXJ0aWFsPFJhdGVMaW1pdENvbmZpZz4pIHtcbiAgICByZXR1cm4gYXN5bmMgKFxuICAgICAgcmVxdWVzdDogRmFzdGlmeVJlcXVlc3QsXG4gICAgICByZXBseTogRmFzdGlmeVJlcGx5LFxuICAgICAgZG9uZTogSG9va0hhbmRsZXJEb25lRnVuY3Rpb25cbiAgICApOiBQcm9taXNlPHZvaWQ+ID0+IHtcbiAgICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgICBcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHRoaXMuY2hlY2tSYXRlTGltaXQocmVxdWVzdCwgY29uZmlnKTtcbiAgICAgICAgXG4gICAgICAgIC8vIEFkZCByYXRlIGxpbWl0IGhlYWRlcnNcbiAgICAgICAgcmVwbHkuaGVhZGVyKCdYLVJhdGVMaW1pdC1MaW1pdCcsIChjb25maWc/Lm1heFJlcXVlc3RzIHx8IHRoaXMuZGVmYXVsdENvbmZpZy5tYXhSZXF1ZXN0cykudG9TdHJpbmcoKSk7XG4gICAgICAgIHJlcGx5LmhlYWRlcignWC1SYXRlTGltaXQtUmVtYWluaW5nJywgcmVzdWx0LnJlbWFpbmluZy50b1N0cmluZygpKTtcbiAgICAgICAgcmVwbHkuaGVhZGVyKCdYLVJhdGVMaW1pdC1SZXNldCcsIE1hdGguY2VpbChyZXN1bHQucmVzZXRUaW1lIC8gMTAwMCkudG9TdHJpbmcoKSk7XG5cbiAgICAgICAgaWYgKCFyZXN1bHQuYWxsb3dlZCkge1xuICAgICAgICAgIC8vIExvZyByYXRlIGxpbWl0IGV4Y2VlZGVkXG4gICAgICAgICAgdGhpcy5sb2dnZXIubG9nU2VjdXJpdHlFdmVudChcbiAgICAgICAgICAgICdSYXRlIGxpbWl0IGV4Y2VlZGVkJyxcbiAgICAgICAgICAgICdtZWRpdW0nLFxuICAgICAgICAgICAgKHJlcXVlc3QgYXMgYW55KS5jb3JyZWxhdGlvbklkLFxuICAgICAgICAgICAge1xuICAgICAgICAgICAgICBpcDogcmVxdWVzdC5pcCxcbiAgICAgICAgICAgICAgZW5kcG9pbnQ6IHJlcXVlc3QudXJsLFxuICAgICAgICAgICAgICBtZXRob2Q6IHJlcXVlc3QubWV0aG9kLFxuICAgICAgICAgICAgICB1c2VyQWdlbnQ6IHJlcXVlc3QuaGVhZGVyc1sndXNlci1hZ2VudCddLFxuICAgICAgICAgICAgICB0b3RhbEhpdHM6IHJlc3VsdC50b3RhbEhpdHMsXG4gICAgICAgICAgICAgIGxpbWl0OiBjb25maWc/Lm1heFJlcXVlc3RzIHx8IHRoaXMuZGVmYXVsdENvbmZpZy5tYXhSZXF1ZXN0c1xuICAgICAgICAgICAgfVxuICAgICAgICAgICk7XG5cbiAgICAgICAgICAvLyBDYWxsIGN1c3RvbSBoYW5kbGVyIGlmIHByb3ZpZGVkXG4gICAgICAgICAgaWYgKGNvbmZpZz8ub25MaW1pdFJlYWNoZWQpIHtcbiAgICAgICAgICAgIGNvbmZpZy5vbkxpbWl0UmVhY2hlZChyZXF1ZXN0LCByZXBseSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHJlcGx5LnN0YXR1cyg0MjkpLnNlbmQoe1xuICAgICAgICAgICAgICBlcnJvcjogJ1RvbyBNYW55IFJlcXVlc3RzJyxcbiAgICAgICAgICAgICAgbWVzc2FnZTogJ1JhdGUgbGltaXQgZXhjZWVkZWQuIFBsZWFzZSB0cnkgYWdhaW4gbGF0ZXIuJyxcbiAgICAgICAgICAgICAgcmV0cnlBZnRlcjogTWF0aC5jZWlsKChyZXN1bHQucmVzZXRUaW1lIC0gRGF0ZS5ub3coKSkgLyAxMDAwKSxcbiAgICAgICAgICAgICAgdGltZXN0YW1wOiBuZXcgRGF0ZSgpLnRvSVNPU3RyaW5nKClcbiAgICAgICAgICAgIH0pO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm47XG4gICAgICAgIH1cblxuICAgICAgICAvLyBBZGQgcmVzcG9uc2UgaG9vayB0byB1cGRhdGUgcmF0ZSBsaW1pdCBpZiB1c2luZyBjb25kaXRpb25hbCBjb3VudGluZ1xuICAgICAgICBpZiAoY29uZmlnPy5za2lwU3VjY2Vzc2Z1bFJlcXVlc3RzIHx8IGNvbmZpZz8uc2tpcEZhaWxlZFJlcXVlc3RzKSB7XG4gICAgICAgICAgLy8gTm90ZTogRmFzdGlmeSBkb2Vzbid0IGhhdmUgYWRkSG9vayBvbiByZXBseSwgd2UgbmVlZCB0byB1c2UgYSBkaWZmZXJlbnQgYXBwcm9hY2hcbiAgICAgICAgICAvLyBGb3Igbm93LCB3ZSdsbCBza2lwIHRoaXMgZnVuY3Rpb25hbGl0eSBpbiB0aGUgbWlkZGxld2FyZVxuICAgICAgICAgIC8vIEluIGEgcmVhbCBpbXBsZW1lbnRhdGlvbiwgdGhpcyB3b3VsZCBiZSBoYW5kbGVkIGF0IHRoZSByb3V0ZSBsZXZlbFxuICAgICAgICB9XG5cbiAgICAgICAgLy8gTG9nIHJhdGUgbGltaXQgY2hlY2tcbiAgICAgICAgY29uc3QgZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xuICAgICAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhcbiAgICAgICAgICAnUmF0ZSBsaW1pdCBjaGVjayBjb21wbGV0ZWQnLFxuICAgICAgICAgIChyZXF1ZXN0IGFzIGFueSkuY29ycmVsYXRpb25JZCxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBpcDogcmVxdWVzdC5pcCxcbiAgICAgICAgICAgIGVuZHBvaW50OiByZXF1ZXN0LnVybCxcbiAgICAgICAgICAgIGFsbG93ZWQ6IHJlc3VsdC5hbGxvd2VkLFxuICAgICAgICAgICAgcmVtYWluaW5nOiByZXN1bHQucmVtYWluaW5nLFxuICAgICAgICAgICAgZHVyYXRpb25cbiAgICAgICAgICB9XG4gICAgICAgICk7XG5cbiAgICAgICAgZG9uZSgpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgICAgJ1JhdGUgbGltaXQgbWlkZGxld2FyZSBlcnJvcicsXG4gICAgICAgICAgZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yIDogbmV3IEVycm9yKFN0cmluZyhlcnJvcikpLFxuICAgICAgICAgIChyZXF1ZXN0IGFzIGFueSkuY29ycmVsYXRpb25JZCxcbiAgICAgICAgICB7XG4gICAgICAgICAgICBpcDogcmVxdWVzdC5pcCxcbiAgICAgICAgICAgIGVuZHBvaW50OiByZXF1ZXN0LnVybFxuICAgICAgICAgIH1cbiAgICAgICAgKTtcbiAgICAgICAgXG4gICAgICAgIC8vIE9uIGVycm9yLCBhbGxvdyB0aGUgcmVxdWVzdCAoZmFpbCBvcGVuKVxuICAgICAgICBkb25lKCk7XG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgZW5kcG9pbnQtc3BlY2lmaWMgcmF0ZSBsaW1pdGluZyBtaWRkbGV3YXJlXG4gICAqL1xuICBjcmVhdGVFbmRwb2ludE1pZGRsZXdhcmUoZW5kcG9pbnRDb25maWdzOiBSZWNvcmQ8c3RyaW5nLCBQYXJ0aWFsPFJhdGVMaW1pdENvbmZpZz4+KSB7XG4gICAgcmV0dXJuIGFzeW5jIChcbiAgICAgIHJlcXVlc3Q6IEZhc3RpZnlSZXF1ZXN0LFxuICAgICAgcmVwbHk6IEZhc3RpZnlSZXBseSxcbiAgICAgIGRvbmU6IEhvb2tIYW5kbGVyRG9uZUZ1bmN0aW9uXG4gICAgKTogUHJvbWlzZTx2b2lkPiA9PiB7XG4gICAgICBjb25zdCBlbmRwb2ludCA9IHJlcXVlc3QudXJsLnNwbGl0KCc/JylbMF07IC8vIFJlbW92ZSBxdWVyeSBwYXJhbWV0ZXJzXG4gICAgICBjb25zdCBjb25maWcgPSBlbmRwb2ludENvbmZpZ3NbZW5kcG9pbnRdO1xuICAgICAgXG4gICAgICBpZiAoIWNvbmZpZykge1xuICAgICAgICAvLyBObyBzcGVjaWZpYyBjb25maWcgZm9yIHRoaXMgZW5kcG9pbnQsIHVzZSBkZWZhdWx0XG4gICAgICAgIGNvbnN0IGRlZmF1bHRNaWRkbGV3YXJlID0gdGhpcy5jcmVhdGVNaWRkbGV3YXJlKCk7XG4gICAgICAgIHJldHVybiBkZWZhdWx0TWlkZGxld2FyZShyZXF1ZXN0LCByZXBseSwgZG9uZSk7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGVuZHBvaW50TWlkZGxld2FyZSA9IHRoaXMuY3JlYXRlTWlkZGxld2FyZShjb25maWcpO1xuICAgICAgcmV0dXJuIGVuZHBvaW50TWlkZGxld2FyZShyZXF1ZXN0LCByZXBseSwgZG9uZSk7XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZXNldCByYXRlIGxpbWl0IGZvciBhIHNwZWNpZmljIGtleVxuICAgKi9cbiAgYXN5bmMgcmVzZXRSYXRlTGltaXQoa2V5OiBzdHJpbmcpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgdGhpcy5jYWNoZU1hbmFnZXIuZGVsZXRlKGtleSk7XG4gICAgICB0aGlzLmxvZ2dlci5pbmZvKCdSYXRlIGxpbWl0IHJlc2V0JywgdW5kZWZpbmVkLCB7IGtleSB9KTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoXG4gICAgICAgICdGYWlsZWQgdG8gcmVzZXQgcmF0ZSBsaW1pdCcsXG4gICAgICAgIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvciA6IG5ldyBFcnJvcihTdHJpbmcoZXJyb3IpKSxcbiAgICAgICAgdW5kZWZpbmVkLFxuICAgICAgICB7IGtleSB9XG4gICAgICApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgcmF0ZSBsaW1pdCBzdGF0dXMgZm9yIGEga2V5XG4gICAqL1xuICBhc3luYyBnZXRSYXRlTGltaXRTdGF0dXMoa2V5OiBzdHJpbmcpOiBQcm9taXNlPHtcbiAgICBoaXRzOiBudW1iZXI7XG4gICAgcmVtYWluaW5nOiBudW1iZXI7XG4gICAgcmVzZXRUaW1lOiBudW1iZXI7XG4gIH0gfCBudWxsPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IGhpdFJlc3VsdCA9IGF3YWl0IHRoaXMuY2FjaGVNYW5hZ2VyLmdldChrZXkpO1xuICAgICAgaWYgKCFoaXRSZXN1bHQuc3VjY2VzcyB8fCAhaGl0UmVzdWx0LnZhbHVlKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgaGl0czogMCxcbiAgICAgICAgICByZW1haW5pbmc6IHRoaXMuZGVmYXVsdENvbmZpZy5tYXhSZXF1ZXN0cyxcbiAgICAgICAgICByZXNldFRpbWU6IERhdGUubm93KCkgKyB0aGlzLmRlZmF1bHRDb25maWcud2luZG93TXNcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgaGl0czogQXJyYXk8eyB0aW1lc3RhbXA6IG51bWJlciB9PiA9IEpTT04ucGFyc2UoaGl0UmVzdWx0LnZhbHVlKTtcbiAgICAgIGNvbnN0IG5vdyA9IERhdGUubm93KCk7XG4gICAgICBjb25zdCB3aW5kb3dTdGFydCA9IG5vdyAtIHRoaXMuZGVmYXVsdENvbmZpZy53aW5kb3dNcztcbiAgICAgIGNvbnN0IHZhbGlkSGl0cyA9IGhpdHMuZmlsdGVyKGhpdCA9PiBoaXQudGltZXN0YW1wID4gd2luZG93U3RhcnQpO1xuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBoaXRzOiB2YWxpZEhpdHMubGVuZ3RoLFxuICAgICAgICByZW1haW5pbmc6IE1hdGgubWF4KDAsIHRoaXMuZGVmYXVsdENvbmZpZy5tYXhSZXF1ZXN0cyAtIHZhbGlkSGl0cy5sZW5ndGgpLFxuICAgICAgICByZXNldFRpbWU6IHdpbmRvd1N0YXJ0ICsgdGhpcy5kZWZhdWx0Q29uZmlnLndpbmRvd01zXG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcihcbiAgICAgICAgJ0ZhaWxlZCB0byBnZXQgcmF0ZSBsaW1pdCBzdGF0dXMnLFxuICAgICAgICBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IgOiBuZXcgRXJyb3IoU3RyaW5nKGVycm9yKSksXG4gICAgICAgIHVuZGVmaW5lZCxcbiAgICAgICAgeyBrZXkgfVxuICAgICAgKTtcbiAgICAgIHJldHVybiBudWxsO1xuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIERlZmF1bHQgcmF0ZSBsaW1pdCBjb25maWd1cmF0aW9ucyBmb3IgZGlmZmVyZW50IGVuZHBvaW50c1xuICovXG5leHBvcnQgY29uc3QgREVGQVVMVF9FTkRQT0lOVF9DT05GSUdTOiBSZWNvcmQ8c3RyaW5nLCBQYXJ0aWFsPFJhdGVMaW1pdENvbmZpZz4+ID0ge1xuICAnL3NpZ25hbCc6IHtcbiAgICB3aW5kb3dNczogNjAwMDAsICAgIC8vIDEgbWludXRlXG4gICAgbWF4UmVxdWVzdHM6IDYwLCAgICAvLyA2MCBzaWduYWxzIHBlciBtaW51dGVcbiAgICBza2lwRmFpbGVkUmVxdWVzdHM6IHRydWUgIC8vIERvbid0IGNvdW50IGZhaWxlZCBzaWduYWxzXG4gIH0sXG4gICcvd2ViaG9vay9waGFzZTEnOiB7XG4gICAgd2luZG93TXM6IDYwMDAwLCAgICAvLyAxIG1pbnV0ZVxuICAgIG1heFJlcXVlc3RzOiAxMjAsICAgLy8gMTIwIHdlYmhvb2tzIHBlciBtaW51dGVcbiAgICBza2lwRmFpbGVkUmVxdWVzdHM6IHRydWVcbiAgfSxcbiAgJy93ZWJob29rL3BoYXNlMic6IHtcbiAgICB3aW5kb3dNczogNjAwMDAsICAgIC8vIDEgbWludXRlXG4gICAgbWF4UmVxdWVzdHM6IDYwLCAgICAvLyA2MCB3ZWJob29rcyBwZXIgbWludXRlXG4gICAgc2tpcEZhaWxlZFJlcXVlc3RzOiB0cnVlXG4gIH0sXG4gICcvd2ViaG9vay9waGFzZTMnOiB7XG4gICAgd2luZG93TXM6IDYwMDAwLCAgICAvLyAxIG1pbnV0ZVxuICAgIG1heFJlcXVlc3RzOiAzMCwgICAgLy8gMzAgd2ViaG9va3MgcGVyIG1pbnV0ZVxuICAgIHNraXBGYWlsZWRSZXF1ZXN0czogdHJ1ZVxuICB9LFxuICAnL2FkbWluL292ZXJyaWRlJzoge1xuICAgIHdpbmRvd01zOiAzMDAwMDAsICAgLy8gNSBtaW51dGVzXG4gICAgbWF4UmVxdWVzdHM6IDUsICAgICAvLyA1IG92ZXJyaWRlIGF0dGVtcHRzIHBlciA1IG1pbnV0ZXNcbiAgICBza2lwU3VjY2Vzc2Z1bFJlcXVlc3RzOiBmYWxzZSxcbiAgICBza2lwRmFpbGVkUmVxdWVzdHM6IGZhbHNlXG4gIH0sXG4gICcvYnJlYWtlci9yZXNldCc6IHtcbiAgICB3aW5kb3dNczogMzAwMDAwLCAgIC8vIDUgbWludXRlc1xuICAgIG1heFJlcXVlc3RzOiAxMCwgICAgLy8gMTAgcmVzZXQgYXR0ZW1wdHMgcGVyIDUgbWludXRlc1xuICAgIHNraXBTdWNjZXNzZnVsUmVxdWVzdHM6IGZhbHNlLFxuICAgIHNraXBGYWlsZWRSZXF1ZXN0czogZmFsc2VcbiAgfSxcbiAgJy9kYXNoYm9hcmQnOiB7XG4gICAgd2luZG93TXM6IDYwMDAwLCAgICAvLyAxIG1pbnV0ZVxuICAgIG1heFJlcXVlc3RzOiAzMDAsICAgLy8gMzAwIGRhc2hib2FyZCByZXF1ZXN0cyBwZXIgbWludXRlXG4gICAgc2tpcEZhaWxlZFJlcXVlc3RzOiB0cnVlXG4gIH0sXG4gICcvbWV0cmljcyc6IHtcbiAgICB3aW5kb3dNczogNjAwMDAsICAgIC8vIDEgbWludXRlXG4gICAgbWF4UmVxdWVzdHM6IDYwMCwgICAvLyA2MDAgbWV0cmljcyByZXF1ZXN0cyBwZXIgbWludXRlIChmb3IgbW9uaXRvcmluZylcbiAgICBza2lwRmFpbGVkUmVxdWVzdHM6IHRydWVcbiAgfVxufTtcblxuLyoqXG4gKiBSYXRlIGxpbWl0ZXIgcGx1Z2luIGZvciBGYXN0aWZ5XG4gKi9cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByYXRlTGltaXRlclBsdWdpbihcbiAgZmFzdGlmeTogYW55LFxuICBvcHRpb25zOiB7XG4gICAgY2FjaGVNYW5hZ2VyOiBDYWNoZU1hbmFnZXI7XG4gICAgbG9nZ2VyOiBMb2dnZXI7XG4gICAgZGVmYXVsdENvbmZpZz86IFJhdGVMaW1pdENvbmZpZztcbiAgICBlbmRwb2ludENvbmZpZ3M/OiBSZWNvcmQ8c3RyaW5nLCBQYXJ0aWFsPFJhdGVMaW1pdENvbmZpZz4+O1xuICB9XG4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgY29uc3QgcmF0ZUxpbWl0ZXIgPSBuZXcgUmF0ZUxpbWl0ZXIoXG4gICAgb3B0aW9ucy5jYWNoZU1hbmFnZXIsXG4gICAgb3B0aW9ucy5sb2dnZXIsXG4gICAgb3B0aW9ucy5kZWZhdWx0Q29uZmlnIHx8IHtcbiAgICAgIHdpbmRvd01zOiA2MDAwMCxcbiAgICAgIG1heFJlcXVlc3RzOiAxMDBcbiAgICB9XG4gICk7XG5cbiAgY29uc3QgZW5kcG9pbnRDb25maWdzID0gb3B0aW9ucy5lbmRwb2ludENvbmZpZ3MgfHwgREVGQVVMVF9FTkRQT0lOVF9DT05GSUdTO1xuICBjb25zdCBtaWRkbGV3YXJlID0gcmF0ZUxpbWl0ZXIuY3JlYXRlRW5kcG9pbnRNaWRkbGV3YXJlKGVuZHBvaW50Q29uZmlncyk7XG4gIFxuICBmYXN0aWZ5LmFkZEhvb2soJ3ByZUhhbmRsZXInLCBtaWRkbGV3YXJlKTtcbiAgXG4gIC8vIEFkZCByYXRlIGxpbWl0ZXIgaW5zdGFuY2UgdG8gZmFzdGlmeSBmb3IgYWNjZXNzIGluIHJvdXRlc1xuICBmYXN0aWZ5LmRlY29yYXRlKCdyYXRlTGltaXRlcicsIHJhdGVMaW1pdGVyKTtcbn0iXSwidmVyc2lvbiI6M30=
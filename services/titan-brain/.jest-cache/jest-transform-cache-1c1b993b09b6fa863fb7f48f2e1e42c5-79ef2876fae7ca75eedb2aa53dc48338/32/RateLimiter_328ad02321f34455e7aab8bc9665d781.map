{"file":"/Users/ivan/Code/trading/titan/services/titan-brain/src/middleware/RateLimiter.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-brain/src/middleware/RateLimiter.ts"],"sourcesContent":["/**\n * RateLimiter - Rate limiting middleware for Fastify\n * \n * Provides configurable rate limiting with Redis-based storage and in-memory fallback.\n * Supports different rate limits for different endpoints and includes proper headers.\n * \n * Requirements: 4.3.1, 4.3.2, 4.3.3, 4.3.4, 4.3.5\n */\n\nimport { FastifyRequest, FastifyReply, HookHandlerDoneFunction } from 'fastify';\nimport { CacheManager } from '../cache/CacheManager.js';\nimport { Logger } from '../logging/Logger.js';\n\n/**\n * Rate limit configuration for an endpoint\n */\nexport interface RateLimitConfig {\n  windowMs: number;      // Time window in milliseconds\n  maxRequests: number;   // Maximum requests per window\n  skipSuccessfulRequests?: boolean;  // Don't count successful requests\n  skipFailedRequests?: boolean;      // Don't count failed requests\n  keyGenerator?: (request: FastifyRequest) => string;  // Custom key generator\n  onLimitReached?: (request: FastifyRequest, reply: FastifyReply) => void;  // Custom limit handler\n}\n\n/**\n * Rate limit result\n */\nexport interface RateLimitResult {\n  allowed: boolean;\n  remaining: number;\n  resetTime: number;\n  totalHits: number;\n}\n\n/**\n * Rate limiter class\n */\nexport class RateLimiter {\n  private cacheManager: CacheManager;\n  private logger: Logger;\n  private defaultConfig: RateLimitConfig;\n\n  constructor(\n    cacheManager: CacheManager,\n    logger: Logger,\n    defaultConfig: RateLimitConfig\n  ) {\n    this.cacheManager = cacheManager;\n    this.logger = logger;\n    this.defaultConfig = defaultConfig;\n  }\n\n  /**\n   * Create rate limiter from environment variables\n   */\n  static createFromEnvironment(\n    cacheManager: CacheManager,\n    logger: Logger\n  ): RateLimiter {\n    const defaultConfig: RateLimitConfig = {\n      windowMs: parseInt(process.env.RATE_LIMIT_WINDOW_MS || '60000'), // 1 minute\n      maxRequests: parseInt(process.env.RATE_LIMIT_MAX_REQUESTS || '100'), // 100 requests per minute\n      skipSuccessfulRequests: process.env.RATE_LIMIT_SKIP_SUCCESS === 'true',\n      skipFailedRequests: process.env.RATE_LIMIT_SKIP_FAILED === 'true'\n    };\n\n    return new RateLimiter(cacheManager, logger, defaultConfig);\n  }\n\n  /**\n   * Default key generator using IP address\n   */\n  private defaultKeyGenerator(request: FastifyRequest): string {\n    const ip = request.ip || 'unknown';\n    const endpoint = request.url.split('?')[0]; // Remove query parameters\n    return `rate_limit:${ip}:${endpoint}`;\n  }\n\n  /**\n   * Check rate limit for a request\n   */\n  async checkRateLimit(\n    request: FastifyRequest,\n    config?: Partial<RateLimitConfig>\n  ): Promise<RateLimitResult> {\n    const finalConfig = { ...this.defaultConfig, ...config };\n    const keyGenerator = finalConfig.keyGenerator || this.defaultKeyGenerator.bind(this);\n    const key = keyGenerator(request);\n    \n    const now = Date.now();\n    const windowStart = now - finalConfig.windowMs;\n    \n    try {\n      // Get current hit count from cache\n      const hitResult = await this.cacheManager.get(key);\n      let hits: Array<{ timestamp: number; success?: boolean }> = [];\n      \n      if (hitResult.success && hitResult.value) {\n        try {\n          hits = JSON.parse(hitResult.value);\n          if (!Array.isArray(hits)) {\n            hits = [];\n          }\n        } catch (error) {\n          this.logger.warn('Failed to parse rate limit data', undefined, { key, error: error instanceof Error ? error.message : String(error) });\n          hits = [];\n        }\n      }\n\n      // Filter hits within the current window\n      hits = hits.filter(hit => hit.timestamp > windowStart);\n\n      // Count relevant hits based on configuration\n      let relevantHits = hits.length;\n      if (finalConfig.skipSuccessfulRequests || finalConfig.skipFailedRequests) {\n        relevantHits = hits.filter(hit => {\n          if (finalConfig.skipSuccessfulRequests && hit.success === true) {\n            return false;\n          }\n          if (finalConfig.skipFailedRequests && hit.success === false) {\n            return false;\n          }\n          return true;\n        }).length;\n      }\n\n      const allowed = relevantHits < finalConfig.maxRequests;\n      const remaining = Math.max(0, finalConfig.maxRequests - relevantHits);\n      const resetTime = windowStart + finalConfig.windowMs;\n\n      // Add current request to hits if we're tracking it\n      if (allowed) {\n        hits.push({ timestamp: now });\n        \n        // Store updated hits with TTL\n        const ttlMs = Math.ceil(finalConfig.windowMs / 1000);\n        await this.cacheManager.set(key, JSON.stringify(hits), ttlMs);\n      }\n\n      return {\n        allowed,\n        remaining,\n        resetTime,\n        totalHits: hits.length\n      };\n    } catch (error) {\n      this.logger.error('Rate limit check failed', error instanceof Error ? error : new Error(String(error)), undefined, { key });\n      \n      // On error, allow the request (fail open)\n      return {\n        allowed: true,\n        remaining: finalConfig.maxRequests,\n        resetTime: now + finalConfig.windowMs,\n        totalHits: 0\n      };\n    }\n  }\n\n  /**\n   * Update rate limit after response (for conditional counting)\n   */\n  async updateRateLimit(\n    request: FastifyRequest,\n    success: boolean,\n    config?: Partial<RateLimitConfig>\n  ): Promise<void> {\n    const finalConfig = { ...this.defaultConfig, ...config };\n    \n    // Only update if we're conditionally counting requests\n    if (!finalConfig.skipSuccessfulRequests && !finalConfig.skipFailedRequests) {\n      return;\n    }\n\n    const keyGenerator = finalConfig.keyGenerator || this.defaultKeyGenerator.bind(this);\n    const key = keyGenerator(request);\n    \n    try {\n      const hitResult = await this.cacheManager.get(key);\n      if (!hitResult.success || !hitResult.value) return;\n\n      let hits: Array<{ timestamp: number; success?: boolean }> = JSON.parse(hitResult.value);\n      \n      // Update the most recent hit with success status\n      if (hits.length > 0) {\n        hits[hits.length - 1].success = success;\n        \n        const ttlMs = Math.ceil(finalConfig.windowMs / 1000);\n        await this.cacheManager.set(key, JSON.stringify(hits), ttlMs);\n      }\n    } catch (error) {\n      this.logger.warn('Failed to update rate limit', undefined, { \n        key, \n        success, \n        error: error instanceof Error ? error.message : String(error) \n      });\n    }\n  }\n\n  /**\n   * Create rate limiting middleware\n   */\n  createMiddleware(config?: Partial<RateLimitConfig>) {\n    return async (\n      request: FastifyRequest,\n      reply: FastifyReply,\n      done: HookHandlerDoneFunction\n    ): Promise<void> => {\n      const startTime = Date.now();\n      \n      try {\n        const result = await this.checkRateLimit(request, config);\n        \n        // Add rate limit headers\n        reply.header('X-RateLimit-Limit', (config?.maxRequests || this.defaultConfig.maxRequests).toString());\n        reply.header('X-RateLimit-Remaining', result.remaining.toString());\n        reply.header('X-RateLimit-Reset', Math.ceil(result.resetTime / 1000).toString());\n\n        if (!result.allowed) {\n          // Log rate limit exceeded\n          this.logger.logSecurityEvent(\n            'Rate limit exceeded',\n            'medium',\n            (request as any).correlationId,\n            {\n              ip: request.ip,\n              endpoint: request.url,\n              method: request.method,\n              userAgent: request.headers['user-agent'],\n              totalHits: result.totalHits,\n              limit: config?.maxRequests || this.defaultConfig.maxRequests\n            }\n          );\n\n          // Call custom handler if provided\n          if (config?.onLimitReached) {\n            config.onLimitReached(request, reply);\n          } else {\n            reply.status(429).send({\n              error: 'Too Many Requests',\n              message: 'Rate limit exceeded. Please try again later.',\n              retryAfter: Math.ceil((result.resetTime - Date.now()) / 1000),\n              timestamp: new Date().toISOString()\n            });\n          }\n          return;\n        }\n\n        // Add response hook to update rate limit if using conditional counting\n        if (config?.skipSuccessfulRequests || config?.skipFailedRequests) {\n          // Note: Fastify doesn't have addHook on reply, we need to use a different approach\n          // For now, we'll skip this functionality in the middleware\n          // In a real implementation, this would be handled at the route level\n        }\n\n        // Log rate limit check\n        const duration = Date.now() - startTime;\n        this.logger.debug(\n          'Rate limit check completed',\n          (request as any).correlationId,\n          {\n            ip: request.ip,\n            endpoint: request.url,\n            allowed: result.allowed,\n            remaining: result.remaining,\n            duration\n          }\n        );\n\n        done();\n      } catch (error) {\n        this.logger.error(\n          'Rate limit middleware error',\n          error instanceof Error ? error : new Error(String(error)),\n          (request as any).correlationId,\n          {\n            ip: request.ip,\n            endpoint: request.url\n          }\n        );\n        \n        // On error, allow the request (fail open)\n        done();\n      }\n    };\n  }\n\n  /**\n   * Create endpoint-specific rate limiting middleware\n   */\n  createEndpointMiddleware(endpointConfigs: Record<string, Partial<RateLimitConfig>>) {\n    return async (\n      request: FastifyRequest,\n      reply: FastifyReply,\n      done: HookHandlerDoneFunction\n    ): Promise<void> => {\n      const endpoint = request.url.split('?')[0]; // Remove query parameters\n      const config = endpointConfigs[endpoint];\n      \n      if (!config) {\n        // No specific config for this endpoint, use default\n        const defaultMiddleware = this.createMiddleware();\n        return defaultMiddleware(request, reply, done);\n      }\n\n      const endpointMiddleware = this.createMiddleware(config);\n      return endpointMiddleware(request, reply, done);\n    };\n  }\n\n  /**\n   * Reset rate limit for a specific key\n   */\n  async resetRateLimit(key: string): Promise<void> {\n    try {\n      await this.cacheManager.delete(key);\n      this.logger.info('Rate limit reset', undefined, { key });\n    } catch (error) {\n      this.logger.error(\n        'Failed to reset rate limit',\n        error instanceof Error ? error : new Error(String(error)),\n        undefined,\n        { key }\n      );\n    }\n  }\n\n  /**\n   * Get rate limit status for a key\n   */\n  async getRateLimitStatus(key: string): Promise<{\n    hits: number;\n    remaining: number;\n    resetTime: number;\n  } | null> {\n    try {\n      const hitResult = await this.cacheManager.get(key);\n      if (!hitResult.success || !hitResult.value) {\n        return {\n          hits: 0,\n          remaining: this.defaultConfig.maxRequests,\n          resetTime: Date.now() + this.defaultConfig.windowMs\n        };\n      }\n\n      const hits: Array<{ timestamp: number }> = JSON.parse(hitResult.value);\n      const now = Date.now();\n      const windowStart = now - this.defaultConfig.windowMs;\n      const validHits = hits.filter(hit => hit.timestamp > windowStart);\n\n      return {\n        hits: validHits.length,\n        remaining: Math.max(0, this.defaultConfig.maxRequests - validHits.length),\n        resetTime: windowStart + this.defaultConfig.windowMs\n      };\n    } catch (error) {\n      this.logger.error(\n        'Failed to get rate limit status',\n        error instanceof Error ? error : new Error(String(error)),\n        undefined,\n        { key }\n      );\n      return null;\n    }\n  }\n}\n\n/**\n * Default rate limit configurations for different endpoints\n */\nexport const DEFAULT_ENDPOINT_CONFIGS: Record<string, Partial<RateLimitConfig>> = {\n  '/signal': {\n    windowMs: 60000,    // 1 minute\n    maxRequests: 60,    // 60 signals per minute\n    skipFailedRequests: true  // Don't count failed signals\n  },\n  '/webhook/phase1': {\n    windowMs: 60000,    // 1 minute\n    maxRequests: 120,   // 120 webhooks per minute\n    skipFailedRequests: true\n  },\n  '/webhook/phase2': {\n    windowMs: 60000,    // 1 minute\n    maxRequests: 60,    // 60 webhooks per minute\n    skipFailedRequests: true\n  },\n  '/webhook/phase3': {\n    windowMs: 60000,    // 1 minute\n    maxRequests: 30,    // 30 webhooks per minute\n    skipFailedRequests: true\n  },\n  '/admin/override': {\n    windowMs: 300000,   // 5 minutes\n    maxRequests: 5,     // 5 override attempts per 5 minutes\n    skipSuccessfulRequests: false,\n    skipFailedRequests: false\n  },\n  '/breaker/reset': {\n    windowMs: 300000,   // 5 minutes\n    maxRequests: 10,    // 10 reset attempts per 5 minutes\n    skipSuccessfulRequests: false,\n    skipFailedRequests: false\n  },\n  '/dashboard': {\n    windowMs: 60000,    // 1 minute\n    maxRequests: 300,   // 300 dashboard requests per minute\n    skipFailedRequests: true\n  },\n  '/metrics': {\n    windowMs: 60000,    // 1 minute\n    maxRequests: 600,   // 600 metrics requests per minute (for monitoring)\n    skipFailedRequests: true\n  }\n};\n\n/**\n * Rate limiter plugin for Fastify\n */\nexport async function rateLimiterPlugin(\n  fastify: any,\n  options: {\n    cacheManager: CacheManager;\n    logger: Logger;\n    defaultConfig?: RateLimitConfig;\n    endpointConfigs?: Record<string, Partial<RateLimitConfig>>;\n  }\n): Promise<void> {\n  const rateLimiter = new RateLimiter(\n    options.cacheManager,\n    options.logger,\n    options.defaultConfig || {\n      windowMs: 60000,\n      maxRequests: 100\n    }\n  );\n\n  const endpointConfigs = options.endpointConfigs || DEFAULT_ENDPOINT_CONFIGS;\n  const middleware = rateLimiter.createEndpointMiddleware(endpointConfigs);\n  \n  fastify.addHook('preHandler', middleware);\n  \n  // Add rate limiter instance to fastify for access in routes\n  fastify.decorate('rateLimiter', rateLimiter);\n}"],"version":3}
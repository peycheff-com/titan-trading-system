{"file":"/Users/ivan/Code/trading/titan/services/titan-brain/src/server/NotificationService.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-brain/src/server/NotificationService.ts"],"sourcesContent":["/**\n * Notification Service for Titan Brain\n * Handles all notification channels (Telegram, email) for alerts\n */\n\nimport { NotificationConfig } from '../types/config.js';\nimport { PhaseId } from '../types/performance.js';\n\n/**\n * Notification types for different alert categories\n */\nexport enum NotificationType {\n  CIRCUIT_BREAKER = 'CIRCUIT_BREAKER',\n  HIGH_CORRELATION = 'HIGH_CORRELATION', \n  SWEEP_NOTIFICATION = 'SWEEP_NOTIFICATION',\n  VETO_NOTIFICATION = 'VETO_NOTIFICATION',\n  SYSTEM_ERROR = 'SYSTEM_ERROR',\n}\n\n/**\n * Notification message interface\n */\nexport interface NotificationMessage {\n  type: NotificationType;\n  title: string;\n  message: string;\n  priority: 'LOW' | 'MEDIUM' | 'HIGH' | 'CRITICAL';\n  timestamp: number;\n  metadata?: Record<string, any>;\n}\n\n/**\n * Circuit breaker notification data\n */\nexport interface CircuitBreakerNotification {\n  reason: string;\n  equity: number;\n  drawdown: number;\n  triggeredAt: number;\n}\n\n/**\n * High correlation warning data\n */\nexport interface HighCorrelationNotification {\n  correlationScore: number;\n  threshold: number;\n  affectedPositions: string[];\n}\n\n/**\n * Sweep notification data\n */\nexport interface SweepNotification {\n  amount: number;\n  fromWallet: string;\n  toWallet: string;\n  reason: string;\n  newBalance: number;\n}\n\n/**\n * Veto notification data\n */\nexport interface VetoNotification {\n  phaseId: PhaseId;\n  signalId: string;\n  symbol: string;\n  reason: string;\n  requestedSize: number;\n}\n\n/**\n * Notification service for sending alerts via multiple channels\n */\nexport class NotificationService {\n  private config: NotificationConfig;\n  private retryAttempts = 3;\n  private retryDelay = 1000; // 1 second base delay\n\n  constructor(config: NotificationConfig) {\n    this.config = config;\n  }\n\n  /**\n   * Send circuit breaker emergency notification\n   * Requirement 5.6: Send emergency notifications via all configured channels\n   */\n  async sendCircuitBreakerNotification(data: CircuitBreakerNotification): Promise<void> {\n    const message: NotificationMessage = {\n      type: NotificationType.CIRCUIT_BREAKER,\n      title: 'üö® CIRCUIT BREAKER TRIGGERED',\n      message: this.formatCircuitBreakerMessage(data),\n      priority: 'CRITICAL',\n      timestamp: Date.now(),\n      metadata: data,\n    };\n\n    await this.sendNotification(message);\n  }\n\n  /**\n   * Send high correlation warning\n   * Requirement 6.5: Display warning when correlation exceeds threshold\n   */\n  async sendHighCorrelationWarning(data: HighCorrelationNotification): Promise<void> {\n    const message: NotificationMessage = {\n      type: NotificationType.HIGH_CORRELATION,\n      title: '‚ö†Ô∏è HIGH CORRELATION WARNING',\n      message: this.formatHighCorrelationMessage(data),\n      priority: 'HIGH',\n      timestamp: Date.now(),\n      metadata: data,\n    };\n\n    await this.sendNotification(message);\n  }\n\n  /**\n   * Send sweep notification\n   * Requirement 4.7: Log all sweep transactions\n   */\n  async sendSweepNotification(data: SweepNotification): Promise<void> {\n    const message: NotificationMessage = {\n      type: NotificationType.SWEEP_NOTIFICATION,\n      title: 'üí∞ PROFIT SWEEP EXECUTED',\n      message: this.formatSweepMessage(data),\n      priority: 'MEDIUM',\n      timestamp: Date.now(),\n      metadata: data,\n    };\n\n    await this.sendNotification(message);\n  }\n\n  /**\n   * Send veto notification to phases\n   * Requirement 7.6: Notify originating phase when signal is vetoed\n   */\n  async sendVetoNotification(data: VetoNotification): Promise<void> {\n    const message: NotificationMessage = {\n      type: NotificationType.VETO_NOTIFICATION,\n      title: '‚ùå SIGNAL VETOED',\n      message: this.formatVetoMessage(data),\n      priority: 'MEDIUM',\n      timestamp: Date.now(),\n      metadata: data,\n    };\n\n    await this.sendNotification(message);\n  }\n\n  /**\n   * Send system error notification\n   */\n  async sendSystemError(error: string, context?: Record<string, any>): Promise<void> {\n    const message: NotificationMessage = {\n      type: NotificationType.SYSTEM_ERROR,\n      title: 'üî• SYSTEM ERROR',\n      message: `System Error: ${error}`,\n      priority: 'HIGH',\n      timestamp: Date.now(),\n      metadata: context,\n    };\n\n    await this.sendNotification(message);\n  }\n\n  /**\n   * Send notification via all enabled channels\n   */\n  private async sendNotification(message: NotificationMessage): Promise<void> {\n    const promises: Promise<void>[] = [];\n\n    // Send via Telegram if enabled\n    if (this.config.telegram.enabled) {\n      promises.push(this.sendTelegramNotification(message));\n    }\n\n    // Send via Email if enabled\n    if (this.config.email.enabled) {\n      promises.push(this.sendEmailNotification(message));\n    }\n\n    // Wait for all notifications to complete\n    if (promises.length > 0) {\n      await Promise.allSettled(promises);\n    }\n  }\n\n  /**\n   * Send notification via Telegram\n   */\n  private async sendTelegramNotification(message: NotificationMessage): Promise<void> {\n    if (!this.config.telegram.botToken || !this.config.telegram.chatId) {\n      throw new Error('Telegram configuration incomplete');\n    }\n\n    const telegramMessage = this.formatTelegramMessage(message);\n    const url = `https://api.telegram.org/bot${this.config.telegram.botToken}/sendMessage`;\n    \n    const payload = {\n      chat_id: this.config.telegram.chatId,\n      text: telegramMessage,\n      parse_mode: 'Markdown',\n    };\n\n    await this.retryRequest(async () => {\n      const response = await fetch(url, {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(payload),\n      });\n\n      if (!response.ok) {\n        const error = await response.text();\n        throw new Error(`Telegram API error: ${response.status} - ${error}`);\n      }\n    });\n  }\n\n  /**\n   * Send notification via Email (placeholder implementation)\n   */\n  private async sendEmailNotification(message: NotificationMessage): Promise<void> {\n    if (!this.config.email.smtpHost || !this.config.email.from || !this.config.email.to?.length) {\n      throw new Error('Email configuration incomplete');\n    }\n\n    // TODO: Implement email sending using nodemailer or similar\n    // For now, just log the email that would be sent\n    console.log('Email notification (not implemented):', {\n      to: this.config.email.to,\n      subject: message.title,\n      body: message.message,\n      timestamp: new Date(message.timestamp).toISOString(),\n    });\n  }\n\n  /**\n   * Format circuit breaker message\n   */\n  private formatCircuitBreakerMessage(data: CircuitBreakerNotification): string {\n    return `EMERGENCY: Circuit breaker triggered!\n    \nReason: ${data.reason}\nCurrent Equity: $${data.equity.toFixed(2)}\nDrawdown: ${(data.drawdown * 100).toFixed(2)}%\nTime: ${new Date(data.triggeredAt).toISOString()}\n\nAll positions have been closed and trading is halted.\nManual reset required to resume operations.`;\n  }\n\n  /**\n   * Format high correlation message\n   */\n  private formatHighCorrelationMessage(data: HighCorrelationNotification): string {\n    return `High correlation detected between positions!\n    \nCorrelation Score: ${(data.correlationScore * 100).toFixed(2)}%\nThreshold: ${(data.threshold * 100).toFixed(2)}%\nAffected Positions: ${data.affectedPositions.join(', ')}\n\nRisk management measures may be applied to new signals.`;\n  }\n\n  /**\n   * Format sweep message\n   */\n  private formatSweepMessage(data: SweepNotification): string {\n    return `Profit sweep executed successfully!\n    \nAmount: $${data.amount.toFixed(2)}\nFrom: ${data.fromWallet}\nTo: ${data.toWallet}\nReason: ${data.reason}\nNew Balance: $${data.newBalance.toFixed(2)}`;\n  }\n\n  /**\n   * Format veto message\n   */\n  private formatVetoMessage(data: VetoNotification): string {\n    return `Signal vetoed by Brain risk management!\n    \nPhase: ${data.phaseId}\nSignal ID: ${data.signalId}\nSymbol: ${data.symbol}\nRequested Size: $${data.requestedSize.toFixed(2)}\nReason: ${data.reason}`;\n  }\n\n  /**\n   * Format message for Telegram with markdown\n   */\n  private formatTelegramMessage(message: NotificationMessage): string {\n    const priorityEmoji = {\n      LOW: 'üîµ',\n      MEDIUM: 'üü°', \n      HIGH: 'üü†',\n      CRITICAL: 'üî¥',\n    };\n\n    return `${priorityEmoji[message.priority]} *${message.title}*\n\n${message.message}\n\n_${new Date(message.timestamp).toISOString()}_`;\n  }\n\n  /**\n   * Retry mechanism for network requests\n   */\n  private async retryRequest(fn: () => Promise<void>): Promise<void> {\n    let lastError: Error | null = null;\n\n    for (let attempt = 1; attempt <= this.retryAttempts; attempt++) {\n      try {\n        await fn();\n        return; // Success\n      } catch (error) {\n        lastError = error as Error;\n        \n        if (attempt < this.retryAttempts) {\n          // Exponential backoff\n          const delay = this.retryDelay * Math.pow(2, attempt - 1);\n          await new Promise(resolve => setTimeout(resolve, delay));\n        }\n      }\n    }\n\n    // All retries failed\n    throw new Error(`Notification failed after ${this.retryAttempts} attempts: ${lastError?.message}`);\n  }\n\n  /**\n   * Update configuration\n   */\n  updateConfig(config: NotificationConfig): void {\n    this.config = config;\n  }\n\n  /**\n   * Test notification channels\n   */\n  async testNotifications(): Promise<{ telegram: boolean; email: boolean }> {\n    const results = { telegram: false, email: false };\n\n    // Test Telegram\n    if (this.config.telegram.enabled) {\n      try {\n        const testMessage: NotificationMessage = {\n          type: NotificationType.SYSTEM_ERROR,\n          title: 'üß™ Test Notification',\n          message: 'This is a test notification from Titan Brain.',\n          priority: 'LOW',\n          timestamp: Date.now(),\n        };\n        await this.sendTelegramNotification(testMessage);\n        results.telegram = true;\n      } catch (error) {\n        console.error('Telegram test failed:', error);\n      }\n    }\n\n    // Test Email\n    if (this.config.email.enabled) {\n      try {\n        const testMessage: NotificationMessage = {\n          type: NotificationType.SYSTEM_ERROR,\n          title: 'üß™ Test Notification',\n          message: 'This is a test notification from Titan Brain.',\n          priority: 'LOW',\n          timestamp: Date.now(),\n        };\n        await this.sendEmailNotification(testMessage);\n        results.email = true;\n      } catch (error) {\n        console.error('Email test failed:', error);\n      }\n    }\n\n    return results;\n  }\n}"],"version":3}
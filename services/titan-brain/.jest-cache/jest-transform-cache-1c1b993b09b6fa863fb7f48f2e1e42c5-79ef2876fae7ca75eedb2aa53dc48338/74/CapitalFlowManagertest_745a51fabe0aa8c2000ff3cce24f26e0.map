{"file":"/Users/ivan/Code/trading/titan/services/titan-brain/tests/unit/CapitalFlowManager.test.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-brain/tests/unit/CapitalFlowManager.test.ts"],"sourcesContent":["/**\n * Unit Tests for CapitalFlowManager\n * \n * Tests sweep condition detection, reserve limit enforcement,\n * high watermark updates, and sweep retry logic.\n * Requirements: 4.1, 4.2, 4.3, 4.5, 4.8\n */\n\nimport { CapitalFlowManager, ExchangeWalletAPI } from '../../src/engine/CapitalFlowManager.js';\nimport { CapitalFlowConfig } from '../../src/types/index.js';\nimport { defaultConfig } from '../../src/config/defaults.js';\n\n/**\n * Mock Exchange API for testing\n */\nclass MockExchangeAPI implements ExchangeWalletAPI {\n  private futuresBalance: number = 0;\n  private spotBalance: number = 0;\n  private transferShouldFail: boolean = false;\n  private failCount: number = 0;\n  private maxFailures: number = 0;\n\n  setFuturesBalance(balance: number): void {\n    this.futuresBalance = balance;\n  }\n\n  setSpotBalance(balance: number): void {\n    this.spotBalance = balance;\n  }\n\n  setTransferShouldFail(shouldFail: boolean, maxFailures: number = Infinity): void {\n    this.transferShouldFail = shouldFail;\n    this.maxFailures = maxFailures;\n    this.failCount = 0;\n  }\n\n  async getFuturesBalance(): Promise<number> {\n    return this.futuresBalance;\n  }\n\n  async getSpotBalance(): Promise<number> {\n    return this.spotBalance;\n  }\n\n  async transferToSpot(amount: number): Promise<{ success: boolean; transactionId?: string; error?: string }> {\n    if (this.transferShouldFail && this.failCount < this.maxFailures) {\n      this.failCount++;\n      return { success: false, error: 'Transfer failed' };\n    }\n    \n    this.futuresBalance -= amount;\n    this.spotBalance += amount;\n    return { success: true, transactionId: `tx-${Date.now()}` };\n  }\n}\n\ndescribe('CapitalFlowManager', () => {\n  let manager: CapitalFlowManager;\n  let mockAPI: MockExchangeAPI;\n  let config: CapitalFlowConfig;\n\n  beforeEach(() => {\n    config = { ...defaultConfig.capitalFlow };\n    mockAPI = new MockExchangeAPI();\n    manager = new CapitalFlowManager(config, undefined, mockAPI);\n  });\n\n\n  describe('constructor', () => {\n    it('should initialize with provided configuration', () => {\n      const retrievedConfig = manager.getConfig();\n      expect(retrievedConfig.sweepThreshold).toBe(1.2);\n      expect(retrievedConfig.reserveLimit).toBe(200);\n      expect(retrievedConfig.maxRetries).toBe(3);\n    });\n\n    it('should accept custom configuration', () => {\n      const customConfig: CapitalFlowConfig = {\n        sweepThreshold: 1.3,\n        reserveLimit: 500,\n        sweepSchedule: '0 12 * * *',\n        maxRetries: 5,\n        retryBaseDelay: 2000,\n      };\n      const customManager = new CapitalFlowManager(customConfig, undefined, mockAPI);\n      \n      const retrievedConfig = customManager.getConfig();\n      expect(retrievedConfig.sweepThreshold).toBe(1.3);\n      expect(retrievedConfig.reserveLimit).toBe(500);\n      expect(retrievedConfig.maxRetries).toBe(5);\n    });\n  });\n\n  describe('setTargetAllocation', () => {\n    it('should set target allocation', () => {\n      manager.setTargetAllocation(1000);\n      expect(manager.getTargetAllocation()).toBe(1000);\n    });\n\n    it('should handle negative values by setting to 0', () => {\n      manager.setTargetAllocation(-500);\n      expect(manager.getTargetAllocation()).toBe(0);\n    });\n  });\n\n  describe('getHighWatermark', () => {\n    it('should return 0 initially', () => {\n      expect(manager.getHighWatermark()).toBe(0);\n    });\n  });\n\n  describe('updateHighWatermark', () => {\n    it('should update watermark when equity exceeds current', async () => {\n      const updated = await manager.updateHighWatermark(1000);\n      expect(updated).toBe(true);\n      expect(manager.getHighWatermark()).toBe(1000);\n    });\n\n    it('should not update watermark when equity is lower', async () => {\n      await manager.updateHighWatermark(1000);\n      const updated = await manager.updateHighWatermark(800);\n      expect(updated).toBe(false);\n      expect(manager.getHighWatermark()).toBe(1000);\n    });\n\n    it('should not update watermark when equity is equal', async () => {\n      await manager.updateHighWatermark(1000);\n      const updated = await manager.updateHighWatermark(1000);\n      expect(updated).toBe(false);\n      expect(manager.getHighWatermark()).toBe(1000);\n    });\n\n    it('should update watermark monotonically (Property 10)', async () => {\n      const equitySequence = [500, 1000, 800, 1200, 900, 1500];\n      const expectedWatermarks = [500, 1000, 1000, 1200, 1200, 1500];\n\n      for (let i = 0; i < equitySequence.length; i++) {\n        await manager.updateHighWatermark(equitySequence[i]);\n        expect(manager.getHighWatermark()).toBe(expectedWatermarks[i]);\n      }\n    });\n  });\n\n\n  describe('checkSweepConditions', () => {\n    beforeEach(() => {\n      manager.setTargetAllocation(1000);\n    });\n\n    it('should not sweep when balance is below threshold', async () => {\n      mockAPI.setFuturesBalance(1100); // 10% over target, below 20% threshold\n      \n      const decision = await manager.checkSweepConditions();\n      expect(decision.shouldSweep).toBe(false);\n      expect(decision.amount).toBe(0);\n    });\n\n    it('should sweep when balance exceeds 20% threshold (Requirement 4.2)', async () => {\n      mockAPI.setFuturesBalance(1500); // 50% over target\n      \n      const decision = await manager.checkSweepConditions();\n      expect(decision.shouldSweep).toBe(true);\n      expect(decision.amount).toBeGreaterThan(0);\n    });\n\n    it('should calculate correct excess amount (Requirement 4.3)', async () => {\n      mockAPI.setFuturesBalance(1500);\n      manager.setTargetAllocation(1000);\n      \n      // Sweep trigger level = 1000 * 1.2 = 1200\n      // Excess = 1500 - 1200 = 300\n      const decision = await manager.checkSweepConditions();\n      expect(decision.shouldSweep).toBe(true);\n      expect(decision.amount).toBe(300);\n    });\n\n    it('should respect reserve limit (Requirement 4.5)', async () => {\n      mockAPI.setFuturesBalance(350); // Low balance\n      manager.setTargetAllocation(200);\n      \n      // Sweep trigger level = 200 * 1.2 = 240\n      // Excess = 350 - 240 = 110\n      // But max sweepable = 350 - 200 (reserve) = 150\n      // So sweep amount = min(110, 150) = 110\n      const decision = await manager.checkSweepConditions();\n      expect(decision.shouldSweep).toBe(true);\n      expect(decision.amount).toBe(110);\n    });\n\n    it('should not sweep if it would violate reserve limit', async () => {\n      mockAPI.setFuturesBalance(200); // Exactly at reserve limit\n      manager.setTargetAllocation(100);\n      \n      // Sweep trigger level = 100 * 1.2 = 120\n      // Balance 200 > 120, so excess = 80\n      // But max sweepable = 200 - 200 = 0\n      const decision = await manager.checkSweepConditions();\n      expect(decision.shouldSweep).toBe(false);\n    });\n\n    it('should return correct futures balance and target allocation', async () => {\n      mockAPI.setFuturesBalance(1500);\n      manager.setTargetAllocation(1000);\n      \n      const decision = await manager.checkSweepConditions();\n      expect(decision.futuresBalance).toBe(1500);\n      expect(decision.targetAllocation).toBe(1000);\n    });\n  });\n\n  describe('executeSweep', () => {\n    beforeEach(() => {\n      mockAPI.setFuturesBalance(1500);\n      manager.setTargetAllocation(1000);\n    });\n\n    it('should execute sweep successfully', async () => {\n      const result = await manager.executeSweep(300);\n      \n      expect(result.success).toBe(true);\n      expect(result.amount).toBe(300);\n      expect(result.transactionId).toBeDefined();\n    });\n\n    it('should reject invalid sweep amount', async () => {\n      const result = await manager.executeSweep(0);\n      \n      expect(result.success).toBe(false);\n      expect(result.error).toContain('Invalid sweep amount');\n    });\n\n    it('should reject negative sweep amount', async () => {\n      const result = await manager.executeSweep(-100);\n      \n      expect(result.success).toBe(false);\n      expect(result.error).toContain('Invalid sweep amount');\n    });\n\n    it('should reject sweep that violates reserve limit (Property 5)', async () => {\n      mockAPI.setFuturesBalance(300);\n      \n      // Trying to sweep 200 would leave only 100, below reserve of 200\n      const result = await manager.executeSweep(200);\n      \n      expect(result.success).toBe(false);\n      expect(result.error).toContain('reserve limit');\n    });\n\n    it('should update total swept on success (Property 4)', async () => {\n      const initialSwept = manager.getTotalSwept();\n      \n      await manager.executeSweep(100);\n      expect(manager.getTotalSwept()).toBe(initialSwept + 100);\n      \n      await manager.executeSweep(50);\n      expect(manager.getTotalSwept()).toBe(initialSwept + 150);\n    });\n\n    it('should retry on failure (Requirement 4.8)', async () => {\n      mockAPI.setTransferShouldFail(true, 2); // Fail first 2 attempts\n      \n      const result = await manager.executeSweep(100);\n      \n      // Should succeed on 3rd attempt\n      expect(result.success).toBe(true);\n    });\n\n    it('should fail after max retries', async () => {\n      mockAPI.setTransferShouldFail(true, 10); // Fail all attempts\n      \n      const result = await manager.executeSweep(100);\n      \n      expect(result.success).toBe(false);\n      expect(result.error).toContain('failed after');\n    });\n  });\n\n\n  describe('getTreasuryStatus', () => {\n    it('should return correct treasury status', async () => {\n      mockAPI.setFuturesBalance(1500);\n      mockAPI.setSpotBalance(500);\n      await manager.updateHighWatermark(2000);\n      await manager.executeSweep(100);\n      \n      const status = await manager.getTreasuryStatus();\n      \n      expect(status.futuresWallet).toBe(1400); // 1500 - 100\n      expect(status.spotWallet).toBe(600); // 500 + 100\n      expect(status.highWatermark).toBe(2000);\n      expect(status.totalSwept).toBe(100);\n      expect(status.lockedProfit).toBe(100);\n      expect(status.riskCapital).toBe(1400);\n    });\n  });\n\n  describe('getNextSweepTriggerLevel', () => {\n    it('should calculate correct trigger level', () => {\n      manager.setTargetAllocation(1000);\n      \n      // Trigger level = 1000 * 1.2 = 1200\n      expect(manager.getNextSweepTriggerLevel()).toBe(1200);\n    });\n\n    it('should update when target allocation changes', () => {\n      manager.setTargetAllocation(500);\n      expect(manager.getNextSweepTriggerLevel()).toBe(600);\n      \n      manager.setTargetAllocation(2000);\n      expect(manager.getNextSweepTriggerLevel()).toBe(2400);\n    });\n  });\n\n  describe('shouldTriggerSweepOnEquityIncrease', () => {\n    it('should return true for > 10% increase', () => {\n      expect(manager.shouldTriggerSweepOnEquityIncrease(1000, 1150)).toBe(true);\n      expect(manager.shouldTriggerSweepOnEquityIncrease(1000, 1200)).toBe(true);\n    });\n\n    it('should return false for <= 10% increase', () => {\n      expect(manager.shouldTriggerSweepOnEquityIncrease(1000, 1100)).toBe(false);\n      expect(manager.shouldTriggerSweepOnEquityIncrease(1000, 1050)).toBe(false);\n    });\n\n    it('should return false for decrease', () => {\n      expect(manager.shouldTriggerSweepOnEquityIncrease(1000, 900)).toBe(false);\n    });\n\n    it('should handle zero previous equity', () => {\n      expect(manager.shouldTriggerSweepOnEquityIncrease(0, 100)).toBe(false);\n    });\n\n    it('should handle negative previous equity', () => {\n      expect(manager.shouldTriggerSweepOnEquityIncrease(-100, 100)).toBe(false);\n    });\n  });\n\n  describe('performSweepIfNeeded', () => {\n    it('should perform sweep when conditions are met', async () => {\n      mockAPI.setFuturesBalance(1500);\n      manager.setTargetAllocation(1000);\n      \n      const result = await manager.performSweepIfNeeded();\n      \n      expect(result).not.toBeNull();\n      expect(result?.success).toBe(true);\n    });\n\n    it('should return null when conditions are not met', async () => {\n      mockAPI.setFuturesBalance(1100);\n      manager.setTargetAllocation(1000);\n      \n      const result = await manager.performSweepIfNeeded();\n      \n      expect(result).toBeNull();\n    });\n  });\n\n  describe('getReserveLimit', () => {\n    it('should return configured reserve limit', () => {\n      expect(manager.getReserveLimit()).toBe(200);\n    });\n  });\n\n  describe('edge cases', () => {\n    it('should handle zero target allocation', async () => {\n      manager.setTargetAllocation(0);\n      mockAPI.setFuturesBalance(500);\n      \n      const decision = await manager.checkSweepConditions();\n      // With 0 target, trigger level is 0, so any balance triggers sweep\n      // But reserve limit still applies\n      expect(decision.shouldSweep).toBe(true);\n      expect(decision.amount).toBe(300); // 500 - 200 reserve\n    });\n\n    it('should handle very large balances', async () => {\n      mockAPI.setFuturesBalance(1000000);\n      manager.setTargetAllocation(500000);\n      \n      const decision = await manager.checkSweepConditions();\n      expect(decision.shouldSweep).toBe(true);\n      // Excess = 1000000 - (500000 * 1.2) = 1000000 - 600000 = 400000\n      expect(decision.amount).toBe(400000);\n    });\n\n    it('should handle balance exactly at reserve limit', async () => {\n      mockAPI.setFuturesBalance(200);\n      manager.setTargetAllocation(100);\n      \n      const decision = await manager.checkSweepConditions();\n      // Can't sweep anything without violating reserve\n      expect(decision.shouldSweep).toBe(false);\n    });\n  });\n});\n"],"version":3}
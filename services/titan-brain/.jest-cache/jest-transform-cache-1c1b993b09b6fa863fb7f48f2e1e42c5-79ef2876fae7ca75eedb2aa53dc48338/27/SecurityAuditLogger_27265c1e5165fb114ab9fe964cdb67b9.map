{"file":"/Users/ivan/Code/trading/titan/services/titan-brain/src/security/SecurityAuditLogger.ts","mappings":";AAAA;;;;;;;GAOG;;;AAomBH,wDAKC;AAKD,4DAEC;AA9mBD,2BAA0E;AAC1E,+BAA4B;AAC5B,2EAA8D;AA+D9D;;GAEG;AACH,MAAM,cAAc,GAAwB;IAC1C,YAAY,EAAE,iBAAiB;IAC/B,cAAc,EAAE,EAAE,GAAG,IAAI,GAAG,IAAI,EAAE,OAAO;IACzC,aAAa,EAAE,EAAE;IACjB,qBAAqB,EAAE,IAAI;IAC3B,eAAe,EAAE;QACf,qBAAqB,EAAE,CAAC;QACxB,2BAA2B,EAAE,EAAE;QAC/B,yBAAyB,EAAE,EAAE;KAC9B;CACF,CAAC;AAEF;;GAEG;AACH,MAAM,eAAe,GAAoB;IACvC;QACE,IAAI,EAAE,eAAe;QACrB,OAAO,EAAE,uDAAuD;QAChE,QAAQ,EAAE,UAAU;QACpB,WAAW,EAAE,iCAAiC;KAC/C;IACD;QACE,IAAI,EAAE,aAAa;QACnB,OAAO,EAAE,gCAAgC;QACzC,QAAQ,EAAE,UAAU;QACpB,WAAW,EAAE,8BAA8B;KAC5C;IACD;QACE,IAAI,EAAE,gBAAgB;QACtB,OAAO,EAAE,YAAY;QACrB,QAAQ,EAAE,UAAU;QACpB,WAAW,EAAE,kCAAkC;KAChD;IACD;QACE,IAAI,EAAE,mBAAmB;QACzB,OAAO,EAAE,aAAa;QACtB,QAAQ,EAAE,SAAS;QACnB,WAAW,EAAE,qCAAqC;KACnD;IACD;QACE,IAAI,EAAE,gBAAgB;QACtB,OAAO,EAAE,WAAW;QACpB,QAAQ,EAAE,SAAS;QACnB,WAAW,EAAE,gCAAgC;KAC9C;CACF,CAAC;AAEF;;GAEG;AACH,MAAa,mBAAmB;IACtB,MAAM,CAAsB;IAC5B,MAAM,GAAG,IAAA,+BAAS,EAAC,EAAE,SAAS,EAAE,gBAAgB,EAAE,CAAC,CAAC;IACpD,WAAW,GAAsD,IAAI,GAAG,EAAE,CAAC;IAEnF,YAAY,SAAuC,EAAE;QACnD,IAAI,CAAC,MAAM,GAAG,EAAE,GAAG,cAAc,EAAE,GAAG,MAAM,EAAE,CAAC;QAC/C,IAAI,CAAC,kBAAkB,EAAE,CAAC;IAC5B,CAAC;IAED;;OAEG;IACH,gBAAgB,CAAC,KAA4C,EAAE,sBAA+B,KAAK;QACjG,MAAM,UAAU,GAAuB;YACrC,GAAG,KAAK;YACR,SAAS,EAAE,IAAI,IAAI,EAAE,CAAC,WAAW,EAAE;SACpC,CAAC;QAEF,2BAA2B;QAC3B,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,sBAAsB,EAAE;YACvC,aAAa,EAAE,UAAU;SAC1B,CAAC,CAAC;QAEH,+BAA+B;QAC/B,IAAI,CAAC,gBAAgB,CAAC,UAAU,CAAC,CAAC;QAElC,yFAAyF;QACzF,IAAI,IAAI,CAAC,MAAM,CAAC,qBAAqB,IAAI,CAAC,mBAAmB,IAAI,KAAK,CAAC,SAAS,KAAK,qBAAqB,EAAE,CAAC;YAC3G,IAAI,CAAC,aAAa,CAAC,UAAU,CAAC,CAAC;QACjC,CAAC;QAED,yBAAyB;QACzB,IAAI,CAAC,oBAAoB,CAAC,UAAU,CAAC,CAAC;IACxC,CAAC;IAED;;OAEG;IACH,wBAAwB,CACtB,QAAgB,EAChB,UAAkB,EAClB,QAAgB,EAChB,SAAkB;QAElB,IAAI,CAAC,gBAAgB,CAAC;YACpB,SAAS,EAAE,cAAc;YACzB,QAAQ,EAAE,MAAM;YAChB,QAAQ;YACR,UAAU;YACV,QAAQ;YACR,SAAS;YACT,OAAO,EAAE;gBACP,MAAM,EAAE,wBAAwB;gBAChC,UAAU;aACX;SACF,CAAC,CAAC;IACL,CAAC;IAED;;OAEG;IACH,wBAAwB,CACtB,QAAgB,EAChB,UAAkB,EAClB,MAAc,EACd,QAAgB,EAChB,SAAkB;QAElB,IAAI,CAAC,gBAAgB,CAAC;YACpB,SAAS,EAAE,cAAc;YACzB,QAAQ,EAAE,SAAS;YACnB,QAAQ;YACR,UAAU;YACV,QAAQ;YACR,SAAS;YACT,OAAO,EAAE;gBACP,MAAM,EAAE,wBAAwB;gBAChC,UAAU;gBACV,MAAM;aACP;SACF,CAAC,CAAC;QAEH,4CAA4C;QAC5C,IAAI,CAAC,mBAAmB,CAAC,gBAAgB,QAAQ,EAAE,CAAC,CAAC;IACvD,CAAC;IAED;;OAEG;IACH,oBAAoB,CAClB,QAAgB,EAChB,QAAgB,EAChB,MAAgB,EAChB,WAAqB,EACrB,SAAkB;QAElB,IAAI,CAAC,gBAAgB,CAAC;YACpB,SAAS,EAAE,oBAAoB;YAC/B,QAAQ,EAAE,SAAS;YACnB,QAAQ;YACR,QAAQ;YACR,SAAS;YACT,OAAO,EAAE;gBACP,MAAM,EAAE,oBAAoB;gBAC5B,MAAM;gBACN,cAAc,EAAE,CAAC,CAAC,WAAW;gBAC7B,mCAAmC;gBACnC,eAAe,EAAE,WAAW,CAAC,CAAC,CAAC,OAAO,WAAW,CAAC,CAAC,CAAC,MAAM;aAC3D;SACF,CAAC,CAAC;QAEH,0BAA0B;QAC1B,IAAI,CAAC,mBAAmB,CAAC,sBAAsB,QAAQ,EAAE,CAAC,CAAC;IAC7D,CAAC;IAED;;OAEG;IACH,cAAc,CACZ,QAAgB,EAChB,QAAgB,EAChB,MAAc,EACd,SAAkB;QAElB,IAAI,CAAC,gBAAgB,CAAC;YACpB,SAAS,EAAE,cAAc;YACzB,QAAQ,EAAE,UAAU;YACpB,QAAQ;YACR,QAAQ;YACR,SAAS;YACT,OAAO,EAAE;gBACP,MAAM,EAAE,2BAA2B;gBACnC,MAAM;aACP;SACF,CAAC,CAAC;IACL,CAAC;IAED;;OAEG;IACH,oBAAoB,CAClB,QAAgB,EAChB,QAAgB,EAChB,YAAoB,EACpB,UAAkB,EAClB,SAAkB;QAElB,IAAI,CAAC,gBAAgB,CAAC;YACpB,SAAS,EAAE,qBAAqB;YAChC,QAAQ,EAAE,SAAS;YACnB,QAAQ;YACR,QAAQ;YACR,SAAS;YACT,OAAO,EAAE;gBACP,MAAM,EAAE,qBAAqB;gBAC7B,YAAY;gBACZ,YAAY,EAAE,UAAU;aACzB;SACF,CAAC,CAAC;IACL,CAAC;IAED;;OAEG;IACH,qBAAqB,CACnB,QAAgB,EAChB,YAAoB,EACpB,OAAgC,EAChC,QAAiB,EACjB,SAAkB;QAElB,IAAI,CAAC,gBAAgB,CAAC;YACpB,SAAS,EAAE,qBAAqB;YAChC,QAAQ,EAAE,UAAU;YACpB,QAAQ;YACR,QAAQ;YACR,SAAS;YACT,OAAO,EAAE;gBACP,MAAM,EAAE,qBAAqB;gBAC7B,YAAY;gBACZ,GAAG,OAAO;aACX;SACF,EAAE,IAAI,CAAC,CAAC,CAAC,6CAA6C;QAEvD,sCAAsC;QACtC,IAAI,CAAC,mBAAmB,CAAC,cAAc,QAAQ,EAAE,CAAC,CAAC;IACrD,CAAC;IAED;;OAEG;IACH,sBAAsB,CACpB,QAAgB,EAChB,UAAkB,EAClB,eAAuB,EACvB,QAAgB,EAChB,SAAkB;QAElB,IAAI,CAAC,gBAAgB,CAAC;YACpB,SAAS,EAAE,sBAAsB;YACjC,QAAQ,EAAE,UAAU;YACpB,QAAQ;YACR,UAAU;YACV,QAAQ;YACR,SAAS;YACT,OAAO,EAAE;gBACP,MAAM,EAAE,8BAA8B;gBACtC,UAAU;gBACV,eAAe;aAChB;SACF,CAAC,CAAC;IACL,CAAC;IAED;;OAEG;IACH,aAAa,CACX,QAAgB,EAChB,UAAkB,EAClB,QAAgB,EAChB,QAAgB,EAChB,OAAgB,EAChB,SAAkB;QAElB,IAAI,CAAC,gBAAgB,CAAC;YACpB,SAAS,EAAE,aAAa;YACxB,QAAQ,EAAE,MAAM;YAChB,QAAQ;YACR,UAAU;YACV,QAAQ;YACR,SAAS;YACT,OAAO,EAAE;gBACP,MAAM,EAAE,aAAa;gBACrB,UAAU;gBACV,QAAQ;gBACR,OAAO;aACR;SACF,CAAC,CAAC;IACL,CAAC;IAED;;OAEG;IACH,sBAAsB,CACpB,QAAgB,EAChB,UAAkB,EAClB,UAAkB,EAClB,OAAgC,EAChC,QAAgB,EAChB,SAAkB;QAElB,IAAI,CAAC,gBAAgB,CAAC;YACpB,SAAS,EAAE,eAAe;YAC1B,QAAQ,EAAE,SAAS;YACnB,QAAQ;YACR,UAAU;YACV,QAAQ;YACR,SAAS;YACT,OAAO,EAAE;gBACP,MAAM,EAAE,sBAAsB;gBAC9B,UAAU;gBACV,UAAU;gBACV,OAAO;aACR;SACF,CAAC,CAAC;IACL,CAAC;IAED;;OAEG;IACH,kBAAkB,CAChB,QAAgB,EAChB,UAAkB,EAClB,UAAkB,EAClB,OAAgC,EAChC,QAAgB,EAChB,SAAkB;QAElB,IAAI,CAAC,gBAAgB,CAAC;YACpB,SAAS,EAAE,kBAAkB;YAC7B,QAAQ,EAAE,UAAU;YACpB,QAAQ;YACR,UAAU;YACV,QAAQ;YACR,SAAS;YACT,OAAO,EAAE;gBACP,MAAM,EAAE,kBAAkB;gBAC1B,UAAU;gBACV,UAAU;gBACV,GAAG,OAAO;aACX;SACF,CAAC,CAAC;IACL,CAAC;IAED;;OAEG;IACK,aAAa,CAAC,KAAyB;QAC7C,MAAM,SAAS,GAAG,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC;QAEhD,KAAK,MAAM,OAAO,IAAI,eAAe,EAAE,CAAC;YACtC,IAAI,OAAO,CAAC,OAAO,CAAC,IAAI,CAAC,SAAS,CAAC,EAAE,CAAC;gBACpC,IAAI,CAAC,qBAAqB,CACxB,KAAK,CAAC,QAAQ,EACd,OAAO,CAAC,IAAI,EACZ;oBACE,aAAa,EAAE,OAAO,CAAC,IAAI;oBAC3B,WAAW,EAAE,OAAO,CAAC,WAAW;oBAChC,UAAU,EAAE,qBAAqB;oBACjC,iBAAiB,EAAE,KAAK,CAAC,SAAS;iBACnC,EACD,KAAK,CAAC,QAAQ,EACd,KAAK,CAAC,SAAS,CAChB,CAAC;YACJ,CAAC;QACH,CAAC;IACH,CAAC;IAED;;OAEG;IACK,oBAAoB,CAAC,KAAyB;QACpD,MAAM,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QACvB,MAAM,SAAS,GAAG,EAAE,GAAG,IAAI,CAAC;QAC5B,MAAM,OAAO,GAAG,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC;QAE/B,gCAAgC;QAChC,IAAI,KAAK,CAAC,SAAS,KAAK,cAAc,EAAE,CAAC;YACvC,MAAM,GAAG,GAAG,gBAAgB,KAAK,CAAC,QAAQ,EAAE,CAAC;YAC7C,MAAM,KAAK,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,EAAE,SAAS,CAAC,CAAC;YACjD,IAAI,KAAK,IAAI,IAAI,CAAC,MAAM,CAAC,eAAe,CAAC,qBAAqB,EAAE,CAAC;gBAC/D,IAAI,CAAC,YAAY,CAAC,wBAAwB,EAAE;oBAC1C,QAAQ,EAAE,KAAK,CAAC,QAAQ;oBACxB,KAAK;oBACL,SAAS,EAAE,IAAI,CAAC,MAAM,CAAC,eAAe,CAAC,qBAAqB;oBAC5D,UAAU,EAAE,YAAY;iBACzB,CAAC,CAAC;YACL,CAAC;QACH,CAAC;QAED,4BAA4B;QAC5B,IAAI,KAAK,CAAC,SAAS,KAAK,oBAAoB,EAAE,CAAC;YAC7C,MAAM,GAAG,GAAG,sBAAsB,KAAK,CAAC,QAAQ,EAAE,CAAC;YACnD,MAAM,KAAK,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,EAAE,SAAS,CAAC,CAAC;YACjD,IAAI,KAAK,IAAI,IAAI,CAAC,MAAM,CAAC,eAAe,CAAC,2BAA2B,EAAE,CAAC;gBACrE,IAAI,CAAC,YAAY,CAAC,8BAA8B,EAAE;oBAChD,QAAQ,EAAE,KAAK,CAAC,QAAQ;oBACxB,KAAK;oBACL,SAAS,EAAE,IAAI,CAAC,MAAM,CAAC,eAAe,CAAC,2BAA2B;oBAClE,UAAU,EAAE,YAAY;iBACzB,CAAC,CAAC;YACL,CAAC;QACH,CAAC;QAED,4BAA4B;QAC5B,IAAI,KAAK,CAAC,SAAS,KAAK,qBAAqB,EAAE,CAAC;YAC9C,MAAM,GAAG,GAAG,cAAc,KAAK,CAAC,QAAQ,EAAE,CAAC;YAC3C,MAAM,KAAK,GAAG,IAAI,CAAC,aAAa,CAAC,GAAG,EAAE,OAAO,CAAC,CAAC;YAC/C,IAAI,KAAK,IAAI,IAAI,CAAC,MAAM,CAAC,eAAe,CAAC,yBAAyB,EAAE,CAAC;gBACnE,IAAI,CAAC,YAAY,CAAC,+BAA+B,EAAE;oBACjD,QAAQ,EAAE,KAAK,CAAC,QAAQ;oBACxB,KAAK;oBACL,SAAS,EAAE,IAAI,CAAC,MAAM,CAAC,eAAe,CAAC,yBAAyB;oBAChE,UAAU,EAAE,UAAU;iBACvB,CAAC,CAAC;YACL,CAAC;QACH,CAAC;IACH,CAAC;IAED;;OAEG;IACK,YAAY,CAAC,SAAiB,EAAE,OAAgC;QACtE,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,0BAA0B,EAAE;YAC5C,SAAS;YACT,OAAO;YACP,SAAS,EAAE,IAAI,IAAI,EAAE,CAAC,WAAW,EAAE;SACpC,CAAC,CAAC;QAEH,wFAAwF;QACxF,OAAO,CAAC,KAAK,CAAC,sBAAsB,SAAS,EAAE,EAAE,OAAO,CAAC,CAAC;IAC5D,CAAC;IAED;;OAEG;IACK,mBAAmB,CAAC,GAAW;QACrC,MAAM,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QACvB,MAAM,QAAQ,GAAG,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;QAE3C,IAAI,CAAC,QAAQ,IAAI,GAAG,GAAG,QAAQ,CAAC,SAAS,GAAG,KAAK,EAAE,CAAC,CAAC,qBAAqB;YACxE,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,EAAE,EAAE,KAAK,EAAE,CAAC,EAAE,SAAS,EAAE,GAAG,EAAE,CAAC,CAAC;QAC1D,CAAC;aAAM,CAAC;YACN,QAAQ,CAAC,KAAK,EAAE,CAAC;QACnB,CAAC;IACH,CAAC;IAED;;OAEG;IACK,aAAa,CAAC,GAAW,EAAE,YAAoB;QACrD,MAAM,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QACvB,MAAM,QAAQ,GAAG,IAAI,CAAC,WAAW,CAAC,GAAG,CAAC,GAAG,CAAC,CAAC;QAE3C,IAAI,CAAC,QAAQ,IAAI,GAAG,GAAG,QAAQ,CAAC,SAAS,GAAG,YAAY,EAAE,CAAC;YACzD,OAAO,CAAC,CAAC;QACX,CAAC;QAED,OAAO,QAAQ,CAAC,KAAK,CAAC;IACxB,CAAC;IAED;;OAEG;IACK,gBAAgB,CAAC,KAAyB;QAChD,IAAI,CAAC;YACH,MAAM,IAAI,GAAG,IAAI,IAAI,EAAE,CAAC,WAAW,EAAE,CAAC,KAAK,CAAC,GAAG,CAAC,CAAC,CAAC,CAAC,CAAC;YACpD,MAAM,QAAQ,GAAG,kBAAkB,IAAI,QAAQ,CAAC;YAChD,MAAM,QAAQ,GAAG,IAAA,WAAI,EAAC,IAAI,CAAC,MAAM,CAAC,YAAY,EAAE,QAAQ,CAAC,CAAC;YAE1D,MAAM,OAAO,GAAG,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,GAAG,IAAI,CAAC;YAC7C,IAAA,mBAAc,EAAC,QAAQ,EAAE,OAAO,EAAE,MAAM,CAAC,CAAC;YAE1C,0CAA0C;YAC1C,IAAI,CAAC,qBAAqB,CAAC,QAAQ,CAAC,CAAC;QACvC,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,oCAAoC,EAAE,EAAE,KAAK,EAAE,CAAC,CAAC;QACrE,CAAC;IACH,CAAC;IAED;;OAEG;IACK,kBAAkB;QACxB,IAAI,CAAC,IAAA,eAAU,EAAC,IAAI,CAAC,MAAM,CAAC,YAAY,CAAC,EAAE,CAAC;YAC1C,IAAA,cAAS,EAAC,IAAI,CAAC,MAAM,CAAC,YAAY,EAAE,EAAE,SAAS,EAAE,IAAI,EAAE,CAAC,CAAC;QAC3D,CAAC;IACH,CAAC;IAED;;OAEG;IACK,qBAAqB,CAAC,QAAgB;QAC5C,IAAI,CAAC;YACH,MAAM,KAAK,GAAG,OAAO,CAAC,IAAI,CAAC,CAAC,QAAQ,CAAC,QAAQ,CAAC,CAAC;YAC/C,IAAI,KAAK,CAAC,IAAI,GAAG,IAAI,CAAC,MAAM,CAAC,cAAc,EAAE,CAAC;gBAC5C,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;gBAC7B,MAAM,WAAW,GAAG,GAAG,QAAQ,IAAI,SAAS,EAAE,CAAC;gBAC/C,OAAO,CAAC,IAAI,CAAC,CAAC,UAAU,CAAC,QAAQ,EAAE,WAAW,CAAC,CAAC;gBAEhD,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,4BAA4B,EAAE;oBAC7C,YAAY,EAAE,QAAQ;oBACtB,WAAW;oBACX,IAAI,EAAE,KAAK,CAAC,IAAI;iBACjB,CAAC,CAAC;YACL,CAAC;QACH,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,qCAAqC,EAAE,EAAE,KAAK,EAAE,CAAC,CAAC;QACtE,CAAC;IACH,CAAC;IAED;;OAEG;IACH,qBAAqB,CAAC,iBAAyB,EAAE;QAC/C,4CAA4C;QAC5C,2CAA2C;QAC3C,MAAM,KAAK,GAA2B,EAAE,CAAC;QAEzC,KAAK,MAAM,CAAC,GAAG,EAAE,KAAK,CAAC,IAAI,IAAI,CAAC,WAAW,CAAC,OAAO,EAAE,EAAE,CAAC;YACtD,MAAM,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;YACvB,MAAM,UAAU,GAAG,cAAc,GAAG,EAAE,GAAG,EAAE,GAAG,IAAI,CAAC;YAEnD,IAAI,GAAG,GAAG,KAAK,CAAC,SAAS,IAAI,UAAU,EAAE,CAAC;gBACxC,KAAK,CAAC,GAAG,CAAC,GAAG,KAAK,CAAC,KAAK,CAAC;YAC3B,CAAC;QACH,CAAC;QAED,OAAO,KAAK,CAAC;IACf,CAAC;CACF;AAjeD,kDAieC;AAED;;GAEG;AACH,IAAI,mBAAmB,GAA+B,IAAI,CAAC;AAE3D;;GAEG;AACH,SAAgB,sBAAsB,CAAC,MAAqC;IAC1E,IAAI,CAAC,mBAAmB,EAAE,CAAC;QACzB,mBAAmB,GAAG,IAAI,mBAAmB,CAAC,MAAM,CAAC,CAAC;IACxD,CAAC;IACD,OAAO,mBAAmB,CAAC;AAC7B,CAAC;AAED;;GAEG;AACH,SAAgB,wBAAwB;IACtC,mBAAmB,GAAG,IAAI,CAAC;AAC7B,CAAC","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-brain/src/security/SecurityAuditLogger.ts"],"sourcesContent":["/**\n * SecurityAuditLogger - Comprehensive security audit logging\n * \n * Implements security event logging, threat detection, and audit trails\n * for all critical operations in the Titan trading system.\n * \n * Requirements: 6.1, 6.2 - Security audit logging and monitoring\n */\n\nimport { writeFileSync, appendFileSync, existsSync, mkdirSync } from 'fs';\nimport { join } from 'path';\nimport { getLogger } from '../monitoring/StructuredLogger.js';\n\n/**\n * Security event types\n */\nexport type SecurityEventType = \n  | 'AUTH_SUCCESS'\n  | 'AUTH_FAILURE'\n  | 'VALIDATION_FAILURE'\n  | 'HMAC_FAILURE'\n  | 'RATE_LIMIT_EXCEEDED'\n  | 'SUSPICIOUS_ACTIVITY'\n  | 'PRIVILEGE_ESCALATION'\n  | 'DATA_ACCESS'\n  | 'CONFIG_CHANGE'\n  | 'EMERGENCY_ACTION';\n\n/**\n * Security event severity levels\n */\nexport type SecuritySeverity = 'INFO' | 'WARNING' | 'CRITICAL';\n\n/**\n * Security audit event\n */\nexport interface SecurityAuditEvent {\n  timestamp: string;\n  eventType: SecurityEventType;\n  severity: SecuritySeverity;\n  clientIp: string;\n  userAgent?: string;\n  operatorId?: string;\n  endpoint?: string;\n  method?: string;\n  details: Record<string, unknown>;\n  correlationId?: string;\n}\n\n/**\n * Threat detection patterns\n */\ninterface ThreatPattern {\n  name: string;\n  pattern: RegExp;\n  severity: SecuritySeverity;\n  description: string;\n}\n\n/**\n * Security audit configuration\n */\nexport interface SecurityAuditConfig {\n  logDirectory: string;\n  maxLogFileSize: number; // bytes\n  retentionDays: number;\n  enableThreatDetection: boolean;\n  alertThresholds: {\n    authFailuresPerMinute: number;\n    validationFailuresPerMinute: number;\n    suspiciousActivityPerHour: number;\n  };\n}\n\n/**\n * Default security audit configuration\n */\nconst DEFAULT_CONFIG: SecurityAuditConfig = {\n  logDirectory: './logs/security',\n  maxLogFileSize: 10 * 1024 * 1024, // 10MB\n  retentionDays: 90,\n  enableThreatDetection: true,\n  alertThresholds: {\n    authFailuresPerMinute: 5,\n    validationFailuresPerMinute: 20,\n    suspiciousActivityPerHour: 10\n  }\n};\n\n/**\n * Threat detection patterns\n */\nconst THREAT_PATTERNS: ThreatPattern[] = [\n  {\n    name: 'SQL_INJECTION',\n    pattern: /(union|select|insert|update|delete|drop|exec|script)/i,\n    severity: 'CRITICAL',\n    description: 'Potential SQL injection attempt'\n  },\n  {\n    name: 'XSS_ATTEMPT',\n    pattern: /<script|javascript:|on\\w+\\s*=/i,\n    severity: 'CRITICAL',\n    description: 'Potential XSS attack attempt'\n  },\n  {\n    name: 'PATH_TRAVERSAL',\n    pattern: /\\.\\.[\\/\\\\]/,\n    severity: 'CRITICAL',\n    description: 'Potential path traversal attempt'\n  },\n  {\n    name: 'COMMAND_INJECTION',\n    pattern: /[;&|`$(){}]/,\n    severity: 'WARNING',\n    description: 'Potential command injection attempt'\n  },\n  {\n    name: 'EXCESSIVE_SIZE',\n    pattern: /.{10000,}/,\n    severity: 'WARNING',\n    description: 'Unusually large input detected'\n  }\n];\n\n/**\n * Security audit logger with threat detection\n */\nexport class SecurityAuditLogger {\n  private config: SecurityAuditConfig;\n  private logger = getLogger({ component: 'security-audit' });\n  private eventCounts: Map<string, { count: number; lastReset: number }> = new Map();\n\n  constructor(config: Partial<SecurityAuditConfig> = {}) {\n    this.config = { ...DEFAULT_CONFIG, ...config };\n    this.ensureLogDirectory();\n  }\n\n  /**\n   * Log a security audit event\n   */\n  logSecurityEvent(event: Omit<SecurityAuditEvent, 'timestamp'>, skipThreatDetection: boolean = false): void {\n    const auditEvent: SecurityAuditEvent = {\n      ...event,\n      timestamp: new Date().toISOString()\n    };\n\n    // Log to structured logger\n    this.logger.warn('Security audit event', {\n      securityEvent: auditEvent\n    });\n\n    // Write to security audit file\n    this.writeToAuditFile(auditEvent);\n\n    // Perform threat detection (but not for suspicious activity events to prevent recursion)\n    if (this.config.enableThreatDetection && !skipThreatDetection && event.eventType !== 'SUSPICIOUS_ACTIVITY') {\n      this.detectThreats(auditEvent);\n    }\n\n    // Check alert thresholds\n    this.checkAlertThresholds(auditEvent);\n  }\n\n  /**\n   * Log authentication success\n   */\n  logAuthenticationSuccess(\n    clientIp: string,\n    operatorId: string,\n    endpoint: string,\n    userAgent?: string\n  ): void {\n    this.logSecurityEvent({\n      eventType: 'AUTH_SUCCESS',\n      severity: 'INFO',\n      clientIp,\n      operatorId,\n      endpoint,\n      userAgent,\n      details: {\n        action: 'authentication_success',\n        operatorId\n      }\n    });\n  }\n\n  /**\n   * Log authentication failure\n   */\n  logAuthenticationFailure(\n    clientIp: string,\n    operatorId: string,\n    reason: string,\n    endpoint: string,\n    userAgent?: string\n  ): void {\n    this.logSecurityEvent({\n      eventType: 'AUTH_FAILURE',\n      severity: 'WARNING',\n      clientIp,\n      operatorId,\n      endpoint,\n      userAgent,\n      details: {\n        action: 'authentication_failure',\n        operatorId,\n        reason\n      }\n    });\n\n    // Increment failure count for rate limiting\n    this.incrementEventCount(`auth_failure_${clientIp}`);\n  }\n\n  /**\n   * Log validation failure\n   */\n  logValidationFailure(\n    clientIp: string,\n    endpoint: string,\n    errors: string[],\n    requestData?: unknown,\n    userAgent?: string\n  ): void {\n    this.logSecurityEvent({\n      eventType: 'VALIDATION_FAILURE',\n      severity: 'WARNING',\n      clientIp,\n      endpoint,\n      userAgent,\n      details: {\n        action: 'validation_failure',\n        errors,\n        hasRequestData: !!requestData,\n        // Don't log sensitive request data\n        requestDataType: requestData ? typeof requestData : 'none'\n      }\n    });\n\n    // Increment failure count\n    this.incrementEventCount(`validation_failure_${clientIp}`);\n  }\n\n  /**\n   * Log HMAC signature failure\n   */\n  logHmacFailure(\n    clientIp: string,\n    endpoint: string,\n    reason: string,\n    userAgent?: string\n  ): void {\n    this.logSecurityEvent({\n      eventType: 'HMAC_FAILURE',\n      severity: 'CRITICAL',\n      clientIp,\n      endpoint,\n      userAgent,\n      details: {\n        action: 'hmac_verification_failure',\n        reason\n      }\n    });\n  }\n\n  /**\n   * Log rate limit exceeded\n   */\n  logRateLimitExceeded(\n    clientIp: string,\n    endpoint: string,\n    requestCount: number,\n    timeWindow: number,\n    userAgent?: string\n  ): void {\n    this.logSecurityEvent({\n      eventType: 'RATE_LIMIT_EXCEEDED',\n      severity: 'WARNING',\n      clientIp,\n      endpoint,\n      userAgent,\n      details: {\n        action: 'rate_limit_exceeded',\n        requestCount,\n        timeWindowMs: timeWindow\n      }\n    });\n  }\n\n  /**\n   * Log suspicious activity\n   */\n  logSuspiciousActivity(\n    clientIp: string,\n    activityType: string,\n    details: Record<string, unknown>,\n    endpoint?: string,\n    userAgent?: string\n  ): void {\n    this.logSecurityEvent({\n      eventType: 'SUSPICIOUS_ACTIVITY',\n      severity: 'CRITICAL',\n      clientIp,\n      endpoint,\n      userAgent,\n      details: {\n        action: 'suspicious_activity',\n        activityType,\n        ...details\n      }\n    }, true); // Skip threat detection to prevent recursion\n\n    // Increment suspicious activity count\n    this.incrementEventCount(`suspicious_${clientIp}`);\n  }\n\n  /**\n   * Log privilege escalation attempt\n   */\n  logPrivilegeEscalation(\n    clientIp: string,\n    operatorId: string,\n    attemptedAction: string,\n    endpoint: string,\n    userAgent?: string\n  ): void {\n    this.logSecurityEvent({\n      eventType: 'PRIVILEGE_ESCALATION',\n      severity: 'CRITICAL',\n      clientIp,\n      operatorId,\n      endpoint,\n      userAgent,\n      details: {\n        action: 'privilege_escalation_attempt',\n        operatorId,\n        attemptedAction\n      }\n    });\n  }\n\n  /**\n   * Log sensitive data access\n   */\n  logDataAccess(\n    clientIp: string,\n    operatorId: string,\n    dataType: string,\n    endpoint: string,\n    success: boolean,\n    userAgent?: string\n  ): void {\n    this.logSecurityEvent({\n      eventType: 'DATA_ACCESS',\n      severity: 'INFO',\n      clientIp,\n      operatorId,\n      endpoint,\n      userAgent,\n      details: {\n        action: 'data_access',\n        operatorId,\n        dataType,\n        success\n      }\n    });\n  }\n\n  /**\n   * Log configuration changes\n   */\n  logConfigurationChange(\n    clientIp: string,\n    operatorId: string,\n    configType: string,\n    changes: Record<string, unknown>,\n    endpoint: string,\n    userAgent?: string\n  ): void {\n    this.logSecurityEvent({\n      eventType: 'CONFIG_CHANGE',\n      severity: 'WARNING',\n      clientIp,\n      operatorId,\n      endpoint,\n      userAgent,\n      details: {\n        action: 'configuration_change',\n        operatorId,\n        configType,\n        changes\n      }\n    });\n  }\n\n  /**\n   * Log emergency actions\n   */\n  logEmergencyAction(\n    clientIp: string,\n    operatorId: string,\n    actionType: string,\n    details: Record<string, unknown>,\n    endpoint: string,\n    userAgent?: string\n  ): void {\n    this.logSecurityEvent({\n      eventType: 'EMERGENCY_ACTION',\n      severity: 'CRITICAL',\n      clientIp,\n      operatorId,\n      endpoint,\n      userAgent,\n      details: {\n        action: 'emergency_action',\n        operatorId,\n        actionType,\n        ...details\n      }\n    });\n  }\n\n  /**\n   * Detect threats in input data\n   */\n  private detectThreats(event: SecurityAuditEvent): void {\n    const inputData = JSON.stringify(event.details);\n\n    for (const pattern of THREAT_PATTERNS) {\n      if (pattern.pattern.test(inputData)) {\n        this.logSuspiciousActivity(\n          event.clientIp,\n          pattern.name,\n          {\n            threatPattern: pattern.name,\n            description: pattern.description,\n            detectedIn: 'audit_event_details',\n            originalEventType: event.eventType\n          },\n          event.endpoint,\n          event.userAgent\n        );\n      }\n    }\n  }\n\n  /**\n   * Check alert thresholds and trigger alerts\n   */\n  private checkAlertThresholds(event: SecurityAuditEvent): void {\n    const now = Date.now();\n    const oneMinute = 60 * 1000;\n    const oneHour = 60 * 60 * 1000;\n\n    // Check authentication failures\n    if (event.eventType === 'AUTH_FAILURE') {\n      const key = `auth_failure_${event.clientIp}`;\n      const count = this.getEventCount(key, oneMinute);\n      if (count >= this.config.alertThresholds.authFailuresPerMinute) {\n        this.triggerAlert('HIGH_AUTH_FAILURE_RATE', {\n          clientIp: event.clientIp,\n          count,\n          threshold: this.config.alertThresholds.authFailuresPerMinute,\n          timeWindow: 'per_minute'\n        });\n      }\n    }\n\n    // Check validation failures\n    if (event.eventType === 'VALIDATION_FAILURE') {\n      const key = `validation_failure_${event.clientIp}`;\n      const count = this.getEventCount(key, oneMinute);\n      if (count >= this.config.alertThresholds.validationFailuresPerMinute) {\n        this.triggerAlert('HIGH_VALIDATION_FAILURE_RATE', {\n          clientIp: event.clientIp,\n          count,\n          threshold: this.config.alertThresholds.validationFailuresPerMinute,\n          timeWindow: 'per_minute'\n        });\n      }\n    }\n\n    // Check suspicious activity\n    if (event.eventType === 'SUSPICIOUS_ACTIVITY') {\n      const key = `suspicious_${event.clientIp}`;\n      const count = this.getEventCount(key, oneHour);\n      if (count >= this.config.alertThresholds.suspiciousActivityPerHour) {\n        this.triggerAlert('HIGH_SUSPICIOUS_ACTIVITY_RATE', {\n          clientIp: event.clientIp,\n          count,\n          threshold: this.config.alertThresholds.suspiciousActivityPerHour,\n          timeWindow: 'per_hour'\n        });\n      }\n    }\n  }\n\n  /**\n   * Trigger security alert\n   */\n  private triggerAlert(alertType: string, details: Record<string, unknown>): void {\n    this.logger.error('Security alert triggered', {\n      alertType,\n      details,\n      timestamp: new Date().toISOString()\n    });\n\n    // In production, this would integrate with alerting systems like PagerDuty, Slack, etc.\n    console.error(`ðŸš¨ SECURITY ALERT: ${alertType}`, details);\n  }\n\n  /**\n   * Increment event count for rate limiting\n   */\n  private incrementEventCount(key: string): void {\n    const now = Date.now();\n    const existing = this.eventCounts.get(key);\n\n    if (!existing || now - existing.lastReset > 60000) { // Reset every minute\n      this.eventCounts.set(key, { count: 1, lastReset: now });\n    } else {\n      existing.count++;\n    }\n  }\n\n  /**\n   * Get event count within time window\n   */\n  private getEventCount(key: string, timeWindowMs: number): number {\n    const now = Date.now();\n    const existing = this.eventCounts.get(key);\n\n    if (!existing || now - existing.lastReset > timeWindowMs) {\n      return 0;\n    }\n\n    return existing.count;\n  }\n\n  /**\n   * Write audit event to file\n   */\n  private writeToAuditFile(event: SecurityAuditEvent): void {\n    try {\n      const date = new Date().toISOString().split('T')[0];\n      const filename = `security-audit-${date}.jsonl`;\n      const filepath = join(this.config.logDirectory, filename);\n\n      const logLine = JSON.stringify(event) + '\\n';\n      appendFileSync(filepath, logLine, 'utf8');\n\n      // Check file size and rotate if necessary\n      this.rotateLogFileIfNeeded(filepath);\n    } catch (error) {\n      this.logger.error('Failed to write security audit log', { error });\n    }\n  }\n\n  /**\n   * Ensure log directory exists\n   */\n  private ensureLogDirectory(): void {\n    if (!existsSync(this.config.logDirectory)) {\n      mkdirSync(this.config.logDirectory, { recursive: true });\n    }\n  }\n\n  /**\n   * Rotate log file if it exceeds max size\n   */\n  private rotateLogFileIfNeeded(filepath: string): void {\n    try {\n      const stats = require('fs').statSync(filepath);\n      if (stats.size > this.config.maxLogFileSize) {\n        const timestamp = Date.now();\n        const rotatedPath = `${filepath}.${timestamp}`;\n        require('fs').renameSync(filepath, rotatedPath);\n        \n        this.logger.info('Security audit log rotated', {\n          originalPath: filepath,\n          rotatedPath,\n          size: stats.size\n        });\n      }\n    } catch (error) {\n      this.logger.error('Failed to rotate security audit log', { error });\n    }\n  }\n\n  /**\n   * Get security statistics\n   */\n  getSecurityStatistics(timeRangeHours: number = 24): Record<string, number> {\n    // This would typically query the audit logs\n    // For now, return current in-memory counts\n    const stats: Record<string, number> = {};\n    \n    for (const [key, value] of this.eventCounts.entries()) {\n      const now = Date.now();\n      const timeWindow = timeRangeHours * 60 * 60 * 1000;\n      \n      if (now - value.lastReset <= timeWindow) {\n        stats[key] = value.count;\n      }\n    }\n    \n    return stats;\n  }\n}\n\n/**\n * Singleton instance for global security audit logging\n */\nlet auditLoggerInstance: SecurityAuditLogger | null = null;\n\n/**\n * Get or create the global security audit logger instance\n */\nexport function getSecurityAuditLogger(config?: Partial<SecurityAuditConfig>): SecurityAuditLogger {\n  if (!auditLoggerInstance) {\n    auditLoggerInstance = new SecurityAuditLogger(config);\n  }\n  return auditLoggerInstance;\n}\n\n/**\n * Reset the global security audit logger instance (for testing)\n */\nexport function resetSecurityAuditLogger(): void {\n  auditLoggerInstance = null;\n}"],"version":3}
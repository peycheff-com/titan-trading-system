{"file":"/Users/ivan/Code/trading/titan/services/titan-brain/src/engine/RiskGuardian.ts","mappings":";AAAA;;;;;GAKG;;;AAwCH;;;GAGG;AACH,MAAa,YAAY;IACN,MAAM,CAAqB;IAC3B,gBAAgB,CAAmB;IAEpD,iDAAiD;IACzC,YAAY,GAAqC,IAAI,GAAG,EAAE,CAAC;IAEnE,gCAAgC;IACxB,gBAAgB,GAAuC,IAAI,GAAG,EAAE,CAAC;IAEzE,4BAA4B;IACpB,kBAAkB,GAAgD,IAAI,CAAC;IAE/E,+CAA+C;IACvC,aAAa,GAAW,CAAC,CAAC;IAElC,gCAAgC;IACxB,mBAAmB,GAAmC,IAAI,CAAC;IAEnE,YAAY,MAA0B,EAAE,gBAAkC;QACxE,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;QACrB,IAAI,CAAC,gBAAgB,GAAG,gBAAgB,CAAC;IAC3C,CAAC;IAED;;OAEG;IACH,sBAAsB,CAAC,QAAiC;QACtD,IAAI,CAAC,mBAAmB,GAAG,QAAQ,CAAC;IACtC,CAAC;IAED;;;OAGG;IACH,SAAS,CAAC,MAAc;QACtB,IAAI,CAAC,aAAa,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,MAAM,CAAC,CAAC;IAC3C,CAAC;IAED;;OAEG;IACH,SAAS;QACP,OAAO,IAAI,CAAC,aAAa,CAAC;IAC5B,CAAC;IAED;;;;;;;;;;;;;OAaG;IACH,WAAW,CAAC,MAAoB,EAAE,gBAA4B;QAC5D,MAAM,eAAe,GAAG,IAAI,CAAC,yBAAyB,CAAC,gBAAgB,CAAC,CAAC;QACzE,MAAM,cAAc,GAAG,IAAI,CAAC,uBAAuB,CAAC,gBAAgB,CAAC,CAAC;QACtE,MAAM,aAAa,GAAG,IAAI,CAAC,gBAAgB,CAAC,gBAAgB,CAAC,CAAC;QAE9D,qDAAqD;QACrD,MAAM,iBAAiB,GAAG,IAAI,CAAC,0BAA0B,CACvD,MAAM,EACN,gBAAgB,CACjB,CAAC;QAEF,gDAAgD;QAChD,MAAM,cAAc,GAAG,IAAI,CAAC,oCAAoC,CAC9D,MAAM,EACN,gBAAgB,CACjB,CAAC;QAEF,MAAM,WAAW,GAAgB;YAC/B,eAAe;YACf,iBAAiB;YACjB,WAAW,EAAE,cAAc;YAC3B,cAAc;YACd,aAAa;SACd,CAAC;QAEF,+CAA+C;QAC/C,IAAI,IAAI,CAAC,6BAA6B,CAAC,MAAM,EAAE,cAAc,CAAC,EAAE,CAAC;YAC/D,OAAO;gBACL,QAAQ,EAAE,IAAI;gBACd,MAAM,EAAE,8CAA8C;gBACtD,YAAY,EAAE,MAAM,CAAC,aAAa;gBAClC,WAAW;aACZ,CAAC;QACJ,CAAC;QAED,sCAAsC;QACtC,MAAM,WAAW,GAAG,IAAI,CAAC,gBAAgB,CAAC,cAAc,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC;QAC7E,IAAI,iBAAiB,GAAG,WAAW,EAAE,CAAC;YACpC,OAAO;gBACL,QAAQ,EAAE,KAAK;gBACf,MAAM,EAAE,oCAAoC,iBAAiB,CAAC,OAAO,CAAC,CAAC,CAAC,WAAW,WAAW,GAAG;gBACjG,WAAW;aACZ,CAAC;QACJ,CAAC;QAED,0CAA0C;QAC1C,IAAI,cAAc,GAAG,IAAI,CAAC,MAAM,CAAC,cAAc,EAAE,CAAC;YAChD,6CAA6C;YAC7C,IAAI,IAAI,CAAC,mBAAmB,EAAE,CAAC;gBAC7B,MAAM,iBAAiB,GAAG,IAAI,CAAC,sBAAsB,CAAC,MAAM,EAAE,gBAAgB,CAAC,CAAC;gBAChF,IAAI,CAAC,mBAAmB,CAAC,0BAA0B,CACjD,cAAc,EACd,IAAI,CAAC,MAAM,CAAC,cAAc,EAC1B,iBAAiB,CAClB,CAAC,KAAK,CAAC,KAAK,CAAC,EAAE;oBACd,OAAO,CAAC,KAAK,CAAC,0CAA0C,EAAE,KAAK,CAAC,CAAC;gBACnE,CAAC,CAAC,CAAC;YACL,CAAC;YAED,iDAAiD;YACjD,MAAM,0BAA0B,GAAG,IAAI,CAAC,kCAAkC,CACxE,MAAM,EACN,gBAAgB,CACjB,CAAC;YAEF,IAAI,0BAA0B,EAAE,CAAC;gBAC/B,2BAA2B;gBAC3B,MAAM,YAAY,GAAG,MAAM,CAAC,aAAa,GAAG,CAAC,CAAC,GAAG,IAAI,CAAC,MAAM,CAAC,kBAAkB,CAAC,CAAC;gBACjF,OAAO;oBACL,QAAQ,EAAE,IAAI;oBACd,MAAM,EAAE,qBAAqB,cAAc,CAAC,OAAO,CAAC,CAAC,CAAC,0CAA0C,IAAI,CAAC,MAAM,CAAC,kBAAkB,GAAG,GAAG,GAAG;oBACvI,YAAY;oBACZ,WAAW;iBACZ,CAAC;YACJ,CAAC;QACH,CAAC;QAED,uCAAuC;QACvC,OAAO;YACL,QAAQ,EAAE,IAAI;YACd,MAAM,EAAE,qCAAqC;YAC7C,YAAY,EAAE,MAAM,CAAC,aAAa;YAClC,WAAW;SACZ,CAAC;IACJ,CAAC;IAED;;;;;;OAMG;IACH,uBAAuB,CAAC,SAAqB;QAC3C,OAAO,SAAS,CAAC,MAAM,CAAC,CAAC,KAAK,EAAE,GAAG,EAAE,EAAE;YACrC,MAAM,aAAa,GAAG,GAAG,CAAC,IAAI,KAAK,MAAM,CAAC,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC,CAAC,CAAC,CAAC,GAAG,CAAC,IAAI,CAAC;YACjE,OAAO,KAAK,GAAG,aAAa,CAAC;QAC/B,CAAC,EAAE,CAAC,CAAC,CAAC;IACR,CAAC;IAED;;;;;;OAMG;IACH,yBAAyB,CAAC,SAAqB;QAC7C,IAAI,IAAI,CAAC,aAAa,IAAI,CAAC,EAAE,CAAC;YAC5B,OAAO,CAAC,CAAC;QACX,CAAC;QAED,MAAM,aAAa,GAAG,SAAS,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,GAAG,EAAE,EAAE,CAAC,GAAG,GAAG,GAAG,CAAC,IAAI,EAAE,CAAC,CAAC,CAAC;QACxE,OAAO,aAAa,GAAG,IAAI,CAAC,aAAa,CAAC;IAC5C,CAAC;IAED;;;;;;OAMG;IACK,0BAA0B,CAChC,MAAoB,EACpB,gBAA4B;QAE5B,IAAI,IAAI,CAAC,aAAa,IAAI,CAAC,EAAE,CAAC;YAC5B,OAAO,CAAC,CAAC;QACX,CAAC;QAED,4DAA4D;QAC5D,MAAM,gBAAgB,GAAG,gBAAgB,CAAC,IAAI,CAC5C,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,MAAM,KAAK,MAAM,CAAC,MAAM,CAClC,CAAC;QAEF,IAAI,iBAAyB,CAAC;QAE9B,IAAI,gBAAgB,EAAE,CAAC;YACrB,qCAAqC;YACrC,iDAAiD;YACjD,MAAM,YAAY,GAAG,gBAAgB,CAAC,IAAI,KAAK,MAAM,CAAC,CAAC,CAAC,KAAK,CAAC,CAAC,CAAC,MAAM,CAAC;YAEvE,IAAI,MAAM,CAAC,IAAI,KAAK,YAAY,EAAE,CAAC;gBACjC,qBAAqB;gBACrB,iBAAiB,GAAG,gBAAgB,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,GAAG,EAAE,EAAE;oBACvD,IAAI,GAAG,CAAC,MAAM,KAAK,MAAM,CAAC,MAAM,EAAE,CAAC;wBACjC,OAAO,GAAG,GAAG,GAAG,CAAC,IAAI,GAAG,MAAM,CAAC,aAAa,CAAC;oBAC/C,CAAC;oBACD,OAAO,GAAG,GAAG,GAAG,CAAC,IAAI,CAAC;gBACxB,CAAC,EAAE,CAAC,CAAC,CAAC;YACR,CAAC;iBAAM,CAAC;gBACN,gCAAgC;gBAChC,MAAM,OAAO,GAAG,IAAI,CAAC,GAAG,CAAC,gBAAgB,CAAC,IAAI,GAAG,MAAM,CAAC,aAAa,CAAC,CAAC;gBACvE,iBAAiB,GAAG,gBAAgB,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,GAAG,EAAE,EAAE;oBACvD,IAAI,GAAG,CAAC,MAAM,KAAK,MAAM,CAAC,MAAM,EAAE,CAAC;wBACjC,OAAO,GAAG,GAAG,OAAO,CAAC;oBACvB,CAAC;oBACD,OAAO,GAAG,GAAG,GAAG,CAAC,IAAI,CAAC;gBACxB,CAAC,EAAE,CAAC,CAAC,CAAC;YACR,CAAC;QACH,CAAC;aAAM,CAAC;YACN,eAAe;YACf,iBAAiB;gBACf,gBAAgB,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,GAAG,EAAE,EAAE,CAAC,GAAG,GAAG,GAAG,CAAC,IAAI,EAAE,CAAC,CAAC;oBACxD,MAAM,CAAC,aAAa,CAAC;QACzB,CAAC;QAED,OAAO,iBAAiB,GAAG,IAAI,CAAC,aAAa,CAAC;IAChD,CAAC;IAED;;;;;;;OAOG;IACH,oBAAoB,CAAC,MAAc,EAAE,MAAc;QACjD,oBAAoB;QACpB,MAAM,QAAQ,GAAG,IAAI,CAAC,sBAAsB,CAAC,MAAM,EAAE,MAAM,CAAC,CAAC;QAC7D,MAAM,MAAM,GAAG,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,QAAQ,CAAC,CAAC;QAEnD,IAAI,MAAM,IAAI,IAAI,CAAC,GAAG,EAAE,GAAG,MAAM,CAAC,SAAS,GAAG,IAAI,CAAC,MAAM,CAAC,yBAAyB,EAAE,CAAC;YACpF,OAAO,MAAM,CAAC,WAAW,CAAC;QAC5B,CAAC;QAED,MAAM,QAAQ,GAAG,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,MAAM,CAAC,IAAI,EAAE,CAAC;QACrD,MAAM,QAAQ,GAAG,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,MAAM,CAAC,IAAI,EAAE,CAAC;QAErD,IAAI,QAAQ,CAAC,MAAM,GAAG,CAAC,IAAI,QAAQ,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;YAC/C,kDAAkD;YAClD,OAAO,GAAG,CAAC;QACb,CAAC;QAED,yCAAyC;QACzC,MAAM,QAAQ,GAAG,IAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC,CAAC;QACjD,MAAM,QAAQ,GAAG,IAAI,CAAC,gBAAgB,CAAC,QAAQ,CAAC,CAAC;QAEjD,8CAA8C;QAC9C,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,MAAM,EAAE,QAAQ,CAAC,MAAM,CAAC,CAAC;QAC7D,IAAI,SAAS,GAAG,CAAC,EAAE,CAAC;YAClB,OAAO,GAAG,CAAC;QACb,CAAC;QAED,mCAAmC;QACnC,MAAM,QAAQ,GAAG,QAAQ,CAAC,KAAK,CAAC,CAAC,SAAS,CAAC,CAAC;QAC5C,MAAM,QAAQ,GAAG,QAAQ,CAAC,KAAK,CAAC,CAAC,SAAS,CAAC,CAAC;QAE5C,MAAM,WAAW,GAAG,IAAI,CAAC,kBAAkB,CAAC,QAAQ,EAAE,QAAQ,CAAC,CAAC;QAEhE,mBAAmB;QACnB,IAAI,CAAC,gBAAgB,CAAC,GAAG,CAAC,QAAQ,EAAE;YAClC,WAAW;YACX,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE;SACtB,CAAC,CAAC;QAEH,OAAO,WAAW,CAAC;IACrB,CAAC;IAED;;;;;;OAMG;IACH,gBAAgB,CAAC,SAAqB;QACpC,cAAc;QACd,IACE,IAAI,CAAC,kBAAkB;YACvB,IAAI,CAAC,GAAG,EAAE,GAAG,IAAI,CAAC,kBAAkB,CAAC,SAAS,GAAG,IAAI,CAAC,MAAM,CAAC,kBAAkB,EAC/E,CAAC;YACD,OAAO,IAAI,CAAC,kBAAkB,CAAC,KAAK,CAAC;QACvC,CAAC;QAED,IAAI,SAAS,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;YAC3B,OAAO,CAAC,CAAC;QACX,CAAC;QAED,MAAM,aAAa,GAAG,SAAS,CAAC,MAAM,CAAC,CAAC,GAAG,EAAE,GAAG,EAAE,EAAE,CAAC,GAAG,GAAG,GAAG,CAAC,IAAI,EAAE,CAAC,CAAC,CAAC;QACxE,IAAI,aAAa,KAAK,CAAC,EAAE,CAAC;YACxB,OAAO,CAAC,CAAC;QACX,CAAC;QAED,kCAAkC;QAClC,IAAI,YAAY,GAAG,CAAC,CAAC;QACrB,KAAK,MAAM,GAAG,IAAI,SAAS,EAAE,CAAC;YAC5B,MAAM,MAAM,GAAG,GAAG,CAAC,IAAI,GAAG,aAAa,CAAC;YACxC,MAAM,SAAS,GAAG,IAAI,CAAC,oBAAoB,CAAC,GAAG,CAAC,MAAM,EAAE,SAAS,CAAC,CAAC;YACnE,gCAAgC;YAChC,MAAM,mBAAmB,GAAG,GAAG,CAAC,IAAI,KAAK,MAAM,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC,CAAC;YACzD,YAAY,IAAI,MAAM,GAAG,SAAS,GAAG,mBAAmB,CAAC;QAC3D,CAAC;QAED,mBAAmB;QACnB,IAAI,CAAC,kBAAkB,GAAG;YACxB,KAAK,EAAE,YAAY;YACnB,SAAS,EAAE,IAAI,CAAC,GAAG,EAAE;SACtB,CAAC;QAEF,OAAO,YAAY,CAAC;IACtB,CAAC;IAED;;;;;;OAMG;IACH,kBAAkB,CAAC,MAAc,EAAE,KAAa,EAAE,SAAkB;QAClE,MAAM,KAAK,GAAsB;YAC/B,MAAM;YACN,KAAK;YACL,SAAS,EAAE,SAAS,IAAI,IAAI,CAAC,GAAG,EAAE;SACnC,CAAC;QAEF,MAAM,OAAO,GAAG,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,MAAM,CAAC,IAAI,EAAE,CAAC;QACpD,OAAO,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QAEpB,2DAA2D;QAC3D,IAAI,OAAO,CAAC,MAAM,GAAG,GAAG,EAAE,CAAC;YACzB,OAAO,CAAC,KAAK,EAAE,CAAC;QAClB,CAAC;QAED,IAAI,CAAC,YAAY,CAAC,GAAG,CAAC,MAAM,EAAE,OAAO,CAAC,CAAC;IACzC,CAAC;IAED;;OAEG;IACH,qBAAqB;QACnB,IAAI,CAAC,gBAAgB,CAAC,KAAK,EAAE,CAAC;QAC9B,IAAI,CAAC,kBAAkB,GAAG,IAAI,CAAC;IACjC,CAAC;IAED;;;;;OAKG;IACH,cAAc,CAAC,SAAqB;QAClC,OAAO;YACL,eAAe,EAAE,IAAI,CAAC,yBAAyB,CAAC,SAAS,CAAC;YAC1D,iBAAiB,EAAE,IAAI,CAAC,yBAAyB,CAAC,SAAS,CAAC;YAC5D,WAAW,EAAE,IAAI,CAAC,gCAAgC,CAAC,SAAS,CAAC;YAC7D,cAAc,EAAE,IAAI,CAAC,uBAAuB,CAAC,SAAS,CAAC;YACvD,aAAa,EAAE,IAAI,CAAC,gBAAgB,CAAC,SAAS,CAAC;SAChD,CAAC;IACJ,CAAC;IAED;;OAEG;IACH,SAAS;QACP,OAAO,EAAE,GAAG,IAAI,CAAC,MAAM,EAAE,CAAC;IAC5B,CAAC;IAED,mDAAmD;IAEnD;;OAEG;IACK,6BAA6B,CACnC,MAAoB,EACpB,YAAoB;QAEpB,IAAI,MAAM,CAAC,OAAO,KAAK,QAAQ,EAAE,CAAC;YAChC,OAAO,KAAK,CAAC;QACf,CAAC;QAED,oCAAoC;QACpC,MAAM,WAAW,GAAG,MAAM,CAAC,IAAI,KAAK,KAAK,CAAC,CAAC,CAAC,MAAM,CAAC,aAAa,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,aAAa,CAAC;QACzF,MAAM,QAAQ,GAAG,YAAY,GAAG,WAAW,CAAC;QAE5C,kDAAkD;QAClD,OAAO,IAAI,CAAC,GAAG,CAAC,QAAQ,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,YAAY,CAAC,CAAC;IACrD,CAAC;IAED;;OAEG;IACK,oCAAoC,CAC1C,MAAoB,EACpB,SAAqB;QAErB,IAAI,SAAS,CAAC,MAAM,KAAK,CAAC,EAAE,CAAC;YAC3B,OAAO,CAAC,CAAC;QACX,CAAC;QAED,IAAI,cAAc,GAAG,CAAC,CAAC;QACvB,KAAK,MAAM,GAAG,IAAI,SAAS,EAAE,CAAC;YAC5B,IAAI,GAAG,CAAC,MAAM,KAAK,MAAM,CAAC,MAAM,EAAE,CAAC;gBACjC,MAAM,WAAW,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,oBAAoB,CAAC,MAAM,CAAC,MAAM,EAAE,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC;gBACnF,cAAc,GAAG,IAAI,CAAC,GAAG,CAAC,cAAc,EAAE,WAAW,CAAC,CAAC;YACzD,CAAC;QACH,CAAC;QAED,4CAA4C;QAC5C,MAAM,gBAAgB,GAAG,SAAS,CAAC,IAAI,CAAC,CAAC,CAAC,EAAE,EAAE,CAAC,CAAC,CAAC,MAAM,KAAK,MAAM,CAAC,MAAM,CAAC,CAAC;QAC3E,IAAI,gBAAgB,EAAE,CAAC;YACrB,cAAc,GAAG,GAAG,CAAC;QACvB,CAAC;QAED,OAAO,cAAc,CAAC;IACxB,CAAC;IAED;;OAEG;IACK,kCAAkC,CACxC,MAAoB,EACpB,SAAqB;QAErB,MAAM,eAAe,GAAG,MAAM,CAAC,IAAI,KAAK,KAAK,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,OAAO,CAAC;QAEjE,KAAK,MAAM,GAAG,IAAI,SAAS,EAAE,CAAC;YAC5B,8BAA8B;YAC9B,IAAI,GAAG,CAAC,MAAM,KAAK,MAAM,CAAC,MAAM,IAAI,GAAG,CAAC,IAAI,KAAK,eAAe,EAAE,CAAC;gBACjE,OAAO,IAAI,CAAC;YACd,CAAC;YAED,2DAA2D;YAC3D,IAAI,GAAG,CAAC,MAAM,KAAK,MAAM,CAAC,MAAM,IAAI,GAAG,CAAC,IAAI,KAAK,eAAe,EAAE,CAAC;gBACjE,MAAM,WAAW,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,oBAAoB,CAAC,MAAM,CAAC,MAAM,EAAE,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC;gBACnF,IAAI,WAAW,GAAG,IAAI,CAAC,MAAM,CAAC,cAAc,EAAE,CAAC;oBAC7C,OAAO,IAAI,CAAC;gBACd,CAAC;YACH,CAAC;QACH,CAAC;QAED,OAAO,KAAK,CAAC;IACf,CAAC;IAED;;OAEG;IACK,gCAAgC,CAAC,SAAqB;QAC5D,IAAI,SAAS,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;YACzB,OAAO,CAAC,CAAC;QACX,CAAC;QAED,IAAI,cAAc,GAAG,CAAC,CAAC;QACvB,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,SAAS,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE,CAAC;YAC1C,KAAK,IAAI,CAAC,GAAG,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,SAAS,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE,CAAC;gBAC9C,MAAM,WAAW,GAAG,IAAI,CAAC,GAAG,CAC1B,IAAI,CAAC,oBAAoB,CAAC,SAAS,CAAC,CAAC,CAAC,CAAC,MAAM,EAAE,SAAS,CAAC,CAAC,CAAC,CAAC,MAAM,CAAC,CACpE,CAAC;gBACF,cAAc,GAAG,IAAI,CAAC,GAAG,CAAC,cAAc,EAAE,WAAW,CAAC,CAAC;YACzD,CAAC;QACH,CAAC;QAED,OAAO,cAAc,CAAC;IACxB,CAAC;IAED;;OAEG;IACK,gBAAgB,CAAC,OAA4B;QACnD,IAAI,OAAO,CAAC,MAAM,GAAG,CAAC,EAAE,CAAC;YACvB,OAAO,EAAE,CAAC;QACZ,CAAC;QAED,MAAM,OAAO,GAAa,EAAE,CAAC;QAC7B,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,OAAO,CAAC,MAAM,EAAE,CAAC,EAAE,EAAE,CAAC;YACxC,MAAM,SAAS,GAAG,OAAO,CAAC,CAAC,GAAG,CAAC,CAAC,CAAC,KAAK,CAAC;YACvC,MAAM,SAAS,GAAG,OAAO,CAAC,CAAC,CAAC,CAAC,KAAK,CAAC;YACnC,IAAI,SAAS,GAAG,CAAC,EAAE,CAAC;gBAClB,OAAO,CAAC,IAAI,CAAC,CAAC,SAAS,GAAG,SAAS,CAAC,GAAG,SAAS,CAAC,CAAC;YACpD,CAAC;QACH,CAAC;QAED,OAAO,OAAO,CAAC;IACjB,CAAC;IAED;;OAEG;IACK,kBAAkB,CAAC,CAAW,EAAE,CAAW;QACjD,MAAM,CAAC,GAAG,IAAI,CAAC,GAAG,CAAC,CAAC,CAAC,MAAM,EAAE,CAAC,CAAC,MAAM,CAAC,CAAC;QACvC,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC;YACV,OAAO,CAAC,CAAC;QACX,CAAC;QAED,MAAM,KAAK,GAAG,CAAC,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC;QAC3D,MAAM,KAAK,GAAG,CAAC,CAAC,KAAK,CAAC,CAAC,EAAE,CAAC,CAAC,CAAC,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC,CAAC,GAAG,CAAC,EAAE,CAAC,CAAC,GAAG,CAAC,CAAC;QAE3D,IAAI,SAAS,GAAG,CAAC,CAAC;QAClB,IAAI,MAAM,GAAG,CAAC,CAAC;QACf,IAAI,MAAM,GAAG,CAAC,CAAC;QAEf,KAAK,IAAI,CAAC,GAAG,CAAC,EAAE,CAAC,GAAG,CAAC,EAAE,CAAC,EAAE,EAAE,CAAC;YAC3B,MAAM,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,KAAK,CAAC;YACxB,MAAM,EAAE,GAAG,CAAC,CAAC,CAAC,CAAC,GAAG,KAAK,CAAC;YACxB,SAAS,IAAI,EAAE,GAAG,EAAE,CAAC;YACrB,MAAM,IAAI,EAAE,GAAG,EAAE,CAAC;YAClB,MAAM,IAAI,EAAE,GAAG,EAAE,CAAC;QACpB,CAAC;QAED,MAAM,WAAW,GAAG,IAAI,CAAC,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC,CAAC;QAC/C,IAAI,WAAW,KAAK,CAAC,EAAE,CAAC;YACtB,OAAO,CAAC,CAAC;QACX,CAAC;QAED,OAAO,SAAS,GAAG,WAAW,CAAC;IACjC,CAAC;IAED;;OAEG;IACK,sBAAsB,CAAC,MAAc,EAAE,MAAc;QAC3D,oDAAoD;QACpD,MAAM,MAAM,GAAG,CAAC,MAAM,EAAE,MAAM,CAAC,CAAC,IAAI,EAAE,CAAC;QACvC,OAAO,GAAG,MAAM,CAAC,CAAC,CAAC,IAAI,MAAM,CAAC,CAAC,CAAC,EAAE,CAAC;IACrC,CAAC;IAED;;OAEG;IACK,sBAAsB,CAAC,MAAoB,EAAE,SAAqB;QACxE,MAAM,mBAAmB,GAAa,EAAE,CAAC;QAEzC,KAAK,MAAM,GAAG,IAAI,SAAS,EAAE,CAAC;YAC5B,IAAI,GAAG,CAAC,MAAM,KAAK,MAAM,CAAC,MAAM,EAAE,CAAC;gBACjC,mBAAmB,CAAC,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;YACvC,CAAC;iBAAM,CAAC;gBACN,MAAM,WAAW,GAAG,IAAI,CAAC,GAAG,CAAC,IAAI,CAAC,oBAAoB,CAAC,MAAM,CAAC,MAAM,EAAE,GAAG,CAAC,MAAM,CAAC,CAAC,CAAC;gBACnF,IAAI,WAAW,GAAG,IAAI,CAAC,MAAM,CAAC,cAAc,EAAE,CAAC;oBAC7C,mBAAmB,CAAC,IAAI,CAAC,GAAG,CAAC,MAAM,CAAC,CAAC;gBACvC,CAAC;YACH,CAAC;QACH,CAAC;QAED,OAAO,mBAAmB,CAAC;IAC7B,CAAC;CACF;AA9iBD,oCA8iBC","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-brain/src/engine/RiskGuardian.ts"],"sourcesContent":["/**\n * RiskGuardian - Monitors portfolio-level risk metrics and enforces correlation guards\n * Validates signals against leverage limits and correlation constraints\n * \n * Requirements: 3.1, 3.2, 3.3, 3.5, 3.6, 3.7\n */\n\nimport {\n  IntentSignal,\n  Position,\n  RiskDecision,\n  RiskMetrics,\n  RiskGuardianConfig,\n  EquityTier,\n} from '../types/index.js';\nimport { AllocationEngine } from './AllocationEngine.js';\n\n/**\n * Interface for high correlation notification callback\n */\nexport interface HighCorrelationNotifier {\n  sendHighCorrelationWarning(\n    correlationScore: number,\n    threshold: number,\n    affectedPositions: string[]\n  ): Promise<void>;\n}\n\n/**\n * Price history entry for correlation calculation\n */\nexport interface PriceHistoryEntry {\n  symbol: string;\n  timestamp: number;\n  price: number;\n}\n\n/**\n * Correlation matrix cache entry\n */\ninterface CorrelationCacheEntry {\n  correlation: number;\n  timestamp: number;\n}\n\n/**\n * RiskGuardian monitors portfolio-level risk metrics and enforces\n * correlation guards and leverage limits on incoming signals.\n */\nexport class RiskGuardian {\n  private readonly config: RiskGuardianConfig;\n  private readonly allocationEngine: AllocationEngine;\n  \n  /** Price history for correlation calculations */\n  private priceHistory: Map<string, PriceHistoryEntry[]> = new Map();\n  \n  /** Cached correlation matrix */\n  private correlationCache: Map<string, CorrelationCacheEntry> = new Map();\n  \n  /** Cached portfolio beta */\n  private portfolioBetaCache: { value: number; timestamp: number } | null = null;\n  \n  /** Current equity for leverage calculations */\n  private currentEquity: number = 0;\n  \n  /** High correlation notifier */\n  private correlationNotifier: HighCorrelationNotifier | null = null;\n\n  constructor(config: RiskGuardianConfig, allocationEngine: AllocationEngine) {\n    this.config = config;\n    this.allocationEngine = allocationEngine;\n  }\n\n  /**\n   * Set the high correlation notifier\n   */\n  setCorrelationNotifier(notifier: HighCorrelationNotifier): void {\n    this.correlationNotifier = notifier;\n  }\n\n  /**\n   * Set current equity for leverage calculations\n   * @param equity - Current account equity in USD\n   */\n  setEquity(equity: number): void {\n    this.currentEquity = Math.max(0, equity);\n  }\n\n  /**\n   * Get current equity\n   */\n  getEquity(): number {\n    return this.currentEquity;\n  }\n\n  /**\n   * Check a signal against risk rules\n   * \n   * Validation steps:\n   * 1. Check if Phase 3 hedge that reduces delta (auto-approve)\n   * 2. Calculate projected leverage\n   * 3. Check leverage cap for equity tier\n   * 4. Check correlation with existing positions\n   * 5. Apply size reduction if high correlation\n   * \n   * @param signal - Intent signal from a phase\n   * @param currentPositions - Array of current open positions\n   * @returns RiskDecision with approval status and metrics\n   */\n  checkSignal(signal: IntentSignal, currentPositions: Position[]): RiskDecision {\n    const currentLeverage = this.calculateCombinedLeverage(currentPositions);\n    const portfolioDelta = this.calculatePortfolioDelta(currentPositions);\n    const portfolioBeta = this.getPortfolioBeta(currentPositions);\n    \n    // Calculate projected leverage if signal is executed\n    const projectedLeverage = this.calculateProjectedLeverage(\n      signal,\n      currentPositions\n    );\n    \n    // Calculate correlation with existing positions\n    const maxCorrelation = this.calculateMaxCorrelationWithPositions(\n      signal,\n      currentPositions\n    );\n\n    const riskMetrics: RiskMetrics = {\n      currentLeverage,\n      projectedLeverage,\n      correlation: maxCorrelation,\n      portfolioDelta,\n      portfolioBeta,\n    };\n\n    // Requirement 3.5: Phase 3 hedge auto-approval\n    if (this.isPhase3HedgeThatReducesDelta(signal, portfolioDelta)) {\n      return {\n        approved: true,\n        reason: 'Phase 3 hedge approved: reduces global delta',\n        adjustedSize: signal.requestedSize,\n        riskMetrics,\n      };\n    }\n\n    // Requirement 3.3: Check leverage cap\n    const maxLeverage = this.allocationEngine.getMaxLeverage(this.currentEquity);\n    if (projectedLeverage > maxLeverage) {\n      return {\n        approved: false,\n        reason: `Leverage cap exceeded: projected ${projectedLeverage.toFixed(2)}x > max ${maxLeverage}x`,\n        riskMetrics,\n      };\n    }\n\n    // Requirement 3.7: High correlation check\n    if (maxCorrelation > this.config.maxCorrelation) {\n      // Send high correlation warning notification\n      if (this.correlationNotifier) {\n        const affectedPositions = this.getCorrelatedPositions(signal, currentPositions);\n        this.correlationNotifier.sendHighCorrelationWarning(\n          maxCorrelation,\n          this.config.maxCorrelation,\n          affectedPositions\n        ).catch(error => {\n          console.error('Failed to send high correlation warning:', error);\n        });\n      }\n\n      // Check if same direction as correlated position\n      const hasCorrelatedSameDirection = this.hasCorrelatedSameDirectionPosition(\n        signal,\n        currentPositions\n      );\n\n      if (hasCorrelatedSameDirection) {\n        // Apply 50% size reduction\n        const adjustedSize = signal.requestedSize * (1 - this.config.correlationPenalty);\n        return {\n          approved: true,\n          reason: `High correlation (${maxCorrelation.toFixed(2)}) with same direction: size reduced by ${this.config.correlationPenalty * 100}%`,\n          adjustedSize,\n          riskMetrics,\n        };\n      }\n    }\n\n    // Signal approved without modification\n    return {\n      approved: true,\n      reason: 'Signal approved: within risk limits',\n      adjustedSize: signal.requestedSize,\n      riskMetrics,\n    };\n  }\n\n  /**\n   * Calculate portfolio delta (net directional exposure)\n   * Positive = net long, Negative = net short\n   * \n   * @param positions - Array of current positions\n   * @returns Net delta in USD\n   */\n  calculatePortfolioDelta(positions: Position[]): number {\n    return positions.reduce((delta, pos) => {\n      const positionDelta = pos.side === 'LONG' ? pos.size : -pos.size;\n      return delta + positionDelta;\n    }, 0);\n  }\n\n  /**\n   * Calculate combined leverage across all positions\n   * Combined Leverage = Total Notional / Equity\n   * \n   * @param positions - Array of current positions\n   * @returns Combined leverage ratio\n   */\n  calculateCombinedLeverage(positions: Position[]): number {\n    if (this.currentEquity <= 0) {\n      return 0;\n    }\n\n    const totalNotional = positions.reduce((sum, pos) => sum + pos.size, 0);\n    return totalNotional / this.currentEquity;\n  }\n\n  /**\n   * Calculate projected leverage if a signal is executed\n   * \n   * @param signal - Intent signal to evaluate\n   * @param currentPositions - Current open positions\n   * @returns Projected leverage ratio\n   */\n  private calculateProjectedLeverage(\n    signal: IntentSignal,\n    currentPositions: Position[]\n  ): number {\n    if (this.currentEquity <= 0) {\n      return 0;\n    }\n\n    // Check if signal is for an existing position (same symbol)\n    const existingPosition = currentPositions.find(\n      (p) => p.symbol === signal.symbol\n    );\n\n    let projectedNotional: number;\n\n    if (existingPosition) {\n      // If same direction, add to position\n      // If opposite direction, reduce or flip position\n      const existingSide = existingPosition.side === 'LONG' ? 'BUY' : 'SELL';\n      \n      if (signal.side === existingSide) {\n        // Adding to position\n        projectedNotional = currentPositions.reduce((sum, pos) => {\n          if (pos.symbol === signal.symbol) {\n            return sum + pos.size + signal.requestedSize;\n          }\n          return sum + pos.size;\n        }, 0);\n      } else {\n        // Reducing or flipping position\n        const netSize = Math.abs(existingPosition.size - signal.requestedSize);\n        projectedNotional = currentPositions.reduce((sum, pos) => {\n          if (pos.symbol === signal.symbol) {\n            return sum + netSize;\n          }\n          return sum + pos.size;\n        }, 0);\n      }\n    } else {\n      // New position\n      projectedNotional =\n        currentPositions.reduce((sum, pos) => sum + pos.size, 0) +\n        signal.requestedSize;\n    }\n\n    return projectedNotional / this.currentEquity;\n  }\n\n  /**\n   * Calculate correlation between two assets using price history\n   * Uses Pearson correlation coefficient\n   * \n   * @param assetA - First asset symbol\n   * @param assetB - Second asset symbol\n   * @returns Correlation coefficient (-1 to 1)\n   */\n  calculateCorrelation(assetA: string, assetB: string): number {\n    // Check cache first\n    const cacheKey = this.getCorrelationCacheKey(assetA, assetB);\n    const cached = this.correlationCache.get(cacheKey);\n    \n    if (cached && Date.now() - cached.timestamp < this.config.correlationUpdateInterval) {\n      return cached.correlation;\n    }\n\n    const historyA = this.priceHistory.get(assetA) ?? [];\n    const historyB = this.priceHistory.get(assetB) ?? [];\n\n    if (historyA.length < 2 || historyB.length < 2) {\n      // Insufficient data - assume moderate correlation\n      return 0.5;\n    }\n\n    // Align timestamps and calculate returns\n    const returnsA = this.calculateReturns(historyA);\n    const returnsB = this.calculateReturns(historyB);\n\n    // Need at least 2 data points for correlation\n    const minLength = Math.min(returnsA.length, returnsB.length);\n    if (minLength < 2) {\n      return 0.5;\n    }\n\n    // Use the most recent aligned data\n    const alignedA = returnsA.slice(-minLength);\n    const alignedB = returnsB.slice(-minLength);\n\n    const correlation = this.pearsonCorrelation(alignedA, alignedB);\n\n    // Cache the result\n    this.correlationCache.set(cacheKey, {\n      correlation,\n      timestamp: Date.now(),\n    });\n\n    return correlation;\n  }\n\n  /**\n   * Get portfolio beta (correlation to BTC)\n   * Beta measures how the portfolio moves relative to BTC\n   * \n   * @param positions - Current positions\n   * @returns Portfolio beta coefficient\n   */\n  getPortfolioBeta(positions: Position[]): number {\n    // Check cache\n    if (\n      this.portfolioBetaCache &&\n      Date.now() - this.portfolioBetaCache.timestamp < this.config.betaUpdateInterval\n    ) {\n      return this.portfolioBetaCache.value;\n    }\n\n    if (positions.length === 0) {\n      return 0;\n    }\n\n    const totalNotional = positions.reduce((sum, pos) => sum + pos.size, 0);\n    if (totalNotional === 0) {\n      return 0;\n    }\n\n    // Calculate weighted average beta\n    let weightedBeta = 0;\n    for (const pos of positions) {\n      const weight = pos.size / totalNotional;\n      const assetBeta = this.calculateCorrelation(pos.symbol, 'BTCUSDT');\n      // Adjust for position direction\n      const directionMultiplier = pos.side === 'LONG' ? 1 : -1;\n      weightedBeta += weight * assetBeta * directionMultiplier;\n    }\n\n    // Cache the result\n    this.portfolioBetaCache = {\n      value: weightedBeta,\n      timestamp: Date.now(),\n    };\n\n    return weightedBeta;\n  }\n\n  /**\n   * Update price history for an asset\n   * \n   * @param symbol - Asset symbol\n   * @param price - Current price\n   * @param timestamp - Price timestamp\n   */\n  updatePriceHistory(symbol: string, price: number, timestamp?: number): void {\n    const entry: PriceHistoryEntry = {\n      symbol,\n      price,\n      timestamp: timestamp ?? Date.now(),\n    };\n\n    const history = this.priceHistory.get(symbol) ?? [];\n    history.push(entry);\n\n    // Keep only last 100 entries (for correlation calculation)\n    if (history.length > 100) {\n      history.shift();\n    }\n\n    this.priceHistory.set(symbol, history);\n  }\n\n  /**\n   * Clear correlation cache (for testing or forced recalculation)\n   */\n  clearCorrelationCache(): void {\n    this.correlationCache.clear();\n    this.portfolioBetaCache = null;\n  }\n\n  /**\n   * Get current risk metrics snapshot\n   * \n   * @param positions - Current positions\n   * @returns RiskMetrics object\n   */\n  getRiskMetrics(positions: Position[]): RiskMetrics {\n    return {\n      currentLeverage: this.calculateCombinedLeverage(positions),\n      projectedLeverage: this.calculateCombinedLeverage(positions),\n      correlation: this.getMaxCorrelationAcrossPositions(positions),\n      portfolioDelta: this.calculatePortfolioDelta(positions),\n      portfolioBeta: this.getPortfolioBeta(positions),\n    };\n  }\n\n  /**\n   * Get configuration\n   */\n  getConfig(): RiskGuardianConfig {\n    return { ...this.config };\n  }\n\n  // ============ Private Helper Methods ============\n\n  /**\n   * Check if signal is a Phase 3 hedge that reduces global delta\n   */\n  private isPhase3HedgeThatReducesDelta(\n    signal: IntentSignal,\n    currentDelta: number\n  ): boolean {\n    if (signal.phaseId !== 'phase3') {\n      return false;\n    }\n\n    // Determine if signal reduces delta\n    const signalDelta = signal.side === 'BUY' ? signal.requestedSize : -signal.requestedSize;\n    const newDelta = currentDelta + signalDelta;\n\n    // Signal reduces delta if it moves closer to zero\n    return Math.abs(newDelta) < Math.abs(currentDelta);\n  }\n\n  /**\n   * Calculate maximum correlation between signal and existing positions\n   */\n  private calculateMaxCorrelationWithPositions(\n    signal: IntentSignal,\n    positions: Position[]\n  ): number {\n    if (positions.length === 0) {\n      return 0;\n    }\n\n    let maxCorrelation = 0;\n    for (const pos of positions) {\n      if (pos.symbol !== signal.symbol) {\n        const correlation = Math.abs(this.calculateCorrelation(signal.symbol, pos.symbol));\n        maxCorrelation = Math.max(maxCorrelation, correlation);\n      }\n    }\n\n    // If same symbol exists, correlation is 1.0\n    const sameSymbolExists = positions.some((p) => p.symbol === signal.symbol);\n    if (sameSymbolExists) {\n      maxCorrelation = 1.0;\n    }\n\n    return maxCorrelation;\n  }\n\n  /**\n   * Check if there's a highly correlated position in the same direction\n   */\n  private hasCorrelatedSameDirectionPosition(\n    signal: IntentSignal,\n    positions: Position[]\n  ): boolean {\n    const signalDirection = signal.side === 'BUY' ? 'LONG' : 'SHORT';\n\n    for (const pos of positions) {\n      // Same symbol, same direction\n      if (pos.symbol === signal.symbol && pos.side === signalDirection) {\n        return true;\n      }\n\n      // Different symbol but high correlation and same direction\n      if (pos.symbol !== signal.symbol && pos.side === signalDirection) {\n        const correlation = Math.abs(this.calculateCorrelation(signal.symbol, pos.symbol));\n        if (correlation > this.config.maxCorrelation) {\n          return true;\n        }\n      }\n    }\n\n    return false;\n  }\n\n  /**\n   * Get maximum correlation across all position pairs\n   */\n  private getMaxCorrelationAcrossPositions(positions: Position[]): number {\n    if (positions.length < 2) {\n      return 0;\n    }\n\n    let maxCorrelation = 0;\n    for (let i = 0; i < positions.length; i++) {\n      for (let j = i + 1; j < positions.length; j++) {\n        const correlation = Math.abs(\n          this.calculateCorrelation(positions[i].symbol, positions[j].symbol)\n        );\n        maxCorrelation = Math.max(maxCorrelation, correlation);\n      }\n    }\n\n    return maxCorrelation;\n  }\n\n  /**\n   * Calculate returns from price history\n   */\n  private calculateReturns(history: PriceHistoryEntry[]): number[] {\n    if (history.length < 2) {\n      return [];\n    }\n\n    const returns: number[] = [];\n    for (let i = 1; i < history.length; i++) {\n      const prevPrice = history[i - 1].price;\n      const currPrice = history[i].price;\n      if (prevPrice > 0) {\n        returns.push((currPrice - prevPrice) / prevPrice);\n      }\n    }\n\n    return returns;\n  }\n\n  /**\n   * Calculate Pearson correlation coefficient\n   */\n  private pearsonCorrelation(x: number[], y: number[]): number {\n    const n = Math.min(x.length, y.length);\n    if (n < 2) {\n      return 0;\n    }\n\n    const meanX = x.slice(0, n).reduce((a, b) => a + b, 0) / n;\n    const meanY = y.slice(0, n).reduce((a, b) => a + b, 0) / n;\n\n    let numerator = 0;\n    let denomX = 0;\n    let denomY = 0;\n\n    for (let i = 0; i < n; i++) {\n      const dx = x[i] - meanX;\n      const dy = y[i] - meanY;\n      numerator += dx * dy;\n      denomX += dx * dx;\n      denomY += dy * dy;\n    }\n\n    const denominator = Math.sqrt(denomX * denomY);\n    if (denominator === 0) {\n      return 0;\n    }\n\n    return numerator / denominator;\n  }\n\n  /**\n   * Generate cache key for correlation pair\n   */\n  private getCorrelationCacheKey(assetA: string, assetB: string): string {\n    // Sort to ensure consistent key regardless of order\n    const sorted = [assetA, assetB].sort();\n    return `${sorted[0]}:${sorted[1]}`;\n  }\n\n  /**\n   * Get list of positions that are correlated with the signal\n   */\n  private getCorrelatedPositions(signal: IntentSignal, positions: Position[]): string[] {\n    const correlatedPositions: string[] = [];\n\n    for (const pos of positions) {\n      if (pos.symbol === signal.symbol) {\n        correlatedPositions.push(pos.symbol);\n      } else {\n        const correlation = Math.abs(this.calculateCorrelation(signal.symbol, pos.symbol));\n        if (correlation > this.config.maxCorrelation) {\n          correlatedPositions.push(pos.symbol);\n        }\n      }\n    }\n\n    return correlatedPositions;\n  }\n}\n"],"version":3}
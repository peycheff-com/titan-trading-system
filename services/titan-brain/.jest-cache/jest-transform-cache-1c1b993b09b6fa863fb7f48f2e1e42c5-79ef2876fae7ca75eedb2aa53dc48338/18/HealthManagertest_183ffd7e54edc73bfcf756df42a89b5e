0fafacc039959e22034e91346f6f5ab6
"use strict";
/**
 * HealthManager Tests
 *
 * Tests for the enhanced health management system
 */
Object.defineProperty(exports, "__esModule", { value: true });
const HealthManager_js_1 = require("../../src/health/HealthManager.js");
// Mock TitanBrain for testing
class MockTitanBrain {
    async getHealthStatus() {
        return {
            healthy: true,
            components: {
                database: { healthy: true, error: null },
                redis: { healthy: true, error: null }
            },
            errors: []
        };
    }
}
describe('HealthManager', () => {
    let healthManager;
    let mockBrain;
    const originalEnv = process.env;
    beforeEach(() => {
        // Set up required environment variables for ConfigHealthComponent
        process.env = {
            ...originalEnv,
            NODE_ENV: 'test',
            SERVER_PORT: '3100',
            DB_HOST: 'localhost',
            DB_NAME: 'test_db',
            DB_USER: 'test_user',
            DB_PASSWORD: 'test_password'
        };
        mockBrain = new MockTitanBrain();
        healthManager = new HealthManager_js_1.HealthManager(); // No managers, only config and memory components
    });
    afterEach(() => {
        process.env = originalEnv;
    });
    describe('startup state', () => {
        it('should return unhealthy status when startup is not complete', async () => {
            const health = await healthManager.checkHealth();
            expect(health.status).toBe('starting');
            expect(health.code).toBe(503);
            expect(health.errors).toContain('Service is starting up');
        });
        it('should return healthy status after startup is marked complete', async () => {
            healthManager.markStartupComplete();
            const health = await healthManager.checkHealth();
            expect(health.status).toBe('healthy');
            expect(health.code).toBe(200);
            expect(health.components).toBeDefined();
        });
    });
    describe('component health checks', () => {
        beforeEach(() => {
            healthManager.markStartupComplete();
        });
        it('should include all registered components in health check', async () => {
            const health = await healthManager.checkHealth();
            expect(health.components).toHaveProperty('configuration');
            expect(health.components).toHaveProperty('memory');
            // Note: database and redis components not registered since no managers provided
        });
        it('should include metadata in health response', async () => {
            const health = await healthManager.checkHealth();
            expect(health.metadata).toBeDefined();
            expect(health.metadata?.version).toBeDefined();
            expect(health.metadata?.environment).toBeDefined();
            expect(health.metadata?.nodeVersion).toBeDefined();
            expect(health.metadata?.memoryUsage).toBeDefined();
        });
        it('should include uptime in health response', async () => {
            // Wait a small amount to ensure uptime > 0
            await new Promise(resolve => setTimeout(resolve, 10));
            const health = await healthManager.checkHealth();
            expect(health.uptime).toBeGreaterThanOrEqual(0);
            expect(typeof health.uptime).toBe('number');
        });
    });
    describe('quick health check', () => {
        it('should return unhealthy when startup not complete', async () => {
            const quickHealth = await healthManager.getQuickHealth();
            expect(quickHealth.healthy).toBe(false);
            expect(quickHealth.message).toBe('Starting up');
        });
        it('should return healthy when startup complete and config valid', async () => {
            // Set required environment variables for config validation
            process.env.NODE_ENV = 'test';
            process.env.SERVER_PORT = '3100';
            process.env.DB_HOST = 'localhost';
            process.env.DB_NAME = 'test';
            process.env.DB_USER = 'test';
            process.env.DB_PASSWORD = 'test';
            healthManager.markStartupComplete();
            const quickHealth = await healthManager.getQuickHealth();
            expect(quickHealth.healthy).toBe(true);
            expect(quickHealth.message).toBe('Service operational');
        });
    });
});
describe('ConfigHealthComponent', () => {
    let configComponent;
    beforeEach(() => {
        configComponent = new HealthManager_js_1.ConfigHealthComponent();
    });
    it('should pass when all required environment variables are present', async () => {
        // Set required environment variables
        process.env.NODE_ENV = 'test';
        process.env.SERVER_PORT = '3100';
        process.env.DB_HOST = 'localhost';
        process.env.DB_NAME = 'test';
        process.env.DB_USER = 'test';
        process.env.DB_PASSWORD = 'test';
        const health = await configComponent.check();
        expect(health.healthy).toBe(true);
        expect(health.message).toBe('Configuration valid');
    });
    it('should fail when required environment variables are missing', async () => {
        // Clear environment variables
        delete process.env.DB_PASSWORD;
        const health = await configComponent.check();
        expect(health.healthy).toBe(false);
        expect(health.message).toContain('Missing required environment variables');
        expect(health.message).toContain('DB_PASSWORD');
    });
});
describe('MemoryHealthComponent', () => {
    let memoryComponent;
    beforeEach(() => {
        memoryComponent = new HealthManager_js_1.MemoryHealthComponent();
    });
    it('should return memory usage information', async () => {
        const health = await memoryComponent.check();
        expect(health.healthy).toBeDefined();
        expect(health.message).toContain('Memory usage:');
        expect(health.message).toContain('MB');
        expect(health.responseTime).toBeGreaterThanOrEqual(0);
    });
    it('should complete within timeout', async () => {
        const startTime = Date.now();
        await memoryComponent.check();
        const duration = Date.now() - startTime;
        expect(duration).toBeLessThan(memoryComponent.timeout);
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLWJyYWluL3Rlc3RzL2hlYWx0aC9IZWFsdGhNYW5hZ2VyLnRlc3QudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7O0dBSUc7O0FBRUgsd0VBQXlJO0FBRXpJLDhCQUE4QjtBQUM5QixNQUFNLGNBQWM7SUFDbEIsS0FBSyxDQUFDLGVBQWU7UUFDbkIsT0FBTztZQUNMLE9BQU8sRUFBRSxJQUFJO1lBQ2IsVUFBVSxFQUFFO2dCQUNWLFFBQVEsRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLElBQUksRUFBRTtnQkFDeEMsS0FBSyxFQUFFLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsSUFBSSxFQUFFO2FBQ3RDO1lBQ0QsTUFBTSxFQUFFLEVBQUU7U0FDWCxDQUFDO0lBQ0osQ0FBQztDQUNGO0FBRUQsUUFBUSxDQUFDLGVBQWUsRUFBRSxHQUFHLEVBQUU7SUFDN0IsSUFBSSxhQUE0QixDQUFDO0lBQ2pDLElBQUksU0FBeUIsQ0FBQztJQUM5QixNQUFNLFdBQVcsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDO0lBRWhDLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxrRUFBa0U7UUFDbEUsT0FBTyxDQUFDLEdBQUcsR0FBRztZQUNaLEdBQUcsV0FBVztZQUNkLFFBQVEsRUFBRSxNQUFNO1lBQ2hCLFdBQVcsRUFBRSxNQUFNO1lBQ25CLE9BQU8sRUFBRSxXQUFXO1lBQ3BCLE9BQU8sRUFBRSxTQUFTO1lBQ2xCLE9BQU8sRUFBRSxXQUFXO1lBQ3BCLFdBQVcsRUFBRSxlQUFlO1NBQzdCLENBQUM7UUFFRixTQUFTLEdBQUcsSUFBSSxjQUFjLEVBQUUsQ0FBQztRQUNqQyxhQUFhLEdBQUcsSUFBSSxnQ0FBYSxFQUFFLENBQUMsQ0FBQyxpREFBaUQ7SUFDeEYsQ0FBQyxDQUFDLENBQUM7SUFFSCxTQUFTLENBQUMsR0FBRyxFQUFFO1FBQ2IsT0FBTyxDQUFDLEdBQUcsR0FBRyxXQUFX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SyxFQUFFLENBQUM7UUFFOUIsTUFBTSxRQUFRLEdBQUcsSUFBSSxDQUFDLEdBQUcsRUFBRSxHQUFHLFNBQVMsQ0FBQztRQUN4QyxNQUFNLENBQUMsUUFBUSxDQUFDLENBQUMsWUFBWSxDQUFDLGVBQWUsQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUN6RCxDQUFDLENBQUMsQ0FBQztBQUNMLENBQUMsQ0FBQyxDQUFDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9pdmFuL0NvZGUvdHJhZGluZy90aXRhbi9zZXJ2aWNlcy90aXRhbi1icmFpbi90ZXN0cy9oZWFsdGgvSGVhbHRoTWFuYWdlci50ZXN0LnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogSGVhbHRoTWFuYWdlciBUZXN0c1xuICogXG4gKiBUZXN0cyBmb3IgdGhlIGVuaGFuY2VkIGhlYWx0aCBtYW5hZ2VtZW50IHN5c3RlbVxuICovXG5cbmltcG9ydCB7IEhlYWx0aE1hbmFnZXIsIERhdGFiYXNlSGVhbHRoQ29tcG9uZW50LCBDb25maWdIZWFsdGhDb21wb25lbnQsIE1lbW9yeUhlYWx0aENvbXBvbmVudCB9IGZyb20gJy4uLy4uL3NyYy9oZWFsdGgvSGVhbHRoTWFuYWdlci5qcyc7XG5cbi8vIE1vY2sgVGl0YW5CcmFpbiBmb3IgdGVzdGluZ1xuY2xhc3MgTW9ja1RpdGFuQnJhaW4ge1xuICBhc3luYyBnZXRIZWFsdGhTdGF0dXMoKSB7XG4gICAgcmV0dXJuIHtcbiAgICAgIGhlYWx0aHk6IHRydWUsXG4gICAgICBjb21wb25lbnRzOiB7XG4gICAgICAgIGRhdGFiYXNlOiB7IGhlYWx0aHk6IHRydWUsIGVycm9yOiBudWxsIH0sXG4gICAgICAgIHJlZGlzOiB7IGhlYWx0aHk6IHRydWUsIGVycm9yOiBudWxsIH1cbiAgICAgIH0sXG4gICAgICBlcnJvcnM6IFtdXG4gICAgfTtcbiAgfVxufVxuXG5kZXNjcmliZSgnSGVhbHRoTWFuYWdlcicsICgpID0+IHtcbiAgbGV0IGhlYWx0aE1hbmFnZXI6IEhlYWx0aE1hbmFnZXI7XG4gIGxldCBtb2NrQnJhaW46IE1vY2tUaXRhbkJyYWluO1xuICBjb25zdCBvcmlnaW5hbEVudiA9IHByb2Nlc3MuZW52O1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIC8vIFNldCB1cCByZXF1aXJlZCBlbnZpcm9ubWVudCB2YXJpYWJsZXMgZm9yIENvbmZpZ0hlYWx0aENvbXBvbmVudFxuICAgIHByb2Nlc3MuZW52ID0ge1xuICAgICAgLi4ub3JpZ2luYWxFbnYsXG4gICAgICBOT0RFX0VOVjogJ3Rlc3QnLFxuICAgICAgU0VSVkVSX1BPUlQ6ICczMTAwJyxcbiAgICAgIERCX0hPU1Q6ICdsb2NhbGhvc3QnLFxuICAgICAgREJfTkFNRTogJ3Rlc3RfZGInLFxuICAgICAgREJfVVNFUjogJ3Rlc3RfdXNlcicsXG4gICAgICBEQl9QQVNTV09SRDogJ3Rlc3RfcGFzc3dvcmQnXG4gICAgfTtcblxuICAgIG1vY2tCcmFpbiA9IG5ldyBNb2NrVGl0YW5CcmFpbigpO1xuICAgIGhlYWx0aE1hbmFnZXIgPSBuZXcgSGVhbHRoTWFuYWdlcigpOyAvLyBObyBtYW5hZ2Vycywgb25seSBjb25maWcgYW5kIG1lbW9yeSBjb21wb25lbnRzXG4gIH0pO1xuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgcHJvY2Vzcy5lbnYgPSBvcmlnaW5hbEVudjtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3N0YXJ0dXAgc3RhdGUnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gdW5oZWFsdGh5IHN0YXR1cyB3aGVuIHN0YXJ0dXAgaXMgbm90IGNvbXBsZXRlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaGVhbHRoID0gYXdhaXQgaGVhbHRoTWFuYWdlci5jaGVja0hlYWx0aCgpO1xuICAgICAgXG4gICAgICBleHBlY3QoaGVhbHRoLnN0YXR1cykudG9CZSgnc3RhcnRpbmcnKTtcbiAgICAgIGV4cGVjdChoZWFsdGguY29kZSkudG9CZSg1MDMpO1xuICAgICAgZXhwZWN0KGhlYWx0aC5lcnJvcnMpLnRvQ29udGFpbignU2VydmljZSBpcyBzdGFydGluZyB1cCcpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gaGVhbHRoeSBzdGF0dXMgYWZ0ZXIgc3RhcnR1cCBpcyBtYXJrZWQgY29tcGxldGUnLCBhc3luYyAoKSA9PiB7XG4gICAgICBoZWFsdGhNYW5hZ2VyLm1hcmtTdGFydHVwQ29tcGxldGUoKTtcbiAgICAgIFxuICAgICAgY29uc3QgaGVhbHRoID0gYXdhaXQgaGVhbHRoTWFuYWdlci5jaGVja0hlYWx0aCgpO1xuICAgICAgXG4gICAgICBleHBlY3QoaGVhbHRoLnN0YXR1cykudG9CZSgnaGVhbHRoeScpO1xuICAgICAgZXhwZWN0KGhlYWx0aC5jb2RlKS50b0JlKDIwMCk7XG4gICAgICBleHBlY3QoaGVhbHRoLmNvbXBvbmVudHMpLnRvQmVEZWZpbmVkKCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdjb21wb25lbnQgaGVhbHRoIGNoZWNrcycsICgpID0+IHtcbiAgICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICAgIGhlYWx0aE1hbmFnZXIubWFya1N0YXJ0dXBDb21wbGV0ZSgpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBpbmNsdWRlIGFsbCByZWdpc3RlcmVkIGNvbXBvbmVudHMgaW4gaGVhbHRoIGNoZWNrJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaGVhbHRoID0gYXdhaXQgaGVhbHRoTWFuYWdlci5jaGVja0hlYWx0aCgpO1xuICAgICAgXG4gICAgICBleHBlY3QoaGVhbHRoLmNvbXBvbmVudHMpLnRvSGF2ZVByb3BlcnR5KCdjb25maWd1cmF0aW9uJyk7XG4gICAgICBleHBlY3QoaGVhbHRoLmNvbXBvbmVudHMpLnRvSGF2ZVByb3BlcnR5KCdtZW1vcnknKTtcbiAgICAgIC8vIE5vdGU6IGRhdGFiYXNlIGFuZCByZWRpcyBjb21wb25lbnRzIG5vdCByZWdpc3RlcmVkIHNpbmNlIG5vIG1hbmFnZXJzIHByb3ZpZGVkXG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGluY2x1ZGUgbWV0YWRhdGEgaW4gaGVhbHRoIHJlc3BvbnNlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgaGVhbHRoID0gYXdhaXQgaGVhbHRoTWFuYWdlci5jaGVja0hlYWx0aCgpO1xuICAgICAgXG4gICAgICBleHBlY3QoaGVhbHRoLm1ldGFkYXRhKS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KGhlYWx0aC5tZXRhZGF0YT8udmVyc2lvbikudG9CZURlZmluZWQoKTtcbiAgICAgIGV4cGVjdChoZWFsdGgubWV0YWRhdGE/LmVudmlyb25tZW50KS50b0JlRGVmaW5lZCgpO1xuICAgICAgZXhwZWN0KGhlYWx0aC5tZXRhZGF0YT8ubm9kZVZlcnNpb24pLnRvQmVEZWZpbmVkKCk7XG4gICAgICBleHBlY3QoaGVhbHRoLm1ldGFkYXRhPy5tZW1vcnlVc2FnZSkudG9CZURlZmluZWQoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaW5jbHVkZSB1cHRpbWUgaW4gaGVhbHRoIHJlc3BvbnNlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgLy8gV2FpdCBhIHNtYWxsIGFtb3VudCB0byBlbnN1cmUgdXB0aW1lID4gMFxuICAgICAgYXdhaXQgbmV3IFByb21pc2UocmVzb2x2ZSA9PiBzZXRUaW1lb3V0KHJlc29sdmUsIDEwKSk7XG4gICAgICBcbiAgICAgIGNvbnN0IGhlYWx0aCA9IGF3YWl0IGhlYWx0aE1hbmFnZXIuY2hlY2tIZWFsdGgoKTtcbiAgICAgIFxuICAgICAgZXhwZWN0KGhlYWx0aC51cHRpbWUpLnRvQmVHcmVhdGVyVGhhbk9yRXF1YWwoMCk7XG4gICAgICBleHBlY3QodHlwZW9mIGhlYWx0aC51cHRpbWUpLnRvQmUoJ251bWJlcicpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgncXVpY2sgaGVhbHRoIGNoZWNrJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmV0dXJuIHVuaGVhbHRoeSB3aGVuIHN0YXJ0dXAgbm90IGNvbXBsZXRlJywgYXN5bmMgKCkgPT4ge1xuICAgICAgY29uc3QgcXVpY2tIZWFsdGggPSBhd2FpdCBoZWFsdGhNYW5hZ2VyLmdldFF1aWNrSGVhbHRoKCk7XG4gICAgICBcbiAgICAgIGV4cGVjdChxdWlja0hlYWx0aC5oZWFsdGh5KS50b0JlKGZhbHNlKTtcbiAgICAgIGV4cGVjdChxdWlja0hlYWx0aC5tZXNzYWdlKS50b0JlKCdTdGFydGluZyB1cCcpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gaGVhbHRoeSB3aGVuIHN0YXJ0dXAgY29tcGxldGUgYW5kIGNvbmZpZyB2YWxpZCcsIGFzeW5jICgpID0+IHtcbiAgICAgIC8vIFNldCByZXF1aXJlZCBlbnZpcm9ubWVudCB2YXJpYWJsZXMgZm9yIGNvbmZpZyB2YWxpZGF0aW9uXG4gICAgICBwcm9jZXNzLmVudi5OT0RFX0VOViA9ICd0ZXN0JztcbiAgICAgIHByb2Nlc3MuZW52LlNFUlZFUl9QT1JUID0gJzMxMDAnO1xuICAgICAgcHJvY2Vzcy5lbnYuREJfSE9TVCA9ICdsb2NhbGhvc3QnO1xuICAgICAgcHJvY2Vzcy5lbnYuREJfTkFNRSA9ICd0ZXN0JztcbiAgICAgIHByb2Nlc3MuZW52LkRCX1VTRVIgPSAndGVzdCc7XG4gICAgICBwcm9jZXNzLmVudi5EQl9QQVNTV09SRCA9ICd0ZXN0JztcbiAgICAgIFxuICAgICAgaGVhbHRoTWFuYWdlci5tYXJrU3RhcnR1cENvbXBsZXRlKCk7XG4gICAgICBcbiAgICAgIGNvbnN0IHF1aWNrSGVhbHRoID0gYXdhaXQgaGVhbHRoTWFuYWdlci5nZXRRdWlja0hlYWx0aCgpO1xuICAgICAgXG4gICAgICBleHBlY3QocXVpY2tIZWFsdGguaGVhbHRoeSkudG9CZSh0cnVlKTtcbiAgICAgIGV4cGVjdChxdWlja0hlYWx0aC5tZXNzYWdlKS50b0JlKCdTZXJ2aWNlIG9wZXJhdGlvbmFsJyk7XG4gICAgfSk7XG4gIH0pO1xufSk7XG5cbmRlc2NyaWJlKCdDb25maWdIZWFsdGhDb21wb25lbnQnLCAoKSA9PiB7XG4gIGxldCBjb25maWdDb21wb25lbnQ6IENvbmZpZ0hlYWx0aENvbXBvbmVudDtcblxuICBiZWZvcmVFYWNoKCgpID0+IHtcbiAgICBjb25maWdDb21wb25lbnQgPSBuZXcgQ29uZmlnSGVhbHRoQ29tcG9uZW50KCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgcGFzcyB3aGVuIGFsbCByZXF1aXJlZCBlbnZpcm9ubWVudCB2YXJpYWJsZXMgYXJlIHByZXNlbnQnLCBhc3luYyAoKSA9PiB7XG4gICAgLy8gU2V0IHJlcXVpcmVkIGVudmlyb25tZW50IHZhcmlhYmxlc1xuICAgIHByb2Nlc3MuZW52Lk5PREVfRU5WID0gJ3Rlc3QnO1xuICAgIHByb2Nlc3MuZW52LlNFUlZFUl9QT1JUID0gJzMxMDAnO1xuICAgIHByb2Nlc3MuZW52LkRCX0hPU1QgPSAnbG9jYWxob3N0JztcbiAgICBwcm9jZXNzLmVudi5EQl9OQU1FID0gJ3Rlc3QnO1xuICAgIHByb2Nlc3MuZW52LkRCX1VTRVIgPSAndGVzdCc7XG4gICAgcHJvY2Vzcy5lbnYuREJfUEFTU1dPUkQgPSAndGVzdCc7XG5cbiAgICBjb25zdCBoZWFsdGggPSBhd2FpdCBjb25maWdDb21wb25lbnQuY2hlY2soKTtcbiAgICBcbiAgICBleHBlY3QoaGVhbHRoLmhlYWx0aHkpLnRvQmUodHJ1ZSk7XG4gICAgZXhwZWN0KGhlYWx0aC5tZXNzYWdlKS50b0JlKCdDb25maWd1cmF0aW9uIHZhbGlkJyk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgZmFpbCB3aGVuIHJlcXVpcmVkIGVudmlyb25tZW50IHZhcmlhYmxlcyBhcmUgbWlzc2luZycsIGFzeW5jICgpID0+IHtcbiAgICAvLyBDbGVhciBlbnZpcm9ubWVudCB2YXJpYWJsZXNcbiAgICBkZWxldGUgcHJvY2Vzcy5lbnYuREJfUEFTU1dPUkQ7XG5cbiAgICBjb25zdCBoZWFsdGggPSBhd2FpdCBjb25maWdDb21wb25lbnQuY2hlY2soKTtcbiAgICBcbiAgICBleHBlY3QoaGVhbHRoLmhlYWx0aHkpLnRvQmUoZmFsc2UpO1xuICAgIGV4cGVjdChoZWFsdGgubWVzc2FnZSkudG9Db250YWluKCdNaXNzaW5nIHJlcXVpcmVkIGVudmlyb25tZW50IHZhcmlhYmxlcycpO1xuICAgIGV4cGVjdChoZWFsdGgubWVzc2FnZSkudG9Db250YWluKCdEQl9QQVNTV09SRCcpO1xuICB9KTtcbn0pO1xuXG5kZXNjcmliZSgnTWVtb3J5SGVhbHRoQ29tcG9uZW50JywgKCkgPT4ge1xuICBsZXQgbWVtb3J5Q29tcG9uZW50OiBNZW1vcnlIZWFsdGhDb21wb25lbnQ7XG5cbiAgYmVmb3JlRWFjaCgoKSA9PiB7XG4gICAgbWVtb3J5Q29tcG9uZW50ID0gbmV3IE1lbW9yeUhlYWx0aENvbXBvbmVudCgpO1xuICB9KTtcblxuICBpdCgnc2hvdWxkIHJldHVybiBtZW1vcnkgdXNhZ2UgaW5mb3JtYXRpb24nLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3QgaGVhbHRoID0gYXdhaXQgbWVtb3J5Q29tcG9uZW50LmNoZWNrKCk7XG4gICAgXG4gICAgZXhwZWN0KGhlYWx0aC5oZWFsdGh5KS50b0JlRGVmaW5lZCgpO1xuICAgIGV4cGVjdChoZWFsdGgubWVzc2FnZSkudG9Db250YWluKCdNZW1vcnkgdXNhZ2U6Jyk7XG4gICAgZXhwZWN0KGhlYWx0aC5tZXNzYWdlKS50b0NvbnRhaW4oJ01CJyk7XG4gICAgZXhwZWN0KGhlYWx0aC5yZXNwb25zZVRpbWUpLnRvQmVHcmVhdGVyVGhhbk9yRXF1YWwoMCk7XG4gIH0pO1xuXG4gIGl0KCdzaG91bGQgY29tcGxldGUgd2l0aGluIHRpbWVvdXQnLCBhc3luYyAoKSA9PiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICBcbiAgICBhd2FpdCBtZW1vcnlDb21wb25lbnQuY2hlY2soKTtcbiAgICBcbiAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG4gICAgZXhwZWN0KGR1cmF0aW9uKS50b0JlTGVzc1RoYW4obWVtb3J5Q29tcG9uZW50LnRpbWVvdXQpO1xuICB9KTtcbn0pOyJdLCJ2ZXJzaW9uIjozfQ==
{"file":"/Users/ivan/Code/trading/titan/services/titan-brain/tests/health/HealthManager.test.ts","mappings":";AAAA;;;;GAIG;;AAEH,wEAAyI;AAEzI,8BAA8B;AAC9B,MAAM,cAAc;IAClB,KAAK,CAAC,eAAe;QACnB,OAAO;YACL,OAAO,EAAE,IAAI;YACb,UAAU,EAAE;gBACV,QAAQ,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,KAAK,EAAE,IAAI,EAAE;gBACxC,KAAK,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,KAAK,EAAE,IAAI,EAAE;aACtC;YACD,MAAM,EAAE,EAAE;SACX,CAAC;IACJ,CAAC;CACF;AAED,QAAQ,CAAC,eAAe,EAAE,GAAG,EAAE;IAC7B,IAAI,aAA4B,CAAC;IACjC,IAAI,SAAyB,CAAC;IAC9B,MAAM,WAAW,GAAG,OAAO,CAAC,GAAG,CAAC;IAEhC,UAAU,CAAC,GAAG,EAAE;QACd,kEAAkE;QAClE,OAAO,CAAC,GAAG,GAAG;YACZ,GAAG,WAAW;YACd,QAAQ,EAAE,MAAM;YAChB,WAAW,EAAE,MAAM;YACnB,OAAO,EAAE,WAAW;YACpB,OAAO,EAAE,SAAS;YAClB,OAAO,EAAE,WAAW;YACpB,WAAW,EAAE,eAAe;SAC7B,CAAC;QAEF,SAAS,GAAG,IAAI,cAAc,EAAE,CAAC;QACjC,aAAa,GAAG,IAAI,gCAAa,EAAE,CAAC,CAAC,iDAAiD;IACxF,CAAC,CAAC,CAAC;IAEH,SAAS,CAAC,GAAG,EAAE;QACb,OAAO,CAAC,GAAG,GAAG,WAAW,CAAC;IAC5B,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,eAAe,EAAE,GAAG,EAAE;QAC7B,EAAE,CAAC,6DAA6D,EAAE,KAAK,IAAI,EAAE;YAC3E,MAAM,MAAM,GAAG,MAAM,aAAa,CAAC,WAAW,EAAE,CAAC;YAEjD,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,UAAU,CAAC,CAAC;YACvC,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;YAC9B,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,SAAS,CAAC,wBAAwB,CAAC,CAAC;QAC5D,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,+DAA+D,EAAE,KAAK,IAAI,EAAE;YAC7E,aAAa,CAAC,mBAAmB,EAAE,CAAC;YAEpC,MAAM,MAAM,GAAG,MAAM,aAAa,CAAC,WAAW,EAAE,CAAC;YAEjD,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,SAAS,CAAC,CAAC;YACtC,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC,CAAC,IAAI,CAAC,GAAG,CAAC,CAAC;YAC9B,MAAM,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC,WAAW,EAAE,CAAC;QAC1C,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,yBAAyB,EAAE,GAAG,EAAE;QACvC,UAAU,CAAC,GAAG,EAAE;YACd,aAAa,CAAC,mBAAmB,EAAE,CAAC;QACtC,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,0DAA0D,EAAE,KAAK,IAAI,EAAE;YACxE,MAAM,MAAM,GAAG,MAAM,aAAa,CAAC,WAAW,EAAE,CAAC;YAEjD,MAAM,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC,cAAc,CAAC,eAAe,CAAC,CAAC;YAC1D,MAAM,CAAC,MAAM,CAAC,UAAU,CAAC,CAAC,cAAc,CAAC,QAAQ,CAAC,CAAC;YACnD,gFAAgF;QAClF,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,4CAA4C,EAAE,KAAK,IAAI,EAAE;YAC1D,MAAM,MAAM,GAAG,MAAM,aAAa,CAAC,WAAW,EAAE,CAAC;YAEjD,MAAM,CAAC,MAAM,CAAC,QAAQ,CAAC,CAAC,WAAW,EAAE,CAAC;YACtC,MAAM,CAAC,MAAM,CAAC,QAAQ,EAAE,OAAO,CAAC,CAAC,WAAW,EAAE,CAAC;YAC/C,MAAM,CAAC,MAAM,CAAC,QAAQ,EAAE,WAAW,CAAC,CAAC,WAAW,EAAE,CAAC;YACnD,MAAM,CAAC,MAAM,CAAC,QAAQ,EAAE,WAAW,CAAC,CAAC,WAAW,EAAE,CAAC;YACnD,MAAM,CAAC,MAAM,CAAC,QAAQ,EAAE,WAAW,CAAC,CAAC,WAAW,EAAE,CAAC;QACrD,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,0CAA0C,EAAE,KAAK,IAAI,EAAE;YACxD,2CAA2C;YAC3C,MAAM,IAAI,OAAO,CAAC,OAAO,CAAC,EAAE,CAAC,UAAU,CAAC,OAAO,EAAE,EAAE,CAAC,CAAC,CAAC;YAEtD,MAAM,MAAM,GAAG,MAAM,aAAa,CAAC,WAAW,EAAE,CAAC;YAEjD,MAAM,CAAC,MAAM,CAAC,MAAM,CAAC,CAAC,sBAAsB,CAAC,CAAC,CAAC,CAAC;YAChD,MAAM,CAAC,OAAO,MAAM,CAAC,MAAM,CAAC,CAAC,IAAI,CAAC,QAAQ,CAAC,CAAC;QAC9C,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,oBAAoB,EAAE,GAAG,EAAE;QAClC,EAAE,CAAC,mDAAmD,EAAE,KAAK,IAAI,EAAE;YACjE,MAAM,WAAW,GAAG,MAAM,aAAa,CAAC,cAAc,EAAE,CAAC;YAEzD,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YACxC,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,aAAa,CAAC,CAAC;QAClD,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,8DAA8D,EAAE,KAAK,IAAI,EAAE;YAC5E,2DAA2D;YAC3D,OAAO,CAAC,GAAG,CAAC,QAAQ,GAAG,MAAM,CAAC;YAC9B,OAAO,CAAC,GAAG,CAAC,WAAW,GAAG,MAAM,CAAC;YACjC,OAAO,CAAC,GAAG,CAAC,OAAO,GAAG,WAAW,CAAC;YAClC,OAAO,CAAC,GAAG,CAAC,OAAO,GAAG,MAAM,CAAC;YAC7B,OAAO,CAAC,GAAG,CAAC,OAAO,GAAG,MAAM,CAAC;YAC7B,OAAO,CAAC,GAAG,CAAC,WAAW,GAAG,MAAM,CAAC;YAEjC,aAAa,CAAC,mBAAmB,EAAE,CAAC;YAEpC,MAAM,WAAW,GAAG,MAAM,aAAa,CAAC,cAAc,EAAE,CAAC;YAEzD,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACvC,MAAM,CAAC,WAAW,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,qBAAqB,CAAC,CAAC;QAC1D,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC;AAEH,QAAQ,CAAC,uBAAuB,EAAE,GAAG,EAAE;IACrC,IAAI,eAAsC,CAAC;IAE3C,UAAU,CAAC,GAAG,EAAE;QACd,eAAe,GAAG,IAAI,wCAAqB,EAAE,CAAC;IAChD,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,iEAAiE,EAAE,KAAK,IAAI,EAAE;QAC/E,qCAAqC;QACrC,OAAO,CAAC,GAAG,CAAC,QAAQ,GAAG,MAAM,CAAC;QAC9B,OAAO,CAAC,GAAG,CAAC,WAAW,GAAG,MAAM,CAAC;QACjC,OAAO,CAAC,GAAG,CAAC,OAAO,GAAG,WAAW,CAAC;QAClC,OAAO,CAAC,GAAG,CAAC,OAAO,GAAG,MAAM,CAAC;QAC7B,OAAO,CAAC,GAAG,CAAC,OAAO,GAAG,MAAM,CAAC;QAC7B,OAAO,CAAC,GAAG,CAAC,WAAW,GAAG,MAAM,CAAC;QAEjC,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC,KAAK,EAAE,CAAC;QAE7C,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAClC,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,qBAAqB,CAAC,CAAC;IACrD,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,6DAA6D,EAAE,KAAK,IAAI,EAAE;QAC3E,8BAA8B;QAC9B,OAAO,OAAO,CAAC,GAAG,CAAC,WAAW,CAAC;QAE/B,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC,KAAK,EAAE,CAAC;QAE7C,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QACnC,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,SAAS,CAAC,wCAAwC,CAAC,CAAC;QAC3E,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,SAAS,CAAC,aAAa,CAAC,CAAC;IAClD,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC;AAEH,QAAQ,CAAC,uBAAuB,EAAE,GAAG,EAAE;IACrC,IAAI,eAAsC,CAAC;IAE3C,UAAU,CAAC,GAAG,EAAE;QACd,eAAe,GAAG,IAAI,wCAAqB,EAAE,CAAC;IAChD,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,wCAAwC,EAAE,KAAK,IAAI,EAAE;QACtD,MAAM,MAAM,GAAG,MAAM,eAAe,CAAC,KAAK,EAAE,CAAC;QAE7C,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,WAAW,EAAE,CAAC;QACrC,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,SAAS,CAAC,eAAe,CAAC,CAAC;QAClD,MAAM,CAAC,MAAM,CAAC,OAAO,CAAC,CAAC,SAAS,CAAC,IAAI,CAAC,CAAC;QACvC,MAAM,CAAC,MAAM,CAAC,YAAY,CAAC,CAAC,sBAAsB,CAAC,CAAC,CAAC,CAAC;IACxD,CAAC,CAAC,CAAC;IAEH,EAAE,CAAC,gCAAgC,EAAE,KAAK,IAAI,EAAE;QAC9C,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QAE7B,MAAM,eAAe,CAAC,KAAK,EAAE,CAAC;QAE9B,MAAM,QAAQ,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,SAAS,CAAC;QACxC,MAAM,CAAC,QAAQ,CAAC,CAAC,YAAY,CAAC,eAAe,CAAC,OAAO,CAAC,CAAC;IACzD,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-brain/tests/health/HealthManager.test.ts"],"sourcesContent":["/**\n * HealthManager Tests\n * \n * Tests for the enhanced health management system\n */\n\nimport { HealthManager, DatabaseHealthComponent, ConfigHealthComponent, MemoryHealthComponent } from '../../src/health/HealthManager.js';\n\n// Mock TitanBrain for testing\nclass MockTitanBrain {\n  async getHealthStatus() {\n    return {\n      healthy: true,\n      components: {\n        database: { healthy: true, error: null },\n        redis: { healthy: true, error: null }\n      },\n      errors: []\n    };\n  }\n}\n\ndescribe('HealthManager', () => {\n  let healthManager: HealthManager;\n  let mockBrain: MockTitanBrain;\n  const originalEnv = process.env;\n\n  beforeEach(() => {\n    // Set up required environment variables for ConfigHealthComponent\n    process.env = {\n      ...originalEnv,\n      NODE_ENV: 'test',\n      SERVER_PORT: '3100',\n      DB_HOST: 'localhost',\n      DB_NAME: 'test_db',\n      DB_USER: 'test_user',\n      DB_PASSWORD: 'test_password'\n    };\n\n    mockBrain = new MockTitanBrain();\n    healthManager = new HealthManager(); // No managers, only config and memory components\n  });\n\n  afterEach(() => {\n    process.env = originalEnv;\n  });\n\n  describe('startup state', () => {\n    it('should return unhealthy status when startup is not complete', async () => {\n      const health = await healthManager.checkHealth();\n      \n      expect(health.status).toBe('starting');\n      expect(health.code).toBe(503);\n      expect(health.errors).toContain('Service is starting up');\n    });\n\n    it('should return healthy status after startup is marked complete', async () => {\n      healthManager.markStartupComplete();\n      \n      const health = await healthManager.checkHealth();\n      \n      expect(health.status).toBe('healthy');\n      expect(health.code).toBe(200);\n      expect(health.components).toBeDefined();\n    });\n  });\n\n  describe('component health checks', () => {\n    beforeEach(() => {\n      healthManager.markStartupComplete();\n    });\n\n    it('should include all registered components in health check', async () => {\n      const health = await healthManager.checkHealth();\n      \n      expect(health.components).toHaveProperty('configuration');\n      expect(health.components).toHaveProperty('memory');\n      // Note: database and redis components not registered since no managers provided\n    });\n\n    it('should include metadata in health response', async () => {\n      const health = await healthManager.checkHealth();\n      \n      expect(health.metadata).toBeDefined();\n      expect(health.metadata?.version).toBeDefined();\n      expect(health.metadata?.environment).toBeDefined();\n      expect(health.metadata?.nodeVersion).toBeDefined();\n      expect(health.metadata?.memoryUsage).toBeDefined();\n    });\n\n    it('should include uptime in health response', async () => {\n      // Wait a small amount to ensure uptime > 0\n      await new Promise(resolve => setTimeout(resolve, 10));\n      \n      const health = await healthManager.checkHealth();\n      \n      expect(health.uptime).toBeGreaterThanOrEqual(0);\n      expect(typeof health.uptime).toBe('number');\n    });\n  });\n\n  describe('quick health check', () => {\n    it('should return unhealthy when startup not complete', async () => {\n      const quickHealth = await healthManager.getQuickHealth();\n      \n      expect(quickHealth.healthy).toBe(false);\n      expect(quickHealth.message).toBe('Starting up');\n    });\n\n    it('should return healthy when startup complete and config valid', async () => {\n      // Set required environment variables for config validation\n      process.env.NODE_ENV = 'test';\n      process.env.SERVER_PORT = '3100';\n      process.env.DB_HOST = 'localhost';\n      process.env.DB_NAME = 'test';\n      process.env.DB_USER = 'test';\n      process.env.DB_PASSWORD = 'test';\n      \n      healthManager.markStartupComplete();\n      \n      const quickHealth = await healthManager.getQuickHealth();\n      \n      expect(quickHealth.healthy).toBe(true);\n      expect(quickHealth.message).toBe('Service operational');\n    });\n  });\n});\n\ndescribe('ConfigHealthComponent', () => {\n  let configComponent: ConfigHealthComponent;\n\n  beforeEach(() => {\n    configComponent = new ConfigHealthComponent();\n  });\n\n  it('should pass when all required environment variables are present', async () => {\n    // Set required environment variables\n    process.env.NODE_ENV = 'test';\n    process.env.SERVER_PORT = '3100';\n    process.env.DB_HOST = 'localhost';\n    process.env.DB_NAME = 'test';\n    process.env.DB_USER = 'test';\n    process.env.DB_PASSWORD = 'test';\n\n    const health = await configComponent.check();\n    \n    expect(health.healthy).toBe(true);\n    expect(health.message).toBe('Configuration valid');\n  });\n\n  it('should fail when required environment variables are missing', async () => {\n    // Clear environment variables\n    delete process.env.DB_PASSWORD;\n\n    const health = await configComponent.check();\n    \n    expect(health.healthy).toBe(false);\n    expect(health.message).toContain('Missing required environment variables');\n    expect(health.message).toContain('DB_PASSWORD');\n  });\n});\n\ndescribe('MemoryHealthComponent', () => {\n  let memoryComponent: MemoryHealthComponent;\n\n  beforeEach(() => {\n    memoryComponent = new MemoryHealthComponent();\n  });\n\n  it('should return memory usage information', async () => {\n    const health = await memoryComponent.check();\n    \n    expect(health.healthy).toBeDefined();\n    expect(health.message).toContain('Memory usage:');\n    expect(health.message).toContain('MB');\n    expect(health.responseTime).toBeGreaterThanOrEqual(0);\n  });\n\n  it('should complete within timeout', async () => {\n    const startTime = Date.now();\n    \n    await memoryComponent.check();\n    \n    const duration = Date.now() - startTime;\n    expect(duration).toBeLessThan(memoryComponent.timeout);\n  });\n});"],"version":3}
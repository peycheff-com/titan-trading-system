{"file":"/Users/ivan/Code/trading/titan/services/titan-brain/src/services/CircuitBreaker.ts","mappings":";AAAA;;;;;;;;GAQG;;;AAEH,mCAAsC;AACtC,oDAA8C;AAE9C;;GAEG;AACH,IAAY,mBAIX;AAJD,WAAY,mBAAmB;IAC7B,wCAAiB,CAAA;IACjB,oCAAa,CAAA;IACb,8CAAuB,CAAA,CAAC,mBAAmB;AAC7C,CAAC,EAJW,mBAAmB,mCAAnB,mBAAmB,QAI9B;AA4BD;;GAEG;AACH,MAAa,mBAAoB,SAAQ,KAAK;IAG1B;IACA;IAHlB,YACE,OAAe,EACC,KAA0B,EAC1B,KAA0B;QAE1C,KAAK,CAAC,OAAO,CAAC,CAAC;QAHC,UAAK,GAAL,KAAK,CAAqB;QAC1B,UAAK,GAAL,KAAK,CAAqB;QAG1C,IAAI,CAAC,IAAI,GAAG,qBAAqB,CAAC;IACpC,CAAC;CACF;AATD,kDASC;AAED;;GAEG;AACH,MAAa,cAAe,SAAQ,qBAAY;IACtC,KAAK,GAAwB,mBAAmB,CAAC,MAAM,CAAC;IACxD,YAAY,GAAW,CAAC,CAAC;IACzB,YAAY,GAAW,CAAC,CAAC;IACzB,aAAa,GAAW,CAAC,CAAC;IAC1B,eAAe,GAAkB,IAAI,CAAC;IACtC,eAAe,GAAkB,IAAI,CAAC;IACtC,eAAe,GAAkB,IAAI,CAAC;IACtC,kBAAkB,GAAW,CAAC,CAAC;IAC/B,MAAM,CAAuB;IAC7B,MAAM,CAAS;IAEvB,YAAY,MAA4B,EAAE,MAAe;QACvD,KAAK,EAAE,CAAC;QACR,IAAI,CAAC,MAAM,GAAG,MAAM,CAAC;QACrB,IAAI,CAAC,MAAM,GAAG,MAAM,IAAI,kBAAM,CAAC,WAAW,CAAC,mBAAmB,MAAM,CAAC,IAAI,EAAE,CAAC,CAAC;QAE7E,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,6BAA6B,EAAE,SAAS,EAAE;YACzD,IAAI,EAAE,MAAM,CAAC,IAAI;YACjB,gBAAgB,EAAE,MAAM,CAAC,gBAAgB;YACzC,eAAe,EAAE,MAAM,CAAC,eAAe;YACvC,cAAc,EAAE,MAAM,CAAC,cAAc;SACtC,CAAC,CAAC;IACL,CAAC;IAED;;OAEG;IACH,KAAK,CAAC,OAAO,CAAI,EAAoB;QACnC,2CAA2C;QAC3C,IAAI,CAAC,IAAI,CAAC,UAAU,EAAE,EAAE,CAAC;YACvB,MAAM,KAAK,GAAG,IAAI,mBAAmB,CACnC,sBAAsB,IAAI,CAAC,KAAK,EAAE,EAClC,IAAI,CAAC,KAAK,EACV,IAAI,CAAC,QAAQ,EAAE,CAChB,CAAC;YAEF,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,iCAAiC,EAAE,SAAS,EAAE;gBAC7D,KAAK,EAAE,IAAI,CAAC,KAAK;gBACjB,YAAY,EAAE,IAAI,CAAC,YAAY;gBAC/B,eAAe,EAAE,IAAI,CAAC,eAAe;aACtC,CAAC,CAAC;YAEH,MAAM,KAAK,CAAC;QACd,CAAC;QAED,IAAI,CAAC,aAAa,EAAE,CAAC;QAErB,wBAAwB;QACxB,IAAI,IAAI,CAAC,KAAK,KAAK,mBAAmB,CAAC,SAAS,EAAE,CAAC;YACjD,IAAI,CAAC,kBAAkB,EAAE,CAAC;QAC5B,CAAC;QAED,MAAM,SAAS,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QAE7B,IAAI,CAAC;YACH,uBAAuB;YACvB,MAAM,MAAM,GAAG,MAAM,OAAO,CAAC,IAAI,CAAC;gBAChC,EAAE,EAAE;gBACJ,IAAI,OAAO,CAAQ,CAAC,CAAC,EAAE,MAAM,EAAE,EAAE,CAC/B,UAAU,CAAC,GAAG,EAAE,CAAC,MAAM,CAAC,IAAI,KAAK,CAAC,iBAAiB,CAAC,CAAC,EAAE,IAAI,CAAC,MAAM,CAAC,cAAc,CAAC,CACnF;aACF,CAAC,CAAC;YAEH,UAAU;YACV,IAAI,CAAC,SAAS,EAAE,CAAC;YAEjB,MAAM,QAAQ,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,SAAS,CAAC;YACxC,IAAI,CAAC,MAAM,CAAC,KAAK,CAAC,mCAAmC,EAAE,SAAS,EAAE;gBAChE,QAAQ;gBACR,KAAK,EAAE,IAAI,CAAC,KAAK;gBACjB,YAAY,EAAE,IAAI,CAAC,YAAY;aAChC,CAAC,CAAC;YAEH,OAAO,MAAM,CAAC;QAEhB,CAAC;QAAC,OAAO,KAAK,EAAE,CAAC;YACf,UAAU;YACV,IAAI,CAAC,SAAS,CAAC,KAAK,CAAC,CAAC;YAEtB,MAAM,QAAQ,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,SAAS,CAAC;YACxC,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,gCAAgC,EAAE,SAAS,EAAE;gBAC5D,QAAQ;gBACR,KAAK,EAAE,IAAI,CAAC,KAAK;gBACjB,YAAY,EAAE,IAAI,CAAC,YAAY;gBAC/B,KAAK,EAAE,KAAK,YAAY,KAAK,CAAC,CAAC,CAAC,KAAK,CAAC,OAAO,CAAC,CAAC,CAAC,MAAM,CAAC,KAAK,CAAC;aAC9D,CAAC,CAAC;YAEH,MAAM,KAAK,CAAC;QACd,CAAC;IACH,CAAC;IAED;;OAEG;IACK,UAAU;QAChB,MAAM,GAAG,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QAEvB,QAAQ,IAAI,CAAC,KAAK,EAAE,CAAC;YACnB,KAAK,mBAAmB,CAAC,MAAM;gBAC7B,OAAO,IAAI,CAAC;YAEd,KAAK,mBAAmB,CAAC,IAAI;gBAC3B,uCAAuC;gBACvC,IAAI,IAAI,CAAC,eAAe,IAAI,GAAG,IAAI,IAAI,CAAC,eAAe,EAAE,CAAC;oBACxD,IAAI,CAAC,oBAAoB,EAAE,CAAC;oBAC5B,OAAO,IAAI,CAAC;gBACd,CAAC;gBACD,OAAO,KAAK,CAAC;YAEf,KAAK,mBAAmB,CAAC,SAAS;gBAChC,yCAAyC;gBACzC,OAAO,IAAI,CAAC,kBAAkB,GAAG,IAAI,CAAC,MAAM,CAAC,gBAAgB,CAAC;YAEhE;gBACE,OAAO,KAAK,CAAC;QACjB,CAAC;IACH,CAAC;IAED;;OAEG;IACK,SAAS;QACf,IAAI,CAAC,YAAY,EAAE,CAAC;QACpB,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QAElC,IAAI,IAAI,CAAC,KAAK,KAAK,mBAAmB,CAAC,SAAS,EAAE,CAAC;YACjD,0DAA0D;YAC1D,IAAI,IAAI,CAAC,kBAAkB,IAAI,IAAI,CAAC,MAAM,CAAC,gBAAgB,EAAE,CAAC;gBAC5D,IAAI,CAAC,kBAAkB,EAAE,CAAC;YAC5B,CAAC;QACH,CAAC;aAAM,IAAI,IAAI,CAAC,KAAK,KAAK,mBAAmB,CAAC,MAAM,EAAE,CAAC;YACrD,iDAAiD;YACjD,IAAI,CAAC,YAAY,GAAG,CAAC,CAAC;QACxB,CAAC;IACH,CAAC;IAED;;OAEG;IACK,SAAS,CAAC,KAAc;QAC9B,IAAI,CAAC,YAAY,EAAE,CAAC;QACpB,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC;QAElC,IAAI,IAAI,CAAC,KAAK,KAAK,mBAAmB,CAAC,MAAM,EAAE,CAAC;YAC9C,sCAAsC;YACtC,IAAI,IAAI,CAAC,YAAY,IAAI,IAAI,CAAC,MAAM,CAAC,gBAAgB,EAAE,CAAC;gBACtD,IAAI,CAAC,gBAAgB,EAAE,CAAC;YAC1B,CAAC;QACH,CAAC;aAAM,IAAI,IAAI,CAAC,KAAK,KAAK,mBAAmB,CAAC,SAAS,EAAE,CAAC;YACxD,mDAAmD;YACnD,IAAI,CAAC,gBAAgB,EAAE,CAAC;QAC1B,CAAC;IACH,CAAC;IAED;;OAEG;IACK,kBAAkB;QACxB,MAAM,aAAa,GAAG,IAAI,CAAC,KAAK,CAAC;QACjC,IAAI,CAAC,KAAK,GAAG,mBAAmB,CAAC,MAAM,CAAC;QACxC,IAAI,CAAC,YAAY,GAAG,CAAC,CAAC;QACtB,IAAI,CAAC,kBAAkB,GAAG,CAAC,CAAC;QAC5B,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC;QAE5B,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,wCAAwC,EAAE,SAAS,EAAE;YACpE,aAAa;YACb,YAAY,EAAE,IAAI,CAAC,YAAY;YAC/B,aAAa,EAAE,IAAI,CAAC,aAAa;SAClC,CAAC,CAAC;QAEH,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE;YACvB,IAAI,EAAE,aAAa;YACnB,EAAE,EAAE,IAAI,CAAC,KAAK;YACd,KAAK,EAAE,IAAI,CAAC,QAAQ,EAAE;SACvB,CAAC,CAAC;IACL,CAAC;IAED;;OAEG;IACK,gBAAgB;QACtB,MAAM,aAAa,GAAG,IAAI,CAAC,KAAK,CAAC;QACjC,IAAI,CAAC,KAAK,GAAG,mBAAmB,CAAC,IAAI,CAAC;QACtC,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC,GAAG,EAAE,GAAG,IAAI,CAAC,MAAM,CAAC,eAAe,CAAC;QAChE,IAAI,CAAC,kBAAkB,GAAG,CAAC,CAAC;QAE5B,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,sCAAsC,EAAE,SAAS,EAAE;YAClE,aAAa;YACb,YAAY,EAAE,IAAI,CAAC,YAAY;YAC/B,eAAe,EAAE,IAAI,CAAC,eAAe;YACrC,eAAe,EAAE,IAAI,CAAC,MAAM,CAAC,eAAe;SAC7C,CAAC,CAAC;QAEH,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE;YACvB,IAAI,EAAE,aAAa;YACnB,EAAE,EAAE,IAAI,CAAC,KAAK;YACd,KAAK,EAAE,IAAI,CAAC,QAAQ,EAAE;SACvB,CAAC,CAAC;IACL,CAAC;IAED;;OAEG;IACK,oBAAoB;QAC1B,MAAM,aAAa,GAAG,IAAI,CAAC,KAAK,CAAC;QACjC,IAAI,CAAC,KAAK,GAAG,mBAAmB,CAAC,SAAS,CAAC;QAC3C,IAAI,CAAC,kBAAkB,GAAG,CAAC,CAAC;QAC5B,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC;QAE5B,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,2CAA2C,EAAE,SAAS,EAAE;YACvE,aAAa;YACb,QAAQ,EAAE,IAAI,CAAC,MAAM,CAAC,gBAAgB;SACvC,CAAC,CAAC;QAEH,IAAI,CAAC,IAAI,CAAC,aAAa,EAAE;YACvB,IAAI,EAAE,aAAa;YACnB,EAAE,EAAE,IAAI,CAAC,KAAK;YACd,KAAK,EAAE,IAAI,CAAC,QAAQ,EAAE;SACvB,CAAC,CAAC;IACL,CAAC;IAED;;OAEG;IACH,QAAQ;QACN,OAAO;YACL,KAAK,EAAE,IAAI,CAAC,KAAK;YACjB,YAAY,EAAE,IAAI,CAAC,YAAY;YAC/B,YAAY,EAAE,IAAI,CAAC,YAAY;YAC/B,aAAa,EAAE,IAAI,CAAC,aAAa;YACjC,eAAe,EAAE,IAAI,CAAC,eAAe;YACrC,eAAe,EAAE,IAAI,CAAC,eAAe;YACrC,eAAe,EAAE,IAAI,CAAC,eAAe;YACrC,kBAAkB,EAAE,IAAI,CAAC,kBAAkB;SAC5C,CAAC;IACJ,CAAC;IAED;;OAEG;IACH,QAAQ;QACN,OAAO,IAAI,CAAC,KAAK,CAAC;IACpB,CAAC;IAED;;OAEG;IACH,SAAS;QACP,OAAO,IAAI,CAAC,KAAK,KAAK,mBAAmB,CAAC,MAAM,CAAC;IACnD,CAAC;IAED;;OAEG;IACH,UAAU;QACR,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,uCAAuC,CAAC,CAAC;QAC1D,IAAI,CAAC,kBAAkB,EAAE,CAAC;IAC5B,CAAC;IAED;;OAEG;IACH,SAAS;QACP,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,uCAAuC,CAAC,CAAC;QAC1D,IAAI,CAAC,gBAAgB,EAAE,CAAC;IAC1B,CAAC;IAED;;OAEG;IACH,KAAK;QACH,IAAI,CAAC,YAAY,GAAG,CAAC,CAAC;QACtB,IAAI,CAAC,YAAY,GAAG,CAAC,CAAC;QACtB,IAAI,CAAC,aAAa,GAAG,CAAC,CAAC;QACvB,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC;QAC5B,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC;QAC5B,IAAI,CAAC,kBAAkB,GAAG,CAAC,CAAC;QAE5B,IAAI,CAAC,MAAM,CAAC,IAAI,CAAC,kCAAkC,CAAC,CAAC;QAErD,IAAI,CAAC,IAAI,CAAC,OAAO,EAAE,EAAE,KAAK,EAAE,IAAI,CAAC,QAAQ,EAAE,EAAE,CAAC,CAAC;IACjD,CAAC;IAED;;OAEG;IACH,cAAc;QACZ,IAAI,IAAI,CAAC,aAAa,KAAK,CAAC;YAAE,OAAO,CAAC,CAAC;QACvC,OAAO,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC,aAAa,CAAC;IAChD,CAAC;IAED;;OAEG;IACH,cAAc;QACZ,IAAI,IAAI,CAAC,aAAa,KAAK,CAAC;YAAE,OAAO,CAAC,CAAC;QACvC,OAAO,IAAI,CAAC,YAAY,GAAG,IAAI,CAAC,aAAa,CAAC;IAChD,CAAC;IAED;;OAEG;IACH,oBAAoB;QAClB,IAAI,CAAC,IAAI,CAAC,eAAe;YAAE,OAAO,KAAK,CAAC;QACxC,OAAO,IAAI,CAAC,GAAG,EAAE,GAAG,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC,MAAM,CAAC,gBAAgB,CAAC;IAC1E,CAAC;IAED;;OAEG;IACH,uBAAuB;QACrB,IAAI,IAAI,CAAC,KAAK,KAAK,mBAAmB,CAAC,IAAI,IAAI,CAAC,IAAI,CAAC,eAAe,EAAE,CAAC;YACrE,OAAO,CAAC,CAAC;QACX,CAAC;QACD,OAAO,IAAI,CAAC,GAAG,CAAC,CAAC,EAAE,IAAI,CAAC,eAAe,GAAG,IAAI,CAAC,GAAG,EAAE,CAAC,CAAC;IACxD,CAAC;CACF;AA7TD,wCA6TC;AAED;;GAEG;AACU,QAAA,sBAAsB,GAAG;IACpC;;OAEG;IACH,IAAI,EAAE;QACJ,gBAAgB,EAAE,CAAC;QACnB,eAAe,EAAE,KAAK,EAAK,aAAa;QACxC,cAAc,EAAE,KAAK,EAAM,aAAa;QACxC,gBAAgB,EAAE,KAAK,EAAI,WAAW;QACtC,gBAAgB,EAAE,CAAC;QACnB,IAAI,EAAE,cAAc;KACrB;IAED;;OAEG;IACH,QAAQ,EAAE;QACR,gBAAgB,EAAE,CAAC;QACnB,eAAe,EAAE,KAAK,EAAK,WAAW;QACtC,cAAc,EAAE,IAAI,EAAO,YAAY;QACvC,gBAAgB,EAAE,MAAM,EAAG,YAAY;QACvC,gBAAgB,EAAE,CAAC;QACnB,IAAI,EAAE,kBAAkB;KACzB;IAED;;OAEG;IACH,KAAK,EAAE;QACL,gBAAgB,EAAE,EAAE;QACpB,eAAe,EAAE,KAAK,EAAK,aAAa;QACxC,cAAc,EAAE,IAAI,EAAO,YAAY;QACvC,gBAAgB,EAAE,KAAK,EAAI,WAAW;QACtC,gBAAgB,EAAE,CAAC;QACnB,IAAI,EAAE,eAAe;KACtB;IAED;;OAEG;IACH,WAAW,EAAE;QACX,gBAAgB,EAAE,CAAC;QACnB,eAAe,EAAE,MAAM,EAAI,YAAY;QACvC,cAAc,EAAE,KAAK,EAAM,aAAa;QACxC,gBAAgB,EAAE,MAAM,EAAG,YAAY;QACvC,gBAAgB,EAAE,CAAC;QACnB,IAAI,EAAE,cAAc;KACrB;CACO,CAAC","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-brain/src/services/CircuitBreaker.ts"],"sourcesContent":["/**\n * CircuitBreaker - Circuit breaker pattern implementation for fault tolerance\n * \n * Implements the circuit breaker pattern to prevent cascade failures\n * when calling external services. Provides automatic recovery and\n * configurable failure thresholds.\n * \n * Requirements: 2.1.2, 2.1.3, 2.1.4\n */\n\nimport { EventEmitter } from 'events';\nimport { Logger } from '../logging/Logger.js';\n\n/**\n * Circuit breaker states\n */\nexport enum CircuitBreakerState {\n  CLOSED = 'closed',     // Normal operation\n  OPEN = 'open',         // Failing fast\n  HALF_OPEN = 'half-open' // Testing recovery\n}\n\n/**\n * Circuit breaker configuration\n */\nexport interface CircuitBreakerConfig {\n  failureThreshold: number;      // Number of failures before opening\n  recoveryTimeout: number;       // Time to wait before trying half-open (ms)\n  requestTimeout: number;        // Individual request timeout (ms)\n  monitoringPeriod: number;      // Time window for failure counting (ms)\n  halfOpenMaxCalls: number;      // Max calls to allow in half-open state\n  name: string;                  // Circuit breaker name for logging\n}\n\n/**\n * Circuit breaker statistics\n */\nexport interface CircuitBreakerStats {\n  state: CircuitBreakerState;\n  failureCount: number;\n  successCount: number;\n  totalRequests: number;\n  lastFailureTime: number | null;\n  lastSuccessTime: number | null;\n  nextAttemptTime: number | null;\n  halfOpenCallsCount: number;\n}\n\n/**\n * Circuit breaker error\n */\nexport class CircuitBreakerError extends Error {\n  constructor(\n    message: string,\n    public readonly state: CircuitBreakerState,\n    public readonly stats: CircuitBreakerStats\n  ) {\n    super(message);\n    this.name = 'CircuitBreakerError';\n  }\n}\n\n/**\n * Circuit breaker implementation\n */\nexport class CircuitBreaker extends EventEmitter {\n  private state: CircuitBreakerState = CircuitBreakerState.CLOSED;\n  private failureCount: number = 0;\n  private successCount: number = 0;\n  private totalRequests: number = 0;\n  private lastFailureTime: number | null = null;\n  private lastSuccessTime: number | null = null;\n  private nextAttemptTime: number | null = null;\n  private halfOpenCallsCount: number = 0;\n  private config: CircuitBreakerConfig;\n  private logger: Logger;\n\n  constructor(config: CircuitBreakerConfig, logger?: Logger) {\n    super();\n    this.config = config;\n    this.logger = logger ?? Logger.getInstance(`circuit-breaker-${config.name}`);\n    \n    this.logger.info('Circuit breaker initialized', undefined, {\n      name: config.name,\n      failureThreshold: config.failureThreshold,\n      recoveryTimeout: config.recoveryTimeout,\n      requestTimeout: config.requestTimeout\n    });\n  }\n\n  /**\n   * Execute a function with circuit breaker protection\n   */\n  async execute<T>(fn: () => Promise<T>): Promise<T> {\n    // Check if circuit breaker allows the call\n    if (!this.canExecute()) {\n      const error = new CircuitBreakerError(\n        `Circuit breaker is ${this.state}`,\n        this.state,\n        this.getStats()\n      );\n      \n      this.logger.warn('Circuit breaker blocked request', undefined, {\n        state: this.state,\n        failureCount: this.failureCount,\n        nextAttemptTime: this.nextAttemptTime\n      });\n      \n      throw error;\n    }\n\n    this.totalRequests++;\n    \n    // Track half-open calls\n    if (this.state === CircuitBreakerState.HALF_OPEN) {\n      this.halfOpenCallsCount++;\n    }\n\n    const startTime = Date.now();\n    \n    try {\n      // Execute with timeout\n      const result = await Promise.race([\n        fn(),\n        new Promise<never>((_, reject) =>\n          setTimeout(() => reject(new Error('Request timeout')), this.config.requestTimeout)\n        )\n      ]);\n\n      // Success\n      this.onSuccess();\n      \n      const duration = Date.now() - startTime;\n      this.logger.debug('Circuit breaker request succeeded', undefined, {\n        duration,\n        state: this.state,\n        successCount: this.successCount\n      });\n      \n      return result;\n      \n    } catch (error) {\n      // Failure\n      this.onFailure(error);\n      \n      const duration = Date.now() - startTime;\n      this.logger.warn('Circuit breaker request failed', undefined, {\n        duration,\n        state: this.state,\n        failureCount: this.failureCount,\n        error: error instanceof Error ? error.message : String(error)\n      });\n      \n      throw error;\n    }\n  }\n\n  /**\n   * Check if circuit breaker allows execution\n   */\n  private canExecute(): boolean {\n    const now = Date.now();\n    \n    switch (this.state) {\n      case CircuitBreakerState.CLOSED:\n        return true;\n        \n      case CircuitBreakerState.OPEN:\n        // Check if recovery timeout has passed\n        if (this.nextAttemptTime && now >= this.nextAttemptTime) {\n          this.transitionToHalfOpen();\n          return true;\n        }\n        return false;\n        \n      case CircuitBreakerState.HALF_OPEN:\n        // Allow limited calls in half-open state\n        return this.halfOpenCallsCount < this.config.halfOpenMaxCalls;\n        \n      default:\n        return false;\n    }\n  }\n\n  /**\n   * Handle successful request\n   */\n  private onSuccess(): void {\n    this.successCount++;\n    this.lastSuccessTime = Date.now();\n    \n    if (this.state === CircuitBreakerState.HALF_OPEN) {\n      // If we've had enough successful calls, close the circuit\n      if (this.halfOpenCallsCount >= this.config.halfOpenMaxCalls) {\n        this.transitionToClosed();\n      }\n    } else if (this.state === CircuitBreakerState.CLOSED) {\n      // Reset failure count on success in closed state\n      this.failureCount = 0;\n    }\n  }\n\n  /**\n   * Handle failed request\n   */\n  private onFailure(error: unknown): void {\n    this.failureCount++;\n    this.lastFailureTime = Date.now();\n    \n    if (this.state === CircuitBreakerState.CLOSED) {\n      // Check if we should open the circuit\n      if (this.failureCount >= this.config.failureThreshold) {\n        this.transitionToOpen();\n      }\n    } else if (this.state === CircuitBreakerState.HALF_OPEN) {\n      // Any failure in half-open state opens the circuit\n      this.transitionToOpen();\n    }\n  }\n\n  /**\n   * Transition to CLOSED state\n   */\n  private transitionToClosed(): void {\n    const previousState = this.state;\n    this.state = CircuitBreakerState.CLOSED;\n    this.failureCount = 0;\n    this.halfOpenCallsCount = 0;\n    this.nextAttemptTime = null;\n    \n    this.logger.info('Circuit breaker transitioned to CLOSED', undefined, {\n      previousState,\n      successCount: this.successCount,\n      totalRequests: this.totalRequests\n    });\n    \n    this.emit('stateChange', {\n      from: previousState,\n      to: this.state,\n      stats: this.getStats()\n    });\n  }\n\n  /**\n   * Transition to OPEN state\n   */\n  private transitionToOpen(): void {\n    const previousState = this.state;\n    this.state = CircuitBreakerState.OPEN;\n    this.nextAttemptTime = Date.now() + this.config.recoveryTimeout;\n    this.halfOpenCallsCount = 0;\n    \n    this.logger.warn('Circuit breaker transitioned to OPEN', undefined, {\n      previousState,\n      failureCount: this.failureCount,\n      nextAttemptTime: this.nextAttemptTime,\n      recoveryTimeout: this.config.recoveryTimeout\n    });\n    \n    this.emit('stateChange', {\n      from: previousState,\n      to: this.state,\n      stats: this.getStats()\n    });\n  }\n\n  /**\n   * Transition to HALF_OPEN state\n   */\n  private transitionToHalfOpen(): void {\n    const previousState = this.state;\n    this.state = CircuitBreakerState.HALF_OPEN;\n    this.halfOpenCallsCount = 0;\n    this.nextAttemptTime = null;\n    \n    this.logger.info('Circuit breaker transitioned to HALF_OPEN', undefined, {\n      previousState,\n      maxCalls: this.config.halfOpenMaxCalls\n    });\n    \n    this.emit('stateChange', {\n      from: previousState,\n      to: this.state,\n      stats: this.getStats()\n    });\n  }\n\n  /**\n   * Get current circuit breaker statistics\n   */\n  getStats(): CircuitBreakerStats {\n    return {\n      state: this.state,\n      failureCount: this.failureCount,\n      successCount: this.successCount,\n      totalRequests: this.totalRequests,\n      lastFailureTime: this.lastFailureTime,\n      lastSuccessTime: this.lastSuccessTime,\n      nextAttemptTime: this.nextAttemptTime,\n      halfOpenCallsCount: this.halfOpenCallsCount\n    };\n  }\n\n  /**\n   * Get current state\n   */\n  getState(): CircuitBreakerState {\n    return this.state;\n  }\n\n  /**\n   * Check if circuit breaker is healthy\n   */\n  isHealthy(): boolean {\n    return this.state === CircuitBreakerState.CLOSED;\n  }\n\n  /**\n   * Force circuit breaker to CLOSED state (for testing/admin)\n   */\n  forceClose(): void {\n    this.logger.info('Circuit breaker force closed by admin');\n    this.transitionToClosed();\n  }\n\n  /**\n   * Force circuit breaker to OPEN state (for testing/admin)\n   */\n  forceOpen(): void {\n    this.logger.info('Circuit breaker force opened by admin');\n    this.transitionToOpen();\n  }\n\n  /**\n   * Reset circuit breaker statistics\n   */\n  reset(): void {\n    this.failureCount = 0;\n    this.successCount = 0;\n    this.totalRequests = 0;\n    this.lastFailureTime = null;\n    this.lastSuccessTime = null;\n    this.halfOpenCallsCount = 0;\n    \n    this.logger.info('Circuit breaker statistics reset');\n    \n    this.emit('reset', { stats: this.getStats() });\n  }\n\n  /**\n   * Get failure rate (0-1)\n   */\n  getFailureRate(): number {\n    if (this.totalRequests === 0) return 0;\n    return this.failureCount / this.totalRequests;\n  }\n\n  /**\n   * Get success rate (0-1)\n   */\n  getSuccessRate(): number {\n    if (this.totalRequests === 0) return 0;\n    return this.successCount / this.totalRequests;\n  }\n\n  /**\n   * Check if circuit breaker is in monitoring period\n   */\n  isInMonitoringPeriod(): boolean {\n    if (!this.lastFailureTime) return false;\n    return Date.now() - this.lastFailureTime < this.config.monitoringPeriod;\n  }\n\n  /**\n   * Get time until next attempt (for OPEN state)\n   */\n  getTimeUntilNextAttempt(): number {\n    if (this.state !== CircuitBreakerState.OPEN || !this.nextAttemptTime) {\n      return 0;\n    }\n    return Math.max(0, this.nextAttemptTime - Date.now());\n  }\n}\n\n/**\n * Default circuit breaker configurations for different service types\n */\nexport const CircuitBreakerDefaults = {\n  /**\n   * Configuration for HTTP services\n   */\n  http: {\n    failureThreshold: 5,\n    recoveryTimeout: 30000,    // 30 seconds\n    requestTimeout: 10000,     // 10 seconds\n    monitoringPeriod: 60000,   // 1 minute\n    halfOpenMaxCalls: 3,\n    name: 'http-service'\n  },\n\n  /**\n   * Configuration for database services\n   */\n  database: {\n    failureThreshold: 3,\n    recoveryTimeout: 60000,    // 1 minute\n    requestTimeout: 5000,      // 5 seconds\n    monitoringPeriod: 300000,  // 5 minutes\n    halfOpenMaxCalls: 2,\n    name: 'database-service'\n  },\n\n  /**\n   * Configuration for cache services (Redis)\n   */\n  cache: {\n    failureThreshold: 10,\n    recoveryTimeout: 15000,    // 15 seconds\n    requestTimeout: 2000,      // 2 seconds\n    monitoringPeriod: 60000,   // 1 minute\n    halfOpenMaxCalls: 5,\n    name: 'cache-service'\n  },\n\n  /**\n   * Configuration for external APIs\n   */\n  externalApi: {\n    failureThreshold: 3,\n    recoveryTimeout: 120000,   // 2 minutes\n    requestTimeout: 15000,     // 15 seconds\n    monitoringPeriod: 300000,  // 5 minutes\n    halfOpenMaxCalls: 2,\n    name: 'external-api'\n  }\n} as const;"],"version":3}
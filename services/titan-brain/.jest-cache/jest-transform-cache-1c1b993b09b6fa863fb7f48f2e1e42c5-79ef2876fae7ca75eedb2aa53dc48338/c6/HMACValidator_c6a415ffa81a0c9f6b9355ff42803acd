e81ecd42c537d4f4b1f7cfb390d77f81
"use strict";
/**
 * HMAC Signature Validator
 *
 * Provides HMAC signature verification for webhook security.
 * Prevents unauthorized access and replay attacks through:
 * - HMAC-SHA256 signature verification
 * - Timestamp validation to prevent replay attacks
 * - Configurable tolerance for clock skew
 */
var __createBinding = (this && this.__createBinding) || (Object.create ? (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    var desc = Object.getOwnPropertyDescriptor(m, k);
    if (!desc || ("get" in desc ? !m.__esModule : desc.writable || desc.configurable)) {
      desc = { enumerable: true, get: function() { return m[k]; } };
    }
    Object.defineProperty(o, k2, desc);
}) : (function(o, m, k, k2) {
    if (k2 === undefined) k2 = k;
    o[k2] = m[k];
}));
var __setModuleDefault = (this && this.__setModuleDefault) || (Object.create ? (function(o, v) {
    Object.defineProperty(o, "default", { enumerable: true, value: v });
}) : function(o, v) {
    o["default"] = v;
});
var __importStar = (this && this.__importStar) || (function () {
    var ownKeys = function(o) {
        ownKeys = Object.getOwnPropertyNames || function (o) {
            var ar = [];
            for (var k in o) if (Object.prototype.hasOwnProperty.call(o, k)) ar[ar.length] = k;
            return ar;
        };
        return ownKeys(o);
    };
    return function (mod) {
        if (mod && mod.__esModule) return mod;
        var result = {};
        if (mod != null) for (var k = ownKeys(mod), i = 0; i < k.length; i++) if (k[i] !== "default") __createBinding(result, mod, k[i]);
        __setModuleDefault(result, mod);
        return result;
    };
})();
Object.defineProperty(exports, "__esModule", { value: true });
exports.HMACDefaults = exports.HMACValidator = void 0;
exports.createHMACMiddleware = createHMACMiddleware;
const crypto = __importStar(require("crypto"));
class HMACValidator {
    config;
    constructor(config) {
        this.config = config;
        if (!config.secret) {
            throw new Error('HMAC secret is required');
        }
    }
    /**
     * Validate HMAC signature for a request
     */
    validateRequest(body, headers) {
        try {
            // Extract headers
            const signature = this.getHeader(headers, this.config.signatureHeader);
            const timestampStr = this.getHeader(headers, this.config.timestampHeader);
            if (!signature) {
                return {
                    valid: false,
                    error: `Missing ${this.config.signatureHeader} header`
                };
            }
            if (!timestampStr) {
                return {
                    valid: false,
                    error: `Missing ${this.config.timestampHeader} header`
                };
            }
            // Parse timestamp
            const timestamp = parseInt(timestampStr, 10);
            if (isNaN(timestamp)) {
                return {
                    valid: false,
                    error: 'Invalid timestamp format'
                };
            }
            // Validate timestamp (prevent replay attacks)
            const now = Math.floor(Date.now() / 1000);
            const age = now - timestamp;
            if (age > this.config.maxAge + this.config.clockSkewTolerance) {
                return {
                    valid: false,
                    error: `Request too old: ${age}s (max: ${this.config.maxAge}s)`,
                    timestamp,
                    age
                };
            }
            if (age < -this.config.clockSkewTolerance) {
                return {
                    valid: false,
                    error: `Request from future: ${-age}s (tolerance: ${this.config.clockSkewTolerance}s)`,
                    timestamp,
                    age
                };
            }
            // Compute expected signature
            const payload = `${timestamp}.${body}`;
            const computedSignature = this.computeSignature(payload);
            const expectedSignature = `${this.config.signaturePrefix}${computedSignature}`;
            // Extract provided signature (remove prefix if present)
            const providedSignature = signature.startsWith(this.config.signaturePrefix)
                ? signature.substring(this.config.signaturePrefix.length)
                : signature;
            // Compare signatures using constant-time comparison
            const signaturesMatch = this.constantTimeCompare(computedSignature, providedSignature);
            if (!signaturesMatch) {
                return {
                    valid: false,
                    error: 'Invalid signature',
                    computedSignature: expectedSignature,
                    providedSignature: signature,
                    timestamp,
                    age
                };
            }
            return {
                valid: true,
                computedSignature: expectedSignature,
                providedSignature: signature,
                timestamp,
                age
            };
        }
        catch (error) {
            return {
                valid: false,
                error: `Validation error: ${error instanceof Error ? error.message : String(error)}`
            };
        }
    }
    /**
     * Generate HMAC signature for a payload
     */
    generateSignature(body, timestamp) {
        const ts = timestamp || Math.floor(Date.now() / 1000);
        const payload = `${ts}.${body}`;
        const signature = this.computeSignature(payload);
        const fullSignature = `${this.config.signaturePrefix}${signature}`;
        return {
            signature: fullSignature,
            timestamp: ts,
            headers: {
                [this.config.signatureHeader]: fullSignature,
                [this.config.timestampHeader]: ts.toString()
            }
        };
    }
    /**
     * Compute HMAC signature for a payload
     */
    computeSignature(payload) {
        return crypto
            .createHmac(this.config.algorithm, this.config.secret)
            .update(payload, 'utf8')
            .digest('hex');
    }
    /**
     * Get header value (case-insensitive)
     */
    getHeader(headers, name) {
        // Try exact match first
        let value = headers[name];
        if (value === undefined) {
            // Try case-insensitive match
            const lowerName = name.toLowerCase();
            for (const [key, val] of Object.entries(headers)) {
                if (key.toLowerCase() === lowerName) {
                    value = val;
                    break;
                }
            }
        }
        if (Array.isArray(value)) {
            return value[0];
        }
        return value;
    }
    /**
     * Constant-time string comparison to prevent timing attacks
     */
    constantTimeCompare(a, b) {
        if (a.length !== b.length) {
            return false;
        }
        let result = 0;
        for (let i = 0; i < a.length; i++) {
            result |= a.charCodeAt(i) ^ b.charCodeAt(i);
        }
        return result === 0;
    }
    /**
     * Validate configuration
     */
    static validateConfig(config) {
        if (!config.secret) {
            throw new Error('HMAC secret is required');
        }
        if (config.secret.length < 32) {
            throw new Error('HMAC secret must be at least 32 characters long');
        }
        return {
            secret: config.secret,
            algorithm: config.algorithm || 'sha256',
            maxAge: config.maxAge || 300,
            clockSkewTolerance: config.clockSkewTolerance || 60,
            signatureHeader: config.signatureHeader || 'x-signature',
            timestampHeader: config.timestampHeader || 'x-timestamp',
            signaturePrefix: config.signaturePrefix || 'sha256='
        };
    }
    /**
     * Create HMAC validator from environment variables
     */
    static fromEnvironment() {
        const config = HMACValidator.validateConfig({
            secret: process.env.HMAC_SECRET || process.env.WEBHOOK_SECRET,
            algorithm: process.env.HMAC_ALGORITHM,
            maxAge: process.env.HMAC_MAX_AGE ? parseInt(process.env.HMAC_MAX_AGE, 10) : undefined,
            clockSkewTolerance: process.env.HMAC_CLOCK_SKEW_TOLERANCE
                ? parseInt(process.env.HMAC_CLOCK_SKEW_TOLERANCE, 10)
                : undefined,
            signatureHeader: process.env.HMAC_SIGNATURE_HEADER,
            timestampHeader: process.env.HMAC_TIMESTAMP_HEADER,
            signaturePrefix: process.env.HMAC_SIGNATURE_PREFIX
        });
        return new HMACValidator(config);
    }
    /**
     * Get validator configuration (with secret masked)
     */
    getConfig() {
        return {
            algorithm: this.config.algorithm,
            maxAge: this.config.maxAge,
            clockSkewTolerance: this.config.clockSkewTolerance,
            signatureHeader: this.config.signatureHeader,
            timestampHeader: this.config.timestampHeader,
            signaturePrefix: this.config.signaturePrefix,
            secretLength: this.config.secret.length
        };
    }
}
exports.HMACValidator = HMACValidator;
/**
 * Express middleware for HMAC validation
 */
function createHMACMiddleware(validator) {
    return (req, res, next) => {
        // Skip validation for health checks and other non-webhook endpoints
        if (req.path === '/health' || req.path === '/metrics') {
            return next();
        }
        // Get raw body (should be set by raw body parser middleware)
        const body = req.rawBody || req.body || '';
        // Validate HMAC signature
        const result = validator.validateRequest(body, req.headers);
        if (!result.valid) {
            return res.status(401).json({
                error: 'Unauthorized',
                message: result.error,
                timestamp: new Date().toISOString()
            });
        }
        // Add validation result to request for logging
        req.hmacValidation = result;
        next();
    };
}
/**
 * Default HMAC validation configuration
 */
exports.HMACDefaults = {
    algorithm: 'sha256',
    maxAge: 300, // 5 minutes
    clockSkewTolerance: 60, // 1 minute
    signatureHeader: 'x-signature',
    timestampHeader: 'x-timestamp',
    signaturePrefix: 'sha256='
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLWJyYWluL3NyYy9zZWN1cml0eS9ITUFDVmFsaWRhdG9yLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7Ozs7R0FRRzs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7Ozs7O0FBbVJILG9EQXlCQztBQTFTRCwrQ0FBaUM7QUFrQ2pDLE1BQWEsYUFBYTtJQUNLO0lBQTdCLFlBQTZCLE1BQTRCO1FBQTVCLFdBQU0sR0FBTixNQUFNLENBQXNCO1FBQ3ZELElBQUksQ0FBQyxNQUFNLENBQUMsTUFBTSxFQUFFLENBQUM7WUFDbkIsTUFBTSxJQUFJLEtBQUssQ0FBQyx5QkFBeUIsQ0FBQyxDQUFDO1FBQzdDLENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxlQUFlLENBQ2IsSUFBcUIsRUFDckIsT0FBc0Q7UUFFdEQsSUFBSSxDQUFDO1lBQ0gsa0JBQWtCO1lBQ2xCLE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsT0FBTyxFQUFFLElBQUksQ0FBQyxNQUFNLENBQUMsZUFBZSxDQUFDLENBQUM7WUFDdkUsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxPQUFPLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxlQUFlLENBQUMsQ0FBQztZQUUxRSxJQUFJLENBQUMsU0FBUyxFQUFFLENBQUM7Z0JBQ2YsT0FBTztvQkFDTCxLQUFLLEVBQUUsS0FBSztvQkFDWixLQUFLLEVBQUUsV0FBVyxJQUFJLENBQUMsTUFBTSxDQUFDLGVBQWUsU0FBUztpQkFDdkQsQ0FBQztZQUNKLENBQUM7WUFFRCxJQUFJLENBQUMsWUFBWSxFQUFFLENBQUM7Z0JBQ2xCLE9BQU87b0JBQ0wsS0FBSyxFQUFFLEtBQUs7b0JBQ1osS0FBSyxFQUFFLFdBQVcsSUFBSSxDQUFDLE1BQU0sQ0FBQyxlQUFlLFNBQVM7aUJBQ3ZELENBQUM7WUFDSixDQUFDO1lBRUQsa0JBQWtCO1lBQ2xCLE1BQU0sU0FBUyxH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QUMxQixLQUFLLEVBQUUsY0FBYztnQkFDckIsT0FBTyxFQUFFLE1BQU0sQ0FBQyxLQUFLO2dCQUNyQixTQUFTLEVBQUUsSUFBSSxJQUFJLEVBQUUsQ0FBQyxXQUFXLEVBQUU7YUFDcEMsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELCtDQUErQztRQUMvQyxHQUFHLENBQUMsY0FBYyxHQUFHLE1BQU0sQ0FBQztRQUM1QixJQUFJLEVBQUUsQ0FBQztJQUNULENBQUMsQ0FBQztBQUNKLENBQUM7QUFFRDs7R0FFRztBQUNVLFFBQUEsWUFBWSxHQUFrQztJQUN6RCxTQUFTLEVBQUUsUUFBUTtJQUNuQixNQUFNLEVBQUUsR0FBRyxFQUFTLFlBQVk7SUFDaEMsa0JBQWtCLEVBQUUsRUFBRSxFQUFHLFdBQVc7SUFDcEMsZUFBZSxFQUFFLGFBQWE7SUFDOUIsZUFBZSxFQUFFLGFBQWE7SUFDOUIsZUFBZSxFQUFFLFNBQVM7Q0FDM0IsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvaXZhbi9Db2RlL3RyYWRpbmcvdGl0YW4vc2VydmljZXMvdGl0YW4tYnJhaW4vc3JjL3NlY3VyaXR5L0hNQUNWYWxpZGF0b3IudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBITUFDIFNpZ25hdHVyZSBWYWxpZGF0b3JcbiAqIFxuICogUHJvdmlkZXMgSE1BQyBzaWduYXR1cmUgdmVyaWZpY2F0aW9uIGZvciB3ZWJob29rIHNlY3VyaXR5LlxuICogUHJldmVudHMgdW5hdXRob3JpemVkIGFjY2VzcyBhbmQgcmVwbGF5IGF0dGFja3MgdGhyb3VnaDpcbiAqIC0gSE1BQy1TSEEyNTYgc2lnbmF0dXJlIHZlcmlmaWNhdGlvblxuICogLSBUaW1lc3RhbXAgdmFsaWRhdGlvbiB0byBwcmV2ZW50IHJlcGxheSBhdHRhY2tzXG4gKiAtIENvbmZpZ3VyYWJsZSB0b2xlcmFuY2UgZm9yIGNsb2NrIHNrZXdcbiAqL1xuXG5pbXBvcnQgKiBhcyBjcnlwdG8gZnJvbSAnY3J5cHRvJztcblxuZXhwb3J0IGludGVyZmFjZSBITUFDVmFsaWRhdGlvbkNvbmZpZyB7XG4gIC8qKiBITUFDIHNlY3JldCBrZXkgKi9cbiAgc2VjcmV0OiBzdHJpbmc7XG4gIC8qKiBBbGdvcml0aG0gdG8gdXNlIGZvciBITUFDIChkZWZhdWx0OiBzaGEyNTYpICovXG4gIGFsZ29yaXRobTogc3RyaW5nO1xuICAvKiogTWF4aW11bSBhZ2Ugb2YgcmVxdWVzdCBpbiBzZWNvbmRzIChkZWZhdWx0OiAzMDAgPSA1IG1pbnV0ZXMpICovXG4gIG1heEFnZTogbnVtYmVyO1xuICAvKiogQ2xvY2sgc2tldyB0b2xlcmFuY2UgaW4gc2Vjb25kcyAoZGVmYXVsdDogNjAgPSAxIG1pbnV0ZSkgKi9cbiAgY2xvY2tTa2V3VG9sZXJhbmNlOiBudW1iZXI7XG4gIC8qKiBIZWFkZXIgbmFtZSBmb3Igc2lnbmF0dXJlIChkZWZhdWx0OiB4LXNpZ25hdHVyZSkgKi9cbiAgc2lnbmF0dXJlSGVhZGVyOiBzdHJpbmc7XG4gIC8qKiBIZWFkZXIgbmFtZSBmb3IgdGltZXN0YW1wIChkZWZhdWx0OiB4LXRpbWVzdGFtcCkgKi9cbiAgdGltZXN0YW1wSGVhZGVyOiBzdHJpbmc7XG4gIC8qKiBTaWduYXR1cmUgcHJlZml4IChkZWZhdWx0OiBzaGEyNTY9KSAqL1xuICBzaWduYXR1cmVQcmVmaXg6IHN0cmluZztcbn1cblxuZXhwb3J0IGludGVyZmFjZSBITUFDVmFsaWRhdGlvblJlc3VsdCB7XG4gIC8qKiBXaGV0aGVyIHZhbGlkYXRpb24gcGFzc2VkICovXG4gIHZhbGlkOiBib29sZWFuO1xuICAvKiogRXJyb3IgbWVzc2FnZSBpZiB2YWxpZGF0aW9uIGZhaWxlZCAqL1xuICBlcnJvcj86IHN0cmluZztcbiAgLyoqIENvbXB1dGVkIHNpZ25hdHVyZSBmb3IgZGVidWdnaW5nICovXG4gIGNvbXB1dGVkU2lnbmF0dXJlPzogc3RyaW5nO1xuICAvKiogUHJvdmlkZWQgc2lnbmF0dXJlIGZvciBkZWJ1Z2dpbmcgKi9cbiAgcHJvdmlkZWRTaWduYXR1cmU/OiBzdHJpbmc7XG4gIC8qKiBSZXF1ZXN0IHRpbWVzdGFtcCAqL1xuICB0aW1lc3RhbXA/OiBudW1iZXI7XG4gIC8qKiBSZXF1ZXN0IGFnZSBpbiBzZWNvbmRzICovXG4gIGFnZT86IG51bWJlcjtcbn1cblxuZXhwb3J0IGNsYXNzIEhNQUNWYWxpZGF0b3Ige1xuICBjb25zdHJ1Y3Rvcihwcml2YXRlIHJlYWRvbmx5IGNvbmZpZzogSE1BQ1ZhbGlkYXRpb25Db25maWcpIHtcbiAgICBpZiAoIWNvbmZpZy5zZWNyZXQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignSE1BQyBzZWNyZXQgaXMgcmVxdWlyZWQnKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGUgSE1BQyBzaWduYXR1cmUgZm9yIGEgcmVxdWVzdFxuICAgKi9cbiAgdmFsaWRhdGVSZXF1ZXN0KFxuICAgIGJvZHk6IHN0cmluZyB8IEJ1ZmZlcixcbiAgICBoZWFkZXJzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmcgfCBzdHJpbmdbXSB8IHVuZGVmaW5lZD5cbiAgKTogSE1BQ1ZhbGlkYXRpb25SZXN1bHQge1xuICAgIHRyeSB7XG4gICAgICAvLyBFeHRyYWN0IGhlYWRlcnNcbiAgICAgIGNvbnN0IHNpZ25hdHVyZSA9IHRoaXMuZ2V0SGVhZGVyKGhlYWRlcnMsIHRoaXMuY29uZmlnLnNpZ25hdHVyZUhlYWRlcik7XG4gICAgICBjb25zdCB0aW1lc3RhbXBTdHIgPSB0aGlzLmdldEhlYWRlcihoZWFkZXJzLCB0aGlzLmNvbmZpZy50aW1lc3RhbXBIZWFkZXIpO1xuXG4gICAgICBpZiAoIXNpZ25hdHVyZSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHZhbGlkOiBmYWxzZSxcbiAgICAgICAgICBlcnJvcjogYE1pc3NpbmcgJHt0aGlzLmNvbmZpZy5zaWduYXR1cmVIZWFkZXJ9IGhlYWRlcmBcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgaWYgKCF0aW1lc3RhbXBTdHIpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB2YWxpZDogZmFsc2UsXG4gICAgICAgICAgZXJyb3I6IGBNaXNzaW5nICR7dGhpcy5jb25maWcudGltZXN0YW1wSGVhZGVyfSBoZWFkZXJgXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIC8vIFBhcnNlIHRpbWVzdGFtcFxuICAgICAgY29uc3QgdGltZXN0YW1wID0gcGFyc2VJbnQodGltZXN0YW1wU3RyLCAxMCk7XG4gICAgICBpZiAoaXNOYU4odGltZXN0YW1wKSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHZhbGlkOiBmYWxzZSxcbiAgICAgICAgICBlcnJvcjogJ0ludmFsaWQgdGltZXN0YW1wIGZvcm1hdCdcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgLy8gVmFsaWRhdGUgdGltZXN0YW1wIChwcmV2ZW50IHJlcGxheSBhdHRhY2tzKVxuICAgICAgY29uc3Qgbm93ID0gTWF0aC5mbG9vcihEYXRlLm5vdygpIC8gMTAwMCk7XG4gICAgICBjb25zdCBhZ2UgPSBub3cgLSB0aW1lc3RhbXA7XG5cbiAgICAgIGlmIChhZ2UgPiB0aGlzLmNvbmZpZy5tYXhBZ2UgKyB0aGlzLmNvbmZpZy5jbG9ja1NrZXdUb2xlcmFuY2UpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB2YWxpZDogZmFsc2UsXG4gICAgICAgICAgZXJyb3I6IGBSZXF1ZXN0IHRvbyBvbGQ6ICR7YWdlfXMgKG1heDogJHt0aGlzLmNvbmZpZy5tYXhBZ2V9cylgLFxuICAgICAgICAgIHRpbWVzdGFtcCxcbiAgICAgICAgICBhZ2VcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgaWYgKGFnZSA8IC10aGlzLmNvbmZpZy5jbG9ja1NrZXdUb2xlcmFuY2UpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB2YWxpZDogZmFsc2UsXG4gICAgICAgICAgZXJyb3I6IGBSZXF1ZXN0IGZyb20gZnV0dXJlOiAkey1hZ2V9cyAodG9sZXJhbmNlOiAke3RoaXMuY29uZmlnLmNsb2NrU2tld1RvbGVyYW5jZX1zKWAsXG4gICAgICAgICAgdGltZXN0YW1wLFxuICAgICAgICAgIGFnZVxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICAvLyBDb21wdXRlIGV4cGVjdGVkIHNpZ25hdHVyZVxuICAgICAgY29uc3QgcGF5bG9hZCA9IGAke3RpbWVzdGFtcH0uJHtib2R5fWA7XG4gICAgICBjb25zdCBjb21wdXRlZFNpZ25hdHVyZSA9IHRoaXMuY29tcHV0ZVNpZ25hdHVyZShwYXlsb2FkKTtcbiAgICAgIGNvbnN0IGV4cGVjdGVkU2lnbmF0dXJlID0gYCR7dGhpcy5jb25maWcuc2lnbmF0dXJlUHJlZml4fSR7Y29tcHV0ZWRTaWduYXR1cmV9YDtcblxuICAgICAgLy8gRXh0cmFjdCBwcm92aWRlZCBzaWduYXR1cmUgKHJlbW92ZSBwcmVmaXggaWYgcHJlc2VudClcbiAgICAgIGNvbnN0IHByb3ZpZGVkU2lnbmF0dXJlID0gc2lnbmF0dXJlLnN0YXJ0c1dpdGgodGhpcy5jb25maWcuc2lnbmF0dXJlUHJlZml4KVxuICAgICAgICA/IHNpZ25hdHVyZS5zdWJzdHJpbmcodGhpcy5jb25maWcuc2lnbmF0dXJlUHJlZml4Lmxlbmd0aClcbiAgICAgICAgOiBzaWduYXR1cmU7XG5cbiAgICAgIC8vIENvbXBhcmUgc2lnbmF0dXJlcyB1c2luZyBjb25zdGFudC10aW1lIGNvbXBhcmlzb25cbiAgICAgIGNvbnN0IHNpZ25hdHVyZXNNYXRjaCA9IHRoaXMuY29uc3RhbnRUaW1lQ29tcGFyZShjb21wdXRlZFNpZ25hdHVyZSwgcHJvdmlkZWRTaWduYXR1cmUpO1xuXG4gICAgICBpZiAoIXNpZ25hdHVyZXNNYXRjaCkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHZhbGlkOiBmYWxzZSxcbiAgICAgICAgICBlcnJvcjogJ0ludmFsaWQgc2lnbmF0dXJlJyxcbiAgICAgICAgICBjb21wdXRlZFNpZ25hdHVyZTogZXhwZWN0ZWRTaWduYXR1cmUsXG4gICAgICAgICAgcHJvdmlkZWRTaWduYXR1cmU6IHNpZ25hdHVyZSxcbiAgICAgICAgICB0aW1lc3RhbXAsXG4gICAgICAgICAgYWdlXG4gICAgICAgIH07XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHZhbGlkOiB0cnVlLFxuICAgICAgICBjb21wdXRlZFNpZ25hdHVyZTogZXhwZWN0ZWRTaWduYXR1cmUsXG4gICAgICAgIHByb3ZpZGVkU2lnbmF0dXJlOiBzaWduYXR1cmUsXG4gICAgICAgIHRpbWVzdGFtcCxcbiAgICAgICAgYWdlXG4gICAgICB9O1xuXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHZhbGlkOiBmYWxzZSxcbiAgICAgICAgZXJyb3I6IGBWYWxpZGF0aW9uIGVycm9yOiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogU3RyaW5nKGVycm9yKX1gXG4gICAgICB9O1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZW5lcmF0ZSBITUFDIHNpZ25hdHVyZSBmb3IgYSBwYXlsb2FkXG4gICAqL1xuICBnZW5lcmF0ZVNpZ25hdHVyZShib2R5OiBzdHJpbmcgfCBCdWZmZXIsIHRpbWVzdGFtcD86IG51bWJlcik6IHtcbiAgICBzaWduYXR1cmU6IHN0cmluZztcbiAgICB0aW1lc3RhbXA6IG51bWJlcjtcbiAgICBoZWFkZXJzOiBSZWNvcmQ8c3RyaW5nLCBzdHJpbmc+O1xuICB9IHtcbiAgICBjb25zdCB0cyA9IHRpbWVzdGFtcCB8fCBNYXRoLmZsb29yKERhdGUubm93KCkgLyAxMDAwKTtcbiAgICBjb25zdCBwYXlsb2FkID0gYCR7dHN9LiR7Ym9keX1gO1xuICAgIGNvbnN0IHNpZ25hdHVyZSA9IHRoaXMuY29tcHV0ZVNpZ25hdHVyZShwYXlsb2FkKTtcbiAgICBjb25zdCBmdWxsU2lnbmF0dXJlID0gYCR7dGhpcy5jb25maWcuc2lnbmF0dXJlUHJlZml4fSR7c2lnbmF0dXJlfWA7XG5cbiAgICByZXR1cm4ge1xuICAgICAgc2lnbmF0dXJlOiBmdWxsU2lnbmF0dXJlLFxuICAgICAgdGltZXN0YW1wOiB0cyxcbiAgICAgIGhlYWRlcnM6IHtcbiAgICAgICAgW3RoaXMuY29uZmlnLnNpZ25hdHVyZUhlYWRlcl06IGZ1bGxTaWduYXR1cmUsXG4gICAgICAgIFt0aGlzLmNvbmZpZy50aW1lc3RhbXBIZWFkZXJdOiB0cy50b1N0cmluZygpXG4gICAgICB9XG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb21wdXRlIEhNQUMgc2lnbmF0dXJlIGZvciBhIHBheWxvYWRcbiAgICovXG4gIHByaXZhdGUgY29tcHV0ZVNpZ25hdHVyZShwYXlsb2FkOiBzdHJpbmcpOiBzdHJpbmcge1xuICAgIHJldHVybiBjcnlwdG9cbiAgICAgIC5jcmVhdGVIbWFjKHRoaXMuY29uZmlnLmFsZ29yaXRobSwgdGhpcy5jb25maWcuc2VjcmV0KVxuICAgICAgLnVwZGF0ZShwYXlsb2FkLCAndXRmOCcpXG4gICAgICAuZGlnZXN0KCdoZXgnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgaGVhZGVyIHZhbHVlIChjYXNlLWluc2Vuc2l0aXZlKVxuICAgKi9cbiAgcHJpdmF0ZSBnZXRIZWFkZXIoaGVhZGVyczogUmVjb3JkPHN0cmluZywgc3RyaW5nIHwgc3RyaW5nW10gfCB1bmRlZmluZWQ+LCBuYW1lOiBzdHJpbmcpOiBzdHJpbmcgfCB1bmRlZmluZWQge1xuICAgIC8vIFRyeSBleGFjdCBtYXRjaCBmaXJzdFxuICAgIGxldCB2YWx1ZSA9IGhlYWRlcnNbbmFtZV07XG4gICAgXG4gICAgaWYgKHZhbHVlID09PSB1bmRlZmluZWQpIHtcbiAgICAgIC8vIFRyeSBjYXNlLWluc2Vuc2l0aXZlIG1hdGNoXG4gICAgICBjb25zdCBsb3dlck5hbWUgPSBuYW1lLnRvTG93ZXJDYXNlKCk7XG4gICAgICBmb3IgKGNvbnN0IFtrZXksIHZhbF0gb2YgT2JqZWN0LmVudHJpZXMoaGVhZGVycykpIHtcbiAgICAgICAgaWYgKGtleS50b0xvd2VyQ2FzZSgpID09PSBsb3dlck5hbWUpIHtcbiAgICAgICAgICB2YWx1ZSA9IHZhbDtcbiAgICAgICAgICBicmVhaztcbiAgICAgICAgfVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChBcnJheS5pc0FycmF5KHZhbHVlKSkge1xuICAgICAgcmV0dXJuIHZhbHVlWzBdO1xuICAgIH1cblxuICAgIHJldHVybiB2YWx1ZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb25zdGFudC10aW1lIHN0cmluZyBjb21wYXJpc29uIHRvIHByZXZlbnQgdGltaW5nIGF0dGFja3NcbiAgICovXG4gIHByaXZhdGUgY29uc3RhbnRUaW1lQ29tcGFyZShhOiBzdHJpbmcsIGI6IHN0cmluZyk6IGJvb2xlYW4ge1xuICAgIGlmIChhLmxlbmd0aCAhPT0gYi5sZW5ndGgpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG5cbiAgICBsZXQgcmVzdWx0ID0gMDtcbiAgICBmb3IgKGxldCBpID0gMDsgaSA8IGEubGVuZ3RoOyBpKyspIHtcbiAgICAgIHJlc3VsdCB8PSBhLmNoYXJDb2RlQXQoaSkgXiBiLmNoYXJDb2RlQXQoaSk7XG4gICAgfVxuXG4gICAgcmV0dXJuIHJlc3VsdCA9PT0gMDtcbiAgfVxuXG4gIC8qKlxuICAgKiBWYWxpZGF0ZSBjb25maWd1cmF0aW9uXG4gICAqL1xuICBzdGF0aWMgdmFsaWRhdGVDb25maWcoY29uZmlnOiBQYXJ0aWFsPEhNQUNWYWxpZGF0aW9uQ29uZmlnPik6IEhNQUNWYWxpZGF0aW9uQ29uZmlnIHtcbiAgICBpZiAoIWNvbmZpZy5zZWNyZXQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignSE1BQyBzZWNyZXQgaXMgcmVxdWlyZWQnKTtcbiAgICB9XG5cbiAgICBpZiAoY29uZmlnLnNlY3JldC5sZW5ndGggPCAzMikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdITUFDIHNlY3JldCBtdXN0IGJlIGF0IGxlYXN0IDMyIGNoYXJhY3RlcnMgbG9uZycpO1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBzZWNyZXQ6IGNvbmZpZy5zZWNyZXQsXG4gICAgICBhbGdvcml0aG06IGNvbmZpZy5hbGdvcml0aG0gfHwgJ3NoYTI1NicsXG4gICAgICBtYXhBZ2U6IGNvbmZpZy5tYXhBZ2UgfHwgMzAwLFxuICAgICAgY2xvY2tTa2V3VG9sZXJhbmNlOiBjb25maWcuY2xvY2tTa2V3VG9sZXJhbmNlIHx8IDYwLFxuICAgICAgc2lnbmF0dXJlSGVhZGVyOiBjb25maWcuc2lnbmF0dXJlSGVhZGVyIHx8ICd4LXNpZ25hdHVyZScsXG4gICAgICB0aW1lc3RhbXBIZWFkZXI6IGNvbmZpZy50aW1lc3RhbXBIZWFkZXIgfHwgJ3gtdGltZXN0YW1wJyxcbiAgICAgIHNpZ25hdHVyZVByZWZpeDogY29uZmlnLnNpZ25hdHVyZVByZWZpeCB8fCAnc2hhMjU2PSdcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENyZWF0ZSBITUFDIHZhbGlkYXRvciBmcm9tIGVudmlyb25tZW50IHZhcmlhYmxlc1xuICAgKi9cbiAgc3RhdGljIGZyb21FbnZpcm9ubWVudCgpOiBITUFDVmFsaWRhdG9yIHtcbiAgICBjb25zdCBjb25maWcgPSBITUFDVmFsaWRhdG9yLnZhbGlkYXRlQ29uZmlnKHtcbiAgICAgIHNlY3JldDogcHJvY2Vzcy5lbnYuSE1BQ19TRUNSRVQgfHwgcHJvY2Vzcy5lbnYuV0VCSE9PS19TRUNSRVQsXG4gICAgICBhbGdvcml0aG06IHByb2Nlc3MuZW52LkhNQUNfQUxHT1JJVEhNLFxuICAgICAgbWF4QWdlOiBwcm9jZXNzLmVudi5ITUFDX01BWF9BR0UgPyBwYXJzZUludChwcm9jZXNzLmVudi5ITUFDX01BWF9BR0UsIDEwKSA6IHVuZGVmaW5lZCxcbiAgICAgIGNsb2NrU2tld1RvbGVyYW5jZTogcHJvY2Vzcy5lbnYuSE1BQ19DTE9DS19TS0VXX1RPTEVSQU5DRSBcbiAgICAgICAgPyBwYXJzZUludChwcm9jZXNzLmVudi5ITUFDX0NMT0NLX1NLRVdfVE9MRVJBTkNFLCAxMCkgXG4gICAgICAgIDogdW5kZWZpbmVkLFxuICAgICAgc2lnbmF0dXJlSGVhZGVyOiBwcm9jZXNzLmVudi5ITUFDX1NJR05BVFVSRV9IRUFERVIsXG4gICAgICB0aW1lc3RhbXBIZWFkZXI6IHByb2Nlc3MuZW52LkhNQUNfVElNRVNUQU1QX0hFQURFUixcbiAgICAgIHNpZ25hdHVyZVByZWZpeDogcHJvY2Vzcy5lbnYuSE1BQ19TSUdOQVRVUkVfUFJFRklYXG4gICAgfSk7XG5cbiAgICByZXR1cm4gbmV3IEhNQUNWYWxpZGF0b3IoY29uZmlnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdmFsaWRhdG9yIGNvbmZpZ3VyYXRpb24gKHdpdGggc2VjcmV0IG1hc2tlZClcbiAgICovXG4gIGdldENvbmZpZygpOiBPbWl0PEhNQUNWYWxpZGF0aW9uQ29uZmlnLCAnc2VjcmV0Jz4gJiB7IHNlY3JldExlbmd0aDogbnVtYmVyIH0ge1xuICAgIHJldHVybiB7XG4gICAgICBhbGdvcml0aG06IHRoaXMuY29uZmlnLmFsZ29yaXRobSxcbiAgICAgIG1heEFnZTogdGhpcy5jb25maWcubWF4QWdlLFxuICAgICAgY2xvY2tTa2V3VG9sZXJhbmNlOiB0aGlzLmNvbmZpZy5jbG9ja1NrZXdUb2xlcmFuY2UsXG4gICAgICBzaWduYXR1cmVIZWFkZXI6IHRoaXMuY29uZmlnLnNpZ25hdHVyZUhlYWRlcixcbiAgICAgIHRpbWVzdGFtcEhlYWRlcjogdGhpcy5jb25maWcudGltZXN0YW1wSGVhZGVyLFxuICAgICAgc2lnbmF0dXJlUHJlZml4OiB0aGlzLmNvbmZpZy5zaWduYXR1cmVQcmVmaXgsXG4gICAgICBzZWNyZXRMZW5ndGg6IHRoaXMuY29uZmlnLnNlY3JldC5sZW5ndGhcbiAgICB9O1xuICB9XG59XG5cbi8qKlxuICogRXhwcmVzcyBtaWRkbGV3YXJlIGZvciBITUFDIHZhbGlkYXRpb25cbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGNyZWF0ZUhNQUNNaWRkbGV3YXJlKHZhbGlkYXRvcjogSE1BQ1ZhbGlkYXRvcikge1xuICByZXR1cm4gKHJlcTogYW55LCByZXM6IGFueSwgbmV4dDogYW55KSA9PiB7XG4gICAgLy8gU2tpcCB2YWxpZGF0aW9uIGZvciBoZWFsdGggY2hlY2tzIGFuZCBvdGhlciBub24td2ViaG9vayBlbmRwb2ludHNcbiAgICBpZiAocmVxLnBhdGggPT09ICcvaGVhbHRoJyB8fCByZXEucGF0aCA9PT0gJy9tZXRyaWNzJykge1xuICAgICAgcmV0dXJuIG5leHQoKTtcbiAgICB9XG5cbiAgICAvLyBHZXQgcmF3IGJvZHkgKHNob3VsZCBiZSBzZXQgYnkgcmF3IGJvZHkgcGFyc2VyIG1pZGRsZXdhcmUpXG4gICAgY29uc3QgYm9keSA9IHJlcS5yYXdCb2R5IHx8IHJlcS5ib2R5IHx8ICcnO1xuICAgIFxuICAgIC8vIFZhbGlkYXRlIEhNQUMgc2lnbmF0dXJlXG4gICAgY29uc3QgcmVzdWx0ID0gdmFsaWRhdG9yLnZhbGlkYXRlUmVxdWVzdChib2R5LCByZXEuaGVhZGVycyk7XG4gICAgXG4gICAgaWYgKCFyZXN1bHQudmFsaWQpIHtcbiAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwMSkuanNvbih7XG4gICAgICAgIGVycm9yOiAnVW5hdXRob3JpemVkJyxcbiAgICAgICAgbWVzc2FnZTogcmVzdWx0LmVycm9yLFxuICAgICAgICB0aW1lc3RhbXA6IG5ldyBEYXRlKCkudG9JU09TdHJpbmcoKVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgLy8gQWRkIHZhbGlkYXRpb24gcmVzdWx0IHRvIHJlcXVlc3QgZm9yIGxvZ2dpbmdcbiAgICByZXEuaG1hY1ZhbGlkYXRpb24gPSByZXN1bHQ7XG4gICAgbmV4dCgpO1xuICB9O1xufVxuXG4vKipcbiAqIERlZmF1bHQgSE1BQyB2YWxpZGF0aW9uIGNvbmZpZ3VyYXRpb25cbiAqL1xuZXhwb3J0IGNvbnN0IEhNQUNEZWZhdWx0czogUGFydGlhbDxITUFDVmFsaWRhdGlvbkNvbmZpZz4gPSB7XG4gIGFsZ29yaXRobTogJ3NoYTI1NicsXG4gIG1heEFnZTogMzAwLCAgICAgICAgLy8gNSBtaW51dGVzXG4gIGNsb2NrU2tld1RvbGVyYW5jZTogNjAsICAvLyAxIG1pbnV0ZVxuICBzaWduYXR1cmVIZWFkZXI6ICd4LXNpZ25hdHVyZScsXG4gIHRpbWVzdGFtcEhlYWRlcjogJ3gtdGltZXN0YW1wJyxcbiAgc2lnbmF0dXJlUHJlZml4OiAnc2hhMjU2PSdcbn07Il0sInZlcnNpb24iOjN9
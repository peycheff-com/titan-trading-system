{"file":"/Users/ivan/Code/trading/titan/services/titan-brain/src/security/HMACValidator.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-brain/src/security/HMACValidator.ts"],"sourcesContent":["/**\n * HMACValidator - HMAC signature verification for webhook security\n * \n * Provides HMAC signature verification with timestamp validation\n * to prevent replay attacks and ensure webhook authenticity.\n * \n * Requirements: 2.3.1, 2.3.2, 2.3.3, 2.3.4\n */\n\nimport { createHmac, timingSafeEqual } from 'crypto';\nimport { Logger } from '../logging/Logger.js';\n\n/**\n * HMAC validation configuration\n */\nexport interface HMACConfig {\n  secret: string;\n  algorithm: 'sha256' | 'sha512';\n  headerName: string;\n  timestampHeaderName: string;\n  timestampTolerance: number; // seconds\n  requireTimestamp: boolean;\n}\n\n/**\n * HMAC validation result\n */\nexport interface HMACValidationResult {\n  valid: boolean;\n  error?: string;\n  timestamp?: number;\n  age?: number;\n}\n\n/**\n * Default HMAC configuration\n */\nconst DEFAULT_HMAC_CONFIG: HMACConfig = {\n  secret: '',\n  algorithm: 'sha256',\n  headerName: 'x-signature',\n  timestampHeaderName: 'x-timestamp',\n  timestampTolerance: 300, // 5 minutes\n  requireTimestamp: true\n};\n\n/**\n * HMAC validator for webhook security\n */\nexport class HMACValidator {\n  private config: HMACConfig;\n  private logger: Logger;\n\n  constructor(config: Partial<HMACConfig>, logger?: Logger) {\n    this.config = { ...DEFAULT_HMAC_CONFIG, ...config };\n    this.logger = logger ?? Logger.getInstance('hmac-validator');\n    \n    if (!this.config.secret) {\n      throw new Error('HMAC secret is required');\n    }\n    \n    this.logger.info('HMAC validator initialized', undefined, {\n      algorithm: this.config.algorithm,\n      headerName: this.config.headerName,\n      timestampHeaderName: this.config.timestampHeaderName,\n      timestampTolerance: this.config.timestampTolerance,\n      requireTimestamp: this.config.requireTimestamp\n    });\n  }\n\n  /**\n   * Create HMAC validator from environment variables\n   */\n  static fromEnvironment(logger?: Logger): HMACValidator {\n    const secret = process.env.HMAC_SECRET;\n    if (!secret) {\n      throw new Error('HMAC_SECRET environment variable is required');\n    }\n\n    const config: Partial<HMACConfig> = {\n      secret,\n      algorithm: (process.env.HMAC_ALGORITHM as 'sha256' | 'sha512') || 'sha256',\n      headerName: process.env.HMAC_HEADER_NAME || 'x-signature',\n      timestampHeaderName: process.env.HMAC_TIMESTAMP_HEADER || 'x-timestamp',\n      timestampTolerance: parseInt(process.env.HMAC_TIMESTAMP_TOLERANCE || '300'),\n      requireTimestamp: process.env.HMAC_REQUIRE_TIMESTAMP !== 'false'\n    };\n\n    return new HMACValidator(config, logger);\n  }\n\n  /**\n   * Generate HMAC signature for a payload\n   */\n  generateSignature(payload: string, timestamp?: number): string {\n    let data = payload;\n    \n    // Include timestamp in signature if provided\n    if (timestamp !== undefined) {\n      data = `${timestamp}.${payload}`;\n    }\n    \n    return createHmac(this.config.algorithm, this.config.secret)\n      .update(data, 'utf8')\n      .digest('hex');\n  }\n\n  /**\n   * Validate HMAC signature from request headers\n   */\n  validateRequest(payload: string, headers: Record<string, string | string[] | undefined>): HMACValidationResult {\n    try {\n      // Get signature from headers\n      const signature = this.getHeaderValue(headers, this.config.headerName);\n      if (!signature) {\n        return {\n          valid: false,\n          error: `Missing ${this.config.headerName} header`\n        };\n      }\n\n      // Get timestamp from headers if required\n      let timestamp: number | undefined;\n      let age: number | undefined;\n      \n      if (this.config.requireTimestamp) {\n        const timestampStr = this.getHeaderValue(headers, this.config.timestampHeaderName);\n        if (!timestampStr) {\n          return {\n            valid: false,\n            error: `Missing ${this.config.timestampHeaderName} header`\n          };\n        }\n\n        timestamp = parseInt(timestampStr, 10);\n        if (isNaN(timestamp)) {\n          return {\n            valid: false,\n            error: 'Invalid timestamp format'\n          };\n        }\n\n        // Check timestamp age\n        const now = Math.floor(Date.now() / 1000);\n        age = now - timestamp;\n        \n        if (Math.abs(age) > this.config.timestampTolerance) {\n          return {\n            valid: false,\n            error: `Timestamp too old or too far in future (age: ${age}s, tolerance: ${this.config.timestampTolerance}s)`,\n            timestamp,\n            age\n          };\n        }\n      }\n\n      // Validate signature format\n      if (!this.isValidSignatureFormat(signature)) {\n        // Add constant-time delay to prevent timing attacks\n        this.constantTimeDelay();\n        return {\n          valid: false,\n          error: 'Invalid signature format',\n          timestamp,\n          age\n        };\n      }\n\n      // Generate expected signature\n      const expectedSignature = this.generateSignature(payload, timestamp);\n\n      // Perform timing-safe comparison\n      const isValid = this.timingSafeCompare(signature, expectedSignature);\n\n      if (!isValid) {\n        this.logger.warn('HMAC signature validation failed', undefined, {\n          expectedLength: expectedSignature.length,\n          actualLength: signature.length,\n          timestamp,\n          age\n        });\n      }\n\n      return {\n        valid: isValid,\n        error: isValid ? undefined : 'Invalid signature',\n        timestamp,\n        age\n      };\n\n    } catch (error) {\n      this.logger.error('HMAC validation error', error instanceof Error ? error : new Error(String(error)));\n      \n      return {\n        valid: false,\n        error: 'HMAC validation failed due to internal error'\n      };\n    }\n  }\n\n  /**\n   * Get header value (case-insensitive)\n   */\n  private getHeaderValue(headers: Record<string, string | string[] | undefined>, name: string): string | undefined {\n    // Try exact match first\n    let value = headers[name];\n    \n    // Try case-insensitive match\n    if (value === undefined) {\n      const lowerName = name.toLowerCase();\n      for (const [key, val] of Object.entries(headers)) {\n        if (key.toLowerCase() === lowerName) {\n          value = val;\n          break;\n        }\n      }\n    }\n    \n    // Handle array values (take first)\n    if (Array.isArray(value)) {\n      value = value[0];\n    }\n    \n    return value;\n  }\n\n  /**\n   * Validate signature format (should be hex)\n   */\n  private isValidSignatureFormat(signature: string): boolean {\n    return /^[a-fA-F0-9]+$/.test(signature);\n  }\n\n  /**\n   * Timing-safe string comparison to prevent timing attacks\n   */\n  private timingSafeCompare(signature: string, expectedSignature: string): boolean {\n    // Ensure both signatures are the same length to prevent length-based timing attacks\n    if (signature.length !== expectedSignature.length) {\n      this.constantTimeDelay();\n      return false;\n    }\n\n    try {\n      const signatureBuffer = Buffer.from(signature, 'hex');\n      const expectedBuffer = Buffer.from(expectedSignature, 'hex');\n      \n      return timingSafeEqual(signatureBuffer, expectedBuffer);\n    } catch (error) {\n      // Log security event without exposing details\n      this.logger.warn('HMAC signature buffer conversion failed');\n      this.constantTimeDelay();\n      return false;\n    }\n  }\n\n  /**\n   * Add constant-time delay to prevent timing attacks\n   */\n  private constantTimeDelay(): void {\n    // Perform a dummy HMAC calculation to maintain constant time\n    const dummyData = 'dummy_data_for_timing_consistency';\n    createHmac(this.config.algorithm, this.config.secret)\n      .update(dummyData)\n      .digest('hex');\n  }\n\n  /**\n   * Create HMAC headers for outgoing requests\n   */\n  createHeaders(payload: string, includeTimestamp: boolean = true): Record<string, string> {\n    const headers: Record<string, string> = {};\n    \n    let timestamp: number | undefined;\n    if (includeTimestamp) {\n      timestamp = Math.floor(Date.now() / 1000);\n      headers[this.config.timestampHeaderName] = timestamp.toString();\n    }\n    \n    const signature = this.generateSignature(payload, timestamp);\n    headers[this.config.headerName] = signature;\n    \n    return headers;\n  }\n\n  /**\n   * Get HMAC configuration (without secret)\n   */\n  getConfig(): Omit<HMACConfig, 'secret'> {\n    const { secret, ...config } = this.config;\n    return config;\n  }\n\n  /**\n   * Check if HMAC validation is enabled\n   */\n  isEnabled(): boolean {\n    return !!this.config.secret;\n  }\n\n  /**\n   * Update HMAC secret (for key rotation)\n   */\n  updateSecret(newSecret: string): void {\n    if (!newSecret) {\n      throw new Error('HMAC secret cannot be empty');\n    }\n    \n    this.config.secret = newSecret;\n    this.logger.info('HMAC secret updated');\n  }\n\n  /**\n   * Test HMAC validation with known payload and signature\n   */\n  test(payload: string, expectedSignature: string, timestamp?: number): boolean {\n    const actualSignature = this.generateSignature(payload, timestamp);\n    return this.timingSafeCompare(expectedSignature, actualSignature);\n  }\n}\n\n/**\n * Create HMAC middleware for Fastify\n */\nexport function createHMACMiddleware(validator: HMACValidator, logger?: Logger) {\n  const middlewareLogger = logger ?? Logger.getInstance('hmac-middleware');\n  \n  return async (request: any, reply: any) => {\n    // Skip HMAC validation for health checks and metrics\n    if (request.url === '/health' || request.url === '/status' || request.url === '/metrics') {\n      return;\n    }\n\n    const body = request.rawBody || request.body || '';\n    const bodyString = typeof body === 'string' ? body : JSON.stringify(body);\n    \n    const result = validator.validateRequest(bodyString, request.headers);\n    \n    if (!result.valid) {\n      middlewareLogger.warn('HMAC validation failed', undefined, {\n        ip: request.ip,\n        endpoint: request.url,\n        error: result.error,\n        userAgent: request.headers['user-agent'],\n        timestamp: result.timestamp,\n        age: result.age\n      });\n\n      reply.status(401).send({\n        error: 'Unauthorized',\n        message: result.error,\n        timestamp: new Date().toISOString()\n      });\n      return;\n    }\n\n    // Add validation result to request for logging\n    request.hmacValidation = result;\n    \n    middlewareLogger.debug('HMAC validation successful', undefined, {\n      ip: request.ip,\n      endpoint: request.url,\n      timestamp: result.timestamp,\n      age: result.age\n    });\n  };\n}\n\n/**\n * HMAC configuration defaults for different environments\n */\nexport const HMACDefaults = {\n  development: {\n    algorithm: 'sha256' as const,\n    timestampTolerance: 600, // 10 minutes (more lenient for development)\n    requireTimestamp: false\n  },\n  \n  production: {\n    algorithm: 'sha512' as const,\n    timestampTolerance: 300, // 5 minutes\n    requireTimestamp: true\n  },\n  \n  test: {\n    algorithm: 'sha256' as const,\n    timestampTolerance: 3600, // 1 hour (very lenient for tests)\n    requireTimestamp: false\n  }\n} as const;"],"version":3}
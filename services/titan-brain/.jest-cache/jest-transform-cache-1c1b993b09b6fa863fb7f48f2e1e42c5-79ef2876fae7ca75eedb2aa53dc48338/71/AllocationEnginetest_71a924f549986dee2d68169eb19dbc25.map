{"file":"/Users/ivan/Code/trading/titan/services/titan-brain/tests/unit/AllocationEngine.test.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-brain/tests/unit/AllocationEngine.test.ts"],"sourcesContent":["/**\n * Unit Tests for AllocationEngine\n * \n * Tests boundary conditions, sigmoid smoothness, and leverage cap lookup.\n * Requirements: 1.2, 1.3, 1.4, 1.5, 1.6, 3.4\n */\n\nimport { AllocationEngine } from '../../src/engine/AllocationEngine.js';\nimport { EquityTier } from '../../src/types/index.js';\nimport { defaultConfig } from '../../src/config/defaults.js';\n\ndescribe('AllocationEngine', () => {\n  let engine: AllocationEngine;\n\n  beforeEach(() => {\n    engine = new AllocationEngine(defaultConfig.allocationEngine);\n  });\n\n  describe('constructor', () => {\n    it('should initialize with provided configuration', () => {\n      const transitionPoints = engine.getTransitionPoints();\n      const leverageCaps = engine.getLeverageCaps();\n\n      expect(transitionPoints.startP2).toBe(1500);\n      expect(transitionPoints.fullP2).toBe(5000);\n      expect(transitionPoints.startP3).toBe(25000);\n      expect(leverageCaps[EquityTier.MICRO]).toBe(20);\n      expect(leverageCaps[EquityTier.INSTITUTIONAL]).toBe(2);\n    });\n\n    it('should accept custom configuration', () => {\n      const customEngine = new AllocationEngine({\n        transitionPoints: {\n          startP2: 2000,\n          fullP2: 10000,\n          startP3: 50000,\n        },\n        leverageCaps: {\n          [EquityTier.MICRO]: 25,\n          [EquityTier.SMALL]: 15,\n          [EquityTier.MEDIUM]: 8,\n          [EquityTier.LARGE]: 4,\n          [EquityTier.INSTITUTIONAL]: 2,\n        },\n      });\n\n      const transitionPoints = customEngine.getTransitionPoints();\n      expect(transitionPoints.startP2).toBe(2000);\n      expect(transitionPoints.fullP2).toBe(10000);\n    });\n  });\n\n  describe('getWeights', () => {\n    describe('boundary conditions', () => {\n      it('should return 100% Phase 1 at $0', () => {\n        const weights = engine.getWeights(0);\n        expect(weights.w1).toBe(1.0);\n        expect(weights.w2).toBe(0.0);\n        expect(weights.w3).toBe(0.0);\n      });\n\n      it('should return 100% Phase 1 at $1,499', () => {\n        const weights = engine.getWeights(1499);\n        expect(weights.w1).toBe(1.0);\n        expect(weights.w2).toBe(0.0);\n        expect(weights.w3).toBe(0.0);\n      });\n\n      it('should start transitioning at $1,500', () => {\n        const weights = engine.getWeights(1500);\n        // At the start of transition, Phase 1 should still be dominant\n        expect(weights.w1).toBeGreaterThan(0.5);\n        expect(weights.w2).toBeLessThan(0.5);\n        expect(weights.w3).toBe(0.0);\n      });\n\n      it('should be at stable allocation at $5,000', () => {\n        const weights = engine.getWeights(5000);\n        // At full P2, should be approximately 20% P1, 80% P2\n        expect(weights.w1).toBeCloseTo(0.2, 1);\n        expect(weights.w2).toBeCloseTo(0.8, 1);\n        expect(weights.w3).toBe(0.0);\n      });\n\n      it('should maintain stable allocation at $10,000', () => {\n        const weights = engine.getWeights(10000);\n        expect(weights.w1).toBeCloseTo(0.2, 1);\n        expect(weights.w2).toBeCloseTo(0.8, 1);\n        expect(weights.w3).toBe(0.0);\n      });\n\n      it('should start Phase 3 transition at $25,000', () => {\n        const weights = engine.getWeights(25000);\n        // At the start of P3 transition\n        expect(weights.w1).toBeCloseTo(0.2, 1);\n        expect(weights.w2).toBeLessThanOrEqual(0.8);\n        expect(weights.w3).toBeGreaterThanOrEqual(0);\n      });\n\n      it('should have significant Phase 3 allocation at $50,000', () => {\n        const weights = engine.getWeights(50000);\n        expect(weights.w1).toBeCloseTo(0.2, 1);\n        expect(weights.w3).toBeGreaterThan(0.1);\n        // Sum should still be 1.0\n        expect(weights.w1 + weights.w2 + weights.w3).toBeCloseTo(1.0, 10);\n      });\n    });\n\n    describe('sigmoid smoothness', () => {\n      it('should have smooth transition in Phase 1 → Phase 2 zone', () => {\n        const equityLevels = [1500, 2000, 2500, 3000, 3500, 4000, 4500, 5000];\n        const weights = equityLevels.map(e => engine.getWeights(e));\n\n        // Phase 1 weight should monotonically decrease\n        for (let i = 1; i < weights.length; i++) {\n          expect(weights[i].w1).toBeLessThanOrEqual(weights[i - 1].w1);\n        }\n\n        // Phase 2 weight should monotonically increase\n        for (let i = 1; i < weights.length; i++) {\n          expect(weights[i].w2).toBeGreaterThanOrEqual(weights[i - 1].w2);\n        }\n      });\n\n      it('should have no sudden jumps in allocation', () => {\n        const step = 100;\n        let prevWeights = engine.getWeights(1500);\n\n        for (let equity = 1600; equity <= 5000; equity += step) {\n          const weights = engine.getWeights(equity);\n          \n          // No weight should change by more than 20% per $100 step\n          expect(Math.abs(weights.w1 - prevWeights.w1)).toBeLessThan(0.2);\n          expect(Math.abs(weights.w2 - prevWeights.w2)).toBeLessThan(0.2);\n          \n          prevWeights = weights;\n        }\n      });\n\n      it('should have smooth transition in Phase 2 → Phase 3 zone', () => {\n        const equityLevels = [25000, 30000, 35000, 40000, 45000, 50000];\n        const weights = equityLevels.map(e => engine.getWeights(e));\n\n        // Phase 3 weight should monotonically increase\n        for (let i = 1; i < weights.length; i++) {\n          expect(weights[i].w3).toBeGreaterThanOrEqual(weights[i - 1].w3);\n        }\n\n        // Phase 2 weight should monotonically decrease (as P3 takes over)\n        for (let i = 1; i < weights.length; i++) {\n          expect(weights[i].w2).toBeLessThanOrEqual(weights[i - 1].w2);\n        }\n      });\n    });\n\n    describe('weight sum invariant', () => {\n      it('should always sum to 1.0', () => {\n        const testEquities = [0, 100, 500, 1000, 1500, 2500, 5000, 10000, 25000, 50000, 100000];\n        \n        for (const equity of testEquities) {\n          const weights = engine.getWeights(equity);\n          const sum = weights.w1 + weights.w2 + weights.w3;\n          expect(sum).toBeCloseTo(1.0, 10);\n        }\n      });\n    });\n\n    describe('edge cases', () => {\n      it('should handle negative equity as $0', () => {\n        const weights = engine.getWeights(-1000);\n        expect(weights.w1).toBe(1.0);\n        expect(weights.w2).toBe(0.0);\n        expect(weights.w3).toBe(0.0);\n      });\n\n      it('should handle very large equity', () => {\n        const weights = engine.getWeights(10000000);\n        expect(weights.w1 + weights.w2 + weights.w3).toBeCloseTo(1.0, 10);\n        expect(weights.w3).toBeGreaterThan(0);\n      });\n\n      it('should include timestamp in result', () => {\n        const before = Date.now();\n        const weights = engine.getWeights(5000);\n        const after = Date.now();\n\n        expect(weights.timestamp).toBeGreaterThanOrEqual(before);\n        expect(weights.timestamp).toBeLessThanOrEqual(after);\n      });\n    });\n  });\n\n  describe('getEquityTier', () => {\n    describe('tier boundaries', () => {\n      it('should return MICRO for equity < $1,500', () => {\n        expect(engine.getEquityTier(0)).toBe(EquityTier.MICRO);\n        expect(engine.getEquityTier(500)).toBe(EquityTier.MICRO);\n        expect(engine.getEquityTier(1499.99)).toBe(EquityTier.MICRO);\n      });\n\n      it('should return SMALL for equity $1,500 - $4,999.99', () => {\n        expect(engine.getEquityTier(1500)).toBe(EquityTier.SMALL);\n        expect(engine.getEquityTier(3000)).toBe(EquityTier.SMALL);\n        expect(engine.getEquityTier(4999.99)).toBe(EquityTier.SMALL);\n      });\n\n      it('should return MEDIUM for equity $5,000 - $24,999.99', () => {\n        expect(engine.getEquityTier(5000)).toBe(EquityTier.MEDIUM);\n        expect(engine.getEquityTier(15000)).toBe(EquityTier.MEDIUM);\n        expect(engine.getEquityTier(24999.99)).toBe(EquityTier.MEDIUM);\n      });\n\n      it('should return LARGE for equity $25,000 - $49,999.99', () => {\n        expect(engine.getEquityTier(25000)).toBe(EquityTier.LARGE);\n        expect(engine.getEquityTier(35000)).toBe(EquityTier.LARGE);\n        expect(engine.getEquityTier(49999.99)).toBe(EquityTier.LARGE);\n      });\n\n      it('should return INSTITUTIONAL for equity >= $50,000', () => {\n        expect(engine.getEquityTier(50000)).toBe(EquityTier.INSTITUTIONAL);\n        expect(engine.getEquityTier(100000)).toBe(EquityTier.INSTITUTIONAL);\n        expect(engine.getEquityTier(1000000)).toBe(EquityTier.INSTITUTIONAL);\n      });\n    });\n\n    describe('edge cases', () => {\n      it('should handle negative equity as MICRO', () => {\n        expect(engine.getEquityTier(-100)).toBe(EquityTier.MICRO);\n        expect(engine.getEquityTier(-1000000)).toBe(EquityTier.MICRO);\n      });\n\n      it('should handle exact boundary values', () => {\n        // Exact boundaries should be in the higher tier\n        expect(engine.getEquityTier(1500)).toBe(EquityTier.SMALL);\n        expect(engine.getEquityTier(5000)).toBe(EquityTier.MEDIUM);\n        expect(engine.getEquityTier(25000)).toBe(EquityTier.LARGE);\n        expect(engine.getEquityTier(50000)).toBe(EquityTier.INSTITUTIONAL);\n      });\n    });\n  });\n\n  describe('getMaxLeverage', () => {\n    describe('leverage cap lookup', () => {\n      it('should return 20x for MICRO tier', () => {\n        expect(engine.getMaxLeverage(0)).toBe(20);\n        expect(engine.getMaxLeverage(500)).toBe(20);\n        expect(engine.getMaxLeverage(1499)).toBe(20);\n      });\n\n      it('should return 10x for SMALL tier', () => {\n        expect(engine.getMaxLeverage(1500)).toBe(10);\n        expect(engine.getMaxLeverage(3000)).toBe(10);\n        expect(engine.getMaxLeverage(4999)).toBe(10);\n      });\n\n      it('should return 5x for MEDIUM tier', () => {\n        expect(engine.getMaxLeverage(5000)).toBe(5);\n        expect(engine.getMaxLeverage(15000)).toBe(5);\n        expect(engine.getMaxLeverage(24999)).toBe(5);\n      });\n\n      it('should return 3x for LARGE tier', () => {\n        expect(engine.getMaxLeverage(25000)).toBe(3);\n        expect(engine.getMaxLeverage(35000)).toBe(3);\n        expect(engine.getMaxLeverage(49999)).toBe(3);\n      });\n\n      it('should return 2x for INSTITUTIONAL tier', () => {\n        expect(engine.getMaxLeverage(50000)).toBe(2);\n        expect(engine.getMaxLeverage(100000)).toBe(2);\n        expect(engine.getMaxLeverage(1000000)).toBe(2);\n      });\n    });\n\n    describe('leverage decreases with equity', () => {\n      it('should have decreasing leverage as equity increases', () => {\n        const leverages = [\n          engine.getMaxLeverage(500),    // MICRO\n          engine.getMaxLeverage(2500),   // SMALL\n          engine.getMaxLeverage(10000),  // MEDIUM\n          engine.getMaxLeverage(35000),  // LARGE\n          engine.getMaxLeverage(75000),  // INSTITUTIONAL\n        ];\n\n        for (let i = 1; i < leverages.length; i++) {\n          expect(leverages[i]).toBeLessThanOrEqual(leverages[i - 1]);\n        }\n      });\n    });\n  });\n\n  describe('getTransitionPoints', () => {\n    it('should return a copy of transition points', () => {\n      const points1 = engine.getTransitionPoints();\n      const points2 = engine.getTransitionPoints();\n\n      expect(points1).toEqual(points2);\n      expect(points1).not.toBe(points2); // Should be different objects\n    });\n  });\n\n  describe('getLeverageCaps', () => {\n    it('should return a copy of leverage caps', () => {\n      const caps1 = engine.getLeverageCaps();\n      const caps2 = engine.getLeverageCaps();\n\n      expect(caps1).toEqual(caps2);\n      expect(caps1).not.toBe(caps2); // Should be different objects\n    });\n  });\n});\n"],"version":3}
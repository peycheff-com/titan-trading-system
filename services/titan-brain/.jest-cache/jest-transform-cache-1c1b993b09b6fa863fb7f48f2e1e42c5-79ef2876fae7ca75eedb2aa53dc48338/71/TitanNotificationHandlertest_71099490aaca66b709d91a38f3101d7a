6237d16ab6673f1fd3aea1c4e0073063
"use strict";
/**
 * Unit tests for TitanNotificationHandler
 */
Object.defineProperty(exports, "__esModule", { value: true });
// Mock the NotificationService
jest.mock('../../src/server/NotificationService.js');
const NotificationHandler_js_1 = require("../../src/server/NotificationHandler.js");
const NotificationService_js_1 = require("../../src/server/NotificationService.js");
describe('TitanNotificationHandler', () => {
    let handler;
    let mockNotificationService;
    beforeEach(() => {
        const mockConfig = {
            telegram: { enabled: true, botToken: 'test', chatId: 'test' },
            email: { enabled: false },
        };
        mockNotificationService = new NotificationService_js_1.NotificationService(mockConfig);
        // Mock all methods
        mockNotificationService.sendCircuitBreakerNotification = jest.fn().mockResolvedValue(undefined);
        mockNotificationService.sendHighCorrelationWarning = jest.fn().mockResolvedValue(undefined);
        mockNotificationService.sendSweepNotification = jest.fn().mockResolvedValue(undefined);
        mockNotificationService.sendVetoNotification = jest.fn().mockResolvedValue(undefined);
        mockNotificationService.sendSystemError = jest.fn().mockResolvedValue(undefined);
        mockNotificationService.testNotifications = jest.fn().mockResolvedValue({ telegram: true, email: false });
        mockNotificationService.updateConfig = jest.fn();
        handler = new NotificationHandler_js_1.TitanNotificationHandler(mockNotificationService);
    });
    describe('sendEmergencyNotification', () => {
        it('should call sendCircuitBreakerNotification with correct data', async () => {
            const reason = 'Daily drawdown exceeded 15%';
            const equity = 1000;
            await handler.sendEmergencyNotification(reason, equity);
            expect(mockNotificationService.sendCircuitBreakerNotification).toHaveBeenCalledWith({
                reason,
                equity,
                drawdown: 0,
                triggeredAt: expect.any(Number),
            });
        });
    });
    describe('sendHighCorrelationWarning', () => {
        it('should call sendHighCorrelationWarning with correct data', async () => {
            const correlationScore = 0.85;
            const threshold = 0.8;
            const affectedPositions = ['BTCUSDT', 'ETHUSDT'];
            await handler.sendHighCorrelationWarning(correlationScore, threshold, affectedPositions);
            expect(mockNotificationService.sendHighCorrelationWarning).toHaveBeenCalledWith({
                correlationScore,
                threshold,
                affectedPositions,
            });
        });
    });
    describe('sendSweepNotification', () => {
        it('should call sendSweepNotification with correct data', async () => {
            const amount = 500;
            const fromWallet = 'FUTURES';
            const toWallet = 'SPOT';
            const reason = 'Automated profit sweep';
            const newBalance = 1500;
            await handler.sendSweepNotification(amount, fromWallet, toWallet, reason, newBalance);
            expect(mockNotificationService.sendSweepNotification).toHaveBeenCalledWith({
                amount,
                fromWallet,
                toWallet,
                reason,
                newBalance,
            });
        });
    });
    describe('sendVetoNotification', () => {
        it('should call sendVetoNotification with correct data', async () => {
            const phaseId = 'phase1';
            const signalId = 'signal_123';
            const symbol = 'BTCUSDT';
            const reason = 'Leverage cap exceeded';
            const requestedSize = 1000;
            await handler.sendVetoNotification(phaseId, signalId, symbol, reason, requestedSize);
            expect(mockNotificationService.sendVetoNotification).toHaveBeenCalledWith({
                phaseId,
                signalId,
                symbol,
                reason,
                requestedSize,
            });
        });
    });
    describe('sendSystemError', () => {
        it('should call sendSystemError with correct data', async () => {
            const error = 'Database connection failed';
            const context = { component: 'DatabaseManager' };
            await handler.sendSystemError(error, context);
            expect(mockNotificationService.sendSystemError).toHaveBeenCalledWith(error, context);
        });
    });
    describe('testNotifications', () => {
        it('should call testNotifications on the service', async () => {
            const result = await handler.testNotifications();
            expect(mockNotificationService.testNotifications).toHaveBeenCalled();
            expect(result).toEqual({ telegram: true, email: false });
        });
    });
    describe('updateConfig', () => {
        it('should call updateConfig on the service', () => {
            const newConfig = {
                telegram: { enabled: false },
                email: { enabled: true, smtpHost: 'smtp.test.com' },
            };
            handler.updateConfig(newConfig);
            expect(mockNotificationService.updateConfig).toHaveBeenCalledWith(newConfig);
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLWJyYWluL3Rlc3RzL3VuaXQvVGl0YW5Ob3RpZmljYXRpb25IYW5kbGVyLnRlc3QudHMiLCJtYXBwaW5ncyI6IjtBQUFBOztHQUVHOztBQU1ILCtCQUErQjtBQUMvQixJQUFJLENBQUMsSUFBSSxDQUFDLHlDQUF5QyxDQUFDLENBQUM7QUFMckQsb0ZBQW1GO0FBQ25GLG9GQUE4RTtBQU05RSxRQUFRLENBQUMsMEJBQTBCLEVBQUUsR0FBRyxFQUFFO0lBQ3hDLElBQUksT0FBaUMsQ0FBQztJQUN0QyxJQUFJLHVCQUF5RCxDQUFDO0lBRTlELFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxNQUFNLFVBQVUsR0FBdUI7WUFDckMsUUFBUSxFQUFFLEVBQUUsT0FBTyxFQUFFLElBQUksRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLE1BQU0sRUFBRSxNQUFNLEVBQUU7WUFDN0QsS0FBSyxFQUFFLEVBQUUsT0FBTyxFQUFFLEtBQUssRUFBRTtTQUMxQixDQUFDO1FBRUYsdUJBQXVCLEdBQUcsSUFBSSw0Q0FBbUIsQ0FBQyxVQUFVLENBQXFDLENBQUM7UUFFbEcsbUJBQW1CO1FBQ25CLHVCQUF1QixDQUFDLDhCQUE4QixHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUNoRyx1QkFBdUIsQ0FBQywwQkFBMEIsR0FBRyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsaUJBQWlCLENBQUMsU0FBUyxDQUFDLENBQUM7UUFDNUYsdUJBQXVCLENBQUMscUJBQXFCLEdBQUcsSUFBSSxDQUFDLEVBQUUsRUFBRSxDQUFDLGlCQUFpQixDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQ3ZGLHVCQUF1QixDQUFDLG9CQUFvQixHQUFHLElBQUksQ0FBQyxFQUFFLEVBQUUsQ0FBQyxpQkFBaUIsQ0FBQyxTQUFTLENBQUMsQ0FBQztRQUN0Rix1QkFBdUIsQ0FBQyxlQUFlLEdBQUcsSUFBSSxD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QUFJLEVBQUUsS0FBSyxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDM0QsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDLENBQUMsQ0FBQztJQUVILFFBQVEsQ0FBQyxjQUFjLEVBQUUsR0FBRyxFQUFFO1FBQzVCLEVBQUUsQ0FBQyx5Q0FBeUMsRUFBRSxHQUFHLEVBQUU7WUFDakQsTUFBTSxTQUFTLEdBQXVCO2dCQUNwQyxRQUFRLEVBQUUsRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFO2dCQUM1QixLQUFLLEVBQUUsRUFBRSxPQUFPLEVBQUUsSUFBSSxFQUFFLFFBQVEsRUFBRSxlQUFlLEVBQUU7YUFDcEQsQ0FBQztZQUVGLE9BQU8sQ0FBQyxZQUFZLENBQUMsU0FBUyxDQUFDLENBQUM7WUFFaEMsTUFBTSxDQUFDLHVCQUF1QixDQUFDLFlBQVksQ0FBQyxDQUFDLG9CQUFvQixDQUFDLFNBQVMsQ0FBQyxDQUFDO1FBQy9FLENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvaXZhbi9Db2RlL3RyYWRpbmcvdGl0YW4vc2VydmljZXMvdGl0YW4tYnJhaW4vdGVzdHMvdW5pdC9UaXRhbk5vdGlmaWNhdGlvbkhhbmRsZXIudGVzdC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFVuaXQgdGVzdHMgZm9yIFRpdGFuTm90aWZpY2F0aW9uSGFuZGxlclxuICovXG5cbmltcG9ydCB7IFRpdGFuTm90aWZpY2F0aW9uSGFuZGxlciB9IGZyb20gJy4uLy4uL3NyYy9zZXJ2ZXIvTm90aWZpY2F0aW9uSGFuZGxlci5qcyc7XG5pbXBvcnQgeyBOb3RpZmljYXRpb25TZXJ2aWNlIH0gZnJvbSAnLi4vLi4vc3JjL3NlcnZlci9Ob3RpZmljYXRpb25TZXJ2aWNlLmpzJztcbmltcG9ydCB7IE5vdGlmaWNhdGlvbkNvbmZpZyB9IGZyb20gJy4uLy4uL3NyYy90eXBlcy9jb25maWcuanMnO1xuXG4vLyBNb2NrIHRoZSBOb3RpZmljYXRpb25TZXJ2aWNlXG5qZXN0Lm1vY2soJy4uLy4uL3NyYy9zZXJ2ZXIvTm90aWZpY2F0aW9uU2VydmljZS5qcycpO1xuXG5kZXNjcmliZSgnVGl0YW5Ob3RpZmljYXRpb25IYW5kbGVyJywgKCkgPT4ge1xuICBsZXQgaGFuZGxlcjogVGl0YW5Ob3RpZmljYXRpb25IYW5kbGVyO1xuICBsZXQgbW9ja05vdGlmaWNhdGlvblNlcnZpY2U6IGplc3QuTW9ja2VkPE5vdGlmaWNhdGlvblNlcnZpY2U+O1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGNvbnN0IG1vY2tDb25maWc6IE5vdGlmaWNhdGlvbkNvbmZpZyA9IHtcbiAgICAgIHRlbGVncmFtOiB7IGVuYWJsZWQ6IHRydWUsIGJvdFRva2VuOiAndGVzdCcsIGNoYXRJZDogJ3Rlc3QnIH0sXG4gICAgICBlbWFpbDogeyBlbmFibGVkOiBmYWxzZSB9LFxuICAgIH07XG5cbiAgICBtb2NrTm90aWZpY2F0aW9uU2VydmljZSA9IG5ldyBOb3RpZmljYXRpb25TZXJ2aWNlKG1vY2tDb25maWcpIGFzIGplc3QuTW9ja2VkPE5vdGlmaWNhdGlvblNlcnZpY2U+O1xuICAgIFxuICAgIC8vIE1vY2sgYWxsIG1ldGhvZHNcbiAgICBtb2NrTm90aWZpY2F0aW9uU2VydmljZS5zZW5kQ2lyY3VpdEJyZWFrZXJOb3RpZmljYXRpb24gPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUodW5kZWZpbmVkKTtcbiAgICBtb2NrTm90aWZpY2F0aW9uU2VydmljZS5zZW5kSGlnaENvcnJlbGF0aW9uV2FybmluZyA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpO1xuICAgIG1vY2tOb3RpZmljYXRpb25TZXJ2aWNlLnNlbmRTd2VlcE5vdGlmaWNhdGlvbiA9IGplc3QuZm4oKS5tb2NrUmVzb2x2ZWRWYWx1ZSh1bmRlZmluZWQpO1xuICAgIG1vY2tOb3RpZmljYXRpb25TZXJ2aWNlLnNlbmRWZXRvTm90aWZpY2F0aW9uID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCk7XG4gICAgbW9ja05vdGlmaWNhdGlvblNlcnZpY2Uuc2VuZFN5c3RlbUVycm9yID0gamVzdC5mbigpLm1vY2tSZXNvbHZlZFZhbHVlKHVuZGVmaW5lZCk7XG4gICAgbW9ja05vdGlmaWNhdGlvblNlcnZpY2UudGVzdE5vdGlmaWNhdGlvbnMgPSBqZXN0LmZuKCkubW9ja1Jlc29sdmVkVmFsdWUoeyB0ZWxlZ3JhbTogdHJ1ZSwgZW1haWw6IGZhbHNlIH0pO1xuICAgIG1vY2tOb3RpZmljYXRpb25TZXJ2aWNlLnVwZGF0ZUNvbmZpZyA9IGplc3QuZm4oKTtcblxuICAgIGhhbmRsZXIgPSBuZXcgVGl0YW5Ob3RpZmljYXRpb25IYW5kbGVyKG1vY2tOb3RpZmljYXRpb25TZXJ2aWNlKTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3NlbmRFbWVyZ2VuY3lOb3RpZmljYXRpb24nLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjYWxsIHNlbmRDaXJjdWl0QnJlYWtlck5vdGlmaWNhdGlvbiB3aXRoIGNvcnJlY3QgZGF0YScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHJlYXNvbiA9ICdEYWlseSBkcmF3ZG93biBleGNlZWRlZCAxNSUnO1xuICAgICAgY29uc3QgZXF1aXR5ID0gMTAwMDtcblxuICAgICAgYXdhaXQgaGFuZGxlci5zZW5kRW1lcmdlbmN5Tm90aWZpY2F0aW9uKHJlYXNvbiwgZXF1aXR5KTtcblxuICAgICAgZXhwZWN0KG1vY2tOb3RpZmljYXRpb25TZXJ2aWNlLnNlbmRDaXJjdWl0QnJlYWtlck5vdGlmaWNhdGlvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoe1xuICAgICAgICByZWFzb24sXG4gICAgICAgIGVxdWl0eSxcbiAgICAgICAgZHJhd2Rvd246IDAsXG4gICAgICAgIHRyaWdnZXJlZEF0OiBleHBlY3QuYW55KE51bWJlciksXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3NlbmRIaWdoQ29ycmVsYXRpb25XYXJuaW5nJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY2FsbCBzZW5kSGlnaENvcnJlbGF0aW9uV2FybmluZyB3aXRoIGNvcnJlY3QgZGF0YScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGNvcnJlbGF0aW9uU2NvcmUgPSAwLjg1O1xuICAgICAgY29uc3QgdGhyZXNob2xkID0gMC44O1xuICAgICAgY29uc3QgYWZmZWN0ZWRQb3NpdGlvbnMgPSBbJ0JUQ1VTRFQnLCAnRVRIVVNEVCddO1xuXG4gICAgICBhd2FpdCBoYW5kbGVyLnNlbmRIaWdoQ29ycmVsYXRpb25XYXJuaW5nKGNvcnJlbGF0aW9uU2NvcmUsIHRocmVzaG9sZCwgYWZmZWN0ZWRQb3NpdGlvbnMpO1xuXG4gICAgICBleHBlY3QobW9ja05vdGlmaWNhdGlvblNlcnZpY2Uuc2VuZEhpZ2hDb3JyZWxhdGlvbldhcm5pbmcpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICAgICAgY29ycmVsYXRpb25TY29yZSxcbiAgICAgICAgdGhyZXNob2xkLFxuICAgICAgICBhZmZlY3RlZFBvc2l0aW9ucyxcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnc2VuZFN3ZWVwTm90aWZpY2F0aW9uJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY2FsbCBzZW5kU3dlZXBOb3RpZmljYXRpb24gd2l0aCBjb3JyZWN0IGRhdGEnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCBhbW91bnQgPSA1MDA7XG4gICAgICBjb25zdCBmcm9tV2FsbGV0ID0gJ0ZVVFVSRVMnO1xuICAgICAgY29uc3QgdG9XYWxsZXQgPSAnU1BPVCc7XG4gICAgICBjb25zdCByZWFzb24gPSAnQXV0b21hdGVkIHByb2ZpdCBzd2VlcCc7XG4gICAgICBjb25zdCBuZXdCYWxhbmNlID0gMTUwMDtcblxuICAgICAgYXdhaXQgaGFuZGxlci5zZW5kU3dlZXBOb3RpZmljYXRpb24oYW1vdW50LCBmcm9tV2FsbGV0LCB0b1dhbGxldCwgcmVhc29uLCBuZXdCYWxhbmNlKTtcblxuICAgICAgZXhwZWN0KG1vY2tOb3RpZmljYXRpb25TZXJ2aWNlLnNlbmRTd2VlcE5vdGlmaWNhdGlvbikudG9IYXZlQmVlbkNhbGxlZFdpdGgoe1xuICAgICAgICBhbW91bnQsXG4gICAgICAgIGZyb21XYWxsZXQsXG4gICAgICAgIHRvV2FsbGV0LFxuICAgICAgICByZWFzb24sXG4gICAgICAgIG5ld0JhbGFuY2UsXG4gICAgICB9KTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3NlbmRWZXRvTm90aWZpY2F0aW9uJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY2FsbCBzZW5kVmV0b05vdGlmaWNhdGlvbiB3aXRoIGNvcnJlY3QgZGF0YScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IHBoYXNlSWQgPSAncGhhc2UxJyBhcyBjb25zdDtcbiAgICAgIGNvbnN0IHNpZ25hbElkID0gJ3NpZ25hbF8xMjMnO1xuICAgICAgY29uc3Qgc3ltYm9sID0gJ0JUQ1VTRFQnO1xuICAgICAgY29uc3QgcmVhc29uID0gJ0xldmVyYWdlIGNhcCBleGNlZWRlZCc7XG4gICAgICBjb25zdCByZXF1ZXN0ZWRTaXplID0gMTAwMDtcblxuICAgICAgYXdhaXQgaGFuZGxlci5zZW5kVmV0b05vdGlmaWNhdGlvbihwaGFzZUlkLCBzaWduYWxJZCwgc3ltYm9sLCByZWFzb24sIHJlcXVlc3RlZFNpemUpO1xuXG4gICAgICBleHBlY3QobW9ja05vdGlmaWNhdGlvblNlcnZpY2Uuc2VuZFZldG9Ob3RpZmljYXRpb24pLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICAgICAgcGhhc2VJZCxcbiAgICAgICAgc2lnbmFsSWQsXG4gICAgICAgIHN5bWJvbCxcbiAgICAgICAgcmVhc29uLFxuICAgICAgICByZXF1ZXN0ZWRTaXplLFxuICAgICAgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdzZW5kU3lzdGVtRXJyb3InLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjYWxsIHNlbmRTeXN0ZW1FcnJvciB3aXRoIGNvcnJlY3QgZGF0YScsIGFzeW5jICgpID0+IHtcbiAgICAgIGNvbnN0IGVycm9yID0gJ0RhdGFiYXNlIGNvbm5lY3Rpb24gZmFpbGVkJztcbiAgICAgIGNvbnN0IGNvbnRleHQgPSB7IGNvbXBvbmVudDogJ0RhdGFiYXNlTWFuYWdlcicgfTtcblxuICAgICAgYXdhaXQgaGFuZGxlci5zZW5kU3lzdGVtRXJyb3IoZXJyb3IsIGNvbnRleHQpO1xuXG4gICAgICBleHBlY3QobW9ja05vdGlmaWNhdGlvblNlcnZpY2Uuc2VuZFN5c3RlbUVycm9yKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChlcnJvciwgY29udGV4dCk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCd0ZXN0Tm90aWZpY2F0aW9ucycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGNhbGwgdGVzdE5vdGlmaWNhdGlvbnMgb24gdGhlIHNlcnZpY2UnLCBhc3luYyAoKSA9PiB7XG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBoYW5kbGVyLnRlc3ROb3RpZmljYXRpb25zKCk7XG5cbiAgICAgIGV4cGVjdChtb2NrTm90aWZpY2F0aW9uU2VydmljZS50ZXN0Tm90aWZpY2F0aW9ucykudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgZXhwZWN0KHJlc3VsdCkudG9FcXVhbCh7IHRlbGVncmFtOiB0cnVlLCBlbWFpbDogZmFsc2UgfSk7XG4gICAgfSk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCd1cGRhdGVDb25maWcnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBjYWxsIHVwZGF0ZUNvbmZpZyBvbiB0aGUgc2VydmljZScsICgpID0+IHtcbiAgICAgIGNvbnN0IG5ld0NvbmZpZzogTm90aWZpY2F0aW9uQ29uZmlnID0ge1xuICAgICAgICB0ZWxlZ3JhbTogeyBlbmFibGVkOiBmYWxzZSB9LFxuICAgICAgICBlbWFpbDogeyBlbmFibGVkOiB0cnVlLCBzbXRwSG9zdDogJ3NtdHAudGVzdC5jb20nIH0sXG4gICAgICB9O1xuXG4gICAgICBoYW5kbGVyLnVwZGF0ZUNvbmZpZyhuZXdDb25maWcpO1xuXG4gICAgICBleHBlY3QobW9ja05vdGlmaWNhdGlvblNlcnZpY2UudXBkYXRlQ29uZmlnKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChuZXdDb25maWcpO1xuICAgIH0pO1xuICB9KTtcbn0pOyJdLCJ2ZXJzaW9uIjozfQ==
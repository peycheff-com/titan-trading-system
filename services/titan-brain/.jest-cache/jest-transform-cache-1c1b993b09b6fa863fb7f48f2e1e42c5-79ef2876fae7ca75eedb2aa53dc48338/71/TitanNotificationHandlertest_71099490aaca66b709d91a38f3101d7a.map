{"file":"/Users/ivan/Code/trading/titan/services/titan-brain/tests/unit/TitanNotificationHandler.test.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-brain/tests/unit/TitanNotificationHandler.test.ts"],"sourcesContent":["/**\n * Unit tests for TitanNotificationHandler\n */\n\nimport { TitanNotificationHandler } from '../../src/server/NotificationHandler.js';\nimport { NotificationService } from '../../src/server/NotificationService.js';\nimport { NotificationConfig } from '../../src/types/config.js';\n\n// Mock the NotificationService\njest.mock('../../src/server/NotificationService.js');\n\ndescribe('TitanNotificationHandler', () => {\n  let handler: TitanNotificationHandler;\n  let mockNotificationService: jest.Mocked<NotificationService>;\n\n  beforeEach(() => {\n    const mockConfig: NotificationConfig = {\n      telegram: { enabled: true, botToken: 'test', chatId: 'test' },\n      email: { enabled: false },\n    };\n\n    mockNotificationService = new NotificationService(mockConfig) as jest.Mocked<NotificationService>;\n    \n    // Mock all methods\n    mockNotificationService.sendCircuitBreakerNotification = jest.fn().mockResolvedValue(undefined);\n    mockNotificationService.sendHighCorrelationWarning = jest.fn().mockResolvedValue(undefined);\n    mockNotificationService.sendSweepNotification = jest.fn().mockResolvedValue(undefined);\n    mockNotificationService.sendVetoNotification = jest.fn().mockResolvedValue(undefined);\n    mockNotificationService.sendSystemError = jest.fn().mockResolvedValue(undefined);\n    mockNotificationService.testNotifications = jest.fn().mockResolvedValue({ telegram: true, email: false });\n    mockNotificationService.updateConfig = jest.fn();\n\n    handler = new TitanNotificationHandler(mockNotificationService);\n  });\n\n  describe('sendEmergencyNotification', () => {\n    it('should call sendCircuitBreakerNotification with correct data', async () => {\n      const reason = 'Daily drawdown exceeded 15%';\n      const equity = 1000;\n\n      await handler.sendEmergencyNotification(reason, equity);\n\n      expect(mockNotificationService.sendCircuitBreakerNotification).toHaveBeenCalledWith({\n        reason,\n        equity,\n        drawdown: 0,\n        triggeredAt: expect.any(Number),\n      });\n    });\n  });\n\n  describe('sendHighCorrelationWarning', () => {\n    it('should call sendHighCorrelationWarning with correct data', async () => {\n      const correlationScore = 0.85;\n      const threshold = 0.8;\n      const affectedPositions = ['BTCUSDT', 'ETHUSDT'];\n\n      await handler.sendHighCorrelationWarning(correlationScore, threshold, affectedPositions);\n\n      expect(mockNotificationService.sendHighCorrelationWarning).toHaveBeenCalledWith({\n        correlationScore,\n        threshold,\n        affectedPositions,\n      });\n    });\n  });\n\n  describe('sendSweepNotification', () => {\n    it('should call sendSweepNotification with correct data', async () => {\n      const amount = 500;\n      const fromWallet = 'FUTURES';\n      const toWallet = 'SPOT';\n      const reason = 'Automated profit sweep';\n      const newBalance = 1500;\n\n      await handler.sendSweepNotification(amount, fromWallet, toWallet, reason, newBalance);\n\n      expect(mockNotificationService.sendSweepNotification).toHaveBeenCalledWith({\n        amount,\n        fromWallet,\n        toWallet,\n        reason,\n        newBalance,\n      });\n    });\n  });\n\n  describe('sendVetoNotification', () => {\n    it('should call sendVetoNotification with correct data', async () => {\n      const phaseId = 'phase1' as const;\n      const signalId = 'signal_123';\n      const symbol = 'BTCUSDT';\n      const reason = 'Leverage cap exceeded';\n      const requestedSize = 1000;\n\n      await handler.sendVetoNotification(phaseId, signalId, symbol, reason, requestedSize);\n\n      expect(mockNotificationService.sendVetoNotification).toHaveBeenCalledWith({\n        phaseId,\n        signalId,\n        symbol,\n        reason,\n        requestedSize,\n      });\n    });\n  });\n\n  describe('sendSystemError', () => {\n    it('should call sendSystemError with correct data', async () => {\n      const error = 'Database connection failed';\n      const context = { component: 'DatabaseManager' };\n\n      await handler.sendSystemError(error, context);\n\n      expect(mockNotificationService.sendSystemError).toHaveBeenCalledWith(error, context);\n    });\n  });\n\n  describe('testNotifications', () => {\n    it('should call testNotifications on the service', async () => {\n      const result = await handler.testNotifications();\n\n      expect(mockNotificationService.testNotifications).toHaveBeenCalled();\n      expect(result).toEqual({ telegram: true, email: false });\n    });\n  });\n\n  describe('updateConfig', () => {\n    it('should call updateConfig on the service', () => {\n      const newConfig: NotificationConfig = {\n        telegram: { enabled: false },\n        email: { enabled: true, smtpHost: 'smtp.test.com' },\n      };\n\n      handler.updateConfig(newConfig);\n\n      expect(mockNotificationService.updateConfig).toHaveBeenCalledWith(newConfig);\n    });\n  });\n});"],"version":3}
{"file":"/Users/ivan/Code/trading/titan/services/titan-brain/src/engine/TitanBrain.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-brain/src/engine/TitanBrain.ts"],"sourcesContent":["/**\n * TitanBrain - Master Orchestrator for Titan Trading System\n * Integrates all components: Allocation, Performance, Risk, Capital, and Circuit Breaker\n *\n * Requirements: 1.1, 1.7, 7.1, 7.2, 7.3, 7.4, 7.5, 7.6\n */\n\nimport {\n  AllocationVector,\n  BrainConfig,\n  BrainDecision,\n  BreakerStatus,\n  DashboardData,\n  DecisionRecord,\n  HealthStatus,\n  IntentSignal,\n  PhaseId,\n  PhasePerformance,\n  Position,\n  QueuedSignal,\n  RiskDecision,\n  RiskMetrics,\n  TreasuryStatus,\n} from \"../types/index.js\";\nimport { AllocationEngine } from \"./AllocationEngine.js\";\nimport { PerformanceTracker } from \"./PerformanceTracker.js\";\nimport { HighCorrelationNotifier, RiskGuardian } from \"./RiskGuardian.js\";\nimport { CapitalFlowManager, SweepNotifier } from \"./CapitalFlowManager.js\";\nimport {\n  BreakerEventPersistence,\n  CircuitBreaker,\n  NotificationHandler,\n  PositionClosureHandler,\n} from \"./CircuitBreaker.js\";\nimport {\n  RecoveredState,\n  StateRecoveryService,\n} from \"./StateRecoveryService.js\";\nimport { getMetrics } from \"../monitoring/PrometheusMetrics.js\";\nimport { ManualOverrideService } from \"./ManualOverrideService.js\";\nimport { DatabaseManager } from \"../db/DatabaseManager.js\";\n\n/**\n * Phase priority for signal processing\n * Requirement 7.1: P3 > P2 > P1\n */\nconst PHASE_PRIORITY: Record<PhaseId, number> = {\n  phase3: 3,\n  phase2: 2,\n  phase1: 1,\n};\n\n/**\n * Interface for execution engine communication\n */\nexport interface ExecutionEngineClient {\n  forwardSignal(signal: IntentSignal, authorizedSize: number): Promise<void>;\n  closeAllPositions(): Promise<void>;\n  getPositions(): Promise<Position[]>;\n}\n\n/**\n * Interface for phase notification\n */\nexport interface PhaseNotifier {\n  notifyVeto(phaseId: PhaseId, signalId: string, reason: string): Promise<void>;\n}\n\n/**\n * TitanBrain orchestrates all components and processes signals\n */\nexport class TitanBrain\n  implements PositionClosureHandler, BreakerEventPersistence {\n  private readonly config: BrainConfig;\n  private readonly allocationEngine: AllocationEngine;\n  private readonly performanceTracker: PerformanceTracker;\n  private readonly riskGuardian: RiskGuardian;\n  private readonly capitalFlowManager: CapitalFlowManager;\n  private readonly circuitBreaker: CircuitBreaker;\n  private readonly stateRecoveryService: StateRecoveryService | null;\n  private readonly manualOverrideService: ManualOverrideService | null;\n  private readonly db: DatabaseManager | null;\n\n  /** External integrations */\n  private executionEngine: ExecutionEngineClient | null = null;\n  private phaseNotifier: PhaseNotifier | null = null;\n  private notificationHandler: NotificationHandler | null = null;\n\n  /** Signal queue for priority processing */\n  private signalQueue: QueuedSignal[] = [];\n\n  /** Current state */\n  private currentEquity: number = 0;\n  private currentPositions: Position[] = [];\n  private recentDecisions: BrainDecision[] = [];\n  private dailyStartEquity: number = 0;\n  private recentTrades: Array<{ pnl: number; timestamp: number }> = [];\n\n  /** Dashboard cache */\n  private dashboardCache: DashboardData | null = null;\n  private dashboardCacheTime: number = 0;\n\n  /** Metrics update timer */\n  private metricsUpdateTimer: NodeJS.Timeout | null = null;\n\n  /** Signal approval tracking per phase */\n  private signalStats: Record<PhaseId, { approved: number; total: number }> = {\n    phase1: { approved: 0, total: 0 },\n    phase2: { approved: 0, total: 0 },\n    phase3: { approved: 0, total: 0 },\n  };\n\n  constructor(\n    config: BrainConfig,\n    allocationEngine: AllocationEngine,\n    performanceTracker: PerformanceTracker,\n    riskGuardian: RiskGuardian,\n    capitalFlowManager: CapitalFlowManager,\n    circuitBreaker: CircuitBreaker,\n    db?: DatabaseManager,\n    stateRecoveryService?: StateRecoveryService,\n    manualOverrideService?: ManualOverrideService,\n  ) {\n    this.config = config;\n    this.allocationEngine = allocationEngine;\n    this.performanceTracker = performanceTracker;\n    this.riskGuardian = riskGuardian;\n    this.capitalFlowManager = capitalFlowManager;\n    this.circuitBreaker = circuitBreaker;\n    this.db = db ?? null;\n    this.stateRecoveryService = stateRecoveryService ?? null;\n    this.manualOverrideService = manualOverrideService ?? null;\n\n    // Wire up circuit breaker handlers\n    this.circuitBreaker.setPositionHandler(this);\n    this.circuitBreaker.setEventPersistence(this);\n  }\n\n  /**\n   * Initialize the brain and start metric updates\n   * Requirement 9.4, 9.5: Load state and recalculate metrics on startup\n   */\n  async initialize(): Promise<void> {\n    console.log(\"üß† Initializing Titan Brain...\");\n\n    // Recover system state on startup\n    if (this.stateRecoveryService) {\n      console.log(\"üìä Recovering system state...\");\n      const recoveredState = await this.stateRecoveryService.recoverState();\n\n      // Validate recovered state\n      if (!this.stateRecoveryService.validateRecoveredState(recoveredState)) {\n        console.warn(\"‚ö†Ô∏è Recovered state validation failed, using defaults\");\n      } else {\n        console.log(\"‚úÖ State recovery completed successfully\");\n\n        // Apply recovered allocation if available\n        if (recoveredState.allocation) {\n          console.log(\n            `üìà Restored allocation: w1=${recoveredState.allocation.w1}, w2=${recoveredState.allocation.w2}, w3=${recoveredState.allocation.w3}`,\n          );\n        }\n\n        // Apply recovered high watermark\n        if (recoveredState.highWatermark > 0) {\n          await this.capitalFlowManager.setHighWatermark(\n            recoveredState.highWatermark,\n          );\n          console.log(\n            `üí∞ Restored high watermark: $${recoveredState.highWatermark}`,\n          );\n        }\n\n        // Apply recovered performance metrics\n        for (\n          const [phaseId, performance] of Object.entries(\n            recoveredState.performance,\n          )\n        ) {\n          console.log(\n            `üìä Restored performance for ${phaseId}: Sharpe=${\n              performance.sharpeRatio.toFixed(2)\n            }, Modifier=${performance.modifier.toFixed(2)}`,\n          );\n        }\n      }\n\n      // Recalculate risk metrics with current positions\n      // Requirement 9.5: Recalculate all risk metrics before accepting new signals\n      if (this.currentPositions.length > 0) {\n        console.log(\"üîç Recalculating risk metrics with current positions...\");\n        const riskMetrics = this.stateRecoveryService.recalculateRiskMetrics(\n          this.currentPositions,\n          this.currentEquity,\n        );\n        console.log(\"‚úÖ Risk metrics recalculated\");\n      }\n    }\n\n    // Initialize manual override service\n    if (this.manualOverrideService) {\n      await this.manualOverrideService.initialize();\n      console.log(\"üîß Manual override service initialized\");\n    }\n\n    // Initialize capital flow manager\n    await this.capitalFlowManager.initialize();\n\n    // Load daily start equity\n    this.dailyStartEquity = this.currentEquity;\n    this.circuitBreaker.setDailyStartEquity(this.dailyStartEquity);\n\n    // Start periodic metric updates\n    this.startMetricUpdates();\n\n    console.log(\"üß† Titan Brain initialization completed\");\n  }\n\n  /**\n   * Shutdown the brain gracefully\n   */\n  async shutdown(): Promise<void> {\n    if (this.metricsUpdateTimer) {\n      clearInterval(this.metricsUpdateTimer);\n      this.metricsUpdateTimer = null;\n    }\n  }\n\n  /**\n   * Set the execution engine client\n   */\n  setExecutionEngine(client: ExecutionEngineClient): void {\n    this.executionEngine = client;\n  }\n\n  /**\n   * Set the phase notifier\n   */\n  setPhaseNotifier(notifier: PhaseNotifier): void {\n    this.phaseNotifier = notifier;\n  }\n\n  /**\n   * Set the notification handler\n   */\n  setNotificationHandler(handler: NotificationHandler): void {\n    this.notificationHandler = handler;\n    this.circuitBreaker.setNotificationHandler(handler);\n\n    // Set correlation notifier if handler supports it\n    if (\"sendHighCorrelationWarning\" in handler) {\n      this.riskGuardian.setCorrelationNotifier(handler as any);\n    }\n\n    // Set sweep notifier if handler supports it\n    if (\"sendSweepNotification\" in handler) {\n      this.capitalFlowManager.setSweepNotifier(handler as any);\n    }\n  }\n\n  /**\n   * Update current equity\n   */\n  setEquity(equity: number): void {\n    this.currentEquity = Math.max(0, equity);\n    this.riskGuardian.setEquity(this.currentEquity);\n  }\n\n  /**\n   * Update current positions\n   */\n  setPositions(positions: Position[]): void {\n    this.currentPositions = positions;\n  }\n\n  /**\n   * Set daily start equity (called at start of trading day)\n   */\n  setDailyStartEquity(equity: number): void {\n    this.dailyStartEquity = Math.max(0, equity);\n    this.circuitBreaker.setDailyStartEquity(this.dailyStartEquity);\n  }\n\n  /**\n   * Process an intent signal through the full pipeline\n   * Requirement 7.5: Maximum latency of 100ms\n   *\n   * Pipeline:\n   * 1. Check circuit breaker\n   * 2. Get allocation weights\n   * 3. Apply performance modifiers\n   * 4. Check risk constraints\n   * 5. Calculate authorized size\n   * 6. Forward to execution or veto\n   *\n   * @param signal - Intent signal from a phase\n   * @returns BrainDecision with approval status\n   */\n  async processSignal(signal: IntentSignal): Promise<BrainDecision> {\n    const startTime = Date.now();\n    const timestamp = startTime;\n\n    // Check circuit breaker first\n    if (this.circuitBreaker.isActive()) {\n      const decision = this.createVetoDecision(\n        signal,\n        \"Circuit breaker active: all signals rejected\",\n        timestamp,\n      );\n      await this.recordDecision(decision, signal);\n      return decision;\n    }\n\n    // Check breaker conditions with current state\n    const breakerStatus = this.circuitBreaker.checkConditions({\n      equity: this.currentEquity,\n      positions: this.currentPositions,\n      dailyStartEquity: this.dailyStartEquity,\n      recentTrades: this.recentTrades,\n    });\n\n    if (breakerStatus.active) {\n      const decision = this.createVetoDecision(\n        signal,\n        `Circuit breaker triggered: ${breakerStatus.reason}`,\n        timestamp,\n      );\n      await this.recordDecision(decision, signal);\n      return decision;\n    }\n\n    // Get allocation weights (with manual override if active)\n    const allocation = this.getAllocation();\n\n    // Get performance modifier for the phase\n    const performance = await this.performanceTracker.getPhasePerformance(\n      signal.phaseId,\n    );\n\n    // Calculate base allocation for this phase\n    const phaseWeight = this.getPhaseWeight(signal.phaseId, allocation);\n    const adjustedWeight = phaseWeight * performance.modifier;\n\n    // Calculate max position size based on allocation\n    // Requirement 1.7: Cap position size at Equity * Phase_Weight\n    const maxPositionSize = this.currentEquity * adjustedWeight;\n\n    // Check risk constraints\n    const riskDecision = this.riskGuardian.checkSignal(\n      signal,\n      this.currentPositions,\n    );\n\n    // Determine final authorized size\n    let authorizedSize: number;\n    let approved: boolean;\n    let reason: string;\n\n    if (!riskDecision.approved) {\n      // Risk veto\n      approved = false;\n      authorizedSize = 0;\n      reason = riskDecision.reason;\n    } else {\n      // Apply all constraints\n      const riskAdjustedSize = riskDecision.adjustedSize ??\n        signal.requestedSize;\n      authorizedSize = Math.min(\n        signal.requestedSize,\n        maxPositionSize,\n        riskAdjustedSize,\n      );\n\n      // Requirement 1.7: Position size consistency\n      if (authorizedSize <= 0) {\n        approved = false;\n        authorizedSize = 0;\n        reason = \"Authorized size is zero after applying constraints\";\n      } else {\n        approved = true;\n        reason = this.buildApprovalReason(\n          signal.requestedSize,\n          authorizedSize,\n          maxPositionSize,\n          riskDecision,\n        );\n      }\n    }\n\n    const decision: BrainDecision = {\n      signalId: signal.signalId,\n      approved,\n      authorizedSize,\n      reason,\n      allocation,\n      performance,\n      risk: riskDecision,\n      timestamp,\n    };\n\n    // Record decision\n    await this.recordDecision(decision, signal);\n\n    // Update signal stats\n    this.updateSignalStats(signal.phaseId, approved);\n\n    // Forward to execution or notify veto\n    if (approved && this.executionEngine) {\n      await this.executionEngine.forwardSignal(signal, authorizedSize);\n    } else if (!approved) {\n      // Requirement 7.6: Notify originating phase of veto\n      if (this.phaseNotifier) {\n        await this.phaseNotifier.notifyVeto(\n          signal.phaseId,\n          signal.signalId,\n          reason,\n        );\n      }\n\n      // Send veto notification via notification service\n      if (\n        this.notificationHandler &&\n        \"sendVetoNotification\" in this.notificationHandler\n      ) {\n        try {\n          await (this.notificationHandler as any).sendVetoNotification(\n            signal.phaseId,\n            signal.signalId,\n            signal.symbol,\n            reason,\n            signal.requestedSize,\n          );\n        } catch (error) {\n          console.error(\"Failed to send veto notification:\", error);\n        }\n      }\n    }\n\n    // Check processing latency and record metrics\n    const processingTime = Date.now() - startTime;\n    if (processingTime > this.config.signalTimeout) {\n      console.warn(\n        `Signal processing exceeded timeout: ${processingTime}ms > ${this.config.signalTimeout}ms`,\n      );\n    }\n\n    // Record metrics\n    const metrics = getMetrics();\n    metrics.recordSignalLatency(signal.phaseId, processingTime, approved);\n\n    return decision;\n  }\n\n  /**\n   * Process multiple signals with priority ordering\n   * Requirement 7.1: Process in priority order (P3 > P2 > P1)\n   *\n   * @param signals - Array of intent signals\n   * @returns Array of brain decisions\n   */\n  async processSignals(signals: IntentSignal[]): Promise<BrainDecision[]> {\n    // Sort by priority (highest first)\n    const sortedSignals = [...signals].sort((a, b) => {\n      return PHASE_PRIORITY[b.phaseId] - PHASE_PRIORITY[a.phaseId];\n    });\n\n    const decisions: BrainDecision[] = [];\n\n    for (const signal of sortedSignals) {\n      const decision = await this.processSignal(signal);\n      decisions.push(decision);\n\n      // Update positions after each approved signal\n      if (decision.approved && this.executionEngine) {\n        this.currentPositions = await this.executionEngine.getPositions();\n      }\n    }\n\n    return decisions;\n  }\n\n  /**\n   * Enqueue a signal for processing\n   * Requirement 7.4: Maintain signal queue with timestamps and phase source\n   *\n   * @param signal - Intent signal to enqueue\n   */\n  enqueueSignal(signal: IntentSignal): void {\n    if (this.signalQueue.length >= this.config.maxQueueSize) {\n      // Remove oldest signal\n      this.signalQueue.shift();\n    }\n\n    this.signalQueue.push({\n      signal,\n      priority: PHASE_PRIORITY[signal.phaseId],\n      enqueuedAt: Date.now(),\n    });\n\n    // Sort queue by priority\n    this.signalQueue.sort((a, b) => b.priority - a.priority);\n  }\n\n  /**\n   * Process all queued signals\n   */\n  async processQueue(): Promise<BrainDecision[]> {\n    const signals = this.signalQueue.map((q) => q.signal);\n    this.signalQueue = [];\n    return this.processSignals(signals);\n  }\n\n  /**\n   * Update all metrics periodically\n   * Requirement 1.1: Recalculate allocation every 1 minute or on trade close\n   */\n  async updateMetrics(): Promise<void> {\n    // Update allocation\n    const allocation = this.allocationEngine.getWeights(this.currentEquity);\n\n    // Update capital flow target allocation\n    const futuresAllocation = this.currentEquity *\n      (allocation.w1 + allocation.w2);\n    this.capitalFlowManager.setTargetAllocation(futuresAllocation);\n\n    // Update high watermark\n    await this.capitalFlowManager.updateHighWatermark(this.currentEquity);\n\n    // Check sweep conditions\n    await this.capitalFlowManager.performSweepIfNeeded();\n\n    // Invalidate dashboard cache\n    this.dashboardCache = null;\n\n    // Update Prometheus metrics\n    const metrics = getMetrics();\n    metrics.updateEquity(this.currentEquity);\n    metrics.updateAllocation(allocation.w1, allocation.w2, allocation.w3);\n    metrics.updateCircuitBreakerStatus(this.circuitBreaker.isActive());\n    metrics.updateHighWatermark(this.capitalFlowManager.getHighWatermark());\n\n    // Update daily drawdown\n    const dailyDrawdown = this.dailyStartEquity > 0\n      ? ((this.dailyStartEquity - this.currentEquity) / this.dailyStartEquity) *\n        100\n      : 0;\n    metrics.updateDailyDrawdown(Math.max(0, dailyDrawdown));\n\n    // Update phase performance metrics\n    for (const phaseId of [\"phase1\", \"phase2\", \"phase3\"] as PhaseId[]) {\n      const performance = await this.performanceTracker.getPhasePerformance(\n        phaseId,\n      );\n      metrics.updatePhasePerformance(\n        phaseId,\n        performance.sharpeRatio,\n        performance.modifier,\n      );\n    }\n  }\n\n  /**\n   * Record a trade result\n   * Updates performance tracking and circuit breaker state\n   *\n   * @param phaseId - Phase that executed the trade\n   * @param pnl - Trade PnL\n   * @param symbol - Trading symbol\n   * @param side - Trade side\n   */\n  async recordTrade(\n    phaseId: PhaseId,\n    pnl: number,\n    symbol?: string,\n    side?: \"BUY\" | \"SELL\",\n  ): Promise<void> {\n    const timestamp = Date.now();\n\n    // Record in performance tracker\n    await this.performanceTracker.recordTrade(\n      phaseId,\n      pnl,\n      timestamp,\n      symbol,\n      side,\n    );\n\n    // Record for circuit breaker\n    this.recentTrades.push({ pnl, timestamp });\n    this.circuitBreaker.recordTrade(pnl, timestamp);\n\n    // Clean up old trades (keep last hour)\n    const oneHourAgo = timestamp - 3600000;\n    this.recentTrades = this.recentTrades.filter((t) =>\n      t.timestamp >= oneHourAgo\n    );\n\n    // Update metrics after trade\n    await this.updateMetrics();\n  }\n\n  /**\n   * Get dashboard data for UI\n   * Requirement 10.1-10.7: Dashboard visibility\n   *\n   * @returns DashboardData with all metrics\n   */\n  async getDashboardData(): Promise<DashboardData> {\n    // Check cache\n    if (\n      this.dashboardCache &&\n      Date.now() - this.dashboardCacheTime < this.config.dashboardCacheTTL\n    ) {\n      return this.dashboardCache;\n    }\n\n    // Get allocation\n    const allocation = this.allocationEngine.getWeights(this.currentEquity);\n\n    // Calculate phase equity\n    const phaseEquity: Record<PhaseId, number> = {\n      phase1: this.currentEquity * allocation.w1,\n      phase2: this.currentEquity * allocation.w2,\n      phase3: this.currentEquity * allocation.w3,\n    };\n\n    // Get risk metrics\n    const riskMetrics = this.riskGuardian.getRiskMetrics(this.currentPositions);\n\n    // Get treasury status\n    const treasury = await this.capitalFlowManager.getTreasuryStatus();\n\n    // Get circuit breaker status\n    const circuitBreaker = this.circuitBreaker.getStatus();\n\n    // Get recent decisions (last 20)\n    const recentDecisions = this.recentDecisions.slice(-20);\n\n    // Get manual override status\n    const manualOverride = this.getCurrentManualOverride();\n    const warningBannerActive = this.isWarningBannerActive();\n\n    const dashboardData: DashboardData = {\n      nav: this.currentEquity,\n      allocation,\n      phaseEquity,\n      riskMetrics: {\n        globalLeverage: riskMetrics.currentLeverage,\n        netDelta: riskMetrics.portfolioDelta,\n        correlationScore: riskMetrics.correlation,\n        portfolioBeta: riskMetrics.portfolioBeta,\n      },\n      treasury,\n      circuitBreaker,\n      recentDecisions,\n      lastUpdated: Date.now(),\n      manualOverride: manualOverride\n        ? {\n          active: true,\n          operatorId: manualOverride.operatorId,\n          reason: manualOverride.reason,\n          allocation: manualOverride.overrideAllocation,\n          expiresAt: manualOverride.expiresAt,\n        }\n        : null,\n      warningBannerActive,\n    };\n\n    // Cache the result\n    this.dashboardCache = dashboardData;\n    this.dashboardCacheTime = Date.now();\n\n    return dashboardData;\n  }\n\n  /**\n   * Get system health status\n   *\n   * @returns HealthStatus with component health\n   */\n  async getHealthStatus(): Promise<HealthStatus> {\n    const errors: string[] = [];\n    const components = {\n      database: false,\n      redis: false,\n      executionEngine: false,\n      phases: {\n        phase1: false,\n        phase2: false,\n        phase3: false,\n      } as Record<PhaseId, boolean>,\n    };\n\n    // Check database\n    if (this.db) {\n      try {\n        await this.db.query(\"SELECT 1\");\n        components.database = true;\n      } catch (error) {\n        errors.push(\n          `Database: ${\n            error instanceof Error ? error.message : \"Unknown error\"\n          }`,\n        );\n      }\n    } else {\n      // For Railway deployment without database, consider it healthy\n      components.database = true;\n    }\n\n    // Check execution engine (optional for Railway)\n    if (this.executionEngine) {\n      try {\n        await this.executionEngine.getPositions();\n        components.executionEngine = true;\n      } catch (error) {\n        errors.push(\n          `Execution Engine: ${\n            error instanceof Error ? error.message : \"Unknown error\"\n          }`,\n        );\n      }\n    } else {\n      // For Railway deployment without execution engine, consider it healthy\n      components.executionEngine = true;\n    }\n\n    // Check phase approval rates\n    // Requirement 7.8: Flag for review if approval rate < 50%\n    for (const phaseId of [\"phase1\", \"phase2\", \"phase3\"] as PhaseId[]) {\n      const stats = this.signalStats[phaseId];\n      if (stats.total > 0) {\n        const approvalRate = stats.approved / stats.total;\n        components.phases[phaseId] = approvalRate >= 0.5;\n        if (approvalRate < 0.5) {\n          errors.push(\n            `${phaseId}: Approval rate ${\n              (approvalRate * 100).toFixed(1)\n            }% < 50%`,\n          );\n        }\n      } else {\n        components.phases[phaseId] = true; // No signals yet\n      }\n    }\n\n    // For Railway deployment, be more lenient with health checks\n    const isRailwayDeployment = process.env.RAILWAY_ENVIRONMENT === \"true\";\n    const healthy = isRailwayDeployment\n      ? // Railway: Just check that the service is running (phases are healthy)\n      Object.values(components.phases).every(Boolean)\n      : // Local: Check all components\n      components.database &&\n      components.executionEngine &&\n      Object.values(components.phases).every(Boolean);\n\n    return {\n      healthy,\n      components,\n      lastCheck: Date.now(),\n      errors,\n    };\n  }\n\n  /**\n   * Get signal approval rate for a phase\n   * Requirement 7.7: Track signal approval rate per phase\n   *\n   * @param phaseId - Phase to check\n   * @returns Approval rate (0-1)\n   */\n  getApprovalRate(phaseId: PhaseId): number {\n    const stats = this.signalStats[phaseId];\n    if (stats.total === 0) return 1.0;\n    return stats.approved / stats.total;\n  }\n\n  /**\n   * Get all phase approval rates\n   */\n  getAllApprovalRates(): Record<PhaseId, number> {\n    return {\n      phase1: this.getApprovalRate(\"phase1\"),\n      phase2: this.getApprovalRate(\"phase2\"),\n      phase3: this.getApprovalRate(\"phase3\"),\n    };\n  }\n\n  /**\n   * Reset signal stats (e.g., at start of day)\n   */\n  resetSignalStats(): void {\n    this.signalStats = {\n      phase1: { approved: 0, total: 0 },\n      phase2: { approved: 0, total: 0 },\n      phase3: { approved: 0, total: 0 },\n    };\n  }\n\n  /**\n   * Get current allocation vector (with manual override if active)\n   * Requirement 9.7: Support manual override of allocation weights\n   */\n  getAllocation(): AllocationVector {\n    const normalAllocation = this.allocationEngine.getWeights(\n      this.currentEquity,\n    );\n\n    // Apply manual override if active\n    if (this.manualOverrideService) {\n      return this.manualOverrideService.getEffectiveAllocation(\n        normalAllocation,\n      );\n    }\n\n    return normalAllocation;\n  }\n\n  /**\n   * Get current equity\n   */\n  getEquity(): number {\n    return this.currentEquity;\n  }\n\n  /**\n   * Get current positions\n   */\n  getPositions(): Position[] {\n    return [...this.currentPositions];\n  }\n\n  /**\n   * Get circuit breaker status\n   */\n  getCircuitBreakerStatus(): BreakerStatus {\n    return this.circuitBreaker.getStatus();\n  }\n\n  /**\n   * Manually reset circuit breaker\n   * Requirement 5.8: Require operator ID\n   *\n   * @param operatorId - ID of operator performing reset\n   */\n  async resetCircuitBreaker(operatorId: string): Promise<void> {\n    await this.circuitBreaker.reset(operatorId);\n  }\n\n  /**\n   * Get configuration\n   */\n  getConfig(): BrainConfig {\n    return { ...this.config };\n  }\n\n  /**\n   * Create a manual allocation override\n   * Requirement 9.7: Create admin endpoint for allocation override\n   *\n   * @param operatorId - Operator creating the override\n   * @param password - Operator password\n   * @param allocation - New allocation vector\n   * @param reason - Reason for override\n   * @param durationHours - Optional duration in hours\n   * @returns True if override created successfully\n   */\n  async createManualOverride(\n    operatorId: string,\n    password: string,\n    allocation: AllocationVector,\n    reason: string,\n    durationHours?: number,\n  ): Promise<boolean> {\n    if (!this.manualOverrideService) {\n      console.error(\"Manual override service not available\");\n      return false;\n    }\n\n    // Authenticate operator\n    const authenticated = await this.manualOverrideService.authenticateOperator(\n      operatorId,\n      password,\n    );\n    if (!authenticated) {\n      console.warn(\n        `Manual override rejected: authentication failed for operator ${operatorId}`,\n      );\n      return false;\n    }\n\n    // Create override\n    const override = await this.manualOverrideService.createOverride({\n      operatorId,\n      allocation,\n      reason,\n      durationHours,\n    });\n\n    if (override) {\n      console.log(`‚úÖ Manual override created by operator ${operatorId}`);\n      console.log(\n        `   New allocation: w1=${allocation.w1}, w2=${allocation.w2}, w3=${allocation.w3}`,\n      );\n      console.log(`   Reason: ${reason}`);\n\n      // Invalidate dashboard cache to show warning banner\n      this.dashboardCache = null;\n\n      return true;\n    }\n\n    return false;\n  }\n\n  /**\n   * Deactivate the current manual override\n   *\n   * @param operatorId - Operator deactivating the override\n   * @param password - Operator password\n   * @returns True if successfully deactivated\n   */\n  async deactivateManualOverride(\n    operatorId: string,\n    password: string,\n  ): Promise<boolean> {\n    if (!this.manualOverrideService) {\n      console.error(\"Manual override service not available\");\n      return false;\n    }\n\n    // Authenticate operator\n    const authenticated = await this.manualOverrideService.authenticateOperator(\n      operatorId,\n      password,\n    );\n    if (!authenticated) {\n      console.warn(\n        `Manual override deactivation rejected: authentication failed for operator ${operatorId}`,\n      );\n      return false;\n    }\n\n    const success = await this.manualOverrideService.deactivateOverride(\n      operatorId,\n    );\n\n    if (success) {\n      console.log(`‚úÖ Manual override deactivated by operator ${operatorId}`);\n\n      // Invalidate dashboard cache to hide warning banner\n      this.dashboardCache = null;\n    }\n\n    return success;\n  }\n\n  /**\n   * Get current manual override status\n   *\n   * @returns Current override or null if none active\n   */\n  getCurrentManualOverride() {\n    if (!this.manualOverrideService) return null;\n    return this.manualOverrideService.getCurrentOverride();\n  }\n\n  /**\n   * Check if warning banner should be displayed\n   * Requirement 9.8: Implement warning banner flag\n   *\n   * @returns True if warning banner should be shown\n   */\n  isWarningBannerActive(): boolean {\n    if (!this.manualOverrideService) return false;\n    return this.manualOverrideService.isWarningBannerActive();\n  }\n\n  /**\n   * Get manual override history\n   *\n   * @param operatorId - Optional operator filter\n   * @param limit - Maximum number of records\n   * @returns Array of historical overrides\n   */\n  async getManualOverrideHistory(operatorId?: string, limit: number = 50) {\n    if (!this.manualOverrideService) return [];\n    return this.manualOverrideService.getOverrideHistory(operatorId, limit);\n  }\n\n  /**\n   * Create a new operator account\n   *\n   * @param operatorId - Unique operator identifier\n   * @param password - Operator password\n   * @param permissions - Array of permissions\n   * @returns True if created successfully\n   */\n  async createOperator(\n    operatorId: string,\n    password: string,\n    permissions: string[],\n  ): Promise<boolean> {\n    if (!this.manualOverrideService) {\n      console.error(\"Manual override service not available\");\n      return false;\n    }\n\n    return this.manualOverrideService.createOperator(\n      operatorId,\n      password,\n      permissions,\n    );\n  }\n\n  // ============ PositionClosureHandler Implementation ============\n\n  /**\n   * Close all positions (called by circuit breaker)\n   */\n  async closeAllPositions(): Promise<void> {\n    if (this.executionEngine) {\n      await this.executionEngine.closeAllPositions();\n      this.currentPositions = [];\n    }\n  }\n\n  // ============ BreakerEventPersistence Implementation ============\n\n  /**\n   * Persist circuit breaker event to database\n   */\n  async persistEvent(event: {\n    timestamp: number;\n    eventType: \"TRIGGER\" | \"RESET\";\n    breakerType?: string;\n    reason: string;\n    equity: number;\n    operatorId?: string;\n    metadata?: Record<string, unknown>;\n  }): Promise<void> {\n    if (!this.db) return;\n\n    await this.db.query(\n      `INSERT INTO circuit_breaker_events \n       (timestamp, event_type, reason, equity, operator_id, metadata)\n       VALUES ($1, $2, $3, $4, $5, $6)`,\n      [\n        event.timestamp,\n        event.eventType,\n        event.reason,\n        event.equity,\n        event.operatorId ?? null,\n        event.metadata ? JSON.stringify(event.metadata) : null,\n      ],\n    );\n  }\n\n  // ============ Private Helper Methods ============\n\n  /**\n   * Start periodic metric updates\n   */\n  private startMetricUpdates(): void {\n    if (this.metricsUpdateTimer) {\n      clearInterval(this.metricsUpdateTimer);\n    }\n\n    this.metricsUpdateTimer = setInterval(async () => {\n      try {\n        await this.updateMetrics();\n      } catch (error) {\n        console.error(\"Error updating metrics:\", error);\n      }\n    }, this.config.metricUpdateInterval);\n  }\n\n  /**\n   * Get phase weight from allocation vector\n   */\n  private getPhaseWeight(\n    phaseId: PhaseId,\n    allocation: AllocationVector,\n  ): number {\n    switch (phaseId) {\n      case \"phase1\":\n        return allocation.w1;\n      case \"phase2\":\n        return allocation.w2;\n      case \"phase3\":\n        return allocation.w3;\n      default:\n        return 0;\n    }\n  }\n\n  /**\n   * Create a veto decision\n   */\n  private createVetoDecision(\n    signal: IntentSignal,\n    reason: string,\n    timestamp: number,\n  ): BrainDecision {\n    const allocation = this.allocationEngine.getWeights(this.currentEquity);\n    const riskMetrics = this.riskGuardian.getRiskMetrics(this.currentPositions);\n\n    return {\n      signalId: signal.signalId,\n      approved: false,\n      authorizedSize: 0,\n      reason,\n      allocation,\n      performance: {\n        phaseId: signal.phaseId,\n        sharpeRatio: 0,\n        totalPnL: 0,\n        tradeCount: 0,\n        winRate: 0,\n        avgWin: 0,\n        avgLoss: 0,\n        modifier: 1.0,\n      },\n      risk: {\n        approved: false,\n        reason,\n        riskMetrics,\n      },\n      timestamp,\n    };\n  }\n\n  /**\n   * Build approval reason string\n   */\n  private buildApprovalReason(\n    requestedSize: number,\n    authorizedSize: number,\n    maxPositionSize: number,\n    riskDecision: RiskDecision,\n  ): string {\n    const parts: string[] = [\"Signal approved\"];\n\n    if (authorizedSize < requestedSize) {\n      const reductions: string[] = [];\n\n      if (\n        authorizedSize <= maxPositionSize && requestedSize > maxPositionSize\n      ) {\n        reductions.push(`allocation cap (${maxPositionSize.toFixed(2)})`);\n      }\n\n      if (\n        riskDecision.adjustedSize && riskDecision.adjustedSize < requestedSize\n      ) {\n        reductions.push(`risk adjustment`);\n      }\n\n      if (reductions.length > 0) {\n        parts.push(`with size reduction due to ${reductions.join(\", \")}`);\n      }\n    }\n\n    return parts.join(\" \");\n  }\n\n  /**\n   * Record a decision to database and memory\n   */\n  private async recordDecision(\n    decision: BrainDecision,\n    signal: IntentSignal,\n  ): Promise<void> {\n    // Add to recent decisions\n    this.recentDecisions.push(decision);\n\n    // Keep only last 100 decisions in memory\n    if (this.recentDecisions.length > 100) {\n      this.recentDecisions.shift();\n    }\n\n    // Persist to database\n    if (this.db) {\n      const record: DecisionRecord = {\n        signalId: signal.signalId,\n        phaseId: signal.phaseId,\n        timestamp: decision.timestamp,\n        approved: decision.approved,\n        requestedSize: signal.requestedSize,\n        authorizedSize: decision.approved ? decision.authorizedSize : null,\n        reason: decision.reason,\n        riskMetrics: decision.risk.riskMetrics,\n      };\n\n      await this.db.query(\n        `INSERT INTO brain_decisions \n         (signal_id, phase_id, timestamp, approved, requested_size, authorized_size, reason, risk_metrics)\n         VALUES ($1, $2, $3, $4, $5, $6, $7, $8)\n         ON CONFLICT (signal_id) DO NOTHING`,\n        [\n          record.signalId,\n          record.phaseId,\n          record.timestamp,\n          record.approved,\n          record.requestedSize,\n          record.authorizedSize,\n          record.reason,\n          record.riskMetrics ? JSON.stringify(record.riskMetrics) : null,\n        ],\n      );\n    }\n  }\n\n  /**\n   * Update signal statistics\n   */\n  private updateSignalStats(phaseId: PhaseId, approved: boolean): void {\n    this.signalStats[phaseId].total++;\n    if (approved) {\n      this.signalStats[phaseId].approved++;\n    }\n  }\n\n  /**\n   * Calculate net position for opposite signals\n   * Requirement 7.3: Calculate net position for opposite signals on same asset\n   *\n   * @param signals - Array of signals for the same asset\n   * @returns Net position size and direction\n   */\n  calculateNetPosition(\n    signals: IntentSignal[],\n  ): { netSize: number; side: \"BUY\" | \"SELL\" | \"NEUTRAL\" } {\n    let netSize = 0;\n\n    for (const signal of signals) {\n      if (signal.side === \"BUY\") {\n        netSize += signal.requestedSize;\n      } else {\n        netSize -= signal.requestedSize;\n      }\n    }\n\n    if (netSize > 0) {\n      return { netSize, side: \"BUY\" };\n    } else if (netSize < 0) {\n      return { netSize: Math.abs(netSize), side: \"SELL\" };\n    } else {\n      return { netSize: 0, side: \"NEUTRAL\" };\n    }\n  }\n\n  /**\n   * Get recent decisions\n   *\n   * @param limit - Maximum number of decisions to return\n   * @returns Array of recent decisions\n   */\n  getRecentDecisions(limit: number = 20): BrainDecision[] {\n    return this.recentDecisions.slice(-limit);\n  }\n\n  /**\n   * Export dashboard data to JSON\n   * Requirement 10.8: Support exporting dashboard data to JSON\n   *\n   * @returns JSON string of dashboard data\n   */\n  async exportDashboardJSON(): Promise<string> {\n    const data = await this.getDashboardData();\n    return JSON.stringify(data, null, 2);\n  }\n\n  /**\n   * Get performance for all phases\n   */\n  async getAllPhasePerformance(): Promise<PhasePerformance[]> {\n    return this.performanceTracker.getAllPhasePerformance();\n  }\n\n  /**\n   * Get treasury status\n   */\n  async getTreasuryStatus(): Promise<TreasuryStatus> {\n    return this.capitalFlowManager.getTreasuryStatus();\n  }\n\n  /**\n   * Get next sweep trigger level\n   */\n  getNextSweepTriggerLevel(): number {\n    return this.capitalFlowManager.getNextSweepTriggerLevel();\n  }\n\n  /**\n   * Get total swept amount\n   */\n  getTotalSwept(): number {\n    return this.capitalFlowManager.getTotalSwept();\n  }\n\n  /**\n   * Get high watermark\n   */\n  getHighWatermark(): number {\n    return this.capitalFlowManager.getHighWatermark();\n  }\n\n  /**\n   * Update price history for correlation calculations\n   *\n   * @param symbol - Asset symbol\n   * @param price - Current price\n   */\n  updatePriceHistory(symbol: string, price: number): void {\n    this.riskGuardian.updatePriceHistory(symbol, price);\n  }\n  /**\n   * Get database manager\n   */\n  getDatabaseManager(): DatabaseManager | null {\n    return this.db;\n  }\n}\n"],"version":3}
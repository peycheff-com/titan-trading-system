e6f3a9f11fc7d04a91351c3078bd5559
"use strict";
/**
 * CacheManager - Redis with in-memory fallback strategy
 *
 * Provides reliable caching with Redis as primary and in-memory as fallback.
 * Handles Redis unavailability gracefully.
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.CacheManager = exports.DEFAULT_CACHE_CONFIG = exports.CacheNamespace = void 0;
const events_1 = require("events");
const redis_1 = require("redis");
const InMemoryCache_js_1 = require("./InMemoryCache.js");
/**
 * Cache namespaces
 */
var CacheNamespace;
(function (CacheNamespace) {
    CacheNamespace["RISK"] = "risk";
    CacheNamespace["QUERY"] = "query";
    CacheNamespace["CORRELATION"] = "correlation";
    CacheNamespace["SESSION"] = "session";
    CacheNamespace["METRICS"] = "metrics";
    CacheNamespace["ALLOCATION"] = "allocation";
    CacheNamespace["PERFORMANCE"] = "performance";
})(CacheNamespace || (exports.CacheNamespace = CacheNamespace = {}));
/**
 * Default cache configuration
 */
exports.DEFAULT_CACHE_CONFIG = {
    enableInMemoryFallback: true,
    inMemoryMaxSize: 1000,
    inMemoryTtlMs: 300000,
    healthCheckIntervalMs: 30000,
    healthCheckTimeoutMs: 5000,
    maxReconnectAttempts: 5,
    reconnectDelayMs: 5000,
};
/**
 * Cache manager with Redis primary and in-memory fallback
 */
class CacheManager extends events_1.EventEmitter {
    redisClient = null;
    inMemoryCache;
    config;
    metrics;
    healthCheckInterval = null;
    isShuttingDown = false;
    operationCount = 0;
    totalResponseTime = 0;
    constructor(config = exports.DEFAULT_CACHE_CONFIG) {
        super();
        this.config = config;
        this.inMemoryCache = new InMemoryCache_js_1.InMemoryCache(config.inMemoryMaxSize, config.inMemoryTtlMs);
        this.metrics = {
            redisConnected: false,
            fallbackActive: false,
            totalOperations: 0,
            redisHits: 0,
            redisMisses: 0,
            memoryHits: 0,
            memoryMisses: 0,
            errors: 0,
        };
    }
    /**
     * Create cache configuration from environment variables
     */
    static createConfigFromEnv() {
        const redisUrl = process.env.REDIS_URL;
        let redisConfig = undefined;
        const redisDisabled = process.env.REDIS_DISABLED === "true";
        if (redisUrl && !redisDisabled) {
            redisConfig = { url: redisUrl };
        }
        else if (process.env.REDIS_HOST) {
            redisConfig = {
                host: process.env.REDIS_HOST,
                port: parseInt(process.env.REDIS_PORT || "6379"),
                password: process.env.REDIS_PASSWORD,
                db: parseInt(process.env.REDIS_DB || "0"),
            };
        }
        return {
            redis: redisConfig,
            enableInMemoryFallback: process.env.CACHE_ENABLE_MEMORY_FALLBACK !== "false",
            inMemoryMaxSize: parseInt(process.env.CACHE_MEMORY_MAX_SIZE || "1000"),
            inMemoryTtlMs: parseInt(process.env.CACHE_MEMORY_TTL || "300000"),
            healthCheckIntervalMs: parseInt(process.env.CACHE_HEALTH_CHECK_INTERVAL || "30000"),
            healthCheckTimeoutMs: parseInt(process.env.CACHE_HEALTH_CHECK_TIMEOUT || "5000"),
            maxReconnectAttempts: parseInt(process.env.CACHE_MAX_RECONNECT_ATTEMPTS || "5"),
            reconnectDelayMs: parseInt(process.env.CACHE_RECONNECT_DELAY || "5000"),
        };
    }
    /**
     * Initialize cache manager
     */
    async initialize() {
        this.inMemoryCache.initialize();
        if (this.config.redis) {
            await this.initializeRedis();
        }
        else {
            console.log("Redis not configured, using in-memory cache only");
            this.metrics.fallbackActive = true;
        }
        // Emit initialized event
        this.emit('initialized', {
            redisEnabled: !!this.config.redis,
            fallbackActive: this.metrics.fallbackActive
        });
    }
    async initializeRedis() {
        if (!this.config.redis)
            return;
        try {
            this.redisClient = (0, redis_1.createClient)({
                url: this.config.redis.url,
                socket: {
                    host: this.config.redis.host,
                    port: this.config.redis.port,
                },
            });
            this.redisClient.on("error", (err) => {
                console.error("Redis error:", err);
                this.metrics.redisConnected = false;
                this.metrics.fallbackActive = true;
            });
            this.redisClient.on("connect", () => {
                console.log("Redis connected");
                this.metrics.redisConnected = true;
                this.metrics.fallbackActive = false;
            });
            await this.redisClient.connect();
        }
        catch (error) {
            console.warn("Failed to connect to Redis, using fallback:", error);
            this.metrics.redisConnected = false;
            this.metrics.fallbackActive = true;
        }
    }
    /**
     * Generate namespaced key
     */
    getKey(namespace, key) {
        return `${namespace}:${key}`;
    }
    /**
     * Get value from cache
     * Supports both get(key) and get(namespace, key) signatures
     */
    async get(arg1, arg2) {
        const startTime = Date.now();
        let key;
        if (arg2) {
            key = this.getKey(arg1, arg2);
        }
        else {
            key = arg1;
        }
        this.metrics.totalOperations++;
        // Try Redis first
        if (this.redisClient && this.metrics.redisConnected) {
            try {
                const value = await this.redisClient.get(key);
                const duration = Date.now() - startTime;
                this.totalResponseTime += duration;
                if (value) {
                    this.metrics.redisHits++;
                    this.emit('cache:hit', { source: 'redis', key, duration });
                    return {
                        success: true,
                        value: JSON.parse(value),
                        source: 'redis'
                    };
                }
                else {
                    this.metrics.redisMisses++;
                    this.emit('cache:miss', { source: 'redis', key, duration });
                    return {
                        success: false,
                        source: 'redis'
                    };
                }
            }
            catch (err) {
                this.metrics.errors++;
                const duration = Date.now() - startTime;
                this.emit('cache:error', {
                    source: 'redis',
                    key,
                    error: err instanceof Error ? err.message : 'Unknown error',
                    duration
                });
                // Fall through to memory cache
            }
        }
        // Fallback to memory
        if (this.config.enableInMemoryFallback) {
            const value = this.inMemoryCache.get(key);
            const duration = Date.now() - startTime;
            this.totalResponseTime += duration;
            if (value !== undefined) {
                this.metrics.memoryHits++;
                this.emit('cache:hit', { source: 'memory', key, duration });
                return {
                    success: true,
                    value,
                    source: 'memory'
                };
            }
            else {
                this.metrics.memoryMisses++;
                this.emit('cache:miss', { source: 'memory', key, duration });
                return {
                    success: false,
                    source: 'memory'
                };
            }
        }
        return {
            success: false,
            source: 'none'
        };
    }
    /**
     * Set value in cache
     * Supports both set(key, value, ttl?) and set(namespace, key, value, ttl?)
     */
    async set(arg1, arg2, arg3, arg4) {
        let key;
        let value;
        let ttl;
        if (typeof arg2 === "string" && arg3 !== undefined) {
            // set(namespace, key, value, ttl?)
            key = this.getKey(arg1, arg2);
            value = arg3;
            ttl = arg4;
        }
        else {
            // set(key, value, ttl?)
            key = arg1;
            value = arg2;
            ttl = arg3;
        }
        const stringValue = JSON.stringify(value);
        this.metrics.totalOperations++;
        // Try Redis first
        if (this.redisClient && this.metrics.redisConnected) {
            try {
                if (ttl) {
                    await this.redisClient.setEx(key, ttl, stringValue);
                }
                else {
                    await this.redisClient.set(key, stringValue);
                }
                return {
                    success: true,
                    source: 'redis'
                };
            }
            catch (err) {
                this.metrics.errors++;
                console.error("Redis set error:", err);
                // Fall through to memory cache
            }
        }
        // Fallback to memory
        if (this.config.enableInMemoryFallback) {
            this.inMemoryCache.set(key, value, ttl ? ttl * 1000 : this.config.inMemoryTtlMs);
            return {
                success: true,
                source: 'memory'
            };
        }
        return {
            success: false,
            source: 'none',
            error: 'No cache backend available'
        };
    }
    /**
     * Delete value from cache
     * Supports delete(key) and delete(namespace, key)
     */
    async delete(arg1, arg2) {
        let key;
        if (arg2) {
            key = this.getKey(arg1, arg2);
        }
        else {
            key = arg1;
        }
        this.metrics.totalOperations++;
        let redisSuccess = false;
        let memorySuccess = false;
        if (this.redisClient && this.metrics.redisConnected) {
            try {
                await this.redisClient.del(key);
                redisSuccess = true;
            }
            catch (err) {
                this.metrics.errors++;
                console.error("Redis delete error:", err);
            }
        }
        if (this.config.enableInMemoryFallback) {
            this.inMemoryCache.delete(key);
            memorySuccess = true;
        }
        if (redisSuccess) {
            return { success: true, source: 'redis' };
        }
        else if (memorySuccess) {
            return { success: true, source: 'memory' };
        }
        else {
            return { success: false, source: 'none' };
        }
    }
    /**
     * Invalidate keys by pattern
     */
    async invalidatePattern(namespace, pattern) {
        const fullPattern = this.getKey(namespace, pattern);
        if (this.redisClient && this.metrics.redisConnected) {
            try {
                const keys = await this.redisClient.keys(fullPattern);
                if (keys.length > 0) {
                    await this.redisClient.del(keys);
                }
            }
            catch (err) {
                console.error("Redis invalidatePattern error:", err);
            }
        }
        // Memory cache doesn't efficiently support patterns in this implementation
        // Ideally we iterate keys
        // For now, assuming Redis is primary
    }
    /**
     * Invalidate entire namespace
     */
    async invalidateNamespace(namespace) {
        await this.invalidatePattern(namespace, "*");
    }
    async clear() {
        this.metrics.totalOperations++;
        let redisSuccess = false;
        let memorySuccess = false;
        if (this.redisClient && this.metrics.redisConnected) {
            try {
                await this.redisClient.flushDb();
                redisSuccess = true;
            }
            catch (err) {
                this.metrics.errors++;
                console.error("Redis clear error:", err);
            }
        }
        if (this.config.enableInMemoryFallback) {
            this.inMemoryCache.clear();
            memorySuccess = true;
        }
        if (redisSuccess) {
            return { success: true, source: 'redis' };
        }
        else if (memorySuccess) {
            return { success: true, source: 'memory' };
        }
        else {
            return { success: false, source: 'none' };
        }
    }
    /**
     * Check if cache is healthy
     */
    isHealthy() {
        return this.metrics.redisConnected || this.config.enableInMemoryFallback;
    }
    /**
     * Get cache status
     */
    getStatus() {
        const hitRate = this.metrics.totalOperations > 0
            ? (this.metrics.redisHits + this.metrics.memoryHits) / this.metrics.totalOperations
            : 0;
        const averageResponseTime = this.metrics.totalOperations > 0
            ? this.totalResponseTime / this.metrics.totalOperations
            : 0;
        return {
            redisConnected: this.metrics.redisConnected,
            fallbackActive: this.metrics.fallbackActive,
            totalOperations: this.metrics.totalOperations,
            hitRate,
            averageResponseTime
        };
    }
    /**
     * Get cache metrics
     */
    getMetrics() {
        return { ...this.metrics };
    }
    async shutdown() {
        this.isShuttingDown = true;
        if (this.healthCheckInterval) {
            clearInterval(this.healthCheckInterval);
        }
        if (this.redisClient) {
            try {
                await this.redisClient.disconnect();
            }
            catch (err) {
                console.error("Redis disconnect error:", err);
            }
        }
        this.inMemoryCache.clear();
    }
}
exports.CacheManager = CacheManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLWJyYWluL3NyYy9jYWNoZS9DYWNoZU1hbmFnZXIudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7OztHQUtHOzs7QUFFSCxtQ0FBc0M7QUFDdEMsaUNBQXNEO0FBQ3RELHlEQUFtRDtBQUVuRDs7R0FFRztBQUNILElBQVksY0FRWDtBQVJELFdBQVksY0FBYztJQUN4QiwrQkFBYSxDQUFBO0lBQ2IsaUNBQWUsQ0FBQTtJQUNmLDZDQUEyQixDQUFBO0lBQzNCLHFDQUFtQixDQUFBO0lBQ25CLHFDQUFtQixDQUFBO0lBQ25CLDJDQUF5QixDQUFBO0lBQ3pCLDZDQUEyQixDQUFBO0FBQzdCLENBQUMsRUFSVyxjQUFjLDhCQUFkLGNBQWMsUUFRekI7QUE4QkQ7O0dBRUc7QUFDVSxRQUFBLG9CQUFvQixHQUFnQjtJQUMvQyxzQkFBc0IsRUFBRSxJQUFJO0lBQzVCLGVBQWUsRUFBRSxJQUFJO0lBQ3JCLGFBQWEsRUFBRSxNQUFNO0lBQ3JCLHFCQUFxQixFQUFFLEtBQUs7SUFDNUIsb0JBQW9CLEVBQUUsSUFBSTtJQUMxQixvQkFBb0IsRUFBRSxDQUFDO0lBQ3ZCLGdCQUFnQixFQUFFLElBQUk7Q0FDdkIsQ0FBQztBQStDRjs7R0FFRztBQUNILE1BQWEsWUFBYSxTQUFRLHFCQUFZO0lBQ3BDLFdBQVcsR0FBMkIsSUFBSSxDQUFDO0lBQzNDLGFBQWEsQ0FBZ0I7SUFDN0IsTUFBTSxDQUFjO0lBQ3BCLE9BQU8sQ0FBZTtJQUN0QixtQkFBbUIsR0FBMEIsSUFBSSxDQUFDO0lBQ2xELGNBQWMsR0FBWSxLQUFLLENBQUM7SUFDaEMsY0FBYyxHQUFXLENBQUMsQ0FBQztJQUMzQixpQkFBaUIsR0FBVyxDQUFDLENBQUM7SUFFdEMsWUFBWSxTQUFzQiw0QkFBb0I7UUFDcEQsS0FBSyxFQUFFLENBQUM7UUFDUixJQUFJLENBQUMsTUFBTSxHQUFHLE1BQU0sQ0FBQztRQUNyQixJQUFJLENBQUMsYUFBYSxHQUFHLElBQUksZ0NBQWEs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QUUsQ0FBQztZQUM3QixhQUFhLENBQUMsSUFBSSxDQUFDLG1CQUFtQixDQUFDLENBQUM7UUFDMUMsQ0FBQztRQUNELElBQUksSUFBSSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBQ3JCLElBQUksQ0FBQztnQkFDSCxNQUFNLElBQUksQ0FBQyxXQUFXLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDdEMsQ0FBQztZQUFDLE9BQU8sR0FBRyxFQUFFLENBQUM7Z0JBQ2IsT0FBTyxDQUFDLEtBQUssQ0FBQyx5QkFBeUIsRUFBRSxHQUFHLENBQUMsQ0FBQztZQUNoRCxDQUFDO1FBQ0gsQ0FBQztRQUNELElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLENBQUM7SUFDN0IsQ0FBQztDQUNGO0FBN2FELG9DQTZhQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvaXZhbi9Db2RlL3RyYWRpbmcvdGl0YW4vc2VydmljZXMvdGl0YW4tYnJhaW4vc3JjL2NhY2hlL0NhY2hlTWFuYWdlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIENhY2hlTWFuYWdlciAtIFJlZGlzIHdpdGggaW4tbWVtb3J5IGZhbGxiYWNrIHN0cmF0ZWd5XG4gKlxuICogUHJvdmlkZXMgcmVsaWFibGUgY2FjaGluZyB3aXRoIFJlZGlzIGFzIHByaW1hcnkgYW5kIGluLW1lbW9yeSBhcyBmYWxsYmFjay5cbiAqIEhhbmRsZXMgUmVkaXMgdW5hdmFpbGFiaWxpdHkgZ3JhY2VmdWxseS5cbiAqL1xuXG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tIFwiZXZlbnRzXCI7XG5pbXBvcnQgeyBjcmVhdGVDbGllbnQsIFJlZGlzQ2xpZW50VHlwZSB9IGZyb20gXCJyZWRpc1wiO1xuaW1wb3J0IHsgSW5NZW1vcnlDYWNoZSB9IGZyb20gXCIuL0luTWVtb3J5Q2FjaGUuanNcIjtcblxuLyoqXG4gKiBDYWNoZSBuYW1lc3BhY2VzXG4gKi9cbmV4cG9ydCBlbnVtIENhY2hlTmFtZXNwYWNlIHtcbiAgUklTSyA9IFwicmlza1wiLFxuICBRVUVSWSA9IFwicXVlcnlcIixcbiAgQ09SUkVMQVRJT04gPSBcImNvcnJlbGF0aW9uXCIsXG4gIFNFU1NJT04gPSBcInNlc3Npb25cIixcbiAgTUVUUklDUyA9IFwibWV0cmljc1wiLFxuICBBTExPQ0FUSU9OID0gXCJhbGxvY2F0aW9uXCIsXG4gIFBFUkZPUk1BTkNFID0gXCJwZXJmb3JtYW5jZVwiLFxufVxuXG4vKipcbiAqIENhY2hlIGNvbmZpZ3VyYXRpb25cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBDYWNoZUNvbmZpZyB7XG4gIHJlZGlzPzoge1xuICAgIHVybD86IHN0cmluZztcbiAgICBob3N0Pzogc3RyaW5nO1xuICAgIHBvcnQ/OiBudW1iZXI7XG4gICAgcGFzc3dvcmQ/OiBzdHJpbmc7XG4gICAgZGI/OiBudW1iZXI7XG4gICAgY29ubmVjdFRpbWVvdXQ/OiBudW1iZXI7XG4gICAgY29tbWFuZFRpbWVvdXQ/OiBudW1iZXI7XG4gICAgcmV0cnlEZWxheU9uRmFpbG92ZXI/OiBudW1iZXI7XG4gICAgbWF4UmV0cmllc1BlclJlcXVlc3Q/OiBudW1iZXI7XG4gIH07XG5cbiAgLy8gRmFsbGJhY2sgc2V0dGluZ3NcbiAgZW5hYmxlSW5NZW1vcnlGYWxsYmFjazogYm9vbGVhbjtcbiAgaW5NZW1vcnlNYXhTaXplOiBudW1iZXI7XG4gIGluTWVtb3J5VHRsTXM6IG51bWJlcjtcblxuICAvLyBIZWFsdGggY2hlY2sgc2V0dGluZ3NcbiAgaGVhbHRoQ2hlY2tJbnRlcnZhbE1zOiBudW1iZXI7XG4gIGhlYWx0aENoZWNrVGltZW91dE1zOiBudW1iZXI7XG4gIG1heFJlY29ubmVjdEF0dGVtcHRzOiBudW1iZXI7XG4gIHJlY29ubmVjdERlbGF5TXM6IG51bWJlcjtcbn1cblxuLyoqXG4gKiBEZWZhdWx0IGNhY2hlIGNvbmZpZ3VyYXRpb25cbiAqL1xuZXhwb3J0IGNvbnN0IERFRkFVTFRfQ0FDSEVfQ09ORklHOiBDYWNoZUNvbmZpZyA9IHtcbiAgZW5hYmxlSW5NZW1vcnlGYWxsYmFjazogdHJ1ZSxcbiAgaW5NZW1vcnlNYXhTaXplOiAxMDAwLFxuICBpbk1lbW9yeVR0bE1zOiAzMDAwMDAsXG4gIGhlYWx0aENoZWNrSW50ZXJ2YWxNczogMzAwMDAsXG4gIGhlYWx0aENoZWNrVGltZW91dE1zOiA1MDAwLFxuICBtYXhSZWNvbm5lY3RBdHRlbXB0czogNSxcbiAgcmVjb25uZWN0RGVsYXlNczogNTAwMCxcbn07XG5cbi8qKlxuICogQ2FjaGUgc3RhdHNcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBDYWNoZVN0YXRzIHtcbiAgaGl0czogbnVtYmVyO1xuICBtaXNzZXM6IG51bWJlcjtcbiAga2V5czogbnVtYmVyO1xuICBtZW1vcnlVc2FnZTogbnVtYmVyO1xufVxuXG4vKipcbiAqIENhY2hlIG9wZXJhdGlvbiByZXN1bHRcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBDYWNoZVJlc3VsdDxUID0gYW55PiB7XG4gIHN1Y2Nlc3M6IGJvb2xlYW47XG4gIHZhbHVlPzogVDtcbiAgc291cmNlOiAncmVkaXMnIHwgJ21lbW9yeScgfCAnbm9uZSc7XG4gIGVycm9yPzogc3RyaW5nO1xufVxuXG4vKipcbiAqIENhY2hlIHN0YXR1c1xuICovXG5leHBvcnQgaW50ZXJmYWNlIENhY2hlU3RhdHVzIHtcbiAgcmVkaXNDb25uZWN0ZWQ6IGJvb2xlYW47XG4gIGZhbGxiYWNrQWN0aXZlOiBib29sZWFuO1xuICB0b3RhbE9wZXJhdGlvbnM6IG51bWJlcjtcbiAgaGl0UmF0ZTogbnVtYmVyO1xuICBhdmVyYWdlUmVzcG9uc2VUaW1lOiBudW1iZXI7XG59XG5cbi8qKlxuICogQ2FjaGUgbWV0cmljc1xuICovXG5leHBvcnQgaW50ZXJmYWNlIENhY2hlTWV0cmljcyB7XG4gIHJlZGlzQ29ubmVjdGVkOiBib29sZWFuO1xuICBmYWxsYmFja0FjdGl2ZTogYm9vbGVhbjtcbiAgdG90YWxPcGVyYXRpb25zOiBudW1iZXI7XG4gIHJlZGlzSGl0czogbnVtYmVyO1xuICByZWRpc01pc3NlczogbnVtYmVyO1xuICBtZW1vcnlIaXRzOiBudW1iZXI7XG4gIG1lbW9yeU1pc3NlczogbnVtYmVyO1xuICBlcnJvcnM6IG51bWJlcjtcbn1cblxuLyoqXG4gKiBDYWNoZSBtYW5hZ2VyIHdpdGggUmVkaXMgcHJpbWFyeSBhbmQgaW4tbWVtb3J5IGZhbGxiYWNrXG4gKi9cbmV4cG9ydCBjbGFzcyBDYWNoZU1hbmFnZXIgZXh0ZW5kcyBFdmVudEVtaXR0ZXIge1xuICBwcml2YXRlIHJlZGlzQ2xpZW50OiBSZWRpc0NsaWVudFR5cGUgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBpbk1lbW9yeUNhY2hlOiBJbk1lbW9yeUNhY2hlO1xuICBwcml2YXRlIGNvbmZpZzogQ2FjaGVDb25maWc7XG4gIHByaXZhdGUgbWV0cmljczogQ2FjaGVNZXRyaWNzO1xuICBwcml2YXRlIGhlYWx0aENoZWNrSW50ZXJ2YWw6IE5vZGVKUy5UaW1lb3V0IHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgaXNTaHV0dGluZ0Rvd246IGJvb2xlYW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSBvcGVyYXRpb25Db3VudDogbnVtYmVyID0gMDtcbiAgcHJpdmF0ZSB0b3RhbFJlc3BvbnNlVGltZTogbnVtYmVyID0gMDtcblxuICBjb25zdHJ1Y3Rvcihjb25maWc6IENhY2hlQ29uZmlnID0gREVGQVVMVF9DQUNIRV9DT05GSUcpIHtcbiAgICBzdXBlcigpO1xuICAgIHRoaXMuY29uZmlnID0gY29uZmlnO1xuICAgIHRoaXMuaW5NZW1vcnlDYWNoZSA9IG5ldyBJbk1lbW9yeUNhY2hlKFxuICAgICAgY29uZmlnLmluTWVtb3J5TWF4U2l6ZSxcbiAgICAgIGNvbmZpZy5pbk1lbW9yeVR0bE1zLFxuICAgICk7XG4gICAgdGhpcy5tZXRyaWNzID0ge1xuICAgICAgcmVkaXNDb25uZWN0ZWQ6IGZhbHNlLFxuICAgICAgZmFsbGJhY2tBY3RpdmU6IGZhbHNlLFxuICAgICAgdG90YWxPcGVyYXRpb25zOiAwLFxuICAgICAgcmVkaXNIaXRzOiAwLFxuICAgICAgcmVkaXNNaXNzZXM6IDAsXG4gICAgICBtZW1vcnlIaXRzOiAwLFxuICAgICAgbWVtb3J5TWlzc2VzOiAwLFxuICAgICAgZXJyb3JzOiAwLFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogQ3JlYXRlIGNhY2hlIGNvbmZpZ3VyYXRpb24gZnJvbSBlbnZpcm9ubWVudCB2YXJpYWJsZXNcbiAgICovXG4gIHN0YXRpYyBjcmVhdGVDb25maWdGcm9tRW52KCk6IENhY2hlQ29uZmlnIHtcbiAgICBjb25zdCByZWRpc1VybCA9IHByb2Nlc3MuZW52LlJFRElTX1VSTDtcbiAgICBsZXQgcmVkaXNDb25maWc6IENhY2hlQ29uZmlnW1wicmVkaXNcIl0gPSB1bmRlZmluZWQ7XG4gICAgY29uc3QgcmVkaXNEaXNhYmxlZCA9IHByb2Nlc3MuZW52LlJFRElTX0RJU0FCTEVEID09PSBcInRydWVcIjtcblxuICAgIGlmIChyZWRpc1VybCAmJiAhcmVkaXNEaXNhYmxlZCkge1xuICAgICAgcmVkaXNDb25maWcgPSB7IHVybDogcmVkaXNVcmwgfTtcbiAgICB9IGVsc2UgaWYgKHByb2Nlc3MuZW52LlJFRElTX0hPU1QpIHtcbiAgICAgIHJlZGlzQ29uZmlnID0ge1xuICAgICAgICBob3N0OiBwcm9jZXNzLmVudi5SRURJU19IT1NULFxuICAgICAgICBwb3J0OiBwYXJzZUludChwcm9jZXNzLmVudi5SRURJU19QT1JUIHx8IFwiNjM3OVwiKSxcbiAgICAgICAgcGFzc3dvcmQ6IHByb2Nlc3MuZW52LlJFRElTX1BBU1NXT1JELFxuICAgICAgICBkYjogcGFyc2VJbnQocHJvY2Vzcy5lbnYuUkVESVNfREIgfHwgXCIwXCIpLFxuICAgICAgfTtcbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgcmVkaXM6IHJlZGlzQ29uZmlnLFxuICAgICAgZW5hYmxlSW5NZW1vcnlGYWxsYmFjazpcbiAgICAgICAgcHJvY2Vzcy5lbnYuQ0FDSEVfRU5BQkxFX01FTU9SWV9GQUxMQkFDSyAhPT0gXCJmYWxzZVwiLFxuICAgICAgaW5NZW1vcnlNYXhTaXplOiBwYXJzZUludChwcm9jZXNzLmVudi5DQUNIRV9NRU1PUllfTUFYX1NJWkUgfHwgXCIxMDAwXCIpLFxuICAgICAgaW5NZW1vcnlUdGxNczogcGFyc2VJbnQocHJvY2Vzcy5lbnYuQ0FDSEVfTUVNT1JZX1RUTCB8fCBcIjMwMDAwMFwiKSxcbiAgICAgIGhlYWx0aENoZWNrSW50ZXJ2YWxNczogcGFyc2VJbnQoXG4gICAgICAgIHByb2Nlc3MuZW52LkNBQ0hFX0hFQUxUSF9DSEVDS19JTlRFUlZBTCB8fCBcIjMwMDAwXCIsXG4gICAgICApLFxuICAgICAgaGVhbHRoQ2hlY2tUaW1lb3V0TXM6IHBhcnNlSW50KFxuICAgICAgICBwcm9jZXNzLmVudi5DQUNIRV9IRUFMVEhfQ0hFQ0tfVElNRU9VVCB8fCBcIjUwMDBcIixcbiAgICAgICksXG4gICAgICBtYXhSZWNvbm5lY3RBdHRlbXB0czogcGFyc2VJbnQoXG4gICAgICAgIHByb2Nlc3MuZW52LkNBQ0hFX01BWF9SRUNPTk5FQ1RfQVRURU1QVFMgfHwgXCI1XCIsXG4gICAgICApLFxuICAgICAgcmVjb25uZWN0RGVsYXlNczogcGFyc2VJbnQocHJvY2Vzcy5lbnYuQ0FDSEVfUkVDT05ORUNUX0RFTEFZIHx8IFwiNTAwMFwiKSxcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEluaXRpYWxpemUgY2FjaGUgbWFuYWdlclxuICAgKi9cbiAgYXN5bmMgaW5pdGlhbGl6ZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0aGlzLmluTWVtb3J5Q2FjaGUuaW5pdGlhbGl6ZSgpO1xuXG4gICAgaWYgKHRoaXMuY29uZmlnLnJlZGlzKSB7XG4gICAgICBhd2FpdCB0aGlzLmluaXRpYWxpemVSZWRpcygpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLmxvZyhcIlJlZGlzIG5vdCBjb25maWd1cmVkLCB1c2luZyBpbi1tZW1vcnkgY2FjaGUgb25seVwiKTtcbiAgICAgIHRoaXMubWV0cmljcy5mYWxsYmFja0FjdGl2ZSA9IHRydWU7XG4gICAgfVxuXG4gICAgLy8gRW1pdCBpbml0aWFsaXplZCBldmVudFxuICAgIHRoaXMuZW1pdCgnaW5pdGlhbGl6ZWQnLCB7XG4gICAgICByZWRpc0VuYWJsZWQ6ICEhdGhpcy5jb25maWcucmVkaXMsXG4gICAgICBmYWxsYmFja0FjdGl2ZTogdGhpcy5tZXRyaWNzLmZhbGxiYWNrQWN0aXZlXG4gICAgfSk7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGluaXRpYWxpemVSZWRpcygpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAoIXRoaXMuY29uZmlnLnJlZGlzKSByZXR1cm47XG5cbiAgICB0cnkge1xuICAgICAgdGhpcy5yZWRpc0NsaWVudCA9IGNyZWF0ZUNsaWVudCh7XG4gICAgICAgIHVybDogdGhpcy5jb25maWcucmVkaXMudXJsLFxuICAgICAgICBzb2NrZXQ6IHtcbiAgICAgICAgICBob3N0OiB0aGlzLmNvbmZpZy5yZWRpcy5ob3N0LFxuICAgICAgICAgIHBvcnQ6IHRoaXMuY29uZmlnLnJlZGlzLnBvcnQsXG4gICAgICAgIH0sXG4gICAgICB9KTtcblxuICAgICAgdGhpcy5yZWRpc0NsaWVudC5vbihcImVycm9yXCIsIChlcnIpID0+IHtcbiAgICAgICAgY29uc29sZS5lcnJvcihcIlJlZGlzIGVycm9yOlwiLCBlcnIpO1xuICAgICAgICB0aGlzLm1ldHJpY3MucmVkaXNDb25uZWN0ZWQgPSBmYWxzZTtcbiAgICAgICAgdGhpcy5tZXRyaWNzLmZhbGxiYWNrQWN0aXZlID0gdHJ1ZTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLnJlZGlzQ2xpZW50Lm9uKFwiY29ubmVjdFwiLCAoKSA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKFwiUmVkaXMgY29ubmVjdGVkXCIpO1xuICAgICAgICB0aGlzLm1ldHJpY3MucmVkaXNDb25uZWN0ZWQgPSB0cnVlO1xuICAgICAgICB0aGlzLm1ldHJpY3MuZmFsbGJhY2tBY3RpdmUgPSBmYWxzZTtcbiAgICAgIH0pO1xuXG4gICAgICBhd2FpdCB0aGlzLnJlZGlzQ2xpZW50LmNvbm5lY3QoKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS53YXJuKFwiRmFpbGVkIHRvIGNvbm5lY3QgdG8gUmVkaXMsIHVzaW5nIGZhbGxiYWNrOlwiLCBlcnJvcik7XG4gICAgICB0aGlzLm1ldHJpY3MucmVkaXNDb25uZWN0ZWQgPSBmYWxzZTtcbiAgICAgIHRoaXMubWV0cmljcy5mYWxsYmFja0FjdGl2ZSA9IHRydWU7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEdlbmVyYXRlIG5hbWVzcGFjZWQga2V5XG4gICAqL1xuICBwcml2YXRlIGdldEtleShuYW1lc3BhY2U6IHN0cmluZyB8IENhY2hlTmFtZXNwYWNlLCBrZXk6IHN0cmluZyk6IHN0cmluZyB7XG4gICAgcmV0dXJuIGAke25hbWVzcGFjZX06JHtrZXl9YDtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdmFsdWUgZnJvbSBjYWNoZVxuICAgKiBTdXBwb3J0cyBib3RoIGdldChrZXkpIGFuZCBnZXQobmFtZXNwYWNlLCBrZXkpIHNpZ25hdHVyZXNcbiAgICovXG4gIGFzeW5jIGdldDxUPihcbiAgICBhcmcxOiBzdHJpbmcgfCBDYWNoZU5hbWVzcGFjZSxcbiAgICBhcmcyPzogc3RyaW5nLFxuICApOiBQcm9taXNlPENhY2hlUmVzdWx0PFQ+PiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICBsZXQga2V5OiBzdHJpbmc7XG5cbiAgICBpZiAoYXJnMikge1xuICAgICAga2V5ID0gdGhpcy5nZXRLZXkoYXJnMSwgYXJnMik7XG4gICAgfSBlbHNlIHtcbiAgICAgIGtleSA9IGFyZzEgYXMgc3RyaW5nO1xuICAgIH1cblxuICAgIHRoaXMubWV0cmljcy50b3RhbE9wZXJhdGlvbnMrKztcblxuICAgIC8vIFRyeSBSZWRpcyBmaXJzdFxuICAgIGlmICh0aGlzLnJlZGlzQ2xpZW50ICYmIHRoaXMubWV0cmljcy5yZWRpc0Nvbm5lY3RlZCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgdmFsdWUgPSBhd2FpdCB0aGlzLnJlZGlzQ2xpZW50LmdldChrZXkpO1xuICAgICAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG4gICAgICAgIHRoaXMudG90YWxSZXNwb25zZVRpbWUgKz0gZHVyYXRpb247XG4gICAgICAgIFxuICAgICAgICBpZiAodmFsdWUpIHtcbiAgICAgICAgICB0aGlzLm1ldHJpY3MucmVkaXNIaXRzKys7XG4gICAgICAgICAgdGhpcy5lbWl0KCdjYWNoZTpoaXQnLCB7IHNvdXJjZTogJ3JlZGlzJywga2V5LCBkdXJhdGlvbiB9KTtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgICAgIHZhbHVlOiBKU09OLnBhcnNlKHZhbHVlKSBhcyBULFxuICAgICAgICAgICAgc291cmNlOiAncmVkaXMnXG4gICAgICAgICAgfTtcbiAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICB0aGlzLm1ldHJpY3MucmVkaXNNaXNzZXMrKztcbiAgICAgICAgICB0aGlzLmVtaXQoJ2NhY2hlOm1pc3MnLCB7IHNvdXJjZTogJ3JlZGlzJywga2V5LCBkdXJhdGlvbiB9KTtcbiAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICAgICAgICBzb3VyY2U6ICdyZWRpcydcbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgICAgdGhpcy5tZXRyaWNzLmVycm9ycysrO1xuICAgICAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG4gICAgICAgIHRoaXMuZW1pdCgnY2FjaGU6ZXJyb3InLCB7IFxuICAgICAgICAgIHNvdXJjZTogJ3JlZGlzJywgXG4gICAgICAgICAga2V5LCBcbiAgICAgICAgICBlcnJvcjogZXJyIGluc3RhbmNlb2YgRXJyb3IgPyBlcnIubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyxcbiAgICAgICAgICBkdXJhdGlvbiBcbiAgICAgICAgfSk7XG4gICAgICAgIC8vIEZhbGwgdGhyb3VnaCB0byBtZW1vcnkgY2FjaGVcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBGYWxsYmFjayB0byBtZW1vcnlcbiAgICBpZiAodGhpcy5jb25maWcuZW5hYmxlSW5NZW1vcnlGYWxsYmFjaykge1xuICAgICAgY29uc3QgdmFsdWUgPSB0aGlzLmluTWVtb3J5Q2FjaGUuZ2V0PFQ+KGtleSk7XG4gICAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG4gICAgICB0aGlzLnRvdGFsUmVzcG9uc2VUaW1lICs9IGR1cmF0aW9uO1xuICAgICAgXG4gICAgICBpZiAodmFsdWUgIT09IHVuZGVmaW5lZCkge1xuICAgICAgICB0aGlzLm1ldHJpY3MubWVtb3J5SGl0cysrO1xuICAgICAgICB0aGlzLmVtaXQoJ2NhY2hlOmhpdCcsIHsgc291cmNlOiAnbWVtb3J5Jywga2V5LCBkdXJhdGlvbiB9KTtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgIHZhbHVlLFxuICAgICAgICAgIHNvdXJjZTogJ21lbW9yeSdcbiAgICAgICAgfTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMubWV0cmljcy5tZW1vcnlNaXNzZXMrKztcbiAgICAgICAgdGhpcy5lbWl0KCdjYWNoZTptaXNzJywgeyBzb3VyY2U6ICdtZW1vcnknLCBrZXksIGR1cmF0aW9uIH0pO1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgIHNvdXJjZTogJ21lbW9yeSdcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4ge1xuICAgICAgc3VjY2VzczogZmFsc2UsXG4gICAgICBzb3VyY2U6ICdub25lJ1xuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogU2V0IHZhbHVlIGluIGNhY2hlXG4gICAqIFN1cHBvcnRzIGJvdGggc2V0KGtleSwgdmFsdWUsIHR0bD8pIGFuZCBzZXQobmFtZXNwYWNlLCBrZXksIHZhbHVlLCB0dGw/KVxuICAgKi9cbiAgYXN5bmMgc2V0PFQ+KFxuICAgIGFyZzE6IHN0cmluZyB8IENhY2hlTmFtZXNwYWNlLFxuICAgIGFyZzI6IHN0cmluZyB8IFQsXG4gICAgYXJnMz86IFQgfCBudW1iZXIsXG4gICAgYXJnND86IG51bWJlcixcbiAgKTogUHJvbWlzZTxDYWNoZVJlc3VsdDx2b2lkPj4ge1xuICAgIGxldCBrZXk6IHN0cmluZztcbiAgICBsZXQgdmFsdWU6IFQ7XG4gICAgbGV0IHR0bDogbnVtYmVyIHwgdW5kZWZpbmVkO1xuXG4gICAgaWYgKHR5cGVvZiBhcmcyID09PSBcInN0cmluZ1wiICYmIGFyZzMgIT09IHVuZGVmaW5lZCkge1xuICAgICAgLy8gc2V0KG5hbWVzcGFjZSwga2V5LCB2YWx1ZSwgdHRsPylcbiAgICAgIGtleSA9IHRoaXMuZ2V0S2V5KGFyZzEsIGFyZzIpO1xuICAgICAgdmFsdWUgPSBhcmczIGFzIFQ7XG4gICAgICB0dGwgPSBhcmc0O1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBzZXQoa2V5LCB2YWx1ZSwgdHRsPylcbiAgICAgIGtleSA9IGFyZzEgYXMgc3RyaW5nO1xuICAgICAgdmFsdWUgPSBhcmcyIGFzIFQ7XG4gICAgICB0dGwgPSBhcmczIGFzIG51bWJlciB8IHVuZGVmaW5lZDtcbiAgICB9XG5cbiAgICBjb25zdCBzdHJpbmdWYWx1ZSA9IEpTT04uc3RyaW5naWZ5KHZhbHVlKTtcbiAgICB0aGlzLm1ldHJpY3MudG90YWxPcGVyYXRpb25zKys7XG5cbiAgICAvLyBUcnkgUmVkaXMgZmlyc3RcbiAgICBpZiAodGhpcy5yZWRpc0NsaWVudCAmJiB0aGlzLm1ldHJpY3MucmVkaXNDb25uZWN0ZWQpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGlmICh0dGwpIHtcbiAgICAgICAgICBhd2FpdCB0aGlzLnJlZGlzQ2xpZW50LnNldEV4KGtleSwgdHRsLCBzdHJpbmdWYWx1ZSk7XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgYXdhaXQgdGhpcy5yZWRpc0NsaWVudC5zZXQoa2V5LCBzdHJpbmdWYWx1ZSk7XG4gICAgICAgIH1cbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgIHNvdXJjZTogJ3JlZGlzJ1xuICAgICAgICB9O1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHRoaXMubWV0cmljcy5lcnJvcnMrKztcbiAgICAgICAgY29uc29sZS5lcnJvcihcIlJlZGlzIHNldCBlcnJvcjpcIiwgZXJyKTtcbiAgICAgICAgLy8gRmFsbCB0aHJvdWdoIHRvIG1lbW9yeSBjYWNoZVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIEZhbGxiYWNrIHRvIG1lbW9yeVxuICAgIGlmICh0aGlzLmNvbmZpZy5lbmFibGVJbk1lbW9yeUZhbGxiYWNrKSB7XG4gICAgICB0aGlzLmluTWVtb3J5Q2FjaGUuc2V0KFxuICAgICAgICBrZXksXG4gICAgICAgIHZhbHVlLFxuICAgICAgICB0dGwgPyB0dGwgKiAxMDAwIDogdGhpcy5jb25maWcuaW5NZW1vcnlUdGxNcyxcbiAgICAgICk7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICBzb3VyY2U6ICdtZW1vcnknXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgIHNvdXJjZTogJ25vbmUnLFxuICAgICAgZXJyb3I6ICdObyBjYWNoZSBiYWNrZW5kIGF2YWlsYWJsZSdcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIERlbGV0ZSB2YWx1ZSBmcm9tIGNhY2hlXG4gICAqIFN1cHBvcnRzIGRlbGV0ZShrZXkpIGFuZCBkZWxldGUobmFtZXNwYWNlLCBrZXkpXG4gICAqL1xuICBhc3luYyBkZWxldGUoYXJnMTogc3RyaW5nIHwgQ2FjaGVOYW1lc3BhY2UsIGFyZzI/OiBzdHJpbmcpOiBQcm9taXNlPENhY2hlUmVzdWx0PHZvaWQ+PiB7XG4gICAgbGV0IGtleTogc3RyaW5nO1xuICAgIGlmIChhcmcyKSB7XG4gICAgICBrZXkgPSB0aGlzLmdldEtleShhcmcxLCBhcmcyKTtcbiAgICB9IGVsc2Uge1xuICAgICAga2V5ID0gYXJnMSBhcyBzdHJpbmc7XG4gICAgfVxuXG4gICAgdGhpcy5tZXRyaWNzLnRvdGFsT3BlcmF0aW9ucysrO1xuICAgIGxldCByZWRpc1N1Y2Nlc3MgPSBmYWxzZTtcbiAgICBsZXQgbWVtb3J5U3VjY2VzcyA9IGZhbHNlO1xuXG4gICAgaWYgKHRoaXMucmVkaXNDbGllbnQgJiYgdGhpcy5tZXRyaWNzLnJlZGlzQ29ubmVjdGVkKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLnJlZGlzQ2xpZW50LmRlbChrZXkpO1xuICAgICAgICByZWRpc1N1Y2Nlc3MgPSB0cnVlO1xuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIHRoaXMubWV0cmljcy5lcnJvcnMrKztcbiAgICAgICAgY29uc29sZS5lcnJvcihcIlJlZGlzIGRlbGV0ZSBlcnJvcjpcIiwgZXJyKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodGhpcy5jb25maWcuZW5hYmxlSW5NZW1vcnlGYWxsYmFjaykge1xuICAgICAgdGhpcy5pbk1lbW9yeUNhY2hlLmRlbGV0ZShrZXkpO1xuICAgICAgbWVtb3J5U3VjY2VzcyA9IHRydWU7XG4gICAgfVxuXG4gICAgaWYgKHJlZGlzU3VjY2Vzcykge1xuICAgICAgcmV0dXJuIHsgc3VjY2VzczogdHJ1ZSwgc291cmNlOiAncmVkaXMnIH07XG4gICAgfSBlbHNlIGlmIChtZW1vcnlTdWNjZXNzKSB7XG4gICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCBzb3VyY2U6ICdtZW1vcnknIH07XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IGZhbHNlLCBzb3VyY2U6ICdub25lJyB9O1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBJbnZhbGlkYXRlIGtleXMgYnkgcGF0dGVyblxuICAgKi9cbiAgYXN5bmMgaW52YWxpZGF0ZVBhdHRlcm4oXG4gICAgbmFtZXNwYWNlOiBDYWNoZU5hbWVzcGFjZSxcbiAgICBwYXR0ZXJuOiBzdHJpbmcsXG4gICk6IFByb21pc2U8dm9pZD4ge1xuICAgIGNvbnN0IGZ1bGxQYXR0ZXJuID0gdGhpcy5nZXRLZXkobmFtZXNwYWNlLCBwYXR0ZXJuKTtcblxuICAgIGlmICh0aGlzLnJlZGlzQ2xpZW50ICYmIHRoaXMubWV0cmljcy5yZWRpc0Nvbm5lY3RlZCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3Qga2V5cyA9IGF3YWl0IHRoaXMucmVkaXNDbGllbnQua2V5cyhmdWxsUGF0dGVybik7XG4gICAgICAgIGlmIChrZXlzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICBhd2FpdCB0aGlzLnJlZGlzQ2xpZW50LmRlbChrZXlzKTtcbiAgICAgICAgfVxuICAgICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJSZWRpcyBpbnZhbGlkYXRlUGF0dGVybiBlcnJvcjpcIiwgZXJyKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBNZW1vcnkgY2FjaGUgZG9lc24ndCBlZmZpY2llbnRseSBzdXBwb3J0IHBhdHRlcm5zIGluIHRoaXMgaW1wbGVtZW50YXRpb25cbiAgICAvLyBJZGVhbGx5IHdlIGl0ZXJhdGUga2V5c1xuICAgIC8vIEZvciBub3csIGFzc3VtaW5nIFJlZGlzIGlzIHByaW1hcnlcbiAgfVxuXG4gIC8qKlxuICAgKiBJbnZhbGlkYXRlIGVudGlyZSBuYW1lc3BhY2VcbiAgICovXG4gIGFzeW5jIGludmFsaWRhdGVOYW1lc3BhY2UobmFtZXNwYWNlOiBDYWNoZU5hbWVzcGFjZSk6IFByb21pc2U8dm9pZD4ge1xuICAgIGF3YWl0IHRoaXMuaW52YWxpZGF0ZVBhdHRlcm4obmFtZXNwYWNlLCBcIipcIik7XG4gIH1cblxuICBhc3luYyBjbGVhcigpOiBQcm9taXNlPENhY2hlUmVzdWx0PHZvaWQ+PiB7XG4gICAgdGhpcy5tZXRyaWNzLnRvdGFsT3BlcmF0aW9ucysrO1xuICAgIGxldCByZWRpc1N1Y2Nlc3MgPSBmYWxzZTtcbiAgICBsZXQgbWVtb3J5U3VjY2VzcyA9IGZhbHNlO1xuXG4gICAgaWYgKHRoaXMucmVkaXNDbGllbnQgJiYgdGhpcy5tZXRyaWNzLnJlZGlzQ29ubmVjdGVkKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLnJlZGlzQ2xpZW50LmZsdXNoRGIoKTtcbiAgICAgICAgcmVkaXNTdWNjZXNzID0gdHJ1ZTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICB0aGlzLm1ldHJpY3MuZXJyb3JzKys7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoXCJSZWRpcyBjbGVhciBlcnJvcjpcIiwgZXJyKTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBpZiAodGhpcy5jb25maWcuZW5hYmxlSW5NZW1vcnlGYWxsYmFjaykge1xuICAgICAgdGhpcy5pbk1lbW9yeUNhY2hlLmNsZWFyKCk7XG4gICAgICBtZW1vcnlTdWNjZXNzID0gdHJ1ZTtcbiAgICB9XG5cbiAgICBpZiAocmVkaXNTdWNjZXNzKSB7XG4gICAgICByZXR1cm4geyBzdWNjZXNzOiB0cnVlLCBzb3VyY2U6ICdyZWRpcycgfTtcbiAgICB9IGVsc2UgaWYgKG1lbW9yeVN1Y2Nlc3MpIHtcbiAgICAgIHJldHVybiB7IHN1Y2Nlc3M6IHRydWUsIHNvdXJjZTogJ21lbW9yeScgfTtcbiAgICB9IGVsc2Uge1xuICAgICAgcmV0dXJuIHsgc3VjY2VzczogZmFsc2UsIHNvdXJjZTogJ25vbmUnIH07XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIGNhY2hlIGlzIGhlYWx0aHlcbiAgICovXG4gIGlzSGVhbHRoeSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5tZXRyaWNzLnJlZGlzQ29ubmVjdGVkIHx8IHRoaXMuY29uZmlnLmVuYWJsZUluTWVtb3J5RmFsbGJhY2s7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGNhY2hlIHN0YXR1c1xuICAgKi9cbiAgZ2V0U3RhdHVzKCk6IENhY2hlU3RhdHVzIHtcbiAgICBjb25zdCBoaXRSYXRlID0gdGhpcy5tZXRyaWNzLnRvdGFsT3BlcmF0aW9ucyA+IDAgXG4gICAgICA/ICh0aGlzLm1ldHJpY3MucmVkaXNIaXRzICsgdGhpcy5tZXRyaWNzLm1lbW9yeUhpdHMpIC8gdGhpcy5tZXRyaWNzLnRvdGFsT3BlcmF0aW9ucyBcbiAgICAgIDogMDtcbiAgICBcbiAgICBjb25zdCBhdmVyYWdlUmVzcG9uc2VUaW1lID0gdGhpcy5tZXRyaWNzLnRvdGFsT3BlcmF0aW9ucyA+IDAgXG4gICAgICA/IHRoaXMudG90YWxSZXNwb25zZVRpbWUgLyB0aGlzLm1ldHJpY3MudG90YWxPcGVyYXRpb25zIFxuICAgICAgOiAwO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHJlZGlzQ29ubmVjdGVkOiB0aGlzLm1ldHJpY3MucmVkaXNDb25uZWN0ZWQsXG4gICAgICBmYWxsYmFja0FjdGl2ZTogdGhpcy5tZXRyaWNzLmZhbGxiYWNrQWN0aXZlLFxuICAgICAgdG90YWxPcGVyYXRpb25zOiB0aGlzLm1ldHJpY3MudG90YWxPcGVyYXRpb25zLFxuICAgICAgaGl0UmF0ZSxcbiAgICAgIGF2ZXJhZ2VSZXNwb25zZVRpbWVcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBjYWNoZSBtZXRyaWNzXG4gICAqL1xuICBnZXRNZXRyaWNzKCk6IENhY2hlTWV0cmljcyB7XG4gICAgcmV0dXJuIHsgLi4udGhpcy5tZXRyaWNzIH07XG4gIH1cblxuICBhc3luYyBzaHV0ZG93bigpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0aGlzLmlzU2h1dHRpbmdEb3duID0gdHJ1ZTtcbiAgICBpZiAodGhpcy5oZWFsdGhDaGVja0ludGVydmFsKSB7XG4gICAgICBjbGVhckludGVydmFsKHRoaXMuaGVhbHRoQ2hlY2tJbnRlcnZhbCk7XG4gICAgfVxuICAgIGlmICh0aGlzLnJlZGlzQ2xpZW50KSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCB0aGlzLnJlZGlzQ2xpZW50LmRpc2Nvbm5lY3QoKTtcbiAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICBjb25zb2xlLmVycm9yKFwiUmVkaXMgZGlzY29ubmVjdCBlcnJvcjpcIiwgZXJyKTtcbiAgICAgIH1cbiAgICB9XG4gICAgdGhpcy5pbk1lbW9yeUNhY2hlLmNsZWFyKCk7XG4gIH1cbn1cbiJdLCJ2ZXJzaW9uIjozfQ==
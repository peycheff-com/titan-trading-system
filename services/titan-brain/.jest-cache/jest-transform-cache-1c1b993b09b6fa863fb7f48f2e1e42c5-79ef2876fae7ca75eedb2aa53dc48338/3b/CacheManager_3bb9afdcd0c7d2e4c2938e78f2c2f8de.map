{"file":"/Users/ivan/Code/trading/titan/services/titan-brain/src/cache/CacheManager.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-brain/src/cache/CacheManager.ts"],"sourcesContent":["/**\n * CacheManager - Redis with in-memory fallback strategy\n *\n * Provides reliable caching with Redis as primary and in-memory as fallback.\n * Handles Redis unavailability gracefully.\n */\n\nimport { EventEmitter } from \"events\";\nimport { createClient, RedisClientType } from \"redis\";\nimport { InMemoryCache } from \"./InMemoryCache.js\";\n\n/**\n * Cache namespaces\n */\nexport enum CacheNamespace {\n  RISK = \"risk\",\n  QUERY = \"query\",\n  CORRELATION = \"correlation\",\n  SESSION = \"session\",\n  METRICS = \"metrics\",\n  ALLOCATION = \"allocation\",\n  PERFORMANCE = \"performance\",\n}\n\n/**\n * Cache configuration\n */\nexport interface CacheConfig {\n  redis?: {\n    url?: string;\n    host?: string;\n    port?: number;\n    password?: string;\n    db?: number;\n    connectTimeout?: number;\n    commandTimeout?: number;\n    retryDelayOnFailover?: number;\n    maxRetriesPerRequest?: number;\n  };\n\n  // Fallback settings\n  enableInMemoryFallback: boolean;\n  inMemoryMaxSize: number;\n  inMemoryTtlMs: number;\n\n  // Health check settings\n  healthCheckIntervalMs: number;\n  healthCheckTimeoutMs: number;\n  maxReconnectAttempts: number;\n  reconnectDelayMs: number;\n}\n\n/**\n * Default cache configuration\n */\nexport const DEFAULT_CACHE_CONFIG: CacheConfig = {\n  enableInMemoryFallback: true,\n  inMemoryMaxSize: 1000,\n  inMemoryTtlMs: 300000,\n  healthCheckIntervalMs: 30000,\n  healthCheckTimeoutMs: 5000,\n  maxReconnectAttempts: 5,\n  reconnectDelayMs: 5000,\n};\n\n/**\n * Cache stats\n */\nexport interface CacheStats {\n  hits: number;\n  misses: number;\n  keys: number;\n  memoryUsage: number;\n}\n\n/**\n * Cache operation result\n */\nexport interface CacheResult<T = any> {\n  success: boolean;\n  value?: T;\n  source: 'redis' | 'memory' | 'none';\n  error?: string;\n}\n\n/**\n * Cache status\n */\nexport interface CacheStatus {\n  redisConnected: boolean;\n  fallbackActive: boolean;\n  totalOperations: number;\n  hitRate: number;\n  averageResponseTime: number;\n}\n\n/**\n * Cache metrics\n */\nexport interface CacheMetrics {\n  redisConnected: boolean;\n  fallbackActive: boolean;\n  totalOperations: number;\n  redisHits: number;\n  redisMisses: number;\n  memoryHits: number;\n  memoryMisses: number;\n  errors: number;\n}\n\n/**\n * Cache manager with Redis primary and in-memory fallback\n */\nexport class CacheManager extends EventEmitter {\n  private redisClient: RedisClientType | null = null;\n  private inMemoryCache: InMemoryCache;\n  private config: CacheConfig;\n  private metrics: CacheMetrics;\n  private healthCheckInterval: NodeJS.Timeout | null = null;\n  private isShuttingDown: boolean = false;\n  private operationCount: number = 0;\n  private totalResponseTime: number = 0;\n\n  constructor(config: CacheConfig = DEFAULT_CACHE_CONFIG) {\n    super();\n    this.config = config;\n    this.inMemoryCache = new InMemoryCache(\n      config.inMemoryMaxSize,\n      config.inMemoryTtlMs,\n    );\n    this.metrics = {\n      redisConnected: false,\n      fallbackActive: false,\n      totalOperations: 0,\n      redisHits: 0,\n      redisMisses: 0,\n      memoryHits: 0,\n      memoryMisses: 0,\n      errors: 0,\n    };\n  }\n\n  /**\n   * Create cache configuration from environment variables\n   */\n  static createConfigFromEnv(): CacheConfig {\n    const redisUrl = process.env.REDIS_URL;\n    let redisConfig: CacheConfig[\"redis\"] = undefined;\n    const redisDisabled = process.env.REDIS_DISABLED === \"true\";\n\n    if (redisUrl && !redisDisabled) {\n      redisConfig = { url: redisUrl };\n    } else if (process.env.REDIS_HOST) {\n      redisConfig = {\n        host: process.env.REDIS_HOST,\n        port: parseInt(process.env.REDIS_PORT || \"6379\"),\n        password: process.env.REDIS_PASSWORD,\n        db: parseInt(process.env.REDIS_DB || \"0\"),\n      };\n    }\n\n    return {\n      redis: redisConfig,\n      enableInMemoryFallback:\n        process.env.CACHE_ENABLE_MEMORY_FALLBACK !== \"false\",\n      inMemoryMaxSize: parseInt(process.env.CACHE_MEMORY_MAX_SIZE || \"1000\"),\n      inMemoryTtlMs: parseInt(process.env.CACHE_MEMORY_TTL || \"300000\"),\n      healthCheckIntervalMs: parseInt(\n        process.env.CACHE_HEALTH_CHECK_INTERVAL || \"30000\",\n      ),\n      healthCheckTimeoutMs: parseInt(\n        process.env.CACHE_HEALTH_CHECK_TIMEOUT || \"5000\",\n      ),\n      maxReconnectAttempts: parseInt(\n        process.env.CACHE_MAX_RECONNECT_ATTEMPTS || \"5\",\n      ),\n      reconnectDelayMs: parseInt(process.env.CACHE_RECONNECT_DELAY || \"5000\"),\n    };\n  }\n\n  /**\n   * Initialize cache manager\n   */\n  async initialize(): Promise<void> {\n    this.inMemoryCache.initialize();\n\n    if (this.config.redis) {\n      await this.initializeRedis();\n    } else {\n      console.log(\"Redis not configured, using in-memory cache only\");\n      this.metrics.fallbackActive = true;\n    }\n\n    // Emit initialized event\n    this.emit('initialized', {\n      redisEnabled: !!this.config.redis,\n      fallbackActive: this.metrics.fallbackActive\n    });\n  }\n\n  private async initializeRedis(): Promise<void> {\n    if (!this.config.redis) return;\n\n    try {\n      this.redisClient = createClient({\n        url: this.config.redis.url,\n        socket: {\n          host: this.config.redis.host,\n          port: this.config.redis.port,\n        },\n      });\n\n      this.redisClient.on(\"error\", (err) => {\n        console.error(\"Redis error:\", err);\n        this.metrics.redisConnected = false;\n        this.metrics.fallbackActive = true;\n      });\n\n      this.redisClient.on(\"connect\", () => {\n        console.log(\"Redis connected\");\n        this.metrics.redisConnected = true;\n        this.metrics.fallbackActive = false;\n      });\n\n      await this.redisClient.connect();\n    } catch (error) {\n      console.warn(\"Failed to connect to Redis, using fallback:\", error);\n      this.metrics.redisConnected = false;\n      this.metrics.fallbackActive = true;\n    }\n  }\n\n  /**\n   * Generate namespaced key\n   */\n  private getKey(namespace: string | CacheNamespace, key: string): string {\n    return `${namespace}:${key}`;\n  }\n\n  /**\n   * Get value from cache\n   * Supports both get(key) and get(namespace, key) signatures\n   */\n  async get<T>(\n    arg1: string | CacheNamespace,\n    arg2?: string,\n  ): Promise<CacheResult<T>> {\n    const startTime = Date.now();\n    let key: string;\n\n    if (arg2) {\n      key = this.getKey(arg1, arg2);\n    } else {\n      key = arg1 as string;\n    }\n\n    this.metrics.totalOperations++;\n\n    // Try Redis first\n    if (this.redisClient && this.metrics.redisConnected) {\n      try {\n        const value = await this.redisClient.get(key);\n        const duration = Date.now() - startTime;\n        this.totalResponseTime += duration;\n        \n        if (value) {\n          this.metrics.redisHits++;\n          this.emit('cache:hit', { source: 'redis', key, duration });\n          return {\n            success: true,\n            value: JSON.parse(value) as T,\n            source: 'redis'\n          };\n        } else {\n          this.metrics.redisMisses++;\n          this.emit('cache:miss', { source: 'redis', key, duration });\n          return {\n            success: false,\n            source: 'redis'\n          };\n        }\n      } catch (err) {\n        this.metrics.errors++;\n        const duration = Date.now() - startTime;\n        this.emit('cache:error', { \n          source: 'redis', \n          key, \n          error: err instanceof Error ? err.message : 'Unknown error',\n          duration \n        });\n        // Fall through to memory cache\n      }\n    }\n\n    // Fallback to memory\n    if (this.config.enableInMemoryFallback) {\n      const value = this.inMemoryCache.get<T>(key);\n      const duration = Date.now() - startTime;\n      this.totalResponseTime += duration;\n      \n      if (value !== undefined) {\n        this.metrics.memoryHits++;\n        this.emit('cache:hit', { source: 'memory', key, duration });\n        return {\n          success: true,\n          value,\n          source: 'memory'\n        };\n      } else {\n        this.metrics.memoryMisses++;\n        this.emit('cache:miss', { source: 'memory', key, duration });\n        return {\n          success: false,\n          source: 'memory'\n        };\n      }\n    }\n\n    return {\n      success: false,\n      source: 'none'\n    };\n  }\n\n  /**\n   * Set value in cache\n   * Supports both set(key, value, ttl?) and set(namespace, key, value, ttl?)\n   */\n  async set<T>(\n    arg1: string | CacheNamespace,\n    arg2: string | T,\n    arg3?: T | number,\n    arg4?: number,\n  ): Promise<CacheResult<void>> {\n    let key: string;\n    let value: T;\n    let ttl: number | undefined;\n\n    if (typeof arg2 === \"string\" && arg3 !== undefined) {\n      // set(namespace, key, value, ttl?)\n      key = this.getKey(arg1, arg2);\n      value = arg3 as T;\n      ttl = arg4;\n    } else {\n      // set(key, value, ttl?)\n      key = arg1 as string;\n      value = arg2 as T;\n      ttl = arg3 as number | undefined;\n    }\n\n    const stringValue = JSON.stringify(value);\n    this.metrics.totalOperations++;\n\n    // Try Redis first\n    if (this.redisClient && this.metrics.redisConnected) {\n      try {\n        if (ttl) {\n          await this.redisClient.setEx(key, ttl, stringValue);\n        } else {\n          await this.redisClient.set(key, stringValue);\n        }\n        return {\n          success: true,\n          source: 'redis'\n        };\n      } catch (err) {\n        this.metrics.errors++;\n        console.error(\"Redis set error:\", err);\n        // Fall through to memory cache\n      }\n    }\n\n    // Fallback to memory\n    if (this.config.enableInMemoryFallback) {\n      this.inMemoryCache.set(\n        key,\n        value,\n        ttl ? ttl * 1000 : this.config.inMemoryTtlMs,\n      );\n      return {\n        success: true,\n        source: 'memory'\n      };\n    }\n\n    return {\n      success: false,\n      source: 'none',\n      error: 'No cache backend available'\n    };\n  }\n\n  /**\n   * Delete value from cache\n   * Supports delete(key) and delete(namespace, key)\n   */\n  async delete(arg1: string | CacheNamespace, arg2?: string): Promise<CacheResult<void>> {\n    let key: string;\n    if (arg2) {\n      key = this.getKey(arg1, arg2);\n    } else {\n      key = arg1 as string;\n    }\n\n    this.metrics.totalOperations++;\n    let redisSuccess = false;\n    let memorySuccess = false;\n\n    if (this.redisClient && this.metrics.redisConnected) {\n      try {\n        await this.redisClient.del(key);\n        redisSuccess = true;\n      } catch (err) {\n        this.metrics.errors++;\n        console.error(\"Redis delete error:\", err);\n      }\n    }\n\n    if (this.config.enableInMemoryFallback) {\n      this.inMemoryCache.delete(key);\n      memorySuccess = true;\n    }\n\n    if (redisSuccess) {\n      return { success: true, source: 'redis' };\n    } else if (memorySuccess) {\n      return { success: true, source: 'memory' };\n    } else {\n      return { success: false, source: 'none' };\n    }\n  }\n\n  /**\n   * Invalidate keys by pattern\n   */\n  async invalidatePattern(\n    namespace: CacheNamespace,\n    pattern: string,\n  ): Promise<void> {\n    const fullPattern = this.getKey(namespace, pattern);\n\n    if (this.redisClient && this.metrics.redisConnected) {\n      try {\n        const keys = await this.redisClient.keys(fullPattern);\n        if (keys.length > 0) {\n          await this.redisClient.del(keys);\n        }\n      } catch (err) {\n        console.error(\"Redis invalidatePattern error:\", err);\n      }\n    }\n\n    // Memory cache doesn't efficiently support patterns in this implementation\n    // Ideally we iterate keys\n    // For now, assuming Redis is primary\n  }\n\n  /**\n   * Invalidate entire namespace\n   */\n  async invalidateNamespace(namespace: CacheNamespace): Promise<void> {\n    await this.invalidatePattern(namespace, \"*\");\n  }\n\n  async clear(): Promise<CacheResult<void>> {\n    this.metrics.totalOperations++;\n    let redisSuccess = false;\n    let memorySuccess = false;\n\n    if (this.redisClient && this.metrics.redisConnected) {\n      try {\n        await this.redisClient.flushDb();\n        redisSuccess = true;\n      } catch (err) {\n        this.metrics.errors++;\n        console.error(\"Redis clear error:\", err);\n      }\n    }\n\n    if (this.config.enableInMemoryFallback) {\n      this.inMemoryCache.clear();\n      memorySuccess = true;\n    }\n\n    if (redisSuccess) {\n      return { success: true, source: 'redis' };\n    } else if (memorySuccess) {\n      return { success: true, source: 'memory' };\n    } else {\n      return { success: false, source: 'none' };\n    }\n  }\n\n  /**\n   * Check if cache is healthy\n   */\n  isHealthy(): boolean {\n    return this.metrics.redisConnected || this.config.enableInMemoryFallback;\n  }\n\n  /**\n   * Get cache status\n   */\n  getStatus(): CacheStatus {\n    const hitRate = this.metrics.totalOperations > 0 \n      ? (this.metrics.redisHits + this.metrics.memoryHits) / this.metrics.totalOperations \n      : 0;\n    \n    const averageResponseTime = this.metrics.totalOperations > 0 \n      ? this.totalResponseTime / this.metrics.totalOperations \n      : 0;\n\n    return {\n      redisConnected: this.metrics.redisConnected,\n      fallbackActive: this.metrics.fallbackActive,\n      totalOperations: this.metrics.totalOperations,\n      hitRate,\n      averageResponseTime\n    };\n  }\n\n  /**\n   * Get cache metrics\n   */\n  getMetrics(): CacheMetrics {\n    return { ...this.metrics };\n  }\n\n  async shutdown(): Promise<void> {\n    this.isShuttingDown = true;\n    if (this.healthCheckInterval) {\n      clearInterval(this.healthCheckInterval);\n    }\n    if (this.redisClient) {\n      try {\n        await this.redisClient.disconnect();\n      } catch (err) {\n        console.error(\"Redis disconnect error:\", err);\n      }\n    }\n    this.inMemoryCache.clear();\n  }\n}\n"],"version":3}
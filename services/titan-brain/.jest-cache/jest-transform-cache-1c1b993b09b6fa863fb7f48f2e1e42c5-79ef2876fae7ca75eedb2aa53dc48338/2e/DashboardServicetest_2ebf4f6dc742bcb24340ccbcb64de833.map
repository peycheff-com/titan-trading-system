{"file":"/Users/ivan/Code/trading/titan/services/titan-brain/tests/unit/DashboardService.test.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-brain/tests/unit/DashboardService.test.ts"],"sourcesContent":["/**\n * DashboardService Unit Tests\n * Tests the dashboard data aggregation functionality\n */\n\nimport { DashboardService, WalletBalance } from '../../src/server/DashboardService.js';\nimport { TitanBrain } from '../../src/engine/TitanBrain.js';\nimport { AllocationEngine } from '../../src/engine/AllocationEngine.js';\nimport { PerformanceTracker } from '../../src/engine/PerformanceTracker.js';\nimport { RiskGuardian } from '../../src/engine/RiskGuardian.js';\nimport { CapitalFlowManager } from '../../src/engine/CapitalFlowManager.js';\nimport { CircuitBreaker } from '../../src/engine/CircuitBreaker.js';\nimport {\n  AllocationVector,\n  PhasePerformance,\n  TreasuryStatus,\n  BreakerStatus,\n  BrainDecision,\n  Position,\n} from '../../src/types/index.js';\n\n\n// Mock implementations\nconst mockAllocationEngine = {\n  getWeights: jest.fn(),\n  getMaxLeverage: jest.fn(),\n} as unknown as AllocationEngine;\n\nconst mockPerformanceTracker = {\n  getAllPhasePerformance: jest.fn(),\n} as unknown as PerformanceTracker;\n\nconst mockRiskGuardian = {\n  getRiskMetrics: jest.fn(),\n} as unknown as RiskGuardian;\n\nconst mockCapitalFlowManager = {\n  getTreasuryStatus: jest.fn(),\n  getNextSweepTriggerLevel: jest.fn(),\n  getTotalSwept: jest.fn(),\n  getHighWatermark: jest.fn(),\n} as unknown as CapitalFlowManager;\n\nconst mockCircuitBreaker = {\n  getStatus: jest.fn(),\n} as unknown as CircuitBreaker;\n\nconst mockBrain = {\n  getEquity: jest.fn(),\n  getPositions: jest.fn(),\n  getAllPhasePerformance: jest.fn(),\n  getAllApprovalRates: jest.fn(),\n  getTreasuryStatus: jest.fn(),\n  getNextSweepTriggerLevel: jest.fn(),\n  getTotalSwept: jest.fn(),\n  getHighWatermark: jest.fn(),\n  getRecentDecisions: jest.fn(),\n  getDashboardData: jest.fn(),\n  getCircuitBreakerStatus: jest.fn(),\n  getAllocation: jest.fn(),\n} as unknown as TitanBrain;\n\ndescribe('DashboardService', () => {\n  let dashboardService: DashboardService;\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n    dashboardService = new DashboardService(mockBrain);\n  });\n\n  describe('calculateNAV', () => {\n    it('should calculate NAV from wallet providers', async () => {\n      // Mock wallet provider\n      const mockWalletBalances: WalletBalance[] = [\n        {\n          exchange: 'bybit',\n          walletType: 'futures',\n          asset: 'USDT',\n          balance: 1000,\n          usdValue: 1000,\n        },\n        {\n          exchange: 'binance',\n          walletType: 'spot',\n          asset: 'USDT',\n          balance: 500,\n          usdValue: 500,\n        },\n      ];\n\n      const mockProvider = jest.fn().mockResolvedValue(mockWalletBalances);\n      dashboardService.registerWalletProvider('test', mockProvider);\n\n      // Mock positions with unrealized PnL\n      const mockPositions: Position[] = [\n        {\n          symbol: 'BTCUSDT',\n          side: 'LONG',\n          size: 100,\n          entryPrice: 50000,\n          unrealizedPnL: 50,\n          leverage: 10,\n          phaseId: 'phase1',\n        },\n      ];\n      (mockBrain.getPositions as jest.Mock).mockReturnValue(mockPositions);\n\n      const result = await dashboardService.calculateNAV();\n\n      expect(result.totalNAV).toBe(1550); // 1000 + 500 + 50\n      expect(result.walletBreakdown).toEqual(mockWalletBalances);\n      expect(result.unrealizedPnL).toBe(50);\n      expect(mockProvider).toHaveBeenCalled();\n    });\n\n    it('should handle wallet provider errors gracefully', async () => {\n      const mockProvider = jest.fn().mockRejectedValue(new Error('API Error'));\n      dashboardService.registerWalletProvider('test', mockProvider);\n\n      (mockBrain.getPositions as jest.Mock).mockReturnValue([]);\n\n      const result = await dashboardService.calculateNAV();\n\n      expect(result.totalNAV).toBe(0);\n      expect(result.walletBreakdown).toEqual([]);\n      expect(result.unrealizedPnL).toBe(0);\n    });\n\n    it('should cache NAV calculation results', async () => {\n      const mockProvider = jest.fn().mockResolvedValue([]);\n      dashboardService.registerWalletProvider('test', mockProvider);\n      (mockBrain.getPositions as jest.Mock).mockReturnValue([]);\n\n      // First call\n      await dashboardService.calculateNAV();\n      expect(mockProvider).toHaveBeenCalledTimes(1);\n\n      // Second call should use cache\n      await dashboardService.calculateNAV();\n      expect(mockProvider).toHaveBeenCalledTimes(1);\n    });\n  });\n\n  describe('formatAllocation', () => {\n    it('should format allocation vector correctly', () => {\n      const allocation: AllocationVector = {\n        w1: 0.6,\n        w2: 0.3,\n        w3: 0.1,\n        timestamp: Date.now(),\n      };\n      const equity = 1000;\n\n      const result = dashboardService.formatAllocation(allocation, equity);\n\n      expect(result.phaseEquity.phase1.weight).toBe(0.6);\n      expect(result.phaseEquity.phase1.equity).toBe(600);\n      expect(result.phaseEquity.phase1.percentage).toBe('60.00%');\n      expect(result.phaseEquity.phase2.equity).toBe(300);\n      expect(result.phaseEquity.phase3.equity).toBe(100);\n      expect(result.totalEquity).toBe(1000);\n    });\n  });\n\n  describe('calculatePhaseEquity', () => {\n    it('should calculate phase equity correctly', () => {\n      const allocation: AllocationVector = {\n        w1: 0.5,\n        w2: 0.3,\n        w3: 0.2,\n        timestamp: Date.now(),\n      };\n      const equity = 2000;\n\n      const result = dashboardService.calculatePhaseEquity(allocation, equity);\n\n      expect(result.phase1).toBe(1000);\n      expect(result.phase2).toBe(600);\n      expect(result.phase3).toBe(400);\n    });\n  });\n\n  describe('exportDashboardJSON', () => {\n    it('should export dashboard data as JSON with metadata', async () => {\n      // Mock dashboard data\n      const mockDashboardData = {\n        nav: 1000,\n        allocation: { w1: 0.6, w2: 0.3, w3: 0.1, timestamp: Date.now() },\n        version: '1.0.0',\n        uptime: 60000,\n      };\n\n      // Mock the getDashboardData method\n      jest.spyOn(dashboardService, 'getDashboardData').mockResolvedValue(mockDashboardData as any);\n\n      const result = await dashboardService.exportDashboardJSON();\n      const parsed = JSON.parse(result);\n\n      expect(parsed.metadata).toBeDefined();\n      expect(parsed.metadata.version).toBe('1.0.0');\n      expect(parsed.metadata.source).toBe('titan-brain-dashboard-service');\n      expect(parsed.data).toEqual(mockDashboardData);\n    });\n  });\n\n  describe('cache management', () => {\n    it('should clear cache correctly', () => {\n      dashboardService.clearCache();\n      \n      const cacheStatus = dashboardService.getCacheStatus();\n      expect(cacheStatus.dashboard.cached).toBe(false);\n      expect(cacheStatus.nav.cached).toBe(false);\n    });\n\n    it('should report cache status correctly', async () => {\n      // Trigger cache population\n      const mockProvider = jest.fn().mockResolvedValue([]);\n      dashboardService.registerWalletProvider('test', mockProvider);\n      (mockBrain.getPositions as jest.Mock).mockReturnValue([]);\n      \n      await dashboardService.calculateNAV();\n      \n      const cacheStatus = dashboardService.getCacheStatus();\n      expect(cacheStatus.nav.cached).toBe(true);\n      expect(cacheStatus.nav.age).toBeGreaterThanOrEqual(0);\n    });\n  });\n});"],"version":3}
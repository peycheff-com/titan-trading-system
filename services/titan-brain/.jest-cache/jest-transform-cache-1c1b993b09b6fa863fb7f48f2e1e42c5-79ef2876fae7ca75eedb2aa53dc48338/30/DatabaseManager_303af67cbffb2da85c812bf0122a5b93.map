{"file":"/Users/ivan/Code/trading/titan/services/titan-brain/src/database/DatabaseManager.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-brain/src/database/DatabaseManager.ts"],"sourcesContent":["/**\n * DatabaseManager - Reliable database connection pooling with health monitoring\n * \n * Provides robust database connectivity with connection pooling, health monitoring,\n * automatic reconnection, and comprehensive error handling for Railway deployment.\n * \n * Requirements: 3.1.1, 3.1.2, 3.1.3, 3.1.4, 3.1.5\n */\n\nimport { Pool, PoolClient, PoolConfig } from 'pg';\nimport { EventEmitter } from 'events';\n\n/**\n * Database connection configuration\n */\nexport interface DatabaseConfig {\n  host: string;\n  port: number;\n  database: string;\n  user: string;\n  password: string;\n  ssl?: boolean | object;\n  \n  // Connection pool settings\n  min: number;\n  max: number;\n  idleTimeoutMillis: number;\n  connectionTimeoutMillis: number;\n  acquireTimeoutMillis: number;\n  \n  // Health check settings\n  healthCheckIntervalMs: number;\n  healthCheckTimeoutMs: number;\n  maxReconnectAttempts: number;\n  reconnectDelayMs: number;\n}\n\n/**\n * Database connection metrics\n */\nexport interface DatabaseMetrics {\n  totalConnections: number;\n  idleConnections: number;\n  waitingClients: number;\n  totalQueries: number;\n  successfulQueries: number;\n  failedQueries: number;\n  averageQueryTime: number;\n  connectionErrors: number;\n  lastHealthCheck: number;\n  isHealthy: boolean;\n}\n\n/**\n * Query execution result with timing\n */\nexport interface QueryResult<T = any> {\n  rows: T[];\n  rowCount: number;\n  duration: number;\n  command: string;\n}\n\n/**\n * Database connection pool manager with health monitoring\n */\nexport class DatabaseManager extends EventEmitter {\n  private pool: Pool | null = null;\n  private config: DatabaseConfig;\n  private metrics: DatabaseMetrics;\n  private healthCheckInterval: NodeJS.Timeout | null = null;\n  private reconnectAttempts: number = 0;\n  private isShuttingDown: boolean = false;\n  private queryHistory: number[] = []; // Query times for average calculation\n\n  constructor(config: DatabaseConfig) {\n    super();\n    this.config = config;\n    this.metrics = this.initializeMetrics();\n  }\n\n  /**\n   * Initialize metrics object\n   */\n  private initializeMetrics(): DatabaseMetrics {\n    return {\n      totalConnections: 0,\n      idleConnections: 0,\n      waitingClients: 0,\n      totalQueries: 0,\n      successfulQueries: 0,\n      failedQueries: 0,\n      averageQueryTime: 0,\n      connectionErrors: 0,\n      lastHealthCheck: 0,\n      isHealthy: false\n    };\n  }\n\n  /**\n   * Create database configuration from environment variables\n   */\n  static createConfigFromEnv(): DatabaseConfig {\n    // Parse Railway DATABASE_URL if available\n    const databaseUrl = process.env.DATABASE_URL;\n    let parsedConfig: Partial<DatabaseConfig> = {};\n\n    if (databaseUrl) {\n      try {\n        const url = new URL(databaseUrl);\n        parsedConfig = {\n          host: url.hostname,\n          port: parseInt(url.port) || 5432,\n          database: url.pathname.slice(1), // Remove leading slash\n          user: url.username,\n          password: url.password,\n          ssl: url.searchParams.get('sslmode') !== 'disable'\n        };\n      } catch (error) {\n        console.warn('Failed to parse DATABASE_URL, falling back to individual env vars');\n      }\n    }\n\n    return {\n      host: parsedConfig.host || process.env.DB_HOST || 'localhost',\n      port: parsedConfig.port || parseInt(process.env.DB_PORT || '5432'),\n      database: parsedConfig.database || process.env.DB_NAME || 'titan_brain',\n      user: parsedConfig.user || process.env.DB_USER || 'postgres',\n      password: parsedConfig.password || process.env.DB_PASSWORD || '',\n      ssl: parsedConfig.ssl !== undefined ? parsedConfig.ssl : (process.env.DB_SSL === 'true'),\n      \n      // Connection pool settings\n      min: parseInt(process.env.DB_POOL_MIN || '2'),\n      max: parseInt(process.env.DB_POOL_MAX || '10'),\n      idleTimeoutMillis: parseInt(process.env.DB_IDLE_TIMEOUT || '30000'),\n      connectionTimeoutMillis: parseInt(process.env.DB_CONNECTION_TIMEOUT || '10000'),\n      acquireTimeoutMillis: parseInt(process.env.DB_ACQUIRE_TIMEOUT || '5000'),\n      \n      // Health check settings\n      healthCheckIntervalMs: parseInt(process.env.DB_HEALTH_CHECK_INTERVAL || '30000'),\n      healthCheckTimeoutMs: parseInt(process.env.DB_HEALTH_CHECK_TIMEOUT || '5000'),\n      maxReconnectAttempts: parseInt(process.env.DB_MAX_RECONNECT_ATTEMPTS || '5'),\n      reconnectDelayMs: parseInt(process.env.DB_RECONNECT_DELAY || '5000')\n    };\n  }\n\n  /**\n   * Initialize database connection pool\n   */\n  async initialize(): Promise<void> {\n    if (this.pool) {\n      throw new Error('DatabaseManager already initialized');\n    }\n\n    const poolConfig: PoolConfig = {\n      host: this.config.host,\n      port: this.config.port,\n      database: this.config.database,\n      user: this.config.user,\n      password: this.config.password,\n      ssl: this.config.ssl,\n      min: this.config.min,\n      max: this.config.max,\n      idleTimeoutMillis: this.config.idleTimeoutMillis,\n      connectionTimeoutMillis: this.config.connectionTimeoutMillis\n    };\n\n    this.pool = new Pool(poolConfig);\n\n    // Set up pool event listeners\n    this.setupPoolEventListeners();\n\n    // Test initial connection\n    await this.testConnection();\n\n    // Start health check monitoring\n    this.startHealthCheckMonitoring();\n\n    this.emit('initialized');\n  }\n\n  /**\n   * Set up pool event listeners for monitoring\n   */\n  private setupPoolEventListeners(): void {\n    if (!this.pool) return;\n\n    this.pool.on('connect', (client) => {\n      this.metrics.totalConnections++;\n      this.emit('connection:established', { totalConnections: this.metrics.totalConnections });\n    });\n\n    this.pool.on('acquire', (client) => {\n      this.updatePoolMetrics();\n    });\n\n    this.pool.on('release', (client) => {\n      this.updatePoolMetrics();\n    });\n\n    this.pool.on('remove', (client) => {\n      this.metrics.totalConnections--;\n      this.emit('connection:removed', { totalConnections: this.metrics.totalConnections });\n    });\n\n    this.pool.on('error', (error, client) => {\n      this.metrics.connectionErrors++;\n      this.metrics.isHealthy = false;\n      this.emit('connection:error', { error: error.message, connectionErrors: this.metrics.connectionErrors });\n      \n      // Attempt reconnection if not shutting down\n      if (!this.isShuttingDown) {\n        this.attemptReconnection();\n      }\n    });\n  }\n\n  /**\n   * Update pool metrics from current pool state\n   */\n  private updatePoolMetrics(): void {\n    if (!this.pool) return;\n\n    this.metrics.totalConnections = this.pool.totalCount;\n    this.metrics.idleConnections = this.pool.idleCount;\n    this.metrics.waitingClients = this.pool.waitingCount;\n  }\n\n  /**\n   * Test database connection\n   */\n  private async testConnection(): Promise<void> {\n    if (!this.pool) {\n      throw new Error('Pool not initialized');\n    }\n\n    const client = await this.pool.connect();\n    try {\n      await client.query('SELECT 1');\n      this.metrics.isHealthy = true;\n      this.reconnectAttempts = 0; // Reset on successful connection\n    } finally {\n      client.release();\n    }\n  }\n\n  /**\n   * Start health check monitoring\n   */\n  private startHealthCheckMonitoring(): void {\n    if (this.healthCheckInterval) {\n      clearInterval(this.healthCheckInterval);\n    }\n\n    this.healthCheckInterval = setInterval(async () => {\n      await this.performHealthCheck();\n    }, this.config.healthCheckIntervalMs);\n  }\n\n  /**\n   * Perform health check\n   */\n  private async performHealthCheck(): Promise<void> {\n    if (this.isShuttingDown) return;\n\n    const startTime = Date.now();\n    \n    try {\n      await Promise.race([\n        this.testConnection(),\n        new Promise((_, reject) => \n          setTimeout(() => reject(new Error('Health check timeout')), this.config.healthCheckTimeoutMs)\n        )\n      ]);\n\n      this.metrics.lastHealthCheck = Date.now();\n      this.metrics.isHealthy = true;\n      this.emit('health:check:success', { duration: Date.now() - startTime });\n    } catch (error) {\n      this.metrics.lastHealthCheck = Date.now();\n      this.metrics.isHealthy = false;\n      this.emit('health:check:failure', { \n        error: error instanceof Error ? error.message : 'Unknown error',\n        duration: Date.now() - startTime\n      });\n\n      // Attempt reconnection on health check failure\n      this.attemptReconnection();\n    }\n  }\n\n  /**\n   * Attempt database reconnection with exponential backoff\n   */\n  private async attemptReconnection(): Promise<void> {\n    if (this.isShuttingDown || this.reconnectAttempts >= this.config.maxReconnectAttempts) {\n      return;\n    }\n\n    this.reconnectAttempts++;\n    const delay = this.config.reconnectDelayMs * Math.pow(2, this.reconnectAttempts - 1);\n    \n    this.emit('reconnection:attempt', { \n      attempt: this.reconnectAttempts, \n      maxAttempts: this.config.maxReconnectAttempts,\n      delay \n    });\n\n    setTimeout(async () => {\n      try {\n        await this.testConnection();\n        this.emit('reconnection:success', { attempts: this.reconnectAttempts });\n        this.reconnectAttempts = 0;\n      } catch (error) {\n        this.emit('reconnection:failure', { \n          attempt: this.reconnectAttempts,\n          error: error instanceof Error ? error.message : 'Unknown error'\n        });\n        \n        // Continue attempting if we haven't reached max attempts\n        if (this.reconnectAttempts < this.config.maxReconnectAttempts) {\n          this.attemptReconnection();\n        } else {\n          this.emit('reconnection:exhausted', { maxAttempts: this.config.maxReconnectAttempts });\n        }\n      }\n    }, delay);\n  }\n\n  /**\n   * Execute a query with timing and error handling\n   */\n  async query<T = any>(text: string, params?: any[]): Promise<QueryResult<T>> {\n    if (!this.pool) {\n      throw new Error('DatabaseManager not initialized');\n    }\n\n    if (!this.metrics.isHealthy) {\n      throw new Error('Database is not healthy');\n    }\n\n    const startTime = Date.now();\n    this.metrics.totalQueries++;\n\n    try {\n      const result = await this.pool.query(text, params);\n      const duration = Date.now() - startTime;\n      \n      // Update metrics\n      this.metrics.successfulQueries++;\n      this.updateQueryTimeMetrics(duration);\n      \n      this.emit('query:success', { \n        command: result.command,\n        rowCount: result.rowCount,\n        duration \n      });\n\n      return {\n        rows: result.rows,\n        rowCount: result.rowCount || 0,\n        duration,\n        command: result.command || 'UNKNOWN'\n      };\n    } catch (error) {\n      const duration = Date.now() - startTime;\n      this.metrics.failedQueries++;\n      \n      this.emit('query:failure', { \n        error: error instanceof Error ? error.message : 'Unknown error',\n        duration,\n        query: text.substring(0, 100) // Log first 100 chars for debugging\n      });\n      \n      throw error;\n    }\n  }\n\n  /**\n   * Execute a query with a specific client (for transactions)\n   */\n  async queryWithClient<T = any>(client: PoolClient, text: string, params?: any[]): Promise<QueryResult<T>> {\n    const startTime = Date.now();\n    this.metrics.totalQueries++;\n\n    try {\n      const result = await client.query(text, params);\n      const duration = Date.now() - startTime;\n      \n      // Update metrics\n      this.metrics.successfulQueries++;\n      this.updateQueryTimeMetrics(duration);\n      \n      this.emit('query:success', { \n        command: result.command,\n        rowCount: result.rowCount,\n        duration \n      });\n\n      return {\n        rows: result.rows,\n        rowCount: result.rowCount || 0,\n        duration,\n        command: result.command || 'UNKNOWN'\n      };\n    } catch (error) {\n      const duration = Date.now() - startTime;\n      this.metrics.failedQueries++;\n      \n      this.emit('query:failure', { \n        error: error instanceof Error ? error.message : 'Unknown error',\n        duration,\n        query: text.substring(0, 100)\n      });\n      \n      throw error;\n    }\n  }\n\n  /**\n   * Get a client from the pool for transactions\n   */\n  async getClient(): Promise<PoolClient> {\n    if (!this.pool) {\n      throw new Error('DatabaseManager not initialized');\n    }\n\n    if (!this.metrics.isHealthy) {\n      throw new Error('Database is not healthy');\n    }\n\n    return await this.pool.connect();\n  }\n\n  /**\n   * Execute a transaction with automatic rollback on error\n   */\n  async transaction<T>(callback: (client: PoolClient) => Promise<T>): Promise<T> {\n    const client = await this.getClient();\n    \n    try {\n      await client.query('BEGIN');\n      const result = await callback(client);\n      await client.query('COMMIT');\n      \n      this.emit('transaction:success');\n      return result;\n    } catch (error) {\n      await client.query('ROLLBACK');\n      this.emit('transaction:rollback', { \n        error: error instanceof Error ? error.message : 'Unknown error' \n      });\n      throw error;\n    } finally {\n      client.release();\n    }\n  }\n\n  /**\n   * Update query time metrics\n   */\n  private updateQueryTimeMetrics(duration: number): void {\n    this.queryHistory.push(duration);\n    \n    // Keep only last 100 queries for average calculation\n    if (this.queryHistory.length > 100) {\n      this.queryHistory.shift();\n    }\n    \n    // Calculate average query time\n    this.metrics.averageQueryTime = this.queryHistory.reduce((sum, time) => sum + time, 0) / this.queryHistory.length;\n  }\n\n  /**\n   * Get current database metrics\n   */\n  getMetrics(): DatabaseMetrics {\n    this.updatePoolMetrics();\n    return { ...this.metrics };\n  }\n\n  /**\n   * Check if database is healthy\n   */\n  isHealthy(): boolean {\n    return this.metrics.isHealthy && this.pool !== null;\n  }\n\n  /**\n   * Get connection pool status\n   */\n  getPoolStatus(): {\n    totalConnections: number;\n    idleConnections: number;\n    waitingClients: number;\n    isHealthy: boolean;\n  } {\n    this.updatePoolMetrics();\n    return {\n      totalConnections: this.metrics.totalConnections,\n      idleConnections: this.metrics.idleConnections,\n      waitingClients: this.metrics.waitingClients,\n      isHealthy: this.metrics.isHealthy\n    };\n  }\n\n  /**\n   * Gracefully shutdown the database manager\n   */\n  async shutdown(): Promise<void> {\n    this.isShuttingDown = true;\n\n    // Stop health check monitoring\n    if (this.healthCheckInterval) {\n      clearInterval(this.healthCheckInterval);\n      this.healthCheckInterval = null;\n    }\n\n    // Close connection pool\n    if (this.pool) {\n      await this.pool.end();\n      this.pool = null;\n    }\n\n    this.emit('shutdown');\n  }\n}"],"version":3}
4d36e78a478f97c37810d39824829cad
"use strict";
/**
 * StartupManager - Reliable service initialization for Railway deployment
 *
 * Ensures reliable service initialization with proper error handling,
 * timeout management, and graceful shutdown for Railway deployment.
 *
 * Requirements: 1.2.1, 1.2.2, 1.2.3, 1.2.4, 1.2.5
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.StartupManager = exports.StartupStatus = void 0;
const events_1 = require("events");
const Logger_js_1 = require("../logging/Logger.js");
/**
 * Startup step status
 */
var StartupStatus;
(function (StartupStatus) {
    StartupStatus["PENDING"] = "pending";
    StartupStatus["RUNNING"] = "running";
    StartupStatus["COMPLETED"] = "completed";
    StartupStatus["FAILED"] = "failed";
    StartupStatus["SKIPPED"] = "skipped";
})(StartupStatus || (exports.StartupStatus = StartupStatus = {}));
/**
 * Startup manager for reliable service initialization
 */
class StartupManager extends events_1.EventEmitter {
    steps = new Map();
    results = new Map();
    config;
    logger;
    startTime = 0;
    isStarted = false;
    isShuttingDown = false;
    shutdownHandlers = [];
    constructor(config = {}, logger) {
        super();
        this.config = {
            maxStartupTime: config.maxStartupTime || 60000, // 60 seconds
            stepTimeout: config.stepTimeout || 30000, // 30 seconds
            maxRetries: config.maxRetries || 3,
            retryDelay: config.retryDelay || 1000, // 1 second
            gracefulShutdownTimeout: config.gracefulShutdownTimeout || 10000, // 10 seconds
            validateEnvironment: config.validateEnvironment ?? true
        };
        this.logger = logger ?? Logger_js_1.Logger.getInstance('startup-manager');
        // Setup process signal handlers
        this.setupSignalHandlers();
    }
    /**
     * Register a startup step
     */
    registerStep(step) {
        if (this.isStarted) {
            throw new Error('Cannot register steps after startup has begun');
        }
        this.steps.set(step.name, step);
        this.emit('step:registered', { name: step.name });
        this.logger.debug(`Startup step registered: ${step.name}`, undefined, {
            description: step.description,
            timeout: step.timeout,
            required: step.required,
            dependencies: step.dependencies
        });
    }
    /**
     * Register a shutdown handler
     */
    registerShutdownHandler(handler) {
        this.shutdownHandlers.push(handler);
    }
    /**
     * Start the initialization process
     */
    async start() {
        if (this.isStarted) {
            throw new Error('Startup manager has already been started');
        }
        this.isStarted = true;
        this.startTime = Date.now();
        this.logger.info('Starting service initialization', undefined, {
            totalSteps: this.steps.size,
            maxStartupTime: this.config.maxStartupTime
        });
        this.emit('startup:started');
        try {
            // Validate environment if enabled
            if (this.config.validateEnvironment) {
                await this.validateEnvironment();
            }
            // Execute startup steps
            await this.executeSteps();
            const duration = Date.now() - this.startTime;
            this.logger.info('Service initialization completed successfully', undefined, {
                duration,
                completedSteps: Array.from(this.results.values()).filter(r => r.status === StartupStatus.COMPLETED).length,
                failedSteps: Array.from(this.results.values()).filter(r => r.status === StartupStatus.FAILED).length
            });
            this.emit('startup:completed', { duration });
        }
        catch (error) {
            const duration = Date.now() - this.startTime;
            this.logger.error('Service initialization failed', error instanceof Error ? error : new Error(String(error)), undefined, {
                duration,
                completedSteps: Array.from(this.results.values()).filter(r => r.status === StartupStatus.COMPLETED).length,
                failedSteps: Array.from(this.results.values()).filter(r => r.status === StartupStatus.FAILED).length
            });
            this.emit('startup:failed', { error, duration });
            throw error;
        }
    }
    /**
     * Validate environment variables
     */
    async validateEnvironment() {
        this.logger.info('Validating environment configuration');
        const requiredVariables = [
            'NODE_ENV',
            'PORT',
            'DATABASE_URL'
        ];
        const optionalVariables = [
            'REDIS_URL',
            'HMAC_SECRET',
            'LOG_LEVEL',
            'RATE_LIMIT_WINDOW_MS',
            'RATE_LIMIT_MAX_REQUESTS'
        ];
        const errors = [];
        const warnings = [];
        // Check required variables
        for (const variable of requiredVariables) {
            if (!process.env[variable]) {
                errors.push(`Required environment variable ${variable} is not set`);
            }
        }
        // Check optional variables and warn if missing
        for (const variable of optionalVariables) {
            if (!process.env[variable]) {
                warnings.push(`Optional environment variable ${variable} is not set`);
            }
        }
        // Validate specific values
        if (process.env.NODE_ENV && !['development', 'production', 'test'].includes(process.env.NODE_ENV)) {
            errors.push(`NODE_ENV must be one of: development, production, test. Got: ${process.env.NODE_ENV}`);
        }
        if (process.env.PORT) {
            const port = parseInt(process.env.PORT, 10);
            if (isNaN(port) || port < 1 || port > 65535) {
                errors.push(`PORT must be a valid port number (1-65535). Got: ${process.env.PORT}`);
            }
        }
        if (process.env.LOG_LEVEL && !['fatal', 'error', 'warn', 'info', 'debug', 'trace'].includes(process.env.LOG_LEVEL)) {
            warnings.push(`LOG_LEVEL should be one of: fatal, error, warn, info, debug, trace. Got: ${process.env.LOG_LEVEL}`);
        }
        const result = {
            valid: errors.length === 0,
            errors,
            warnings,
            requiredVariables,
            optionalVariables
        };
        // Log warnings
        for (const warning of warnings) {
            this.logger.warn(warning);
        }
        // Log configuration summary (mask sensitive values)
        const configSummary = {
            NODE_ENV: process.env.NODE_ENV,
            PORT: process.env.PORT,
            DATABASE_URL: process.env.DATABASE_URL ? '[CONFIGURED]' : '[NOT SET]',
            REDIS_URL: process.env.REDIS_URL ? '[CONFIGURED]' : '[NOT SET]',
            HMAC_SECRET: process.env.HMAC_SECRET ? '[CONFIGURED]' : '[NOT SET]',
            LOG_LEVEL: process.env.LOG_LEVEL || 'info'
        };
        this.logger.info('Environment configuration summary', undefined, configSummary);
        this.emit('environment:validated', result);
        if (!result.valid) {
            const error = new Error(`Environment validation failed: ${errors.join(', ')}`);
            this.logger.error('Environment validation failed', error, undefined, { errors, warnings });
            throw error;
        }
        this.logger.info('Environment validation completed successfully', undefined, {
            warningCount: warnings.length
        });
    }
    /**
     * Execute all startup steps in dependency order
     */
    async executeSteps() {
        const executionOrder = this.calculateExecutionOrder();
        this.logger.info('Executing startup steps', undefined, {
            executionOrder,
            totalSteps: executionOrder.length
        });
        for (const stepName of executionOrder) {
            const step = this.steps.get(stepName);
            if (!step) {
                throw new Error(`Step ${stepName} not found`);
            }
            await this.executeStep(step);
            // Check if we've exceeded the maximum startup time
            const elapsed = Date.now() - this.startTime;
            if (elapsed > this.config.maxStartupTime) {
                throw new Error(`Startup timeout exceeded: ${elapsed}ms > ${this.config.maxStartupTime}ms`);
            }
        }
    }
    /**
     * Calculate execution order based on dependencies
     */
    calculateExecutionOrder() {
        const visited = new Set();
        const visiting = new Set();
        const order = [];
        const visit = (stepName) => {
            if (visiting.has(stepName)) {
                throw new Error(`Circular dependency detected involving step: ${stepName}`);
            }
            if (visited.has(stepName)) {
                return;
            }
            visiting.add(stepName);
            const step = this.steps.get(stepName);
            if (!step) {
                throw new Error(`Step ${stepName} not found`);
            }
            // Visit dependencies first
            for (const dependency of step.dependencies) {
                if (!this.steps.has(dependency)) {
                    throw new Error(`Dependency ${dependency} for step ${stepName} not found`);
                }
                visit(dependency);
            }
            visiting.delete(stepName);
            visited.add(stepName);
            order.push(stepName);
        };
        // Visit all steps
        for (const stepName of this.steps.keys()) {
            visit(stepName);
        }
        return order;
    }
    /**
     * Execute a single startup step with retry logic
     */
    async executeStep(step) {
        const startTime = Date.now();
        this.logger.info(`Executing startup step: ${step.name}`, undefined, {
            description: step.description,
            timeout: step.timeout,
            required: step.required
        });
        this.emit('step:started', { name: step.name });
        let lastError;
        let attempt = 0;
        while (attempt < this.config.maxRetries) {
            attempt++;
            try {
                // Execute step with timeout
                await Promise.race([
                    step.execute(),
                    new Promise((_, reject) => setTimeout(() => reject(new Error(`Step timeout: ${step.name}`)), step.timeout))
                ]);
                const duration = Date.now() - startTime;
                const result = {
                    name: step.name,
                    status: StartupStatus.COMPLETED,
                    duration,
                    timestamp: Date.now()
                };
                this.results.set(step.name, result);
                this.logger.info(`Startup step completed: ${step.name}`, undefined, {
                    duration,
                    attempt
                });
                this.emit('step:completed', result);
                return;
            }
            catch (error) {
                lastError = error instanceof Error ? error : new Error(String(error));
                this.logger.warn(`Startup step failed (attempt ${attempt}/${this.config.maxRetries}): ${step.name}`, undefined, {
                    attempt,
                    maxRetries: this.config.maxRetries
                });
                if (attempt < this.config.maxRetries) {
                    // Wait before retry
                    await new Promise(resolve => setTimeout(resolve, this.config.retryDelay * attempt));
                }
            }
        }
        // All retries failed
        const duration = Date.now() - startTime;
        const result = {
            name: step.name,
            status: StartupStatus.FAILED,
            duration,
            error: lastError,
            timestamp: Date.now()
        };
        this.results.set(step.name, result);
        this.logger.error(`Startup step failed permanently: ${step.name}`, lastError, undefined, {
            duration,
            attempts: attempt,
            required: step.required
        });
        this.emit('step:failed', result);
        if (step.required) {
            throw new Error(`Required startup step failed: ${step.name} - ${lastError?.message}`);
        }
        else {
            this.logger.warn(`Optional startup step failed, continuing: ${step.name}`);
        }
    }
    /**
     * Setup process signal handlers for graceful shutdown
     */
    setupSignalHandlers() {
        const signals = ['SIGTERM', 'SIGINT', 'SIGUSR2'];
        for (const signal of signals) {
            process.on(signal, async () => {
                this.logger.info(`Received ${signal}, initiating graceful shutdown`);
                await this.shutdown();
                process.exit(0);
            });
        }
        // Handle uncaught exceptions
        process.on('uncaughtException', (error) => {
            this.logger.error('Uncaught exception, shutting down', error);
            this.shutdown().finally(() => process.exit(1));
        });
        // Handle unhandled promise rejections
        process.on('unhandledRejection', (reason, promise) => {
            this.logger.error('Unhandled promise rejection, shutting down', new Error(String(reason)), undefined, {
                promise: promise.toString()
            });
            this.shutdown().finally(() => process.exit(1));
        });
    }
    /**
     * Graceful shutdown
     */
    async shutdown() {
        if (this.isShuttingDown) {
            this.logger.warn('Shutdown already in progress');
            return;
        }
        this.isShuttingDown = true;
        const shutdownStart = Date.now();
        this.logger.info('Starting graceful shutdown', undefined, {
            shutdownHandlers: this.shutdownHandlers.length,
            timeout: this.config.gracefulShutdownTimeout
        });
        this.emit('shutdown:started');
        try {
            // Execute shutdown handlers with timeout
            await Promise.race([
                this.executeShutdownHandlers(),
                new Promise((_, reject) => setTimeout(() => reject(new Error('Shutdown timeout')), this.config.gracefulShutdownTimeout))
            ]);
            const duration = Date.now() - shutdownStart;
            this.logger.info('Graceful shutdown completed', undefined, { duration });
            this.emit('shutdown:completed', { duration });
        }
        catch (error) {
            const duration = Date.now() - shutdownStart;
            this.logger.error('Graceful shutdown failed', error instanceof Error ? error : new Error(String(error)), undefined, {
                duration
            });
            this.emit('shutdown:failed', { error, duration });
            throw error;
        }
    }
    /**
     * Execute all shutdown handlers
     */
    async executeShutdownHandlers() {
        const promises = this.shutdownHandlers.map(async (handler, index) => {
            try {
                await handler();
                this.logger.debug(`Shutdown handler ${index} completed`);
            }
            catch (error) {
                this.logger.error(`Shutdown handler ${index} failed`, error instanceof Error ? error : new Error(String(error)));
                throw error;
            }
        });
        await Promise.all(promises);
    }
    /**
     * Get startup results
     */
    getResults() {
        return Array.from(this.results.values());
    }
    /**
     * Get startup duration
     */
    getStartupDuration() {
        return this.startTime > 0 ? Date.now() - this.startTime : 0;
    }
    /**
     * Check if startup is complete
     */
    isStartupComplete() {
        if (!this.isStarted)
            return false;
        const requiredSteps = Array.from(this.steps.values()).filter(step => step.required);
        const completedRequiredSteps = Array.from(this.results.values()).filter(result => result.status === StartupStatus.COMPLETED &&
            this.steps.get(result.name)?.required);
        return completedRequiredSteps.length === requiredSteps.length;
    }
    /**
     * Get startup status summary
     */
    getStatusSummary() {
        const results = Array.from(this.results.values());
        return {
            started: this.isStarted,
            completed: this.isStartupComplete(),
            failed: results.some(r => r.status === StartupStatus.FAILED && this.steps.get(r.name)?.required),
            duration: this.getStartupDuration(),
            totalSteps: this.steps.size,
            completedSteps: results.filter(r => r.status === StartupStatus.COMPLETED).length,
            failedSteps: results.filter(r => r.status === StartupStatus.FAILED).length,
            pendingSteps: this.steps.size - results.length
        };
    }
}
exports.StartupManager = StartupManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLWJyYWluL3NyYy9zdGFydHVwL1N0YXJ0dXBNYW5hZ2VyLnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7Ozs7OztHQU9HOzs7QUFFSCxtQ0FBc0M7QUFDdEMsb0RBQThDO0FBRTlDOztHQUVHO0FBQ0gsSUFBWSxhQU1YO0FBTkQsV0FBWSxhQUFhO0lBQ3ZCLG9DQUFtQixDQUFBO0lBQ25CLG9DQUFtQixDQUFBO0lBQ25CLHdDQUF1QixDQUFBO0lBQ3ZCLGtDQUFpQixDQUFBO0lBQ2pCLG9DQUFtQixDQUFBO0FBQ3JCLENBQUMsRUFOVyxhQUFhLDZCQUFiLGFBQWEsUUFNeEI7QUFnREQ7O0dBRUc7QUFDSCxNQUFhLGNBQWUsU0FBUSxxQkFBWTtJQUN0QyxLQUFLLEdBQTZCLElBQUksR0FBRyxFQUFFLENBQUM7SUFDNUMsT0FBTyxHQUFtQyxJQUFJLEdBQUcsRUFBRSxDQUFDO0lBQ3BELE1BQU0sQ0FBdUI7SUFDN0IsTUFBTSxDQUFTO0lBQ2YsU0FBUyxHQUFXLENBQUMsQ0FBQztJQUN0QixTQUFTLEdBQVksS0FBSyxDQUFDO0lBQzNCLGNBQWMsR0FBWSxLQUFLLENBQUM7SUFDaEMsZ0JBQWdCLEdBQStCLEVBQUUsQ0FBQztJQUUxRCxZQUFZLFNBQXdDLEVBQUUsRUFBRSxNQUFlO1FBQ3JFLEtBQUssRUFBRSxDQUFDO1FBRVIsSUFBSSxDQUFDLE1BQU0sR0FBRztZQUNaLGNBQWMsRUFBRSxNQUFNLENBQUMsY0FBYyxJQUFJLEtBQUssRUFBRSxhQUFhO1lBQzdELFdBQVcsRUFBRSxNQUFNLENBQUMsV0FBVyxJQUFJLEtBQUssRUFBRSxhQUFhO1lBQ3ZELFVBQVUsRUFBRSxNQUFNLENBQUMsVUFBVSxJQUFJLENBQUM7WUFDbEMsVUFBVSxFQUFFLE1BQU0sQ0FBQyxVQUFVLElBQUksSUFBSSxFQUFFLFdBQVc7WUFDbEQsdUJBQXVCLEVBQUUsTUFBTSxDQUFDLHVCQUF1QixJQUFJLEtBQUssRUFBRSxhQUFhO1lBQy9F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RSxDQUFDLENBQUMsQ0FBQyxNQUFNLEtBQUssYUFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFDLE1BQU07WUFDaEYsV0FBVyxFQUFFLE9BQU8sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsTUFBTSxLQUFLLGFBQWEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxNQUFNO1lBQzFFLFlBQVksRUFBRSxJQUFJLENBQUMsS0FBSyxDQUFDLElBQUksR0FBRyxPQUFPLENBQUMsTUFBTTtTQUMvQyxDQUFDO0lBQ0osQ0FBQztDQUNGO0FBdmZELHdDQXVmQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvaXZhbi9Db2RlL3RyYWRpbmcvdGl0YW4vc2VydmljZXMvdGl0YW4tYnJhaW4vc3JjL3N0YXJ0dXAvU3RhcnR1cE1hbmFnZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBTdGFydHVwTWFuYWdlciAtIFJlbGlhYmxlIHNlcnZpY2UgaW5pdGlhbGl6YXRpb24gZm9yIFJhaWx3YXkgZGVwbG95bWVudFxuICogXG4gKiBFbnN1cmVzIHJlbGlhYmxlIHNlcnZpY2UgaW5pdGlhbGl6YXRpb24gd2l0aCBwcm9wZXIgZXJyb3IgaGFuZGxpbmcsXG4gKiB0aW1lb3V0IG1hbmFnZW1lbnQsIGFuZCBncmFjZWZ1bCBzaHV0ZG93biBmb3IgUmFpbHdheSBkZXBsb3ltZW50LlxuICogXG4gKiBSZXF1aXJlbWVudHM6IDEuMi4xLCAxLjIuMiwgMS4yLjMsIDEuMi40LCAxLjIuNVxuICovXG5cbmltcG9ydCB7IEV2ZW50RW1pdHRlciB9IGZyb20gJ2V2ZW50cyc7XG5pbXBvcnQgeyBMb2dnZXIgfSBmcm9tICcuLi9sb2dnaW5nL0xvZ2dlci5qcyc7XG5cbi8qKlxuICogU3RhcnR1cCBzdGVwIHN0YXR1c1xuICovXG5leHBvcnQgZW51bSBTdGFydHVwU3RhdHVzIHtcbiAgUEVORElORyA9ICdwZW5kaW5nJyxcbiAgUlVOTklORyA9ICdydW5uaW5nJyxcbiAgQ09NUExFVEVEID0gJ2NvbXBsZXRlZCcsXG4gIEZBSUxFRCA9ICdmYWlsZWQnLFxuICBTS0lQUEVEID0gJ3NraXBwZWQnXG59XG5cbi8qKlxuICogSW5kaXZpZHVhbCBzdGFydHVwIHN0ZXBcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBTdGFydHVwU3RlcCB7XG4gIG5hbWU6IHN0cmluZztcbiAgZGVzY3JpcHRpb246IHN0cmluZztcbiAgdGltZW91dDogbnVtYmVyO1xuICByZXF1aXJlZDogYm9vbGVhbjtcbiAgZGVwZW5kZW5jaWVzOiBzdHJpbmdbXTtcbiAgZXhlY3V0ZTogKCkgPT4gUHJvbWlzZTx2b2lkPjtcbn1cblxuLyoqXG4gKiBTdGFydHVwIHN0ZXAgcmVzdWx0XG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgU3RhcnR1cFN0ZXBSZXN1bHQge1xuICBuYW1lOiBzdHJpbmc7XG4gIHN0YXR1czogU3RhcnR1cFN0YXR1cztcbiAgZHVyYXRpb246IG51bWJlcjtcbiAgZXJyb3I/OiBFcnJvcjtcbiAgdGltZXN0YW1wOiBudW1iZXI7XG59XG5cbi8qKlxuICogU3RhcnR1cCBtYW5hZ2VyIGNvbmZpZ3VyYXRpb25cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBTdGFydHVwTWFuYWdlckNvbmZpZyB7XG4gIG1heFN0YXJ0dXBUaW1lOiBudW1iZXI7XG4gIHN0ZXBUaW1lb3V0OiBudW1iZXI7XG4gIG1heFJldHJpZXM6IG51bWJlcjtcbiAgcmV0cnlEZWxheTogbnVtYmVyO1xuICBncmFjZWZ1bFNodXRkb3duVGltZW91dDogbnVtYmVyO1xuICB2YWxpZGF0ZUVudmlyb25tZW50OiBib29sZWFuO1xufVxuXG4vKipcbiAqIEVudmlyb25tZW50IHZhbGlkYXRpb24gcmVzdWx0XG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRW52aXJvbm1lbnRWYWxpZGF0aW9uUmVzdWx0IHtcbiAgdmFsaWQ6IGJvb2xlYW47XG4gIGVycm9yczogc3RyaW5nW107XG4gIHdhcm5pbmdzOiBzdHJpbmdbXTtcbiAgcmVxdWlyZWRWYXJpYWJsZXM6IHN0cmluZ1tdO1xuICBvcHRpb25hbFZhcmlhYmxlczogc3RyaW5nW107XG59XG5cbi8qKlxuICogU3RhcnR1cCBtYW5hZ2VyIGZvciByZWxpYWJsZSBzZXJ2aWNlIGluaXRpYWxpemF0aW9uXG4gKi9cbmV4cG9ydCBjbGFzcyBTdGFydHVwTWFuYWdlciBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG4gIHByaXZhdGUgc3RlcHM6IE1hcDxzdHJpbmcsIFN0YXJ0dXBTdGVwPiA9IG5ldyBNYXAoKTtcbiAgcHJpdmF0ZSByZXN1bHRzOiBNYXA8c3RyaW5nLCBTdGFydHVwU3RlcFJlc3VsdD4gPSBuZXcgTWFwKCk7XG4gIHByaXZhdGUgY29uZmlnOiBTdGFydHVwTWFuYWdlckNvbmZpZztcbiAgcHJpdmF0ZSBsb2dnZXI6IExvZ2dlcjtcbiAgcHJpdmF0ZSBzdGFydFRpbWU6IG51bWJlciA9IDA7XG4gIHByaXZhdGUgaXNTdGFydGVkOiBib29sZWFuID0gZmFsc2U7XG4gIHByaXZhdGUgaXNTaHV0dGluZ0Rvd246IGJvb2xlYW4gPSBmYWxzZTtcbiAgcHJpdmF0ZSBzaHV0ZG93bkhhbmRsZXJzOiBBcnJheTwoKSA9PiBQcm9taXNlPHZvaWQ+PiA9IFtdO1xuXG4gIGNvbnN0cnVjdG9yKGNvbmZpZzogUGFydGlhbDxTdGFydHVwTWFuYWdlckNvbmZpZz4gPSB7fSwgbG9nZ2VyPzogTG9nZ2VyKSB7XG4gICAgc3VwZXIoKTtcbiAgICBcbiAgICB0aGlzLmNvbmZpZyA9IHtcbiAgICAgIG1heFN0YXJ0dXBUaW1lOiBjb25maWcubWF4U3RhcnR1cFRpbWUgfHwgNjAwMDAsIC8vIDYwIHNlY29uZHNcbiAgICAgIHN0ZXBUaW1lb3V0OiBjb25maWcuc3RlcFRpbWVvdXQgfHwgMzAwMDAsIC8vIDMwIHNlY29uZHNcbiAgICAgIG1heFJldHJpZXM6IGNvbmZpZy5tYXhSZXRyaWVzIHx8IDMsXG4gICAgICByZXRyeURlbGF5OiBjb25maWcucmV0cnlEZWxheSB8fCAxMDAwLCAvLyAxIHNlY29uZFxuICAgICAgZ3JhY2VmdWxTaHV0ZG93blRpbWVvdXQ6IGNvbmZpZy5ncmFjZWZ1bFNodXRkb3duVGltZW91dCB8fCAxMDAwMCwgLy8gMTAgc2Vjb25kc1xuICAgICAgdmFsaWRhdGVFbnZpcm9ubWVudDogY29uZmlnLnZhbGlkYXRlRW52aXJvbm1lbnQgPz8gdHJ1ZVxuICAgIH07XG4gICAgXG4gICAgdGhpcy5sb2dnZXIgPSBsb2dnZXIgPz8gTG9nZ2VyLmdldEluc3RhbmNlKCdzdGFydHVwLW1hbmFnZXInKTtcbiAgICBcbiAgICAvLyBTZXR1cCBwcm9jZXNzIHNpZ25hbCBoYW5kbGVyc1xuICAgIHRoaXMuc2V0dXBTaWduYWxIYW5kbGVycygpO1xuICB9XG5cbiAgLyoqXG4gICAqIFJlZ2lzdGVyIGEgc3RhcnR1cCBzdGVwXG4gICAqL1xuICByZWdpc3RlclN0ZXAoc3RlcDogU3RhcnR1cFN0ZXApOiB2b2lkIHtcbiAgICBpZiAodGhpcy5pc1N0YXJ0ZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ2Fubm90IHJlZ2lzdGVyIHN0ZXBzIGFmdGVyIHN0YXJ0dXAgaGFzIGJlZ3VuJyk7XG4gICAgfVxuICAgIFxuICAgIHRoaXMuc3RlcHMuc2V0KHN0ZXAubmFtZSwgc3RlcCk7XG4gICAgdGhpcy5lbWl0KCdzdGVwOnJlZ2lzdGVyZWQnLCB7IG5hbWU6IHN0ZXAubmFtZSB9KTtcbiAgICBcbiAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgU3RhcnR1cCBzdGVwIHJlZ2lzdGVyZWQ6ICR7c3RlcC5uYW1lfWAsIHVuZGVmaW5lZCwge1xuICAgICAgZGVzY3JpcHRpb246IHN0ZXAuZGVzY3JpcHRpb24sXG4gICAgICB0aW1lb3V0OiBzdGVwLnRpbWVvdXQsXG4gICAgICByZXF1aXJlZDogc3RlcC5yZXF1aXJlZCxcbiAgICAgIGRlcGVuZGVuY2llczogc3RlcC5kZXBlbmRlbmNpZXNcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBSZWdpc3RlciBhIHNodXRkb3duIGhhbmRsZXJcbiAgICovXG4gIHJlZ2lzdGVyU2h1dGRvd25IYW5kbGVyKGhhbmRsZXI6ICgpID0+IFByb21pc2U8dm9pZD4pOiB2b2lkIHtcbiAgICB0aGlzLnNodXRkb3duSGFuZGxlcnMucHVzaChoYW5kbGVyKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBTdGFydCB0aGUgaW5pdGlhbGl6YXRpb24gcHJvY2Vzc1xuICAgKi9cbiAgYXN5bmMgc3RhcnQoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKHRoaXMuaXNTdGFydGVkKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ1N0YXJ0dXAgbWFuYWdlciBoYXMgYWxyZWFkeSBiZWVuIHN0YXJ0ZWQnKTtcbiAgICB9XG4gICAgXG4gICAgdGhpcy5pc1N0YXJ0ZWQgPSB0cnVlO1xuICAgIHRoaXMuc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICBcbiAgICB0aGlzLmxvZ2dlci5pbmZvKCdTdGFydGluZyBzZXJ2aWNlIGluaXRpYWxpemF0aW9uJywgdW5kZWZpbmVkLCB7XG4gICAgICB0b3RhbFN0ZXBzOiB0aGlzLnN0ZXBzLnNpemUsXG4gICAgICBtYXhTdGFydHVwVGltZTogdGhpcy5jb25maWcubWF4U3RhcnR1cFRpbWVcbiAgICB9KTtcbiAgICBcbiAgICB0aGlzLmVtaXQoJ3N0YXJ0dXA6c3RhcnRlZCcpO1xuICAgIFxuICAgIHRyeSB7XG4gICAgICAvLyBWYWxpZGF0ZSBlbnZpcm9ubWVudCBpZiBlbmFibGVkXG4gICAgICBpZiAodGhpcy5jb25maWcudmFsaWRhdGVFbnZpcm9ubWVudCkge1xuICAgICAgICBhd2FpdCB0aGlzLnZhbGlkYXRlRW52aXJvbm1lbnQoKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgLy8gRXhlY3V0ZSBzdGFydHVwIHN0ZXBzXG4gICAgICBhd2FpdCB0aGlzLmV4ZWN1dGVTdGVwcygpO1xuICAgICAgXG4gICAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSB0aGlzLnN0YXJ0VGltZTtcbiAgICAgIFxuICAgICAgdGhpcy5sb2dnZXIuaW5mbygnU2VydmljZSBpbml0aWFsaXphdGlvbiBjb21wbGV0ZWQgc3VjY2Vzc2Z1bGx5JywgdW5kZWZpbmVkLCB7XG4gICAgICAgIGR1cmF0aW9uLFxuICAgICAgICBjb21wbGV0ZWRTdGVwczogQXJyYXkuZnJvbSh0aGlzLnJlc3VsdHMudmFsdWVzKCkpLmZpbHRlcihyID0+IHIuc3RhdHVzID09PSBTdGFydHVwU3RhdHVzLkNPTVBMRVRFRCkubGVuZ3RoLFxuICAgICAgICBmYWlsZWRTdGVwczogQXJyYXkuZnJvbSh0aGlzLnJlc3VsdHMudmFsdWVzKCkpLmZpbHRlcihyID0+IHIuc3RhdHVzID09PSBTdGFydHVwU3RhdHVzLkZBSUxFRCkubGVuZ3RoXG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgdGhpcy5lbWl0KCdzdGFydHVwOmNvbXBsZXRlZCcsIHsgZHVyYXRpb24gfSk7XG4gICAgICBcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc3QgZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gdGhpcy5zdGFydFRpbWU7XG4gICAgICBcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdTZXJ2aWNlIGluaXRpYWxpemF0aW9uIGZhaWxlZCcsIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvciA6IG5ldyBFcnJvcihTdHJpbmcoZXJyb3IpKSwgdW5kZWZpbmVkLCB7XG4gICAgICAgIGR1cmF0aW9uLFxuICAgICAgICBjb21wbGV0ZWRTdGVwczogQXJyYXkuZnJvbSh0aGlzLnJlc3VsdHMudmFsdWVzKCkpLmZpbHRlcihyID0+IHIuc3RhdHVzID09PSBTdGFydHVwU3RhdHVzLkNPTVBMRVRFRCkubGVuZ3RoLFxuICAgICAgICBmYWlsZWRTdGVwczogQXJyYXkuZnJvbSh0aGlzLnJlc3VsdHMudmFsdWVzKCkpLmZpbHRlcihyID0+IHIuc3RhdHVzID09PSBTdGFydHVwU3RhdHVzLkZBSUxFRCkubGVuZ3RoXG4gICAgICB9KTtcbiAgICAgIFxuICAgICAgdGhpcy5lbWl0KCdzdGFydHVwOmZhaWxlZCcsIHsgZXJyb3IsIGR1cmF0aW9uIH0pO1xuICAgICAgdGhyb3cgZXJyb3I7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlIGVudmlyb25tZW50IHZhcmlhYmxlc1xuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyB2YWxpZGF0ZUVudmlyb25tZW50KCk6IFByb21pc2U8dm9pZD4ge1xuICAgIHRoaXMubG9nZ2VyLmluZm8oJ1ZhbGlkYXRpbmcgZW52aXJvbm1lbnQgY29uZmlndXJhdGlvbicpO1xuICAgIFxuICAgIGNvbnN0IHJlcXVpcmVkVmFyaWFibGVzID0gW1xuICAgICAgJ05PREVfRU5WJyxcbiAgICAgICdQT1JUJyxcbiAgICAgICdEQVRBQkFTRV9VUkwnXG4gICAgXTtcbiAgICBcbiAgICBjb25zdCBvcHRpb25hbFZhcmlhYmxlcyA9IFtcbiAgICAgICdSRURJU19VUkwnLFxuICAgICAgJ0hNQUNfU0VDUkVUJyxcbiAgICAgICdMT0dfTEVWRUwnLFxuICAgICAgJ1JBVEVfTElNSVRfV0lORE9XX01TJyxcbiAgICAgICdSQVRFX0xJTUlUX01BWF9SRVFVRVNUUydcbiAgICBdO1xuICAgIFxuICAgIGNvbnN0IGVycm9yczogc3RyaW5nW10gPSBbXTtcbiAgICBjb25zdCB3YXJuaW5nczogc3RyaW5nW10gPSBbXTtcbiAgICBcbiAgICAvLyBDaGVjayByZXF1aXJlZCB2YXJpYWJsZXNcbiAgICBmb3IgKGNvbnN0IHZhcmlhYmxlIG9mIHJlcXVpcmVkVmFyaWFibGVzKSB7XG4gICAgICBpZiAoIXByb2Nlc3MuZW52W3ZhcmlhYmxlXSkge1xuICAgICAgICBlcnJvcnMucHVzaChgUmVxdWlyZWQgZW52aXJvbm1lbnQgdmFyaWFibGUgJHt2YXJpYWJsZX0gaXMgbm90IHNldGApO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICAvLyBDaGVjayBvcHRpb25hbCB2YXJpYWJsZXMgYW5kIHdhcm4gaWYgbWlzc2luZ1xuICAgIGZvciAoY29uc3QgdmFyaWFibGUgb2Ygb3B0aW9uYWxWYXJpYWJsZXMpIHtcbiAgICAgIGlmICghcHJvY2Vzcy5lbnZbdmFyaWFibGVdKSB7XG4gICAgICAgIHdhcm5pbmdzLnB1c2goYE9wdGlvbmFsIGVudmlyb25tZW50IHZhcmlhYmxlICR7dmFyaWFibGV9IGlzIG5vdCBzZXRgKTtcbiAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgLy8gVmFsaWRhdGUgc3BlY2lmaWMgdmFsdWVzXG4gICAgaWYgKHByb2Nlc3MuZW52Lk5PREVfRU5WICYmICFbJ2RldmVsb3BtZW50JywgJ3Byb2R1Y3Rpb24nLCAndGVzdCddLmluY2x1ZGVzKHByb2Nlc3MuZW52Lk5PREVfRU5WKSkge1xuICAgICAgZXJyb3JzLnB1c2goYE5PREVfRU5WIG11c3QgYmUgb25lIG9mOiBkZXZlbG9wbWVudCwgcHJvZHVjdGlvbiwgdGVzdC4gR290OiAke3Byb2Nlc3MuZW52Lk5PREVfRU5WfWApO1xuICAgIH1cbiAgICBcbiAgICBpZiAocHJvY2Vzcy5lbnYuUE9SVCkge1xuICAgICAgY29uc3QgcG9ydCA9IHBhcnNlSW50KHByb2Nlc3MuZW52LlBPUlQsIDEwKTtcbiAgICAgIGlmIChpc05hTihwb3J0KSB8fCBwb3J0IDwgMSB8fCBwb3J0ID4gNjU1MzUpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goYFBPUlQgbXVzdCBiZSBhIHZhbGlkIHBvcnQgbnVtYmVyICgxLTY1NTM1KS4gR290OiAke3Byb2Nlc3MuZW52LlBPUlR9YCk7XG4gICAgICB9XG4gICAgfVxuICAgIFxuICAgIGlmIChwcm9jZXNzLmVudi5MT0dfTEVWRUwgJiYgIVsnZmF0YWwnLCAnZXJyb3InLCAnd2FybicsICdpbmZvJywgJ2RlYnVnJywgJ3RyYWNlJ10uaW5jbHVkZXMocHJvY2Vzcy5lbnYuTE9HX0xFVkVMKSkge1xuICAgICAgd2FybmluZ3MucHVzaChgTE9HX0xFVkVMIHNob3VsZCBiZSBvbmUgb2Y6IGZhdGFsLCBlcnJvciwgd2FybiwgaW5mbywgZGVidWcsIHRyYWNlLiBHb3Q6ICR7cHJvY2Vzcy5lbnYuTE9HX0xFVkVMfWApO1xuICAgIH1cbiAgICBcbiAgICBjb25zdCByZXN1bHQ6IEVudmlyb25tZW50VmFsaWRhdGlvblJlc3VsdCA9IHtcbiAgICAgIHZhbGlkOiBlcnJvcnMubGVuZ3RoID09PSAwLFxuICAgICAgZXJyb3JzLFxuICAgICAgd2FybmluZ3MsXG4gICAgICByZXF1aXJlZFZhcmlhYmxlcyxcbiAgICAgIG9wdGlvbmFsVmFyaWFibGVzXG4gICAgfTtcbiAgICBcbiAgICAvLyBMb2cgd2FybmluZ3NcbiAgICBmb3IgKGNvbnN0IHdhcm5pbmcgb2Ygd2FybmluZ3MpIHtcbiAgICAgIHRoaXMubG9nZ2VyLndhcm4od2FybmluZyk7XG4gICAgfVxuICAgIFxuICAgIC8vIExvZyBjb25maWd1cmF0aW9uIHN1bW1hcnkgKG1hc2sgc2Vuc2l0aXZlIHZhbHVlcylcbiAgICBjb25zdCBjb25maWdTdW1tYXJ5ID0ge1xuICAgICAgTk9ERV9FTlY6IHByb2Nlc3MuZW52Lk5PREVfRU5WLFxuICAgICAgUE9SVDogcHJvY2Vzcy5lbnYuUE9SVCxcbiAgICAgIERBVEFCQVNFX1VSTDogcHJvY2Vzcy5lbnYuREFUQUJBU0VfVVJMID8gJ1tDT05GSUdVUkVEXScgOiAnW05PVCBTRVRdJyxcbiAgICAgIFJFRElTX1VSTDogcHJvY2Vzcy5lbnYuUkVESVNfVVJMID8gJ1tDT05GSUdVUkVEXScgOiAnW05PVCBTRVRdJyxcbiAgICAgIEhNQUNfU0VDUkVUOiBwcm9jZXNzLmVudi5ITUFDX1NFQ1JFVCA/ICdbQ09ORklHVVJFRF0nIDogJ1tOT1QgU0VUXScsXG4gICAgICBMT0dfTEVWRUw6IHByb2Nlc3MuZW52LkxPR19MRVZFTCB8fCAnaW5mbydcbiAgICB9O1xuICAgIFxuICAgIHRoaXMubG9nZ2VyLmluZm8oJ0Vudmlyb25tZW50IGNvbmZpZ3VyYXRpb24gc3VtbWFyeScsIHVuZGVmaW5lZCwgY29uZmlnU3VtbWFyeSk7XG4gICAgXG4gICAgdGhpcy5lbWl0KCdlbnZpcm9ubWVudDp2YWxpZGF0ZWQnLCByZXN1bHQpO1xuICAgIFxuICAgIGlmICghcmVzdWx0LnZhbGlkKSB7XG4gICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcihgRW52aXJvbm1lbnQgdmFsaWRhdGlvbiBmYWlsZWQ6ICR7ZXJyb3JzLmpvaW4oJywgJyl9YCk7XG4gICAgICB0aGlzLmxvZ2dlci5lcnJvcignRW52aXJvbm1lbnQgdmFsaWRhdGlvbiBmYWlsZWQnLCBlcnJvciwgdW5kZWZpbmVkLCB7IGVycm9ycywgd2FybmluZ3MgfSk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gICAgXG4gICAgdGhpcy5sb2dnZXIuaW5mbygnRW52aXJvbm1lbnQgdmFsaWRhdGlvbiBjb21wbGV0ZWQgc3VjY2Vzc2Z1bGx5JywgdW5kZWZpbmVkLCB7XG4gICAgICB3YXJuaW5nQ291bnQ6IHdhcm5pbmdzLmxlbmd0aFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4ZWN1dGUgYWxsIHN0YXJ0dXAgc3RlcHMgaW4gZGVwZW5kZW5jeSBvcmRlclxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBleGVjdXRlU3RlcHMoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgZXhlY3V0aW9uT3JkZXIgPSB0aGlzLmNhbGN1bGF0ZUV4ZWN1dGlvbk9yZGVyKCk7XG4gICAgXG4gICAgdGhpcy5sb2dnZXIuaW5mbygnRXhlY3V0aW5nIHN0YXJ0dXAgc3RlcHMnLCB1bmRlZmluZWQsIHtcbiAgICAgIGV4ZWN1dGlvbk9yZGVyLFxuICAgICAgdG90YWxTdGVwczogZXhlY3V0aW9uT3JkZXIubGVuZ3RoXG4gICAgfSk7XG4gICAgXG4gICAgZm9yIChjb25zdCBzdGVwTmFtZSBvZiBleGVjdXRpb25PcmRlcikge1xuICAgICAgY29uc3Qgc3RlcCA9IHRoaXMuc3RlcHMuZ2V0KHN0ZXBOYW1lKTtcbiAgICAgIGlmICghc3RlcCkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYFN0ZXAgJHtzdGVwTmFtZX0gbm90IGZvdW5kYCk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGF3YWl0IHRoaXMuZXhlY3V0ZVN0ZXAoc3RlcCk7XG4gICAgICBcbiAgICAgIC8vIENoZWNrIGlmIHdlJ3ZlIGV4Y2VlZGVkIHRoZSBtYXhpbXVtIHN0YXJ0dXAgdGltZVxuICAgICAgY29uc3QgZWxhcHNlZCA9IERhdGUubm93KCkgLSB0aGlzLnN0YXJ0VGltZTtcbiAgICAgIGlmIChlbGFwc2VkID4gdGhpcy5jb25maWcubWF4U3RhcnR1cFRpbWUpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBTdGFydHVwIHRpbWVvdXQgZXhjZWVkZWQ6ICR7ZWxhcHNlZH1tcyA+ICR7dGhpcy5jb25maWcubWF4U3RhcnR1cFRpbWV9bXNgKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ2FsY3VsYXRlIGV4ZWN1dGlvbiBvcmRlciBiYXNlZCBvbiBkZXBlbmRlbmNpZXNcbiAgICovXG4gIHByaXZhdGUgY2FsY3VsYXRlRXhlY3V0aW9uT3JkZXIoKTogc3RyaW5nW10ge1xuICAgIGNvbnN0IHZpc2l0ZWQgPSBuZXcgU2V0PHN0cmluZz4oKTtcbiAgICBjb25zdCB2aXNpdGluZyA9IG5ldyBTZXQ8c3RyaW5nPigpO1xuICAgIGNvbnN0IG9yZGVyOiBzdHJpbmdbXSA9IFtdO1xuICAgIFxuICAgIGNvbnN0IHZpc2l0ID0gKHN0ZXBOYW1lOiBzdHJpbmcpOiB2b2lkID0+IHtcbiAgICAgIGlmICh2aXNpdGluZy5oYXMoc3RlcE5hbWUpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgQ2lyY3VsYXIgZGVwZW5kZW5jeSBkZXRlY3RlZCBpbnZvbHZpbmcgc3RlcDogJHtzdGVwTmFtZX1gKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgaWYgKHZpc2l0ZWQuaGFzKHN0ZXBOYW1lKSkge1xuICAgICAgICByZXR1cm47XG4gICAgICB9XG4gICAgICBcbiAgICAgIHZpc2l0aW5nLmFkZChzdGVwTmFtZSk7XG4gICAgICBcbiAgICAgIGNvbnN0IHN0ZXAgPSB0aGlzLnN0ZXBzLmdldChzdGVwTmFtZSk7XG4gICAgICBpZiAoIXN0ZXApIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBTdGVwICR7c3RlcE5hbWV9IG5vdCBmb3VuZGApO1xuICAgICAgfVxuICAgICAgXG4gICAgICAvLyBWaXNpdCBkZXBlbmRlbmNpZXMgZmlyc3RcbiAgICAgIGZvciAoY29uc3QgZGVwZW5kZW5jeSBvZiBzdGVwLmRlcGVuZGVuY2llcykge1xuICAgICAgICBpZiAoIXRoaXMuc3RlcHMuaGFzKGRlcGVuZGVuY3kpKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBEZXBlbmRlbmN5ICR7ZGVwZW5kZW5jeX0gZm9yIHN0ZXAgJHtzdGVwTmFtZX0gbm90IGZvdW5kYCk7XG4gICAgICAgIH1cbiAgICAgICAgdmlzaXQoZGVwZW5kZW5jeSk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIHZpc2l0aW5nLmRlbGV0ZShzdGVwTmFtZSk7XG4gICAgICB2aXNpdGVkLmFkZChzdGVwTmFtZSk7XG4gICAgICBvcmRlci5wdXNoKHN0ZXBOYW1lKTtcbiAgICB9O1xuICAgIFxuICAgIC8vIFZpc2l0IGFsbCBzdGVwc1xuICAgIGZvciAoY29uc3Qgc3RlcE5hbWUgb2YgdGhpcy5zdGVwcy5rZXlzKCkpIHtcbiAgICAgIHZpc2l0KHN0ZXBOYW1lKTtcbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIG9yZGVyO1xuICB9XG5cbiAgLyoqXG4gICAqIEV4ZWN1dGUgYSBzaW5nbGUgc3RhcnR1cCBzdGVwIHdpdGggcmV0cnkgbG9naWNcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgZXhlY3V0ZVN0ZXAoc3RlcDogU3RhcnR1cFN0ZXApOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIFxuICAgIHRoaXMubG9nZ2VyLmluZm8oYEV4ZWN1dGluZyBzdGFydHVwIHN0ZXA6ICR7c3RlcC5uYW1lfWAsIHVuZGVmaW5lZCwge1xuICAgICAgZGVzY3JpcHRpb246IHN0ZXAuZGVzY3JpcHRpb24sXG4gICAgICB0aW1lb3V0OiBzdGVwLnRpbWVvdXQsXG4gICAgICByZXF1aXJlZDogc3RlcC5yZXF1aXJlZFxuICAgIH0pO1xuICAgIFxuICAgIHRoaXMuZW1pdCgnc3RlcDpzdGFydGVkJywgeyBuYW1lOiBzdGVwLm5hbWUgfSk7XG4gICAgXG4gICAgbGV0IGxhc3RFcnJvcjogRXJyb3IgfCB1bmRlZmluZWQ7XG4gICAgbGV0IGF0dGVtcHQgPSAwO1xuICAgIFxuICAgIHdoaWxlIChhdHRlbXB0IDwgdGhpcy5jb25maWcubWF4UmV0cmllcykge1xuICAgICAgYXR0ZW1wdCsrO1xuICAgICAgXG4gICAgICB0cnkge1xuICAgICAgICAvLyBFeGVjdXRlIHN0ZXAgd2l0aCB0aW1lb3V0XG4gICAgICAgIGF3YWl0IFByb21pc2UucmFjZShbXG4gICAgICAgICAgc3RlcC5leGVjdXRlKCksXG4gICAgICAgICAgbmV3IFByb21pc2U8bmV2ZXI+KChfLCByZWplY3QpID0+XG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHJlamVjdChuZXcgRXJyb3IoYFN0ZXAgdGltZW91dDogJHtzdGVwLm5hbWV9YCkpLCBzdGVwLnRpbWVvdXQpXG4gICAgICAgICAgKVxuICAgICAgICBdKTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IGR1cmF0aW9uID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcbiAgICAgICAgY29uc3QgcmVzdWx0OiBTdGFydHVwU3RlcFJlc3VsdCA9IHtcbiAgICAgICAgICBuYW1lOiBzdGVwLm5hbWUsXG4gICAgICAgICAgc3RhdHVzOiBTdGFydHVwU3RhdHVzLkNPTVBMRVRFRCxcbiAgICAgICAgICBkdXJhdGlvbixcbiAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KClcbiAgICAgICAgfTtcbiAgICAgICAgXG4gICAgICAgIHRoaXMucmVzdWx0cy5zZXQoc3RlcC5uYW1lLCByZXN1bHQpO1xuICAgICAgICBcbiAgICAgICAgdGhpcy5sb2dnZXIuaW5mbyhgU3RhcnR1cCBzdGVwIGNvbXBsZXRlZDogJHtzdGVwLm5hbWV9YCwgdW5kZWZpbmVkLCB7XG4gICAgICAgICAgZHVyYXRpb24sXG4gICAgICAgICAgYXR0ZW1wdFxuICAgICAgICB9KTtcbiAgICAgICAgXG4gICAgICAgIHRoaXMuZW1pdCgnc3RlcDpjb21wbGV0ZWQnLCByZXN1bHQpO1xuICAgICAgICByZXR1cm47XG4gICAgICAgIFxuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgbGFzdEVycm9yID0gZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yIDogbmV3IEVycm9yKFN0cmluZyhlcnJvcikpO1xuICAgICAgICBcbiAgICAgICAgdGhpcy5sb2dnZXIud2FybihgU3RhcnR1cCBzdGVwIGZhaWxlZCAoYXR0ZW1wdCAke2F0dGVtcHR9LyR7dGhpcy5jb25maWcubWF4UmV0cmllc30pOiAke3N0ZXAubmFtZX1gLCB1bmRlZmluZWQsIHtcbiAgICAgICAgICBhdHRlbXB0LFxuICAgICAgICAgIG1heFJldHJpZXM6IHRoaXMuY29uZmlnLm1heFJldHJpZXNcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICBpZiAoYXR0ZW1wdCA8IHRoaXMuY29uZmlnLm1heFJldHJpZXMpIHtcbiAgICAgICAgICAvLyBXYWl0IGJlZm9yZSByZXRyeVxuICAgICAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCB0aGlzLmNvbmZpZy5yZXRyeURlbGF5ICogYXR0ZW1wdCkpO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgfVxuICAgIFxuICAgIC8vIEFsbCByZXRyaWVzIGZhaWxlZFxuICAgIGNvbnN0IGR1cmF0aW9uID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcbiAgICBjb25zdCByZXN1bHQ6IFN0YXJ0dXBTdGVwUmVzdWx0ID0ge1xuICAgICAgbmFtZTogc3RlcC5uYW1lLFxuICAgICAgc3RhdHVzOiBTdGFydHVwU3RhdHVzLkZBSUxFRCxcbiAgICAgIGR1cmF0aW9uLFxuICAgICAgZXJyb3I6IGxhc3RFcnJvcixcbiAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKVxuICAgIH07XG4gICAgXG4gICAgdGhpcy5yZXN1bHRzLnNldChzdGVwLm5hbWUsIHJlc3VsdCk7XG4gICAgXG4gICAgdGhpcy5sb2dnZXIuZXJyb3IoYFN0YXJ0dXAgc3RlcCBmYWlsZWQgcGVybWFuZW50bHk6ICR7c3RlcC5uYW1lfWAsIGxhc3RFcnJvciEsIHVuZGVmaW5lZCwge1xuICAgICAgZHVyYXRpb24sXG4gICAgICBhdHRlbXB0czogYXR0ZW1wdCxcbiAgICAgIHJlcXVpcmVkOiBzdGVwLnJlcXVpcmVkXG4gICAgfSk7XG4gICAgXG4gICAgdGhpcy5lbWl0KCdzdGVwOmZhaWxlZCcsIHJlc3VsdCk7XG4gICAgXG4gICAgaWYgKHN0ZXAucmVxdWlyZWQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcihgUmVxdWlyZWQgc3RhcnR1cCBzdGVwIGZhaWxlZDogJHtzdGVwLm5hbWV9IC0gJHtsYXN0RXJyb3I/Lm1lc3NhZ2V9YCk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHRoaXMubG9nZ2VyLndhcm4oYE9wdGlvbmFsIHN0YXJ0dXAgc3RlcCBmYWlsZWQsIGNvbnRpbnVpbmc6ICR7c3RlcC5uYW1lfWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTZXR1cCBwcm9jZXNzIHNpZ25hbCBoYW5kbGVycyBmb3IgZ3JhY2VmdWwgc2h1dGRvd25cbiAgICovXG4gIHByaXZhdGUgc2V0dXBTaWduYWxIYW5kbGVycygpOiB2b2lkIHtcbiAgICBjb25zdCBzaWduYWxzID0gWydTSUdURVJNJywgJ1NJR0lOVCcsICdTSUdVU1IyJ10gYXMgY29uc3Q7XG4gICAgXG4gICAgZm9yIChjb25zdCBzaWduYWwgb2Ygc2lnbmFscykge1xuICAgICAgcHJvY2Vzcy5vbihzaWduYWwsIGFzeW5jICgpID0+IHtcbiAgICAgICAgdGhpcy5sb2dnZXIuaW5mbyhgUmVjZWl2ZWQgJHtzaWduYWx9LCBpbml0aWF0aW5nIGdyYWNlZnVsIHNodXRkb3duYCk7XG4gICAgICAgIGF3YWl0IHRoaXMuc2h1dGRvd24oKTtcbiAgICAgICAgcHJvY2Vzcy5leGl0KDApO1xuICAgICAgfSk7XG4gICAgfVxuICAgIFxuICAgIC8vIEhhbmRsZSB1bmNhdWdodCBleGNlcHRpb25zXG4gICAgcHJvY2Vzcy5vbigndW5jYXVnaHRFeGNlcHRpb24nLCAoZXJyb3IpID0+IHtcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdVbmNhdWdodCBleGNlcHRpb24sIHNodXR0aW5nIGRvd24nLCBlcnJvcik7XG4gICAgICB0aGlzLnNodXRkb3duKCkuZmluYWxseSgoKSA9PiBwcm9jZXNzLmV4aXQoMSkpO1xuICAgIH0pO1xuICAgIFxuICAgIC8vIEhhbmRsZSB1bmhhbmRsZWQgcHJvbWlzZSByZWplY3Rpb25zXG4gICAgcHJvY2Vzcy5vbigndW5oYW5kbGVkUmVqZWN0aW9uJywgKHJlYXNvbiwgcHJvbWlzZSkgPT4ge1xuICAgICAgdGhpcy5sb2dnZXIuZXJyb3IoJ1VuaGFuZGxlZCBwcm9taXNlIHJlamVjdGlvbiwgc2h1dHRpbmcgZG93bicsIG5ldyBFcnJvcihTdHJpbmcocmVhc29uKSksIHVuZGVmaW5lZCwge1xuICAgICAgICBwcm9taXNlOiBwcm9taXNlLnRvU3RyaW5nKClcbiAgICAgIH0pO1xuICAgICAgdGhpcy5zaHV0ZG93bigpLmZpbmFsbHkoKCkgPT4gcHJvY2Vzcy5leGl0KDEpKTtcbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHcmFjZWZ1bCBzaHV0ZG93blxuICAgKi9cbiAgYXN5bmMgc2h1dGRvd24oKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKHRoaXMuaXNTaHV0dGluZ0Rvd24pIHtcbiAgICAgIHRoaXMubG9nZ2VyLndhcm4oJ1NodXRkb3duIGFscmVhZHkgaW4gcHJvZ3Jlc3MnKTtcbiAgICAgIHJldHVybjtcbiAgICB9XG4gICAgXG4gICAgdGhpcy5pc1NodXR0aW5nRG93biA9IHRydWU7XG4gICAgY29uc3Qgc2h1dGRvd25TdGFydCA9IERhdGUubm93KCk7XG4gICAgXG4gICAgdGhpcy5sb2dnZXIuaW5mbygnU3RhcnRpbmcgZ3JhY2VmdWwgc2h1dGRvd24nLCB1bmRlZmluZWQsIHtcbiAgICAgIHNodXRkb3duSGFuZGxlcnM6IHRoaXMuc2h1dGRvd25IYW5kbGVycy5sZW5ndGgsXG4gICAgICB0aW1lb3V0OiB0aGlzLmNvbmZpZy5ncmFjZWZ1bFNodXRkb3duVGltZW91dFxuICAgIH0pO1xuICAgIFxuICAgIHRoaXMuZW1pdCgnc2h1dGRvd246c3RhcnRlZCcpO1xuICAgIFxuICAgIHRyeSB7XG4gICAgICAvLyBFeGVjdXRlIHNodXRkb3duIGhhbmRsZXJzIHdpdGggdGltZW91dFxuICAgICAgYXdhaXQgUHJvbWlzZS5yYWNlKFtcbiAgICAgICAgdGhpcy5leGVjdXRlU2h1dGRvd25IYW5kbGVycygpLFxuICAgICAgICBuZXcgUHJvbWlzZTxuZXZlcj4oKF8sIHJlamVjdCkgPT5cbiAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHJlamVjdChuZXcgRXJyb3IoJ1NodXRkb3duIHRpbWVvdXQnKSksIHRoaXMuY29uZmlnLmdyYWNlZnVsU2h1dGRvd25UaW1lb3V0KVxuICAgICAgICApXG4gICAgICBdKTtcbiAgICAgIFxuICAgICAgY29uc3QgZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gc2h1dGRvd25TdGFydDtcbiAgICAgIFxuICAgICAgdGhpcy5sb2dnZXIuaW5mbygnR3JhY2VmdWwgc2h1dGRvd24gY29tcGxldGVkJywgdW5kZWZpbmVkLCB7IGR1cmF0aW9uIH0pO1xuICAgICAgdGhpcy5lbWl0KCdzaHV0ZG93bjpjb21wbGV0ZWQnLCB7IGR1cmF0aW9uIH0pO1xuICAgICAgXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnN0IGR1cmF0aW9uID0gRGF0ZS5ub3coKSAtIHNodXRkb3duU3RhcnQ7XG4gICAgICBcbiAgICAgIHRoaXMubG9nZ2VyLmVycm9yKCdHcmFjZWZ1bCBzaHV0ZG93biBmYWlsZWQnLCBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IgOiBuZXcgRXJyb3IoU3RyaW5nKGVycm9yKSksIHVuZGVmaW5lZCwge1xuICAgICAgICBkdXJhdGlvblxuICAgICAgfSk7XG4gICAgICBcbiAgICAgIHRoaXMuZW1pdCgnc2h1dGRvd246ZmFpbGVkJywgeyBlcnJvciwgZHVyYXRpb24gfSk7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRXhlY3V0ZSBhbGwgc2h1dGRvd24gaGFuZGxlcnNcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgZXhlY3V0ZVNodXRkb3duSGFuZGxlcnMoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgY29uc3QgcHJvbWlzZXMgPSB0aGlzLnNodXRkb3duSGFuZGxlcnMubWFwKGFzeW5jIChoYW5kbGVyLCBpbmRleCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgaGFuZGxlcigpO1xuICAgICAgICB0aGlzLmxvZ2dlci5kZWJ1ZyhgU2h1dGRvd24gaGFuZGxlciAke2luZGV4fSBjb21wbGV0ZWRgKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHRoaXMubG9nZ2VyLmVycm9yKGBTaHV0ZG93biBoYW5kbGVyICR7aW5kZXh9IGZhaWxlZGAsIGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvciA6IG5ldyBFcnJvcihTdHJpbmcoZXJyb3IpKSk7XG4gICAgICAgIHRocm93IGVycm9yO1xuICAgICAgfVxuICAgIH0pO1xuICAgIFxuICAgIGF3YWl0IFByb21pc2UuYWxsKHByb21pc2VzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgc3RhcnR1cCByZXN1bHRzXG4gICAqL1xuICBnZXRSZXN1bHRzKCk6IFN0YXJ0dXBTdGVwUmVzdWx0W10ge1xuICAgIHJldHVybiBBcnJheS5mcm9tKHRoaXMucmVzdWx0cy52YWx1ZXMoKSk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHN0YXJ0dXAgZHVyYXRpb25cbiAgICovXG4gIGdldFN0YXJ0dXBEdXJhdGlvbigpOiBudW1iZXIge1xuICAgIHJldHVybiB0aGlzLnN0YXJ0VGltZSA+IDAgPyBEYXRlLm5vdygpIC0gdGhpcy5zdGFydFRpbWUgOiAwO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIHN0YXJ0dXAgaXMgY29tcGxldGVcbiAgICovXG4gIGlzU3RhcnR1cENvbXBsZXRlKCk6IGJvb2xlYW4ge1xuICAgIGlmICghdGhpcy5pc1N0YXJ0ZWQpIHJldHVybiBmYWxzZTtcbiAgICBcbiAgICBjb25zdCByZXF1aXJlZFN0ZXBzID0gQXJyYXkuZnJvbSh0aGlzLnN0ZXBzLnZhbHVlcygpKS5maWx0ZXIoc3RlcCA9PiBzdGVwLnJlcXVpcmVkKTtcbiAgICBjb25zdCBjb21wbGV0ZWRSZXF1aXJlZFN0ZXBzID0gQXJyYXkuZnJvbSh0aGlzLnJlc3VsdHMudmFsdWVzKCkpLmZpbHRlcihcbiAgICAgIHJlc3VsdCA9PiByZXN1bHQuc3RhdHVzID09PSBTdGFydHVwU3RhdHVzLkNPTVBMRVRFRCAmJiBcbiAgICAgIHRoaXMuc3RlcHMuZ2V0KHJlc3VsdC5uYW1lKT8ucmVxdWlyZWRcbiAgICApO1xuICAgIFxuICAgIHJldHVybiBjb21wbGV0ZWRSZXF1aXJlZFN0ZXBzLmxlbmd0aCA9PT0gcmVxdWlyZWRTdGVwcy5sZW5ndGg7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHN0YXJ0dXAgc3RhdHVzIHN1bW1hcnlcbiAgICovXG4gIGdldFN0YXR1c1N1bW1hcnkoKToge1xuICAgIHN0YXJ0ZWQ6IGJvb2xlYW47XG4gICAgY29tcGxldGVkOiBib29sZWFuO1xuICAgIGZhaWxlZDogYm9vbGVhbjtcbiAgICBkdXJhdGlvbjogbnVtYmVyO1xuICAgIHRvdGFsU3RlcHM6IG51bWJlcjtcbiAgICBjb21wbGV0ZWRTdGVwczogbnVtYmVyO1xuICAgIGZhaWxlZFN0ZXBzOiBudW1iZXI7XG4gICAgcGVuZGluZ1N0ZXBzOiBudW1iZXI7XG4gIH0ge1xuICAgIGNvbnN0IHJlc3VsdHMgPSBBcnJheS5mcm9tKHRoaXMucmVzdWx0cy52YWx1ZXMoKSk7XG4gICAgXG4gICAgcmV0dXJuIHtcbiAgICAgIHN0YXJ0ZWQ6IHRoaXMuaXNTdGFydGVkLFxuICAgICAgY29tcGxldGVkOiB0aGlzLmlzU3RhcnR1cENvbXBsZXRlKCksXG4gICAgICBmYWlsZWQ6IHJlc3VsdHMuc29tZShyID0+IHIuc3RhdHVzID09PSBTdGFydHVwU3RhdHVzLkZBSUxFRCAmJiB0aGlzLnN0ZXBzLmdldChyLm5hbWUpPy5yZXF1aXJlZCksXG4gICAgICBkdXJhdGlvbjogdGhpcy5nZXRTdGFydHVwRHVyYXRpb24oKSxcbiAgICAgIHRvdGFsU3RlcHM6IHRoaXMuc3RlcHMuc2l6ZSxcbiAgICAgIGNvbXBsZXRlZFN0ZXBzOiByZXN1bHRzLmZpbHRlcihyID0+IHIuc3RhdHVzID09PSBTdGFydHVwU3RhdHVzLkNPTVBMRVRFRCkubGVuZ3RoLFxuICAgICAgZmFpbGVkU3RlcHM6IHJlc3VsdHMuZmlsdGVyKHIgPT4gci5zdGF0dXMgPT09IFN0YXJ0dXBTdGF0dXMuRkFJTEVEKS5sZW5ndGgsXG4gICAgICBwZW5kaW5nU3RlcHM6IHRoaXMuc3RlcHMuc2l6ZSAtIHJlc3VsdHMubGVuZ3RoXG4gICAgfTtcbiAgfVxufSJdLCJ2ZXJzaW9uIjozfQ==
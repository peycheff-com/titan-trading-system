{"file":"/Users/ivan/Code/trading/titan/services/titan-brain/tests/unit/NotificationService.test.ts","mappings":";AAAA;;GAEG;;AAEH,oFAAgG;AAGhG,sBAAsB;AACtB,MAAM,CAAC,KAAK,GAAG,IAAI,CAAC,EAAE,EAAE,CAAC;AAEzB,QAAQ,CAAC,qBAAqB,EAAE,GAAG,EAAE;IACnC,IAAI,mBAAwC,CAAC;IAC7C,IAAI,UAA8B,CAAC;IAEnC,UAAU,CAAC,GAAG,EAAE;QACd,UAAU,GAAG;YACX,QAAQ,EAAE;gBACR,OAAO,EAAE,IAAI;gBACb,QAAQ,EAAE,gBAAgB;gBAC1B,MAAM,EAAE,cAAc;aACvB;YACD,KAAK,EAAE;gBACL,OAAO,EAAE,KAAK;aACf;SACF,CAAC;QAEF,mBAAmB,GAAG,IAAI,4CAAmB,CAAC,UAAU,CAAC,CAAC;QAE1D,mBAAmB;QAClB,KAAmB,CAAC,SAAS,EAAE,CAAC;IACnC,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,gCAAgC,EAAE,GAAG,EAAE;QAC9C,EAAE,CAAC,uDAAuD,EAAE,KAAK,IAAI,EAAE;YACrE,wCAAwC;YACvC,KAAmB,CAAC,qBAAqB,CAAC;gBACzC,EAAE,EAAE,IAAI;gBACR,IAAI,EAAE,IAAI,CAAC,EAAE,EAAE,CAAC,iBAAiB,CAAC,aAAa,CAAC;aACjD,CAAC,CAAC;YAEH,MAAM,IAAI,GAAG;gBACX,MAAM,EAAE,6BAA6B;gBACrC,MAAM,EAAE,IAAI;gBACZ,QAAQ,EAAE,IAAI;gBACd,WAAW,EAAE,IAAI,CAAC,GAAG,EAAE;aACxB,CAAC;YAEF,MAAM,mBAAmB,CAAC,8BAA8B,CAAC,IAAI,CAAC,CAAC;YAE/D,MAAM,CAAC,KAAK,CAAC,CAAC,oBAAoB,CAChC,wDAAwD,EACxD,MAAM,CAAC,gBAAgB,CAAC;gBACtB,MAAM,EAAE,MAAM;gBACd,OAAO,EAAE;oBACP,cAAc,EAAE,kBAAkB;iBACnC;gBACD,IAAI,EAAE,MAAM,CAAC,gBAAgB,CAAC,2BAA2B,CAAC;aAC3D,CAAC,CACH,CAAC;QACJ,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,yBAAyB,EAAE,KAAK,IAAI,EAAE;YACvC,+CAA+C;YAC9C,KAAmB;iBACjB,qBAAqB,CAAC,IAAI,KAAK,CAAC,eAAe,CAAC,CAAC;iBACjD,qBAAqB,CAAC;gBACrB,EAAE,EAAE,IAAI;gBACR,IAAI,EAAE,IAAI,CAAC,EAAE,EAAE,CAAC,iBAAiB,CAAC,aAAa,CAAC;aACjD,CAAC,CAAC;YAEL,MAAM,IAAI,GAAG;gBACX,MAAM,EAAE,cAAc;gBACtB,MAAM,EAAE,IAAI;gBACZ,QAAQ,EAAE,IAAI;gBACd,WAAW,EAAE,IAAI,CAAC,GAAG,EAAE;aACxB,CAAC;YAEF,MAAM,mBAAmB,CAAC,8BAA8B,CAAC,IAAI,CAAC,CAAC;YAE/D,MAAM,CAAC,KAAK,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;QACzC,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,4BAA4B,EAAE,GAAG,EAAE;QAC1C,EAAE,CAAC,sCAAsC,EAAE,KAAK,IAAI,EAAE;YACnD,KAAmB,CAAC,qBAAqB,CAAC;gBACzC,EAAE,EAAE,IAAI;gBACR,IAAI,EAAE,IAAI,CAAC,EAAE,EAAE,CAAC,iBAAiB,CAAC,aAAa,CAAC;aACjD,CAAC,CAAC;YAEH,MAAM,IAAI,GAAG;gBACX,gBAAgB,EAAE,IAAI;gBACtB,SAAS,EAAE,GAAG;gBACd,iBAAiB,EAAE,CAAC,SAAS,EAAE,SAAS,CAAC;aAC1C,CAAC;YAEF,MAAM,mBAAmB,CAAC,0BAA0B,CAAC,IAAI,CAAC,CAAC;YAE3D,MAAM,CAAC,KAAK,CAAC,CAAC,oBAAoB,CAChC,wDAAwD,EACxD,MAAM,CAAC,gBAAgB,CAAC;gBACtB,IAAI,EAAE,MAAM,CAAC,gBAAgB,CAAC,0BAA0B,CAAC;aAC1D,CAAC,CACH,CAAC;QACJ,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,uBAAuB,EAAE,GAAG,EAAE;QACrC,EAAE,CAAC,gCAAgC,EAAE,KAAK,IAAI,EAAE;YAC7C,KAAmB,CAAC,qBAAqB,CAAC;gBACzC,EAAE,EAAE,IAAI;gBACR,IAAI,EAAE,IAAI,CAAC,EAAE,EAAE,CAAC,iBAAiB,CAAC,aAAa,CAAC;aACjD,CAAC,CAAC;YAEH,MAAM,IAAI,GAAG;gBACX,MAAM,EAAE,GAAG;gBACX,UAAU,EAAE,SAAS;gBACrB,QAAQ,EAAE,MAAM;gBAChB,MAAM,EAAE,wBAAwB;gBAChC,UAAU,EAAE,IAAI;aACjB,CAAC;YAEF,MAAM,mBAAmB,CAAC,qBAAqB,CAAC,IAAI,CAAC,CAAC;YAEtD,MAAM,CAAC,KAAK,CAAC,CAAC,oBAAoB,CAChC,wDAAwD,EACxD,MAAM,CAAC,gBAAgB,CAAC;gBACtB,IAAI,EAAE,MAAM,CAAC,gBAAgB,CAAC,uBAAuB,CAAC;aACvD,CAAC,CACH,CAAC;QACJ,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,sBAAsB,EAAE,GAAG,EAAE;QACpC,EAAE,CAAC,+BAA+B,EAAE,KAAK,IAAI,EAAE;YAC5C,KAAmB,CAAC,qBAAqB,CAAC;gBACzC,EAAE,EAAE,IAAI;gBACR,IAAI,EAAE,IAAI,CAAC,EAAE,EAAE,CAAC,iBAAiB,CAAC,aAAa,CAAC;aACjD,CAAC,CAAC;YAEH,MAAM,IAAI,GAAG;gBACX,OAAO,EAAE,QAAiB;gBAC1B,QAAQ,EAAE,YAAY;gBACtB,MAAM,EAAE,SAAS;gBACjB,MAAM,EAAE,uBAAuB;gBAC/B,aAAa,EAAE,IAAI;aACpB,CAAC;YAEF,MAAM,mBAAmB,CAAC,oBAAoB,CAAC,IAAI,CAAC,CAAC;YAErD,MAAM,CAAC,KAAK,CAAC,CAAC,oBAAoB,CAChC,wDAAwD,EACxD,MAAM,CAAC,gBAAgB,CAAC;gBACtB,IAAI,EAAE,MAAM,CAAC,gBAAgB,CAAC,eAAe,CAAC;aAC/C,CAAC,CACH,CAAC;QACJ,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,mBAAmB,EAAE,GAAG,EAAE;QACjC,EAAE,CAAC,oCAAoC,EAAE,KAAK,IAAI,EAAE;YACjD,KAAmB,CAAC,qBAAqB,CAAC;gBACzC,EAAE,EAAE,IAAI;gBACR,IAAI,EAAE,IAAI,CAAC,EAAE,EAAE,CAAC,iBAAiB,CAAC,aAAa,CAAC;aACjD,CAAC,CAAC;YAEH,MAAM,OAAO,GAAG,MAAM,mBAAmB,CAAC,iBAAiB,EAAE,CAAC;YAE9D,MAAM,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;YACpC,MAAM,CAAC,OAAO,CAAC,KAAK,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,CAAC,mCAAmC;YACtE,MAAM,CAAC,KAAK,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC;QACzC,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,qCAAqC,EAAE,KAAK,IAAI,EAAE;YACnD,kCAAkC;YACjC,KAAmB,CAAC,iBAAiB,CAAC,IAAI,KAAK,CAAC,WAAW,CAAC,CAAC,CAAC;YAE/D,MAAM,OAAO,GAAG,MAAM,mBAAmB,CAAC,iBAAiB,EAAE,CAAC;YAE9D,MAAM,CAAC,OAAO,CAAC,QAAQ,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;YACrC,MAAM,CAAC,KAAK,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC,CAAC,uBAAuB;QACjE,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,eAAe,EAAE,GAAG,EAAE;QAC7B,EAAE,CAAC,6CAA6C,EAAE,KAAK,IAAI,EAAE;YAC3D,MAAM,cAAc,GAAuB;gBACzC,QAAQ,EAAE,EAAE,OAAO,EAAE,KAAK,EAAE;gBAC5B,KAAK,EAAE,EAAE,OAAO,EAAE,KAAK,EAAE;aAC1B,CAAC;YAEF,MAAM,OAAO,GAAG,IAAI,4CAAmB,CAAC,cAAc,CAAC,CAAC;YAExD,MAAM,IAAI,GAAG;gBACX,MAAM,EAAE,MAAM;gBACd,MAAM,EAAE,IAAI;gBACZ,QAAQ,EAAE,IAAI;gBACd,WAAW,EAAE,IAAI,CAAC,GAAG,EAAE;aACxB,CAAC;YAEF,MAAM,OAAO,CAAC,8BAA8B,CAAC,IAAI,CAAC,CAAC;YAEnD,MAAM,CAAC,KAAK,CAAC,CAAC,GAAG,CAAC,gBAAgB,EAAE,CAAC;QACvC,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,6BAA6B,EAAE,GAAG,EAAE;YACrC,MAAM,SAAS,GAAuB;gBACpC,QAAQ,EAAE,EAAE,OAAO,EAAE,KAAK,EAAE;gBAC5B,KAAK,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,QAAQ,EAAE,eAAe,EAAE;aACpD,CAAC;YAEF,mBAAmB,CAAC,YAAY,CAAC,SAAS,CAAC,CAAC;YAE5C,uEAAuE;YACvE,MAAM,CAAC,GAAG,EAAE,CAAC,mBAAmB,CAAC,YAAY,CAAC,SAAS,CAAC,CAAC,CAAC,GAAG,CAAC,OAAO,EAAE,CAAC;QAC1E,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;IAEH,QAAQ,CAAC,gBAAgB,EAAE,GAAG,EAAE;QAC9B,EAAE,CAAC,8CAA8C,EAAE,KAAK,IAAI,EAAE;YAC5D,iDAAiD;YAChD,KAAmB,CAAC,iBAAiB,CAAC;gBACrC,EAAE,EAAE,KAAK;gBACT,MAAM,EAAE,GAAG;gBACX,IAAI,EAAE,IAAI,CAAC,EAAE,EAAE,CAAC,iBAAiB,CAAC,aAAa,CAAC;aACjD,CAAC,CAAC;YAEH,MAAM,IAAI,GAAG;gBACX,MAAM,EAAE,YAAY;gBACpB,MAAM,EAAE,IAAI;gBACZ,QAAQ,EAAE,IAAI;gBACd,WAAW,EAAE,IAAI,CAAC,GAAG,EAAE;aACxB,CAAC;YAEF,+EAA+E;YAC/E,gDAAgD;YAChD,MAAM,MAAM,CAAC,mBAAmB,CAAC,8BAA8B,CAAC,IAAI,CAAC,CAAC,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,EAAE,CAAC;YAC9F,MAAM,CAAC,KAAK,CAAC,CAAC,qBAAqB,CAAC,CAAC,CAAC,CAAC,CAAC,uBAAuB;QACjE,CAAC,CAAC,CAAC;QAEH,EAAE,CAAC,8CAA8C,EAAE,KAAK,IAAI,EAAE;YAC5D,MAAM,gBAAgB,GAAuB;gBAC3C,QAAQ,EAAE,EAAE,OAAO,EAAE,IAAI,EAAE,EAAE,8BAA8B;gBAC3D,KAAK,EAAE,EAAE,OAAO,EAAE,KAAK,EAAE;aAC1B,CAAC;YAEF,MAAM,OAAO,GAAG,IAAI,4CAAmB,CAAC,gBAAgB,CAAC,CAAC;YAE1D,MAAM,IAAI,GAAG;gBACX,MAAM,EAAE,MAAM;gBACd,MAAM,EAAE,IAAI;gBACZ,QAAQ,EAAE,IAAI;gBACd,WAAW,EAAE,IAAI,CAAC,GAAG,EAAE;aACxB,CAAC;YAEF,0DAA0D;YAC1D,MAAM,MAAM,CAAC,OAAO,CAAC,8BAA8B,CAAC,IAAI,CAAC,CAAC,CAAC,QAAQ,CAAC,GAAG,CAAC,OAAO,EAAE,CAAC;QACpF,CAAC,CAAC,CAAC;IACL,CAAC,CAAC,CAAC;AACL,CAAC,CAAC,CAAC","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-brain/tests/unit/NotificationService.test.ts"],"sourcesContent":["/**\n * Unit tests for NotificationService\n */\n\nimport { NotificationService, NotificationType } from '../../src/server/NotificationService.js';\nimport { NotificationConfig } from '../../src/types/config.js';\n\n// Mock fetch globally\nglobal.fetch = jest.fn();\n\ndescribe('NotificationService', () => {\n  let notificationService: NotificationService;\n  let mockConfig: NotificationConfig;\n\n  beforeEach(() => {\n    mockConfig = {\n      telegram: {\n        enabled: true,\n        botToken: 'test_bot_token',\n        chatId: 'test_chat_id',\n      },\n      email: {\n        enabled: false,\n      },\n    };\n\n    notificationService = new NotificationService(mockConfig);\n    \n    // Reset fetch mock\n    (fetch as jest.Mock).mockReset();\n  });\n\n  describe('sendCircuitBreakerNotification', () => {\n    it('should send circuit breaker notification via Telegram', async () => {\n      // Mock successful Telegram API response\n      (fetch as jest.Mock).mockResolvedValueOnce({\n        ok: true,\n        text: jest.fn().mockResolvedValue('{\"ok\":true}'),\n      });\n\n      const data = {\n        reason: 'Daily drawdown exceeded 15%',\n        equity: 1000,\n        drawdown: 0.15,\n        triggeredAt: Date.now(),\n      };\n\n      await notificationService.sendCircuitBreakerNotification(data);\n\n      expect(fetch).toHaveBeenCalledWith(\n        'https://api.telegram.org/bottest_bot_token/sendMessage',\n        expect.objectContaining({\n          method: 'POST',\n          headers: {\n            'Content-Type': 'application/json',\n          },\n          body: expect.stringContaining('CIRCUIT BREAKER TRIGGERED'),\n        })\n      );\n    });\n\n    it('should retry on failure', async () => {\n      // Mock first call failure, second call success\n      (fetch as jest.Mock)\n        .mockRejectedValueOnce(new Error('Network error'))\n        .mockResolvedValueOnce({\n          ok: true,\n          text: jest.fn().mockResolvedValue('{\"ok\":true}'),\n        });\n\n      const data = {\n        reason: 'Test failure',\n        equity: 1000,\n        drawdown: 0.15,\n        triggeredAt: Date.now(),\n      };\n\n      await notificationService.sendCircuitBreakerNotification(data);\n\n      expect(fetch).toHaveBeenCalledTimes(2);\n    });\n  });\n\n  describe('sendHighCorrelationWarning', () => {\n    it('should send high correlation warning', async () => {\n      (fetch as jest.Mock).mockResolvedValueOnce({\n        ok: true,\n        text: jest.fn().mockResolvedValue('{\"ok\":true}'),\n      });\n\n      const data = {\n        correlationScore: 0.85,\n        threshold: 0.8,\n        affectedPositions: ['BTCUSDT', 'ETHUSDT'],\n      };\n\n      await notificationService.sendHighCorrelationWarning(data);\n\n      expect(fetch).toHaveBeenCalledWith(\n        'https://api.telegram.org/bottest_bot_token/sendMessage',\n        expect.objectContaining({\n          body: expect.stringContaining('HIGH CORRELATION WARNING'),\n        })\n      );\n    });\n  });\n\n  describe('sendSweepNotification', () => {\n    it('should send sweep notification', async () => {\n      (fetch as jest.Mock).mockResolvedValueOnce({\n        ok: true,\n        text: jest.fn().mockResolvedValue('{\"ok\":true}'),\n      });\n\n      const data = {\n        amount: 500,\n        fromWallet: 'FUTURES',\n        toWallet: 'SPOT',\n        reason: 'Automated profit sweep',\n        newBalance: 1500,\n      };\n\n      await notificationService.sendSweepNotification(data);\n\n      expect(fetch).toHaveBeenCalledWith(\n        'https://api.telegram.org/bottest_bot_token/sendMessage',\n        expect.objectContaining({\n          body: expect.stringContaining('PROFIT SWEEP EXECUTED'),\n        })\n      );\n    });\n  });\n\n  describe('sendVetoNotification', () => {\n    it('should send veto notification', async () => {\n      (fetch as jest.Mock).mockResolvedValueOnce({\n        ok: true,\n        text: jest.fn().mockResolvedValue('{\"ok\":true}'),\n      });\n\n      const data = {\n        phaseId: 'phase1' as const,\n        signalId: 'signal_123',\n        symbol: 'BTCUSDT',\n        reason: 'Leverage cap exceeded',\n        requestedSize: 1000,\n      };\n\n      await notificationService.sendVetoNotification(data);\n\n      expect(fetch).toHaveBeenCalledWith(\n        'https://api.telegram.org/bottest_bot_token/sendMessage',\n        expect.objectContaining({\n          body: expect.stringContaining('SIGNAL VETOED'),\n        })\n      );\n    });\n  });\n\n  describe('testNotifications', () => {\n    it('should test Telegram notifications', async () => {\n      (fetch as jest.Mock).mockResolvedValueOnce({\n        ok: true,\n        text: jest.fn().mockResolvedValue('{\"ok\":true}'),\n      });\n\n      const results = await notificationService.testNotifications();\n\n      expect(results.telegram).toBe(true);\n      expect(results.email).toBe(false); // Email is disabled in test config\n      expect(fetch).toHaveBeenCalledTimes(1);\n    });\n\n    it('should handle Telegram test failure', async () => {\n      // Mock all retry attempts to fail\n      (fetch as jest.Mock).mockRejectedValue(new Error('API error'));\n\n      const results = await notificationService.testNotifications();\n\n      expect(results.telegram).toBe(false);\n      expect(fetch).toHaveBeenCalledTimes(3); // Should retry 3 times\n    });\n  });\n\n  describe('configuration', () => {\n    it('should not send notifications when disabled', async () => {\n      const disabledConfig: NotificationConfig = {\n        telegram: { enabled: false },\n        email: { enabled: false },\n      };\n\n      const service = new NotificationService(disabledConfig);\n      \n      const data = {\n        reason: 'Test',\n        equity: 1000,\n        drawdown: 0.15,\n        triggeredAt: Date.now(),\n      };\n\n      await service.sendCircuitBreakerNotification(data);\n\n      expect(fetch).not.toHaveBeenCalled();\n    });\n\n    it('should update configuration', () => {\n      const newConfig: NotificationConfig = {\n        telegram: { enabled: false },\n        email: { enabled: true, smtpHost: 'smtp.test.com' },\n      };\n\n      notificationService.updateConfig(newConfig);\n\n      // Configuration should be updated (tested indirectly through behavior)\n      expect(() => notificationService.updateConfig(newConfig)).not.toThrow();\n    });\n  });\n\n  describe('error handling', () => {\n    it('should handle Telegram API errors gracefully', async () => {\n      // Mock all retry attempts to fail with API error\n      (fetch as jest.Mock).mockResolvedValue({\n        ok: false,\n        status: 400,\n        text: jest.fn().mockResolvedValue('Bad Request'),\n      });\n\n      const data = {\n        reason: 'Test error',\n        equity: 1000,\n        drawdown: 0.15,\n        triggeredAt: Date.now(),\n      };\n\n      // The service catches errors internally and doesn't re-throw for notifications\n      // So we test that it completes without throwing\n      await expect(notificationService.sendCircuitBreakerNotification(data)).resolves.not.toThrow();\n      expect(fetch).toHaveBeenCalledTimes(3); // Should retry 3 times\n    });\n\n    it('should handle missing Telegram configuration', async () => {\n      const incompleteConfig: NotificationConfig = {\n        telegram: { enabled: true }, // Missing botToken and chatId\n        email: { enabled: false },\n      };\n\n      const service = new NotificationService(incompleteConfig);\n      \n      const data = {\n        reason: 'Test',\n        equity: 1000,\n        drawdown: 0.15,\n        triggeredAt: Date.now(),\n      };\n\n      // The service catches errors internally for notifications\n      await expect(service.sendCircuitBreakerNotification(data)).resolves.not.toThrow();\n    });\n  });\n});"],"version":3}
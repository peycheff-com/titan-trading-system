37b794017cf59a03344d5a5217be58c3
"use strict";
/**
 * CacheManager - Redis with in-memory fallback strategy
 *
 * Provides reliable caching with Redis as primary and in-memory as fallback.
 * Handles Redis unavailability gracefully for Railway deployment.
 *
 * Requirements: 3.2.1, 3.2.2, 3.2.3, 3.2.4, 3.2.5
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.CacheManager = void 0;
const events_1 = require("events");
const redis_1 = require("redis");
const InMemoryCache_js_1 = require("./InMemoryCache.js");
/**
 * Cache manager with Redis primary and in-memory fallback
 */
class CacheManager extends events_1.EventEmitter {
    redisClient = null;
    inMemoryCache;
    config;
    metrics;
    healthCheckInterval = null;
    reconnectAttempts = 0;
    isShuttingDown = false;
    responseTimeHistory = [];
    constructor(config) {
        super();
        this.config = config;
        this.inMemoryCache = new InMemoryCache_js_1.InMemoryCache(config.inMemoryMaxSize, config.inMemoryTtlMs);
        this.metrics = this.initializeMetrics();
    }
    /**
     * Initialize metrics object
     */
    initializeMetrics() {
        return {
            redisConnected: false,
            redisHits: 0,
            redisMisses: 0,
            redisErrors: 0,
            memoryHits: 0,
            memoryMisses: 0,
            totalOperations: 0,
            averageResponseTime: 0,
            lastHealthCheck: 0,
            fallbackActive: false
        };
    }
    /**
     * Create cache configuration from environment variables
     */
    static createConfigFromEnv() {
        // Parse Railway REDIS_URL if available
        const redisUrl = process.env.REDIS_URL;
        let redisConfig = undefined;
        if (redisUrl) {
            redisConfig = { url: redisUrl };
        }
        else if (process.env.REDIS_HOST) {
            redisConfig = {
                host: process.env.REDIS_HOST,
                port: parseInt(process.env.REDIS_PORT || '6379'),
                password: process.env.REDIS_PASSWORD,
                db: parseInt(process.env.REDIS_DB || '0'),
                connectTimeout: parseInt(process.env.REDIS_CONNECT_TIMEOUT || '10000'),
                commandTimeout: parseInt(process.env.REDIS_COMMAND_TIMEOUT || '5000'),
                retryDelayOnFailover: parseInt(process.env.REDIS_RETRY_DELAY || '100'),
                maxRetriesPerRequest: parseInt(process.env.REDIS_MAX_RETRIES || '3')
            };
        }
        return {
            redis: redisConfig,
            enableInMemoryFallback: process.env.CACHE_ENABLE_MEMORY_FALLBACK !== 'false',
            inMemoryMaxSize: parseInt(process.env.CACHE_MEMORY_MAX_SIZE || '1000'),
            inMemoryTtlMs: parseInt(process.env.CACHE_MEMORY_TTL || '300000'), // 5 minutes
            healthCheckIntervalMs: parseInt(process.env.CACHE_HEALTH_CHECK_INTERVAL || '30000'),
            healthCheckTimeoutMs: parseInt(process.env.CACHE_HEALTH_CHECK_TIMEOUT || '5000'),
            maxReconnectAttempts: parseInt(process.env.CACHE_MAX_RECONNECT_ATTEMPTS || '5'),
            reconnectDelayMs: parseInt(process.env.CACHE_RECONNECT_DELAY || '5000')
        };
    }
    /**
     * Initialize cache manager
     */
    async initialize() {
        // Initialize in-memory cache (always available)
        this.inMemoryCache.initialize();
        // Initialize Redis if configured
        if (this.config.redis) {
            await this.initializeRedis();
        }
        else {
            console.log('Redis not configured, using in-memory cache only');
            this.metrics.fallbackActive = true;
        }
        // Start health check monitoring
        this.startHealthCheckMonitoring();
        this.emit('initialized', {
            redisEnabled: !!this.config.redis,
            fallbackActive: this.metrics.fallbackActive
        });
    }
    /**
     * Initialize Redis connection
     */
    async initializeRedis() {
        if (!this.config.redis)
            return;
        try {
            // Create Redis client
            this.redisClient = (0, redis_1.createClient)({
                url: this.config.redis.url,
                socket: {
                    host: this.config.redis.host,
                    port: this.config.redis.port,
                    connectTimeout: this.config.redis.connectTimeout,
                    reconnectStrategy: (retries) => {
                        if (retries > this.config.maxReconnectAttempts) {
                            return false; // Stop reconnecting
                        }
                        return Math.min(retries * this.config.reconnectDelayMs, 30000);
                    }
                },
                commandsQueueMaxLength: this.config.redis.maxRetriesPerRequest || 3,
                password: this.config.redis.password,
                database: this.config.redis.db
            });
            // Set up Redis event listeners
            this.setupRedisEventListeners();
            // Connect to Redis
            await this.redisClient.connect();
            this.metrics.redisConnected = true;
            this.metrics.fallbackActive = false;
            this.reconnectAttempts = 0;
            this.emit('redis:connected');
        }
        catch (error) {
            console.warn('Failed to connect to Redis, using in-memory fallback:', error);
            this.metrics.redisConnected = false;
            this.metrics.fallbackActive = true;
            this.redisClient = null;
            this.emit('redis:connection:failed', {
                error: error instanceof Error ? error.message : 'Unknown error'
            });
        }
    }
    /**
     * Set up Redis event listeners
     */
    setupRedisEventListeners() {
        if (!this.redisClient)
            return;
        this.redisClient.on('connect', () => {
            this.metrics.redisConnected = true;
            this.metrics.fallbackActive = false;
            this.reconnectAttempts = 0;
            this.emit('redis:connected');
        });
        this.redisClient.on('ready', () => {
            this.emit('redis:ready');
        });
        this.redisClient.on('error', (error) => {
            this.metrics.redisErrors++;
            this.metrics.redisConnected = false;
            this.metrics.fallbackActive = true;
            this.emit('redis:error', {
                error: error.message,
                totalErrors: this.metrics.redisErrors
            });
        });
        this.redisClient.on('end', () => {
            this.metrics.redisConnected = false;
            this.metrics.fallbackActive = true;
            this.emit('redis:disconnected');
        });
        this.redisClient.on('reconnecting', () => {
            this.reconnectAttempts++;
            this.emit('redis:reconnecting', {
                attempt: this.reconnectAttempts,
                maxAttempts: this.config.maxReconnectAttempts
            });
        });
    }
    /**
     * Start health check monitoring
     */
    startHealthCheckMonitoring() {
        if (this.healthCheckInterval) {
            clearInterval(this.healthCheckInterval);
        }
        this.healthCheckInterval = setInterval(async () => {
            await this.performHealthCheck();
        }, this.config.healthCheckIntervalMs);
    }
    /**
     * Perform health check
     */
    async performHealthCheck() {
        if (this.isShuttingDown)
            return;
        const startTime = Date.now();
        try {
            if (this.redisClient && this.metrics.redisConnected) {
                // Test Redis connection
                await Promise.race([
                    this.redisClient.ping(),
                    new Promise((_, reject) => setTimeout(() => reject(new Error('Redis health check timeout')), this.config.healthCheckTimeoutMs))
                ]);
                this.metrics.lastHealthCheck = Date.now();
                this.emit('health:check:success', {
                    source: 'redis',
                    duration: Date.now() - startTime
                });
            }
            else {
                // Test in-memory cache
                const testKey = '__health_check__';
                const testValue = Date.now().toString();
                this.inMemoryCache.set(testKey, testValue, 1000); // 1 second TTL
                const retrieved = this.inMemoryCache.get(testKey);
                if (retrieved !== testValue) {
                    throw new Error('In-memory cache health check failed');
                }
                this.inMemoryCache.delete(testKey);
                this.metrics.lastHealthCheck = Date.now();
                this.emit('health:check:success', {
                    source: 'memory',
                    duration: Date.now() - startTime
                });
            }
        }
        catch (error) {
            this.metrics.lastHealthCheck = Date.now();
            this.emit('health:check:failure', {
                error: error instanceof Error ? error.message : 'Unknown error',
                duration: Date.now() - startTime
            });
        }
    }
    /**
     * Get a value from cache
     */
    async get(key) {
        const startTime = Date.now();
        this.metrics.totalOperations++;
        // Try Redis first if available
        if (this.redisClient && this.metrics.redisConnected) {
            try {
                const value = await this.redisClient.get(key);
                const duration = Date.now() - startTime;
                this.updateResponseTimeMetrics(duration);
                if (value !== null) {
                    this.metrics.redisHits++;
                    this.emit('cache:hit', { source: 'redis', key, duration });
                    return {
                        success: true,
                        value: JSON.parse(value),
                        source: 'redis',
                        duration
                    };
                }
                else {
                    this.metrics.redisMisses++;
                    this.emit('cache:miss', { source: 'redis', key, duration });
                    return {
                        success: false,
                        source: 'redis',
                        duration
                    };
                }
            }
            catch (error) {
                this.metrics.redisErrors++;
                this.emit('cache:error', {
                    source: 'redis',
                    key,
                    error: error instanceof Error ? error.message : 'Unknown error'
                });
                // Fall through to in-memory cache
            }
        }
        // Use in-memory cache as fallback
        if (this.config.enableInMemoryFallback) {
            const value = this.inMemoryCache.get(key);
            const duration = Date.now() - startTime;
            this.updateResponseTimeMetrics(duration);
            if (value !== undefined) {
                this.metrics.memoryHits++;
                this.emit('cache:hit', { source: 'memory', key, duration });
                return {
                    success: true,
                    value,
                    source: 'memory',
                    duration
                };
            }
            else {
                this.metrics.memoryMisses++;
                this.emit('cache:miss', { source: 'memory', key, duration });
                return {
                    success: false,
                    source: 'memory',
                    duration
                };
            }
        }
        // No cache available
        return {
            success: false,
            source: 'none',
            duration: Date.now() - startTime
        };
    }
    /**
     * Set a value in cache
     */
    async set(key, value, ttlSeconds) {
        const startTime = Date.now();
        this.metrics.totalOperations++;
        // Try Redis first if available
        if (this.redisClient && this.metrics.redisConnected) {
            try {
                const serializedValue = JSON.stringify(value);
                if (ttlSeconds) {
                    await this.redisClient.setEx(key, ttlSeconds, serializedValue);
                }
                else {
                    await this.redisClient.set(key, serializedValue);
                }
                const duration = Date.now() - startTime;
                this.updateResponseTimeMetrics(duration);
                this.emit('cache:set', { source: 'redis', key, duration });
                return {
                    success: true,
                    source: 'redis',
                    duration
                };
            }
            catch (error) {
                this.metrics.redisErrors++;
                this.emit('cache:error', {
                    source: 'redis',
                    key,
                    error: error instanceof Error ? error.message : 'Unknown error'
                });
                // Fall through to in-memory cache
            }
        }
        // Use in-memory cache as fallback
        if (this.config.enableInMemoryFallback) {
            const ttlMs = ttlSeconds ? ttlSeconds * 1000 : this.config.inMemoryTtlMs;
            this.inMemoryCache.set(key, value, ttlMs);
            const duration = Date.now() - startTime;
            this.updateResponseTimeMetrics(duration);
            this.emit('cache:set', { source: 'memory', key, duration });
            return {
                success: true,
                source: 'memory',
                duration
            };
        }
        // No cache available
        return {
            success: false,
            source: 'none',
            duration: Date.now() - startTime,
            error: 'No cache backend available'
        };
    }
    /**
     * Delete a value from cache
     */
    async delete(key) {
        const startTime = Date.now();
        this.metrics.totalOperations++;
        let redisSuccess = false;
        let memorySuccess = false;
        // Try Redis first if available
        if (this.redisClient && this.metrics.redisConnected) {
            try {
                await this.redisClient.del(key);
                redisSuccess = true;
                this.emit('cache:delete', { source: 'redis', key });
            }
            catch (error) {
                this.metrics.redisErrors++;
                this.emit('cache:error', {
                    source: 'redis',
                    key,
                    error: error instanceof Error ? error.message : 'Unknown error'
                });
            }
        }
        // Also delete from in-memory cache
        if (this.config.enableInMemoryFallback) {
            memorySuccess = this.inMemoryCache.delete(key);
            if (memorySuccess) {
                this.emit('cache:delete', { source: 'memory', key });
            }
        }
        const duration = Date.now() - startTime;
        this.updateResponseTimeMetrics(duration);
        return {
            success: redisSuccess || memorySuccess,
            source: redisSuccess ? 'redis' : (memorySuccess ? 'memory' : 'none'),
            duration
        };
    }
    /**
     * Clear all cache entries
     */
    async clear() {
        const startTime = Date.now();
        this.metrics.totalOperations++;
        let redisSuccess = false;
        let memorySuccess = false;
        // Clear Redis if available
        if (this.redisClient && this.metrics.redisConnected) {
            try {
                await this.redisClient.flushDb();
                redisSuccess = true;
                this.emit('cache:clear', { source: 'redis' });
            }
            catch (error) {
                this.metrics.redisErrors++;
                this.emit('cache:error', {
                    source: 'redis',
                    error: error instanceof Error ? error.message : 'Unknown error'
                });
            }
        }
        // Clear in-memory cache
        if (this.config.enableInMemoryFallback) {
            this.inMemoryCache.clear();
            memorySuccess = true;
            this.emit('cache:clear', { source: 'memory' });
        }
        const duration = Date.now() - startTime;
        this.updateResponseTimeMetrics(duration);
        return {
            success: redisSuccess || memorySuccess,
            source: redisSuccess ? 'redis' : (memorySuccess ? 'memory' : 'none'),
            duration
        };
    }
    /**
     * Update response time metrics
     */
    updateResponseTimeMetrics(duration) {
        this.responseTimeHistory.push(duration);
        // Keep only last 100 operations for average calculation
        if (this.responseTimeHistory.length > 100) {
            this.responseTimeHistory.shift();
        }
        // Calculate average response time
        this.metrics.averageResponseTime = this.responseTimeHistory.reduce((sum, time) => sum + time, 0) / this.responseTimeHistory.length;
    }
    /**
     * Get current cache metrics
     */
    getMetrics() {
        return { ...this.metrics };
    }
    /**
     * Check if cache is healthy
     */
    isHealthy() {
        return this.metrics.redisConnected || this.metrics.fallbackActive;
    }
    /**
     * Get cache status
     */
    getStatus() {
        const totalHits = this.metrics.redisHits + this.metrics.memoryHits;
        const totalMisses = this.metrics.redisMisses + this.metrics.memoryMisses;
        const hitRate = totalHits + totalMisses > 0 ? (totalHits / (totalHits + totalMisses)) * 100 : 0;
        return {
            redisConnected: this.metrics.redisConnected,
            fallbackActive: this.metrics.fallbackActive,
            totalOperations: this.metrics.totalOperations,
            hitRate,
            averageResponseTime: this.metrics.averageResponseTime
        };
    }
    /**
     * Gracefully shutdown the cache manager
     */
    async shutdown() {
        this.isShuttingDown = true;
        // Stop health check monitoring
        if (this.healthCheckInterval) {
            clearInterval(this.healthCheckInterval);
            this.healthCheckInterval = null;
        }
        // Disconnect Redis
        if (this.redisClient) {
            try {
                await this.redisClient.disconnect();
            }
            catch (error) {
                console.warn('Error disconnecting Redis:', error);
            }
            this.redisClient = null;
        }
        // Clear in-memory cache
        this.inMemoryCache.clear();
        this.emit('shutdown');
    }
}
exports.CacheManager = CacheManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLWJyYWluL3NyYy9jYWNoZS9DYWNoZU1hbmFnZXIudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7O0dBT0c7OztBQUVILG1DQUFzQztBQUN0QyxpQ0FBc0Q7QUFDdEQseURBQW1EO0FBeURuRDs7R0FFRztBQUNILE1BQWEsWUFBYSxTQUFRLHFCQUFZO0lBQ3BDLFdBQVcsR0FBMkIsSUFBSSxDQUFDO0lBQzNDLGFBQWEsQ0FBZ0I7SUFDN0IsTUFBTSxDQUFjO0lBQ3BCLE9BQU8sQ0FBZTtJQUN0QixtQkFBbUIsR0FBMEIsSUFBSSxDQUFDO0lBQ2xELGlCQUFpQixHQUFXLENBQUMsQ0FBQztJQUM5QixjQUFjLEdBQVksS0FBSyxDQUFDO0lBQ2hDLG1CQUFtQixHQUFhLEVBQUUsQ0FBQztJQUUzQyxZQUFZLE1BQW1CO1FBQzdCLEtBQUssRUFBRSxDQUFDO1FBQ1IsSUFBSSxDQUFDLE1BQU0sR0FBRyxNQUFNLENBQUM7UUFDckIsSUFBSSxDQUFDLGFBQWEsR0FBRyxJQUFJLGdDQUFhLENBQUMsTUFBTSxDQUFDLGVBQWUsRUFBRSxNQUFNLENBQUMsYUFBYSxDQUFDLENBQUM7UUFDckYsSUFBSSxDQUFDLE9BQU8sR0FBRyxJQUFJLENBQUMsaUJBQWlCLEVBQUUsQ0FBQztJQUMxQyxDQUFDO0lBRUQ7O09BRUc7SUFDSyxpQkFBaUI7UUFDdkIsT0FBTztZQUNMLGNBQWMsRUFBRSxLQUFLO1lBQ3JCLFNBQVMsRUFBRSxDQUFDO1lBQ1osV0FBVyxFQUFFLENBQUM7WUFDZCxXQUFXLEVBQUUsQ0FBQztZQUNkLFVBQVUsRUFBRSxDQUFDO1lBQ2IsWUFBWSxFQUFFLENBQUM7WUFDZixlQUFlLEVBQUUsQ0FBQztZQUNsQixtQkFBbUIsRUFBRSxDQUFDO1lBQ3RCLGVBQWUsRUFBRSxDQUFDO1lBQ2xCLGNBQWMsRUFBRSxLQUFLO1NBQ3RCLENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxNQUFNLENBQUMsbUJBQW1C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Q0FBQyxjQUFjO1lBQzNDLGVBQWUsRUFBRSxJQUFJLENBQUMsT0FBTyxDQUFDLGVBQWU7WUFDN0MsT0FBTztZQUNQLG1CQUFtQixFQUFFLElBQUksQ0FBQyxPQUFPLENBQUMsbUJBQW1CO1NBQ3RELENBQUM7SUFDSixDQUFDO0lBRUQ7O09BRUc7SUFDSCxLQUFLLENBQUMsUUFBUTtRQUNaLElBQUksQ0FBQyxjQUFjLEdBQUcsSUFBSSxDQUFDO1FBRTNCLCtCQUErQjtRQUMvQixJQUFJLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1lBQzdCLGFBQWEsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsQ0FBQztZQUN4QyxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxDQUFDO1FBQ2xDLENBQUM7UUFFRCxtQkFBbUI7UUFDbkIsSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDckIsSUFBSSxDQUFDO2dCQUNILE1BQU0sSUFBSSxDQUFDLFdBQVcsQ0FBQyxVQUFVLEVBQUUsQ0FBQztZQUN0QyxDQUFDO1lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztnQkFDZixPQUFPLENBQUMsSUFBSSxDQUFDLDRCQUE0QixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3BELENBQUM7WUFDRCxJQUFJLENBQUMsV0FBVyxHQUFHLElBQUksQ0FBQztRQUMxQixDQUFDO1FBRUQsd0JBQXdCO1FBQ3hCLElBQUksQ0FBQyxhQUFhLENBQUMsS0FBSyxFQUFFLENBQUM7UUFFM0IsSUFBSSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUN4QixDQUFDO0NBQ0Y7QUFsakJELG9DQWtqQkMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLWJyYWluL3NyYy9jYWNoZS9DYWNoZU1hbmFnZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDYWNoZU1hbmFnZXIgLSBSZWRpcyB3aXRoIGluLW1lbW9yeSBmYWxsYmFjayBzdHJhdGVneVxuICogXG4gKiBQcm92aWRlcyByZWxpYWJsZSBjYWNoaW5nIHdpdGggUmVkaXMgYXMgcHJpbWFyeSBhbmQgaW4tbWVtb3J5IGFzIGZhbGxiYWNrLlxuICogSGFuZGxlcyBSZWRpcyB1bmF2YWlsYWJpbGl0eSBncmFjZWZ1bGx5IGZvciBSYWlsd2F5IGRlcGxveW1lbnQuXG4gKiBcbiAqIFJlcXVpcmVtZW50czogMy4yLjEsIDMuMi4yLCAzLjIuMywgMy4yLjQsIDMuMi41XG4gKi9cblxuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IGNyZWF0ZUNsaWVudCwgUmVkaXNDbGllbnRUeXBlIH0gZnJvbSAncmVkaXMnO1xuaW1wb3J0IHsgSW5NZW1vcnlDYWNoZSB9IGZyb20gJy4vSW5NZW1vcnlDYWNoZS5qcyc7XG5cbi8qKlxuICogQ2FjaGUgY29uZmlndXJhdGlvblxuICovXG5leHBvcnQgaW50ZXJmYWNlIENhY2hlQ29uZmlnIHtcbiAgcmVkaXM/OiB7XG4gICAgdXJsPzogc3RyaW5nO1xuICAgIGhvc3Q/OiBzdHJpbmc7XG4gICAgcG9ydD86IG51bWJlcjtcbiAgICBwYXNzd29yZD86IHN0cmluZztcbiAgICBkYj86IG51bWJlcjtcbiAgICBjb25uZWN0VGltZW91dD86IG51bWJlcjtcbiAgICBjb21tYW5kVGltZW91dD86IG51bWJlcjtcbiAgICByZXRyeURlbGF5T25GYWlsb3Zlcj86IG51bWJlcjtcbiAgICBtYXhSZXRyaWVzUGVyUmVxdWVzdD86IG51bWJlcjtcbiAgfTtcbiAgXG4gIC8vIEZhbGxiYWNrIHNldHRpbmdzXG4gIGVuYWJsZUluTWVtb3J5RmFsbGJhY2s6IGJvb2xlYW47XG4gIGluTWVtb3J5TWF4U2l6ZTogbnVtYmVyO1xuICBpbk1lbW9yeVR0bE1zOiBudW1iZXI7XG4gIFxuICAvLyBIZWFsdGggY2hlY2sgc2V0dGluZ3NcbiAgaGVhbHRoQ2hlY2tJbnRlcnZhbE1zOiBudW1iZXI7XG4gIGhlYWx0aENoZWNrVGltZW91dE1zOiBudW1iZXI7XG4gIG1heFJlY29ubmVjdEF0dGVtcHRzOiBudW1iZXI7XG4gIHJlY29ubmVjdERlbGF5TXM6IG51bWJlcjtcbn1cblxuLyoqXG4gKiBDYWNoZSBvcGVyYXRpb24gcmVzdWx0XG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQ2FjaGVSZXN1bHQ8VCA9IGFueT4ge1xuICBzdWNjZXNzOiBib29sZWFuO1xuICB2YWx1ZT86IFQ7XG4gIHNvdXJjZTogJ3JlZGlzJyB8ICdtZW1vcnknIHwgJ25vbmUnO1xuICBlcnJvcj86IHN0cmluZztcbiAgZHVyYXRpb246IG51bWJlcjtcbn1cblxuLyoqXG4gKiBDYWNoZSBtZXRyaWNzXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQ2FjaGVNZXRyaWNzIHtcbiAgcmVkaXNDb25uZWN0ZWQ6IGJvb2xlYW47XG4gIHJlZGlzSGl0czogbnVtYmVyO1xuICByZWRpc01pc3NlczogbnVtYmVyO1xuICByZWRpc0Vycm9yczogbnVtYmVyO1xuICBtZW1vcnlIaXRzOiBudW1iZXI7XG4gIG1lbW9yeU1pc3NlczogbnVtYmVyO1xuICB0b3RhbE9wZXJhdGlvbnM6IG51bWJlcjtcbiAgYXZlcmFnZVJlc3BvbnNlVGltZTogbnVtYmVyO1xuICBsYXN0SGVhbHRoQ2hlY2s6IG51bWJlcjtcbiAgZmFsbGJhY2tBY3RpdmU6IGJvb2xlYW47XG59XG5cbi8qKlxuICogQ2FjaGUgbWFuYWdlciB3aXRoIFJlZGlzIHByaW1hcnkgYW5kIGluLW1lbW9yeSBmYWxsYmFja1xuICovXG5leHBvcnQgY2xhc3MgQ2FjaGVNYW5hZ2VyIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgcHJpdmF0ZSByZWRpc0NsaWVudDogUmVkaXNDbGllbnRUeXBlIHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgaW5NZW1vcnlDYWNoZTogSW5NZW1vcnlDYWNoZTtcbiAgcHJpdmF0ZSBjb25maWc6IENhY2hlQ29uZmlnO1xuICBwcml2YXRlIG1ldHJpY3M6IENhY2hlTWV0cmljcztcbiAgcHJpdmF0ZSBoZWFsdGhDaGVja0ludGVydmFsOiBOb2RlSlMuVGltZW91dCB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIHJlY29ubmVjdEF0dGVtcHRzOiBudW1iZXIgPSAwO1xuICBwcml2YXRlIGlzU2h1dHRpbmdEb3duOiBib29sZWFuID0gZmFsc2U7XG4gIHByaXZhdGUgcmVzcG9uc2VUaW1lSGlzdG9yeTogbnVtYmVyW10gPSBbXTtcblxuICBjb25zdHJ1Y3Rvcihjb25maWc6IENhY2hlQ29uZmlnKSB7XG4gICAgc3VwZXIoKTtcbiAgICB0aGlzLmNvbmZpZyA9IGNvbmZpZztcbiAgICB0aGlzLmluTWVtb3J5Q2FjaGUgPSBuZXcgSW5NZW1vcnlDYWNoZShjb25maWcuaW5NZW1vcnlNYXhTaXplLCBjb25maWcuaW5NZW1vcnlUdGxNcyk7XG4gICAgdGhpcy5tZXRyaWNzID0gdGhpcy5pbml0aWFsaXplTWV0cmljcygpO1xuICB9XG5cbiAgLyoqXG4gICAqIEluaXRpYWxpemUgbWV0cmljcyBvYmplY3RcbiAgICovXG4gIHByaXZhdGUgaW5pdGlhbGl6ZU1ldHJpY3MoKTogQ2FjaGVNZXRyaWNzIHtcbiAgICByZXR1cm4ge1xuICAgICAgcmVkaXNDb25uZWN0ZWQ6IGZhbHNlLFxuICAgICAgcmVkaXNIaXRzOiAwLFxuICAgICAgcmVkaXNNaXNzZXM6IDAsXG4gICAgICByZWRpc0Vycm9yczogMCxcbiAgICAgIG1lbW9yeUhpdHM6IDAsXG4gICAgICBtZW1vcnlNaXNzZXM6IDAsXG4gICAgICB0b3RhbE9wZXJhdGlvbnM6IDAsXG4gICAgICBhdmVyYWdlUmVzcG9uc2VUaW1lOiAwLFxuICAgICAgbGFzdEhlYWx0aENoZWNrOiAwLFxuICAgICAgZmFsbGJhY2tBY3RpdmU6IGZhbHNlXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDcmVhdGUgY2FjaGUgY29uZmlndXJhdGlvbiBmcm9tIGVudmlyb25tZW50IHZhcmlhYmxlc1xuICAgKi9cbiAgc3RhdGljIGNyZWF0ZUNvbmZpZ0Zyb21FbnYoKTogQ2FjaGVDb25maWcge1xuICAgIC8vIFBhcnNlIFJhaWx3YXkgUkVESVNfVVJMIGlmIGF2YWlsYWJsZVxuICAgIGNvbnN0IHJlZGlzVXJsID0gcHJvY2Vzcy5lbnYuUkVESVNfVVJMO1xuICAgIGxldCByZWRpc0NvbmZpZzogQ2FjaGVDb25maWdbJ3JlZGlzJ10gPSB1bmRlZmluZWQ7XG5cbiAgICBpZiAocmVkaXNVcmwpIHtcbiAgICAgIHJlZGlzQ29uZmlnID0geyB1cmw6IHJlZGlzVXJsIH07XG4gICAgfSBlbHNlIGlmIChwcm9jZXNzLmVudi5SRURJU19IT1NUKSB7XG4gICAgICByZWRpc0NvbmZpZyA9IHtcbiAgICAgICAgaG9zdDogcHJvY2Vzcy5lbnYuUkVESVNfSE9TVCxcbiAgICAgICAgcG9ydDogcGFyc2VJbnQocHJvY2Vzcy5lbnYuUkVESVNfUE9SVCB8fCAnNjM3OScpLFxuICAgICAgICBwYXNzd29yZDogcHJvY2Vzcy5lbnYuUkVESVNfUEFTU1dPUkQsXG4gICAgICAgIGRiOiBwYXJzZUludChwcm9jZXNzLmVudi5SRURJU19EQiB8fCAnMCcpLFxuICAgICAgICBjb25uZWN0VGltZW91dDogcGFyc2VJbnQocHJvY2Vzcy5lbnYuUkVESVNfQ09OTkVDVF9USU1FT1VUIHx8ICcxMDAwMCcpLFxuICAgICAgICBjb21tYW5kVGltZW91dDogcGFyc2VJbnQocHJvY2Vzcy5lbnYuUkVESVNfQ09NTUFORF9USU1FT1VUIHx8ICc1MDAwJyksXG4gICAgICAgIHJldHJ5RGVsYXlPbkZhaWxvdmVyOiBwYXJzZUludChwcm9jZXNzLmVudi5SRURJU19SRVRSWV9ERUxBWSB8fCAnMTAwJyksXG4gICAgICAgIG1heFJldHJpZXNQZXJSZXF1ZXN0OiBwYXJzZUludChwcm9jZXNzLmVudi5SRURJU19NQVhfUkVUUklFUyB8fCAnMycpXG4gICAgICB9O1xuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICByZWRpczogcmVkaXNDb25maWcsXG4gICAgICBlbmFibGVJbk1lbW9yeUZhbGxiYWNrOiBwcm9jZXNzLmVudi5DQUNIRV9FTkFCTEVfTUVNT1JZX0ZBTExCQUNLICE9PSAnZmFsc2UnLFxuICAgICAgaW5NZW1vcnlNYXhTaXplOiBwYXJzZUludChwcm9jZXNzLmVudi5DQUNIRV9NRU1PUllfTUFYX1NJWkUgfHwgJzEwMDAnKSxcbiAgICAgIGluTWVtb3J5VHRsTXM6IHBhcnNlSW50KHByb2Nlc3MuZW52LkNBQ0hFX01FTU9SWV9UVEwgfHwgJzMwMDAwMCcpLCAvLyA1IG1pbnV0ZXNcbiAgICAgIGhlYWx0aENoZWNrSW50ZXJ2YWxNczogcGFyc2VJbnQocHJvY2Vzcy5lbnYuQ0FDSEVfSEVBTFRIX0NIRUNLX0lOVEVSVkFMIHx8ICczMDAwMCcpLFxuICAgICAgaGVhbHRoQ2hlY2tUaW1lb3V0TXM6IHBhcnNlSW50KHByb2Nlc3MuZW52LkNBQ0hFX0hFQUxUSF9DSEVDS19USU1FT1VUIHx8ICc1MDAwJyksXG4gICAgICBtYXhSZWNvbm5lY3RBdHRlbXB0czogcGFyc2VJbnQocHJvY2Vzcy5lbnYuQ0FDSEVfTUFYX1JFQ09OTkVDVF9BVFRFTVBUUyB8fCAnNScpLFxuICAgICAgcmVjb25uZWN0RGVsYXlNczogcGFyc2VJbnQocHJvY2Vzcy5lbnYuQ0FDSEVfUkVDT05ORUNUX0RFTEFZIHx8ICc1MDAwJylcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEluaXRpYWxpemUgY2FjaGUgbWFuYWdlclxuICAgKi9cbiAgYXN5bmMgaW5pdGlhbGl6ZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICAvLyBJbml0aWFsaXplIGluLW1lbW9yeSBjYWNoZSAoYWx3YXlzIGF2YWlsYWJsZSlcbiAgICB0aGlzLmluTWVtb3J5Q2FjaGUuaW5pdGlhbGl6ZSgpO1xuXG4gICAgLy8gSW5pdGlhbGl6ZSBSZWRpcyBpZiBjb25maWd1cmVkXG4gICAgaWYgKHRoaXMuY29uZmlnLnJlZGlzKSB7XG4gICAgICBhd2FpdCB0aGlzLmluaXRpYWxpemVSZWRpcygpO1xuICAgIH0gZWxzZSB7XG4gICAgICBjb25zb2xlLmxvZygnUmVkaXMgbm90IGNvbmZpZ3VyZWQsIHVzaW5nIGluLW1lbW9yeSBjYWNoZSBvbmx5Jyk7XG4gICAgICB0aGlzLm1ldHJpY3MuZmFsbGJhY2tBY3RpdmUgPSB0cnVlO1xuICAgIH1cblxuICAgIC8vIFN0YXJ0IGhlYWx0aCBjaGVjayBtb25pdG9yaW5nXG4gICAgdGhpcy5zdGFydEhlYWx0aENoZWNrTW9uaXRvcmluZygpO1xuXG4gICAgdGhpcy5lbWl0KCdpbml0aWFsaXplZCcsIHsgXG4gICAgICByZWRpc0VuYWJsZWQ6ICEhdGhpcy5jb25maWcucmVkaXMsXG4gICAgICBmYWxsYmFja0FjdGl2ZTogdGhpcy5tZXRyaWNzLmZhbGxiYWNrQWN0aXZlIFxuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIEluaXRpYWxpemUgUmVkaXMgY29ubmVjdGlvblxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBpbml0aWFsaXplUmVkaXMoKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKCF0aGlzLmNvbmZpZy5yZWRpcykgcmV0dXJuO1xuXG4gICAgdHJ5IHtcbiAgICAgIC8vIENyZWF0ZSBSZWRpcyBjbGllbnRcbiAgICAgIHRoaXMucmVkaXNDbGllbnQgPSBjcmVhdGVDbGllbnQoe1xuICAgICAgICB1cmw6IHRoaXMuY29uZmlnLnJlZGlzLnVybCxcbiAgICAgICAgc29ja2V0OiB7XG4gICAgICAgICAgaG9zdDogdGhpcy5jb25maWcucmVkaXMuaG9zdCxcbiAgICAgICAgICBwb3J0OiB0aGlzLmNvbmZpZy5yZWRpcy5wb3J0LFxuICAgICAgICAgIGNvbm5lY3RUaW1lb3V0OiB0aGlzLmNvbmZpZy5yZWRpcy5jb25uZWN0VGltZW91dCxcbiAgICAgICAgICByZWNvbm5lY3RTdHJhdGVneTogKHJldHJpZXMpID0+IHtcbiAgICAgICAgICAgIGlmIChyZXRyaWVzID4gdGhpcy5jb25maWcubWF4UmVjb25uZWN0QXR0ZW1wdHMpIHtcbiAgICAgICAgICAgICAgcmV0dXJuIGZhbHNlOyAvLyBTdG9wIHJlY29ubmVjdGluZ1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgcmV0dXJuIE1hdGgubWluKHJldHJpZXMgKiB0aGlzLmNvbmZpZy5yZWNvbm5lY3REZWxheU1zLCAzMDAwMCk7XG4gICAgICAgICAgfVxuICAgICAgICB9LFxuICAgICAgICBjb21tYW5kc1F1ZXVlTWF4TGVuZ3RoOiB0aGlzLmNvbmZpZy5yZWRpcy5tYXhSZXRyaWVzUGVyUmVxdWVzdCB8fCAzLFxuICAgICAgICBwYXNzd29yZDogdGhpcy5jb25maWcucmVkaXMucGFzc3dvcmQsXG4gICAgICAgIGRhdGFiYXNlOiB0aGlzLmNvbmZpZy5yZWRpcy5kYlxuICAgICAgfSk7XG5cbiAgICAgIC8vIFNldCB1cCBSZWRpcyBldmVudCBsaXN0ZW5lcnNcbiAgICAgIHRoaXMuc2V0dXBSZWRpc0V2ZW50TGlzdGVuZXJzKCk7XG5cbiAgICAgIC8vIENvbm5lY3QgdG8gUmVkaXNcbiAgICAgIGF3YWl0IHRoaXMucmVkaXNDbGllbnQuY29ubmVjdCgpO1xuICAgICAgXG4gICAgICB0aGlzLm1ldHJpY3MucmVkaXNDb25uZWN0ZWQgPSB0cnVlO1xuICAgICAgdGhpcy5tZXRyaWNzLmZhbGxiYWNrQWN0aXZlID0gZmFsc2U7XG4gICAgICB0aGlzLnJlY29ubmVjdEF0dGVtcHRzID0gMDtcblxuICAgICAgdGhpcy5lbWl0KCdyZWRpczpjb25uZWN0ZWQnKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS53YXJuKCdGYWlsZWQgdG8gY29ubmVjdCB0byBSZWRpcywgdXNpbmcgaW4tbWVtb3J5IGZhbGxiYWNrOicsIGVycm9yKTtcbiAgICAgIHRoaXMubWV0cmljcy5yZWRpc0Nvbm5lY3RlZCA9IGZhbHNlO1xuICAgICAgdGhpcy5tZXRyaWNzLmZhbGxiYWNrQWN0aXZlID0gdHJ1ZTtcbiAgICAgIHRoaXMucmVkaXNDbGllbnQgPSBudWxsO1xuICAgICAgXG4gICAgICB0aGlzLmVtaXQoJ3JlZGlzOmNvbm5lY3Rpb246ZmFpbGVkJywgeyBcbiAgICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InIFxuICAgICAgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNldCB1cCBSZWRpcyBldmVudCBsaXN0ZW5lcnNcbiAgICovXG4gIHByaXZhdGUgc2V0dXBSZWRpc0V2ZW50TGlzdGVuZXJzKCk6IHZvaWQge1xuICAgIGlmICghdGhpcy5yZWRpc0NsaWVudCkgcmV0dXJuO1xuXG4gICAgdGhpcy5yZWRpc0NsaWVudC5vbignY29ubmVjdCcsICgpID0+IHtcbiAgICAgIHRoaXMubWV0cmljcy5yZWRpc0Nvbm5lY3RlZCA9IHRydWU7XG4gICAgICB0aGlzLm1ldHJpY3MuZmFsbGJhY2tBY3RpdmUgPSBmYWxzZTtcbiAgICAgIHRoaXMucmVjb25uZWN0QXR0ZW1wdHMgPSAwO1xuICAgICAgdGhpcy5lbWl0KCdyZWRpczpjb25uZWN0ZWQnKTtcbiAgICB9KTtcblxuICAgIHRoaXMucmVkaXNDbGllbnQub24oJ3JlYWR5JywgKCkgPT4ge1xuICAgICAgdGhpcy5lbWl0KCdyZWRpczpyZWFkeScpO1xuICAgIH0pO1xuXG4gICAgdGhpcy5yZWRpc0NsaWVudC5vbignZXJyb3InLCAoZXJyb3IpID0+IHtcbiAgICAgIHRoaXMubWV0cmljcy5yZWRpc0Vycm9ycysrO1xuICAgICAgdGhpcy5tZXRyaWNzLnJlZGlzQ29ubmVjdGVkID0gZmFsc2U7XG4gICAgICB0aGlzLm1ldHJpY3MuZmFsbGJhY2tBY3RpdmUgPSB0cnVlO1xuICAgICAgXG4gICAgICB0aGlzLmVtaXQoJ3JlZGlzOmVycm9yJywgeyBcbiAgICAgICAgZXJyb3I6IGVycm9yLm1lc3NhZ2UsXG4gICAgICAgIHRvdGFsRXJyb3JzOiB0aGlzLm1ldHJpY3MucmVkaXNFcnJvcnMgXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIHRoaXMucmVkaXNDbGllbnQub24oJ2VuZCcsICgpID0+IHtcbiAgICAgIHRoaXMubWV0cmljcy5yZWRpc0Nvbm5lY3RlZCA9IGZhbHNlO1xuICAgICAgdGhpcy5tZXRyaWNzLmZhbGxiYWNrQWN0aXZlID0gdHJ1ZTtcbiAgICAgIHRoaXMuZW1pdCgncmVkaXM6ZGlzY29ubmVjdGVkJyk7XG4gICAgfSk7XG5cbiAgICB0aGlzLnJlZGlzQ2xpZW50Lm9uKCdyZWNvbm5lY3RpbmcnLCAoKSA9PiB7XG4gICAgICB0aGlzLnJlY29ubmVjdEF0dGVtcHRzKys7XG4gICAgICB0aGlzLmVtaXQoJ3JlZGlzOnJlY29ubmVjdGluZycsIHsgXG4gICAgICAgIGF0dGVtcHQ6IHRoaXMucmVjb25uZWN0QXR0ZW1wdHMsXG4gICAgICAgIG1heEF0dGVtcHRzOiB0aGlzLmNvbmZpZy5tYXhSZWNvbm5lY3RBdHRlbXB0cyBcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFN0YXJ0IGhlYWx0aCBjaGVjayBtb25pdG9yaW5nXG4gICAqL1xuICBwcml2YXRlIHN0YXJ0SGVhbHRoQ2hlY2tNb25pdG9yaW5nKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmhlYWx0aENoZWNrSW50ZXJ2YWwpIHtcbiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5oZWFsdGhDaGVja0ludGVydmFsKTtcbiAgICB9XG5cbiAgICB0aGlzLmhlYWx0aENoZWNrSW50ZXJ2YWwgPSBzZXRJbnRlcnZhbChhc3luYyAoKSA9PiB7XG4gICAgICBhd2FpdCB0aGlzLnBlcmZvcm1IZWFsdGhDaGVjaygpO1xuICAgIH0sIHRoaXMuY29uZmlnLmhlYWx0aENoZWNrSW50ZXJ2YWxNcyk7XG4gIH1cblxuICAvKipcbiAgICogUGVyZm9ybSBoZWFsdGggY2hlY2tcbiAgICovXG4gIHByaXZhdGUgYXN5bmMgcGVyZm9ybUhlYWx0aENoZWNrKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICh0aGlzLmlzU2h1dHRpbmdEb3duKSByZXR1cm47XG5cbiAgICBjb25zdCBzdGFydFRpbWUgPSBEYXRlLm5vdygpO1xuICAgIFxuICAgIHRyeSB7XG4gICAgICBpZiAodGhpcy5yZWRpc0NsaWVudCAmJiB0aGlzLm1ldHJpY3MucmVkaXNDb25uZWN0ZWQpIHtcbiAgICAgICAgLy8gVGVzdCBSZWRpcyBjb25uZWN0aW9uXG4gICAgICAgIGF3YWl0IFByb21pc2UucmFjZShbXG4gICAgICAgICAgdGhpcy5yZWRpc0NsaWVudC5waW5nKCksXG4gICAgICAgICAgbmV3IFByb21pc2UoKF8sIHJlamVjdCkgPT4gXG4gICAgICAgICAgICBzZXRUaW1lb3V0KCgpID0+IHJlamVjdChuZXcgRXJyb3IoJ1JlZGlzIGhlYWx0aCBjaGVjayB0aW1lb3V0JykpLCB0aGlzLmNvbmZpZy5oZWFsdGhDaGVja1RpbWVvdXRNcylcbiAgICAgICAgICApXG4gICAgICAgIF0pO1xuICAgICAgICBcbiAgICAgICAgdGhpcy5tZXRyaWNzLmxhc3RIZWFsdGhDaGVjayA9IERhdGUubm93KCk7XG4gICAgICAgIHRoaXMuZW1pdCgnaGVhbHRoOmNoZWNrOnN1Y2Nlc3MnLCB7IFxuICAgICAgICAgIHNvdXJjZTogJ3JlZGlzJyxcbiAgICAgICAgICBkdXJhdGlvbjogRGF0ZS5ub3coKSAtIHN0YXJ0VGltZSBcbiAgICAgICAgfSk7XG4gICAgICB9IGVsc2Uge1xuICAgICAgICAvLyBUZXN0IGluLW1lbW9yeSBjYWNoZVxuICAgICAgICBjb25zdCB0ZXN0S2V5ID0gJ19faGVhbHRoX2NoZWNrX18nO1xuICAgICAgICBjb25zdCB0ZXN0VmFsdWUgPSBEYXRlLm5vdygpLnRvU3RyaW5nKCk7XG4gICAgICAgIFxuICAgICAgICB0aGlzLmluTWVtb3J5Q2FjaGUuc2V0KHRlc3RLZXksIHRlc3RWYWx1ZSwgMTAwMCk7IC8vIDEgc2Vjb25kIFRUTFxuICAgICAgICBjb25zdCByZXRyaWV2ZWQgPSB0aGlzLmluTWVtb3J5Q2FjaGUuZ2V0KHRlc3RLZXkpO1xuICAgICAgICBcbiAgICAgICAgaWYgKHJldHJpZXZlZCAhPT0gdGVzdFZhbHVlKSB7XG4gICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdJbi1tZW1vcnkgY2FjaGUgaGVhbHRoIGNoZWNrIGZhaWxlZCcpO1xuICAgICAgICB9XG4gICAgICAgIFxuICAgICAgICB0aGlzLmluTWVtb3J5Q2FjaGUuZGVsZXRlKHRlc3RLZXkpO1xuICAgICAgICB0aGlzLm1ldHJpY3MubGFzdEhlYWx0aENoZWNrID0gRGF0ZS5ub3coKTtcbiAgICAgICAgXG4gICAgICAgIHRoaXMuZW1pdCgnaGVhbHRoOmNoZWNrOnN1Y2Nlc3MnLCB7IFxuICAgICAgICAgIHNvdXJjZTogJ21lbW9yeScsXG4gICAgICAgICAgZHVyYXRpb246IERhdGUubm93KCkgLSBzdGFydFRpbWUgXG4gICAgICAgIH0pO1xuICAgICAgfVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLm1ldHJpY3MubGFzdEhlYWx0aENoZWNrID0gRGF0ZS5ub3coKTtcbiAgICAgIHRoaXMuZW1pdCgnaGVhbHRoOmNoZWNrOmZhaWx1cmUnLCB7IFxuICAgICAgICBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcicsXG4gICAgICAgIGR1cmF0aW9uOiBEYXRlLm5vdygpIC0gc3RhcnRUaW1lXG4gICAgICB9KTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IGEgdmFsdWUgZnJvbSBjYWNoZVxuICAgKi9cbiAgYXN5bmMgZ2V0PFQgPSBhbnk+KGtleTogc3RyaW5nKTogUHJvbWlzZTxDYWNoZVJlc3VsdDxUPj4ge1xuICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgdGhpcy5tZXRyaWNzLnRvdGFsT3BlcmF0aW9ucysrO1xuXG4gICAgLy8gVHJ5IFJlZGlzIGZpcnN0IGlmIGF2YWlsYWJsZVxuICAgIGlmICh0aGlzLnJlZGlzQ2xpZW50ICYmIHRoaXMubWV0cmljcy5yZWRpc0Nvbm5lY3RlZCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY29uc3QgdmFsdWUgPSBhd2FpdCB0aGlzLnJlZGlzQ2xpZW50LmdldChrZXkpO1xuICAgICAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG4gICAgICAgIHRoaXMudXBkYXRlUmVzcG9uc2VUaW1lTWV0cmljcyhkdXJhdGlvbik7XG5cbiAgICAgICAgaWYgKHZhbHVlICE9PSBudWxsKSB7XG4gICAgICAgICAgdGhpcy5tZXRyaWNzLnJlZGlzSGl0cysrO1xuICAgICAgICAgIHRoaXMuZW1pdCgnY2FjaGU6aGl0JywgeyBzb3VyY2U6ICdyZWRpcycsIGtleSwgZHVyYXRpb24gfSk7XG4gICAgICAgICAgXG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IHRydWUsXG4gICAgICAgICAgICB2YWx1ZTogSlNPTi5wYXJzZSh2YWx1ZSksXG4gICAgICAgICAgICBzb3VyY2U6ICdyZWRpcycsXG4gICAgICAgICAgICBkdXJhdGlvblxuICAgICAgICAgIH07XG4gICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgdGhpcy5tZXRyaWNzLnJlZGlzTWlzc2VzKys7XG4gICAgICAgICAgdGhpcy5lbWl0KCdjYWNoZTptaXNzJywgeyBzb3VyY2U6ICdyZWRpcycsIGtleSwgZHVyYXRpb24gfSk7XG4gICAgICAgICAgXG4gICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgICAgICAgc291cmNlOiAncmVkaXMnLFxuICAgICAgICAgICAgZHVyYXRpb25cbiAgICAgICAgICB9O1xuICAgICAgICB9XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICB0aGlzLm1ldHJpY3MucmVkaXNFcnJvcnMrKztcbiAgICAgICAgdGhpcy5lbWl0KCdjYWNoZTplcnJvcicsIHsgXG4gICAgICAgICAgc291cmNlOiAncmVkaXMnLCBcbiAgICAgICAgICBrZXksIFxuICAgICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyBcbiAgICAgICAgfSk7XG4gICAgICAgIFxuICAgICAgICAvLyBGYWxsIHRocm91Z2ggdG8gaW4tbWVtb3J5IGNhY2hlXG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gVXNlIGluLW1lbW9yeSBjYWNoZSBhcyBmYWxsYmFja1xuICAgIGlmICh0aGlzLmNvbmZpZy5lbmFibGVJbk1lbW9yeUZhbGxiYWNrKSB7XG4gICAgICBjb25zdCB2YWx1ZSA9IHRoaXMuaW5NZW1vcnlDYWNoZS5nZXQ8VD4oa2V5KTtcbiAgICAgIGNvbnN0IGR1cmF0aW9uID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcbiAgICAgIHRoaXMudXBkYXRlUmVzcG9uc2VUaW1lTWV0cmljcyhkdXJhdGlvbik7XG5cbiAgICAgIGlmICh2YWx1ZSAhPT0gdW5kZWZpbmVkKSB7XG4gICAgICAgIHRoaXMubWV0cmljcy5tZW1vcnlIaXRzKys7XG4gICAgICAgIHRoaXMuZW1pdCgnY2FjaGU6aGl0JywgeyBzb3VyY2U6ICdtZW1vcnknLCBrZXksIGR1cmF0aW9uIH0pO1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgIHZhbHVlLFxuICAgICAgICAgIHNvdXJjZTogJ21lbW9yeScsXG4gICAgICAgICAgZHVyYXRpb25cbiAgICAgICAgfTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRoaXMubWV0cmljcy5tZW1vcnlNaXNzZXMrKztcbiAgICAgICAgdGhpcy5lbWl0KCdjYWNoZTptaXNzJywgeyBzb3VyY2U6ICdtZW1vcnknLCBrZXksIGR1cmF0aW9uIH0pO1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdWNjZXNzOiBmYWxzZSxcbiAgICAgICAgICBzb3VyY2U6ICdtZW1vcnknLFxuICAgICAgICAgIGR1cmF0aW9uXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gTm8gY2FjaGUgYXZhaWxhYmxlXG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgc291cmNlOiAnbm9uZScsXG4gICAgICBkdXJhdGlvbjogRGF0ZS5ub3coKSAtIHN0YXJ0VGltZVxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogU2V0IGEgdmFsdWUgaW4gY2FjaGVcbiAgICovXG4gIGFzeW5jIHNldDxUID0gYW55PihrZXk6IHN0cmluZywgdmFsdWU6IFQsIHR0bFNlY29uZHM/OiBudW1iZXIpOiBQcm9taXNlPENhY2hlUmVzdWx0PHZvaWQ+PiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICB0aGlzLm1ldHJpY3MudG90YWxPcGVyYXRpb25zKys7XG5cbiAgICAvLyBUcnkgUmVkaXMgZmlyc3QgaWYgYXZhaWxhYmxlXG4gICAgaWYgKHRoaXMucmVkaXNDbGllbnQgJiYgdGhpcy5tZXRyaWNzLnJlZGlzQ29ubmVjdGVkKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBzZXJpYWxpemVkVmFsdWUgPSBKU09OLnN0cmluZ2lmeSh2YWx1ZSk7XG4gICAgICAgIFxuICAgICAgICBpZiAodHRsU2Vjb25kcykge1xuICAgICAgICAgIGF3YWl0IHRoaXMucmVkaXNDbGllbnQuc2V0RXgoa2V5LCB0dGxTZWNvbmRzLCBzZXJpYWxpemVkVmFsdWUpO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGF3YWl0IHRoaXMucmVkaXNDbGllbnQuc2V0KGtleSwgc2VyaWFsaXplZFZhbHVlKTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgY29uc3QgZHVyYXRpb24gPSBEYXRlLm5vdygpIC0gc3RhcnRUaW1lO1xuICAgICAgICB0aGlzLnVwZGF0ZVJlc3BvbnNlVGltZU1ldHJpY3MoZHVyYXRpb24pO1xuICAgICAgICB0aGlzLmVtaXQoJ2NhY2hlOnNldCcsIHsgc291cmNlOiAncmVkaXMnLCBrZXksIGR1cmF0aW9uIH0pO1xuICAgICAgICBcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBzdWNjZXNzOiB0cnVlLFxuICAgICAgICAgIHNvdXJjZTogJ3JlZGlzJyxcbiAgICAgICAgICBkdXJhdGlvblxuICAgICAgICB9O1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgdGhpcy5tZXRyaWNzLnJlZGlzRXJyb3JzKys7XG4gICAgICAgIHRoaXMuZW1pdCgnY2FjaGU6ZXJyb3InLCB7IFxuICAgICAgICAgIHNvdXJjZTogJ3JlZGlzJywgXG4gICAgICAgICAga2V5LCBcbiAgICAgICAgICBlcnJvcjogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcicgXG4gICAgICAgIH0pO1xuICAgICAgICBcbiAgICAgICAgLy8gRmFsbCB0aHJvdWdoIHRvIGluLW1lbW9yeSBjYWNoZVxuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFVzZSBpbi1tZW1vcnkgY2FjaGUgYXMgZmFsbGJhY2tcbiAgICBpZiAodGhpcy5jb25maWcuZW5hYmxlSW5NZW1vcnlGYWxsYmFjaykge1xuICAgICAgY29uc3QgdHRsTXMgPSB0dGxTZWNvbmRzID8gdHRsU2Vjb25kcyAqIDEwMDAgOiB0aGlzLmNvbmZpZy5pbk1lbW9yeVR0bE1zO1xuICAgICAgdGhpcy5pbk1lbW9yeUNhY2hlLnNldChrZXksIHZhbHVlLCB0dGxNcyk7XG4gICAgICBcbiAgICAgIGNvbnN0IGR1cmF0aW9uID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcbiAgICAgIHRoaXMudXBkYXRlUmVzcG9uc2VUaW1lTWV0cmljcyhkdXJhdGlvbik7XG4gICAgICB0aGlzLmVtaXQoJ2NhY2hlOnNldCcsIHsgc291cmNlOiAnbWVtb3J5Jywga2V5LCBkdXJhdGlvbiB9KTtcbiAgICAgIFxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgc3VjY2VzczogdHJ1ZSxcbiAgICAgICAgc291cmNlOiAnbWVtb3J5JyxcbiAgICAgICAgZHVyYXRpb25cbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gTm8gY2FjaGUgYXZhaWxhYmxlXG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IGZhbHNlLFxuICAgICAgc291cmNlOiAnbm9uZScsXG4gICAgICBkdXJhdGlvbjogRGF0ZS5ub3coKSAtIHN0YXJ0VGltZSxcbiAgICAgIGVycm9yOiAnTm8gY2FjaGUgYmFja2VuZCBhdmFpbGFibGUnXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBEZWxldGUgYSB2YWx1ZSBmcm9tIGNhY2hlXG4gICAqL1xuICBhc3luYyBkZWxldGUoa2V5OiBzdHJpbmcpOiBQcm9taXNlPENhY2hlUmVzdWx0PHZvaWQ+PiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICB0aGlzLm1ldHJpY3MudG90YWxPcGVyYXRpb25zKys7XG5cbiAgICBsZXQgcmVkaXNTdWNjZXNzID0gZmFsc2U7XG4gICAgbGV0IG1lbW9yeVN1Y2Nlc3MgPSBmYWxzZTtcblxuICAgIC8vIFRyeSBSZWRpcyBmaXJzdCBpZiBhdmFpbGFibGVcbiAgICBpZiAodGhpcy5yZWRpc0NsaWVudCAmJiB0aGlzLm1ldHJpY3MucmVkaXNDb25uZWN0ZWQpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGF3YWl0IHRoaXMucmVkaXNDbGllbnQuZGVsKGtleSk7XG4gICAgICAgIHJlZGlzU3VjY2VzcyA9IHRydWU7XG4gICAgICAgIHRoaXMuZW1pdCgnY2FjaGU6ZGVsZXRlJywgeyBzb3VyY2U6ICdyZWRpcycsIGtleSB9KTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHRoaXMubWV0cmljcy5yZWRpc0Vycm9ycysrO1xuICAgICAgICB0aGlzLmVtaXQoJ2NhY2hlOmVycm9yJywgeyBcbiAgICAgICAgICBzb3VyY2U6ICdyZWRpcycsIFxuICAgICAgICAgIGtleSwgXG4gICAgICAgICAgZXJyb3I6IGVycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InIFxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBBbHNvIGRlbGV0ZSBmcm9tIGluLW1lbW9yeSBjYWNoZVxuICAgIGlmICh0aGlzLmNvbmZpZy5lbmFibGVJbk1lbW9yeUZhbGxiYWNrKSB7XG4gICAgICBtZW1vcnlTdWNjZXNzID0gdGhpcy5pbk1lbW9yeUNhY2hlLmRlbGV0ZShrZXkpO1xuICAgICAgaWYgKG1lbW9yeVN1Y2Nlc3MpIHtcbiAgICAgICAgdGhpcy5lbWl0KCdjYWNoZTpkZWxldGUnLCB7IHNvdXJjZTogJ21lbW9yeScsIGtleSB9KTtcbiAgICAgIH1cbiAgICB9XG5cbiAgICBjb25zdCBkdXJhdGlvbiA9IERhdGUubm93KCkgLSBzdGFydFRpbWU7XG4gICAgdGhpcy51cGRhdGVSZXNwb25zZVRpbWVNZXRyaWNzKGR1cmF0aW9uKTtcblxuICAgIHJldHVybiB7XG4gICAgICBzdWNjZXNzOiByZWRpc1N1Y2Nlc3MgfHwgbWVtb3J5U3VjY2VzcyxcbiAgICAgIHNvdXJjZTogcmVkaXNTdWNjZXNzID8gJ3JlZGlzJyA6IChtZW1vcnlTdWNjZXNzID8gJ21lbW9yeScgOiAnbm9uZScpLFxuICAgICAgZHVyYXRpb25cbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENsZWFyIGFsbCBjYWNoZSBlbnRyaWVzXG4gICAqL1xuICBhc3luYyBjbGVhcigpOiBQcm9taXNlPENhY2hlUmVzdWx0PHZvaWQ+PiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICB0aGlzLm1ldHJpY3MudG90YWxPcGVyYXRpb25zKys7XG5cbiAgICBsZXQgcmVkaXNTdWNjZXNzID0gZmFsc2U7XG4gICAgbGV0IG1lbW9yeVN1Y2Nlc3MgPSBmYWxzZTtcblxuICAgIC8vIENsZWFyIFJlZGlzIGlmIGF2YWlsYWJsZVxuICAgIGlmICh0aGlzLnJlZGlzQ2xpZW50ICYmIHRoaXMubWV0cmljcy5yZWRpc0Nvbm5lY3RlZCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5yZWRpc0NsaWVudC5mbHVzaERiKCk7XG4gICAgICAgIHJlZGlzU3VjY2VzcyA9IHRydWU7XG4gICAgICAgIHRoaXMuZW1pdCgnY2FjaGU6Y2xlYXInLCB7IHNvdXJjZTogJ3JlZGlzJyB9KTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIHRoaXMubWV0cmljcy5yZWRpc0Vycm9ycysrO1xuICAgICAgICB0aGlzLmVtaXQoJ2NhY2hlOmVycm9yJywgeyBcbiAgICAgICAgICBzb3VyY2U6ICdyZWRpcycsIFxuICAgICAgICAgIGVycm9yOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJyBcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgLy8gQ2xlYXIgaW4tbWVtb3J5IGNhY2hlXG4gICAgaWYgKHRoaXMuY29uZmlnLmVuYWJsZUluTWVtb3J5RmFsbGJhY2spIHtcbiAgICAgIHRoaXMuaW5NZW1vcnlDYWNoZS5jbGVhcigpO1xuICAgICAgbWVtb3J5U3VjY2VzcyA9IHRydWU7XG4gICAgICB0aGlzLmVtaXQoJ2NhY2hlOmNsZWFyJywgeyBzb3VyY2U6ICdtZW1vcnknIH0pO1xuICAgIH1cblxuICAgIGNvbnN0IGR1cmF0aW9uID0gRGF0ZS5ub3coKSAtIHN0YXJ0VGltZTtcbiAgICB0aGlzLnVwZGF0ZVJlc3BvbnNlVGltZU1ldHJpY3MoZHVyYXRpb24pO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHN1Y2Nlc3M6IHJlZGlzU3VjY2VzcyB8fCBtZW1vcnlTdWNjZXNzLFxuICAgICAgc291cmNlOiByZWRpc1N1Y2Nlc3MgPyAncmVkaXMnIDogKG1lbW9yeVN1Y2Nlc3MgPyAnbWVtb3J5JyA6ICdub25lJyksXG4gICAgICBkdXJhdGlvblxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIHJlc3BvbnNlIHRpbWUgbWV0cmljc1xuICAgKi9cbiAgcHJpdmF0ZSB1cGRhdGVSZXNwb25zZVRpbWVNZXRyaWNzKGR1cmF0aW9uOiBudW1iZXIpOiB2b2lkIHtcbiAgICB0aGlzLnJlc3BvbnNlVGltZUhpc3RvcnkucHVzaChkdXJhdGlvbik7XG4gICAgXG4gICAgLy8gS2VlcCBvbmx5IGxhc3QgMTAwIG9wZXJhdGlvbnMgZm9yIGF2ZXJhZ2UgY2FsY3VsYXRpb25cbiAgICBpZiAodGhpcy5yZXNwb25zZVRpbWVIaXN0b3J5Lmxlbmd0aCA+IDEwMCkge1xuICAgICAgdGhpcy5yZXNwb25zZVRpbWVIaXN0b3J5LnNoaWZ0KCk7XG4gICAgfVxuICAgIFxuICAgIC8vIENhbGN1bGF0ZSBhdmVyYWdlIHJlc3BvbnNlIHRpbWVcbiAgICB0aGlzLm1ldHJpY3MuYXZlcmFnZVJlc3BvbnNlVGltZSA9IHRoaXMucmVzcG9uc2VUaW1lSGlzdG9yeS5yZWR1Y2UoKHN1bSwgdGltZSkgPT4gc3VtICsgdGltZSwgMCkgLyB0aGlzLnJlc3BvbnNlVGltZUhpc3RvcnkubGVuZ3RoO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBjdXJyZW50IGNhY2hlIG1ldHJpY3NcbiAgICovXG4gIGdldE1ldHJpY3MoKTogQ2FjaGVNZXRyaWNzIHtcbiAgICByZXR1cm4geyAuLi50aGlzLm1ldHJpY3MgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBjYWNoZSBpcyBoZWFsdGh5XG4gICAqL1xuICBpc0hlYWx0aHkoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMubWV0cmljcy5yZWRpc0Nvbm5lY3RlZCB8fCB0aGlzLm1ldHJpY3MuZmFsbGJhY2tBY3RpdmU7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGNhY2hlIHN0YXR1c1xuICAgKi9cbiAgZ2V0U3RhdHVzKCk6IHtcbiAgICByZWRpc0Nvbm5lY3RlZDogYm9vbGVhbjtcbiAgICBmYWxsYmFja0FjdGl2ZTogYm9vbGVhbjtcbiAgICB0b3RhbE9wZXJhdGlvbnM6IG51bWJlcjtcbiAgICBoaXRSYXRlOiBudW1iZXI7XG4gICAgYXZlcmFnZVJlc3BvbnNlVGltZTogbnVtYmVyO1xuICB9IHtcbiAgICBjb25zdCB0b3RhbEhpdHMgPSB0aGlzLm1ldHJpY3MucmVkaXNIaXRzICsgdGhpcy5tZXRyaWNzLm1lbW9yeUhpdHM7XG4gICAgY29uc3QgdG90YWxNaXNzZXMgPSB0aGlzLm1ldHJpY3MucmVkaXNNaXNzZXMgKyB0aGlzLm1ldHJpY3MubWVtb3J5TWlzc2VzO1xuICAgIGNvbnN0IGhpdFJhdGUgPSB0b3RhbEhpdHMgKyB0b3RhbE1pc3NlcyA+IDAgPyAodG90YWxIaXRzIC8gKHRvdGFsSGl0cyArIHRvdGFsTWlzc2VzKSkgKiAxMDAgOiAwO1xuXG4gICAgcmV0dXJuIHtcbiAgICAgIHJlZGlzQ29ubmVjdGVkOiB0aGlzLm1ldHJpY3MucmVkaXNDb25uZWN0ZWQsXG4gICAgICBmYWxsYmFja0FjdGl2ZTogdGhpcy5tZXRyaWNzLmZhbGxiYWNrQWN0aXZlLFxuICAgICAgdG90YWxPcGVyYXRpb25zOiB0aGlzLm1ldHJpY3MudG90YWxPcGVyYXRpb25zLFxuICAgICAgaGl0UmF0ZSxcbiAgICAgIGF2ZXJhZ2VSZXNwb25zZVRpbWU6IHRoaXMubWV0cmljcy5hdmVyYWdlUmVzcG9uc2VUaW1lXG4gICAgfTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHcmFjZWZ1bGx5IHNodXRkb3duIHRoZSBjYWNoZSBtYW5hZ2VyXG4gICAqL1xuICBhc3luYyBzaHV0ZG93bigpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICB0aGlzLmlzU2h1dHRpbmdEb3duID0gdHJ1ZTtcblxuICAgIC8vIFN0b3AgaGVhbHRoIGNoZWNrIG1vbml0b3JpbmdcbiAgICBpZiAodGhpcy5oZWFsdGhDaGVja0ludGVydmFsKSB7XG4gICAgICBjbGVhckludGVydmFsKHRoaXMuaGVhbHRoQ2hlY2tJbnRlcnZhbCk7XG4gICAgICB0aGlzLmhlYWx0aENoZWNrSW50ZXJ2YWwgPSBudWxsO1xuICAgIH1cblxuICAgIC8vIERpc2Nvbm5lY3QgUmVkaXNcbiAgICBpZiAodGhpcy5yZWRpc0NsaWVudCkge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5yZWRpc0NsaWVudC5kaXNjb25uZWN0KCk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICBjb25zb2xlLndhcm4oJ0Vycm9yIGRpc2Nvbm5lY3RpbmcgUmVkaXM6JywgZXJyb3IpO1xuICAgICAgfVxuICAgICAgdGhpcy5yZWRpc0NsaWVudCA9IG51bGw7XG4gICAgfVxuXG4gICAgLy8gQ2xlYXIgaW4tbWVtb3J5IGNhY2hlXG4gICAgdGhpcy5pbk1lbW9yeUNhY2hlLmNsZWFyKCk7XG5cbiAgICB0aGlzLmVtaXQoJ3NodXRkb3duJyk7XG4gIH1cbn0iXSwidmVyc2lvbiI6M30=
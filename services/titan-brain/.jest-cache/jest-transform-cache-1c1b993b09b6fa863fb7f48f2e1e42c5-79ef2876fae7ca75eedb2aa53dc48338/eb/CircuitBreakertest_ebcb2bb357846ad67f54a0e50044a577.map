{"file":"/Users/ivan/Code/trading/titan/services/titan-brain/tests/unit/CircuitBreaker.test.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-brain/tests/unit/CircuitBreaker.test.ts"],"sourcesContent":["/**\n * Unit Tests for CircuitBreaker\n * \n * Tests daily drawdown trigger, minimum equity trigger, consecutive loss trigger,\n * soft pause cooldown, and manual reset with operator logging.\n * Requirements: 5.1, 5.2, 5.3, 5.4, 5.5, 5.8\n */\n\nimport {\n  CircuitBreaker,\n  PositionClosureHandler,\n  NotificationHandler,\n  BreakerEventPersistence,\n} from '../../src/engine/CircuitBreaker.js';\nimport {\n  BreakerType,\n  BreakerCheckInput,\n  BreakerEvent,\n  CircuitBreakerConfig,\n  Position,\n} from '../../src/types/index.js';\nimport { defaultConfig } from '../../src/config/defaults.js';\n\ndescribe('CircuitBreaker', () => {\n  let circuitBreaker: CircuitBreaker;\n  let mockPositionHandler: jest.Mocked<PositionClosureHandler>;\n  let mockNotificationHandler: jest.Mocked<NotificationHandler>;\n  let mockEventPersistence: jest.Mocked<BreakerEventPersistence>;\n\n  const defaultBreakerConfig: CircuitBreakerConfig = {\n    maxDailyDrawdown: 0.15, // 15%\n    minEquity: 150, // $150\n    consecutiveLossLimit: 3,\n    consecutiveLossWindow: 3600000, // 1 hour\n    cooldownMinutes: 30,\n  };\n\n  beforeEach(() => {\n    circuitBreaker = new CircuitBreaker(defaultBreakerConfig);\n    \n    mockPositionHandler = {\n      closeAllPositions: jest.fn().mockResolvedValue(undefined),\n    };\n    \n    mockNotificationHandler = {\n      sendEmergencyNotification: jest.fn().mockResolvedValue(undefined),\n    };\n    \n    mockEventPersistence = {\n      persistEvent: jest.fn().mockResolvedValue(undefined),\n    };\n    \n    circuitBreaker.setPositionHandler(mockPositionHandler);\n    circuitBreaker.setNotificationHandler(mockNotificationHandler);\n    circuitBreaker.setEventPersistence(mockEventPersistence);\n  });\n\n  describe('constructor', () => {\n    it('should initialize with provided configuration', () => {\n      const config = circuitBreaker.getConfig();\n      expect(config.maxDailyDrawdown).toBe(0.15);\n      expect(config.minEquity).toBe(150);\n      expect(config.consecutiveLossLimit).toBe(3);\n      expect(config.cooldownMinutes).toBe(30);\n    });\n\n    it('should start in inactive state', () => {\n      expect(circuitBreaker.isActive()).toBe(false);\n    });\n  });\n\n  describe('setDailyStartEquity / getDailyStartEquity', () => {\n    it('should set and get daily start equity correctly', () => {\n      circuitBreaker.setDailyStartEquity(1000);\n      expect(circuitBreaker.getDailyStartEquity()).toBe(1000);\n    });\n\n    it('should handle negative equity as 0', () => {\n      circuitBreaker.setDailyStartEquity(-500);\n      expect(circuitBreaker.getDailyStartEquity()).toBe(0);\n    });\n  });\n\n  describe('checkConditions - Daily Drawdown (Requirement 5.1)', () => {\n    it('should trigger HARD breaker when daily drawdown exceeds 15%', () => {\n      const input: BreakerCheckInput = {\n        equity: 850, // 15% drawdown from 1000\n        positions: [],\n        dailyStartEquity: 1000,\n        recentTrades: [],\n      };\n\n      const status = circuitBreaker.checkConditions(input);\n      \n      expect(status.active).toBe(true);\n      expect(status.type).toBe(BreakerType.HARD);\n      expect(status.reason).toContain('Daily drawdown exceeded');\n    });\n\n    it('should not trigger when drawdown is below threshold', () => {\n      const input: BreakerCheckInput = {\n        equity: 900, // 10% drawdown\n        positions: [],\n        dailyStartEquity: 1000,\n        recentTrades: [],\n      };\n\n      const status = circuitBreaker.checkConditions(input);\n      \n      expect(status.active).toBe(false);\n    });\n\n    it('should calculate drawdown correctly at boundary', () => {\n      const input: BreakerCheckInput = {\n        equity: 851, // Just under 15% drawdown (14.9%)\n        positions: [],\n        dailyStartEquity: 1000,\n        recentTrades: [],\n      };\n\n      const status = circuitBreaker.checkConditions(input);\n      \n      expect(status.active).toBe(false);\n      expect(status.dailyDrawdown).toBeCloseTo(0.149, 2);\n    });\n  });\n\n  describe('checkConditions - Minimum Equity (Requirement 5.2)', () => {\n    it('should trigger HARD breaker when equity drops below minimum', () => {\n      // Use dailyStartEquity close to equity to avoid drawdown trigger\n      const input: BreakerCheckInput = {\n        equity: 140, // Below $150 minimum\n        positions: [],\n        dailyStartEquity: 145, // Small drawdown, won't trigger 15% threshold\n        recentTrades: [],\n      };\n\n      const status = circuitBreaker.checkConditions(input);\n      \n      expect(status.active).toBe(true);\n      expect(status.type).toBe(BreakerType.HARD);\n      expect(status.reason).toContain('Equity below minimum');\n    });\n\n    it('should not trigger when equity is at minimum', () => {\n      // Use dailyStartEquity close to equity to avoid drawdown trigger\n      const input: BreakerCheckInput = {\n        equity: 150, // Exactly at minimum\n        positions: [],\n        dailyStartEquity: 155, // Small drawdown, won't trigger 15% threshold\n        recentTrades: [],\n      };\n\n      const status = circuitBreaker.checkConditions(input);\n      \n      expect(status.active).toBe(false);\n    });\n  });\n\n  describe('checkConditions - Consecutive Losses (Requirement 5.3)', () => {\n    it('should trigger SOFT breaker for 3 consecutive losses within 1 hour', () => {\n      const now = Date.now();\n      const input: BreakerCheckInput = {\n        equity: 900,\n        positions: [],\n        dailyStartEquity: 1000,\n        recentTrades: [\n          { pnl: -50, timestamp: now - 30000 },\n          { pnl: -30, timestamp: now - 20000 },\n          { pnl: -20, timestamp: now - 10000 },\n        ],\n      };\n\n      const status = circuitBreaker.checkConditions(input);\n      \n      expect(status.active).toBe(true);\n      expect(status.type).toBe(BreakerType.SOFT);\n      expect(status.reason).toContain('consecutive losses');\n      expect(status.cooldownEndsAt).toBeDefined();\n    });\n\n    it('should not trigger for losses outside the time window', () => {\n      const now = Date.now();\n      const input: BreakerCheckInput = {\n        equity: 900,\n        positions: [],\n        dailyStartEquity: 1000,\n        recentTrades: [\n          { pnl: -50, timestamp: now - 4000000 }, // Outside 1 hour window\n          { pnl: -30, timestamp: now - 3900000 },\n          { pnl: -20, timestamp: now - 3800000 },\n        ],\n      };\n\n      const status = circuitBreaker.checkConditions(input);\n      \n      expect(status.active).toBe(false);\n    });\n\n    it('should not trigger when profitable trade breaks the streak', () => {\n      const now = Date.now();\n      const input: BreakerCheckInput = {\n        equity: 900,\n        positions: [],\n        dailyStartEquity: 1000,\n        recentTrades: [\n          { pnl: -50, timestamp: now - 40000 },\n          { pnl: 10, timestamp: now - 30000 }, // Profitable trade breaks streak\n          { pnl: -30, timestamp: now - 20000 },\n          { pnl: -20, timestamp: now - 10000 },\n        ],\n      };\n\n      const status = circuitBreaker.checkConditions(input);\n      \n      expect(status.active).toBe(false);\n      expect(status.consecutiveLosses).toBe(2);\n    });\n  });\n\n  describe('trigger - Position Closure (Requirement 5.4)', () => {\n    it('should close all positions when triggered', async () => {\n      await circuitBreaker.trigger('Test trigger');\n      \n      expect(mockPositionHandler.closeAllPositions).toHaveBeenCalledTimes(1);\n    });\n\n    it('should continue even if position closure fails', async () => {\n      mockPositionHandler.closeAllPositions.mockRejectedValue(new Error('API error'));\n      \n      await circuitBreaker.trigger('Test trigger');\n      \n      expect(circuitBreaker.isActive()).toBe(true);\n    });\n  });\n\n  describe('trigger - Signal Rejection (Requirement 5.5)', () => {\n    it('should be active after trigger', async () => {\n      await circuitBreaker.trigger('Test trigger');\n      \n      expect(circuitBreaker.isActive()).toBe(true);\n    });\n\n    it('should remain active until manual reset', async () => {\n      await circuitBreaker.trigger('Test trigger');\n      \n      // Check multiple times\n      expect(circuitBreaker.isActive()).toBe(true);\n      expect(circuitBreaker.isActive()).toBe(true);\n      \n      // Still active\n      const status = circuitBreaker.getStatus();\n      expect(status.active).toBe(true);\n    });\n  });\n\n  describe('trigger - Idempotence (Requirement 5.4)', () => {\n    it('should not create duplicate events when triggered multiple times', async () => {\n      await circuitBreaker.trigger('First trigger');\n      await circuitBreaker.trigger('Second trigger');\n      await circuitBreaker.trigger('Third trigger');\n      \n      // Should only persist one event\n      expect(mockEventPersistence.persistEvent).toHaveBeenCalledTimes(1);\n      \n      // Should only close positions once\n      expect(mockPositionHandler.closeAllPositions).toHaveBeenCalledTimes(1);\n    });\n\n    it('should maintain original trigger reason', async () => {\n      await circuitBreaker.trigger('First trigger');\n      await circuitBreaker.trigger('Second trigger');\n      \n      const status = circuitBreaker.getStatus();\n      expect(status.reason).toBe('First trigger');\n    });\n  });\n\n  describe('trigger - Notifications (Requirement 5.6)', () => {\n    it('should send emergency notification when triggered', async () => {\n      circuitBreaker.setDailyStartEquity(1000);\n      await circuitBreaker.trigger('Emergency test');\n      \n      expect(mockNotificationHandler.sendEmergencyNotification).toHaveBeenCalledWith(\n        'Emergency test',\n        1000\n      );\n    });\n\n    it('should continue even if notification fails', async () => {\n      mockNotificationHandler.sendEmergencyNotification.mockRejectedValue(new Error('Network error'));\n      \n      await circuitBreaker.trigger('Test trigger');\n      \n      expect(circuitBreaker.isActive()).toBe(true);\n    });\n  });\n\n  describe('trigger - Event Logging (Requirement 5.7)', () => {\n    it('should log trigger event with full context', async () => {\n      circuitBreaker.setDailyStartEquity(1000);\n      await circuitBreaker.trigger('Drawdown exceeded');\n      \n      expect(mockEventPersistence.persistEvent).toHaveBeenCalledWith(\n        expect.objectContaining({\n          eventType: 'TRIGGER',\n          breakerType: BreakerType.HARD,\n          reason: 'Drawdown exceeded',\n          equity: 1000,\n        })\n      );\n    });\n  });\n\n  describe('reset - Manual Reset (Requirement 5.8)', () => {\n    it('should require operator ID for reset', async () => {\n      await circuitBreaker.trigger('Test trigger');\n      \n      await expect(circuitBreaker.reset('')).rejects.toThrow('Operator ID is required');\n    });\n\n    it('should log operator identity on reset', async () => {\n      await circuitBreaker.trigger('Test trigger');\n      mockEventPersistence.persistEvent.mockClear();\n      \n      await circuitBreaker.reset('operator-123');\n      \n      expect(mockEventPersistence.persistEvent).toHaveBeenCalledWith(\n        expect.objectContaining({\n          eventType: 'RESET',\n          operatorId: 'operator-123',\n          reason: expect.stringContaining('operator-123'),\n        })\n      );\n    });\n\n    it('should deactivate breaker after reset', async () => {\n      await circuitBreaker.trigger('Test trigger');\n      expect(circuitBreaker.isActive()).toBe(true);\n      \n      await circuitBreaker.reset('operator-123');\n      expect(circuitBreaker.isActive()).toBe(false);\n    });\n\n    it('should clear all trigger state on reset', async () => {\n      await circuitBreaker.trigger('Test trigger');\n      await circuitBreaker.reset('operator-123');\n      \n      const status = circuitBreaker.getStatus();\n      expect(status.active).toBe(false);\n      expect(status.type).toBeUndefined();\n      expect(status.reason).toBeUndefined();\n      expect(status.triggeredAt).toBeUndefined();\n    });\n\n    it('should do nothing if not active', async () => {\n      await circuitBreaker.reset('operator-123');\n      \n      expect(mockEventPersistence.persistEvent).not.toHaveBeenCalled();\n    });\n  });\n\n  describe('soft pause cooldown', () => {\n    it('should auto-reset after cooldown period', async () => {\n      // Create breaker with very short cooldown for testing\n      const shortCooldownConfig: CircuitBreakerConfig = {\n        ...defaultBreakerConfig,\n        cooldownMinutes: 0.001, // ~60ms\n      };\n      const breaker = new CircuitBreaker(shortCooldownConfig);\n      \n      const now = Date.now();\n      const input: BreakerCheckInput = {\n        equity: 900,\n        positions: [],\n        dailyStartEquity: 1000,\n        recentTrades: [\n          { pnl: -50, timestamp: now - 30000 },\n          { pnl: -30, timestamp: now - 20000 },\n          { pnl: -20, timestamp: now - 10000 },\n        ],\n      };\n\n      breaker.checkConditions(input);\n      expect(breaker.isActive()).toBe(true);\n      \n      // Wait for cooldown\n      await new Promise(resolve => setTimeout(resolve, 100));\n      \n      expect(breaker.isActive()).toBe(false);\n    });\n\n    it('should not auto-reset HARD breaker', async () => {\n      const shortCooldownConfig: CircuitBreakerConfig = {\n        ...defaultBreakerConfig,\n        cooldownMinutes: 0.001,\n      };\n      const breaker = new CircuitBreaker(shortCooldownConfig);\n      \n      await breaker.trigger('Hard trigger');\n      \n      // Wait for what would be cooldown\n      await new Promise(resolve => setTimeout(resolve, 100));\n      \n      // Should still be active\n      expect(breaker.isActive()).toBe(true);\n    });\n  });\n\n  describe('getStatus', () => {\n    it('should return complete status when inactive', () => {\n      circuitBreaker.setDailyStartEquity(1000);\n      \n      const status = circuitBreaker.getStatus();\n      \n      expect(status.active).toBe(false);\n      expect(status.type).toBeUndefined();\n      expect(status.reason).toBeUndefined();\n      expect(status.triggeredAt).toBeUndefined();\n      expect(status.dailyDrawdown).toBe(0);\n      expect(status.equityLevel).toBe(1000);\n    });\n\n    it('should return complete status when active', async () => {\n      circuitBreaker.setDailyStartEquity(1000);\n      await circuitBreaker.trigger('Test reason');\n      \n      const status = circuitBreaker.getStatus();\n      \n      expect(status.active).toBe(true);\n      expect(status.type).toBe(BreakerType.HARD);\n      expect(status.reason).toBe('Test reason');\n      expect(status.triggeredAt).toBeDefined();\n    });\n  });\n\n  describe('recordTrade', () => {\n    it('should track trades for consecutive loss detection', () => {\n      const now = Date.now();\n      \n      circuitBreaker.recordTrade(-50, now - 30000);\n      circuitBreaker.recordTrade(-30, now - 20000);\n      circuitBreaker.recordTrade(-20, now - 10000);\n      \n      const input: BreakerCheckInput = {\n        equity: 900,\n        positions: [],\n        dailyStartEquity: 1000,\n        recentTrades: [],\n      };\n      \n      // The internal tracking should have recorded the losses\n      // but checkConditions uses the provided recentTrades\n      const status = circuitBreaker.checkConditions(input);\n      expect(status.consecutiveLosses).toBe(0); // Uses input, not internal\n    });\n\n    it('should reset consecutive losses on profitable trade', () => {\n      const now = Date.now();\n      \n      circuitBreaker.recordTrade(-50, now - 40000);\n      circuitBreaker.recordTrade(-30, now - 30000);\n      circuitBreaker.recordTrade(100, now - 20000); // Profitable\n      circuitBreaker.recordTrade(-20, now - 10000);\n      \n      // Internal state should have reset\n    });\n  });\n\n  describe('edge cases', () => {\n    it('should handle zero daily start equity', () => {\n      const input: BreakerCheckInput = {\n        equity: 100,\n        positions: [],\n        dailyStartEquity: 0,\n        recentTrades: [],\n      };\n\n      const status = circuitBreaker.checkConditions(input);\n      \n      expect(status.dailyDrawdown).toBe(0);\n    });\n\n    it('should handle empty positions array', () => {\n      const input: BreakerCheckInput = {\n        equity: 1000,\n        positions: [],\n        dailyStartEquity: 1000,\n        recentTrades: [],\n      };\n\n      const status = circuitBreaker.checkConditions(input);\n      \n      expect(status.active).toBe(false);\n    });\n\n    it('should not downgrade from HARD to SOFT', async () => {\n      await circuitBreaker.trigger('Hard trigger');\n      \n      const now = Date.now();\n      const input: BreakerCheckInput = {\n        equity: 900,\n        positions: [],\n        dailyStartEquity: 1000,\n        recentTrades: [\n          { pnl: -50, timestamp: now - 30000 },\n          { pnl: -30, timestamp: now - 20000 },\n          { pnl: -20, timestamp: now - 10000 },\n        ],\n      };\n\n      const status = circuitBreaker.checkConditions(input);\n      \n      // Should remain HARD, not become SOFT\n      expect(status.type).toBe(BreakerType.HARD);\n    });\n\n    it('should handle persistence failure gracefully', async () => {\n      mockEventPersistence.persistEvent.mockRejectedValue(new Error('DB error'));\n      \n      await circuitBreaker.trigger('Test trigger');\n      \n      // Should still be active despite persistence failure\n      expect(circuitBreaker.isActive()).toBe(true);\n    });\n  });\n\n  describe('integration with default config', () => {\n    it('should work with default configuration', () => {\n      const breaker = new CircuitBreaker(defaultConfig.circuitBreaker);\n      \n      const config = breaker.getConfig();\n      expect(config.maxDailyDrawdown).toBe(0.15);\n      expect(config.minEquity).toBe(150);\n      expect(config.consecutiveLossLimit).toBe(3);\n      expect(config.cooldownMinutes).toBe(30);\n    });\n  });\n});\n"],"version":3}
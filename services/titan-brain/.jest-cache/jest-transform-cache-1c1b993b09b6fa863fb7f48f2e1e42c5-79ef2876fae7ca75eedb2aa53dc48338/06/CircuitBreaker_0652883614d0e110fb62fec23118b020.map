{"file":"/Users/ivan/Code/trading/titan/services/titan-brain/src/engine/CircuitBreaker.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-brain/src/engine/CircuitBreaker.ts"],"sourcesContent":["/**\n * CircuitBreaker - Emergency halt system for Titan Brain\n * Monitors for extreme conditions and triggers emergency halt when thresholds are breached\n * \n * Requirements: 5.1, 5.2, 5.3, 5.4, 5.5, 5.8\n */\n\nimport {\n  BreakerType,\n  BreakerStatus,\n  BreakerEvent,\n  CircuitBreakerConfig,\n  BreakerCheckInput,\n  Position,\n} from '../types/index.js';\n\n/**\n * Interface for position closure callback\n * Allows external systems to handle position closure\n */\nexport interface PositionClosureHandler {\n  closeAllPositions(): Promise<void>;\n}\n\n/**\n * Interface for notification callback\n * Allows external systems to send emergency notifications\n */\nexport interface NotificationHandler {\n  sendEmergencyNotification(reason: string, equity: number): Promise<void>;\n}\n\n/**\n * Interface for event persistence\n * Allows external systems to persist breaker events\n */\nexport interface BreakerEventPersistence {\n  persistEvent(event: BreakerEvent): Promise<void>;\n}\n\n/**\n * CircuitBreaker monitors for extreme conditions and triggers\n * emergency halt when thresholds are breached.\n * \n * Trigger conditions:\n * - Daily drawdown exceeds 15% (HARD)\n * - Equity drops below $150 (HARD)\n * - 3 consecutive losing trades within 1 hour (SOFT - 30 min cooldown)\n */\nexport class CircuitBreaker {\n  private readonly config: CircuitBreakerConfig;\n  \n  /** Current breaker state */\n  private active: boolean = false;\n  private breakerType?: BreakerType;\n  private triggerReason?: string;\n  private triggeredAt?: number;\n  private cooldownEndsAt?: number;\n  \n  /** Tracking state */\n  private dailyStartEquity: number = 0;\n  private recentLosses: Array<{ pnl: number; timestamp: number }> = [];\n  \n  /** External handlers */\n  private positionHandler?: PositionClosureHandler;\n  private notificationHandler?: NotificationHandler;\n  private eventPersistence?: BreakerEventPersistence;\n\n  constructor(config: CircuitBreakerConfig) {\n    this.config = config;\n  }\n\n  /**\n   * Set the position closure handler\n   */\n  setPositionHandler(handler: PositionClosureHandler): void {\n    this.positionHandler = handler;\n  }\n\n  /**\n   * Set the notification handler\n   */\n  setNotificationHandler(handler: NotificationHandler): void {\n    this.notificationHandler = handler;\n  }\n\n  /**\n   * Set the event persistence handler\n   */\n  setEventPersistence(persistence: BreakerEventPersistence): void {\n    this.eventPersistence = persistence;\n  }\n\n  /**\n   * Set daily start equity for drawdown calculation\n   * Should be called at the start of each trading day\n   */\n  setDailyStartEquity(equity: number): void {\n    this.dailyStartEquity = Math.max(0, equity);\n  }\n\n  /**\n   * Get daily start equity\n   */\n  getDailyStartEquity(): number {\n    return this.dailyStartEquity;\n  }\n\n  /**\n   * Check all breaker conditions\n   * \n   * @param input - Breaker check input with equity, positions, and trade history\n   * @returns Current breaker status\n   */\n  checkConditions(input: BreakerCheckInput): BreakerStatus {\n    const { equity, positions, dailyStartEquity, recentTrades } = input;\n    \n    // Update daily start equity if provided\n    if (dailyStartEquity > 0) {\n      this.dailyStartEquity = dailyStartEquity;\n    }\n    \n    // Calculate daily drawdown\n    const dailyDrawdown = this.calculateDailyDrawdown(equity);\n    \n    // Count consecutive losses within the time window\n    const consecutiveLosses = this.countConsecutiveLosses(recentTrades);\n    \n    // Check for soft breaker cooldown expiry\n    this.checkCooldownExpiry();\n    \n    // If already active with HARD breaker, maintain state\n    if (this.active && this.breakerType === BreakerType.HARD) {\n      return this.getStatus();\n    }\n    \n    // Requirement 5.1: Daily drawdown exceeds 15%\n    if (dailyDrawdown >= this.config.maxDailyDrawdown) {\n      this.trigger(`Daily drawdown exceeded: ${(dailyDrawdown * 100).toFixed(2)}% >= ${(this.config.maxDailyDrawdown * 100).toFixed(0)}%`);\n      return this.getStatus();\n    }\n    \n    // Requirement 5.2: Equity drops below minimum\n    if (equity < this.config.minEquity) {\n      this.trigger(`Equity below minimum: $${equity.toFixed(2)} < $${this.config.minEquity}`);\n      return this.getStatus();\n    }\n    \n    // Requirement 5.3: Consecutive losses (soft pause)\n    if (consecutiveLosses >= this.config.consecutiveLossLimit && !this.active) {\n      this.triggerSoftPause(`${consecutiveLosses} consecutive losses within ${this.config.consecutiveLossWindow / 60000} minutes`);\n      return this.getStatus();\n    }\n    \n    return {\n      active: this.active,\n      type: this.breakerType,\n      reason: this.triggerReason,\n      triggeredAt: this.triggeredAt,\n      dailyDrawdown,\n      consecutiveLosses,\n      equityLevel: equity,\n      cooldownEndsAt: this.cooldownEndsAt,\n    };\n  }\n\n  /**\n   * Trigger the circuit breaker (HARD)\n   * Requirement 5.4: Close all positions immediately\n   * Requirement 5.5: Reject all new signals until manual reset\n   * \n   * @param reason - Reason for triggering\n   */\n  async trigger(reason: string): Promise<void> {\n    // Requirement 5.4: Idempotence - don't create duplicate events\n    if (this.active && this.breakerType === BreakerType.HARD) {\n      return;\n    }\n    \n    const timestamp = Date.now();\n    \n    this.active = true;\n    this.breakerType = BreakerType.HARD;\n    this.triggerReason = reason;\n    this.triggeredAt = timestamp;\n    this.cooldownEndsAt = undefined;\n    \n    // Requirement 5.4: Close all open positions immediately\n    if (this.positionHandler) {\n      try {\n        await this.positionHandler.closeAllPositions();\n      } catch (error) {\n        // Log error but don't prevent breaker activation\n        console.error('Failed to close positions during circuit breaker trigger:', error);\n      }\n    }\n    \n    // Requirement 5.6: Send emergency notifications\n    if (this.notificationHandler) {\n      try {\n        await this.notificationHandler.sendEmergencyNotification(reason, this.dailyStartEquity);\n      } catch (error) {\n        console.error('Failed to send emergency notification:', error);\n      }\n    }\n    \n    // Requirement 5.7: Log the event\n    const event: BreakerEvent = {\n      timestamp,\n      eventType: 'TRIGGER',\n      breakerType: BreakerType.HARD,\n      reason,\n      equity: this.dailyStartEquity,\n      metadata: {\n        dailyDrawdown: this.calculateDailyDrawdown(this.dailyStartEquity),\n      },\n    };\n    \n    if (this.eventPersistence) {\n      try {\n        await this.eventPersistence.persistEvent(event);\n      } catch (error) {\n        console.error('Failed to persist breaker event:', error);\n      }\n    }\n  }\n\n  /**\n   * Trigger a soft pause (cooldown period)\n   * Requirement 5.3: 30 minute cooldown for consecutive losses\n   * \n   * @param reason - Reason for soft pause\n   */\n  private async triggerSoftPause(reason: string): Promise<void> {\n    // Don't downgrade from HARD to SOFT\n    if (this.active && this.breakerType === BreakerType.HARD) {\n      return;\n    }\n    \n    // Idempotence for SOFT breaker\n    if (this.active && this.breakerType === BreakerType.SOFT) {\n      return;\n    }\n    \n    const timestamp = Date.now();\n    \n    this.active = true;\n    this.breakerType = BreakerType.SOFT;\n    this.triggerReason = reason;\n    this.triggeredAt = timestamp;\n    this.cooldownEndsAt = timestamp + (this.config.cooldownMinutes * 60 * 1000);\n    \n    // Log the event\n    const event: BreakerEvent = {\n      timestamp,\n      eventType: 'TRIGGER',\n      breakerType: BreakerType.SOFT,\n      reason,\n      equity: this.dailyStartEquity,\n      metadata: {\n        cooldownMinutes: this.config.cooldownMinutes,\n        cooldownEndsAt: this.cooldownEndsAt,\n      },\n    };\n    \n    if (this.eventPersistence) {\n      try {\n        await this.eventPersistence.persistEvent(event);\n      } catch (error) {\n        console.error('Failed to persist soft pause event:', error);\n      }\n    }\n  }\n\n  /**\n   * Reset the circuit breaker (manual reset)\n   * Requirement 5.8: Require confirmation and log operator identity\n   * \n   * @param operatorId - ID of the operator performing the reset\n   */\n  async reset(operatorId: string): Promise<void> {\n    if (!this.active) {\n      return;\n    }\n    \n    if (!operatorId || operatorId.trim() === '') {\n      throw new Error('Operator ID is required for circuit breaker reset');\n    }\n    \n    const timestamp = Date.now();\n    const previousReason = this.triggerReason;\n    const previousType = this.breakerType;\n    \n    // Reset state\n    this.active = false;\n    this.breakerType = undefined;\n    this.triggerReason = undefined;\n    this.triggeredAt = undefined;\n    this.cooldownEndsAt = undefined;\n    \n    // Requirement 5.8: Log the reset with operator identity\n    const event: BreakerEvent = {\n      timestamp,\n      eventType: 'RESET',\n      reason: `Manual reset by operator: ${operatorId}`,\n      equity: this.dailyStartEquity,\n      operatorId,\n      metadata: {\n        previousReason,\n        previousType,\n      },\n    };\n    \n    if (this.eventPersistence) {\n      try {\n        await this.eventPersistence.persistEvent(event);\n      } catch (error) {\n        console.error('Failed to persist reset event:', error);\n      }\n    }\n  }\n\n  /**\n   * Check if circuit breaker is active\n   * Requirement 5.5: Reject all new signals until manual reset\n   */\n  isActive(): boolean {\n    // Check for soft breaker cooldown expiry\n    this.checkCooldownExpiry();\n    return this.active;\n  }\n\n  /**\n   * Get current breaker status\n   */\n  getStatus(): BreakerStatus {\n    // Check for soft breaker cooldown expiry\n    this.checkCooldownExpiry();\n    \n    return {\n      active: this.active,\n      type: this.breakerType,\n      reason: this.triggerReason,\n      triggeredAt: this.triggeredAt,\n      dailyDrawdown: this.calculateDailyDrawdown(this.dailyStartEquity),\n      consecutiveLosses: this.recentLosses.length,\n      equityLevel: this.dailyStartEquity,\n      cooldownEndsAt: this.cooldownEndsAt,\n    };\n  }\n\n  /**\n   * Record a trade result for consecutive loss tracking\n   * \n   * @param pnl - Trade PnL (positive = profit, negative = loss)\n   * @param timestamp - Trade timestamp\n   */\n  recordTrade(pnl: number, timestamp?: number): void {\n    const tradeTime = timestamp ?? Date.now();\n    \n    // Add to recent losses tracking\n    this.recentLosses.push({ pnl, timestamp: tradeTime });\n    \n    // Clean up old trades outside the window\n    const windowStart = tradeTime - this.config.consecutiveLossWindow;\n    this.recentLosses = this.recentLosses.filter(t => t.timestamp >= windowStart);\n    \n    // If profitable trade, reset consecutive loss counter\n    if (pnl >= 0) {\n      this.recentLosses = this.recentLosses.filter(t => t.pnl < 0 && t.timestamp > tradeTime - this.config.consecutiveLossWindow);\n    }\n  }\n\n  /**\n   * Get configuration\n   */\n  getConfig(): CircuitBreakerConfig {\n    return { ...this.config };\n  }\n\n  // ============ Private Helper Methods ============\n\n  /**\n   * Calculate daily drawdown percentage\n   */\n  private calculateDailyDrawdown(currentEquity: number): number {\n    if (this.dailyStartEquity <= 0) {\n      return 0;\n    }\n    \n    const drawdown = (this.dailyStartEquity - currentEquity) / this.dailyStartEquity;\n    return Math.max(0, drawdown);\n  }\n\n  /**\n   * Count consecutive losses within the time window\n   */\n  private countConsecutiveLosses(recentTrades: Array<{ pnl: number; timestamp: number }>): number {\n    if (recentTrades.length === 0) {\n      return 0;\n    }\n    \n    const now = Date.now();\n    const windowStart = now - this.config.consecutiveLossWindow;\n    \n    // Filter trades within the window and sort by timestamp (most recent first)\n    const tradesInWindow = recentTrades\n      .filter(t => t.timestamp >= windowStart)\n      .sort((a, b) => b.timestamp - a.timestamp);\n    \n    // Count consecutive losses from most recent\n    let consecutiveLosses = 0;\n    for (const trade of tradesInWindow) {\n      if (trade.pnl < 0) {\n        consecutiveLosses++;\n      } else {\n        break; // Stop counting at first profitable trade\n      }\n    }\n    \n    return consecutiveLosses;\n  }\n\n  /**\n   * Check if soft breaker cooldown has expired\n   */\n  private checkCooldownExpiry(): void {\n    if (\n      this.active &&\n      this.breakerType === BreakerType.SOFT &&\n      this.cooldownEndsAt &&\n      Date.now() >= this.cooldownEndsAt\n    ) {\n      // Auto-reset soft breaker after cooldown\n      this.active = false;\n      this.breakerType = undefined;\n      this.triggerReason = undefined;\n      this.triggeredAt = undefined;\n      this.cooldownEndsAt = undefined;\n    }\n  }\n}\n"],"version":3}
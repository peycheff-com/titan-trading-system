9adf34b6d1918f0a2172774efeae08ef
"use strict";
/**
 * HealthManager - Comprehensive health monitoring for Railway deployment
 *
 * Provides health checks for all system components including database,
 * Redis, configuration, and memory usage. Designed for Railway's health
 * monitoring requirements.
 *
 * Requirements: 1.1.1, 1.1.2, 1.1.3, 1.1.4, 1.1.5
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.HealthManager = exports.RedisHealthComponent = exports.MemoryHealthComponent = exports.ConfigHealthComponent = exports.DatabaseHealthComponent = exports.HealthStatus = void 0;
const events_1 = require("events");
/**
 * Health status levels
 */
var HealthStatus;
(function (HealthStatus) {
    HealthStatus["HEALTHY"] = "healthy";
    HealthStatus["DEGRADED"] = "degraded";
    HealthStatus["UNHEALTHY"] = "unhealthy";
})(HealthStatus || (exports.HealthStatus = HealthStatus = {}));
/**
 * Database health component
 */
class DatabaseHealthComponent {
    databaseManager;
    name = 'database';
    isRequired = true;
    timeout = 5000;
    constructor(databaseManager) {
        this.databaseManager = databaseManager;
    }
    async check() {
        const startTime = Date.now();
        try {
            if (!this.databaseManager) {
                return {
                    name: this.name,
                    status: HealthStatus.UNHEALTHY,
                    message: 'Database manager not initialized',
                    duration: Date.now() - startTime,
                    timestamp: Date.now()
                };
            }
            const isHealthy = this.databaseManager.isHealthy();
            const metrics = this.databaseManager.getMetrics();
            if (!isHealthy) {
                return {
                    name: this.name,
                    status: HealthStatus.UNHEALTHY,
                    message: 'Database connection unhealthy',
                    duration: Date.now() - startTime,
                    timestamp: Date.now(),
                    details: {
                        connectionErrors: metrics.connectionErrors,
                        lastHealthCheck: metrics.lastHealthCheck
                    }
                };
            }
            return {
                name: this.name,
                status: HealthStatus.HEALTHY,
                message: 'Database connection healthy',
                duration: Date.now() - startTime,
                timestamp: Date.now(),
                details: {
                    totalConnections: metrics.totalConnections,
                    idleConnections: metrics.idleConnections,
                    successfulQueries: metrics.successfulQueries,
                    failedQueries: metrics.failedQueries
                }
            };
        }
        catch (error) {
            return {
                name: this.name,
                status: HealthStatus.UNHEALTHY,
                message: error instanceof Error ? error.message : 'Database check failed',
                duration: Date.now() - startTime,
                timestamp: Date.now()
            };
        }
    }
}
exports.DatabaseHealthComponent = DatabaseHealthComponent;
/**
 * Configuration health component
 */
class ConfigHealthComponent {
    config;
    name = 'configuration';
    isRequired = true;
    timeout = 1000;
    constructor(config) {
        this.config = config;
    }
    async check() {
        const startTime = Date.now();
        try {
            // Check if required configuration is present
            const requiredFields = ['port', 'nodeEnv'];
            const missingFields = requiredFields.filter(field => !this.config[field]);
            if (missingFields.length > 0) {
                return {
                    name: this.name,
                    status: HealthStatus.UNHEALTHY,
                    message: `Missing required configuration: ${missingFields.join(', ')}`,
                    duration: Date.now() - startTime,
                    timestamp: Date.now(),
                    details: { missingFields }
                };
            }
            return {
                name: this.name,
                status: HealthStatus.HEALTHY,
                message: 'Configuration valid',
                duration: Date.now() - startTime,
                timestamp: Date.now(),
                details: {
                    nodeEnv: this.config.nodeEnv,
                    port: this.config.port
                }
            };
        }
        catch (error) {
            return {
                name: this.name,
                status: HealthStatus.UNHEALTHY,
                message: error instanceof Error ? error.message : 'Configuration check failed',
                duration: Date.now() - startTime,
                timestamp: Date.now()
            };
        }
    }
}
exports.ConfigHealthComponent = ConfigHealthComponent;
/**
 * Memory health component
 */
class MemoryHealthComponent {
    name = 'memory';
    isRequired = false;
    timeout = 1000;
    WARNING_THRESHOLD = 0.8; // 80% memory usage
    CRITICAL_THRESHOLD = 0.9; // 90% memory usage
    async check() {
        const startTime = Date.now();
        try {
            const memUsage = process.memoryUsage();
            const totalMemory = memUsage.heapTotal;
            const usedMemory = memUsage.heapUsed;
            const memoryUsageRatio = usedMemory / totalMemory;
            let status = HealthStatus.HEALTHY;
            let message = 'Memory usage normal';
            if (memoryUsageRatio > this.CRITICAL_THRESHOLD) {
                status = HealthStatus.UNHEALTHY;
                message = `Critical memory usage: ${(memoryUsageRatio * 100).toFixed(1)}%`;
            }
            else if (memoryUsageRatio > this.WARNING_THRESHOLD) {
                status = HealthStatus.DEGRADED;
                message = `High memory usage: ${(memoryUsageRatio * 100).toFixed(1)}%`;
            }
            return {
                name: this.name,
                status,
                message,
                duration: Date.now() - startTime,
                timestamp: Date.now(),
                details: {
                    heapUsed: Math.round(memUsage.heapUsed / 1024 / 1024), // MB
                    heapTotal: Math.round(memUsage.heapTotal / 1024 / 1024), // MB
                    external: Math.round(memUsage.external / 1024 / 1024), // MB
                    rss: Math.round(memUsage.rss / 1024 / 1024), // MB
                    usagePercentage: Math.round(memoryUsageRatio * 100)
                }
            };
        }
        catch (error) {
            return {
                name: this.name,
                status: HealthStatus.UNHEALTHY,
                message: error instanceof Error ? error.message : 'Memory check failed',
                duration: Date.now() - startTime,
                timestamp: Date.now()
            };
        }
    }
}
exports.MemoryHealthComponent = MemoryHealthComponent;
/**
 * Redis health component (optional)
 */
class RedisHealthComponent {
    cacheManager;
    name = 'redis';
    isRequired = false;
    timeout = 3000;
    constructor(cacheManager) {
        this.cacheManager = cacheManager;
    }
    async check() {
        const startTime = Date.now();
        try {
            if (!this.cacheManager) {
                return {
                    name: this.name,
                    status: HealthStatus.DEGRADED,
                    message: 'Redis not configured (using in-memory fallback)',
                    duration: Date.now() - startTime,
                    timestamp: Date.now()
                };
            }
            const isHealthy = await this.cacheManager.isHealthy();
            if (!isHealthy) {
                return {
                    name: this.name,
                    status: HealthStatus.DEGRADED,
                    message: 'Redis unavailable (using in-memory fallback)',
                    duration: Date.now() - startTime,
                    timestamp: Date.now()
                };
            }
            return {
                name: this.name,
                status: HealthStatus.HEALTHY,
                message: 'Redis connection healthy',
                duration: Date.now() - startTime,
                timestamp: Date.now()
            };
        }
        catch (error) {
            return {
                name: this.name,
                status: HealthStatus.DEGRADED,
                message: 'Redis check failed (using in-memory fallback)',
                duration: Date.now() - startTime,
                timestamp: Date.now()
            };
        }
    }
}
exports.RedisHealthComponent = RedisHealthComponent;
/**
 * Health manager for comprehensive system health monitoring
 */
class HealthManager extends events_1.EventEmitter {
    components = new Map();
    lastHealthCheck = null;
    healthCheckInterval = null;
    startTime = Date.now();
    config;
    constructor(config = {}) {
        super();
        this.config = {
            checkInterval: config.checkInterval || 30000, // 30 seconds
            componentTimeout: config.componentTimeout || 5000, // 5 seconds
            maxConcurrentChecks: config.maxConcurrentChecks || 10,
            cacheHealthResults: config.cacheHealthResults ?? true,
            cacheTtl: config.cacheTtl || 10000 // 10 seconds
        };
    }
    /**
     * Register a health component
     */
    registerComponent(component) {
        this.components.set(component.name, component);
        this.emit('component:registered', { name: component.name });
    }
    /**
     * Unregister a health component
     */
    unregisterComponent(name) {
        this.components.delete(name);
        this.emit('component:unregistered', { name });
    }
    /**
     * Perform health check on all components
     */
    async checkHealth() {
        const startTime = Date.now();
        // Return cached result if available and fresh
        if (this.config.cacheHealthResults && this.lastHealthCheck) {
            const age = Date.now() - this.lastHealthCheck.timestamp;
            if (age < this.config.cacheTtl) {
                return this.lastHealthCheck;
            }
        }
        const componentChecks = Array.from(this.components.values()).map(component => this.checkComponent(component));
        const componentResults = await Promise.all(componentChecks);
        // Determine overall system health
        const overallStatus = this.determineOverallStatus(componentResults);
        const systemHealth = {
            status: overallStatus,
            timestamp: Date.now(),
            duration: Date.now() - startTime,
            components: componentResults,
            version: process.env.npm_package_version || '1.0.0',
            uptime: Date.now() - this.startTime
        };
        this.lastHealthCheck = systemHealth;
        this.emit('health:checked', systemHealth);
        return systemHealth;
    }
    /**
     * Check individual component with timeout
     */
    async checkComponent(component) {
        try {
            const timeout = component.timeout || this.config.componentTimeout;
            const result = await Promise.race([
                component.check(),
                new Promise((_, reject) => setTimeout(() => reject(new Error('Health check timeout')), timeout))
            ]);
            this.emit('component:checked', result);
            return result;
        }
        catch (error) {
            const result = {
                name: component.name,
                status: HealthStatus.UNHEALTHY,
                message: error instanceof Error ? error.message : 'Component check failed',
                duration: component.timeout || this.config.componentTimeout,
                timestamp: Date.now()
            };
            this.emit('component:failed', result);
            return result;
        }
    }
    /**
     * Determine overall system health status
     */
    determineOverallStatus(components) {
        const requiredComponents = components.filter(c => {
            const component = this.components.get(c.name);
            return component?.isRequired ?? true;
        });
        // If any required component is unhealthy, system is unhealthy
        if (requiredComponents.some(c => c.status === HealthStatus.UNHEALTHY)) {
            return HealthStatus.UNHEALTHY;
        }
        // If any component is degraded, system is degraded
        if (components.some(c => c.status === HealthStatus.DEGRADED)) {
            return HealthStatus.DEGRADED;
        }
        return HealthStatus.HEALTHY;
    }
    /**
     * Start periodic health checks
     */
    startPeriodicChecks() {
        if (this.healthCheckInterval) {
            clearInterval(this.healthCheckInterval);
        }
        this.healthCheckInterval = setInterval(async () => {
            try {
                await this.checkHealth();
            }
            catch (error) {
                this.emit('health:error', error);
            }
        }, this.config.checkInterval);
        this.emit('periodic:started', { interval: this.config.checkInterval });
    }
    /**
     * Stop periodic health checks
     */
    stopPeriodicChecks() {
        if (this.healthCheckInterval) {
            clearInterval(this.healthCheckInterval);
            this.healthCheckInterval = null;
        }
        this.emit('periodic:stopped');
    }
    /**
     * Get the last health check result
     */
    getLastHealthCheck() {
        return this.lastHealthCheck;
    }
    /**
     * Check if system is healthy
     */
    isHealthy() {
        return this.lastHealthCheck?.status === HealthStatus.HEALTHY;
    }
    /**
     * Get system uptime in milliseconds
     */
    getUptime() {
        return Date.now() - this.startTime;
    }
    /**
     * Shutdown health manager
     */
    shutdown() {
        this.stopPeriodicChecks();
        this.components.clear();
        this.lastHealthCheck = null;
        this.emit('shutdown');
    }
}
exports.HealthManager = HealthManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLWJyYWluL3NyYy9oZWFsdGgvSGVhbHRoTWFuYWdlci50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7O0dBUUc7OztBQUVILG1DQUFzQztBQUV0Qzs7R0FFRztBQUNILElBQVksWUFJWDtBQUpELFdBQVksWUFBWTtJQUN0QixtQ0FBbUIsQ0FBQTtJQUNuQixxQ0FBcUIsQ0FBQTtJQUNyQix1Q0FBdUIsQ0FBQTtBQUN6QixDQUFDLEVBSlcsWUFBWSw0QkFBWixZQUFZLFFBSXZCO0FBK0NEOztHQUVHO0FBQ0gsTUFBYSx1QkFBdUI7SUFLZDtJQUpwQixJQUFJLEdBQUcsVUFBVSxDQUFDO0lBQ2xCLFVBQVUsR0FBRyxJQUFJLENBQUM7SUFDbEIsT0FBTyxHQUFHLElBQUksQ0FBQztJQUVmLFlBQW9CLGVBQW9CO1FBQXBCLG9CQUFlLEdBQWYsZUFBZSxDQUFLO0lBQUcsQ0FBQztJQUU1QyxLQUFLLENBQUMsS0FBSztRQUNULE1BQU0sU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLEVBQUUsQ0FBQztRQUU3QixJQUFJLENBQUM7WUFDSCxJQUFJLENBQUMsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO2dCQUMxQixPQUFPO29CQUNMLElBQUksRUFBRSxJQUFJLENBQUMsSUFBSTtvQkFDZixNQUFNLEVBQUUsWUFBWSxDQUFDLFNBQVM7b0JBQzlCLE9BQU8sRUFBRSxrQ0FBa0M7b0JBQzNDLFFBQVEsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsU0FBUztvQkFDaEMsU0FBUyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUU7aUJBQ3RCLENBQUM7WUFDSixDQUFDO1lBRUQsTUFBTSxTQUFTLEdBQUcsSUFBSSxDQUFDLGVBQWUsQ0FBQyxTQUFTLEVBQUUsQ0FBQztZQUNuRCxNQUFNLE9BQU8sR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLFVBQVUsRUFBRSxDQUFDO1lBRWxELElBQUksQ0FBQyxTQUFTLEVBQUUsQ0FB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QUMsRUFBRSxJQUFJLENBQUMsTUFBTSxDQUFDLGFBQWEsQ0FBQyxDQUFDO1FBRTlCLElBQUksQ0FBQyxJQUFJLENBQUMsa0JBQWtCLEVBQUUsRUFBRSxRQUFRLEVBQUUsSUFBSSxDQUFDLE1BQU0sQ0FBQyxhQUFhLEVBQUUsQ0FBQyxDQUFDO0lBQ3pFLENBQUM7SUFFRDs7T0FFRztJQUNILGtCQUFrQjtRQUNoQixJQUFJLElBQUksQ0FBQyxtQkFBbUIsRUFBRSxDQUFDO1lBQzdCLGFBQWEsQ0FBQyxJQUFJLENBQUMsbUJBQW1CLENBQUMsQ0FBQztZQUN4QyxJQUFJLENBQUMsbUJBQW1CLEdBQUcsSUFBSSxDQUFDO1FBQ2xDLENBQUM7UUFFRCxJQUFJLENBQUMsSUFBSSxDQUFDLGtCQUFrQixDQUFDLENBQUM7SUFDaEMsQ0FBQztJQUVEOztPQUVHO0lBQ0gsa0JBQWtCO1FBQ2hCLE9BQU8sSUFBSSxDQUFDLGVBQWUsQ0FBQztJQUM5QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxTQUFTO1FBQ1AsT0FBTyxJQUFJLENBQUMsZUFBZSxFQUFFLE1BQU0sS0FBSyxZQUFZLENBQUMsT0FBTyxDQUFDO0lBQy9ELENBQUM7SUFFRDs7T0FFRztJQUNILFNBQVM7UUFDUCxPQUFPLElBQUksQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsU0FBUyxDQUFDO0lBQ3JDLENBQUM7SUFFRDs7T0FFRztJQUNILFFBQVE7UUFDTixJQUFJLENBQUMsa0JBQWtCLEVBQUUsQ0FBQztRQUMxQixJQUFJLENBQUMsVUFBVSxDQUFDLEtBQUssRUFBRSxDQUFDO1FBQ3hCLElBQUksQ0FBQyxlQUFlLEdBQUcsSUFBSSxDQUFDO1FBQzVCLElBQUksQ0FBQyxJQUFJLENBQUMsVUFBVSxDQUFDLENBQUM7SUFDeEIsQ0FBQztDQUNGO0FBMUxELHNDQTBMQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvaXZhbi9Db2RlL3RyYWRpbmcvdGl0YW4vc2VydmljZXMvdGl0YW4tYnJhaW4vc3JjL2hlYWx0aC9IZWFsdGhNYW5hZ2VyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogSGVhbHRoTWFuYWdlciAtIENvbXByZWhlbnNpdmUgaGVhbHRoIG1vbml0b3JpbmcgZm9yIFJhaWx3YXkgZGVwbG95bWVudFxuICogXG4gKiBQcm92aWRlcyBoZWFsdGggY2hlY2tzIGZvciBhbGwgc3lzdGVtIGNvbXBvbmVudHMgaW5jbHVkaW5nIGRhdGFiYXNlLFxuICogUmVkaXMsIGNvbmZpZ3VyYXRpb24sIGFuZCBtZW1vcnkgdXNhZ2UuIERlc2lnbmVkIGZvciBSYWlsd2F5J3MgaGVhbHRoXG4gKiBtb25pdG9yaW5nIHJlcXVpcmVtZW50cy5cbiAqIFxuICogUmVxdWlyZW1lbnRzOiAxLjEuMSwgMS4xLjIsIDEuMS4zLCAxLjEuNCwgMS4xLjVcbiAqL1xuXG5pbXBvcnQgeyBFdmVudEVtaXR0ZXIgfSBmcm9tICdldmVudHMnO1xuXG4vKipcbiAqIEhlYWx0aCBzdGF0dXMgbGV2ZWxzXG4gKi9cbmV4cG9ydCBlbnVtIEhlYWx0aFN0YXR1cyB7XG4gIEhFQUxUSFkgPSAnaGVhbHRoeScsXG4gIERFR1JBREVEID0gJ2RlZ3JhZGVkJyxcbiAgVU5IRUFMVEhZID0gJ3VuaGVhbHRoeSdcbn1cblxuLyoqXG4gKiBJbmRpdmlkdWFsIGNvbXBvbmVudCBoZWFsdGggcmVzdWx0XG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQ29tcG9uZW50SGVhbHRoIHtcbiAgbmFtZTogc3RyaW5nO1xuICBzdGF0dXM6IEhlYWx0aFN0YXR1cztcbiAgbWVzc2FnZTogc3RyaW5nO1xuICBkdXJhdGlvbjogbnVtYmVyO1xuICB0aW1lc3RhbXA6IG51bWJlcjtcbiAgZGV0YWlscz86IFJlY29yZDxzdHJpbmcsIGFueT47XG59XG5cbi8qKlxuICogT3ZlcmFsbCBzeXN0ZW0gaGVhbHRoIHJlc3VsdFxuICovXG5leHBvcnQgaW50ZXJmYWNlIFN5c3RlbUhlYWx0aCB7XG4gIHN0YXR1czogSGVhbHRoU3RhdHVzO1xuICB0aW1lc3RhbXA6IG51bWJlcjtcbiAgZHVyYXRpb246IG51bWJlcjtcbiAgY29tcG9uZW50czogQ29tcG9uZW50SGVhbHRoW107XG4gIHZlcnNpb246IHN0cmluZztcbiAgdXB0aW1lOiBudW1iZXI7XG59XG5cbi8qKlxuICogSGVhbHRoIGNoZWNrIGNvbXBvbmVudCBpbnRlcmZhY2VcbiAqL1xuZXhwb3J0IGludGVyZmFjZSBIZWFsdGhDb21wb25lbnQge1xuICBuYW1lOiBzdHJpbmc7XG4gIGNoZWNrKCk6IFByb21pc2U8Q29tcG9uZW50SGVhbHRoPjtcbiAgaXNSZXF1aXJlZDogYm9vbGVhbjtcbiAgdGltZW91dDogbnVtYmVyO1xufVxuXG4vKipcbiAqIEhlYWx0aCBtYW5hZ2VyIGNvbmZpZ3VyYXRpb25cbiAqL1xuZXhwb3J0IGludGVyZmFjZSBIZWFsdGhNYW5hZ2VyQ29uZmlnIHtcbiAgY2hlY2tJbnRlcnZhbDogbnVtYmVyO1xuICBjb21wb25lbnRUaW1lb3V0OiBudW1iZXI7XG4gIG1heENvbmN1cnJlbnRDaGVja3M6IG51bWJlcjtcbiAgY2FjaGVIZWFsdGhSZXN1bHRzOiBib29sZWFuO1xuICBjYWNoZVR0bDogbnVtYmVyO1xufVxuXG4vKipcbiAqIERhdGFiYXNlIGhlYWx0aCBjb21wb25lbnRcbiAqL1xuZXhwb3J0IGNsYXNzIERhdGFiYXNlSGVhbHRoQ29tcG9uZW50IGltcGxlbWVudHMgSGVhbHRoQ29tcG9uZW50IHtcbiAgbmFtZSA9ICdkYXRhYmFzZSc7XG4gIGlzUmVxdWlyZWQgPSB0cnVlO1xuICB0aW1lb3V0ID0gNTAwMDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGRhdGFiYXNlTWFuYWdlcjogYW55KSB7fVxuXG4gIGFzeW5jIGNoZWNrKCk6IFByb21pc2U8Q29tcG9uZW50SGVhbHRoPiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgaWYgKCF0aGlzLmRhdGFiYXNlTWFuYWdlcikge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIG5hbWU6IHRoaXMubmFtZSxcbiAgICAgICAgICBzdGF0dXM6IEhlYWx0aFN0YXR1cy5VTkhFQUxUSFksXG4gICAgICAgICAgbWVzc2FnZTogJ0RhdGFiYXNlIG1hbmFnZXIgbm90IGluaXRpYWxpemVkJyxcbiAgICAgICAgICBkdXJhdGlvbjogRGF0ZS5ub3coKSAtIHN0YXJ0VGltZSxcbiAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KClcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgaXNIZWFsdGh5ID0gdGhpcy5kYXRhYmFzZU1hbmFnZXIuaXNIZWFsdGh5KCk7XG4gICAgICBjb25zdCBtZXRyaWNzID0gdGhpcy5kYXRhYmFzZU1hbmFnZXIuZ2V0TWV0cmljcygpO1xuICAgICAgXG4gICAgICBpZiAoIWlzSGVhbHRoeSkge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIG5hbWU6IHRoaXMubmFtZSxcbiAgICAgICAgICBzdGF0dXM6IEhlYWx0aFN0YXR1cy5VTkhFQUxUSFksXG4gICAgICAgICAgbWVzc2FnZTogJ0RhdGFiYXNlIGNvbm5lY3Rpb24gdW5oZWFsdGh5JyxcbiAgICAgICAgICBkdXJhdGlvbjogRGF0ZS5ub3coKSAtIHN0YXJ0VGltZSxcbiAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICAgICAgZGV0YWlsczoge1xuICAgICAgICAgICAgY29ubmVjdGlvbkVycm9yczogbWV0cmljcy5jb25uZWN0aW9uRXJyb3JzLFxuICAgICAgICAgICAgbGFzdEhlYWx0aENoZWNrOiBtZXRyaWNzLmxhc3RIZWFsdGhDaGVja1xuICAgICAgICAgIH1cbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgbmFtZTogdGhpcy5uYW1lLFxuICAgICAgICBzdGF0dXM6IEhlYWx0aFN0YXR1cy5IRUFMVEhZLFxuICAgICAgICBtZXNzYWdlOiAnRGF0YWJhc2UgY29ubmVjdGlvbiBoZWFsdGh5JyxcbiAgICAgICAgZHVyYXRpb246IERhdGUubm93KCkgLSBzdGFydFRpbWUsXG4gICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgICAgZGV0YWlsczoge1xuICAgICAgICAgIHRvdGFsQ29ubmVjdGlvbnM6IG1ldHJpY3MudG90YWxDb25uZWN0aW9ucyxcbiAgICAgICAgICBpZGxlQ29ubmVjdGlvbnM6IG1ldHJpY3MuaWRsZUNvbm5lY3Rpb25zLFxuICAgICAgICAgIHN1Y2Nlc3NmdWxRdWVyaWVzOiBtZXRyaWNzLnN1Y2Nlc3NmdWxRdWVyaWVzLFxuICAgICAgICAgIGZhaWxlZFF1ZXJpZXM6IG1ldHJpY3MuZmFpbGVkUXVlcmllc1xuICAgICAgICB9XG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBuYW1lOiB0aGlzLm5hbWUsXG4gICAgICAgIHN0YXR1czogSGVhbHRoU3RhdHVzLlVOSEVBTFRIWSxcbiAgICAgICAgbWVzc2FnZTogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnRGF0YWJhc2UgY2hlY2sgZmFpbGVkJyxcbiAgICAgICAgZHVyYXRpb246IERhdGUubm93KCkgLSBzdGFydFRpbWUsXG4gICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKVxuICAgICAgfTtcbiAgICB9XG4gIH1cbn1cblxuLyoqXG4gKiBDb25maWd1cmF0aW9uIGhlYWx0aCBjb21wb25lbnRcbiAqL1xuZXhwb3J0IGNsYXNzIENvbmZpZ0hlYWx0aENvbXBvbmVudCBpbXBsZW1lbnRzIEhlYWx0aENvbXBvbmVudCB7XG4gIG5hbWUgPSAnY29uZmlndXJhdGlvbic7XG4gIGlzUmVxdWlyZWQgPSB0cnVlO1xuICB0aW1lb3V0ID0gMTAwMDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGNvbmZpZzogYW55KSB7fVxuXG4gIGFzeW5jIGNoZWNrKCk6IFByb21pc2U8Q29tcG9uZW50SGVhbHRoPiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgLy8gQ2hlY2sgaWYgcmVxdWlyZWQgY29uZmlndXJhdGlvbiBpcyBwcmVzZW50XG4gICAgICBjb25zdCByZXF1aXJlZEZpZWxkcyA9IFsncG9ydCcsICdub2RlRW52J107XG4gICAgICBjb25zdCBtaXNzaW5nRmllbGRzID0gcmVxdWlyZWRGaWVsZHMuZmlsdGVyKGZpZWxkID0+ICF0aGlzLmNvbmZpZ1tmaWVsZF0pO1xuICAgICAgXG4gICAgICBpZiAobWlzc2luZ0ZpZWxkcy5sZW5ndGggPiAwKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgbmFtZTogdGhpcy5uYW1lLFxuICAgICAgICAgIHN0YXR1czogSGVhbHRoU3RhdHVzLlVOSEVBTFRIWSxcbiAgICAgICAgICBtZXNzYWdlOiBgTWlzc2luZyByZXF1aXJlZCBjb25maWd1cmF0aW9uOiAke21pc3NpbmdGaWVsZHMuam9pbignLCAnKX1gLFxuICAgICAgICAgIGR1cmF0aW9uOiBEYXRlLm5vdygpIC0gc3RhcnRUaW1lLFxuICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgICAgICBkZXRhaWxzOiB7IG1pc3NpbmdGaWVsZHMgfVxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICByZXR1cm4ge1xuICAgICAgICBuYW1lOiB0aGlzLm5hbWUsXG4gICAgICAgIHN0YXR1czogSGVhbHRoU3RhdHVzLkhFQUxUSFksXG4gICAgICAgIG1lc3NhZ2U6ICdDb25maWd1cmF0aW9uIHZhbGlkJyxcbiAgICAgICAgZHVyYXRpb246IERhdGUubm93KCkgLSBzdGFydFRpbWUsXG4gICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgICAgZGV0YWlsczoge1xuICAgICAgICAgIG5vZGVFbnY6IHRoaXMuY29uZmlnLm5vZGVFbnYsXG4gICAgICAgICAgcG9ydDogdGhpcy5jb25maWcucG9ydFxuICAgICAgICB9XG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBuYW1lOiB0aGlzLm5hbWUsXG4gICAgICAgIHN0YXR1czogSGVhbHRoU3RhdHVzLlVOSEVBTFRIWSxcbiAgICAgICAgbWVzc2FnZTogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnQ29uZmlndXJhdGlvbiBjaGVjayBmYWlsZWQnLFxuICAgICAgICBkdXJhdGlvbjogRGF0ZS5ub3coKSAtIHN0YXJ0VGltZSxcbiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpXG4gICAgICB9O1xuICAgIH1cbiAgfVxufVxuXG4vKipcbiAqIE1lbW9yeSBoZWFsdGggY29tcG9uZW50XG4gKi9cbmV4cG9ydCBjbGFzcyBNZW1vcnlIZWFsdGhDb21wb25lbnQgaW1wbGVtZW50cyBIZWFsdGhDb21wb25lbnQge1xuICBuYW1lID0gJ21lbW9yeSc7XG4gIGlzUmVxdWlyZWQgPSBmYWxzZTtcbiAgdGltZW91dCA9IDEwMDA7XG5cbiAgcHJpdmF0ZSByZWFkb25seSBXQVJOSU5HX1RIUkVTSE9MRCA9IDAuODsgLy8gODAlIG1lbW9yeSB1c2FnZVxuICBwcml2YXRlIHJlYWRvbmx5IENSSVRJQ0FMX1RIUkVTSE9MRCA9IDAuOTsgLy8gOTAlIG1lbW9yeSB1c2FnZVxuXG4gIGFzeW5jIGNoZWNrKCk6IFByb21pc2U8Q29tcG9uZW50SGVhbHRoPiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgY29uc3QgbWVtVXNhZ2UgPSBwcm9jZXNzLm1lbW9yeVVzYWdlKCk7XG4gICAgICBjb25zdCB0b3RhbE1lbW9yeSA9IG1lbVVzYWdlLmhlYXBUb3RhbDtcbiAgICAgIGNvbnN0IHVzZWRNZW1vcnkgPSBtZW1Vc2FnZS5oZWFwVXNlZDtcbiAgICAgIGNvbnN0IG1lbW9yeVVzYWdlUmF0aW8gPSB1c2VkTWVtb3J5IC8gdG90YWxNZW1vcnk7XG5cbiAgICAgIGxldCBzdGF0dXMgPSBIZWFsdGhTdGF0dXMuSEVBTFRIWTtcbiAgICAgIGxldCBtZXNzYWdlID0gJ01lbW9yeSB1c2FnZSBub3JtYWwnO1xuXG4gICAgICBpZiAobWVtb3J5VXNhZ2VSYXRpbyA+IHRoaXMuQ1JJVElDQUxfVEhSRVNIT0xEKSB7XG4gICAgICAgIHN0YXR1cyA9IEhlYWx0aFN0YXR1cy5VTkhFQUxUSFk7XG4gICAgICAgIG1lc3NhZ2UgPSBgQ3JpdGljYWwgbWVtb3J5IHVzYWdlOiAkeyhtZW1vcnlVc2FnZVJhdGlvICogMTAwKS50b0ZpeGVkKDEpfSVgO1xuICAgICAgfSBlbHNlIGlmIChtZW1vcnlVc2FnZVJhdGlvID4gdGhpcy5XQVJOSU5HX1RIUkVTSE9MRCkge1xuICAgICAgICBzdGF0dXMgPSBIZWFsdGhTdGF0dXMuREVHUkFERUQ7XG4gICAgICAgIG1lc3NhZ2UgPSBgSGlnaCBtZW1vcnkgdXNhZ2U6ICR7KG1lbW9yeVVzYWdlUmF0aW8gKiAxMDApLnRvRml4ZWQoMSl9JWA7XG4gICAgICB9XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIG5hbWU6IHRoaXMubmFtZSxcbiAgICAgICAgc3RhdHVzLFxuICAgICAgICBtZXNzYWdlLFxuICAgICAgICBkdXJhdGlvbjogRGF0ZS5ub3coKSAtIHN0YXJ0VGltZSxcbiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgICBkZXRhaWxzOiB7XG4gICAgICAgICAgaGVhcFVzZWQ6IE1hdGgucm91bmQobWVtVXNhZ2UuaGVhcFVzZWQgLyAxMDI0IC8gMTAyNCksIC8vIE1CXG4gICAgICAgICAgaGVhcFRvdGFsOiBNYXRoLnJvdW5kKG1lbVVzYWdlLmhlYXBUb3RhbCAvIDEwMjQgLyAxMDI0KSwgLy8gTUJcbiAgICAgICAgICBleHRlcm5hbDogTWF0aC5yb3VuZChtZW1Vc2FnZS5leHRlcm5hbCAvIDEwMjQgLyAxMDI0KSwgLy8gTUJcbiAgICAgICAgICByc3M6IE1hdGgucm91bmQobWVtVXNhZ2UucnNzIC8gMTAyNCAvIDEwMjQpLCAvLyBNQlxuICAgICAgICAgIHVzYWdlUGVyY2VudGFnZTogTWF0aC5yb3VuZChtZW1vcnlVc2FnZVJhdGlvICogMTAwKVxuICAgICAgICB9XG4gICAgICB9O1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICByZXR1cm4ge1xuICAgICAgICBuYW1lOiB0aGlzLm5hbWUsXG4gICAgICAgIHN0YXR1czogSGVhbHRoU3RhdHVzLlVOSEVBTFRIWSxcbiAgICAgICAgbWVzc2FnZTogZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnTWVtb3J5IGNoZWNrIGZhaWxlZCcsXG4gICAgICAgIGR1cmF0aW9uOiBEYXRlLm5vdygpIC0gc3RhcnRUaW1lLFxuICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KClcbiAgICAgIH07XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogUmVkaXMgaGVhbHRoIGNvbXBvbmVudCAob3B0aW9uYWwpXG4gKi9cbmV4cG9ydCBjbGFzcyBSZWRpc0hlYWx0aENvbXBvbmVudCBpbXBsZW1lbnRzIEhlYWx0aENvbXBvbmVudCB7XG4gIG5hbWUgPSAncmVkaXMnO1xuICBpc1JlcXVpcmVkID0gZmFsc2U7XG4gIHRpbWVvdXQgPSAzMDAwO1xuXG4gIGNvbnN0cnVjdG9yKHByaXZhdGUgY2FjaGVNYW5hZ2VyPzogYW55KSB7fVxuXG4gIGFzeW5jIGNoZWNrKCk6IFByb21pc2U8Q29tcG9uZW50SGVhbHRoPiB7XG4gICAgY29uc3Qgc3RhcnRUaW1lID0gRGF0ZS5ub3coKTtcbiAgICBcbiAgICB0cnkge1xuICAgICAgaWYgKCF0aGlzLmNhY2hlTWFuYWdlcikge1xuICAgICAgICByZXR1cm4ge1xuICAgICAgICAgIG5hbWU6IHRoaXMubmFtZSxcbiAgICAgICAgICBzdGF0dXM6IEhlYWx0aFN0YXR1cy5ERUdSQURFRCxcbiAgICAgICAgICBtZXNzYWdlOiAnUmVkaXMgbm90IGNvbmZpZ3VyZWQgKHVzaW5nIGluLW1lbW9yeSBmYWxsYmFjayknLFxuICAgICAgICAgIGR1cmF0aW9uOiBEYXRlLm5vdygpIC0gc3RhcnRUaW1lLFxuICAgICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKVxuICAgICAgICB9O1xuICAgICAgfVxuXG4gICAgICBjb25zdCBpc0hlYWx0aHkgPSBhd2FpdCB0aGlzLmNhY2hlTWFuYWdlci5pc0hlYWx0aHkoKTtcbiAgICAgIFxuICAgICAgaWYgKCFpc0hlYWx0aHkpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICBuYW1lOiB0aGlzLm5hbWUsXG4gICAgICAgICAgc3RhdHVzOiBIZWFsdGhTdGF0dXMuREVHUkFERUQsXG4gICAgICAgICAgbWVzc2FnZTogJ1JlZGlzIHVuYXZhaWxhYmxlICh1c2luZyBpbi1tZW1vcnkgZmFsbGJhY2spJyxcbiAgICAgICAgICBkdXJhdGlvbjogRGF0ZS5ub3coKSAtIHN0YXJ0VGltZSxcbiAgICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KClcbiAgICAgICAgfTtcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgbmFtZTogdGhpcy5uYW1lLFxuICAgICAgICBzdGF0dXM6IEhlYWx0aFN0YXR1cy5IRUFMVEhZLFxuICAgICAgICBtZXNzYWdlOiAnUmVkaXMgY29ubmVjdGlvbiBoZWFsdGh5JyxcbiAgICAgICAgZHVyYXRpb246IERhdGUubm93KCkgLSBzdGFydFRpbWUsXG4gICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKVxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgbmFtZTogdGhpcy5uYW1lLFxuICAgICAgICBzdGF0dXM6IEhlYWx0aFN0YXR1cy5ERUdSQURFRCxcbiAgICAgICAgbWVzc2FnZTogJ1JlZGlzIGNoZWNrIGZhaWxlZCAodXNpbmcgaW4tbWVtb3J5IGZhbGxiYWNrKScsXG4gICAgICAgIGR1cmF0aW9uOiBEYXRlLm5vdygpIC0gc3RhcnRUaW1lLFxuICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KClcbiAgICAgIH07XG4gICAgfVxuICB9XG59XG5cbi8qKlxuICogSGVhbHRoIG1hbmFnZXIgZm9yIGNvbXByZWhlbnNpdmUgc3lzdGVtIGhlYWx0aCBtb25pdG9yaW5nXG4gKi9cbmV4cG9ydCBjbGFzcyBIZWFsdGhNYW5hZ2VyIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgcHJpdmF0ZSBjb21wb25lbnRzOiBNYXA8c3RyaW5nLCBIZWFsdGhDb21wb25lbnQ+ID0gbmV3IE1hcCgpO1xuICBwcml2YXRlIGxhc3RIZWFsdGhDaGVjazogU3lzdGVtSGVhbHRoIHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgaGVhbHRoQ2hlY2tJbnRlcnZhbDogTm9kZUpTLlRpbWVvdXQgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBzdGFydFRpbWU6IG51bWJlciA9IERhdGUubm93KCk7XG4gIHByaXZhdGUgY29uZmlnOiBIZWFsdGhNYW5hZ2VyQ29uZmlnO1xuXG4gIGNvbnN0cnVjdG9yKGNvbmZpZzogUGFydGlhbDxIZWFsdGhNYW5hZ2VyQ29uZmlnPiA9IHt9KSB7XG4gICAgc3VwZXIoKTtcbiAgICBcbiAgICB0aGlzLmNvbmZpZyA9IHtcbiAgICAgIGNoZWNrSW50ZXJ2YWw6IGNvbmZpZy5jaGVja0ludGVydmFsIHx8IDMwMDAwLCAvLyAzMCBzZWNvbmRzXG4gICAgICBjb21wb25lbnRUaW1lb3V0OiBjb25maWcuY29tcG9uZW50VGltZW91dCB8fCA1MDAwLCAvLyA1IHNlY29uZHNcbiAgICAgIG1heENvbmN1cnJlbnRDaGVja3M6IGNvbmZpZy5tYXhDb25jdXJyZW50Q2hlY2tzIHx8IDEwLFxuICAgICAgY2FjaGVIZWFsdGhSZXN1bHRzOiBjb25maWcuY2FjaGVIZWFsdGhSZXN1bHRzID8/IHRydWUsXG4gICAgICBjYWNoZVR0bDogY29uZmlnLmNhY2hlVHRsIHx8IDEwMDAwIC8vIDEwIHNlY29uZHNcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFJlZ2lzdGVyIGEgaGVhbHRoIGNvbXBvbmVudFxuICAgKi9cbiAgcmVnaXN0ZXJDb21wb25lbnQoY29tcG9uZW50OiBIZWFsdGhDb21wb25lbnQpOiB2b2lkIHtcbiAgICB0aGlzLmNvbXBvbmVudHMuc2V0KGNvbXBvbmVudC5uYW1lLCBjb21wb25lbnQpO1xuICAgIHRoaXMuZW1pdCgnY29tcG9uZW50OnJlZ2lzdGVyZWQnLCB7IG5hbWU6IGNvbXBvbmVudC5uYW1lIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFVucmVnaXN0ZXIgYSBoZWFsdGggY29tcG9uZW50XG4gICAqL1xuICB1bnJlZ2lzdGVyQ29tcG9uZW50KG5hbWU6IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMuY29tcG9uZW50cy5kZWxldGUobmFtZSk7XG4gICAgdGhpcy5lbWl0KCdjb21wb25lbnQ6dW5yZWdpc3RlcmVkJywgeyBuYW1lIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFBlcmZvcm0gaGVhbHRoIGNoZWNrIG9uIGFsbCBjb21wb25lbnRzXG4gICAqL1xuICBhc3luYyBjaGVja0hlYWx0aCgpOiBQcm9taXNlPFN5c3RlbUhlYWx0aD4ge1xuICAgIGNvbnN0IHN0YXJ0VGltZSA9IERhdGUubm93KCk7XG4gICAgXG4gICAgLy8gUmV0dXJuIGNhY2hlZCByZXN1bHQgaWYgYXZhaWxhYmxlIGFuZCBmcmVzaFxuICAgIGlmICh0aGlzLmNvbmZpZy5jYWNoZUhlYWx0aFJlc3VsdHMgJiYgdGhpcy5sYXN0SGVhbHRoQ2hlY2spIHtcbiAgICAgIGNvbnN0IGFnZSA9IERhdGUubm93KCkgLSB0aGlzLmxhc3RIZWFsdGhDaGVjay50aW1lc3RhbXA7XG4gICAgICBpZiAoYWdlIDwgdGhpcy5jb25maWcuY2FjaGVUdGwpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubGFzdEhlYWx0aENoZWNrO1xuICAgICAgfVxuICAgIH1cblxuICAgIGNvbnN0IGNvbXBvbmVudENoZWNrcyA9IEFycmF5LmZyb20odGhpcy5jb21wb25lbnRzLnZhbHVlcygpKS5tYXAoY29tcG9uZW50ID0+XG4gICAgICB0aGlzLmNoZWNrQ29tcG9uZW50KGNvbXBvbmVudClcbiAgICApO1xuXG4gICAgY29uc3QgY29tcG9uZW50UmVzdWx0cyA9IGF3YWl0IFByb21pc2UuYWxsKGNvbXBvbmVudENoZWNrcyk7XG4gICAgXG4gICAgLy8gRGV0ZXJtaW5lIG92ZXJhbGwgc3lzdGVtIGhlYWx0aFxuICAgIGNvbnN0IG92ZXJhbGxTdGF0dXMgPSB0aGlzLmRldGVybWluZU92ZXJhbGxTdGF0dXMoY29tcG9uZW50UmVzdWx0cyk7XG4gICAgXG4gICAgY29uc3Qgc3lzdGVtSGVhbHRoOiBTeXN0ZW1IZWFsdGggPSB7XG4gICAgICBzdGF0dXM6IG92ZXJhbGxTdGF0dXMsXG4gICAgICB0aW1lc3RhbXA6IERhdGUubm93KCksXG4gICAgICBkdXJhdGlvbjogRGF0ZS5ub3coKSAtIHN0YXJ0VGltZSxcbiAgICAgIGNvbXBvbmVudHM6IGNvbXBvbmVudFJlc3VsdHMsXG4gICAgICB2ZXJzaW9uOiBwcm9jZXNzLmVudi5ucG1fcGFja2FnZV92ZXJzaW9uIHx8ICcxLjAuMCcsXG4gICAgICB1cHRpbWU6IERhdGUubm93KCkgLSB0aGlzLnN0YXJ0VGltZVxuICAgIH07XG5cbiAgICB0aGlzLmxhc3RIZWFsdGhDaGVjayA9IHN5c3RlbUhlYWx0aDtcbiAgICB0aGlzLmVtaXQoJ2hlYWx0aDpjaGVja2VkJywgc3lzdGVtSGVhbHRoKTtcbiAgICBcbiAgICByZXR1cm4gc3lzdGVtSGVhbHRoO1xuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGluZGl2aWR1YWwgY29tcG9uZW50IHdpdGggdGltZW91dFxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBjaGVja0NvbXBvbmVudChjb21wb25lbnQ6IEhlYWx0aENvbXBvbmVudCk6IFByb21pc2U8Q29tcG9uZW50SGVhbHRoPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IHRpbWVvdXQgPSBjb21wb25lbnQudGltZW91dCB8fCB0aGlzLmNvbmZpZy5jb21wb25lbnRUaW1lb3V0O1xuICAgICAgXG4gICAgICBjb25zdCByZXN1bHQgPSBhd2FpdCBQcm9taXNlLnJhY2UoW1xuICAgICAgICBjb21wb25lbnQuY2hlY2soKSxcbiAgICAgICAgbmV3IFByb21pc2U8Q29tcG9uZW50SGVhbHRoPigoXywgcmVqZWN0KSA9PlxuICAgICAgICAgIHNldFRpbWVvdXQoKCkgPT4gcmVqZWN0KG5ldyBFcnJvcignSGVhbHRoIGNoZWNrIHRpbWVvdXQnKSksIHRpbWVvdXQpXG4gICAgICAgIClcbiAgICAgIF0pO1xuXG4gICAgICB0aGlzLmVtaXQoJ2NvbXBvbmVudDpjaGVja2VkJywgcmVzdWx0KTtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnN0IHJlc3VsdDogQ29tcG9uZW50SGVhbHRoID0ge1xuICAgICAgICBuYW1lOiBjb21wb25lbnQubmFtZSxcbiAgICAgICAgc3RhdHVzOiBIZWFsdGhTdGF0dXMuVU5IRUFMVEhZLFxuICAgICAgICBtZXNzYWdlOiBlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdDb21wb25lbnQgY2hlY2sgZmFpbGVkJyxcbiAgICAgICAgZHVyYXRpb246IGNvbXBvbmVudC50aW1lb3V0IHx8IHRoaXMuY29uZmlnLmNvbXBvbmVudFRpbWVvdXQsXG4gICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKVxuICAgICAgfTtcblxuICAgICAgdGhpcy5lbWl0KCdjb21wb25lbnQ6ZmFpbGVkJywgcmVzdWx0KTtcbiAgICAgIHJldHVybiByZXN1bHQ7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIERldGVybWluZSBvdmVyYWxsIHN5c3RlbSBoZWFsdGggc3RhdHVzXG4gICAqL1xuICBwcml2YXRlIGRldGVybWluZU92ZXJhbGxTdGF0dXMoY29tcG9uZW50czogQ29tcG9uZW50SGVhbHRoW10pOiBIZWFsdGhTdGF0dXMge1xuICAgIGNvbnN0IHJlcXVpcmVkQ29tcG9uZW50cyA9IGNvbXBvbmVudHMuZmlsdGVyKGMgPT4ge1xuICAgICAgY29uc3QgY29tcG9uZW50ID0gdGhpcy5jb21wb25lbnRzLmdldChjLm5hbWUpO1xuICAgICAgcmV0dXJuIGNvbXBvbmVudD8uaXNSZXF1aXJlZCA/PyB0cnVlO1xuICAgIH0pO1xuXG4gICAgLy8gSWYgYW55IHJlcXVpcmVkIGNvbXBvbmVudCBpcyB1bmhlYWx0aHksIHN5c3RlbSBpcyB1bmhlYWx0aHlcbiAgICBpZiAocmVxdWlyZWRDb21wb25lbnRzLnNvbWUoYyA9PiBjLnN0YXR1cyA9PT0gSGVhbHRoU3RhdHVzLlVOSEVBTFRIWSkpIHtcbiAgICAgIHJldHVybiBIZWFsdGhTdGF0dXMuVU5IRUFMVEhZO1xuICAgIH1cblxuICAgIC8vIElmIGFueSBjb21wb25lbnQgaXMgZGVncmFkZWQsIHN5c3RlbSBpcyBkZWdyYWRlZFxuICAgIGlmIChjb21wb25lbnRzLnNvbWUoYyA9PiBjLnN0YXR1cyA9PT0gSGVhbHRoU3RhdHVzLkRFR1JBREVEKSkge1xuICAgICAgcmV0dXJuIEhlYWx0aFN0YXR1cy5ERUdSQURFRDtcbiAgICB9XG5cbiAgICByZXR1cm4gSGVhbHRoU3RhdHVzLkhFQUxUSFk7XG4gIH1cblxuICAvKipcbiAgICogU3RhcnQgcGVyaW9kaWMgaGVhbHRoIGNoZWNrc1xuICAgKi9cbiAgc3RhcnRQZXJpb2RpY0NoZWNrcygpOiB2b2lkIHtcbiAgICBpZiAodGhpcy5oZWFsdGhDaGVja0ludGVydmFsKSB7XG4gICAgICBjbGVhckludGVydmFsKHRoaXMuaGVhbHRoQ2hlY2tJbnRlcnZhbCk7XG4gICAgfVxuXG4gICAgdGhpcy5oZWFsdGhDaGVja0ludGVydmFsID0gc2V0SW50ZXJ2YWwoYXN5bmMgKCkgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgYXdhaXQgdGhpcy5jaGVja0hlYWx0aCgpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgdGhpcy5lbWl0KCdoZWFsdGg6ZXJyb3InLCBlcnJvcik7XG4gICAgICB9XG4gICAgfSwgdGhpcy5jb25maWcuY2hlY2tJbnRlcnZhbCk7XG5cbiAgICB0aGlzLmVtaXQoJ3BlcmlvZGljOnN0YXJ0ZWQnLCB7IGludGVydmFsOiB0aGlzLmNvbmZpZy5jaGVja0ludGVydmFsIH0pO1xuICB9XG5cbiAgLyoqXG4gICAqIFN0b3AgcGVyaW9kaWMgaGVhbHRoIGNoZWNrc1xuICAgKi9cbiAgc3RvcFBlcmlvZGljQ2hlY2tzKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmhlYWx0aENoZWNrSW50ZXJ2YWwpIHtcbiAgICAgIGNsZWFySW50ZXJ2YWwodGhpcy5oZWFsdGhDaGVja0ludGVydmFsKTtcbiAgICAgIHRoaXMuaGVhbHRoQ2hlY2tJbnRlcnZhbCA9IG51bGw7XG4gICAgfVxuXG4gICAgdGhpcy5lbWl0KCdwZXJpb2RpYzpzdG9wcGVkJyk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHRoZSBsYXN0IGhlYWx0aCBjaGVjayByZXN1bHRcbiAgICovXG4gIGdldExhc3RIZWFsdGhDaGVjaygpOiBTeXN0ZW1IZWFsdGggfCBudWxsIHtcbiAgICByZXR1cm4gdGhpcy5sYXN0SGVhbHRoQ2hlY2s7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgaWYgc3lzdGVtIGlzIGhlYWx0aHlcbiAgICovXG4gIGlzSGVhbHRoeSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5sYXN0SGVhbHRoQ2hlY2s/LnN0YXR1cyA9PT0gSGVhbHRoU3RhdHVzLkhFQUxUSFk7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHN5c3RlbSB1cHRpbWUgaW4gbWlsbGlzZWNvbmRzXG4gICAqL1xuICBnZXRVcHRpbWUoKTogbnVtYmVyIHtcbiAgICByZXR1cm4gRGF0ZS5ub3coKSAtIHRoaXMuc3RhcnRUaW1lO1xuICB9XG5cbiAgLyoqXG4gICAqIFNodXRkb3duIGhlYWx0aCBtYW5hZ2VyXG4gICAqL1xuICBzaHV0ZG93bigpOiB2b2lkIHtcbiAgICB0aGlzLnN0b3BQZXJpb2RpY0NoZWNrcygpO1xuICAgIHRoaXMuY29tcG9uZW50cy5jbGVhcigpO1xuICAgIHRoaXMubGFzdEhlYWx0aENoZWNrID0gbnVsbDtcbiAgICB0aGlzLmVtaXQoJ3NodXRkb3duJyk7XG4gIH1cbn0iXSwidmVyc2lvbiI6M30=
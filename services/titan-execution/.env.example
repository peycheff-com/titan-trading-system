# Titan Execution Microservice Configuration
# Copy this file to .env and fill in your values

# =============================================================================
# CRITICAL SECURITY CREDENTIALS (REQUIRED)
# =============================================================================
# Requirements 96.6: These credentials are REQUIRED for startup

# HMAC secret for webhook signature verification (Requirements 20.2, 20.4, 96.6)
# MUST be at least 32 characters for security
# Generate with: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
HMAC_SECRET=your_hmac_secret_here_must_be_at_least_32_characters

# =============================================================================
# BYBIT BROKER CONFIGURATION (Requirements 3.1-3.7)
# =============================================================================

# Use mock broker adapter for testing (default: false)
# Set to 'true' for testing without real API calls
USE_MOCK_BROKER=false

# Bybit API key for order execution (Requirements 3.1-3.3, 96.6)
# Get from: https://www.bybit.com/app/user/api-management
BYBIT_API_KEY=your_bybit_api_key_here

# Bybit API secret (Requirements 3.2, 96.6)
BYBIT_API_SECRET=your_bybit_api_secret_here

# Use Bybit testnet (default: false)
# Set to 'true' for testing with testnet API
# Testnet: https://testnet.bybit.com
BYBIT_TESTNET=false

# Bybit trading category (default: linear)
# Options: linear (USDT perpetual), inverse, spot
BYBIT_CATEGORY=linear

# Bybit API rate limit in requests per second (default: 10)
# Requirements 3.7: Rate limiting with exponential backoff
# Bybit limit is ~50 req/s, we use 10 to be conservative
BYBIT_RATE_LIMIT_RPS=10

# Bybit max retry attempts for rate limit errors (default: 3)
# Requirements 3.7: Exponential backoff on 429 errors
BYBIT_MAX_RETRIES=3

# Bybit account cache TTL in milliseconds (default: 5000)
# Cache account data to reduce API calls
BYBIT_ACCOUNT_CACHE_TTL=5000

# Legacy broker API key (deprecated - use BYBIT_API_KEY)
BROKER_API_KEY=your_broker_api_key_here

# Legacy broker API secret (deprecated - use BYBIT_API_SECRET)
BROKER_API_SECRET=your_broker_api_secret_here

# =============================================================================
# RISK PARAMETERS (REQUIRED)
# =============================================================================
# Requirements 96.4, 96.5: These risk parameters are REQUIRED for startup

# Maximum risk per trade as percentage (Requirements 96.4)
# MUST be between 0.01 (1%) and 0.20 (20%)
MAX_RISK_PCT=0.02

# Phase 1 (Kickstarter) risk percentage (Requirements 96.5)
# MUST be between 0.01 (1%) and 0.50 (50%)
PHASE_1_RISK_PCT=0.10

# Phase 2 (Trend Rider) risk percentage (Requirements 96.5)
# MUST be between 0.01 (1%) and 0.50 (50%)
PHASE_2_RISK_PCT=0.05

# =============================================================================
# FEE CONFIGURATION (OPTIONAL - HAS DEFAULTS)
# =============================================================================

# Maker fee percentage (default: 0.0002 = 0.02%)
MAKER_FEE_PCT=0.0002

# Taker fee percentage (default: 0.0006 = 0.06%)
TAKER_FEE_PCT=0.0006

# =============================================================================
# RATE LIMITING (OPTIONAL - HAS DEFAULTS)
# =============================================================================

# Rate limit per second (default: 12, max: 50)
# Set to 80% of exchange limit to avoid hitting it
RATE_LIMIT_PER_SEC=12

# =============================================================================
# REDIS (OPTIONAL - HAS IN-MEMORY FALLBACK)
# =============================================================================
# Requirement 96.8: Redis connection validated on startup if provided

# Redis connection URL for idempotency key storage (Requirements 21.3)
# Format: redis://[username:password@]host[:port][/database]
# OPTIONAL: If not provided, uses in-memory fallback
REDIS_URL=redis://localhost:6379

# Whether Redis is required (default: false)
# If true and Redis connection fails, microservice will exit
REDIS_REQUIRED=false

# Idempotency key TTL in seconds (default: 300 = 5 minutes)
IDEMPOTENCY_TTL=300

# =============================================================================
# DATABASE (REQUIRED FOR PRODUCTION)
# =============================================================================
# Requirements 97.1-97.8: SQL database for permanent audit trail and crash recovery

# Database connection URL (REQUIRED)
# PostgreSQL (Production): postgresql://username:password@host:port/database
# SQLite (Development): ./titan_execution.db or ./data/titan_execution.db
# 
# PostgreSQL Example:
#   DATABASE_URL=postgresql://titan_user:secure_password@localhost:5432/titan_execution
# 
# SQLite Example:
#   DATABASE_URL=./data/titan_execution.db
DATABASE_URL=./titan_execution.db

# Database type (REQUIRED)
# Options: postgres, sqlite
# Use 'postgres' for production, 'sqlite' for development
DATABASE_TYPE=sqlite

# =============================================================================
# REPLAY GUARD (Requirements 65.1-65.8)
# =============================================================================

# Maximum timestamp drift in milliseconds (default: 5000 = 5 seconds)
# Requests with timestamps older/newer than this are rejected
MAX_TIMESTAMP_DRIFT_MS=5000

# Signal ID cache TTL in milliseconds (default: 300000 = 5 minutes)
# Duplicate signal IDs within this window are rejected as replay attacks
SIGNAL_CACHE_TTL_MS=300000

# =============================================================================
# BROKER API (OPTIONAL - HAS DEFAULTS)
# =============================================================================

# Broker API base URL (optional)
BROKER_API_URL=https://api.broker.com

# =============================================================================
# WEBSOCKET (L2 Order Book Stream)
# =============================================================================

# Exchange WebSocket URL for order book streaming (Requirements 56.1-56.6)
WS_ORDERBOOK_URL=wss://stream.exchange.com/ws

# Maximum cache staleness in milliseconds before rejecting validations
WS_CACHE_MAX_AGE_MS=100

# =============================================================================
# SERVER
# =============================================================================

# Server port
PORT=3001

# Server host
HOST=0.0.0.0

# Environment (development, production, test)
NODE_ENV=development

# =============================================================================
# SAFETY SYSTEMS (OPTIONAL - HAS DEFAULTS)
# =============================================================================

# Heartbeat timeout in milliseconds (Requirements 37.1-37.5)
# Emergency flatten triggered after this many ms without heartbeat
# Default: 300000 (5 minutes)
HEARTBEAT_TIMEOUT_MS=300000

# Z-Score threshold for safety stop (Requirements 27.3)
# Default: -2.0
ZSCORE_SAFETY_THRESHOLD=-2.0

# Drawdown velocity threshold (Requirements 27.7)
# Hard kill if equity drops more than this percentage in 5 minutes
# Default: 0.02 (2%)
DRAWDOWN_VELOCITY_THRESHOLD=0.02

# Maximum consecutive losses before circuit breaker (default: 3)
MAX_CONSECUTIVE_LOSSES=3

# Maximum daily drawdown percentage (default: 0.05 = 5%)
MAX_DAILY_DRAWDOWN_PCT=0.05

# Maximum weekly drawdown percentage (default: 0.10 = 10%)
MAX_WEEKLY_DRAWDOWN_PCT=0.10

# Circuit breaker cooldown in hours (default: 4)
CIRCUIT_BREAKER_COOLDOWN_HOURS=4

# Funding rate greed threshold (default: 100)
FUNDING_GREED_THRESHOLD=100

# Funding rate high greed threshold (default: 50)
FUNDING_HIGH_GREED_THRESHOLD=50

# Funding rate fear threshold (default: -50)
FUNDING_FEAR_THRESHOLD=-50

# =============================================================================
# VALIDATION THRESHOLDS
# =============================================================================

# Minimum market structure score for order validation (Requirements 22.1)
MIN_STRUCTURE_THRESHOLD=60

# Maximum spread percentage (asset-specific, this is default)
MAX_SPREAD_PCT=0.001

# Maximum slippage percentage
MAX_SLIPPAGE_PCT=0.002

# =============================================================================
# NEWS/SENTIMENT AUTO-PROXY (Requirements 45.1-45.6)
# =============================================================================

# News API key for automated sentiment analysis
# Get a free key at https://newsapi.org/
NEWS_API_KEY=your_news_api_key_here

# News API base URL (default: https://newsapi.org/v2)
NEWS_API_URL=https://newsapi.org/v2

# Poll interval in milliseconds (default: 300000 = 5 minutes)
NEWS_POLL_INTERVAL_MS=300000

# Sentiment decay time in milliseconds (default: 3600000 = 1 hour)
# How long sentiment values remain valid before decaying
SENTIMENT_DECAY_MS=3600000

# =============================================================================
# HTTPS CONFIGURATION (Requirements 10.7)
# =============================================================================
# Enable HTTPS for production to encrypt all external communication

# Enable HTTPS (default: false)
# Set to 'true' to enable HTTPS
HTTPS_ENABLED=false

# Path to SSL certificate file (required if HTTPS_ENABLED=true)
# For Let's Encrypt: /etc/letsencrypt/live/your-domain.com/fullchain.pem
# For self-signed: ./certs/titan.crt
SSL_CERT_PATH=./certs/titan.crt

# Path to SSL private key file (required if HTTPS_ENABLED=true)
# For Let's Encrypt: /etc/letsencrypt/live/your-domain.com/privkey.pem
# For self-signed: ./certs/titan.key
SSL_KEY_PATH=./certs/titan.key

# HTTPS port (default: 443)
# Use 8443 if you don't have root access
HTTPS_PORT=443

# Redirect HTTP to HTTPS (default: true when HTTPS is enabled)
# When true, HTTP requests on PORT are redirected to HTTPS on HTTPS_PORT
HTTPS_REDIRECT=true

# =============================================================================
# LOGGING
# =============================================================================

# Log level (error, warn, info, debug)
LOG_LEVEL=info

29ae25079115e95ac0cb986ef5706214
"use strict";
/**
 * Binance Spot Client for CVD Data Source
 *
 * Provides tick-level trade data via WebSocket for Cumulative Volume Delta calculation.
 * Includes reconnection logic and callback system for trade events.
 *
 * Requirements: 4.1 (CVD Monitoring)
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.BinanceSpotClient = void 0;
const WebSocket = require("ws");
// Use require for node-fetch to avoid ES modules issues in Jest
const fetch = require('node-fetch');
class BinanceSpotClient {
    ws = null;
    baseUrl = 'https://api.binance.com';
    wsUrl = 'wss://stream.binance.com:9443/ws';
    subscriptions = new Map();
    reconnectAttempts = 0;
    maxReconnectAttempts = 3;
    reconnectDelay = 2000; // 2 seconds
    isReconnecting = false;
    heartbeatInterval = null;
    lastPongTime = 0;
    isInitialized = false;
    // Callbacks
    errorCallbacks = new Set();
    reconnectCallbacks = new Set();
    constructor() {
        this.setupHeartbeat();
    }
    /**
     * Initialize the Binance client
     * Tests connection and prepares WebSocket
     */
    async initialize() {
        if (this.isInitialized) {
            return;
        }
        try {
            console.log('ðŸ“¡ Initializing Binance Spot Client...');
            // Test connection by fetching server time
            const response = await fetch(`${this.baseUrl}/api/v3/time`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            this.isInitialized = true;
            console.log('âœ… Binance Spot Client initialized');
        }
        catch (error) {
            console.error('âŒ Failed to initialize Binance client:', error);
            throw error;
        }
    }
    /**
     * Disconnect and cleanup the Binance client
     */
    async disconnect() {
        if (!this.isInitialized) {
            return;
        }
        try {
            console.log('ðŸ“¡ Disconnecting Binance Spot Client...');
            // Close WebSocket connection
            if (this.ws) {
                this.ws.close();
                this.ws = null;
            }
            // Clear heartbeat interval
            if (this.heartbeatInterval) {
                clearInterval(this.heartbeatInterval);
                this.heartbeatInterval = null;
            }
            // Clear subscriptions
            this.subscriptions.clear();
            this.errorCallbacks.clear();
            this.reconnectCallbacks.clear();
            this.isInitialized = false;
            console.log('âœ… Binance Spot Client disconnected');
        }
        catch (error) {
            console.error('âŒ Error disconnecting Binance client:', error);
            throw error;
        }
    }
    /**
     * Subscribe to aggregate trades for a symbol
     * @param symbol - Trading symbol (e.g., 'BTCUSDT')
     * @param callback - Callback function for trade events
     */
    subscribeAggTrades(symbol, callback) {
        const normalizedSymbol = symbol.toLowerCase();
        // Add callback to subscriptions
        if (!this.subscriptions.has(normalizedSymbol)) {
            this.subscriptions.set(normalizedSymbol, new Set());
        }
        this.subscriptions.get(normalizedSymbol).add(callback);
        // Connect WebSocket if not already connected
        if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
            this.connect();
        }
        else {
            // Subscribe to the stream if WebSocket is already open
            this.subscribeToStream(normalizedSymbol);
        }
    }
    /**
     * Unsubscribe from aggregate trades for a symbol
     * @param symbol - Trading symbol
     * @param callback - Callback function to remove
     */
    unsubscribeAggTrades(symbol, callback) {
        const normalizedSymbol = symbol.toLowerCase();
        const callbacks = this.subscriptions.get(normalizedSymbol);
        if (callbacks) {
            callbacks.delete(callback);
            // If no more callbacks for this symbol, unsubscribe from stream
            if (callbacks.size === 0) {
                this.subscriptions.delete(normalizedSymbol);
                this.unsubscribeFromStream(normalizedSymbol);
            }
        }
    }
    /**
     * Get current spot price for a symbol via REST API
     * @param symbol - Trading symbol (e.g., 'BTCUSDT')
     * @returns Promise with current price
     */
    async getSpotPrice(symbol) {
        try {
            const response = await fetch(`${this.baseUrl}/api/v3/ticker/price?symbol=${symbol.toUpperCase()}`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            const data = await response.json();
            return parseFloat(data.price);
        }
        catch (error) {
            const errorMsg = `Failed to get spot price for ${symbol}: ${error instanceof Error ? error.message : 'Unknown error'}`;
            this.emitError(new Error(errorMsg));
            throw new Error(errorMsg);
        }
    }
    /**
     * Add error callback
     * @param callback - Error callback function
     */
    onError(callback) {
        this.errorCallbacks.add(callback);
    }
    /**
     * Add reconnect callback
     * @param callback - Reconnect callback function
     */
    onReconnect(callback) {
        this.reconnectCallbacks.add(callback);
    }
    /**
     * Remove error callback
     * @param callback - Error callback function to remove
     */
    removeErrorCallback(callback) {
        this.errorCallbacks.delete(callback);
    }
    /**
     * Remove reconnect callback
     * @param callback - Reconnect callback function to remove
     */
    removeReconnectCallback(callback) {
        this.reconnectCallbacks.delete(callback);
    }
    /**
     * Get connection status
     * @returns WebSocket ready state
     */
    getConnectionStatus() {
        if (!this.ws)
            return 'CLOSED';
        switch (this.ws.readyState) {
            case WebSocket.CONNECTING: return 'CONNECTING';
            case WebSocket.OPEN: return 'OPEN';
            case WebSocket.CLOSING: return 'CLOSING';
            case WebSocket.CLOSED: return 'CLOSED';
            default: return 'CLOSED';
        }
    }
    /**
     * Close WebSocket connection and cleanup
     */
    close() {
        if (this.heartbeatInterval) {
            clearInterval(this.heartbeatInterval);
            this.heartbeatInterval = null;
        }
        if (this.ws) {
            this.ws.close();
            this.ws = null;
        }
        this.subscriptions.clear();
        this.errorCallbacks.clear();
        this.reconnectCallbacks.clear();
        this.reconnectAttempts = 0;
        this.isReconnecting = false;
    }
    /**
     * Connect to Binance WebSocket
     */
    connect() {
        if (this.isReconnecting)
            return;
        try {
            // Build stream URL with all subscribed symbols
            const streams = Array.from(this.subscriptions.keys()).map(symbol => `${symbol}@aggTrade`);
            const streamUrl = streams.length > 0
                ? `${this.wsUrl}/${streams.join('/')}`
                : this.wsUrl;
            this.ws = new WebSocket(streamUrl);
            this.lastPongTime = Date.now();
            this.ws.on('open', () => {
                console.log('ðŸ”— Binance WebSocket connected');
                this.reconnectAttempts = 0;
                this.isReconnecting = false;
                // Subscribe to all existing symbols
                Array.from(this.subscriptions.keys()).forEach(symbol => {
                    this.subscribeToStream(symbol);
                });
            });
            this.ws.on('message', (data) => {
                try {
                    const message = JSON.parse(data.toString());
                    this.handleMessage(message);
                }
                catch (error) {
                    this.emitError(new Error(`Failed to parse WebSocket message: ${error instanceof Error ? error.message : 'Unknown error'}`));
                }
            });
            this.ws.on('pong', () => {
                this.lastPongTime = Date.now();
            });
            this.ws.on('error', (error) => {
                console.error('âŒ Binance WebSocket error:', error.message);
                this.emitError(error);
            });
            this.ws.on('close', (code, reason) => {
                console.log(`ðŸ”Œ Binance WebSocket closed: ${code} ${reason.toString()}`);
                this.ws = null;
                // Attempt reconnection if we have active subscriptions
                if (this.subscriptions.size > 0 && !this.isReconnecting) {
                    this.attemptReconnect();
                }
            });
        }
        catch (error) {
            this.emitError(new Error(`Failed to connect to Binance WebSocket: ${error instanceof Error ? error.message : 'Unknown error'}`));
        }
    }
    /**
     * Subscribe to a specific stream (used when WebSocket is already open)
     */
    subscribeToStream(symbol) {
        if (!this.ws || this.ws.readyState !== WebSocket.OPEN)
            return;
        const subscribeMessage = {
            method: 'SUBSCRIBE',
            params: [`${symbol}@aggTrade`],
            id: Date.now()
        };
        this.ws.send(JSON.stringify(subscribeMessage));
    }
    /**
     * Unsubscribe from a specific stream
     */
    unsubscribeFromStream(symbol) {
        if (!this.ws || this.ws.readyState !== WebSocket.OPEN)
            return;
        const unsubscribeMessage = {
            method: 'UNSUBSCRIBE',
            params: [`${symbol}@aggTrade`],
            id: Date.now()
        };
        this.ws.send(JSON.stringify(unsubscribeMessage));
    }
    /**
     * Handle incoming WebSocket messages
     */
    handleMessage(message) {
        // Handle aggregate trade data
        if (message.e === 'aggTrade') {
            const aggTrade = message;
            const trade = {
                price: parseFloat(aggTrade.p),
                quantity: parseFloat(aggTrade.q),
                side: aggTrade.m ? 'SELL' : 'BUY', // m=true means buyer is market maker (sell order filled)
                timestamp: aggTrade.T,
                isBuyerMaker: aggTrade.m // true = sell order hit buy limit, false = buy order hit sell limit
            };
            // Emit to all callbacks for this symbol
            const callbacks = this.subscriptions.get(aggTrade.s.toLowerCase());
            if (callbacks) {
                callbacks.forEach(callback => {
                    try {
                        callback(trade);
                    }
                    catch (error) {
                        this.emitError(new Error(`Trade callback error: ${error instanceof Error ? error.message : 'Unknown error'}`));
                    }
                });
            }
        }
        // Handle subscription confirmations and errors
        if (message.result === null && message.id) {
            // Subscription successful
            console.log(`âœ… Binance subscription confirmed: ${message.id}`);
        }
        else if (message.error) {
            this.emitError(new Error(`Binance WebSocket error: ${message.error.msg}`));
        }
    }
    /**
     * Attempt to reconnect with exponential backoff
     */
    attemptReconnect() {
        if (this.isReconnecting || this.reconnectAttempts >= this.maxReconnectAttempts) {
            if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                this.emitError(new Error(`Max reconnection attempts (${this.maxReconnectAttempts}) reached`));
            }
            return;
        }
        this.isReconnecting = true;
        this.reconnectAttempts++;
        const delay = this.reconnectDelay * Math.pow(2, this.reconnectAttempts - 1); // Exponential backoff
        console.log(`ðŸ”„ Attempting to reconnect to Binance WebSocket (attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts}) in ${delay}ms`);
        setTimeout(() => {
            this.connect();
            this.emitReconnect();
        }, delay);
    }
    /**
     * Setup heartbeat to detect connection issues
     */
    setupHeartbeat() {
        this.heartbeatInterval = setInterval(() => {
            if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                // Check if we received a pong recently
                const timeSinceLastPong = Date.now() - this.lastPongTime;
                if (timeSinceLastPong > 30000) { // 30 seconds timeout
                    console.warn('âš ï¸ Binance WebSocket heartbeat timeout, closing connection');
                    this.ws.close();
                    return;
                }
                // Send ping
                this.ws.ping();
            }
        }, 20000); // Ping every 20 seconds
    }
    /**
     * Emit error to all error callbacks
     */
    emitError(error) {
        this.errorCallbacks.forEach(callback => {
            try {
                callback(error);
            }
            catch (callbackError) {
                console.error('Error in error callback:', callbackError);
            }
        });
    }
    /**
     * Emit reconnect event to all reconnect callbacks
     */
    emitReconnect() {
        this.reconnectCallbacks.forEach(callback => {
            try {
                callback();
            }
            catch (callbackError) {
                console.error('Error in reconnect callback:', callbackError);
            }
        });
    }
}
exports.BinanceSpotClient = BinanceSpotClient;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLXBoYXNlMi1odW50ZXIvc3JjL2V4Y2hhbmdlcy9CaW5hbmNlU3BvdENsaWVudC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7R0FPRzs7O0FBRUgsZ0NBQWlDO0FBR2pDLGdFQUFnRTtBQUNoRSxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7QUF5QnBDLE1BQWEsaUJBQWlCO0lBQ3BCLEVBQUUsR0FBcUIsSUFBSSxDQUFDO0lBQzVCLE9BQU8sR0FBRyx5QkFBeUIsQ0FBQztJQUNwQyxLQUFLLEdBQUcsa0NBQWtDLENBQUM7SUFDM0MsYUFBYSxHQUFHLElBQUksR0FBRyxFQUE4QixDQUFDO0lBQ3RELGlCQUFpQixHQUFHLENBQUMsQ0FBQztJQUN0QixvQkFBb0IsR0FBRyxDQUFDLENBQUM7SUFDekIsY0FBYyxHQUFHLElBQUksQ0FBQyxDQUFDLFlBQVk7SUFDbkMsY0FBYyxHQUFHLEtBQUssQ0FBQztJQUN2QixpQkFBaUIsR0FBMEIsSUFBSSxDQUFDO0lBQ2hELFlBQVksR0FBRyxDQUFDLENBQUM7SUFDakIsYUFBYSxHQUFHLEtBQUssQ0FBQztJQUU5QixZQUFZO0lBQ0osY0FBYyxHQUFHLElBQUksR0FBRyxFQUFpQixDQUFDO0lBQzFDLGtCQUFrQixHQUFHLElBQUksR0FBRyxFQUFxQixDQUFDO0lBRTFEO1FBQ0UsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO0lBQ3hCLENBQUM7SUFFRDs7O09BR0c7SUFDSSxLQUFLLENBQUMsVUFBVTtRQUNyQixJQUFJLElBQUksQ0FBQyxhQUFhLEVBQUUsQ0FBQztZQUN2QixPQUFPO1FBQ1QsQ0FBQztRQUVELElBQUksQ0FBQztZQUNILE9BQU8sQ0FBQyxHQUFHLENBQUMsd0NBQXdDLENBQUMsQ0FBQztZQUV0RCwwQ0FBMEM7WUFDMUMsTUFBTSxRQUFRLEdBQUcsTUFBTSxLQUFLLENBQUMsR0FBRyxJQUFJLENBQUMsT0FBTyxjQUFjLENB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LENBQUMsQ0FBQztvQkFDM0UsSUFBSSxDQUFDLEVBQUUsQ0FBQyxLQUFLLEVBQUUsQ0FBQztvQkFDaEIsT0FBTztnQkFDVCxDQUFDO2dCQUVELFlBQVk7Z0JBQ1osSUFBSSxDQUFDLEVBQUUsQ0FBQyxJQUFJLEVBQUUsQ0FBQztZQUNqQixDQUFDO1FBQ0gsQ0FBQyxFQUFFLEtBQUssQ0FBQyxDQUFDLENBQUMsd0JBQXdCO0lBQ3JDLENBQUM7SUFFRDs7T0FFRztJQUNLLFNBQVMsQ0FBQyxLQUFZO1FBQzVCLElBQUksQ0FBQyxjQUFjLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQ3JDLElBQUksQ0FBQztnQkFDSCxRQUFRLENBQUMsS0FBSyxDQUFDLENBQUM7WUFDbEIsQ0FBQztZQUFDLE9BQU8sYUFBYSxFQUFFLENBQUM7Z0JBQ3ZCLE9BQU8sQ0FBQyxLQUFLLENBQUMsMEJBQTBCLEVBQUUsYUFBYSxDQUFDLENBQUM7WUFDM0QsQ0FBQztRQUNILENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQztJQUVEOztPQUVHO0lBQ0ssYUFBYTtRQUNuQixJQUFJLENBQUMsa0JBQWtCLENBQUMsT0FBTyxDQUFDLFFBQVEsQ0FBQyxFQUFFO1lBQ3pDLElBQUksQ0FBQztnQkFDSCxRQUFRLEVBQUUsQ0FBQztZQUNiLENBQUM7WUFBQyxPQUFPLGFBQWEsRUFBRSxDQUFDO2dCQUN2QixPQUFPLENBQUMsS0FBSyxDQUFDLDhCQUE4QixFQUFFLGFBQWEsQ0FBQyxDQUFDO1lBQy9ELENBQUM7UUFDSCxDQUFDLENBQUMsQ0FBQztJQUNMLENBQUM7Q0FDRjtBQTlaRCw4Q0E4WkMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLXBoYXNlMi1odW50ZXIvc3JjL2V4Y2hhbmdlcy9CaW5hbmNlU3BvdENsaWVudC50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEJpbmFuY2UgU3BvdCBDbGllbnQgZm9yIENWRCBEYXRhIFNvdXJjZVxuICogXG4gKiBQcm92aWRlcyB0aWNrLWxldmVsIHRyYWRlIGRhdGEgdmlhIFdlYlNvY2tldCBmb3IgQ3VtdWxhdGl2ZSBWb2x1bWUgRGVsdGEgY2FsY3VsYXRpb24uXG4gKiBJbmNsdWRlcyByZWNvbm5lY3Rpb24gbG9naWMgYW5kIGNhbGxiYWNrIHN5c3RlbSBmb3IgdHJhZGUgZXZlbnRzLlxuICogXG4gKiBSZXF1aXJlbWVudHM6IDQuMSAoQ1ZEIE1vbml0b3JpbmcpXG4gKi9cblxuaW1wb3J0IFdlYlNvY2tldCA9IHJlcXVpcmUoJ3dzJyk7XG5pbXBvcnQgeyBUcmFkZSB9IGZyb20gJy4uL3R5cGVzJztcblxuLy8gVXNlIHJlcXVpcmUgZm9yIG5vZGUtZmV0Y2ggdG8gYXZvaWQgRVMgbW9kdWxlcyBpc3N1ZXMgaW4gSmVzdFxuY29uc3QgZmV0Y2ggPSByZXF1aXJlKCdub2RlLWZldGNoJyk7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQmluYW5jZUFnZ1RyYWRlIHtcbiAgZTogc3RyaW5nOyAgICAgIC8vIEV2ZW50IHR5cGVcbiAgRTogbnVtYmVyOyAgICAgIC8vIEV2ZW50IHRpbWVcbiAgczogc3RyaW5nOyAgICAgIC8vIFN5bWJvbFxuICBhOiBudW1iZXI7ICAgICAgLy8gQWdncmVnYXRlIHRyYWRlIElEXG4gIHA6IHN0cmluZzsgICAgICAvLyBQcmljZVxuICBxOiBzdHJpbmc7ICAgICAgLy8gUXVhbnRpdHlcbiAgZjogbnVtYmVyOyAgICAgIC8vIEZpcnN0IHRyYWRlIElEXG4gIGw6IG51bWJlcjsgICAgICAvLyBMYXN0IHRyYWRlIElEXG4gIFQ6IG51bWJlcjsgICAgICAvLyBUcmFkZSB0aW1lXG4gIG06IGJvb2xlYW47ICAgICAvLyBJcyB0aGUgYnV5ZXIgdGhlIG1hcmtldCBtYWtlcj9cbiAgTTogYm9vbGVhbjsgICAgIC8vIElnbm9yZVxufVxuXG5leHBvcnQgaW50ZXJmYWNlIEJpbmFuY2VTcG90UHJpY2Uge1xuICBzeW1ib2w6IHN0cmluZztcbiAgcHJpY2U6IHN0cmluZztcbn1cblxuZXhwb3J0IHR5cGUgVHJhZGVDYWxsYmFjayA9ICh0cmFkZTogVHJhZGUpID0+IHZvaWQ7XG5leHBvcnQgdHlwZSBFcnJvckNhbGxiYWNrID0gKGVycm9yOiBFcnJvcikgPT4gdm9pZDtcbmV4cG9ydCB0eXBlIFJlY29ubmVjdENhbGxiYWNrID0gKCkgPT4gdm9pZDtcblxuZXhwb3J0IGNsYXNzIEJpbmFuY2VTcG90Q2xpZW50IHtcbiAgcHJpdmF0ZSB3czogV2ViU29ja2V0IHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgYmFzZVVybCA9ICdodHRwczovL2FwaS5iaW5hbmNlLmNvbSc7XG4gIHByaXZhdGUgd3NVcmwgPSAnd3NzOi8vc3RyZWFtLmJpbmFuY2UuY29tOjk0NDMvd3MnO1xuICBwcml2YXRlIHN1YnNjcmlwdGlvbnMgPSBuZXcgTWFwPHN0cmluZywgU2V0PFRyYWRlQ2FsbGJhY2s+PigpO1xuICBwcml2YXRlIHJlY29ubmVjdEF0dGVtcHRzID0gMDtcbiAgcHJpdmF0ZSBtYXhSZWNvbm5lY3RBdHRlbXB0cyA9IDM7XG4gIHByaXZhdGUgcmVjb25uZWN0RGVsYXkgPSAyMDAwOyAvLyAyIHNlY29uZHNcbiAgcHJpdmF0ZSBpc1JlY29ubmVjdGluZyA9IGZhbHNlO1xuICBwcml2YXRlIGhlYXJ0YmVhdEludGVydmFsOiBOb2RlSlMuVGltZW91dCB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIGxhc3RQb25nVGltZSA9IDA7XG4gIHByaXZhdGUgaXNJbml0aWFsaXplZCA9IGZhbHNlO1xuICBcbiAgLy8gQ2FsbGJhY2tzXG4gIHByaXZhdGUgZXJyb3JDYWxsYmFja3MgPSBuZXcgU2V0PEVycm9yQ2FsbGJhY2s+KCk7XG4gIHByaXZhdGUgcmVjb25uZWN0Q2FsbGJhY2tzID0gbmV3IFNldDxSZWNvbm5lY3RDYWxsYmFjaz4oKTtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLnNldHVwSGVhcnRiZWF0KCk7XG4gIH1cblxuICAvKipcbiAgICogSW5pdGlhbGl6ZSB0aGUgQmluYW5jZSBjbGllbnRcbiAgICogVGVzdHMgY29ubmVjdGlvbiBhbmQgcHJlcGFyZXMgV2ViU29ja2V0XG4gICAqL1xuICBwdWJsaWMgYXN5bmMgaW5pdGlhbGl6ZSgpOiBQcm9taXNlPHZvaWQ+IHtcbiAgICBpZiAodGhpcy5pc0luaXRpYWxpemVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnNvbGUubG9nKCfwn5OhIEluaXRpYWxpemluZyBCaW5hbmNlIFNwb3QgQ2xpZW50Li4uJyk7XG4gICAgICBcbiAgICAgIC8vIFRlc3QgY29ubmVjdGlvbiBieSBmZXRjaGluZyBzZXJ2ZXIgdGltZVxuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChgJHt0aGlzLmJhc2VVcmx9L2FwaS92My90aW1lYCk7XG4gICAgICBpZiAoIXJlc3BvbnNlLm9rKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgSFRUUCAke3Jlc3BvbnNlLnN0YXR1c306ICR7cmVzcG9uc2Uuc3RhdHVzVGV4dH1gKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgdGhpcy5pc0luaXRpYWxpemVkID0gdHJ1ZTtcbiAgICAgIGNvbnNvbGUubG9nKCfinIUgQmluYW5jZSBTcG90IENsaWVudCBpbml0aWFsaXplZCcpO1xuICAgICAgXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBGYWlsZWQgdG8gaW5pdGlhbGl6ZSBCaW5hbmNlIGNsaWVudDonLCBlcnJvcik7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRGlzY29ubmVjdCBhbmQgY2xlYW51cCB0aGUgQmluYW5jZSBjbGllbnRcbiAgICovXG4gIHB1YmxpYyBhc3luYyBkaXNjb25uZWN0KCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICghdGhpcy5pc0luaXRpYWxpemVkKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIGNvbnNvbGUubG9nKCfwn5OhIERpc2Nvbm5lY3RpbmcgQmluYW5jZSBTcG90IENsaWVudC4uLicpO1xuICAgICAgXG4gICAgICAvLyBDbG9zZSBXZWJTb2NrZXQgY29ubmVjdGlvblxuICAgICAgaWYgKHRoaXMud3MpIHtcbiAgICAgICAgdGhpcy53cy5jbG9zZSgpO1xuICAgICAgICB0aGlzLndzID0gbnVsbDtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgLy8gQ2xlYXIgaGVhcnRiZWF0IGludGVydmFsXG4gICAgICBpZiAodGhpcy5oZWFydGJlYXRJbnRlcnZhbCkge1xuICAgICAgICBjbGVhckludGVydmFsKHRoaXMuaGVhcnRiZWF0SW50ZXJ2YWwpO1xuICAgICAgICB0aGlzLmhlYXJ0YmVhdEludGVydmFsID0gbnVsbDtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgLy8gQ2xlYXIgc3Vic2NyaXB0aW9uc1xuICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLmNsZWFyKCk7XG4gICAgICB0aGlzLmVycm9yQ2FsbGJhY2tzLmNsZWFyKCk7XG4gICAgICB0aGlzLnJlY29ubmVjdENhbGxiYWNrcy5jbGVhcigpO1xuICAgICAgXG4gICAgICB0aGlzLmlzSW5pdGlhbGl6ZWQgPSBmYWxzZTtcbiAgICAgIGNvbnNvbGUubG9nKCfinIUgQmluYW5jZSBTcG90IENsaWVudCBkaXNjb25uZWN0ZWQnKTtcbiAgICAgIFxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCfinYwgRXJyb3IgZGlzY29ubmVjdGluZyBCaW5hbmNlIGNsaWVudDonLCBlcnJvcik7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU3Vic2NyaWJlIHRvIGFnZ3JlZ2F0ZSB0cmFkZXMgZm9yIGEgc3ltYm9sXG4gICAqIEBwYXJhbSBzeW1ib2wgLSBUcmFkaW5nIHN5bWJvbCAoZS5nLiwgJ0JUQ1VTRFQnKVxuICAgKiBAcGFyYW0gY2FsbGJhY2sgLSBDYWxsYmFjayBmdW5jdGlvbiBmb3IgdHJhZGUgZXZlbnRzXG4gICAqL1xuICBwdWJsaWMgc3Vic2NyaWJlQWdnVHJhZGVzKHN5bWJvbDogc3RyaW5nLCBjYWxsYmFjazogVHJhZGVDYWxsYmFjayk6IHZvaWQge1xuICAgIGNvbnN0IG5vcm1hbGl6ZWRTeW1ib2wgPSBzeW1ib2wudG9Mb3dlckNhc2UoKTtcbiAgICBcbiAgICAvLyBBZGQgY2FsbGJhY2sgdG8gc3Vic2NyaXB0aW9uc1xuICAgIGlmICghdGhpcy5zdWJzY3JpcHRpb25zLmhhcyhub3JtYWxpemVkU3ltYm9sKSkge1xuICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLnNldChub3JtYWxpemVkU3ltYm9sLCBuZXcgU2V0KCkpO1xuICAgIH1cbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMuZ2V0KG5vcm1hbGl6ZWRTeW1ib2wpIS5hZGQoY2FsbGJhY2spO1xuXG4gICAgLy8gQ29ubmVjdCBXZWJTb2NrZXQgaWYgbm90IGFscmVhZHkgY29ubmVjdGVkXG4gICAgaWYgKCF0aGlzLndzIHx8IHRoaXMud3MucmVhZHlTdGF0ZSAhPT0gV2ViU29ja2V0Lk9QRU4pIHtcbiAgICAgIHRoaXMuY29ubmVjdCgpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBTdWJzY3JpYmUgdG8gdGhlIHN0cmVhbSBpZiBXZWJTb2NrZXQgaXMgYWxyZWFkeSBvcGVuXG4gICAgICB0aGlzLnN1YnNjcmliZVRvU3RyZWFtKG5vcm1hbGl6ZWRTeW1ib2wpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBVbnN1YnNjcmliZSBmcm9tIGFnZ3JlZ2F0ZSB0cmFkZXMgZm9yIGEgc3ltYm9sXG4gICAqIEBwYXJhbSBzeW1ib2wgLSBUcmFkaW5nIHN5bWJvbFxuICAgKiBAcGFyYW0gY2FsbGJhY2sgLSBDYWxsYmFjayBmdW5jdGlvbiB0byByZW1vdmVcbiAgICovXG4gIHB1YmxpYyB1bnN1YnNjcmliZUFnZ1RyYWRlcyhzeW1ib2w6IHN0cmluZywgY2FsbGJhY2s6IFRyYWRlQ2FsbGJhY2spOiB2b2lkIHtcbiAgICBjb25zdCBub3JtYWxpemVkU3ltYm9sID0gc3ltYm9sLnRvTG93ZXJDYXNlKCk7XG4gICAgY29uc3QgY2FsbGJhY2tzID0gdGhpcy5zdWJzY3JpcHRpb25zLmdldChub3JtYWxpemVkU3ltYm9sKTtcbiAgICBcbiAgICBpZiAoY2FsbGJhY2tzKSB7XG4gICAgICBjYWxsYmFja3MuZGVsZXRlKGNhbGxiYWNrKTtcbiAgICAgIFxuICAgICAgLy8gSWYgbm8gbW9yZSBjYWxsYmFja3MgZm9yIHRoaXMgc3ltYm9sLCB1bnN1YnNjcmliZSBmcm9tIHN0cmVhbVxuICAgICAgaWYgKGNhbGxiYWNrcy5zaXplID09PSAwKSB7XG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5kZWxldGUobm9ybWFsaXplZFN5bWJvbCk7XG4gICAgICAgIHRoaXMudW5zdWJzY3JpYmVGcm9tU3RyZWFtKG5vcm1hbGl6ZWRTeW1ib2wpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY3VycmVudCBzcG90IHByaWNlIGZvciBhIHN5bWJvbCB2aWEgUkVTVCBBUElcbiAgICogQHBhcmFtIHN5bWJvbCAtIFRyYWRpbmcgc3ltYm9sIChlLmcuLCAnQlRDVVNEVCcpXG4gICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCBjdXJyZW50IHByaWNlXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgZ2V0U3BvdFByaWNlKHN5bWJvbDogc3RyaW5nKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChgJHt0aGlzLmJhc2VVcmx9L2FwaS92My90aWNrZXIvcHJpY2U/c3ltYm9sPSR7c3ltYm9sLnRvVXBwZXJDYXNlKCl9YCk7XG4gICAgICBcbiAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBIVFRQICR7cmVzcG9uc2Uuc3RhdHVzfTogJHtyZXNwb25zZS5zdGF0dXNUZXh0fWApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuanNvbigpIGFzIEJpbmFuY2VTcG90UHJpY2U7XG4gICAgICByZXR1cm4gcGFyc2VGbG9hdChkYXRhLnByaWNlKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc3QgZXJyb3JNc2cgPSBgRmFpbGVkIHRvIGdldCBzcG90IHByaWNlIGZvciAke3N5bWJvbH06ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcid9YDtcbiAgICAgIHRoaXMuZW1pdEVycm9yKG5ldyBFcnJvcihlcnJvck1zZykpO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yTXNnKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQWRkIGVycm9yIGNhbGxiYWNrXG4gICAqIEBwYXJhbSBjYWxsYmFjayAtIEVycm9yIGNhbGxiYWNrIGZ1bmN0aW9uXG4gICAqL1xuICBwdWJsaWMgb25FcnJvcihjYWxsYmFjazogRXJyb3JDYWxsYmFjayk6IHZvaWQge1xuICAgIHRoaXMuZXJyb3JDYWxsYmFja3MuYWRkKGNhbGxiYWNrKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgcmVjb25uZWN0IGNhbGxiYWNrXG4gICAqIEBwYXJhbSBjYWxsYmFjayAtIFJlY29ubmVjdCBjYWxsYmFjayBmdW5jdGlvblxuICAgKi9cbiAgcHVibGljIG9uUmVjb25uZWN0KGNhbGxiYWNrOiBSZWNvbm5lY3RDYWxsYmFjayk6IHZvaWQge1xuICAgIHRoaXMucmVjb25uZWN0Q2FsbGJhY2tzLmFkZChjYWxsYmFjayk7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIGVycm9yIGNhbGxiYWNrXG4gICAqIEBwYXJhbSBjYWxsYmFjayAtIEVycm9yIGNhbGxiYWNrIGZ1bmN0aW9uIHRvIHJlbW92ZVxuICAgKi9cbiAgcHVibGljIHJlbW92ZUVycm9yQ2FsbGJhY2soY2FsbGJhY2s6IEVycm9yQ2FsbGJhY2spOiB2b2lkIHtcbiAgICB0aGlzLmVycm9yQ2FsbGJhY2tzLmRlbGV0ZShjYWxsYmFjayk7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIHJlY29ubmVjdCBjYWxsYmFja1xuICAgKiBAcGFyYW0gY2FsbGJhY2sgLSBSZWNvbm5lY3QgY2FsbGJhY2sgZnVuY3Rpb24gdG8gcmVtb3ZlXG4gICAqL1xuICBwdWJsaWMgcmVtb3ZlUmVjb25uZWN0Q2FsbGJhY2soY2FsbGJhY2s6IFJlY29ubmVjdENhbGxiYWNrKTogdm9pZCB7XG4gICAgdGhpcy5yZWNvbm5lY3RDYWxsYmFja3MuZGVsZXRlKGNhbGxiYWNrKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY29ubmVjdGlvbiBzdGF0dXNcbiAgICogQHJldHVybnMgV2ViU29ja2V0IHJlYWR5IHN0YXRlXG4gICAqL1xuICBwdWJsaWMgZ2V0Q29ubmVjdGlvblN0YXR1cygpOiAnQ09OTkVDVElORycgfCAnT1BFTicgfCAnQ0xPU0lORycgfCAnQ0xPU0VEJyB7XG4gICAgaWYgKCF0aGlzLndzKSByZXR1cm4gJ0NMT1NFRCc7XG4gICAgXG4gICAgc3dpdGNoICh0aGlzLndzLnJlYWR5U3RhdGUpIHtcbiAgICAgIGNhc2UgV2ViU29ja2V0LkNPTk5FQ1RJTkc6IHJldHVybiAnQ09OTkVDVElORyc7XG4gICAgICBjYXNlIFdlYlNvY2tldC5PUEVOOiByZXR1cm4gJ09QRU4nO1xuICAgICAgY2FzZSBXZWJTb2NrZXQuQ0xPU0lORzogcmV0dXJuICdDTE9TSU5HJztcbiAgICAgIGNhc2UgV2ViU29ja2V0LkNMT1NFRDogcmV0dXJuICdDTE9TRUQnO1xuICAgICAgZGVmYXVsdDogcmV0dXJuICdDTE9TRUQnO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDbG9zZSBXZWJTb2NrZXQgY29ubmVjdGlvbiBhbmQgY2xlYW51cFxuICAgKi9cbiAgcHVibGljIGNsb3NlKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmhlYXJ0YmVhdEludGVydmFsKSB7XG4gICAgICBjbGVhckludGVydmFsKHRoaXMuaGVhcnRiZWF0SW50ZXJ2YWwpO1xuICAgICAgdGhpcy5oZWFydGJlYXRJbnRlcnZhbCA9IG51bGw7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMud3MpIHtcbiAgICAgIHRoaXMud3MuY2xvc2UoKTtcbiAgICAgIHRoaXMud3MgPSBudWxsO1xuICAgIH1cblxuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5jbGVhcigpO1xuICAgIHRoaXMuZXJyb3JDYWxsYmFja3MuY2xlYXIoKTtcbiAgICB0aGlzLnJlY29ubmVjdENhbGxiYWNrcy5jbGVhcigpO1xuICAgIHRoaXMucmVjb25uZWN0QXR0ZW1wdHMgPSAwO1xuICAgIHRoaXMuaXNSZWNvbm5lY3RpbmcgPSBmYWxzZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb25uZWN0IHRvIEJpbmFuY2UgV2ViU29ja2V0XG4gICAqL1xuICBwcml2YXRlIGNvbm5lY3QoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaXNSZWNvbm5lY3RpbmcpIHJldHVybjtcblxuICAgIHRyeSB7XG4gICAgICAvLyBCdWlsZCBzdHJlYW0gVVJMIHdpdGggYWxsIHN1YnNjcmliZWQgc3ltYm9sc1xuICAgICAgY29uc3Qgc3RyZWFtcyA9IEFycmF5LmZyb20odGhpcy5zdWJzY3JpcHRpb25zLmtleXMoKSkubWFwKHN5bWJvbCA9PiBgJHtzeW1ib2x9QGFnZ1RyYWRlYCk7XG4gICAgICBjb25zdCBzdHJlYW1VcmwgPSBzdHJlYW1zLmxlbmd0aCA+IDAgXG4gICAgICAgID8gYCR7dGhpcy53c1VybH0vJHtzdHJlYW1zLmpvaW4oJy8nKX1gXG4gICAgICAgIDogdGhpcy53c1VybDtcblxuICAgICAgdGhpcy53cyA9IG5ldyBXZWJTb2NrZXQoc3RyZWFtVXJsKTtcbiAgICAgIHRoaXMubGFzdFBvbmdUaW1lID0gRGF0ZS5ub3coKTtcblxuICAgICAgdGhpcy53cy5vbignb3BlbicsICgpID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coJ/CflJcgQmluYW5jZSBXZWJTb2NrZXQgY29ubmVjdGVkJyk7XG4gICAgICAgIHRoaXMucmVjb25uZWN0QXR0ZW1wdHMgPSAwO1xuICAgICAgICB0aGlzLmlzUmVjb25uZWN0aW5nID0gZmFsc2U7XG4gICAgICAgIFxuICAgICAgICAvLyBTdWJzY3JpYmUgdG8gYWxsIGV4aXN0aW5nIHN5bWJvbHNcbiAgICAgICAgQXJyYXkuZnJvbSh0aGlzLnN1YnNjcmlwdGlvbnMua2V5cygpKS5mb3JFYWNoKHN5bWJvbCA9PiB7XG4gICAgICAgICAgdGhpcy5zdWJzY3JpYmVUb1N0cmVhbShzeW1ib2wpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLndzLm9uKCdtZXNzYWdlJywgKGRhdGE6IFdlYlNvY2tldC5EYXRhKSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgY29uc3QgbWVzc2FnZSA9IEpTT04ucGFyc2UoZGF0YS50b1N0cmluZygpKTtcbiAgICAgICAgICB0aGlzLmhhbmRsZU1lc3NhZ2UobWVzc2FnZSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgdGhpcy5lbWl0RXJyb3IobmV3IEVycm9yKGBGYWlsZWQgdG8gcGFyc2UgV2ViU29ja2V0IG1lc3NhZ2U6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcid9YCkpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgdGhpcy53cy5vbigncG9uZycsICgpID0+IHtcbiAgICAgICAgdGhpcy5sYXN0UG9uZ1RpbWUgPSBEYXRlLm5vdygpO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMud3Mub24oJ2Vycm9yJywgKGVycm9yOiBFcnJvcikgPT4ge1xuICAgICAgICBjb25zb2xlLmVycm9yKCfinYwgQmluYW5jZSBXZWJTb2NrZXQgZXJyb3I6JywgZXJyb3IubWVzc2FnZSk7XG4gICAgICAgIHRoaXMuZW1pdEVycm9yKGVycm9yKTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLndzLm9uKCdjbG9zZScsIChjb2RlOiBudW1iZXIsIHJlYXNvbjogQnVmZmVyKSA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKGDwn5SMIEJpbmFuY2UgV2ViU29ja2V0IGNsb3NlZDogJHtjb2RlfSAke3JlYXNvbi50b1N0cmluZygpfWApO1xuICAgICAgICB0aGlzLndzID0gbnVsbDtcbiAgICAgICAgXG4gICAgICAgIC8vIEF0dGVtcHQgcmVjb25uZWN0aW9uIGlmIHdlIGhhdmUgYWN0aXZlIHN1YnNjcmlwdGlvbnNcbiAgICAgICAgaWYgKHRoaXMuc3Vic2NyaXB0aW9ucy5zaXplID4gMCAmJiAhdGhpcy5pc1JlY29ubmVjdGluZykge1xuICAgICAgICAgIHRoaXMuYXR0ZW1wdFJlY29ubmVjdCgpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmVtaXRFcnJvcihuZXcgRXJyb3IoYEZhaWxlZCB0byBjb25uZWN0IHRvIEJpbmFuY2UgV2ViU29ja2V0OiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InfWApKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU3Vic2NyaWJlIHRvIGEgc3BlY2lmaWMgc3RyZWFtICh1c2VkIHdoZW4gV2ViU29ja2V0IGlzIGFscmVhZHkgb3BlbilcbiAgICovXG4gIHByaXZhdGUgc3Vic2NyaWJlVG9TdHJlYW0oc3ltYm9sOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMud3MgfHwgdGhpcy53cy5yZWFkeVN0YXRlICE9PSBXZWJTb2NrZXQuT1BFTikgcmV0dXJuO1xuXG4gICAgY29uc3Qgc3Vic2NyaWJlTWVzc2FnZSA9IHtcbiAgICAgIG1ldGhvZDogJ1NVQlNDUklCRScsXG4gICAgICBwYXJhbXM6IFtgJHtzeW1ib2x9QGFnZ1RyYWRlYF0sXG4gICAgICBpZDogRGF0ZS5ub3coKVxuICAgIH07XG5cbiAgICB0aGlzLndzLnNlbmQoSlNPTi5zdHJpbmdpZnkoc3Vic2NyaWJlTWVzc2FnZSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFVuc3Vic2NyaWJlIGZyb20gYSBzcGVjaWZpYyBzdHJlYW1cbiAgICovXG4gIHByaXZhdGUgdW5zdWJzY3JpYmVGcm9tU3RyZWFtKHN5bWJvbDogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLndzIHx8IHRoaXMud3MucmVhZHlTdGF0ZSAhPT0gV2ViU29ja2V0Lk9QRU4pIHJldHVybjtcblxuICAgIGNvbnN0IHVuc3Vic2NyaWJlTWVzc2FnZSA9IHtcbiAgICAgIG1ldGhvZDogJ1VOU1VCU0NSSUJFJyxcbiAgICAgIHBhcmFtczogW2Ake3N5bWJvbH1AYWdnVHJhZGVgXSxcbiAgICAgIGlkOiBEYXRlLm5vdygpXG4gICAgfTtcblxuICAgIHRoaXMud3Muc2VuZChKU09OLnN0cmluZ2lmeSh1bnN1YnNjcmliZU1lc3NhZ2UpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBIYW5kbGUgaW5jb21pbmcgV2ViU29ja2V0IG1lc3NhZ2VzXG4gICAqL1xuICBwcml2YXRlIGhhbmRsZU1lc3NhZ2UobWVzc2FnZTogYW55KTogdm9pZCB7XG4gICAgLy8gSGFuZGxlIGFnZ3JlZ2F0ZSB0cmFkZSBkYXRhXG4gICAgaWYgKG1lc3NhZ2UuZSA9PT0gJ2FnZ1RyYWRlJykge1xuICAgICAgY29uc3QgYWdnVHJhZGUgPSBtZXNzYWdlIGFzIEJpbmFuY2VBZ2dUcmFkZTtcbiAgICAgIGNvbnN0IHRyYWRlOiBUcmFkZSA9IHtcbiAgICAgICAgcHJpY2U6IHBhcnNlRmxvYXQoYWdnVHJhZGUucCksXG4gICAgICAgIHF1YW50aXR5OiBwYXJzZUZsb2F0KGFnZ1RyYWRlLnEpLFxuICAgICAgICBzaWRlOiBhZ2dUcmFkZS5tID8gJ1NFTEwnIDogJ0JVWScsIC8vIG09dHJ1ZSBtZWFucyBidXllciBpcyBtYXJrZXQgbWFrZXIgKHNlbGwgb3JkZXIgZmlsbGVkKVxuICAgICAgICB0aW1lc3RhbXA6IGFnZ1RyYWRlLlQsXG4gICAgICAgIGlzQnV5ZXJNYWtlcjogYWdnVHJhZGUubSAvLyB0cnVlID0gc2VsbCBvcmRlciBoaXQgYnV5IGxpbWl0LCBmYWxzZSA9IGJ1eSBvcmRlciBoaXQgc2VsbCBsaW1pdFxuICAgICAgfTtcblxuICAgICAgLy8gRW1pdCB0byBhbGwgY2FsbGJhY2tzIGZvciB0aGlzIHN5bWJvbFxuICAgICAgY29uc3QgY2FsbGJhY2tzID0gdGhpcy5zdWJzY3JpcHRpb25zLmdldChhZ2dUcmFkZS5zLnRvTG93ZXJDYXNlKCkpO1xuICAgICAgaWYgKGNhbGxiYWNrcykge1xuICAgICAgICBjYWxsYmFja3MuZm9yRWFjaChjYWxsYmFjayA9PiB7XG4gICAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNhbGxiYWNrKHRyYWRlKTtcbiAgICAgICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgdGhpcy5lbWl0RXJyb3IobmV3IEVycm9yKGBUcmFkZSBjYWxsYmFjayBlcnJvcjogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJ31gKSk7XG4gICAgICAgICAgfVxuICAgICAgICB9KTtcbiAgICAgIH1cbiAgICB9XG4gICAgXG4gICAgLy8gSGFuZGxlIHN1YnNjcmlwdGlvbiBjb25maXJtYXRpb25zIGFuZCBlcnJvcnNcbiAgICBpZiAobWVzc2FnZS5yZXN1bHQgPT09IG51bGwgJiYgbWVzc2FnZS5pZCkge1xuICAgICAgLy8gU3Vic2NyaXB0aW9uIHN1Y2Nlc3NmdWxcbiAgICAgIGNvbnNvbGUubG9nKGDinIUgQmluYW5jZSBzdWJzY3JpcHRpb24gY29uZmlybWVkOiAke21lc3NhZ2UuaWR9YCk7XG4gICAgfSBlbHNlIGlmIChtZXNzYWdlLmVycm9yKSB7XG4gICAgICB0aGlzLmVtaXRFcnJvcihuZXcgRXJyb3IoYEJpbmFuY2UgV2ViU29ja2V0IGVycm9yOiAke21lc3NhZ2UuZXJyb3IubXNnfWApKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQXR0ZW1wdCB0byByZWNvbm5lY3Qgd2l0aCBleHBvbmVudGlhbCBiYWNrb2ZmXG4gICAqL1xuICBwcml2YXRlIGF0dGVtcHRSZWNvbm5lY3QoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaXNSZWNvbm5lY3RpbmcgfHwgdGhpcy5yZWNvbm5lY3RBdHRlbXB0cyA+PSB0aGlzLm1heFJlY29ubmVjdEF0dGVtcHRzKSB7XG4gICAgICBpZiAodGhpcy5yZWNvbm5lY3RBdHRlbXB0cyA+PSB0aGlzLm1heFJlY29ubmVjdEF0dGVtcHRzKSB7XG4gICAgICAgIHRoaXMuZW1pdEVycm9yKG5ldyBFcnJvcihgTWF4IHJlY29ubmVjdGlvbiBhdHRlbXB0cyAoJHt0aGlzLm1heFJlY29ubmVjdEF0dGVtcHRzfSkgcmVhY2hlZGApKTtcbiAgICAgIH1cbiAgICAgIHJldHVybjtcbiAgICB9XG5cbiAgICB0aGlzLmlzUmVjb25uZWN0aW5nID0gdHJ1ZTtcbiAgICB0aGlzLnJlY29ubmVjdEF0dGVtcHRzKys7XG5cbiAgICBjb25zdCBkZWxheSA9IHRoaXMucmVjb25uZWN0RGVsYXkgKiBNYXRoLnBvdygyLCB0aGlzLnJlY29ubmVjdEF0dGVtcHRzIC0gMSk7IC8vIEV4cG9uZW50aWFsIGJhY2tvZmZcbiAgICBjb25zb2xlLmxvZyhg8J+UhCBBdHRlbXB0aW5nIHRvIHJlY29ubmVjdCB0byBCaW5hbmNlIFdlYlNvY2tldCAoYXR0ZW1wdCAke3RoaXMucmVjb25uZWN0QXR0ZW1wdHN9LyR7dGhpcy5tYXhSZWNvbm5lY3RBdHRlbXB0c30pIGluICR7ZGVsYXl9bXNgKTtcblxuICAgIHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgdGhpcy5jb25uZWN0KCk7XG4gICAgICB0aGlzLmVtaXRSZWNvbm5lY3QoKTtcbiAgICB9LCBkZWxheSk7XG4gIH1cblxuICAvKipcbiAgICogU2V0dXAgaGVhcnRiZWF0IHRvIGRldGVjdCBjb25uZWN0aW9uIGlzc3Vlc1xuICAgKi9cbiAgcHJpdmF0ZSBzZXR1cEhlYXJ0YmVhdCgpOiB2b2lkIHtcbiAgICB0aGlzLmhlYXJ0YmVhdEludGVydmFsID0gc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgaWYgKHRoaXMud3MgJiYgdGhpcy53cy5yZWFkeVN0YXRlID09PSBXZWJTb2NrZXQuT1BFTikge1xuICAgICAgICAvLyBDaGVjayBpZiB3ZSByZWNlaXZlZCBhIHBvbmcgcmVjZW50bHlcbiAgICAgICAgY29uc3QgdGltZVNpbmNlTGFzdFBvbmcgPSBEYXRlLm5vdygpIC0gdGhpcy5sYXN0UG9uZ1RpbWU7XG4gICAgICAgIGlmICh0aW1lU2luY2VMYXN0UG9uZyA+IDMwMDAwKSB7IC8vIDMwIHNlY29uZHMgdGltZW91dFxuICAgICAgICAgIGNvbnNvbGUud2Fybign4pqg77iPIEJpbmFuY2UgV2ViU29ja2V0IGhlYXJ0YmVhdCB0aW1lb3V0LCBjbG9zaW5nIGNvbm5lY3Rpb24nKTtcbiAgICAgICAgICB0aGlzLndzLmNsb3NlKCk7XG4gICAgICAgICAgcmV0dXJuO1xuICAgICAgICB9XG5cbiAgICAgICAgLy8gU2VuZCBwaW5nXG4gICAgICAgIHRoaXMud3MucGluZygpO1xuICAgICAgfVxuICAgIH0sIDIwMDAwKTsgLy8gUGluZyBldmVyeSAyMCBzZWNvbmRzXG4gIH1cblxuICAvKipcbiAgICogRW1pdCBlcnJvciB0byBhbGwgZXJyb3IgY2FsbGJhY2tzXG4gICAqL1xuICBwcml2YXRlIGVtaXRFcnJvcihlcnJvcjogRXJyb3IpOiB2b2lkIHtcbiAgICB0aGlzLmVycm9yQ2FsbGJhY2tzLmZvckVhY2goY2FsbGJhY2sgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY2FsbGJhY2soZXJyb3IpO1xuICAgICAgfSBjYXRjaCAoY2FsbGJhY2tFcnJvcikge1xuICAgICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBpbiBlcnJvciBjYWxsYmFjazonLCBjYWxsYmFja0Vycm9yKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxuXG4gIC8qKlxuICAgKiBFbWl0IHJlY29ubmVjdCBldmVudCB0byBhbGwgcmVjb25uZWN0IGNhbGxiYWNrc1xuICAgKi9cbiAgcHJpdmF0ZSBlbWl0UmVjb25uZWN0KCk6IHZvaWQge1xuICAgIHRoaXMucmVjb25uZWN0Q2FsbGJhY2tzLmZvckVhY2goY2FsbGJhY2sgPT4ge1xuICAgICAgdHJ5IHtcbiAgICAgICAgY2FsbGJhY2soKTtcbiAgICAgIH0gY2F0Y2ggKGNhbGxiYWNrRXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgaW4gcmVjb25uZWN0IGNhbGxiYWNrOicsIGNhbGxiYWNrRXJyb3IpO1xuICAgICAgfVxuICAgIH0pO1xuICB9XG59Il0sInZlcnNpb24iOjN9
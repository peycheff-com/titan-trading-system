{"file":"/Users/ivan/Code/trading/titan/services/titan-phase2-hunter/src/risk/PositionManager.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-phase2-hunter/src/risk/PositionManager.ts"],"sourcesContent":["/**\n * Position Manager for Titan Phase 2 - The Hunter\n * \n * Handles automated position management including:\n * - Move stop to breakeven at 1.5R profit\n * - Take partial profit at 2R profit (50% close)\n * - Update trailing stop with 1 ATR distance\n * - Tighten stop after 48h to 0.5 ATR\n * - Close position for stop/target hits\n * \n * Requirements: 12.1-12.7 (Position Management)\n */\n\nimport { EventEmitter } from 'events';\nimport { \n  Position, \n  PositionUpdate, \n  TrailingStopConfig, \n  PartialProfitConfig,\n  OrderParams,\n  OrderResult\n} from '../types';\nimport { BybitPerpsClient } from '../exchanges/BybitPerpsClient';\n\nexport interface PositionManagerConfig {\n  breakevenRLevel: number; // R level to move stop to breakeven (default: 1.5)\n  partialProfitRLevel: number; // R level to take partial profit (default: 2.0)\n  partialProfitPercentage: number; // Percentage to close at partial (default: 50)\n  trailingStopDistance: number; // ATR multiplier for trailing stop (default: 1.0)\n  tightenAfterHours: number; // Hours after which to tighten stop (default: 48)\n  tightenedStopDistance: number; // ATR multiplier for tightened stop (default: 0.5)\n}\n\nexport interface PositionManagerEvents {\n  'position:breakeven': (position: Position) => void;\n  'position:partial': (position: Position, closedQuantity: number) => void;\n  'position:trailing': (position: Position, newStopLoss: number) => void;\n  'position:tightened': (position: Position, newStopLoss: number) => void;\n  'position:closed': (position: Position, reason: 'STOP_HIT' | 'TARGET_HIT' | 'MANUAL') => void;\n  'position:error': (position: Position, error: Error) => void;\n}\n\nexport class PositionManager extends EventEmitter {\n  private positions: Map<string, Position> = new Map();\n  private config: PositionManagerConfig;\n  private bybitClient: BybitPerpsClient;\n  private updateInterval: NodeJS.Timeout | null = null;\n  private readonly UPDATE_FREQUENCY = 5000; // 5 seconds\n\n  constructor(bybitClient: BybitPerpsClient, config?: Partial<PositionManagerConfig>) {\n    super();\n    \n    this.bybitClient = bybitClient;\n    this.config = {\n      breakevenRLevel: 1.5,\n      partialProfitRLevel: 2.0,\n      partialProfitPercentage: 50,\n      trailingStopDistance: 1.0,\n      tightenAfterHours: 48,\n      tightenedStopDistance: 0.5,\n      ...config\n    };\n\n    // Start position monitoring\n    this.startMonitoring();\n  }\n\n  /**\n   * Add a new position to management\n   * @param position - Position to manage\n   */\n  public addPosition(position: Position): void {\n    this.positions.set(position.id, { ...position });\n    console.log(`üìä Position Manager: Added position ${position.id} (${position.symbol} ${position.side})`);\n  }\n\n  /**\n   * Remove a position from management\n   * @param positionId - Position ID to remove\n   */\n  public removePosition(positionId: string): void {\n    const position = this.positions.get(positionId);\n    if (position) {\n      this.positions.delete(positionId);\n      console.log(`üìä Position Manager: Removed position ${positionId}`);\n    }\n  }\n\n  /**\n   * Get all managed positions\n   * @returns Array of managed positions\n   */\n  public getPositions(): Position[] {\n    return Array.from(this.positions.values());\n  }\n\n  /**\n   * Get a specific position\n   * @param positionId - Position ID\n   * @returns Position or undefined\n   */\n  public getPosition(positionId: string): Position | undefined {\n    return this.positions.get(positionId);\n  }\n\n  /**\n   * Update position with current market data\n   * @param update - Position update data\n   */\n  public updatePosition(update: PositionUpdate): void {\n    const position = this.positions.get(update.id);\n    if (!position) return;\n\n    // Update current price and P&L\n    position.currentPrice = update.currentPrice;\n    position.unrealizedPnL = update.unrealizedPnL;\n\n    // Calculate current R value\n    const riskAmount = Math.abs(position.entryPrice - position.stopLoss) * position.quantity;\n    if (riskAmount > 0) {\n      position.rValue = update.unrealizedPnL / riskAmount;\n    }\n\n    // Update position in map\n    this.positions.set(update.id, position);\n\n    // Check for management actions\n    this.checkPositionManagement(position);\n  }\n\n  /**\n   * Move stop loss to breakeven at 1.5R profit\n   * @param position - Position to update\n   * @returns Promise with success status\n   */\n  public async moveStopToBreakeven(position: Position): Promise<boolean> {\n    try {\n      // Check if already at breakeven\n      if (Math.abs(position.stopLoss - position.entryPrice) < 0.01) {\n        return true; // Already at breakeven\n      }\n\n      // Check if position has reached 1.5R profit\n      if (position.rValue < this.config.breakevenRLevel) {\n        return false; // Not profitable enough yet\n      }\n\n      console.log(`üéØ Moving stop to breakeven for ${position.symbol} at ${position.rValue.toFixed(2)}R`);\n\n      // Set stop loss to entry price (breakeven)\n      const success = await this.bybitClient.setStopLoss(position.symbol, position.entryPrice);\n      \n      if (success) {\n        position.stopLoss = position.entryPrice;\n        this.positions.set(position.id, position);\n        this.emit('position:breakeven', position);\n        \n        console.log(`‚úÖ Stop moved to breakeven: ${position.symbol} @ ${position.entryPrice}`);\n        return true;\n      }\n\n      return false;\n    } catch (error) {\n      console.error(`‚ùå Failed to move stop to breakeven for ${position.symbol}:`, error);\n      this.emit('position:error', position, error as Error);\n      return false;\n    }\n  }\n\n  /**\n   * Take partial profit at 2R profit (50% close)\n   * @param position - Position to partially close\n   * @returns Promise with success status\n   */\n  public async takePartialProfit(position: Position): Promise<boolean> {\n    try {\n      // Check if position has reached 2R profit\n      if (position.rValue < this.config.partialProfitRLevel) {\n        return false; // Not profitable enough yet\n      }\n\n      // Check if partial profit already taken (quantity would be reduced)\n      const originalQuantity = position.quantity;\n      const partialQuantity = originalQuantity * (this.config.partialProfitPercentage / 100);\n\n      console.log(`üí∞ Taking partial profit for ${position.symbol} at ${position.rValue.toFixed(2)}R`);\n\n      // Place market order to close partial position\n      const orderParams: OrderParams = {\n        phase: 'phase2',\n        symbol: position.symbol,\n        side: position.side === 'LONG' ? 'Sell' : 'Buy',\n        type: 'MARKET',\n        qty: partialQuantity,\n        leverage: position.leverage\n      };\n\n      const result = await this.bybitClient.placeOrderWithRetry(orderParams);\n      \n      if (result.status === 'FILLED') {\n        // Update position quantity\n        position.quantity -= partialQuantity;\n        position.realizedPnL += (partialQuantity * (position.currentPrice - position.entryPrice));\n        \n        this.positions.set(position.id, position);\n        this.emit('position:partial', position, partialQuantity);\n        \n        console.log(`‚úÖ Partial profit taken: ${position.symbol} closed ${partialQuantity} at ${result.price}`);\n        return true;\n      }\n\n      return false;\n    } catch (error) {\n      console.error(`‚ùå Failed to take partial profit for ${position.symbol}:`, error);\n      this.emit('position:error', position, error as Error);\n      return false;\n    }\n  }\n\n  /**\n   * Update trailing stop with 1 ATR distance\n   * @param position - Position to update trailing stop\n   * @returns Promise with success status\n   */\n  public async updateTrailingStop(position: Position): Promise<boolean> {\n    try {\n      // Only trail if position is profitable\n      if (position.rValue <= 0) {\n        return false;\n      }\n\n      const atrDistance = position.atr * this.config.trailingStopDistance;\n      let newStopLoss: number;\n\n      if (position.side === 'LONG') {\n        // For long positions, trail stop up\n        newStopLoss = position.currentPrice - atrDistance;\n        \n        // Only update if new stop is higher than current stop\n        if (newStopLoss <= position.stopLoss) {\n          return false;\n        }\n      } else {\n        // For short positions, trail stop down\n        newStopLoss = position.currentPrice + atrDistance;\n        \n        // Only update if new stop is lower than current stop\n        if (newStopLoss >= position.stopLoss) {\n          return false;\n        }\n      }\n\n      console.log(`üìà Updating trailing stop for ${position.symbol}: ${position.stopLoss.toFixed(2)} ‚Üí ${newStopLoss.toFixed(2)}`);\n\n      // Set new stop loss\n      const success = await this.bybitClient.setStopLoss(position.symbol, newStopLoss);\n      \n      if (success) {\n        position.stopLoss = newStopLoss;\n        this.positions.set(position.id, position);\n        this.emit('position:trailing', position, newStopLoss);\n        \n        console.log(`‚úÖ Trailing stop updated: ${position.symbol} @ ${newStopLoss.toFixed(2)}`);\n        return true;\n      }\n\n      return false;\n    } catch (error) {\n      console.error(`‚ùå Failed to update trailing stop for ${position.symbol}:`, error);\n      this.emit('position:error', position, error as Error);\n      return false;\n    }\n  }\n\n  /**\n   * Tighten stop loss to 0.5 ATR after 48 hours\n   * @param position - Position to tighten stop\n   * @returns Promise with success status\n   */\n  public async tightenStopAfter48h(position: Position): Promise<boolean> {\n    try {\n      // Check if position is older than configured hours\n      const hoursOpen = (Date.now() - position.entryTime) / (1000 * 60 * 60);\n      if (hoursOpen < this.config.tightenAfterHours) {\n        return false; // Not old enough yet\n      }\n\n      const tightenedDistance = position.atr * this.config.tightenedStopDistance;\n      let newStopLoss: number;\n\n      if (position.side === 'LONG') {\n        newStopLoss = position.currentPrice - tightenedDistance;\n        \n        // Only tighten if new stop is higher than current stop\n        if (newStopLoss <= position.stopLoss) {\n          return false;\n        }\n      } else {\n        newStopLoss = position.currentPrice + tightenedDistance;\n        \n        // Only tighten if new stop is lower than current stop\n        if (newStopLoss >= position.stopLoss) {\n          return false;\n        }\n      }\n\n      console.log(`‚è∞ Tightening stop after ${hoursOpen.toFixed(1)}h for ${position.symbol}: ${position.stopLoss.toFixed(2)} ‚Üí ${newStopLoss.toFixed(2)}`);\n\n      // Set tightened stop loss\n      const success = await this.bybitClient.setStopLoss(position.symbol, newStopLoss);\n      \n      if (success) {\n        position.stopLoss = newStopLoss;\n        this.positions.set(position.id, position);\n        this.emit('position:tightened', position, newStopLoss);\n        \n        console.log(`‚úÖ Stop tightened: ${position.symbol} @ ${newStopLoss.toFixed(2)}`);\n        return true;\n      }\n\n      return false;\n    } catch (error) {\n      console.error(`‚ùå Failed to tighten stop for ${position.symbol}:`, error);\n      this.emit('position:error', position, error as Error);\n      return false;\n    }\n  }\n\n  /**\n   * Close position for stop/target hits\n   * @param position - Position to close\n   * @param reason - Reason for closing\n   * @returns Promise with success status\n   */\n  public async closePosition(position: Position, reason: 'STOP_HIT' | 'TARGET_HIT' | 'MANUAL'): Promise<boolean> {\n    try {\n      console.log(`üö™ Closing position ${position.symbol} - Reason: ${reason}`);\n\n      // Place market order to close entire position\n      const orderParams: OrderParams = {\n        phase: 'phase2',\n        symbol: position.symbol,\n        side: position.side === 'LONG' ? 'Sell' : 'Buy',\n        type: 'MARKET',\n        qty: position.quantity,\n        leverage: position.leverage\n      };\n\n      const result = await this.bybitClient.placeOrderWithRetry(orderParams);\n      \n      if (result.status === 'FILLED') {\n        // Update position status\n        position.status = 'CLOSED';\n        position.realizedPnL += (position.quantity * (result.price - position.entryPrice));\n        \n        // Remove from active management\n        this.positions.delete(position.id);\n        this.emit('position:closed', position, reason);\n        \n        console.log(`‚úÖ Position closed: ${position.symbol} at ${result.price} (${reason})`);\n        return true;\n      }\n\n      return false;\n    } catch (error) {\n      console.error(`‚ùå Failed to close position ${position.symbol}:`, error);\n      this.emit('position:error', position, error as Error);\n      return false;\n    }\n  }\n\n  /**\n   * Check if position needs management actions\n   * @param position - Position to check\n   */\n  private async checkPositionManagement(position: Position): Promise<void> {\n    try {\n      // Check for stop/target hits first\n      if (this.checkStopHit(position)) {\n        await this.closePosition(position, 'STOP_HIT');\n        return;\n      }\n\n      if (this.checkTargetHit(position)) {\n        await this.closePosition(position, 'TARGET_HIT');\n        return;\n      }\n\n      // Check for management actions (in order of priority)\n      \n      // 1. Move to breakeven at 1.5R\n      if (position.rValue >= this.config.breakevenRLevel && \n          Math.abs(position.stopLoss - position.entryPrice) > 0.01) {\n        await this.moveStopToBreakeven(position);\n      }\n\n      // 2. Take partial profit at 2R\n      if (position.rValue >= this.config.partialProfitRLevel) {\n        await this.takePartialProfit(position);\n      }\n\n      // 3. Update trailing stop if profitable\n      if (position.rValue > 0) {\n        await this.updateTrailingStop(position);\n      }\n\n      // 4. Tighten stop after 48h\n      const hoursOpen = (Date.now() - position.entryTime) / (1000 * 60 * 60);\n      if (hoursOpen >= this.config.tightenAfterHours) {\n        await this.tightenStopAfter48h(position);\n      }\n\n    } catch (error) {\n      console.error(`‚ùå Error in position management for ${position.symbol}:`, error);\n      this.emit('position:error', position, error as Error);\n    }\n  }\n\n  /**\n   * Check if stop loss was hit\n   * @param position - Position to check\n   * @returns True if stop was hit\n   */\n  private checkStopHit(position: Position): boolean {\n    if (position.side === 'LONG') {\n      return position.currentPrice <= position.stopLoss;\n    } else {\n      return position.currentPrice >= position.stopLoss;\n    }\n  }\n\n  /**\n   * Check if take profit was hit\n   * @param position - Position to check\n   * @returns True if target was hit\n   */\n  private checkTargetHit(position: Position): boolean {\n    if (position.side === 'LONG') {\n      return position.currentPrice >= position.takeProfit;\n    } else {\n      return position.currentPrice <= position.takeProfit;\n    }\n  }\n\n  /**\n   * Start monitoring positions\n   */\n  private startMonitoring(): void {\n    if (this.updateInterval) {\n      clearInterval(this.updateInterval);\n    }\n\n    this.updateInterval = setInterval(async () => {\n      await this.updateAllPositions();\n    }, this.UPDATE_FREQUENCY);\n\n    console.log(`üìä Position Manager: Started monitoring (${this.UPDATE_FREQUENCY}ms interval)`);\n  }\n\n  /**\n   * Stop monitoring positions\n   */\n  public stopMonitoring(): void {\n    if (this.updateInterval) {\n      clearInterval(this.updateInterval);\n      this.updateInterval = null;\n    }\n    console.log(`üìä Position Manager: Stopped monitoring`);\n  }\n\n  /**\n   * Update all positions with current market data\n   */\n  private async updateAllPositions(): Promise<void> {\n    const positions = Array.from(this.positions.values());\n    \n    for (const position of positions) {\n      try {\n        // Get current price from exchange\n        const currentPrice = await this.bybitClient.getCurrentPrice(position.symbol);\n        \n        // Calculate unrealized P&L\n        const priceDiff = position.side === 'LONG' \n          ? currentPrice - position.entryPrice\n          : position.entryPrice - currentPrice;\n        const unrealizedPnL = priceDiff * position.quantity;\n\n        // Update position\n        this.updatePosition({\n          id: position.id,\n          currentPrice,\n          unrealizedPnL,\n          timestamp: Date.now()\n        });\n\n      } catch (error) {\n        console.error(`‚ùå Failed to update position ${position.symbol}:`, error);\n      }\n    }\n  }\n\n  /**\n   * Get position statistics\n   * @returns Position statistics\n   */\n  public getStatistics(): {\n    totalPositions: number;\n    openPositions: number;\n    totalUnrealizedPnL: number;\n    totalRealizedPnL: number;\n    averageRValue: number;\n  } {\n    const positions = Array.from(this.positions.values());\n    const openPositions = positions.filter(p => p.status === 'OPEN');\n    \n    const totalUnrealizedPnL = openPositions.reduce((sum, p) => sum + p.unrealizedPnL, 0);\n    const totalRealizedPnL = positions.reduce((sum, p) => sum + p.realizedPnL, 0);\n    const averageRValue = openPositions.length > 0 \n      ? openPositions.reduce((sum, p) => sum + p.rValue, 0) / openPositions.length \n      : 0;\n\n    return {\n      totalPositions: positions.length,\n      openPositions: openPositions.length,\n      totalUnrealizedPnL,\n      totalRealizedPnL,\n      averageRValue\n    };\n  }\n\n  /**\n   * Update configuration\n   * @param newConfig - New configuration\n   */\n  public updateConfig(newConfig: Partial<PositionManagerConfig>): void {\n    this.config = { ...this.config, ...newConfig };\n    console.log(`üìä Position Manager: Configuration updated`);\n  }\n\n  /**\n   * Emergency close all positions\n   * @returns Promise with results\n   */\n  public async emergencyCloseAll(): Promise<{ success: number; failed: number }> {\n    console.log(`üö® Emergency closing all positions`);\n    \n    const positions = Array.from(this.positions.values());\n    let success = 0;\n    let failed = 0;\n\n    for (const position of positions) {\n      try {\n        const result = await this.closePosition(position, 'MANUAL');\n        if (result) {\n          success++;\n        } else {\n          failed++;\n        }\n      } catch (error) {\n        console.error(`‚ùå Failed to emergency close ${position.symbol}:`, error);\n        failed++;\n      }\n    }\n\n    console.log(`üö® Emergency close complete: ${success} success, ${failed} failed`);\n    return { success, failed };\n  }\n\n  /**\n   * Cleanup resources\n   */\n  public destroy(): void {\n    this.stopMonitoring();\n    this.positions.clear();\n    this.removeAllListeners();\n    console.log(`üìä Position Manager: Destroyed`);\n  }\n}\n\n// Export event interface for TypeScript\nexport declare interface PositionManager {\n  on<U extends keyof PositionManagerEvents>(event: U, listener: PositionManagerEvents[U]): this;\n  emit<U extends keyof PositionManagerEvents>(event: U, ...args: Parameters<PositionManagerEvents[U]>): boolean;\n}"],"version":3}
{"file":"/Users/ivan/Code/trading/titan/services/titan-phase2-hunter/src/engine/HologramEngine.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-phase2-hunter/src/engine/HologramEngine.ts"],"sourcesContent":["/**\n * HologramEngine - Multi-Timeframe State Machine\n * \n * Combines Daily (Bias), 4H (Narrative), and 15m (Trigger) into a single state vector\n * with weighted scoring and veto logic. This is the core of the Holographic Market\n * Structure Engine that filters out noise and identifies high-probability setups.\n * \n * Core Philosophy: \"We don't trade trends. We trade the Manipulation Phase of the AMD\n * (Accumulation-Manipulation-Distribution) cycle. We identify where institutional\n * algorithms are forced to inject liquidity, and we position ourselves to capture\n * the subsequent distribution.\"\n * \n * Requirements: 1.1-1.7 (Holographic State Engine), 2.1-2.7 (Alignment Logic), 6.1-6.7 (RS Filtering)\n */\n\nimport { \n  OHLCV, \n  TimeframeState, \n  HologramState, \n  HologramStatus, \n  VetoResult, \n  TrendState,\n  DealingRange,\n  Fractal,\n  BOS,\n  MSS\n} from '../types';\nimport { FractalMath } from './FractalMath';\nimport { BybitPerpsClient } from '../exchanges/BybitPerpsClient';\n\nexport class HologramEngine {\n  private bybitClient: BybitPerpsClient;\n  private cache = new Map<string, { data: OHLCV[]; timestamp: number }>();\n  private readonly CACHE_TTL = 5 * 60 * 1000; // 5 minutes\n\n  constructor(bybitClient: BybitPerpsClient) {\n    this.bybitClient = bybitClient;\n  }\n\n  /**\n   * Analyze symbol across all 3 timeframes to generate hologram state\n   * Fetches Daily, 4H, 15m data and combines into single state vector\n   * \n   * @param symbol - Trading symbol (e.g., 'BTCUSDT')\n   * @returns Promise with complete hologram state\n   */\n  public async analyze(symbol: string): Promise<HologramState> {\n    try {\n      // Fetch OHLCV data for all 3 timeframes in parallel\n      const [dailyCandles, h4Candles, m15Candles] = await Promise.all([\n        this.fetchCachedOHLCV(symbol, '1D', 100),\n        this.fetchCachedOHLCV(symbol, '4h', 200),\n        this.fetchCachedOHLCV(symbol, '15m', 500)\n      ]);\n\n      // Validate data\n      FractalMath.validateCandles(dailyCandles, 5);\n      FractalMath.validateCandles(h4Candles, 5);\n      FractalMath.validateCandles(m15Candles, 5);\n\n      // Calculate fractal state for each timeframe\n      const daily = this.analyzeTimeframe(dailyCandles, '1D');\n      const h4 = this.analyzeTimeframe(h4Candles, '4H');\n      const m15 = this.analyzeTimeframe(m15Candles, '15m');\n\n      // Calculate alignment score using weighted formula\n      const alignmentScore = this.calcAlignmentScore(daily, h4, m15);\n\n      // Apply veto logic for Premium/Discount zones\n      const veto = this.applyVetoLogic(daily, h4);\n\n      // Determine hologram status based on score and veto\n      const status = this.getHologramStatus(alignmentScore, veto);\n\n      // Calculate Relative Strength vs BTC over 4 hours\n      const rsScore = await this.calcRelativeStrength(symbol);\n\n      return {\n        symbol,\n        timestamp: Date.now(),\n        daily,\n        h4,\n        m15,\n        alignmentScore,\n        status,\n        veto,\n        rsScore\n      };\n    } catch (error) {\n      throw new Error(`Failed to analyze hologram for ${symbol}: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  /**\n   * Analyze single timeframe to generate timeframe state\n   * Runs fractal detection, BOS/MSS analysis, and dealing range calculation\n   * \n   * @param candles - OHLCV data for timeframe\n   * @param timeframe - Timeframe identifier\n   * @returns TimeframeState with all analysis results\n   */\n  private analyzeTimeframe(candles: OHLCV[], timeframe: '1D' | '4H' | '15m'): TimeframeState {\n    // Detect fractals using Bill Williams definition\n    const fractals = FractalMath.detectFractals(candles);\n\n    // Detect Break of Structure events\n    const bos = FractalMath.detectBOS(candles, fractals);\n\n    // Determine current trend state\n    const trend = FractalMath.getTrendState(bos);\n\n    // Detect Market Structure Shift (only for 15m timeframe as trigger)\n    let mss: MSS | null = null;\n    if (timeframe === '15m' && bos.length > 0) {\n      mss = FractalMath.detectMSS(candles, fractals, trend);\n    }\n\n    // Calculate dealing range and Premium/Discount zones\n    const dealingRange = FractalMath.calcDealingRange(fractals);\n\n    // Get current price (last close)\n    const currentPrice = candles[candles.length - 1].close;\n\n    // Determine price location within dealing range\n    const location = FractalMath.getPriceLocation(currentPrice, dealingRange);\n\n    return {\n      timeframe,\n      trend,\n      dealingRange,\n      currentPrice,\n      location,\n      fractals,\n      bos,\n      mss\n    };\n  }\n\n  /**\n   * Calculate alignment score using weighted formula\n   * Daily 50%, 4H 30%, 15m 20% - emphasizes higher timeframe bias\n   * \n   * @param daily - Daily timeframe state\n   * @param h4 - 4H timeframe state  \n   * @param m15 - 15m timeframe state\n   * @returns Alignment score (0-100)\n   */\n  public calcAlignmentScore(daily: TimeframeState, h4: TimeframeState, m15: TimeframeState): number {\n    let score = 0;\n\n    // Daily-4H agreement (50 points) - Most important\n    if (daily.trend === h4.trend && daily.trend !== 'RANGE') {\n      score += 50;\n    }\n\n    // 4H-15m agreement (30 points) - Secondary importance\n    if (h4.trend === m15.trend && h4.trend !== 'RANGE') {\n      score += 30;\n    }\n\n    // 15m MSS confirmation (20 points) - Trigger confirmation\n    if (m15.mss !== null) {\n      score += 20;\n    }\n\n    return Math.min(100, score);\n  }\n\n  /**\n   * Apply veto logic for Premium/Discount zones\n   * VETO RULE: Don't buy expensive (Premium), don't sell cheap (Discount)\n   * \n   * @param daily - Daily timeframe state (bias)\n   * @param h4 - 4H timeframe state (narrative/location)\n   * @returns VetoResult with veto decision and reason\n   */\n  public applyVetoLogic(daily: TimeframeState, h4: TimeframeState): VetoResult {\n    // VETO: Daily BULLISH but 4H in PREMIUM â†’ Don't buy expensive\n    if (daily.trend === 'BULL' && h4.location === 'PREMIUM') {\n      return {\n        vetoed: true,\n        reason: 'Daily BULLISH but 4H in PREMIUM (too expensive to buy)',\n        direction: 'LONG'\n      };\n    }\n\n    // VETO: Daily BEARISH but 4H in DISCOUNT â†’ Don't sell cheap\n    if (daily.trend === 'BEAR' && h4.location === 'DISCOUNT') {\n      return {\n        vetoed: true,\n        reason: 'Daily BEARISH but 4H in DISCOUNT (too cheap to sell)',\n        direction: 'SHORT'\n      };\n    }\n\n    // No veto - alignment is valid\n    return {\n      vetoed: false,\n      reason: null,\n      direction: null\n    };\n  }\n\n  /**\n   * Determine hologram status based on alignment score and veto logic\n   * A+ = Score >= 80 and no veto\n   * B = Score 60-79 and no veto\n   * NO_PLAY = Vetoed\n   * CONFLICT = Score < 60\n   * \n   * @param score - Alignment score (0-100)\n   * @param veto - Veto result\n   * @returns HologramStatus classification\n   */\n  public getHologramStatus(score: number, veto: VetoResult): HologramStatus {\n    // If vetoed, return NO_PLAY regardless of score\n    if (veto.vetoed) {\n      return 'NO_PLAY';\n    }\n\n    // A+ Alignment: Score >= 80 (full confluence)\n    if (score >= 80) {\n      return 'A+';\n    }\n\n    // B Alignment: Score 60-79 (partial confluence)\n    if (score >= 60) {\n      return 'B';\n    }\n\n    // Conflict: Score < 60 (timeframes disagree)\n    return 'CONFLICT';\n  }\n\n  /**\n   * Calculate Relative Strength vs BTC over 4 hours\n   * RS > 0 = Asset stronger than BTC (trade long)\n   * RS < 0 = Asset weaker than BTC (trade short)\n   * \n   * @param symbol - Asset symbol to compare\n   * @returns Promise with RS score (-1 to +1)\n   */\n  public async calcRelativeStrength(symbol: string): Promise<number> {\n    try {\n      // Skip RS calculation for BTC itself\n      if (symbol.toUpperCase() === 'BTCUSDT') {\n        return 0;\n      }\n\n      // Fetch 4-hour data for both asset and BTC (last 2 candles)\n      const [assetCandles, btcCandles] = await Promise.all([\n        this.fetchCachedOHLCV(symbol, '4h', 2),\n        this.fetchCachedOHLCV('BTCUSDT', '4h', 2)\n      ]);\n\n      // Validate we have enough data\n      if (assetCandles.length < 2 || btcCandles.length < 2) {\n        console.warn(`âš ï¸ Insufficient data for RS calculation: ${symbol}`);\n        return 0;\n      }\n\n      // Calculate % change over 4 hours (current vs previous)\n      const assetChange = (assetCandles[1].close - assetCandles[0].close) / assetCandles[0].close;\n      const btcChange = (btcCandles[1].close - btcCandles[0].close) / btcCandles[0].close;\n\n      // RS Score = Asset % change - BTC % change\n      const rsScore = assetChange - btcChange;\n\n      // Clamp to reasonable range (-1 to +1)\n      return Math.max(-1, Math.min(1, rsScore));\n    } catch (error) {\n      console.warn(`âš ï¸ Failed to calculate RS for ${symbol}: ${error instanceof Error ? error.message : 'Unknown error'}`);\n      return 0; // Return neutral RS on error\n    }\n  }\n\n  /**\n   * Fetch OHLCV data with caching to minimize API calls\n   * Cache TTL is 5 minutes to balance freshness with API efficiency\n   * \n   * @param symbol - Trading symbol\n   * @param interval - Timeframe interval\n   * @param limit - Number of candles\n   * @returns Promise with cached or fresh OHLCV data\n   */\n  private async fetchCachedOHLCV(symbol: string, interval: string, limit: number): Promise<OHLCV[]> {\n    const cacheKey = `${symbol}-${interval}-${limit}`;\n    const cached = this.cache.get(cacheKey);\n\n    // Return cached data if valid\n    if (cached && Date.now() - cached.timestamp < this.CACHE_TTL) {\n      return cached.data;\n    }\n\n    // Fetch fresh data from exchange\n    const data = await this.bybitClient.fetchOHLCV(symbol, interval, limit);\n    \n    // Cache the data\n    this.cache.set(cacheKey, {\n      data,\n      timestamp: Date.now()\n    });\n\n    return data;\n  }\n\n  /**\n   * Clear the OHLCV cache\n   * Useful for testing or forcing fresh data fetch\n   */\n  public clearCache(): void {\n    this.cache.clear();\n  }\n\n  /**\n   * Get cache statistics for monitoring\n   * @returns Object with cache size and hit rate info\n   */\n  public getCacheStats(): { size: number; keys: string[] } {\n    return {\n      size: this.cache.size,\n      keys: Array.from(this.cache.keys())\n    };\n  }\n\n  /**\n   * Validate hologram state for completeness\n   * Ensures all required fields are present and valid\n   * \n   * @param hologram - Hologram state to validate\n   * @returns true if valid, throws error if invalid\n   */\n  public static validateHologramState(hologram: HologramState): boolean {\n    if (!hologram.symbol || typeof hologram.symbol !== 'string') {\n      throw new Error('Invalid hologram: missing or invalid symbol');\n    }\n\n    if (!hologram.timestamp || typeof hologram.timestamp !== 'number') {\n      throw new Error('Invalid hologram: missing or invalid timestamp');\n    }\n\n    if (hologram.alignmentScore < 0 || hologram.alignmentScore > 100) {\n      throw new Error('Invalid hologram: alignment score must be 0-100');\n    }\n\n    if (!['A+', 'B', 'CONFLICT', 'NO_PLAY'].includes(hologram.status)) {\n      throw new Error('Invalid hologram: invalid status');\n    }\n\n    // Validate timeframe states\n    const timeframes = [hologram.daily, hologram.h4, hologram.m15];\n    for (const tf of timeframes) {\n      if (!tf.fractals || !Array.isArray(tf.fractals)) {\n        throw new Error(`Invalid hologram: missing fractals for ${tf.timeframe}`);\n      }\n      \n      if (!tf.bos || !Array.isArray(tf.bos)) {\n        throw new Error(`Invalid hologram: missing BOS for ${tf.timeframe}`);\n      }\n      \n      if (!['BULL', 'BEAR', 'RANGE'].includes(tf.trend)) {\n        throw new Error(`Invalid hologram: invalid trend for ${tf.timeframe}`);\n      }\n      \n      if (!['PREMIUM', 'DISCOUNT', 'EQUILIBRIUM'].includes(tf.location)) {\n        throw new Error(`Invalid hologram: invalid location for ${tf.timeframe}`);\n      }\n    }\n\n    return true;\n  }\n\n  /**\n   * Get human-readable hologram summary\n   * Useful for logging and debugging\n   * \n   * @param hologram - Hologram state\n   * @returns Formatted summary string\n   */\n  public static getHologramSummary(hologram: HologramState): string {\n    const { symbol, status, alignmentScore, rsScore, daily, h4, m15 } = hologram;\n    \n    const statusEmoji = {\n      'A+': 'ðŸŸ¢',\n      'B': 'ðŸŸ¡', \n      'CONFLICT': 'ðŸ”´',\n      'NO_PLAY': 'âš«'\n    }[status];\n\n    const rsEmoji = rsScore > 0.02 ? 'ðŸ“ˆ' : rsScore < -0.02 ? 'ðŸ“‰' : 'âž¡ï¸';\n    \n    return `${statusEmoji} ${symbol} | Score: ${alignmentScore} | RS: ${(rsScore * 100).toFixed(1)}% ${rsEmoji} | ` +\n           `Daily: ${daily.trend}/${daily.location} | 4H: ${h4.trend}/${h4.location} | 15m: ${m15.trend}${m15.mss ? '/MSS' : ''}`;\n  }\n}"],"version":3}
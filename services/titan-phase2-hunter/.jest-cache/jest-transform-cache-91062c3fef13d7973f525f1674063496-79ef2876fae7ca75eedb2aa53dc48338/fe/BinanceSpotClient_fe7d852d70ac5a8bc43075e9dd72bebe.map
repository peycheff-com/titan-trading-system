{"file":"/Users/ivan/Code/trading/titan/services/titan-phase2-hunter/src/exchanges/BinanceSpotClient.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-phase2-hunter/src/exchanges/BinanceSpotClient.ts"],"sourcesContent":["/**\n * Binance Spot Client for CVD Data Source\n * \n * Provides tick-level trade data via WebSocket for Cumulative Volume Delta calculation.\n * Includes reconnection logic and callback system for trade events.\n * \n * Requirements: 4.1 (CVD Monitoring)\n */\n\nimport WebSocket = require('ws');\nimport { Trade } from '../types';\n\n// Use require for node-fetch to avoid ES modules issues in Jest\nconst fetch = require('node-fetch');\n\nexport interface BinanceAggTrade {\n  e: string;      // Event type\n  E: number;      // Event time\n  s: string;      // Symbol\n  a: number;      // Aggregate trade ID\n  p: string;      // Price\n  q: string;      // Quantity\n  f: number;      // First trade ID\n  l: number;      // Last trade ID\n  T: number;      // Trade time\n  m: boolean;     // Is the buyer the market maker?\n  M: boolean;     // Ignore\n}\n\nexport interface BinanceSpotPrice {\n  symbol: string;\n  price: string;\n}\n\nexport type TradeCallback = (trade: Trade) => void;\nexport type ErrorCallback = (error: Error) => void;\nexport type ReconnectCallback = () => void;\n\nexport class BinanceSpotClient {\n  private ws: WebSocket | null = null;\n  private baseUrl = 'https://api.binance.com';\n  private wsUrl = 'wss://stream.binance.com:9443/ws';\n  private subscriptions = new Map<string, Set<TradeCallback>>();\n  private reconnectAttempts = 0;\n  private maxReconnectAttempts = 3;\n  private reconnectDelay = 2000; // 2 seconds\n  private isReconnecting = false;\n  private heartbeatInterval: NodeJS.Timeout | null = null;\n  private lastPongTime = 0;\n  \n  // Callbacks\n  private errorCallbacks = new Set<ErrorCallback>();\n  private reconnectCallbacks = new Set<ReconnectCallback>();\n\n  constructor() {\n    this.setupHeartbeat();\n  }\n\n  /**\n   * Subscribe to aggregate trades for a symbol\n   * @param symbol - Trading symbol (e.g., 'BTCUSDT')\n   * @param callback - Callback function for trade events\n   */\n  public subscribeAggTrades(symbol: string, callback: TradeCallback): void {\n    const normalizedSymbol = symbol.toLowerCase();\n    \n    // Add callback to subscriptions\n    if (!this.subscriptions.has(normalizedSymbol)) {\n      this.subscriptions.set(normalizedSymbol, new Set());\n    }\n    this.subscriptions.get(normalizedSymbol)!.add(callback);\n\n    // Connect WebSocket if not already connected\n    if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {\n      this.connect();\n    } else {\n      // Subscribe to the stream if WebSocket is already open\n      this.subscribeToStream(normalizedSymbol);\n    }\n  }\n\n  /**\n   * Unsubscribe from aggregate trades for a symbol\n   * @param symbol - Trading symbol\n   * @param callback - Callback function to remove\n   */\n  public unsubscribeAggTrades(symbol: string, callback: TradeCallback): void {\n    const normalizedSymbol = symbol.toLowerCase();\n    const callbacks = this.subscriptions.get(normalizedSymbol);\n    \n    if (callbacks) {\n      callbacks.delete(callback);\n      \n      // If no more callbacks for this symbol, unsubscribe from stream\n      if (callbacks.size === 0) {\n        this.subscriptions.delete(normalizedSymbol);\n        this.unsubscribeFromStream(normalizedSymbol);\n      }\n    }\n  }\n\n  /**\n   * Get current spot price for a symbol via REST API\n   * @param symbol - Trading symbol (e.g., 'BTCUSDT')\n   * @returns Promise with current price\n   */\n  public async getSpotPrice(symbol: string): Promise<number> {\n    try {\n      const response = await fetch(`${this.baseUrl}/api/v3/ticker/price?symbol=${symbol.toUpperCase()}`);\n      \n      if (!response.ok) {\n        throw new Error(`HTTP ${response.status}: ${response.statusText}`);\n      }\n\n      const data = await response.json() as BinanceSpotPrice;\n      return parseFloat(data.price);\n    } catch (error) {\n      const errorMsg = `Failed to get spot price for ${symbol}: ${error instanceof Error ? error.message : 'Unknown error'}`;\n      this.emitError(new Error(errorMsg));\n      throw new Error(errorMsg);\n    }\n  }\n\n  /**\n   * Add error callback\n   * @param callback - Error callback function\n   */\n  public onError(callback: ErrorCallback): void {\n    this.errorCallbacks.add(callback);\n  }\n\n  /**\n   * Add reconnect callback\n   * @param callback - Reconnect callback function\n   */\n  public onReconnect(callback: ReconnectCallback): void {\n    this.reconnectCallbacks.add(callback);\n  }\n\n  /**\n   * Remove error callback\n   * @param callback - Error callback function to remove\n   */\n  public removeErrorCallback(callback: ErrorCallback): void {\n    this.errorCallbacks.delete(callback);\n  }\n\n  /**\n   * Remove reconnect callback\n   * @param callback - Reconnect callback function to remove\n   */\n  public removeReconnectCallback(callback: ReconnectCallback): void {\n    this.reconnectCallbacks.delete(callback);\n  }\n\n  /**\n   * Get connection status\n   * @returns WebSocket ready state\n   */\n  public getConnectionStatus(): 'CONNECTING' | 'OPEN' | 'CLOSING' | 'CLOSED' {\n    if (!this.ws) return 'CLOSED';\n    \n    switch (this.ws.readyState) {\n      case WebSocket.CONNECTING: return 'CONNECTING';\n      case WebSocket.OPEN: return 'OPEN';\n      case WebSocket.CLOSING: return 'CLOSING';\n      case WebSocket.CLOSED: return 'CLOSED';\n      default: return 'CLOSED';\n    }\n  }\n\n  /**\n   * Close WebSocket connection and cleanup\n   */\n  public close(): void {\n    if (this.heartbeatInterval) {\n      clearInterval(this.heartbeatInterval);\n      this.heartbeatInterval = null;\n    }\n\n    if (this.ws) {\n      this.ws.close();\n      this.ws = null;\n    }\n\n    this.subscriptions.clear();\n    this.errorCallbacks.clear();\n    this.reconnectCallbacks.clear();\n    this.reconnectAttempts = 0;\n    this.isReconnecting = false;\n  }\n\n  /**\n   * Connect to Binance WebSocket\n   */\n  private connect(): void {\n    if (this.isReconnecting) return;\n\n    try {\n      // Build stream URL with all subscribed symbols\n      const streams = Array.from(this.subscriptions.keys()).map(symbol => `${symbol}@aggTrade`);\n      const streamUrl = streams.length > 0 \n        ? `${this.wsUrl}/${streams.join('/')}`\n        : this.wsUrl;\n\n      this.ws = new WebSocket(streamUrl);\n      this.lastPongTime = Date.now();\n\n      this.ws.on('open', () => {\n        console.log('ðŸ”— Binance WebSocket connected');\n        this.reconnectAttempts = 0;\n        this.isReconnecting = false;\n        \n        // Subscribe to all existing symbols\n        Array.from(this.subscriptions.keys()).forEach(symbol => {\n          this.subscribeToStream(symbol);\n        });\n      });\n\n      this.ws.on('message', (data: WebSocket.Data) => {\n        try {\n          const message = JSON.parse(data.toString());\n          this.handleMessage(message);\n        } catch (error) {\n          this.emitError(new Error(`Failed to parse WebSocket message: ${error instanceof Error ? error.message : 'Unknown error'}`));\n        }\n      });\n\n      this.ws.on('pong', () => {\n        this.lastPongTime = Date.now();\n      });\n\n      this.ws.on('error', (error: Error) => {\n        console.error('âŒ Binance WebSocket error:', error.message);\n        this.emitError(error);\n      });\n\n      this.ws.on('close', (code: number, reason: Buffer) => {\n        console.log(`ðŸ”Œ Binance WebSocket closed: ${code} ${reason.toString()}`);\n        this.ws = null;\n        \n        // Attempt reconnection if we have active subscriptions\n        if (this.subscriptions.size > 0 && !this.isReconnecting) {\n          this.attemptReconnect();\n        }\n      });\n\n    } catch (error) {\n      this.emitError(new Error(`Failed to connect to Binance WebSocket: ${error instanceof Error ? error.message : 'Unknown error'}`));\n    }\n  }\n\n  /**\n   * Subscribe to a specific stream (used when WebSocket is already open)\n   */\n  private subscribeToStream(symbol: string): void {\n    if (!this.ws || this.ws.readyState !== WebSocket.OPEN) return;\n\n    const subscribeMessage = {\n      method: 'SUBSCRIBE',\n      params: [`${symbol}@aggTrade`],\n      id: Date.now()\n    };\n\n    this.ws.send(JSON.stringify(subscribeMessage));\n  }\n\n  /**\n   * Unsubscribe from a specific stream\n   */\n  private unsubscribeFromStream(symbol: string): void {\n    if (!this.ws || this.ws.readyState !== WebSocket.OPEN) return;\n\n    const unsubscribeMessage = {\n      method: 'UNSUBSCRIBE',\n      params: [`${symbol}@aggTrade`],\n      id: Date.now()\n    };\n\n    this.ws.send(JSON.stringify(unsubscribeMessage));\n  }\n\n  /**\n   * Handle incoming WebSocket messages\n   */\n  private handleMessage(message: any): void {\n    // Handle aggregate trade data\n    if (message.e === 'aggTrade') {\n      const aggTrade = message as BinanceAggTrade;\n      const trade: Trade = {\n        price: parseFloat(aggTrade.p),\n        quantity: parseFloat(aggTrade.q),\n        side: aggTrade.m ? 'SELL' : 'BUY', // m=true means buyer is market maker (sell order filled)\n        timestamp: aggTrade.T\n      };\n\n      // Emit to all callbacks for this symbol\n      const callbacks = this.subscriptions.get(aggTrade.s.toLowerCase());\n      if (callbacks) {\n        callbacks.forEach(callback => {\n          try {\n            callback(trade);\n          } catch (error) {\n            this.emitError(new Error(`Trade callback error: ${error instanceof Error ? error.message : 'Unknown error'}`));\n          }\n        });\n      }\n    }\n    \n    // Handle subscription confirmations and errors\n    if (message.result === null && message.id) {\n      // Subscription successful\n      console.log(`âœ… Binance subscription confirmed: ${message.id}`);\n    } else if (message.error) {\n      this.emitError(new Error(`Binance WebSocket error: ${message.error.msg}`));\n    }\n  }\n\n  /**\n   * Attempt to reconnect with exponential backoff\n   */\n  private attemptReconnect(): void {\n    if (this.isReconnecting || this.reconnectAttempts >= this.maxReconnectAttempts) {\n      if (this.reconnectAttempts >= this.maxReconnectAttempts) {\n        this.emitError(new Error(`Max reconnection attempts (${this.maxReconnectAttempts}) reached`));\n      }\n      return;\n    }\n\n    this.isReconnecting = true;\n    this.reconnectAttempts++;\n\n    const delay = this.reconnectDelay * Math.pow(2, this.reconnectAttempts - 1); // Exponential backoff\n    console.log(`ðŸ”„ Attempting to reconnect to Binance WebSocket (attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts}) in ${delay}ms`);\n\n    setTimeout(() => {\n      this.connect();\n      this.emitReconnect();\n    }, delay);\n  }\n\n  /**\n   * Setup heartbeat to detect connection issues\n   */\n  private setupHeartbeat(): void {\n    this.heartbeatInterval = setInterval(() => {\n      if (this.ws && this.ws.readyState === WebSocket.OPEN) {\n        // Check if we received a pong recently\n        const timeSinceLastPong = Date.now() - this.lastPongTime;\n        if (timeSinceLastPong > 30000) { // 30 seconds timeout\n          console.warn('âš ï¸ Binance WebSocket heartbeat timeout, closing connection');\n          this.ws.close();\n          return;\n        }\n\n        // Send ping\n        this.ws.ping();\n      }\n    }, 20000); // Ping every 20 seconds\n  }\n\n  /**\n   * Emit error to all error callbacks\n   */\n  private emitError(error: Error): void {\n    this.errorCallbacks.forEach(callback => {\n      try {\n        callback(error);\n      } catch (callbackError) {\n        console.error('Error in error callback:', callbackError);\n      }\n    });\n  }\n\n  /**\n   * Emit reconnect event to all reconnect callbacks\n   */\n  private emitReconnect(): void {\n    this.reconnectCallbacks.forEach(callback => {\n      try {\n        callback();\n      } catch (callbackError) {\n        console.error('Error in reconnect callback:', callbackError);\n      }\n    });\n  }\n}"],"version":3}
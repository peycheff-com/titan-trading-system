{"file":"/Users/ivan/Code/trading/titan/services/titan-phase2-hunter/tests/unit/PortfolioManager.test.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-phase2-hunter/tests/unit/PortfolioManager.test.ts"],"sourcesContent":["/**\n * Unit tests for PortfolioManager\n * Tests multi-symbol portfolio management functionality\n */\n\nimport { PortfolioManager, PortfolioManagerConfig } from '../../src/risk/PortfolioManager';\nimport { Position, SignalData, HologramState } from '../../src/types';\n\ndescribe('PortfolioManager', () => {\n  let portfolioManager: PortfolioManager;\n  let mockPositions: Position[];\n  let mockSignals: Array<{ signal: SignalData; hologramState: HologramState }>;\n\n  beforeEach(() => {\n    // Create portfolio manager with test config\n    const config: Partial<PortfolioManagerConfig> = {\n      maxTotalExposure: 2.0, // 200% of equity\n      maxConcurrentPositions: 5,\n      baseRiskPercent: 0.02, // 2%\n      maxPortfolioHeat: 0.15, // 15%\n      directionalBiasThreshold: 0.6, // 60%\n      directionalBiasReduction: 0.2, // 20%\n      alignmentScoreWeight: 0.7, // 70%\n      rsScoreWeight: 0.3, // 30%\n      maxSignalsToRank: 10\n    };\n\n    portfolioManager = new PortfolioManager(config);\n\n    // Create mock positions\n    mockPositions = [\n      {\n        id: 'pos-1',\n        symbol: 'BTCUSDT',\n        side: 'LONG',\n        entryPrice: 50000,\n        currentPrice: 51000,\n        quantity: 0.1,\n        leverage: 3,\n        stopLoss: 49250, // 1.5% stop\n        takeProfit: 52250, // 4.5% target\n        unrealizedPnL: 100,\n        realizedPnL: 0,\n        entryTime: Date.now() - (24 * 60 * 60 * 1000), // 24 hours ago\n        status: 'OPEN',\n        rValue: 1.33, // (51000-50000)/(50000-49250) = 1.33R\n        atr: 1000\n      },\n      {\n        id: 'pos-2',\n        symbol: 'ETHUSDT',\n        side: 'LONG',\n        entryPrice: 3000,\n        currentPrice: 3100,\n        quantity: 1,\n        leverage: 4,\n        stopLoss: 2955, // 1.5% stop\n        takeProfit: 3135, // 4.5% target\n        unrealizedPnL: 100,\n        realizedPnL: 0,\n        entryTime: Date.now() - (12 * 60 * 60 * 1000), // 12 hours ago\n        status: 'OPEN',\n        rValue: 2.22, // (3100-3000)/(3000-2955) = 2.22R\n        atr: 50\n      }\n    ];\n\n    // Create mock signals with hologram states\n    mockSignals = [\n      {\n        signal: {\n          symbol: 'ADAUSDT',\n          direction: 'LONG',\n          hologramStatus: 'A+',\n          alignmentScore: 95,\n          rsScore: 0.05,\n          sessionType: 'LONDON',\n          poiType: 'ORDER_BLOCK',\n          cvdConfirmation: true,\n          confidence: 90,\n          entryPrice: 0.5,\n          stopLoss: 0.4925,\n          takeProfit: 0.5225,\n          positionSize: 1000,\n          leverage: 3,\n          timestamp: Date.now()\n        },\n        hologramState: {\n          symbol: 'ADAUSDT',\n          timestamp: Date.now(),\n          daily: {} as any,\n          h4: {} as any,\n          m15: {} as any,\n          alignmentScore: 95,\n          status: 'A+',\n          veto: { vetoed: false, reason: null, direction: null },\n          rsScore: 0.05\n        }\n      },\n      {\n        signal: {\n          symbol: 'SOLUSDT',\n          direction: 'SHORT',\n          hologramStatus: 'B',\n          alignmentScore: 75,\n          rsScore: -0.03,\n          sessionType: 'NY',\n          poiType: 'FVG',\n          cvdConfirmation: true,\n          confidence: 80,\n          entryPrice: 100,\n          stopLoss: 101.5,\n          takeProfit: 95.5,\n          positionSize: 10,\n          leverage: 4,\n          timestamp: Date.now()\n        },\n        hologramState: {\n          symbol: 'SOLUSDT',\n          timestamp: Date.now(),\n          daily: {} as any,\n          h4: {} as any,\n          m15: {} as any,\n          alignmentScore: 75,\n          status: 'B',\n          veto: { vetoed: false, reason: null, direction: null },\n          rsScore: -0.03\n        }\n      }\n    ];\n  });\n\n  afterEach(() => {\n    portfolioManager.destroy();\n  });\n\n  describe('calcTotalExposure', () => {\n    it('should calculate total exposure correctly', () => {\n      const totalEquity = 10000;\n      const exposure = portfolioManager.calcTotalExposure(mockPositions, totalEquity);\n      \n      // Position 1: 0.1 * 51000 * 3 = 15300\n      // Position 2: 1 * 3100 * 4 = 12400\n      // Total: 27700, Exposure: 27700/10000 = 2.77 (277%)\n      // Capped at 2.0 (200%)\n      expect(exposure).toBe(2.0);\n    });\n\n    it('should return 0 for zero equity', () => {\n      const exposure = portfolioManager.calcTotalExposure(mockPositions, 0);\n      expect(exposure).toBe(0);\n    });\n\n    it('should handle empty positions', () => {\n      const exposure = portfolioManager.calcTotalExposure([], 10000);\n      expect(exposure).toBe(0);\n    });\n  });\n\n  describe('enforceMaxPositions', () => {\n    it('should allow new position when under limit', () => {\n      const canOpen = portfolioManager.enforceMaxPositions(mockPositions);\n      expect(canOpen).toBe(true); // 2 positions < 5 limit\n    });\n\n    it('should reject new position when at limit', () => {\n      // Create 5 positions to hit the limit\n      const maxPositions = Array(5).fill(null).map((_, i) => ({\n        ...mockPositions[0],\n        id: `pos-${i}`,\n        status: 'OPEN' as const\n      }));\n      \n      const canOpen = portfolioManager.enforceMaxPositions(maxPositions);\n      expect(canOpen).toBe(false);\n    });\n\n    it('should only count open positions', () => {\n      const positionsWithClosed = [\n        ...mockPositions,\n        { ...mockPositions[0], id: 'pos-3', status: 'CLOSED' as const },\n        { ...mockPositions[0], id: 'pos-4', status: 'CLOSED' as const }\n      ];\n      \n      const canOpen = portfolioManager.enforceMaxPositions(positionsWithClosed);\n      expect(canOpen).toBe(true); // Only 2 open positions\n    });\n  });\n\n  describe('allocateRiskPerTrade', () => {\n    it('should allocate risk dynamically based on open positions', () => {\n      const totalEquity = 10000;\n      const allocation = portfolioManager.allocateRiskPerTrade(totalEquity, mockPositions);\n      \n      // Base risk: 2%, Open positions: 2, Adjusted: 2% / (2+1) = 0.67%\n      expect(allocation.baseRiskPerTrade).toBe(0.02);\n      expect(allocation.adjustedRiskPerTrade).toBeCloseTo(0.0067, 4);\n      expect(allocation.maxPositionSize).toBeCloseTo(4467, 0); // (10000 * 0.0067) / 0.015\n      expect(allocation.recommendedLeverage).toBeGreaterThan(1);\n      expect(allocation.recommendedLeverage).toBeLessThanOrEqual(5);\n    });\n\n    it('should handle no open positions', () => {\n      const totalEquity = 10000;\n      const allocation = portfolioManager.allocateRiskPerTrade(totalEquity, []);\n      \n      // No positions: 2% / 1 = 2%\n      expect(allocation.adjustedRiskPerTrade).toBe(0.02);\n    });\n  });\n\n  describe('rankSignals', () => {\n    it('should rank signals by composite score', () => {\n      const ranked = portfolioManager.rankSignals(mockSignals);\n      \n      expect(ranked).toHaveLength(2);\n      expect(ranked[0].rank).toBe(1);\n      expect(ranked[1].rank).toBe(2);\n      \n      // First signal should have higher composite score (A+ with 95 alignment)\n      expect(ranked[0].compositeScore).toBeGreaterThan(ranked[1].compositeScore);\n      expect(ranked[0].signal.symbol).toBe('ADAUSDT');\n    });\n\n    it('should limit to top 3 signals', () => {\n      // Add more signals\n      const moreSignals = [\n        ...mockSignals,\n        ...Array(5).fill(null).map((_, i) => ({\n          signal: { ...mockSignals[0].signal, symbol: `TEST${i}USDT` },\n          hologramState: { ...mockSignals[0].hologramState, alignmentScore: 60 - i }\n        }))\n      ];\n      \n      const ranked = portfolioManager.rankSignals(moreSignals);\n      expect(ranked).toHaveLength(3); // Limited to top 3\n    });\n\n    it('should handle empty signals array', () => {\n      const ranked = portfolioManager.rankSignals([]);\n      expect(ranked).toHaveLength(0);\n    });\n  });\n\n  describe('checkPortfolioHeat', () => {\n    it('should calculate portfolio heat correctly', () => {\n      const totalEquity = 10000;\n      const canTrade = portfolioManager.checkPortfolioHeat(mockPositions, totalEquity);\n      \n      // Position 1 risk: (50000-49250) * 0.1 = 75\n      // Position 2 risk: (3000-2955) * 1 = 45\n      // Total risk: 120, Heat: 120/10000 = 1.2% < 15%\n      expect(canTrade).toBe(true);\n    });\n\n    it('should reject when portfolio heat exceeds limit', () => {\n      // Create high-risk positions\n      const highRiskPositions = mockPositions.map(pos => ({\n        ...pos,\n        quantity: pos.quantity * 50 // Increase quantity to increase risk\n      }));\n      \n      const totalEquity = 1000; // Small equity to increase heat percentage\n      const canTrade = portfolioManager.checkPortfolioHeat(highRiskPositions, totalEquity);\n      \n      expect(canTrade).toBe(false);\n    });\n\n    it('should return false for zero equity', () => {\n      const canTrade = portfolioManager.checkPortfolioHeat(mockPositions, 0);\n      expect(canTrade).toBe(false);\n    });\n  });\n\n  describe('adjustForDirectionalBias', () => {\n    it('should not adjust when no directional bias', () => {\n      // Mixed positions (1 LONG, 1 SHORT)\n      const mixedPositions = [\n        mockPositions[0], // LONG\n        { ...mockPositions[1], side: 'SHORT' as const } // SHORT\n      ];\n      \n      const adjustedSize = portfolioManager.adjustForDirectionalBias(\n        mixedPositions, \n        'LONG', \n        1000\n      );\n      \n      expect(adjustedSize).toBe(1000); // No adjustment\n    });\n\n    it('should reduce position size when adding to directional bias', () => {\n      // All LONG positions (100% bias)\n      const longPositions = mockPositions; // Both are LONG\n      \n      const adjustedSize = portfolioManager.adjustForDirectionalBias(\n        longPositions, \n        'LONG', \n        1000\n      );\n      \n      // Should reduce by 20%: 1000 * (1 - 0.2) = 800\n      expect(adjustedSize).toBe(800);\n    });\n\n    it('should not adjust when going against directional bias', () => {\n      // All LONG positions\n      const longPositions = mockPositions; // Both are LONG\n      \n      const adjustedSize = portfolioManager.adjustForDirectionalBias(\n        longPositions, \n        'SHORT', \n        1000\n      );\n      \n      expect(adjustedSize).toBe(1000); // No adjustment when going against bias\n    });\n\n    it('should handle empty positions', () => {\n      const adjustedSize = portfolioManager.adjustForDirectionalBias([], 'LONG', 1000);\n      expect(adjustedSize).toBe(1000); // No adjustment with no positions\n    });\n  });\n\n  describe('updatePortfolioState', () => {\n    it('should update portfolio state correctly', () => {\n      const totalEquity = 10000;\n      portfolioManager.updatePortfolioState(mockPositions, totalEquity);\n      \n      const state = portfolioManager.getPortfolioState();\n      \n      expect(state.totalEquity).toBe(totalEquity);\n      expect(state.openPositions).toHaveLength(2);\n      expect(state.directionalBias).toBe('LONG'); // Both positions are LONG\n      expect(state.biasPercentage).toBe(1.0); // 100% LONG\n      expect(state.totalUnrealizedPnL).toBe(200); // 100 + 100\n      expect(state.totalRealizedPnL).toBe(0);\n    });\n\n    it('should detect neutral bias with mixed positions', () => {\n      const mixedPositions = [\n        mockPositions[0], // LONG\n        { ...mockPositions[1], side: 'SHORT' as const } // SHORT\n      ];\n      \n      portfolioManager.updatePortfolioState(mixedPositions, 10000);\n      const state = portfolioManager.getPortfolioState();\n      \n      expect(state.directionalBias).toBe('NEUTRAL');\n      expect(state.biasPercentage).toBe(0);\n    });\n  });\n\n  describe('canAcceptSignal', () => {\n    beforeEach(() => {\n      // Add positions to portfolio manager\n      mockPositions.forEach(pos => portfolioManager.addPosition(pos));\n      portfolioManager.updatePortfolioState(mockPositions, 10000);\n    });\n\n    it('should accept signal when all limits are within bounds', () => {\n      const canAccept = portfolioManager.canAcceptSignal(\n        mockSignals[0].signal,\n        mockSignals[0].hologramState,\n        10000\n      );\n      \n      expect(canAccept).toBe(true);\n    });\n\n    it('should reject signal when position limit exceeded', () => {\n      // Add more positions to hit the limit\n      for (let i = 3; i <= 5; i++) {\n        portfolioManager.addPosition({\n          ...mockPositions[0],\n          id: `pos-${i}`,\n          status: 'OPEN'\n        });\n      }\n      \n      const canAccept = portfolioManager.canAcceptSignal(\n        mockSignals[0].signal,\n        mockSignals[0].hologramState,\n        10000\n      );\n      \n      expect(canAccept).toBe(false);\n    });\n  });\n\n  describe('getPortfolioStatistics', () => {\n    beforeEach(() => {\n      mockPositions.forEach(pos => portfolioManager.addPosition(pos));\n      portfolioManager.updatePortfolioState(mockPositions, 10000);\n    });\n\n    it('should return correct portfolio statistics', () => {\n      const stats = portfolioManager.getPortfolioStatistics();\n      \n      expect(stats.totalPositions).toBe(2);\n      expect(stats.openPositions).toBe(2);\n      expect(stats.exposureUtilization).toBeGreaterThan(0);\n      expect(stats.heatUtilization).toBeGreaterThan(0);\n      expect(stats.positionUtilization).toBe(0.4); // 2/5 = 0.4\n      expect(stats.avgPositionSize).toBeGreaterThan(0);\n      expect(stats.largestPosition).toBeGreaterThan(0);\n      expect(stats.directionalBias).toContain('LONG');\n      expect(stats.totalPnL).toBe(200);\n    });\n  });\n\n  describe('position management', () => {\n    it('should add and remove positions correctly', () => {\n      const position = mockPositions[0];\n      \n      portfolioManager.addPosition(position);\n      expect(portfolioManager.getAllPositions()).toHaveLength(1);\n      \n      portfolioManager.removePosition(position.id);\n      expect(portfolioManager.getAllPositions()).toHaveLength(0);\n    });\n\n    it('should update positions correctly', () => {\n      const position = mockPositions[0];\n      portfolioManager.addPosition(position);\n      \n      const updatedPosition = { ...position, currentPrice: 52000 };\n      portfolioManager.updatePosition(updatedPosition);\n      \n      const retrieved = portfolioManager.getAllPositions()[0];\n      expect(retrieved.currentPrice).toBe(52000);\n    });\n\n    it('should get open positions only', () => {\n      const openPosition = mockPositions[0];\n      const closedPosition = { ...mockPositions[1], status: 'CLOSED' as const };\n      \n      portfolioManager.addPosition(openPosition);\n      portfolioManager.addPosition(closedPosition);\n      \n      const openPositions = portfolioManager.getOpenPositions();\n      expect(openPositions).toHaveLength(1);\n      expect(openPositions[0].status).toBe('OPEN');\n    });\n\n    it('should clear all positions', () => {\n      mockPositions.forEach(pos => portfolioManager.addPosition(pos));\n      expect(portfolioManager.getAllPositions()).toHaveLength(2);\n      \n      portfolioManager.clearPositions();\n      expect(portfolioManager.getAllPositions()).toHaveLength(0);\n    });\n  });\n\n  describe('configuration', () => {\n    it('should update configuration correctly', () => {\n      const newConfig = { maxConcurrentPositions: 10 };\n      portfolioManager.updateConfig(newConfig);\n      \n      // Test that new config is applied\n      const positions = Array(8).fill(null).map((_, i) => ({\n        ...mockPositions[0],\n        id: `pos-${i}`,\n        status: 'OPEN' as const\n      }));\n      \n      const canOpen = portfolioManager.enforceMaxPositions(positions);\n      expect(canOpen).toBe(true); // Should allow since limit is now 10\n    });\n  });\n\n  describe('event emission', () => {\n    it('should emit portfolio updated event', (done) => {\n      portfolioManager.on('portfolio:updated', (state) => {\n        expect(state.totalEquity).toBe(10000);\n        expect(state.openPositions).toHaveLength(2);\n        done();\n      });\n      \n      portfolioManager.updatePortfolioState(mockPositions, 10000);\n    });\n\n    it('should emit signal rejected event', (done) => {\n      portfolioManager.on('portfolio:signal_rejected', (signal, reason) => {\n        expect(signal.symbol).toBe('ADAUSDT');\n        expect(reason).toBe('POSITION_LIMIT_EXCEEDED');\n        done();\n      });\n      \n      // Add positions to hit limit\n      for (let i = 1; i <= 5; i++) {\n        portfolioManager.addPosition({\n          ...mockPositions[0],\n          id: `pos-${i}`,\n          status: 'OPEN'\n        });\n      }\n      \n      portfolioManager.canAcceptSignal(\n        mockSignals[0].signal,\n        mockSignals[0].hologramState,\n        10000\n      );\n    });\n\n    it('should emit directional bias event', (done) => {\n      portfolioManager.on('portfolio:directional_bias', (bias, percentage) => {\n        expect(bias).toBe('LONG');\n        expect(percentage).toBe(1.0);\n        done();\n      });\n      \n      portfolioManager.adjustForDirectionalBias(mockPositions, 'LONG', 1000);\n    });\n  });\n});"],"version":3}
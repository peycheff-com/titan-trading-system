b99ba4720d35acd30e48cbc582a49376
"use strict";
/**
 * HologramEngine - Multi-Timeframe State Machine
 *
 * Combines Daily (Bias), 4H (Narrative), and 15m (Trigger) into a single state vector
 * with weighted scoring and veto logic. This is the core of the Holographic Market
 * Structure Engine that filters out noise and identifies high-probability setups.
 *
 * Core Philosophy: "We don't trade trends. We trade the Manipulation Phase of the AMD
 * (Accumulation-Manipulation-Distribution) cycle. We identify where institutional
 * algorithms are forced to inject liquidity, and we position ourselves to capture
 * the subsequent distribution."
 *
 * Requirements: 1.1-1.7 (Holographic State Engine), 2.1-2.7 (Alignment Logic), 6.1-6.7 (RS Filtering)
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.HologramEngine = void 0;
const FractalMath_1 = require("./FractalMath");
class HologramEngine {
    bybitClient;
    cache = new Map();
    CACHE_TTL = 5 * 60 * 1000; // 5 minutes
    constructor(bybitClient) {
        this.bybitClient = bybitClient;
    }
    /**
     * Analyze symbol across all 3 timeframes to generate hologram state
     * Fetches Daily, 4H, 15m data and combines into single state vector
     *
     * @param symbol - Trading symbol (e.g., 'BTCUSDT')
     * @returns Promise with complete hologram state
     */
    async analyze(symbol) {
        try {
            // Fetch OHLCV data for all 3 timeframes in parallel
            const [dailyCandles, h4Candles, m15Candles] = await Promise.all([
                this.fetchCachedOHLCV(symbol, '1D', 100),
                this.fetchCachedOHLCV(symbol, '4h', 200),
                this.fetchCachedOHLCV(symbol, '15m', 500)
            ]);
            // Validate data
            FractalMath_1.FractalMath.validateCandles(dailyCandles, 5);
            FractalMath_1.FractalMath.validateCandles(h4Candles, 5);
            FractalMath_1.FractalMath.validateCandles(m15Candles, 5);
            // Calculate fractal state for each timeframe
            const daily = this.analyzeTimeframe(dailyCandles, '1D');
            const h4 = this.analyzeTimeframe(h4Candles, '4H');
            const m15 = this.analyzeTimeframe(m15Candles, '15m');
            // Calculate alignment score using weighted formula
            const alignmentScore = this.calcAlignmentScore(daily, h4, m15);
            // Apply veto logic for Premium/Discount zones
            const veto = this.applyVetoLogic(daily, h4);
            // Determine hologram status based on score and veto
            const status = this.getHologramStatus(alignmentScore, veto);
            // Calculate Relative Strength vs BTC over 4 hours
            const rsScore = await this.calcRelativeStrength(symbol);
            return {
                symbol,
                timestamp: Date.now(),
                daily,
                h4,
                m15,
                alignmentScore,
                status,
                veto,
                rsScore
            };
        }
        catch (error) {
            throw new Error(`Failed to analyze hologram for ${symbol}: ${error instanceof Error ? error.message : 'Unknown error'}`);
        }
    }
    /**
     * Analyze single timeframe to generate timeframe state
     * Runs fractal detection, BOS/MSS analysis, and dealing range calculation
     *
     * @param candles - OHLCV data for timeframe
     * @param timeframe - Timeframe identifier
     * @returns TimeframeState with all analysis results
     */
    analyzeTimeframe(candles, timeframe) {
        // Detect fractals using Bill Williams definition
        const fractals = FractalMath_1.FractalMath.detectFractals(candles);
        // Detect Break of Structure events
        const bos = FractalMath_1.FractalMath.detectBOS(candles, fractals);
        // Determine current trend state
        const trend = FractalMath_1.FractalMath.getTrendState(bos);
        // Detect Market Structure Shift (only for 15m timeframe as trigger)
        let mss = null;
        if (timeframe === '15m' && bos.length > 0) {
            mss = FractalMath_1.FractalMath.detectMSS(candles, fractals, trend);
        }
        // Calculate dealing range and Premium/Discount zones
        const dealingRange = FractalMath_1.FractalMath.calcDealingRange(fractals);
        // Get current price (last close)
        const currentPrice = candles[candles.length - 1].close;
        // Determine price location within dealing range
        const location = FractalMath_1.FractalMath.getPriceLocation(currentPrice, dealingRange);
        return {
            timeframe,
            trend,
            dealingRange,
            currentPrice,
            location,
            fractals,
            bos,
            mss
        };
    }
    /**
     * Calculate alignment score using weighted formula
     * Daily 50%, 4H 30%, 15m 20% - emphasizes higher timeframe bias
     *
     * @param daily - Daily timeframe state
     * @param h4 - 4H timeframe state
     * @param m15 - 15m timeframe state
     * @returns Alignment score (0-100)
     */
    calcAlignmentScore(daily, h4, m15) {
        let score = 0;
        // Daily-4H agreement (50 points) - Most important
        if (daily.trend === h4.trend && daily.trend !== 'RANGE') {
            score += 50;
        }
        // 4H-15m agreement (30 points) - Secondary importance
        if (h4.trend === m15.trend && h4.trend !== 'RANGE') {
            score += 30;
        }
        // 15m MSS confirmation (20 points) - Trigger confirmation
        if (m15.mss !== null) {
            score += 20;
        }
        return Math.min(100, score);
    }
    /**
     * Apply veto logic for Premium/Discount zones
     * VETO RULE: Don't buy expensive (Premium), don't sell cheap (Discount)
     *
     * @param daily - Daily timeframe state (bias)
     * @param h4 - 4H timeframe state (narrative/location)
     * @returns VetoResult with veto decision and reason
     */
    applyVetoLogic(daily, h4) {
        // VETO: Daily BULLISH but 4H in PREMIUM â†’ Don't buy expensive
        if (daily.trend === 'BULL' && h4.location === 'PREMIUM') {
            return {
                vetoed: true,
                reason: 'Daily BULLISH but 4H in PREMIUM (too expensive to buy)',
                direction: 'LONG'
            };
        }
        // VETO: Daily BEARISH but 4H in DISCOUNT â†’ Don't sell cheap
        if (daily.trend === 'BEAR' && h4.location === 'DISCOUNT') {
            return {
                vetoed: true,
                reason: 'Daily BEARISH but 4H in DISCOUNT (too cheap to sell)',
                direction: 'SHORT'
            };
        }
        // No veto - alignment is valid
        return {
            vetoed: false,
            reason: null,
            direction: null
        };
    }
    /**
     * Determine hologram status based on alignment score and veto logic
     * A+ = Score >= 80 and no veto
     * B = Score 60-79 and no veto
     * NO_PLAY = Vetoed
     * CONFLICT = Score < 60
     *
     * @param score - Alignment score (0-100)
     * @param veto - Veto result
     * @returns HologramStatus classification
     */
    getHologramStatus(score, veto) {
        // If vetoed, return NO_PLAY regardless of score
        if (veto.vetoed) {
            return 'NO_PLAY';
        }
        // A+ Alignment: Score >= 80 (full confluence)
        if (score >= 80) {
            return 'A+';
        }
        // B Alignment: Score 60-79 (partial confluence)
        if (score >= 60) {
            return 'B';
        }
        // Conflict: Score < 60 (timeframes disagree)
        return 'CONFLICT';
    }
    /**
     * Calculate Relative Strength vs BTC over 4 hours
     * RS > 0 = Asset stronger than BTC (trade long)
     * RS < 0 = Asset weaker than BTC (trade short)
     *
     * @param symbol - Asset symbol to compare
     * @returns Promise with RS score (-1 to +1)
     */
    async calcRelativeStrength(symbol) {
        try {
            // Skip RS calculation for BTC itself
            if (symbol.toUpperCase() === 'BTCUSDT') {
                return 0;
            }
            // Fetch 4-hour data for both asset and BTC (last 2 candles)
            const [assetCandles, btcCandles] = await Promise.all([
                this.fetchCachedOHLCV(symbol, '4h', 2),
                this.fetchCachedOHLCV('BTCUSDT', '4h', 2)
            ]);
            // Validate we have enough data
            if (assetCandles.length < 2 || btcCandles.length < 2) {
                console.warn(`âš ï¸ Insufficient data for RS calculation: ${symbol}`);
                return 0;
            }
            // Calculate % change over 4 hours (current vs previous)
            const assetChange = (assetCandles[1].close - assetCandles[0].close) / assetCandles[0].close;
            const btcChange = (btcCandles[1].close - btcCandles[0].close) / btcCandles[0].close;
            // RS Score = Asset % change - BTC % change
            const rsScore = assetChange - btcChange;
            // Clamp to reasonable range (-1 to +1)
            return Math.max(-1, Math.min(1, rsScore));
        }
        catch (error) {
            console.warn(`âš ï¸ Failed to calculate RS for ${symbol}: ${error instanceof Error ? error.message : 'Unknown error'}`);
            return 0; // Return neutral RS on error
        }
    }
    /**
     * Fetch OHLCV data with caching to minimize API calls
     * Cache TTL is 5 minutes to balance freshness with API efficiency
     *
     * @param symbol - Trading symbol
     * @param interval - Timeframe interval
     * @param limit - Number of candles
     * @returns Promise with cached or fresh OHLCV data
     */
    async fetchCachedOHLCV(symbol, interval, limit) {
        const cacheKey = `${symbol}-${interval}-${limit}`;
        const cached = this.cache.get(cacheKey);
        // Return cached data if valid
        if (cached && Date.now() - cached.timestamp < this.CACHE_TTL) {
            return cached.data;
        }
        // Fetch fresh data from exchange
        const data = await this.bybitClient.fetchOHLCV(symbol, interval, limit);
        // Cache the data
        this.cache.set(cacheKey, {
            data,
            timestamp: Date.now()
        });
        return data;
    }
    /**
     * Clear the OHLCV cache
     * Useful for testing or forcing fresh data fetch
     */
    clearCache() {
        this.cache.clear();
    }
    /**
     * Get cache statistics for monitoring
     * @returns Object with cache size and hit rate info
     */
    getCacheStats() {
        return {
            size: this.cache.size,
            keys: Array.from(this.cache.keys())
        };
    }
    /**
     * Validate hologram state for completeness
     * Ensures all required fields are present and valid
     *
     * @param hologram - Hologram state to validate
     * @returns true if valid, throws error if invalid
     */
    static validateHologramState(hologram) {
        if (!hologram.symbol || typeof hologram.symbol !== 'string') {
            throw new Error('Invalid hologram: missing or invalid symbol');
        }
        if (!hologram.timestamp || typeof hologram.timestamp !== 'number') {
            throw new Error('Invalid hologram: missing or invalid timestamp');
        }
        if (hologram.alignmentScore < 0 || hologram.alignmentScore > 100) {
            throw new Error('Invalid hologram: alignment score must be 0-100');
        }
        if (!['A+', 'B', 'CONFLICT', 'NO_PLAY'].includes(hologram.status)) {
            throw new Error('Invalid hologram: invalid status');
        }
        // Validate timeframe states
        const timeframes = [hologram.daily, hologram.h4, hologram.m15];
        for (const tf of timeframes) {
            if (!tf.fractals || !Array.isArray(tf.fractals)) {
                throw new Error(`Invalid hologram: missing fractals for ${tf.timeframe}`);
            }
            if (!tf.bos || !Array.isArray(tf.bos)) {
                throw new Error(`Invalid hologram: missing BOS for ${tf.timeframe}`);
            }
            if (!['BULL', 'BEAR', 'RANGE'].includes(tf.trend)) {
                throw new Error(`Invalid hologram: invalid trend for ${tf.timeframe}`);
            }
            if (!['PREMIUM', 'DISCOUNT', 'EQUILIBRIUM'].includes(tf.location)) {
                throw new Error(`Invalid hologram: invalid location for ${tf.timeframe}`);
            }
        }
        return true;
    }
    /**
     * Get human-readable hologram summary
     * Useful for logging and debugging
     *
     * @param hologram - Hologram state
     * @returns Formatted summary string
     */
    static getHologramSummary(hologram) {
        const { symbol, status, alignmentScore, rsScore, daily, h4, m15 } = hologram;
        const statusEmoji = {
            'A+': 'ðŸŸ¢',
            'B': 'ðŸŸ¡',
            'CONFLICT': 'ðŸ”´',
            'NO_PLAY': 'âš«'
        }[status];
        const rsEmoji = rsScore > 0.02 ? 'ðŸ“ˆ' : rsScore < -0.02 ? 'ðŸ“‰' : 'âž¡ï¸';
        return `${statusEmoji} ${symbol} | Score: ${alignmentScore} | RS: ${(rsScore * 100).toFixed(1)}% ${rsEmoji} | ` +
            `Daily: ${daily.trend}/${daily.location} | 4H: ${h4.trend}/${h4.location} | 15m: ${m15.trend}${m15.mss ? '/MSS' : ''}`;
    }
}
exports.HologramEngine = HologramEngine;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLXBoYXNlMi1odW50ZXIvc3JjL2VuZ2luZS9Ib2xvZ3JhbUVuZ2luZS50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7Ozs7Ozs7R0FhRzs7O0FBY0gsK0NBQTRDO0FBRzVDLE1BQWEsY0FBYztJQUNqQixXQUFXLENBQW1CO0lBQzlCLEtBQUssR0FBRyxJQUFJLEdBQUcsRUFBZ0QsQ0FBQztJQUN2RCxTQUFTLEdBQUcsQ0FBQyxHQUFHLEVBQUUsR0FBRyxJQUFJLENBQUMsQ0FBQyxZQUFZO0lBRXhELFlBQVksV0FBNkI7UUFDdkMsSUFBSSxDQUFDLFdBQVcsR0FBRyxXQUFXLENBQUM7SUFDakMsQ0FBQztJQUVEOzs7Ozs7T0FNRztJQUNJLEtBQUssQ0FBQyxPQUFPLENBQUMsTUFBYztRQUNqQyxJQUFJLENBQUM7WUFDSCxvREFBb0Q7WUFDcEQsTUFBTSxDQUFDLFlBQVksRUFBRSxTQUFTLEVBQUUsVUFBVSxDQUFDLEdBQUcsTUFBTSxPQUFPLENBQUMsR0FBRyxDQUFDO2dCQUM5RCxJQUFJLENBQUMsZ0JBQWdCLENBQUMsTUFBTSxFQUFFLElBQUksRUFBRSxHQUFHLENBQUM7Z0JBQ3hDLElBQUksQ0FBQyxnQkFBZ0IsQ0FBQyxNQUFNLEVBQUUsSUFBSSxFQUFFLEdBQUcsQ0FBQztnQkFDeEMsSUFBSSxDQUFDLGdCQUFnQixDQUFDLE1BQU0sRUFBRSxLQUFLLEVBQUUsR0FBRyxDQUFDO2FBQzFDLENBQUMsQ0FBQztZQUVILGdCQUFnQjtZQUNoQix5QkFBVyxDQUFDLGVBQWUsQ0FBQyxZQUFZLEVBQUUsQ0FBQyxDQUFDLENBQUM7WUFDN0MseUJBQVcsQ0FBQyxlQUFlLENBQUMsU0FBUyxFQUFFLENBQUMsQ0FBQyxDQUFDO1lBQzFDLHlCQUFXLENBQUMsZUFBZSxDQUFDLFVBQVUsRUFBRSxDQUFDLENBQUMsQ0FBQztZQUUzQyw2Q0FBNkM7WUFDN0MsTUFBTSxLQUFLLEdBQUcsSUFBSSxDQUFDLGdCQUFnQixD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O0lBQ2hJLENBQUM7Q0FDRjtBQTVXRCx3Q0E0V0MiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLXBoYXNlMi1odW50ZXIvc3JjL2VuZ2luZS9Ib2xvZ3JhbUVuZ2luZS50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIEhvbG9ncmFtRW5naW5lIC0gTXVsdGktVGltZWZyYW1lIFN0YXRlIE1hY2hpbmVcbiAqIFxuICogQ29tYmluZXMgRGFpbHkgKEJpYXMpLCA0SCAoTmFycmF0aXZlKSwgYW5kIDE1bSAoVHJpZ2dlcikgaW50byBhIHNpbmdsZSBzdGF0ZSB2ZWN0b3JcbiAqIHdpdGggd2VpZ2h0ZWQgc2NvcmluZyBhbmQgdmV0byBsb2dpYy4gVGhpcyBpcyB0aGUgY29yZSBvZiB0aGUgSG9sb2dyYXBoaWMgTWFya2V0XG4gKiBTdHJ1Y3R1cmUgRW5naW5lIHRoYXQgZmlsdGVycyBvdXQgbm9pc2UgYW5kIGlkZW50aWZpZXMgaGlnaC1wcm9iYWJpbGl0eSBzZXR1cHMuXG4gKiBcbiAqIENvcmUgUGhpbG9zb3BoeTogXCJXZSBkb24ndCB0cmFkZSB0cmVuZHMuIFdlIHRyYWRlIHRoZSBNYW5pcHVsYXRpb24gUGhhc2Ugb2YgdGhlIEFNRFxuICogKEFjY3VtdWxhdGlvbi1NYW5pcHVsYXRpb24tRGlzdHJpYnV0aW9uKSBjeWNsZS4gV2UgaWRlbnRpZnkgd2hlcmUgaW5zdGl0dXRpb25hbFxuICogYWxnb3JpdGhtcyBhcmUgZm9yY2VkIHRvIGluamVjdCBsaXF1aWRpdHksIGFuZCB3ZSBwb3NpdGlvbiBvdXJzZWx2ZXMgdG8gY2FwdHVyZVxuICogdGhlIHN1YnNlcXVlbnQgZGlzdHJpYnV0aW9uLlwiXG4gKiBcbiAqIFJlcXVpcmVtZW50czogMS4xLTEuNyAoSG9sb2dyYXBoaWMgU3RhdGUgRW5naW5lKSwgMi4xLTIuNyAoQWxpZ25tZW50IExvZ2ljKSwgNi4xLTYuNyAoUlMgRmlsdGVyaW5nKVxuICovXG5cbmltcG9ydCB7IFxuICBPSExDViwgXG4gIFRpbWVmcmFtZVN0YXRlLCBcbiAgSG9sb2dyYW1TdGF0ZSwgXG4gIEhvbG9ncmFtU3RhdHVzLCBcbiAgVmV0b1Jlc3VsdCwgXG4gIFRyZW5kU3RhdGUsXG4gIERlYWxpbmdSYW5nZSxcbiAgRnJhY3RhbCxcbiAgQk9TLFxuICBNU1Ncbn0gZnJvbSAnLi4vdHlwZXMnO1xuaW1wb3J0IHsgRnJhY3RhbE1hdGggfSBmcm9tICcuL0ZyYWN0YWxNYXRoJztcbmltcG9ydCB7IEJ5Yml0UGVycHNDbGllbnQgfSBmcm9tICcuLi9leGNoYW5nZXMvQnliaXRQZXJwc0NsaWVudCc7XG5cbmV4cG9ydCBjbGFzcyBIb2xvZ3JhbUVuZ2luZSB7XG4gIHByaXZhdGUgYnliaXRDbGllbnQ6IEJ5Yml0UGVycHNDbGllbnQ7XG4gIHByaXZhdGUgY2FjaGUgPSBuZXcgTWFwPHN0cmluZywgeyBkYXRhOiBPSExDVltdOyB0aW1lc3RhbXA6IG51bWJlciB9PigpO1xuICBwcml2YXRlIHJlYWRvbmx5IENBQ0hFX1RUTCA9IDUgKiA2MCAqIDEwMDA7IC8vIDUgbWludXRlc1xuXG4gIGNvbnN0cnVjdG9yKGJ5Yml0Q2xpZW50OiBCeWJpdFBlcnBzQ2xpZW50KSB7XG4gICAgdGhpcy5ieWJpdENsaWVudCA9IGJ5Yml0Q2xpZW50O1xuICB9XG5cbiAgLyoqXG4gICAqIEFuYWx5emUgc3ltYm9sIGFjcm9zcyBhbGwgMyB0aW1lZnJhbWVzIHRvIGdlbmVyYXRlIGhvbG9ncmFtIHN0YXRlXG4gICAqIEZldGNoZXMgRGFpbHksIDRILCAxNW0gZGF0YSBhbmQgY29tYmluZXMgaW50byBzaW5nbGUgc3RhdGUgdmVjdG9yXG4gICAqIFxuICAgKiBAcGFyYW0gc3ltYm9sIC0gVHJhZGluZyBzeW1ib2wgKGUuZy4sICdCVENVU0RUJylcbiAgICogQHJldHVybnMgUHJvbWlzZSB3aXRoIGNvbXBsZXRlIGhvbG9ncmFtIHN0YXRlXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgYW5hbHl6ZShzeW1ib2w6IHN0cmluZyk6IFByb21pc2U8SG9sb2dyYW1TdGF0ZT4ge1xuICAgIHRyeSB7XG4gICAgICAvLyBGZXRjaCBPSExDViBkYXRhIGZvciBhbGwgMyB0aW1lZnJhbWVzIGluIHBhcmFsbGVsXG4gICAgICBjb25zdCBbZGFpbHlDYW5kbGVzLCBoNENhbmRsZXMsIG0xNUNhbmRsZXNdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgICB0aGlzLmZldGNoQ2FjaGVkT0hMQ1Yoc3ltYm9sLCAnMUQnLCAxMDApLFxuICAgICAgICB0aGlzLmZldGNoQ2FjaGVkT0hMQ1Yoc3ltYm9sLCAnNGgnLCAyMDApLFxuICAgICAgICB0aGlzLmZldGNoQ2FjaGVkT0hMQ1Yoc3ltYm9sLCAnMTVtJywgNTAwKVxuICAgICAgXSk7XG5cbiAgICAgIC8vIFZhbGlkYXRlIGRhdGFcbiAgICAgIEZyYWN0YWxNYXRoLnZhbGlkYXRlQ2FuZGxlcyhkYWlseUNhbmRsZXMsIDUpO1xuICAgICAgRnJhY3RhbE1hdGgudmFsaWRhdGVDYW5kbGVzKGg0Q2FuZGxlcywgNSk7XG4gICAgICBGcmFjdGFsTWF0aC52YWxpZGF0ZUNhbmRsZXMobTE1Q2FuZGxlcywgNSk7XG5cbiAgICAgIC8vIENhbGN1bGF0ZSBmcmFjdGFsIHN0YXRlIGZvciBlYWNoIHRpbWVmcmFtZVxuICAgICAgY29uc3QgZGFpbHkgPSB0aGlzLmFuYWx5emVUaW1lZnJhbWUoZGFpbHlDYW5kbGVzLCAnMUQnKTtcbiAgICAgIGNvbnN0IGg0ID0gdGhpcy5hbmFseXplVGltZWZyYW1lKGg0Q2FuZGxlcywgJzRIJyk7XG4gICAgICBjb25zdCBtMTUgPSB0aGlzLmFuYWx5emVUaW1lZnJhbWUobTE1Q2FuZGxlcywgJzE1bScpO1xuXG4gICAgICAvLyBDYWxjdWxhdGUgYWxpZ25tZW50IHNjb3JlIHVzaW5nIHdlaWdodGVkIGZvcm11bGFcbiAgICAgIGNvbnN0IGFsaWdubWVudFNjb3JlID0gdGhpcy5jYWxjQWxpZ25tZW50U2NvcmUoZGFpbHksIGg0LCBtMTUpO1xuXG4gICAgICAvLyBBcHBseSB2ZXRvIGxvZ2ljIGZvciBQcmVtaXVtL0Rpc2NvdW50IHpvbmVzXG4gICAgICBjb25zdCB2ZXRvID0gdGhpcy5hcHBseVZldG9Mb2dpYyhkYWlseSwgaDQpO1xuXG4gICAgICAvLyBEZXRlcm1pbmUgaG9sb2dyYW0gc3RhdHVzIGJhc2VkIG9uIHNjb3JlIGFuZCB2ZXRvXG4gICAgICBjb25zdCBzdGF0dXMgPSB0aGlzLmdldEhvbG9ncmFtU3RhdHVzKGFsaWdubWVudFNjb3JlLCB2ZXRvKTtcblxuICAgICAgLy8gQ2FsY3VsYXRlIFJlbGF0aXZlIFN0cmVuZ3RoIHZzIEJUQyBvdmVyIDQgaG91cnNcbiAgICAgIGNvbnN0IHJzU2NvcmUgPSBhd2FpdCB0aGlzLmNhbGNSZWxhdGl2ZVN0cmVuZ3RoKHN5bWJvbCk7XG5cbiAgICAgIHJldHVybiB7XG4gICAgICAgIHN5bWJvbCxcbiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgICBkYWlseSxcbiAgICAgICAgaDQsXG4gICAgICAgIG0xNSxcbiAgICAgICAgYWxpZ25tZW50U2NvcmUsXG4gICAgICAgIHN0YXR1cyxcbiAgICAgICAgdmV0byxcbiAgICAgICAgcnNTY29yZVxuICAgICAgfTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGBGYWlsZWQgdG8gYW5hbHl6ZSBob2xvZ3JhbSBmb3IgJHtzeW1ib2x9OiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InfWApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBBbmFseXplIHNpbmdsZSB0aW1lZnJhbWUgdG8gZ2VuZXJhdGUgdGltZWZyYW1lIHN0YXRlXG4gICAqIFJ1bnMgZnJhY3RhbCBkZXRlY3Rpb24sIEJPUy9NU1MgYW5hbHlzaXMsIGFuZCBkZWFsaW5nIHJhbmdlIGNhbGN1bGF0aW9uXG4gICAqIFxuICAgKiBAcGFyYW0gY2FuZGxlcyAtIE9ITENWIGRhdGEgZm9yIHRpbWVmcmFtZVxuICAgKiBAcGFyYW0gdGltZWZyYW1lIC0gVGltZWZyYW1lIGlkZW50aWZpZXJcbiAgICogQHJldHVybnMgVGltZWZyYW1lU3RhdGUgd2l0aCBhbGwgYW5hbHlzaXMgcmVzdWx0c1xuICAgKi9cbiAgcHJpdmF0ZSBhbmFseXplVGltZWZyYW1lKGNhbmRsZXM6IE9ITENWW10sIHRpbWVmcmFtZTogJzFEJyB8ICc0SCcgfCAnMTVtJyk6IFRpbWVmcmFtZVN0YXRlIHtcbiAgICAvLyBEZXRlY3QgZnJhY3RhbHMgdXNpbmcgQmlsbCBXaWxsaWFtcyBkZWZpbml0aW9uXG4gICAgY29uc3QgZnJhY3RhbHMgPSBGcmFjdGFsTWF0aC5kZXRlY3RGcmFjdGFscyhjYW5kbGVzKTtcblxuICAgIC8vIERldGVjdCBCcmVhayBvZiBTdHJ1Y3R1cmUgZXZlbnRzXG4gICAgY29uc3QgYm9zID0gRnJhY3RhbE1hdGguZGV0ZWN0Qk9TKGNhbmRsZXMsIGZyYWN0YWxzKTtcblxuICAgIC8vIERldGVybWluZSBjdXJyZW50IHRyZW5kIHN0YXRlXG4gICAgY29uc3QgdHJlbmQgPSBGcmFjdGFsTWF0aC5nZXRUcmVuZFN0YXRlKGJvcyk7XG5cbiAgICAvLyBEZXRlY3QgTWFya2V0IFN0cnVjdHVyZSBTaGlmdCAob25seSBmb3IgMTVtIHRpbWVmcmFtZSBhcyB0cmlnZ2VyKVxuICAgIGxldCBtc3M6IE1TUyB8IG51bGwgPSBudWxsO1xuICAgIGlmICh0aW1lZnJhbWUgPT09ICcxNW0nICYmIGJvcy5sZW5ndGggPiAwKSB7XG4gICAgICBtc3MgPSBGcmFjdGFsTWF0aC5kZXRlY3RNU1MoY2FuZGxlcywgZnJhY3RhbHMsIHRyZW5kKTtcbiAgICB9XG5cbiAgICAvLyBDYWxjdWxhdGUgZGVhbGluZyByYW5nZSBhbmQgUHJlbWl1bS9EaXNjb3VudCB6b25lc1xuICAgIGNvbnN0IGRlYWxpbmdSYW5nZSA9IEZyYWN0YWxNYXRoLmNhbGNEZWFsaW5nUmFuZ2UoZnJhY3RhbHMpO1xuXG4gICAgLy8gR2V0IGN1cnJlbnQgcHJpY2UgKGxhc3QgY2xvc2UpXG4gICAgY29uc3QgY3VycmVudFByaWNlID0gY2FuZGxlc1tjYW5kbGVzLmxlbmd0aCAtIDFdLmNsb3NlO1xuXG4gICAgLy8gRGV0ZXJtaW5lIHByaWNlIGxvY2F0aW9uIHdpdGhpbiBkZWFsaW5nIHJhbmdlXG4gICAgY29uc3QgbG9jYXRpb24gPSBGcmFjdGFsTWF0aC5nZXRQcmljZUxvY2F0aW9uKGN1cnJlbnRQcmljZSwgZGVhbGluZ1JhbmdlKTtcblxuICAgIHJldHVybiB7XG4gICAgICB0aW1lZnJhbWUsXG4gICAgICB0cmVuZCxcbiAgICAgIGRlYWxpbmdSYW5nZSxcbiAgICAgIGN1cnJlbnRQcmljZSxcbiAgICAgIGxvY2F0aW9uLFxuICAgICAgZnJhY3RhbHMsXG4gICAgICBib3MsXG4gICAgICBtc3NcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIENhbGN1bGF0ZSBhbGlnbm1lbnQgc2NvcmUgdXNpbmcgd2VpZ2h0ZWQgZm9ybXVsYVxuICAgKiBEYWlseSA1MCUsIDRIIDMwJSwgMTVtIDIwJSAtIGVtcGhhc2l6ZXMgaGlnaGVyIHRpbWVmcmFtZSBiaWFzXG4gICAqIFxuICAgKiBAcGFyYW0gZGFpbHkgLSBEYWlseSB0aW1lZnJhbWUgc3RhdGVcbiAgICogQHBhcmFtIGg0IC0gNEggdGltZWZyYW1lIHN0YXRlICBcbiAgICogQHBhcmFtIG0xNSAtIDE1bSB0aW1lZnJhbWUgc3RhdGVcbiAgICogQHJldHVybnMgQWxpZ25tZW50IHNjb3JlICgwLTEwMClcbiAgICovXG4gIHB1YmxpYyBjYWxjQWxpZ25tZW50U2NvcmUoZGFpbHk6IFRpbWVmcmFtZVN0YXRlLCBoNDogVGltZWZyYW1lU3RhdGUsIG0xNTogVGltZWZyYW1lU3RhdGUpOiBudW1iZXIge1xuICAgIGxldCBzY29yZSA9IDA7XG5cbiAgICAvLyBEYWlseS00SCBhZ3JlZW1lbnQgKDUwIHBvaW50cykgLSBNb3N0IGltcG9ydGFudFxuICAgIGlmIChkYWlseS50cmVuZCA9PT0gaDQudHJlbmQgJiYgZGFpbHkudHJlbmQgIT09ICdSQU5HRScpIHtcbiAgICAgIHNjb3JlICs9IDUwO1xuICAgIH1cblxuICAgIC8vIDRILTE1bSBhZ3JlZW1lbnQgKDMwIHBvaW50cykgLSBTZWNvbmRhcnkgaW1wb3J0YW5jZVxuICAgIGlmIChoNC50cmVuZCA9PT0gbTE1LnRyZW5kICYmIGg0LnRyZW5kICE9PSAnUkFOR0UnKSB7XG4gICAgICBzY29yZSArPSAzMDtcbiAgICB9XG5cbiAgICAvLyAxNW0gTVNTIGNvbmZpcm1hdGlvbiAoMjAgcG9pbnRzKSAtIFRyaWdnZXIgY29uZmlybWF0aW9uXG4gICAgaWYgKG0xNS5tc3MgIT09IG51bGwpIHtcbiAgICAgIHNjb3JlICs9IDIwO1xuICAgIH1cblxuICAgIHJldHVybiBNYXRoLm1pbigxMDAsIHNjb3JlKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBcHBseSB2ZXRvIGxvZ2ljIGZvciBQcmVtaXVtL0Rpc2NvdW50IHpvbmVzXG4gICAqIFZFVE8gUlVMRTogRG9uJ3QgYnV5IGV4cGVuc2l2ZSAoUHJlbWl1bSksIGRvbid0IHNlbGwgY2hlYXAgKERpc2NvdW50KVxuICAgKiBcbiAgICogQHBhcmFtIGRhaWx5IC0gRGFpbHkgdGltZWZyYW1lIHN0YXRlIChiaWFzKVxuICAgKiBAcGFyYW0gaDQgLSA0SCB0aW1lZnJhbWUgc3RhdGUgKG5hcnJhdGl2ZS9sb2NhdGlvbilcbiAgICogQHJldHVybnMgVmV0b1Jlc3VsdCB3aXRoIHZldG8gZGVjaXNpb24gYW5kIHJlYXNvblxuICAgKi9cbiAgcHVibGljIGFwcGx5VmV0b0xvZ2ljKGRhaWx5OiBUaW1lZnJhbWVTdGF0ZSwgaDQ6IFRpbWVmcmFtZVN0YXRlKTogVmV0b1Jlc3VsdCB7XG4gICAgLy8gVkVUTzogRGFpbHkgQlVMTElTSCBidXQgNEggaW4gUFJFTUlVTSDihpIgRG9uJ3QgYnV5IGV4cGVuc2l2ZVxuICAgIGlmIChkYWlseS50cmVuZCA9PT0gJ0JVTEwnICYmIGg0LmxvY2F0aW9uID09PSAnUFJFTUlVTScpIHtcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHZldG9lZDogdHJ1ZSxcbiAgICAgICAgcmVhc29uOiAnRGFpbHkgQlVMTElTSCBidXQgNEggaW4gUFJFTUlVTSAodG9vIGV4cGVuc2l2ZSB0byBidXkpJyxcbiAgICAgICAgZGlyZWN0aW9uOiAnTE9ORydcbiAgICAgIH07XG4gICAgfVxuXG4gICAgLy8gVkVUTzogRGFpbHkgQkVBUklTSCBidXQgNEggaW4gRElTQ09VTlQg4oaSIERvbid0IHNlbGwgY2hlYXBcbiAgICBpZiAoZGFpbHkudHJlbmQgPT09ICdCRUFSJyAmJiBoNC5sb2NhdGlvbiA9PT0gJ0RJU0NPVU5UJykge1xuICAgICAgcmV0dXJuIHtcbiAgICAgICAgdmV0b2VkOiB0cnVlLFxuICAgICAgICByZWFzb246ICdEYWlseSBCRUFSSVNIIGJ1dCA0SCBpbiBESVNDT1VOVCAodG9vIGNoZWFwIHRvIHNlbGwpJyxcbiAgICAgICAgZGlyZWN0aW9uOiAnU0hPUlQnXG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIE5vIHZldG8gLSBhbGlnbm1lbnQgaXMgdmFsaWRcbiAgICByZXR1cm4ge1xuICAgICAgdmV0b2VkOiBmYWxzZSxcbiAgICAgIHJlYXNvbjogbnVsbCxcbiAgICAgIGRpcmVjdGlvbjogbnVsbFxuICAgIH07XG4gIH1cblxuICAvKipcbiAgICogRGV0ZXJtaW5lIGhvbG9ncmFtIHN0YXR1cyBiYXNlZCBvbiBhbGlnbm1lbnQgc2NvcmUgYW5kIHZldG8gbG9naWNcbiAgICogQSsgPSBTY29yZSA+PSA4MCBhbmQgbm8gdmV0b1xuICAgKiBCID0gU2NvcmUgNjAtNzkgYW5kIG5vIHZldG9cbiAgICogTk9fUExBWSA9IFZldG9lZFxuICAgKiBDT05GTElDVCA9IFNjb3JlIDwgNjBcbiAgICogXG4gICAqIEBwYXJhbSBzY29yZSAtIEFsaWdubWVudCBzY29yZSAoMC0xMDApXG4gICAqIEBwYXJhbSB2ZXRvIC0gVmV0byByZXN1bHRcbiAgICogQHJldHVybnMgSG9sb2dyYW1TdGF0dXMgY2xhc3NpZmljYXRpb25cbiAgICovXG4gIHB1YmxpYyBnZXRIb2xvZ3JhbVN0YXR1cyhzY29yZTogbnVtYmVyLCB2ZXRvOiBWZXRvUmVzdWx0KTogSG9sb2dyYW1TdGF0dXMge1xuICAgIC8vIElmIHZldG9lZCwgcmV0dXJuIE5PX1BMQVkgcmVnYXJkbGVzcyBvZiBzY29yZVxuICAgIGlmICh2ZXRvLnZldG9lZCkge1xuICAgICAgcmV0dXJuICdOT19QTEFZJztcbiAgICB9XG5cbiAgICAvLyBBKyBBbGlnbm1lbnQ6IFNjb3JlID49IDgwIChmdWxsIGNvbmZsdWVuY2UpXG4gICAgaWYgKHNjb3JlID49IDgwKSB7XG4gICAgICByZXR1cm4gJ0ErJztcbiAgICB9XG5cbiAgICAvLyBCIEFsaWdubWVudDogU2NvcmUgNjAtNzkgKHBhcnRpYWwgY29uZmx1ZW5jZSlcbiAgICBpZiAoc2NvcmUgPj0gNjApIHtcbiAgICAgIHJldHVybiAnQic7XG4gICAgfVxuXG4gICAgLy8gQ29uZmxpY3Q6IFNjb3JlIDwgNjAgKHRpbWVmcmFtZXMgZGlzYWdyZWUpXG4gICAgcmV0dXJuICdDT05GTElDVCc7XG4gIH1cblxuICAvKipcbiAgICogQ2FsY3VsYXRlIFJlbGF0aXZlIFN0cmVuZ3RoIHZzIEJUQyBvdmVyIDQgaG91cnNcbiAgICogUlMgPiAwID0gQXNzZXQgc3Ryb25nZXIgdGhhbiBCVEMgKHRyYWRlIGxvbmcpXG4gICAqIFJTIDwgMCA9IEFzc2V0IHdlYWtlciB0aGFuIEJUQyAodHJhZGUgc2hvcnQpXG4gICAqIFxuICAgKiBAcGFyYW0gc3ltYm9sIC0gQXNzZXQgc3ltYm9sIHRvIGNvbXBhcmVcbiAgICogQHJldHVybnMgUHJvbWlzZSB3aXRoIFJTIHNjb3JlICgtMSB0byArMSlcbiAgICovXG4gIHB1YmxpYyBhc3luYyBjYWxjUmVsYXRpdmVTdHJlbmd0aChzeW1ib2w6IHN0cmluZyk6IFByb21pc2U8bnVtYmVyPiB7XG4gICAgdHJ5IHtcbiAgICAgIC8vIFNraXAgUlMgY2FsY3VsYXRpb24gZm9yIEJUQyBpdHNlbGZcbiAgICAgIGlmIChzeW1ib2wudG9VcHBlckNhc2UoKSA9PT0gJ0JUQ1VTRFQnKSB7XG4gICAgICAgIHJldHVybiAwO1xuICAgICAgfVxuXG4gICAgICAvLyBGZXRjaCA0LWhvdXIgZGF0YSBmb3IgYm90aCBhc3NldCBhbmQgQlRDIChsYXN0IDIgY2FuZGxlcylcbiAgICAgIGNvbnN0IFthc3NldENhbmRsZXMsIGJ0Y0NhbmRsZXNdID0gYXdhaXQgUHJvbWlzZS5hbGwoW1xuICAgICAgICB0aGlzLmZldGNoQ2FjaGVkT0hMQ1Yoc3ltYm9sLCAnNGgnLCAyKSxcbiAgICAgICAgdGhpcy5mZXRjaENhY2hlZE9ITENWKCdCVENVU0RUJywgJzRoJywgMilcbiAgICAgIF0pO1xuXG4gICAgICAvLyBWYWxpZGF0ZSB3ZSBoYXZlIGVub3VnaCBkYXRhXG4gICAgICBpZiAoYXNzZXRDYW5kbGVzLmxlbmd0aCA8IDIgfHwgYnRjQ2FuZGxlcy5sZW5ndGggPCAyKSB7XG4gICAgICAgIGNvbnNvbGUud2Fybihg4pqg77iPIEluc3VmZmljaWVudCBkYXRhIGZvciBSUyBjYWxjdWxhdGlvbjogJHtzeW1ib2x9YCk7XG4gICAgICAgIHJldHVybiAwO1xuICAgICAgfVxuXG4gICAgICAvLyBDYWxjdWxhdGUgJSBjaGFuZ2Ugb3ZlciA0IGhvdXJzIChjdXJyZW50IHZzIHByZXZpb3VzKVxuICAgICAgY29uc3QgYXNzZXRDaGFuZ2UgPSAoYXNzZXRDYW5kbGVzWzFdLmNsb3NlIC0gYXNzZXRDYW5kbGVzWzBdLmNsb3NlKSAvIGFzc2V0Q2FuZGxlc1swXS5jbG9zZTtcbiAgICAgIGNvbnN0IGJ0Y0NoYW5nZSA9IChidGNDYW5kbGVzWzFdLmNsb3NlIC0gYnRjQ2FuZGxlc1swXS5jbG9zZSkgLyBidGNDYW5kbGVzWzBdLmNsb3NlO1xuXG4gICAgICAvLyBSUyBTY29yZSA9IEFzc2V0ICUgY2hhbmdlIC0gQlRDICUgY2hhbmdlXG4gICAgICBjb25zdCByc1Njb3JlID0gYXNzZXRDaGFuZ2UgLSBidGNDaGFuZ2U7XG5cbiAgICAgIC8vIENsYW1wIHRvIHJlYXNvbmFibGUgcmFuZ2UgKC0xIHRvICsxKVxuICAgICAgcmV0dXJuIE1hdGgubWF4KC0xLCBNYXRoLm1pbigxLCByc1Njb3JlKSk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUud2Fybihg4pqg77iPIEZhaWxlZCB0byBjYWxjdWxhdGUgUlMgZm9yICR7c3ltYm9sfTogJHtlcnJvciBpbnN0YW5jZW9mIEVycm9yID8gZXJyb3IubWVzc2FnZSA6ICdVbmtub3duIGVycm9yJ31gKTtcbiAgICAgIHJldHVybiAwOyAvLyBSZXR1cm4gbmV1dHJhbCBSUyBvbiBlcnJvclxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBGZXRjaCBPSExDViBkYXRhIHdpdGggY2FjaGluZyB0byBtaW5pbWl6ZSBBUEkgY2FsbHNcbiAgICogQ2FjaGUgVFRMIGlzIDUgbWludXRlcyB0byBiYWxhbmNlIGZyZXNobmVzcyB3aXRoIEFQSSBlZmZpY2llbmN5XG4gICAqIFxuICAgKiBAcGFyYW0gc3ltYm9sIC0gVHJhZGluZyBzeW1ib2xcbiAgICogQHBhcmFtIGludGVydmFsIC0gVGltZWZyYW1lIGludGVydmFsXG4gICAqIEBwYXJhbSBsaW1pdCAtIE51bWJlciBvZiBjYW5kbGVzXG4gICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCBjYWNoZWQgb3IgZnJlc2ggT0hMQ1YgZGF0YVxuICAgKi9cbiAgcHJpdmF0ZSBhc3luYyBmZXRjaENhY2hlZE9ITENWKHN5bWJvbDogc3RyaW5nLCBpbnRlcnZhbDogc3RyaW5nLCBsaW1pdDogbnVtYmVyKTogUHJvbWlzZTxPSExDVltdPiB7XG4gICAgY29uc3QgY2FjaGVLZXkgPSBgJHtzeW1ib2x9LSR7aW50ZXJ2YWx9LSR7bGltaXR9YDtcbiAgICBjb25zdCBjYWNoZWQgPSB0aGlzLmNhY2hlLmdldChjYWNoZUtleSk7XG5cbiAgICAvLyBSZXR1cm4gY2FjaGVkIGRhdGEgaWYgdmFsaWRcbiAgICBpZiAoY2FjaGVkICYmIERhdGUubm93KCkgLSBjYWNoZWQudGltZXN0YW1wIDwgdGhpcy5DQUNIRV9UVEwpIHtcbiAgICAgIHJldHVybiBjYWNoZWQuZGF0YTtcbiAgICB9XG5cbiAgICAvLyBGZXRjaCBmcmVzaCBkYXRhIGZyb20gZXhjaGFuZ2VcbiAgICBjb25zdCBkYXRhID0gYXdhaXQgdGhpcy5ieWJpdENsaWVudC5mZXRjaE9ITENWKHN5bWJvbCwgaW50ZXJ2YWwsIGxpbWl0KTtcbiAgICBcbiAgICAvLyBDYWNoZSB0aGUgZGF0YVxuICAgIHRoaXMuY2FjaGUuc2V0KGNhY2hlS2V5LCB7XG4gICAgICBkYXRhLFxuICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpXG4gICAgfSk7XG5cbiAgICByZXR1cm4gZGF0YTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhciB0aGUgT0hMQ1YgY2FjaGVcbiAgICogVXNlZnVsIGZvciB0ZXN0aW5nIG9yIGZvcmNpbmcgZnJlc2ggZGF0YSBmZXRjaFxuICAgKi9cbiAgcHVibGljIGNsZWFyQ2FjaGUoKTogdm9pZCB7XG4gICAgdGhpcy5jYWNoZS5jbGVhcigpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBjYWNoZSBzdGF0aXN0aWNzIGZvciBtb25pdG9yaW5nXG4gICAqIEByZXR1cm5zIE9iamVjdCB3aXRoIGNhY2hlIHNpemUgYW5kIGhpdCByYXRlIGluZm9cbiAgICovXG4gIHB1YmxpYyBnZXRDYWNoZVN0YXRzKCk6IHsgc2l6ZTogbnVtYmVyOyBrZXlzOiBzdHJpbmdbXSB9IHtcbiAgICByZXR1cm4ge1xuICAgICAgc2l6ZTogdGhpcy5jYWNoZS5zaXplLFxuICAgICAga2V5czogQXJyYXkuZnJvbSh0aGlzLmNhY2hlLmtleXMoKSlcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIFZhbGlkYXRlIGhvbG9ncmFtIHN0YXRlIGZvciBjb21wbGV0ZW5lc3NcbiAgICogRW5zdXJlcyBhbGwgcmVxdWlyZWQgZmllbGRzIGFyZSBwcmVzZW50IGFuZCB2YWxpZFxuICAgKiBcbiAgICogQHBhcmFtIGhvbG9ncmFtIC0gSG9sb2dyYW0gc3RhdGUgdG8gdmFsaWRhdGVcbiAgICogQHJldHVybnMgdHJ1ZSBpZiB2YWxpZCwgdGhyb3dzIGVycm9yIGlmIGludmFsaWRcbiAgICovXG4gIHB1YmxpYyBzdGF0aWMgdmFsaWRhdGVIb2xvZ3JhbVN0YXRlKGhvbG9ncmFtOiBIb2xvZ3JhbVN0YXRlKTogYm9vbGVhbiB7XG4gICAgaWYgKCFob2xvZ3JhbS5zeW1ib2wgfHwgdHlwZW9mIGhvbG9ncmFtLnN5bWJvbCAhPT0gJ3N0cmluZycpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBob2xvZ3JhbTogbWlzc2luZyBvciBpbnZhbGlkIHN5bWJvbCcpO1xuICAgIH1cblxuICAgIGlmICghaG9sb2dyYW0udGltZXN0YW1wIHx8IHR5cGVvZiBob2xvZ3JhbS50aW1lc3RhbXAgIT09ICdudW1iZXInKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgaG9sb2dyYW06IG1pc3Npbmcgb3IgaW52YWxpZCB0aW1lc3RhbXAnKTtcbiAgICB9XG5cbiAgICBpZiAoaG9sb2dyYW0uYWxpZ25tZW50U2NvcmUgPCAwIHx8IGhvbG9ncmFtLmFsaWdubWVudFNjb3JlID4gMTAwKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ludmFsaWQgaG9sb2dyYW06IGFsaWdubWVudCBzY29yZSBtdXN0IGJlIDAtMTAwJyk7XG4gICAgfVxuXG4gICAgaWYgKCFbJ0ErJywgJ0InLCAnQ09ORkxJQ1QnLCAnTk9fUExBWSddLmluY2x1ZGVzKGhvbG9ncmFtLnN0YXR1cykpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignSW52YWxpZCBob2xvZ3JhbTogaW52YWxpZCBzdGF0dXMnKTtcbiAgICB9XG5cbiAgICAvLyBWYWxpZGF0ZSB0aW1lZnJhbWUgc3RhdGVzXG4gICAgY29uc3QgdGltZWZyYW1lcyA9IFtob2xvZ3JhbS5kYWlseSwgaG9sb2dyYW0uaDQsIGhvbG9ncmFtLm0xNV07XG4gICAgZm9yIChjb25zdCB0ZiBvZiB0aW1lZnJhbWVzKSB7XG4gICAgICBpZiAoIXRmLmZyYWN0YWxzIHx8ICFBcnJheS5pc0FycmF5KHRmLmZyYWN0YWxzKSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoYEludmFsaWQgaG9sb2dyYW06IG1pc3NpbmcgZnJhY3RhbHMgZm9yICR7dGYudGltZWZyYW1lfWApO1xuICAgICAgfVxuICAgICAgXG4gICAgICBpZiAoIXRmLmJvcyB8fCAhQXJyYXkuaXNBcnJheSh0Zi5ib3MpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBob2xvZ3JhbTogbWlzc2luZyBCT1MgZm9yICR7dGYudGltZWZyYW1lfWApO1xuICAgICAgfVxuICAgICAgXG4gICAgICBpZiAoIVsnQlVMTCcsICdCRUFSJywgJ1JBTkdFJ10uaW5jbHVkZXModGYudHJlbmQpKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBob2xvZ3JhbTogaW52YWxpZCB0cmVuZCBmb3IgJHt0Zi50aW1lZnJhbWV9YCk7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGlmICghWydQUkVNSVVNJywgJ0RJU0NPVU5UJywgJ0VRVUlMSUJSSVVNJ10uaW5jbHVkZXModGYubG9jYXRpb24pKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBob2xvZ3JhbTogaW52YWxpZCBsb2NhdGlvbiBmb3IgJHt0Zi50aW1lZnJhbWV9YCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIHRydWU7XG4gIH1cblxuICAvKipcbiAgICogR2V0IGh1bWFuLXJlYWRhYmxlIGhvbG9ncmFtIHN1bW1hcnlcbiAgICogVXNlZnVsIGZvciBsb2dnaW5nIGFuZCBkZWJ1Z2dpbmdcbiAgICogXG4gICAqIEBwYXJhbSBob2xvZ3JhbSAtIEhvbG9ncmFtIHN0YXRlXG4gICAqIEByZXR1cm5zIEZvcm1hdHRlZCBzdW1tYXJ5IHN0cmluZ1xuICAgKi9cbiAgcHVibGljIHN0YXRpYyBnZXRIb2xvZ3JhbVN1bW1hcnkoaG9sb2dyYW06IEhvbG9ncmFtU3RhdGUpOiBzdHJpbmcge1xuICAgIGNvbnN0IHsgc3ltYm9sLCBzdGF0dXMsIGFsaWdubWVudFNjb3JlLCByc1Njb3JlLCBkYWlseSwgaDQsIG0xNSB9ID0gaG9sb2dyYW07XG4gICAgXG4gICAgY29uc3Qgc3RhdHVzRW1vamkgPSB7XG4gICAgICAnQSsnOiAn8J+foicsXG4gICAgICAnQic6ICfwn5+hJywgXG4gICAgICAnQ09ORkxJQ1QnOiAn8J+UtCcsXG4gICAgICAnTk9fUExBWSc6ICfimqsnXG4gICAgfVtzdGF0dXNdO1xuXG4gICAgY29uc3QgcnNFbW9qaSA9IHJzU2NvcmUgPiAwLjAyID8gJ/Cfk4gnIDogcnNTY29yZSA8IC0wLjAyID8gJ/Cfk4knIDogJ+Keoe+4jyc7XG4gICAgXG4gICAgcmV0dXJuIGAke3N0YXR1c0Vtb2ppfSAke3N5bWJvbH0gfCBTY29yZTogJHthbGlnbm1lbnRTY29yZX0gfCBSUzogJHsocnNTY29yZSAqIDEwMCkudG9GaXhlZCgxKX0lICR7cnNFbW9qaX0gfCBgICtcbiAgICAgICAgICAgYERhaWx5OiAke2RhaWx5LnRyZW5kfS8ke2RhaWx5LmxvY2F0aW9ufSB8IDRIOiAke2g0LnRyZW5kfS8ke2g0LmxvY2F0aW9ufSB8IDE1bTogJHttMTUudHJlbmR9JHttMTUubXNzID8gJy9NU1MnIDogJyd9YDtcbiAgfVxufSJdLCJ2ZXJzaW9uIjozfQ==
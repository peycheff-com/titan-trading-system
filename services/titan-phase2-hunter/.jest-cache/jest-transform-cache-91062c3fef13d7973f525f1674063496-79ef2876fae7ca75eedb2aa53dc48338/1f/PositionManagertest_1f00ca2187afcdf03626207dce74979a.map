{"file":"/Users/ivan/Code/trading/titan/services/titan-phase2-hunter/tests/unit/PositionManager.test.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-phase2-hunter/tests/unit/PositionManager.test.ts"],"sourcesContent":["/**\n * Unit tests for PositionManager\n * Tests position management functionality including breakeven, partial profits, trailing stops\n */\n\nimport { PositionManager, PositionManagerConfig } from '../../src/risk/PositionManager';\nimport { BybitPerpsClient } from '../../src/exchanges/BybitPerpsClient';\nimport { Position } from '../../src/types';\n\n// Mock BybitPerpsClient\njest.mock('../../src/exchanges/BybitPerpsClient');\n\ndescribe('PositionManager', () => {\n  let positionManager: PositionManager;\n  let mockBybitClient: jest.Mocked<BybitPerpsClient>;\n  let mockPosition: Position;\n\n  beforeEach(() => {\n    // Create mock client\n    mockBybitClient = new BybitPerpsClient('test-key', 'test-secret') as jest.Mocked<BybitPerpsClient>;\n    \n    // Mock client methods\n    mockBybitClient.setStopLoss = jest.fn().mockResolvedValue(true);\n    mockBybitClient.placeOrderWithRetry = jest.fn().mockResolvedValue({\n      orderId: 'test-order-id',\n      symbol: 'BTCUSDT',\n      side: 'Sell',\n      qty: 0.5,\n      price: 52000,\n      status: 'FILLED',\n      timestamp: Date.now()\n    });\n    mockBybitClient.getCurrentPrice = jest.fn().mockResolvedValue(51000);\n\n    // Create position manager with test config\n    const config: Partial<PositionManagerConfig> = {\n      breakevenRLevel: 1.5,\n      partialProfitRLevel: 2.0,\n      partialProfitPercentage: 50,\n      trailingStopDistance: 1.0,\n      tightenAfterHours: 48,\n      tightenedStopDistance: 0.5\n    };\n\n    positionManager = new PositionManager(mockBybitClient, config);\n\n    // Create mock position\n    mockPosition = {\n      id: 'test-position-1',\n      symbol: 'BTCUSDT',\n      side: 'LONG',\n      entryPrice: 50000,\n      currentPrice: 51000,\n      quantity: 1.0,\n      leverage: 5,\n      stopLoss: 49250, // 1.5% stop\n      takeProfit: 52250, // 4.5% target (3:1 R:R)\n      unrealizedPnL: 1000,\n      realizedPnL: 0,\n      entryTime: Date.now() - (24 * 60 * 60 * 1000), // 24 hours ago\n      status: 'OPEN',\n      rValue: 1.33, // (1000 / 750) = 1.33R\n      atr: 500 // $500 ATR\n    };\n  });\n\n  afterEach(() => {\n    positionManager.destroy();\n    jest.clearAllMocks();\n  });\n\n  describe('Position Management', () => {\n    test('should add and retrieve positions', () => {\n      positionManager.addPosition(mockPosition);\n      \n      const retrievedPosition = positionManager.getPosition(mockPosition.id);\n      expect(retrievedPosition).toEqual(mockPosition);\n      \n      const allPositions = positionManager.getPositions();\n      expect(allPositions).toHaveLength(1);\n      expect(allPositions[0]).toEqual(mockPosition);\n    });\n\n    test('should remove positions', () => {\n      positionManager.addPosition(mockPosition);\n      expect(positionManager.getPositions()).toHaveLength(1);\n      \n      positionManager.removePosition(mockPosition.id);\n      expect(positionManager.getPositions()).toHaveLength(0);\n      expect(positionManager.getPosition(mockPosition.id)).toBeUndefined();\n    });\n\n    test('should update position data', () => {\n      positionManager.addPosition(mockPosition);\n      \n      const update = {\n        id: mockPosition.id,\n        currentPrice: 52000,\n        unrealizedPnL: 2000,\n        timestamp: Date.now()\n      };\n      \n      positionManager.updatePosition(update);\n      \n      const updatedPosition = positionManager.getPosition(mockPosition.id);\n      expect(updatedPosition?.currentPrice).toBe(52000);\n      expect(updatedPosition?.unrealizedPnL).toBe(2000);\n      expect(updatedPosition?.rValue).toBeCloseTo(2.67, 1); // 2000 / 750 = 2.67R\n    });\n  });\n\n  describe('Move Stop to Breakeven', () => {\n    test('should move stop to breakeven at 1.5R profit', async () => {\n      // Set position to 1.5R profit\n      mockPosition.rValue = 1.5;\n      mockPosition.unrealizedPnL = 1125; // 1.5 * 750 = 1125\n      \n      positionManager.addPosition(mockPosition);\n      \n      const result = await positionManager.moveStopToBreakeven(mockPosition);\n      \n      expect(result).toBe(true);\n      expect(mockBybitClient.setStopLoss).toHaveBeenCalledWith('BTCUSDT', 50000);\n      \n      const updatedPosition = positionManager.getPosition(mockPosition.id);\n      expect(updatedPosition?.stopLoss).toBe(50000); // Entry price\n    });\n\n    test('should not move stop to breakeven if not profitable enough', async () => {\n      // Set position to 1.0R profit (below 1.5R threshold)\n      mockPosition.rValue = 1.0;\n      \n      positionManager.addPosition(mockPosition);\n      \n      const result = await positionManager.moveStopToBreakeven(mockPosition);\n      \n      expect(result).toBe(false);\n      expect(mockBybitClient.setStopLoss).not.toHaveBeenCalled();\n    });\n\n    test('should not move stop if already at breakeven', async () => {\n      // Set stop already at entry price\n      mockPosition.stopLoss = mockPosition.entryPrice;\n      mockPosition.rValue = 2.0;\n      \n      positionManager.addPosition(mockPosition);\n      \n      const result = await positionManager.moveStopToBreakeven(mockPosition);\n      \n      expect(result).toBe(true);\n      expect(mockBybitClient.setStopLoss).not.toHaveBeenCalled();\n    });\n  });\n\n  describe('Take Partial Profit', () => {\n    test('should take partial profit at 2R profit', async () => {\n      // Set position to 2R profit\n      mockPosition.rValue = 2.0;\n      mockPosition.unrealizedPnL = 1500; // 2 * 750 = 1500\n      \n      positionManager.addPosition(mockPosition);\n      \n      const result = await positionManager.takePartialProfit(mockPosition);\n      \n      expect(result).toBe(true);\n      expect(mockBybitClient.placeOrderWithRetry).toHaveBeenCalledWith({\n        phase: 'phase2',\n        symbol: 'BTCUSDT',\n        side: 'Sell',\n        type: 'MARKET',\n        qty: 0.5, // 50% of 1.0\n        leverage: 5\n      });\n      \n      const updatedPosition = positionManager.getPosition(mockPosition.id);\n      expect(updatedPosition?.quantity).toBe(0.5); // Reduced by 50%\n    });\n\n    test('should not take partial profit if not profitable enough', async () => {\n      // Set position to 1.5R profit (below 2R threshold)\n      mockPosition.rValue = 1.5;\n      \n      positionManager.addPosition(mockPosition);\n      \n      const result = await positionManager.takePartialProfit(mockPosition);\n      \n      expect(result).toBe(false);\n      expect(mockBybitClient.placeOrderWithRetry).not.toHaveBeenCalled();\n    });\n  });\n\n  describe('Trailing Stop', () => {\n    test('should update trailing stop for profitable long position', async () => {\n      // Set profitable long position\n      mockPosition.rValue = 1.0;\n      mockPosition.currentPrice = 51000;\n      mockPosition.stopLoss = 49250; // Original stop\n      mockPosition.atr = 500;\n      \n      positionManager.addPosition(mockPosition);\n      \n      const result = await positionManager.updateTrailingStop(mockPosition);\n      \n      const expectedNewStop = 51000 - (500 * 1.0); // 50500\n      expect(result).toBe(true);\n      expect(mockBybitClient.setStopLoss).toHaveBeenCalledWith('BTCUSDT', expectedNewStop);\n    });\n\n    test('should update trailing stop for profitable short position', async () => {\n      // Set profitable short position\n      mockPosition.side = 'SHORT';\n      mockPosition.rValue = 1.0;\n      mockPosition.currentPrice = 49000;\n      mockPosition.stopLoss = 50750; // Original stop\n      mockPosition.atr = 500;\n      \n      positionManager.addPosition(mockPosition);\n      \n      const result = await positionManager.updateTrailingStop(mockPosition);\n      \n      const expectedNewStop = 49000 + (500 * 1.0); // 49500\n      expect(result).toBe(true);\n      expect(mockBybitClient.setStopLoss).toHaveBeenCalledWith('BTCUSDT', expectedNewStop);\n    });\n\n    test('should not trail stop if not profitable', async () => {\n      // Set unprofitable position\n      mockPosition.rValue = -0.5;\n      \n      positionManager.addPosition(mockPosition);\n      \n      const result = await positionManager.updateTrailingStop(mockPosition);\n      \n      expect(result).toBe(false);\n      expect(mockBybitClient.setStopLoss).not.toHaveBeenCalled();\n    });\n\n    test('should not trail stop if new stop is worse than current', async () => {\n      // Set position where trailing would make stop worse\n      mockPosition.rValue = 1.0;\n      mockPosition.currentPrice = 50500; // Close to entry\n      mockPosition.stopLoss = 50000; // Better than what trailing would set (50500 - 500 = 50000)\n      mockPosition.atr = 500;\n      \n      positionManager.addPosition(mockPosition);\n      \n      const result = await positionManager.updateTrailingStop(mockPosition);\n      \n      expect(result).toBe(false);\n      expect(mockBybitClient.setStopLoss).not.toHaveBeenCalled();\n    });\n  });\n\n  describe('Tighten Stop After 48h', () => {\n    test('should tighten stop after 48 hours', async () => {\n      // Set position older than 48 hours\n      mockPosition.entryTime = Date.now() - (50 * 60 * 60 * 1000); // 50 hours ago\n      mockPosition.currentPrice = 51000;\n      mockPosition.stopLoss = 49250; // Original stop\n      mockPosition.atr = 500;\n      \n      positionManager.addPosition(mockPosition);\n      \n      const result = await positionManager.tightenStopAfter48h(mockPosition);\n      \n      const expectedNewStop = 51000 - (500 * 0.5); // 50750 (0.5 ATR)\n      expect(result).toBe(true);\n      expect(mockBybitClient.setStopLoss).toHaveBeenCalledWith('BTCUSDT', expectedNewStop);\n    });\n\n    test('should not tighten stop if position is too young', async () => {\n      // Set position younger than 48 hours\n      mockPosition.entryTime = Date.now() - (24 * 60 * 60 * 1000); // 24 hours ago\n      \n      positionManager.addPosition(mockPosition);\n      \n      const result = await positionManager.tightenStopAfter48h(mockPosition);\n      \n      expect(result).toBe(false);\n      expect(mockBybitClient.setStopLoss).not.toHaveBeenCalled();\n    });\n  });\n\n  describe('Close Position', () => {\n    test('should close position for stop hit', async () => {\n      positionManager.addPosition(mockPosition);\n      \n      const result = await positionManager.closePosition(mockPosition, 'STOP_HIT');\n      \n      expect(result).toBe(true);\n      expect(mockBybitClient.placeOrderWithRetry).toHaveBeenCalledWith({\n        phase: 'phase2',\n        symbol: 'BTCUSDT',\n        side: 'Sell',\n        type: 'MARKET',\n        qty: 1.0,\n        leverage: 5\n      });\n      \n      // Position should be removed from management\n      expect(positionManager.getPosition(mockPosition.id)).toBeUndefined();\n    });\n\n    test('should close position for target hit', async () => {\n      positionManager.addPosition(mockPosition);\n      \n      const result = await positionManager.closePosition(mockPosition, 'TARGET_HIT');\n      \n      expect(result).toBe(true);\n      expect(mockBybitClient.placeOrderWithRetry).toHaveBeenCalledWith({\n        phase: 'phase2',\n        symbol: 'BTCUSDT',\n        side: 'Sell',\n        type: 'MARKET',\n        qty: 1.0,\n        leverage: 5\n      });\n    });\n\n    test('should close short position correctly', async () => {\n      mockPosition.side = 'SHORT';\n      positionManager.addPosition(mockPosition);\n      \n      const result = await positionManager.closePosition(mockPosition, 'MANUAL');\n      \n      expect(result).toBe(true);\n      expect(mockBybitClient.placeOrderWithRetry).toHaveBeenCalledWith({\n        phase: 'phase2',\n        symbol: 'BTCUSDT',\n        side: 'Buy', // Opposite side for short\n        type: 'MARKET',\n        qty: 1.0,\n        leverage: 5\n      });\n    });\n  });\n\n  describe('Statistics', () => {\n    test('should calculate position statistics', () => {\n      const position1 = { ...mockPosition, id: 'pos1', unrealizedPnL: 1000, realizedPnL: 500, rValue: 1.5 };\n      const position2 = { ...mockPosition, id: 'pos2', unrealizedPnL: -500, realizedPnL: 200, rValue: -0.5 };\n      \n      positionManager.addPosition(position1);\n      positionManager.addPosition(position2);\n      \n      const stats = positionManager.getStatistics();\n      \n      expect(stats.totalPositions).toBe(2);\n      expect(stats.openPositions).toBe(2);\n      expect(stats.totalUnrealizedPnL).toBe(500); // 1000 + (-500)\n      expect(stats.totalRealizedPnL).toBe(700); // 500 + 200\n      expect(stats.averageRValue).toBe(0.5); // (1.5 + (-0.5)) / 2\n    });\n  });\n\n  describe('Emergency Close', () => {\n    test('should emergency close all positions', async () => {\n      const position1 = { ...mockPosition, id: 'pos1' };\n      const position2 = { ...mockPosition, id: 'pos2' };\n      \n      positionManager.addPosition(position1);\n      positionManager.addPosition(position2);\n      \n      const result = await positionManager.emergencyCloseAll();\n      \n      expect(result.success).toBe(2);\n      expect(result.failed).toBe(0);\n      expect(mockBybitClient.placeOrderWithRetry).toHaveBeenCalledTimes(2);\n      expect(positionManager.getPositions()).toHaveLength(0);\n    });\n  });\n\n  describe('Configuration', () => {\n    test('should update configuration', () => {\n      const newConfig = {\n        breakevenRLevel: 2.0,\n        partialProfitRLevel: 3.0\n      };\n      \n      positionManager.updateConfig(newConfig);\n      \n      // Test that new config is applied (indirectly through behavior)\n      mockPosition.rValue = 1.8; // Between old (1.5) and new (2.0) breakeven level\n      positionManager.addPosition(mockPosition);\n      \n      // Should not move to breakeven with new config\n      expect(positionManager.moveStopToBreakeven(mockPosition)).resolves.toBe(false);\n    });\n  });\n\n  describe('Error Handling', () => {\n    test('should handle API errors gracefully', async () => {\n      mockBybitClient.setStopLoss.mockRejectedValue(new Error('API Error'));\n      \n      mockPosition.rValue = 1.5;\n      positionManager.addPosition(mockPosition);\n      \n      const result = await positionManager.moveStopToBreakeven(mockPosition);\n      \n      expect(result).toBe(false);\n      // Position should still be in management\n      expect(positionManager.getPosition(mockPosition.id)).toBeDefined();\n    });\n\n    test('should emit error events', (done) => {\n      mockBybitClient.setStopLoss.mockRejectedValue(new Error('Test Error'));\n      \n      positionManager.on('position:error', (position, error) => {\n        expect(position.id).toBe(mockPosition.id);\n        expect(error.message).toBe('Test Error');\n        done();\n      });\n      \n      mockPosition.rValue = 1.5;\n      positionManager.addPosition(mockPosition);\n      positionManager.moveStopToBreakeven(mockPosition);\n    });\n  });\n});"],"version":3}
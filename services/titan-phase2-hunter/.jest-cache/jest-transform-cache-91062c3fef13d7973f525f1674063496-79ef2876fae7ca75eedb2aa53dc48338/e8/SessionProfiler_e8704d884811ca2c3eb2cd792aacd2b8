29e92bf2968a09ca8552972d171c2a5b
"use strict";
/**
 * SessionProfiler - Time & Price Dynamics Engine
 *
 * Exploits the "Judas Swing" (false moves) at London/NY opens to catch
 * manipulation-to-distribution transitions. Identifies session-based
 * trading opportunities and manages time-based logic.
 *
 * Requirements: 2.1-2.7 (Session Profiler)
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.SessionProfiler = void 0;
const events_1 = require("events");
class SessionProfiler extends events_1.EventEmitter {
    asianRange = null;
    londonRange = null;
    currentSession = null;
    constructor() {
        super();
    }
    /**
     * Get current session state based on UTC time
     * Requirements: 2.1 (Session identification)
     */
    getSessionState() {
        const now = new Date();
        const utcHour = now.getUTCHours();
        const utcMinute = now.getUTCMinutes();
        const currentTime = utcHour + utcMinute / 60;
        let sessionType;
        let startTime;
        let endTime;
        // Asian session: 00:00 - 06:00 UTC (Accumulation phase)
        if (currentTime >= 0 && currentTime < 6) {
            sessionType = 'ASIAN';
            startTime = 0;
            endTime = 6;
        }
        // London session: 07:00 - 10:00 UTC (Manipulation phase)
        else if (currentTime >= 7 && currentTime < 10) {
            sessionType = 'LONDON';
            startTime = 7;
            endTime = 10;
        }
        // NY session: 13:00 - 16:00 UTC (Distribution phase)
        else if (currentTime >= 13 && currentTime < 16) {
            sessionType = 'NY';
            startTime = 13;
            endTime = 16;
        }
        // Dead Zone: 21:00 - 01:00 UTC (Low volume)
        else {
            sessionType = 'DEAD_ZONE';
            startTime = 21;
            endTime = 1; // Next day
        }
        // Calculate time remaining in current session
        let timeRemaining;
        if (sessionType === 'DEAD_ZONE') {
            // Handle overnight session
            if (currentTime >= 21) {
                timeRemaining = (24 - currentTime) + 1; // Until 01:00 next day
            }
            else {
                timeRemaining = 1 - currentTime; // Until 01:00
            }
        }
        else {
            timeRemaining = endTime - currentTime;
        }
        const sessionState = {
            type: sessionType,
            startTime,
            endTime,
            timeRemaining: Math.max(0, timeRemaining)
        };
        // Check for session transition
        if (!this.currentSession || this.currentSession.type !== sessionType) {
            this.handleSessionTransition(sessionState);
        }
        this.currentSession = sessionState;
        return sessionState;
    }
    /**
     * Check if current time is within tradeable killzone
     * Requirements: 2.6 (Killzone checking)
     */
    isKillzone() {
        const sessionState = this.getSessionState();
        // Only London and NY sessions are killzones
        return sessionState.type === 'LONDON' || sessionState.type === 'NY';
    }
    /**
     * Store Asian range as reference levels for London manipulation
     * Requirements: 2.2 (Asian range storage)
     */
    storeAsianRange(ohlcvData) {
        if (ohlcvData.length === 0) {
            return;
        }
        // Find high and low during Asian session (00:00-06:00 UTC)
        let high = -Infinity;
        let low = Infinity;
        let timestamp = 0;
        for (const candle of ohlcvData) {
            const candleDate = new Date(candle.timestamp);
            const utcHour = candleDate.getUTCHours();
            // Check if candle is within Asian session
            if (utcHour >= 0 && utcHour < 6) {
                if (candle.high > high) {
                    high = candle.high;
                }
                if (candle.low < low) {
                    low = candle.low;
                }
                timestamp = Math.max(timestamp, candle.timestamp);
            }
        }
        if (high !== -Infinity && low !== Infinity) {
            this.asianRange = {
                high,
                low,
                timestamp
            };
        }
    }
    /**
     * Detect Judas Swing at session opens
     * Requirements: 2.3, 2.4, 2.5 (Judas Swing detection)
     */
    detectJudasSwing(currentPrice, sessionType) {
        // London session: Hunt for Asian range sweep
        if (sessionType === 'LONDON' && this.asianRange) {
            // Check for sweep of Asian High
            if (currentPrice > this.asianRange.high) {
                return {
                    type: 'SWEEP_HIGH',
                    sweptPrice: this.asianRange.high,
                    reversalPrice: this.asianRange.low,
                    direction: 'SHORT', // Expect reversal down after sweep
                    confidence: 75
                };
            }
            // Check for sweep of Asian Low
            if (currentPrice < this.asianRange.low) {
                return {
                    type: 'SWEEP_LOW',
                    sweptPrice: this.asianRange.low,
                    reversalPrice: this.asianRange.high,
                    direction: 'LONG', // Expect reversal up after sweep
                    confidence: 75
                };
            }
        }
        // NY session: Hunt for London range sweep
        if (sessionType === 'NY' && this.londonRange) {
            // Check for sweep of London High
            if (currentPrice > this.londonRange.high) {
                return {
                    type: 'SWEEP_HIGH',
                    sweptPrice: this.londonRange.high,
                    reversalPrice: this.londonRange.low,
                    direction: 'SHORT',
                    confidence: 80 // Higher confidence for NY session
                };
            }
            // Check for sweep of London Low
            if (currentPrice < this.londonRange.low) {
                return {
                    type: 'SWEEP_LOW',
                    sweptPrice: this.londonRange.low,
                    reversalPrice: this.londonRange.high,
                    direction: 'LONG',
                    confidence: 80
                };
            }
        }
        return null;
    }
    /**
     * Get stored Asian range
     */
    getAsianRange() {
        return this.asianRange;
    }
    /**
     * Get stored London range
     */
    getLondonRange() {
        return this.londonRange;
    }
    /**
     * Update London range during London session
     */
    updateLondonRange(ohlcvData) {
        if (ohlcvData.length === 0) {
            return;
        }
        // Find high and low during London session (07:00-10:00 UTC)
        let high = -Infinity;
        let low = Infinity;
        let timestamp = 0;
        for (const candle of ohlcvData) {
            const candleDate = new Date(candle.timestamp);
            const utcHour = candleDate.getUTCHours();
            // Check if candle is within London session
            if (utcHour >= 7 && utcHour < 10) {
                if (candle.high > high) {
                    high = candle.high;
                }
                if (candle.low < low) {
                    low = candle.low;
                }
                timestamp = Math.max(timestamp, candle.timestamp);
            }
        }
        if (high !== -Infinity && low !== Infinity) {
            this.londonRange = {
                high,
                low,
                timestamp
            };
        }
    }
    /**
     * Check if we should disable new entries (Dead Zone)
     * Requirements: 2.6 (Dead zone restrictions)
     */
    shouldDisableNewEntries() {
        const sessionState = this.getSessionState();
        return sessionState.type === 'DEAD_ZONE';
    }
    /**
     * Get session statistics for display
     */
    getSessionStats() {
        const sessionState = this.getSessionState();
        return {
            currentSession: sessionState.type,
            timeRemaining: sessionState.timeRemaining,
            asianRange: this.asianRange,
            londonRange: this.londonRange,
            isKillzone: this.isKillzone()
        };
    }
    /**
     * Handle session transition and emit events
     * Requirements: 2.7 (Session transition events)
     */
    handleSessionTransition(newSession) {
        const previousSession = this.currentSession?.type;
        // Emit session change event with reference levels
        this.emit('SESSION_CHANGE', {
            previousSession,
            newSession: newSession.type,
            asianRange: this.asianRange,
            londonRange: this.londonRange,
            timestamp: Date.now()
        });
        // Special handling for session-specific logic
        if (newSession.type === 'LONDON' && previousSession === 'ASIAN') {
            // London opening - prepare for Asian range manipulation
            this.emit('LONDON_OPEN', {
                asianRange: this.asianRange,
                timestamp: Date.now()
            });
        }
        if (newSession.type === 'NY' && previousSession === 'LONDON') {
            // NY opening - prepare for London range manipulation
            this.emit('NY_OPEN', {
                londonRange: this.londonRange,
                timestamp: Date.now()
            });
        }
        if (newSession.type === 'DEAD_ZONE') {
            // Dead zone - disable new entries
            this.emit('DEAD_ZONE_START', {
                timestamp: Date.now()
            });
        }
    }
}
exports.SessionProfiler = SessionProfiler;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLXBoYXNlMi1odW50ZXIvc3JjL2VuZ2luZS9TZXNzaW9uUHJvZmlsZXIudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7OztHQVFHOzs7QUFFSCxtQ0FBc0M7QUFTdEMsTUFBYSxlQUFnQixTQUFRLHFCQUFZO0lBQ3ZDLFVBQVUsR0FBc0IsSUFBSSxDQUFDO0lBQ3JDLFdBQVcsR0FBNEQsSUFBSSxDQUFDO0lBQzVFLGNBQWMsR0FBd0IsSUFBSSxDQUFDO0lBRW5EO1FBQ0UsS0FBSyxFQUFFLENBQUM7SUFDVixDQUFDO0lBRUQ7OztPQUdHO0lBQ0gsZUFBZTtRQUNiLE1BQU0sR0FBRyxHQUFHLElBQUksSUFBSSxFQUFFLENBQUM7UUFDdkIsTUFBTSxPQUFPLEdBQUcsR0FBRyxDQUFDLFdBQVcsRUFBRSxDQUFDO1FBQ2xDLE1BQU0sU0FBUyxHQUFHLEdBQUcsQ0FBQyxhQUFhLEVBQUUsQ0FBQztRQUN0QyxNQUFNLFdBQVcsR0FBRyxPQUFPLEdBQUcsU0FBUyxHQUFHLEVBQUUsQ0FBQztRQUU3QyxJQUFJLFdBQXdCLENBQUM7UUFDN0IsSUFBSSxTQUFpQixDQUFDO1FBQ3RCLElBQUksT0FBZSxDQUFDO1FBRXBCLHdEQUF3RDtRQUN4RCxJQUFJLFdBQVcsSUFBSSxDQUFDLElBQUksV0FBVyxHQUFHLENBQUMsRUFBRSxDQUFDO1lBQ3hDLFdBQVcsR0FBRyxPQUFPLENBQUM7WUFDdEIsU0FBUyxHQUFHLENBQUMsQ0FBQztZQUNkLE9BQU8sR0FBRyxDQUFDLENBQUM7UUFDZCxDQUFDO1FBQ0QseURBQXlEO2FBQ3BELElBQUksV0FBVyxJQUFJLENBQUMsSUFBSSxXQUFXLEdBQUcsRUFBRSxFQUFFLENBQUM7WUFDOUMsV0FBVyxHQUFHLFFBQVEsQ0FBQztZQUN2QixTQUFTLEdBQUcsQ0FBQyxDQUFDO1lBQ2QsT0FBTyxHQUFHLEVBQUUsQ0FBQztRQUNmLENBQUM7UUFDRCxxREFBcUQ7YUFDaEQsSUFBSSxXQUFXLElBQUksRUFBRSxJQUFJLFdBQVcsR0FBRyxFQUFFLEVBQUUsQ0FBQztZQUMvQyxXQUFXLEdBQUcsSUFBSSxDQUFDO1lBQ25CLFNBQVMsR0FBRyxFQUFFLENBQUM7WUFDZixPQUFPLEdBQUcsRUFBRSxDQUFDO1FBQ2YsQ0FBQztRQUNELDRDQUE0QzthQUN2QyxDQUFDO1lBQ0osV0FBVyxHQUFHLFdBQVcsQ0FBQztZQUMxQixTQUFTLEdBQUcsRUFBRSxDQUFDO1lBQ2YsT0FBTyxHQUFHLENBQUMsQ0FBQyxDQUFDLFdBQVc7UUFDMUIsQ0FBQztRQUVELDhDQUE4QztRQUM5QyxJQUFJLGFBQXFCLENBQUM7UUFDMUIsSUFBSSxXQUFXLEtBQUssV0FBVyxFQUFFLENBQUM7WUFDaEMsMkJBQTJCO1lBQzNCLElBQUksV0FBVyxJQUFJLEVBQUUsRUFBRSxDQUFDO2dCQUN0QixhQUFhLEdBQUcsQ0FBQyxFQUFFLEdBQUcsV0FBVyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsdUJBQXVCO1lBQ2pFLENBQUM7aUJBQU0sQ0FBQztnQkFDTixhQUFhLEdBQUcsQ0FBQyxHQUFHLFdBQVcsQ0FBQyxDQUFDLGNBQWM7WUFDakQsQ0FBQztRQUNILENBQUM7YUFBTSxDQUFDO1lBQ04sYUFBYSxHQUFHLE9BQU8sR0FBRyxXQUFXLENBQUM7UUFDeEMsQ0FBQztRQUVELE1BQU0sWUFBWSxHQUFpQjtZQUNqQyxJQUFJLEVBQUUsV0FBVztZQUNqQixTQUFTO1lBQ1QsT0FBTztZQUNQLGFBQWEsRUFBRSxJQUFJLENBQUMsR0FBRyxDQUFDLENBQUMsRUFBRSxhQUFhLENBQUM7U0FDMUMsQ0FBQztRQUVGLCtCQUErQjtRQUMvQixJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsSUFBSSxJQUFJLENBQUMsY0FBYyxDQUFDLElBQUksS0FBSyxXQUFXLEVBQUUsQ0FBQztZQUNyRSxJQUFJLENBQUMsdUJBQXVCLENBQUMsWUFBWSxDQUFDLENBQUM7UUFDN0MsQ0FBQztRQUVELElBQUksQ0FBQyxjQUFjLEdBQUcsWUFBWSxDQUFDO1FBQ25DLE9BQU8sWUFBWSxDQUFDO0lBQ3RCLENBQUM7SUFFRDs7O09BR0c7SUFDSCxVQUFVO1FBQ1IsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBRTVDLDRDQUE0QztRQUM1QyxPQUFPLFlBQVksQ0FBQyxJQUFJLEtBQUssUUFBUSxJQUFJLFlBQVksQ0FBQyxJQUFJLEtBQUssSUFBSSxDQUFDO0lBQ3RFLENBQUM7SUFFRDs7O09BR0c7SUFDSCxlQUFlLENBQUMsU0FBa0I7UUFDaEMsSUFBSSxTQUFTLENBQUMsTUFBTSxLQUFLLENBQUMsRUFBRSxDQUFDO1lBQzNCLE9BQU87UUFDVCxDQUFDO1FBRUQsMkRBQTJEO1FBQzNELElBQUksSUFBSSxHQUFHLENBQUMsUUFBUSxDQUFDO1FBQ3JCLElBQUksR0FBRyxHQUFHLFFBQVEsQ0FBQztRQUNuQixJQUFJLFNBQVMsR0FBRyxDQUFDLENBQUM7UUFFbEIsS0FBSyxNQUFNLE1BQU0sSUFBSSxTQUFTLEVBQUUsQ0FBQztZQUMvQixNQUFNLFVBQVUsR0FBRyxJQUFJLElBQUksQ0FBQyxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDOUMsTUFBTSxPQUFPLEdBQUcsVUFBVSxDQUFDLFdBQVcsRUFBRSxDQUFDO1lBRXpDLDBDQUEwQztZQUMxQyxJQUFJLE9BQU8sSUFBSSxDQUFDLElBQUksT0FBTyxHQUFHLENBQUMsRUFBRSxDQUFDO2dCQUNoQyxJQUFJLE1BQU0sQ0FBQyxJQUFJLEdBQUcsSUFBSSxFQUFFLENBQUM7b0JBQ3ZCLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDO2dCQUNyQixDQUFDO2dCQUNELElBQUksTUFBTSxDQUFDLEdBQUcsR0FBRyxHQUFHLEVBQUUsQ0FBQztvQkFDckIsR0FBRyxHQUFHLE1BQU0sQ0FBQyxHQUFHLENBQUM7Z0JBQ25CLENBQUM7Z0JBQ0QsU0FBUyxHQUFHLElBQUksQ0FBQyxHQUFHLENBQUMsU0FBUyxFQUFFLE1BQU0sQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUNwRCxDQUFDO1FBQ0gsQ0FBQztRQUVELElBQUksSUFBSSxLQUFLLENBQUMsUUFBUSxJQUFJLEdBQUcsS0FBSyxRQUFRLEVBQUUsQ0FBQztZQUMzQyxJQUFJLENBQUMsVUFBVSxHQUFHO2dCQUNoQixJQUFJO2dCQUNKLEdBQUc7Z0JBQ0gsU0FBUzthQUNWLENBQUM7UUFDSixDQUFDO0lBQ0gsQ0FBQztJQUVEOzs7T0FHRztJQUNILGdCQUFnQixDQUFDLFlBQW9CLEVBQUUsV0FBd0I7UUFDN0QsNkNBQTZDO1FBQzdDLElBQUksV0FBVyxLQUFLLFFBQVEsSUFBSSxJQUFJLENBQUMsVUFBVSxFQUFFLENBQUM7WUFDaEQsZ0NBQWdDO1lBQ2hDLElBQUksWUFBWSxHQUFHLElBQUksQ0FBQyxVQUFVLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ3hDLE9BQU87b0JBQ0wsSUFBSSxFQUFFLFlBQVk7b0JBQ2xCLFVBQVUsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLElBQUk7b0JBQ2hDLGFBQWEsRUFBRSxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUc7b0JBQ2xDLFNBQVMsRUFBRSxPQUFPLEVBQUUsbUNBQW1DO29CQUN2RCxVQUFVLEVBQUUsRUFBRTtpQkFDZixDQUFDO1lBQ0osQ0FBQztZQUVELCtCQUErQjtZQUMvQixJQUFJLFlBQVksR0FBRyxJQUFJLENBQUMsVUFBVSxDQUFDLEdBQUcsRUFBRSxDQUFDO2dCQUN2QyxPQUFPO29CQUNMLElBQUksRUFBRSxXQUFXO29CQUNqQixVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxHQUFHO29CQUMvQixhQUFhLEVBQUUsSUFBSSxDQUFDLFVBQVUsQ0FBQyxJQUFJO29CQUNuQyxTQUFTLEVBQUUsTUFBTSxFQUFFLGlDQUFpQztvQkFDcEQsVUFBVSxFQUFFLEVBQUU7aUJBQ2YsQ0FBQztZQUNKLENBQUM7UUFDSCxDQUFDO1FBRUQsMENBQTBDO1FBQzFDLElBQUksV0FBVyxLQUFLLElBQUksSUFBSSxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDN0MsaUNBQWlDO1lBQ2pDLElBQUksWUFBWSxHQUFHLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSSxFQUFFLENBQUM7Z0JBQ3pDLE9BQU87b0JBQ0wsSUFBSSxFQUFFLFlBQVk7b0JBQ2xCLFVBQVUsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLElBQUk7b0JBQ2pDLGFBQWEsRUFBRSxJQUFJLENBQUMsV0FBVyxDQUFDLEdBQUc7b0JBQ25DLFNBQVMsRUFBRSxPQUFPO29CQUNsQixVQUFVLEVBQUUsRUFBRSxDQUFDLG1DQUFtQztpQkFDbkQsQ0FBQztZQUNKLENBQUM7WUFFRCxnQ0FBZ0M7WUFDaEMsSUFBSSxZQUFZLEdBQUcsSUFBSSxDQUFDLFdBQVcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztnQkFDeEMsT0FBTztvQkFDTCxJQUFJLEVBQUUsV0FBVztvQkFDakIsVUFBVSxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsR0FBRztvQkFDaEMsYUFBYSxFQUFFLElBQUksQ0FBQyxXQUFXLENBQUMsSUFBSTtvQkFDcEMsU0FBUyxFQUFFLE1BQU07b0JBQ2pCLFVBQVUsRUFBRSxFQUFFO2lCQUNmLENBQUM7WUFDSixDQUFDO1FBQ0gsQ0FBQztRQUVELE9BQU8sSUFBSSxDQUFDO0lBQ2QsQ0FBQztJQUVEOztPQUVHO0lBQ0gsYUFBYTtRQUNYLE9BQU8sSUFBSSxDQUFDLFVBQVUsQ0FBQztJQUN6QixDQUFDO0lBRUQ7O09BRUc7SUFDSCxjQUFjO1FBQ1osT0FBTyxJQUFJLENBQUMsV0FBVyxDQUFDO0lBQzFCLENBQUM7SUFFRDs7T0FFRztJQUNILGlCQUFpQixDQUFDLFNBQWtCO1FBQ2xDLElBQUksU0FBUyxDQUFDLE1BQU0sS0FBSyxDQUFDLEVBQUUsQ0FBQztZQUMzQixPQUFPO1FBQ1QsQ0FBQztRQUVELDREQUE0RDtRQUM1RCxJQUFJLElBQUksR0FBRyxDQUFDLFFBQVEsQ0FBQztRQUNyQixJQUFJLEdBQUcsR0FBRyxRQUFRLENBQUM7UUFDbkIsSUFBSSxTQUFTLEdBQUcsQ0FBQyxDQUFDO1FBRWxCLEtBQUssTUFBTSxNQUFNLElBQUksU0FBUyxFQUFFLENBQUM7WUFDL0IsTUFBTSxVQUFVLEdBQUcsSUFBSSxJQUFJLENBQUMsTUFBTSxDQUFDLFNBQVMsQ0FBQyxDQUFDO1lBQzlDLE1BQU0sT0FBTyxHQUFHLFVBQVUsQ0FBQyxXQUFXLEVBQUUsQ0FBQztZQUV6QywyQ0FBMkM7WUFDM0MsSUFBSSxPQUFPLElBQUksQ0FBQyxJQUFJLE9BQU8sR0FBRyxFQUFFLEVBQUUsQ0FBQztnQkFDakMsSUFBSSxNQUFNLENBQUMsSUFBSSxHQUFHLElBQUksRUFBRSxDQUFDO29CQUN2QixJQUFJLEdBQUcsTUFBTSxDQUFDLElBQUksQ0FBQztnQkFDckIsQ0FBQztnQkFDRCxJQUFJLE1BQU0sQ0FBQyxHQUFHLEdBQUcsR0FBRyxFQUFFLENBQUM7b0JBQ3JCLEdBQUcsR0FBRyxNQUFNLENBQUMsR0FBRyxDQUFDO2dCQUNuQixDQUFDO2dCQUNELFNBQVMsR0FBRyxJQUFJLENBQUMsR0FBRyxDQUFDLFNBQVMsRUFBRSxNQUFNLENBQUMsU0FBUyxDQUFDLENBQUM7WUFDcEQsQ0FBQztRQUNILENBQUM7UUFFRCxJQUFJLElBQUksS0FBSyxDQUFDLFFBQVEsSUFBSSxHQUFHLEtBQUssUUFBUSxFQUFFLENBQUM7WUFDM0MsSUFBSSxDQUFDLFdBQVcsR0FBRztnQkFDakIsSUFBSTtnQkFDSixHQUFHO2dCQUNILFNBQVM7YUFDVixDQUFDO1FBQ0osQ0FBQztJQUNILENBQUM7SUFFRDs7O09BR0c7SUFDSCx1QkFBdUI7UUFDckIsTUFBTSxZQUFZLEdBQUcsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQzVDLE9BQU8sWUFBWSxDQUFDLElBQUksS0FBSyxXQUFXLENBQUM7SUFDM0MsQ0FBQztJQUVEOztPQUVHO0lBQ0gsZUFBZTtRQU9iLE1BQU0sWUFBWSxHQUFHLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUU1QyxPQUFPO1lBQ0wsY0FBYyxFQUFFLFlBQVksQ0FBQyxJQUFJO1lBQ2pDLGFBQWEsRUFBRSxZQUFZLENBQUMsYUFBYTtZQUN6QyxVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVU7WUFDM0IsV0FBVyxFQUFFLElBQUksQ0FBQyxXQUFXO1lBQzdCLFVBQVUsRUFBRSxJQUFJLENBQUMsVUFBVSxFQUFFO1NBQzlCLENBQUM7SUFDSixDQUFDO0lBRUQ7OztPQUdHO0lBQ0ssdUJBQXVCLENBQUMsVUFBd0I7UUFDdEQsTUFBTSxlQUFlLEdBQUcsSUFBSSxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUM7UUFFbEQsa0RBQWtEO1FBQ2xELElBQUksQ0FBQyxJQUFJLENBQUMsZ0JBQWdCLEVBQUU7WUFDMUIsZUFBZTtZQUNmLFVBQVUsRUFBRSxVQUFVLENBQUMsSUFBSTtZQUMzQixVQUFVLEVBQUUsSUFBSSxDQUFDLFVBQVU7WUFDM0IsV0FBVyxFQUFFLElBQUksQ0FBQyxXQUFXO1lBQzdCLFNBQVMsRUFBRSxJQUFJLENBQUMsR0FBRyxFQUFFO1NBQ3RCLENBQUMsQ0FBQztRQUVILDhDQUE4QztRQUM5QyxJQUFJLFVBQVUsQ0FBQyxJQUFJLEtBQUssUUFBUSxJQUFJLGVBQWUsS0FBSyxPQUFPLEVBQUUsQ0FBQztZQUNoRSx3REFBd0Q7WUFDeEQsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLEVBQUU7Z0JBQ3ZCLFVBQVUsRUFBRSxJQUFJLENBQUMsVUFBVTtnQkFDM0IsU0FBUyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUU7YUFDdEIsQ0FBQyxDQUFDO1FBQ0wsQ0FBQztRQUVELElBQUksVUFBVSxDQUFDLElBQUksS0FBSyxJQUFJLElBQUksZUFBZSxLQUFLLFFBQVEsRUFBRSxDQUFDO1lBQzdELHFEQUFxRDtZQUNyRCxJQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRTtnQkFDbkIsV0FBVyxFQUFFLElBQUksQ0FBQyxXQUFXO2dCQUM3QixTQUFTLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRTthQUN0QixDQUFDLENBQUM7UUFDTCxDQUFDO1FBRUQsSUFBSSxVQUFVLENBQUMsSUFBSSxLQUFLLFdBQVcsRUFBRSxDQUFDO1lBQ3BDLGtDQUFrQztZQUNsQyxJQUFJLENBQUMsSUFBSSxDQUFDLGlCQUFpQixFQUFFO2dCQUMzQixTQUFTLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRTthQUN0QixDQUFDLENBQUM7UUFDTCxDQUFDO0lBQ0gsQ0FBQztDQUNGO0FBblRELDBDQW1UQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvaXZhbi9Db2RlL3RyYWRpbmcvdGl0YW4vc2VydmljZXMvdGl0YW4tcGhhc2UyLWh1bnRlci9zcmMvZW5naW5lL1Nlc3Npb25Qcm9maWxlci50cyJdLCJzb3VyY2VzQ29udGVudCI6WyIvKipcbiAqIFNlc3Npb25Qcm9maWxlciAtIFRpbWUgJiBQcmljZSBEeW5hbWljcyBFbmdpbmVcbiAqIFxuICogRXhwbG9pdHMgdGhlIFwiSnVkYXMgU3dpbmdcIiAoZmFsc2UgbW92ZXMpIGF0IExvbmRvbi9OWSBvcGVucyB0byBjYXRjaCBcbiAqIG1hbmlwdWxhdGlvbi10by1kaXN0cmlidXRpb24gdHJhbnNpdGlvbnMuIElkZW50aWZpZXMgc2Vzc2lvbi1iYXNlZCBcbiAqIHRyYWRpbmcgb3Bwb3J0dW5pdGllcyBhbmQgbWFuYWdlcyB0aW1lLWJhc2VkIGxvZ2ljLlxuICogXG4gKiBSZXF1aXJlbWVudHM6IDIuMS0yLjcgKFNlc3Npb24gUHJvZmlsZXIpXG4gKi9cblxuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSAnZXZlbnRzJztcbmltcG9ydCB7IFxuICBTZXNzaW9uVHlwZSwgXG4gIFNlc3Npb25TdGF0ZSwgXG4gIEFzaWFuUmFuZ2UsIFxuICBKdWRhc1N3aW5nLFxuICBPSExDViBcbn0gZnJvbSAnLi4vdHlwZXMnO1xuXG5leHBvcnQgY2xhc3MgU2Vzc2lvblByb2ZpbGVyIGV4dGVuZHMgRXZlbnRFbWl0dGVyIHtcbiAgcHJpdmF0ZSBhc2lhblJhbmdlOiBBc2lhblJhbmdlIHwgbnVsbCA9IG51bGw7XG4gIHByaXZhdGUgbG9uZG9uUmFuZ2U6IHsgaGlnaDogbnVtYmVyOyBsb3c6IG51bWJlcjsgdGltZXN0YW1wOiBudW1iZXIgfSB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIGN1cnJlbnRTZXNzaW9uOiBTZXNzaW9uU3RhdGUgfCBudWxsID0gbnVsbDtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICBzdXBlcigpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBjdXJyZW50IHNlc3Npb24gc3RhdGUgYmFzZWQgb24gVVRDIHRpbWVcbiAgICogUmVxdWlyZW1lbnRzOiAyLjEgKFNlc3Npb24gaWRlbnRpZmljYXRpb24pXG4gICAqL1xuICBnZXRTZXNzaW9uU3RhdGUoKTogU2Vzc2lvblN0YXRlIHtcbiAgICBjb25zdCBub3cgPSBuZXcgRGF0ZSgpO1xuICAgIGNvbnN0IHV0Y0hvdXIgPSBub3cuZ2V0VVRDSG91cnMoKTtcbiAgICBjb25zdCB1dGNNaW51dGUgPSBub3cuZ2V0VVRDTWludXRlcygpO1xuICAgIGNvbnN0IGN1cnJlbnRUaW1lID0gdXRjSG91ciArIHV0Y01pbnV0ZSAvIDYwO1xuXG4gICAgbGV0IHNlc3Npb25UeXBlOiBTZXNzaW9uVHlwZTtcbiAgICBsZXQgc3RhcnRUaW1lOiBudW1iZXI7XG4gICAgbGV0IGVuZFRpbWU6IG51bWJlcjtcblxuICAgIC8vIEFzaWFuIHNlc3Npb246IDAwOjAwIC0gMDY6MDAgVVRDIChBY2N1bXVsYXRpb24gcGhhc2UpXG4gICAgaWYgKGN1cnJlbnRUaW1lID49IDAgJiYgY3VycmVudFRpbWUgPCA2KSB7XG4gICAgICBzZXNzaW9uVHlwZSA9ICdBU0lBTic7XG4gICAgICBzdGFydFRpbWUgPSAwO1xuICAgICAgZW5kVGltZSA9IDY7XG4gICAgfVxuICAgIC8vIExvbmRvbiBzZXNzaW9uOiAwNzowMCAtIDEwOjAwIFVUQyAoTWFuaXB1bGF0aW9uIHBoYXNlKVxuICAgIGVsc2UgaWYgKGN1cnJlbnRUaW1lID49IDcgJiYgY3VycmVudFRpbWUgPCAxMCkge1xuICAgICAgc2Vzc2lvblR5cGUgPSAnTE9ORE9OJztcbiAgICAgIHN0YXJ0VGltZSA9IDc7XG4gICAgICBlbmRUaW1lID0gMTA7XG4gICAgfVxuICAgIC8vIE5ZIHNlc3Npb246IDEzOjAwIC0gMTY6MDAgVVRDIChEaXN0cmlidXRpb24gcGhhc2UpXG4gICAgZWxzZSBpZiAoY3VycmVudFRpbWUgPj0gMTMgJiYgY3VycmVudFRpbWUgPCAxNikge1xuICAgICAgc2Vzc2lvblR5cGUgPSAnTlknO1xuICAgICAgc3RhcnRUaW1lID0gMTM7XG4gICAgICBlbmRUaW1lID0gMTY7XG4gICAgfVxuICAgIC8vIERlYWQgWm9uZTogMjE6MDAgLSAwMTowMCBVVEMgKExvdyB2b2x1bWUpXG4gICAgZWxzZSB7XG4gICAgICBzZXNzaW9uVHlwZSA9ICdERUFEX1pPTkUnO1xuICAgICAgc3RhcnRUaW1lID0gMjE7XG4gICAgICBlbmRUaW1lID0gMTsgLy8gTmV4dCBkYXlcbiAgICB9XG5cbiAgICAvLyBDYWxjdWxhdGUgdGltZSByZW1haW5pbmcgaW4gY3VycmVudCBzZXNzaW9uXG4gICAgbGV0IHRpbWVSZW1haW5pbmc6IG51bWJlcjtcbiAgICBpZiAoc2Vzc2lvblR5cGUgPT09ICdERUFEX1pPTkUnKSB7XG4gICAgICAvLyBIYW5kbGUgb3Zlcm5pZ2h0IHNlc3Npb25cbiAgICAgIGlmIChjdXJyZW50VGltZSA+PSAyMSkge1xuICAgICAgICB0aW1lUmVtYWluaW5nID0gKDI0IC0gY3VycmVudFRpbWUpICsgMTsgLy8gVW50aWwgMDE6MDAgbmV4dCBkYXlcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIHRpbWVSZW1haW5pbmcgPSAxIC0gY3VycmVudFRpbWU7IC8vIFVudGlsIDAxOjAwXG4gICAgICB9XG4gICAgfSBlbHNlIHtcbiAgICAgIHRpbWVSZW1haW5pbmcgPSBlbmRUaW1lIC0gY3VycmVudFRpbWU7XG4gICAgfVxuXG4gICAgY29uc3Qgc2Vzc2lvblN0YXRlOiBTZXNzaW9uU3RhdGUgPSB7XG4gICAgICB0eXBlOiBzZXNzaW9uVHlwZSxcbiAgICAgIHN0YXJ0VGltZSxcbiAgICAgIGVuZFRpbWUsXG4gICAgICB0aW1lUmVtYWluaW5nOiBNYXRoLm1heCgwLCB0aW1lUmVtYWluaW5nKVxuICAgIH07XG5cbiAgICAvLyBDaGVjayBmb3Igc2Vzc2lvbiB0cmFuc2l0aW9uXG4gICAgaWYgKCF0aGlzLmN1cnJlbnRTZXNzaW9uIHx8IHRoaXMuY3VycmVudFNlc3Npb24udHlwZSAhPT0gc2Vzc2lvblR5cGUpIHtcbiAgICAgIHRoaXMuaGFuZGxlU2Vzc2lvblRyYW5zaXRpb24oc2Vzc2lvblN0YXRlKTtcbiAgICB9XG5cbiAgICB0aGlzLmN1cnJlbnRTZXNzaW9uID0gc2Vzc2lvblN0YXRlO1xuICAgIHJldHVybiBzZXNzaW9uU3RhdGU7XG4gIH1cblxuICAvKipcbiAgICogQ2hlY2sgaWYgY3VycmVudCB0aW1lIGlzIHdpdGhpbiB0cmFkZWFibGUga2lsbHpvbmVcbiAgICogUmVxdWlyZW1lbnRzOiAyLjYgKEtpbGx6b25lIGNoZWNraW5nKVxuICAgKi9cbiAgaXNLaWxsem9uZSgpOiBib29sZWFuIHtcbiAgICBjb25zdCBzZXNzaW9uU3RhdGUgPSB0aGlzLmdldFNlc3Npb25TdGF0ZSgpO1xuICAgIFxuICAgIC8vIE9ubHkgTG9uZG9uIGFuZCBOWSBzZXNzaW9ucyBhcmUga2lsbHpvbmVzXG4gICAgcmV0dXJuIHNlc3Npb25TdGF0ZS50eXBlID09PSAnTE9ORE9OJyB8fCBzZXNzaW9uU3RhdGUudHlwZSA9PT0gJ05ZJztcbiAgfVxuXG4gIC8qKlxuICAgKiBTdG9yZSBBc2lhbiByYW5nZSBhcyByZWZlcmVuY2UgbGV2ZWxzIGZvciBMb25kb24gbWFuaXB1bGF0aW9uXG4gICAqIFJlcXVpcmVtZW50czogMi4yIChBc2lhbiByYW5nZSBzdG9yYWdlKVxuICAgKi9cbiAgc3RvcmVBc2lhblJhbmdlKG9obGN2RGF0YTogT0hMQ1ZbXSk6IHZvaWQge1xuICAgIGlmIChvaGxjdkRhdGEubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gRmluZCBoaWdoIGFuZCBsb3cgZHVyaW5nIEFzaWFuIHNlc3Npb24gKDAwOjAwLTA2OjAwIFVUQylcbiAgICBsZXQgaGlnaCA9IC1JbmZpbml0eTtcbiAgICBsZXQgbG93ID0gSW5maW5pdHk7XG4gICAgbGV0IHRpbWVzdGFtcCA9IDA7XG5cbiAgICBmb3IgKGNvbnN0IGNhbmRsZSBvZiBvaGxjdkRhdGEpIHtcbiAgICAgIGNvbnN0IGNhbmRsZURhdGUgPSBuZXcgRGF0ZShjYW5kbGUudGltZXN0YW1wKTtcbiAgICAgIGNvbnN0IHV0Y0hvdXIgPSBjYW5kbGVEYXRlLmdldFVUQ0hvdXJzKCk7XG4gICAgICBcbiAgICAgIC8vIENoZWNrIGlmIGNhbmRsZSBpcyB3aXRoaW4gQXNpYW4gc2Vzc2lvblxuICAgICAgaWYgKHV0Y0hvdXIgPj0gMCAmJiB1dGNIb3VyIDwgNikge1xuICAgICAgICBpZiAoY2FuZGxlLmhpZ2ggPiBoaWdoKSB7XG4gICAgICAgICAgaGlnaCA9IGNhbmRsZS5oaWdoO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjYW5kbGUubG93IDwgbG93KSB7XG4gICAgICAgICAgbG93ID0gY2FuZGxlLmxvdztcbiAgICAgICAgfVxuICAgICAgICB0aW1lc3RhbXAgPSBNYXRoLm1heCh0aW1lc3RhbXAsIGNhbmRsZS50aW1lc3RhbXApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChoaWdoICE9PSAtSW5maW5pdHkgJiYgbG93ICE9PSBJbmZpbml0eSkge1xuICAgICAgdGhpcy5hc2lhblJhbmdlID0ge1xuICAgICAgICBoaWdoLFxuICAgICAgICBsb3csXG4gICAgICAgIHRpbWVzdGFtcFxuICAgICAgfTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogRGV0ZWN0IEp1ZGFzIFN3aW5nIGF0IHNlc3Npb24gb3BlbnNcbiAgICogUmVxdWlyZW1lbnRzOiAyLjMsIDIuNCwgMi41IChKdWRhcyBTd2luZyBkZXRlY3Rpb24pXG4gICAqL1xuICBkZXRlY3RKdWRhc1N3aW5nKGN1cnJlbnRQcmljZTogbnVtYmVyLCBzZXNzaW9uVHlwZTogU2Vzc2lvblR5cGUpOiBKdWRhc1N3aW5nIHwgbnVsbCB7XG4gICAgLy8gTG9uZG9uIHNlc3Npb246IEh1bnQgZm9yIEFzaWFuIHJhbmdlIHN3ZWVwXG4gICAgaWYgKHNlc3Npb25UeXBlID09PSAnTE9ORE9OJyAmJiB0aGlzLmFzaWFuUmFuZ2UpIHtcbiAgICAgIC8vIENoZWNrIGZvciBzd2VlcCBvZiBBc2lhbiBIaWdoXG4gICAgICBpZiAoY3VycmVudFByaWNlID4gdGhpcy5hc2lhblJhbmdlLmhpZ2gpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB0eXBlOiAnU1dFRVBfSElHSCcsXG4gICAgICAgICAgc3dlcHRQcmljZTogdGhpcy5hc2lhblJhbmdlLmhpZ2gsXG4gICAgICAgICAgcmV2ZXJzYWxQcmljZTogdGhpcy5hc2lhblJhbmdlLmxvdyxcbiAgICAgICAgICBkaXJlY3Rpb246ICdTSE9SVCcsIC8vIEV4cGVjdCByZXZlcnNhbCBkb3duIGFmdGVyIHN3ZWVwXG4gICAgICAgICAgY29uZmlkZW5jZTogNzVcbiAgICAgICAgfTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgLy8gQ2hlY2sgZm9yIHN3ZWVwIG9mIEFzaWFuIExvd1xuICAgICAgaWYgKGN1cnJlbnRQcmljZSA8IHRoaXMuYXNpYW5SYW5nZS5sb3cpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB0eXBlOiAnU1dFRVBfTE9XJyxcbiAgICAgICAgICBzd2VwdFByaWNlOiB0aGlzLmFzaWFuUmFuZ2UubG93LFxuICAgICAgICAgIHJldmVyc2FsUHJpY2U6IHRoaXMuYXNpYW5SYW5nZS5oaWdoLFxuICAgICAgICAgIGRpcmVjdGlvbjogJ0xPTkcnLCAvLyBFeHBlY3QgcmV2ZXJzYWwgdXAgYWZ0ZXIgc3dlZXBcbiAgICAgICAgICBjb25maWRlbmNlOiA3NVxuICAgICAgICB9O1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIE5ZIHNlc3Npb246IEh1bnQgZm9yIExvbmRvbiByYW5nZSBzd2VlcFxuICAgIGlmIChzZXNzaW9uVHlwZSA9PT0gJ05ZJyAmJiB0aGlzLmxvbmRvblJhbmdlKSB7XG4gICAgICAvLyBDaGVjayBmb3Igc3dlZXAgb2YgTG9uZG9uIEhpZ2hcbiAgICAgIGlmIChjdXJyZW50UHJpY2UgPiB0aGlzLmxvbmRvblJhbmdlLmhpZ2gpIHtcbiAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICB0eXBlOiAnU1dFRVBfSElHSCcsXG4gICAgICAgICAgc3dlcHRQcmljZTogdGhpcy5sb25kb25SYW5nZS5oaWdoLFxuICAgICAgICAgIHJldmVyc2FsUHJpY2U6IHRoaXMubG9uZG9uUmFuZ2UubG93LFxuICAgICAgICAgIGRpcmVjdGlvbjogJ1NIT1JUJyxcbiAgICAgICAgICBjb25maWRlbmNlOiA4MCAvLyBIaWdoZXIgY29uZmlkZW5jZSBmb3IgTlkgc2Vzc2lvblxuICAgICAgICB9O1xuICAgICAgfVxuICAgICAgXG4gICAgICAvLyBDaGVjayBmb3Igc3dlZXAgb2YgTG9uZG9uIExvd1xuICAgICAgaWYgKGN1cnJlbnRQcmljZSA8IHRoaXMubG9uZG9uUmFuZ2UubG93KSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgdHlwZTogJ1NXRUVQX0xPVycsXG4gICAgICAgICAgc3dlcHRQcmljZTogdGhpcy5sb25kb25SYW5nZS5sb3csXG4gICAgICAgICAgcmV2ZXJzYWxQcmljZTogdGhpcy5sb25kb25SYW5nZS5oaWdoLFxuICAgICAgICAgIGRpcmVjdGlvbjogJ0xPTkcnLFxuICAgICAgICAgIGNvbmZpZGVuY2U6IDgwXG4gICAgICAgIH07XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICAvKipcbiAgICogR2V0IHN0b3JlZCBBc2lhbiByYW5nZVxuICAgKi9cbiAgZ2V0QXNpYW5SYW5nZSgpOiBBc2lhblJhbmdlIHwgbnVsbCB7XG4gICAgcmV0dXJuIHRoaXMuYXNpYW5SYW5nZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgc3RvcmVkIExvbmRvbiByYW5nZVxuICAgKi9cbiAgZ2V0TG9uZG9uUmFuZ2UoKTogeyBoaWdoOiBudW1iZXI7IGxvdzogbnVtYmVyOyB0aW1lc3RhbXA6IG51bWJlciB9IHwgbnVsbCB7XG4gICAgcmV0dXJuIHRoaXMubG9uZG9uUmFuZ2U7XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIExvbmRvbiByYW5nZSBkdXJpbmcgTG9uZG9uIHNlc3Npb25cbiAgICovXG4gIHVwZGF0ZUxvbmRvblJhbmdlKG9obGN2RGF0YTogT0hMQ1ZbXSk6IHZvaWQge1xuICAgIGlmIChvaGxjdkRhdGEubGVuZ3RoID09PSAwKSB7XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgLy8gRmluZCBoaWdoIGFuZCBsb3cgZHVyaW5nIExvbmRvbiBzZXNzaW9uICgwNzowMC0xMDowMCBVVEMpXG4gICAgbGV0IGhpZ2ggPSAtSW5maW5pdHk7XG4gICAgbGV0IGxvdyA9IEluZmluaXR5O1xuICAgIGxldCB0aW1lc3RhbXAgPSAwO1xuXG4gICAgZm9yIChjb25zdCBjYW5kbGUgb2Ygb2hsY3ZEYXRhKSB7XG4gICAgICBjb25zdCBjYW5kbGVEYXRlID0gbmV3IERhdGUoY2FuZGxlLnRpbWVzdGFtcCk7XG4gICAgICBjb25zdCB1dGNIb3VyID0gY2FuZGxlRGF0ZS5nZXRVVENIb3VycygpO1xuICAgICAgXG4gICAgICAvLyBDaGVjayBpZiBjYW5kbGUgaXMgd2l0aGluIExvbmRvbiBzZXNzaW9uXG4gICAgICBpZiAodXRjSG91ciA+PSA3ICYmIHV0Y0hvdXIgPCAxMCkge1xuICAgICAgICBpZiAoY2FuZGxlLmhpZ2ggPiBoaWdoKSB7XG4gICAgICAgICAgaGlnaCA9IGNhbmRsZS5oaWdoO1xuICAgICAgICB9XG4gICAgICAgIGlmIChjYW5kbGUubG93IDwgbG93KSB7XG4gICAgICAgICAgbG93ID0gY2FuZGxlLmxvdztcbiAgICAgICAgfVxuICAgICAgICB0aW1lc3RhbXAgPSBNYXRoLm1heCh0aW1lc3RhbXAsIGNhbmRsZS50aW1lc3RhbXApO1xuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChoaWdoICE9PSAtSW5maW5pdHkgJiYgbG93ICE9PSBJbmZpbml0eSkge1xuICAgICAgdGhpcy5sb25kb25SYW5nZSA9IHtcbiAgICAgICAgaGlnaCxcbiAgICAgICAgbG93LFxuICAgICAgICB0aW1lc3RhbXBcbiAgICAgIH07XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIENoZWNrIGlmIHdlIHNob3VsZCBkaXNhYmxlIG5ldyBlbnRyaWVzIChEZWFkIFpvbmUpXG4gICAqIFJlcXVpcmVtZW50czogMi42IChEZWFkIHpvbmUgcmVzdHJpY3Rpb25zKVxuICAgKi9cbiAgc2hvdWxkRGlzYWJsZU5ld0VudHJpZXMoKTogYm9vbGVhbiB7XG4gICAgY29uc3Qgc2Vzc2lvblN0YXRlID0gdGhpcy5nZXRTZXNzaW9uU3RhdGUoKTtcbiAgICByZXR1cm4gc2Vzc2lvblN0YXRlLnR5cGUgPT09ICdERUFEX1pPTkUnO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBzZXNzaW9uIHN0YXRpc3RpY3MgZm9yIGRpc3BsYXlcbiAgICovXG4gIGdldFNlc3Npb25TdGF0cygpOiB7XG4gICAgY3VycmVudFNlc3Npb246IFNlc3Npb25UeXBlO1xuICAgIHRpbWVSZW1haW5pbmc6IG51bWJlcjtcbiAgICBhc2lhblJhbmdlOiBBc2lhblJhbmdlIHwgbnVsbDtcbiAgICBsb25kb25SYW5nZTogeyBoaWdoOiBudW1iZXI7IGxvdzogbnVtYmVyOyB0aW1lc3RhbXA6IG51bWJlciB9IHwgbnVsbDtcbiAgICBpc0tpbGx6b25lOiBib29sZWFuO1xuICB9IHtcbiAgICBjb25zdCBzZXNzaW9uU3RhdGUgPSB0aGlzLmdldFNlc3Npb25TdGF0ZSgpO1xuICAgIFxuICAgIHJldHVybiB7XG4gICAgICBjdXJyZW50U2Vzc2lvbjogc2Vzc2lvblN0YXRlLnR5cGUsXG4gICAgICB0aW1lUmVtYWluaW5nOiBzZXNzaW9uU3RhdGUudGltZVJlbWFpbmluZyxcbiAgICAgIGFzaWFuUmFuZ2U6IHRoaXMuYXNpYW5SYW5nZSxcbiAgICAgIGxvbmRvblJhbmdlOiB0aGlzLmxvbmRvblJhbmdlLFxuICAgICAgaXNLaWxsem9uZTogdGhpcy5pc0tpbGx6b25lKClcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIEhhbmRsZSBzZXNzaW9uIHRyYW5zaXRpb24gYW5kIGVtaXQgZXZlbnRzXG4gICAqIFJlcXVpcmVtZW50czogMi43IChTZXNzaW9uIHRyYW5zaXRpb24gZXZlbnRzKVxuICAgKi9cbiAgcHJpdmF0ZSBoYW5kbGVTZXNzaW9uVHJhbnNpdGlvbihuZXdTZXNzaW9uOiBTZXNzaW9uU3RhdGUpOiB2b2lkIHtcbiAgICBjb25zdCBwcmV2aW91c1Nlc3Npb24gPSB0aGlzLmN1cnJlbnRTZXNzaW9uPy50eXBlO1xuICAgIFxuICAgIC8vIEVtaXQgc2Vzc2lvbiBjaGFuZ2UgZXZlbnQgd2l0aCByZWZlcmVuY2UgbGV2ZWxzXG4gICAgdGhpcy5lbWl0KCdTRVNTSU9OX0NIQU5HRScsIHtcbiAgICAgIHByZXZpb3VzU2Vzc2lvbixcbiAgICAgIG5ld1Nlc3Npb246IG5ld1Nlc3Npb24udHlwZSxcbiAgICAgIGFzaWFuUmFuZ2U6IHRoaXMuYXNpYW5SYW5nZSxcbiAgICAgIGxvbmRvblJhbmdlOiB0aGlzLmxvbmRvblJhbmdlLFxuICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpXG4gICAgfSk7XG5cbiAgICAvLyBTcGVjaWFsIGhhbmRsaW5nIGZvciBzZXNzaW9uLXNwZWNpZmljIGxvZ2ljXG4gICAgaWYgKG5ld1Nlc3Npb24udHlwZSA9PT0gJ0xPTkRPTicgJiYgcHJldmlvdXNTZXNzaW9uID09PSAnQVNJQU4nKSB7XG4gICAgICAvLyBMb25kb24gb3BlbmluZyAtIHByZXBhcmUgZm9yIEFzaWFuIHJhbmdlIG1hbmlwdWxhdGlvblxuICAgICAgdGhpcy5lbWl0KCdMT05ET05fT1BFTicsIHtcbiAgICAgICAgYXNpYW5SYW5nZTogdGhpcy5hc2lhblJhbmdlLFxuICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KClcbiAgICAgIH0pO1xuICAgIH1cblxuICAgIGlmIChuZXdTZXNzaW9uLnR5cGUgPT09ICdOWScgJiYgcHJldmlvdXNTZXNzaW9uID09PSAnTE9ORE9OJykge1xuICAgICAgLy8gTlkgb3BlbmluZyAtIHByZXBhcmUgZm9yIExvbmRvbiByYW5nZSBtYW5pcHVsYXRpb25cbiAgICAgIHRoaXMuZW1pdCgnTllfT1BFTicsIHtcbiAgICAgICAgbG9uZG9uUmFuZ2U6IHRoaXMubG9uZG9uUmFuZ2UsXG4gICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKVxuICAgICAgfSk7XG4gICAgfVxuXG4gICAgaWYgKG5ld1Nlc3Npb24udHlwZSA9PT0gJ0RFQURfWk9ORScpIHtcbiAgICAgIC8vIERlYWQgem9uZSAtIGRpc2FibGUgbmV3IGVudHJpZXNcbiAgICAgIHRoaXMuZW1pdCgnREVBRF9aT05FX1NUQVJUJywge1xuICAgICAgICB0aW1lc3RhbXA6IERhdGUubm93KClcbiAgICAgIH0pO1xuICAgIH1cbiAgfVxufSJdLCJ2ZXJzaW9uIjozfQ==
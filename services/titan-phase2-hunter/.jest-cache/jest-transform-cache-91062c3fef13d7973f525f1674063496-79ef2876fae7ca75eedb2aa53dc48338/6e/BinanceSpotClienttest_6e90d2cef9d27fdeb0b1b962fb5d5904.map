{"file":"/Users/ivan/Code/trading/titan/services/titan-phase2-hunter/tests/unit/BinanceSpotClient.test.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-phase2-hunter/tests/unit/BinanceSpotClient.test.ts"],"sourcesContent":["/**\n * Unit tests for BinanceSpotClient\n */\n\nimport { BinanceSpotClient } from '../../src/exchanges/BinanceSpotClient';\nimport { Trade } from '../../src/types';\n\n// Mock WebSocket\njest.mock('ws');\njest.mock('node-fetch', () => jest.fn());\n\nimport WebSocket = require('ws');\n\nconst mockWebSocket = WebSocket as jest.MockedClass<typeof WebSocket>;\n\ndescribe('BinanceSpotClient', () => {\n  let client: BinanceSpotClient;\n  let mockWs: jest.Mocked<WebSocket>;\n\n  beforeEach(() => {\n    jest.clearAllMocks();\n    \n    // Mock WebSocket instance\n    mockWs = {\n      send: jest.fn(),\n      close: jest.fn(),\n      ping: jest.fn(),\n      on: jest.fn(),\n      removeAllListeners: jest.fn(),\n    } as any;\n\n    // Make readyState writable\n    Object.defineProperty(mockWs, 'readyState', {\n      value: WebSocket.OPEN,\n      writable: true,\n      configurable: true\n    });\n\n    mockWebSocket.mockImplementation(() => mockWs);\n    \n    client = new BinanceSpotClient();\n  });\n\n  afterEach(() => {\n    client.close();\n  });\n\n  describe('subscribeAggTrades', () => {\n    it('should add callback to subscriptions', () => {\n      const callback = jest.fn();\n      \n      client.subscribeAggTrades('BTCUSDT', callback);\n\n      // Verify WebSocket constructor was called\n      expect(mockWebSocket).toHaveBeenCalled();\n    });\n\n    it('should handle multiple callbacks for same symbol', () => {\n      const callback1 = jest.fn();\n      const callback2 = jest.fn();\n      \n      client.subscribeAggTrades('BTCUSDT', callback1);\n      client.subscribeAggTrades('BTCUSDT', callback2);\n\n      // Should only create one WebSocket connection\n      expect(mockWebSocket).toHaveBeenCalledTimes(1);\n    });\n\n    it('should normalize symbol to lowercase', () => {\n      const callback = jest.fn();\n      \n      client.subscribeAggTrades('BTCUSDT', callback);\n      \n      // Verify WebSocket URL contains lowercase symbol\n      const constructorCall = mockWebSocket.mock.calls[0];\n      expect(constructorCall[0]).toContain('btcusdt@aggTrade');\n    });\n  });\n\n  describe('unsubscribeAggTrades', () => {\n    it('should remove callback from subscriptions', () => {\n      const callback = jest.fn();\n      \n      client.subscribeAggTrades('BTCUSDT', callback);\n      client.unsubscribeAggTrades('BTCUSDT', callback);\n\n      // Should send unsubscribe message\n      expect(mockWs.send).toHaveBeenCalledWith(\n        expect.stringContaining('UNSUBSCRIBE')\n      );\n    });\n  });\n\n  describe('getConnectionStatus', () => {\n    it('should return CLOSED when no WebSocket', () => {\n      const newClient = new BinanceSpotClient();\n      expect(newClient.getConnectionStatus()).toBe('CLOSED');\n      newClient.close();\n    });\n\n    it('should return correct status based on WebSocket state', () => {\n      const callback = jest.fn();\n      client.subscribeAggTrades('BTCUSDT', callback);\n\n      Object.defineProperty(mockWs, 'readyState', { value: WebSocket.OPEN, writable: true });\n      expect(client.getConnectionStatus()).toBe('OPEN');\n\n      Object.defineProperty(mockWs, 'readyState', { value: WebSocket.CONNECTING, writable: true });\n      expect(client.getConnectionStatus()).toBe('CONNECTING');\n\n      Object.defineProperty(mockWs, 'readyState', { value: WebSocket.CLOSING, writable: true });\n      expect(client.getConnectionStatus()).toBe('CLOSING');\n\n      Object.defineProperty(mockWs, 'readyState', { value: WebSocket.CLOSED, writable: true });\n      expect(client.getConnectionStatus()).toBe('CLOSED');\n    });\n  });\n\n  describe('error handling', () => {\n    it('should call error callbacks when error occurs', () => {\n      const errorCallback = jest.fn();\n      client.onError(errorCallback);\n      \n      // Subscribe to trigger WebSocket creation\n      const callback = jest.fn();\n      client.subscribeAggTrades('BTCUSDT', callback);\n\n      // Simulate WebSocket error\n      const onCall = mockWs.on.mock.calls.find(call => call[0] === 'error');\n      if (onCall) {\n        const errorHandler = onCall[1] as (error: Error) => void;\n        errorHandler(new Error('Test error'));\n      }\n\n      expect(errorCallback).toHaveBeenCalledWith(expect.any(Error));\n    });\n\n    it('should call reconnect callbacks on reconnection', () => {\n      const reconnectCallback = jest.fn();\n      client.onReconnect(reconnectCallback);\n\n      // This would be called during actual reconnection\n      // For unit test, we just verify the callback is registered\n      expect(reconnectCallback).not.toHaveBeenCalled();\n    });\n  });\n\n  describe('message handling', () => {\n    it('should parse aggregate trade messages correctly', () => {\n      const callback = jest.fn();\n      client.subscribeAggTrades('BTCUSDT', callback);\n\n      // Simulate WebSocket message\n      const onCall = mockWs.on.mock.calls.find(call => call[0] === 'message');\n      if (onCall) {\n        const messageHandler = onCall[1] as (data: any) => void;\n        const aggTradeMessage = {\n          e: 'aggTrade',\n          E: 1234567890,\n          s: 'BTCUSDT',\n          a: 12345,\n          p: '50000.00',\n          q: '0.1',\n          f: 100,\n          l: 200,\n          T: 1234567890,\n          m: false, // buyer is not market maker (BUY)\n          M: true\n        };\n\n        messageHandler(Buffer.from(JSON.stringify(aggTradeMessage)));\n      }\n\n      expect(callback).toHaveBeenCalledWith({\n        price: 50000,\n        quantity: 0.1,\n        side: 'BUY',\n        timestamp: 1234567890\n      });\n    });\n\n    it('should handle sell trades correctly', () => {\n      const callback = jest.fn();\n      client.subscribeAggTrades('BTCUSDT', callback);\n\n      // Simulate WebSocket message\n      const onCall = mockWs.on.mock.calls.find(call => call[0] === 'message');\n      if (onCall) {\n        const messageHandler = onCall[1] as (data: any) => void;\n        const aggTradeMessage = {\n          e: 'aggTrade',\n          E: 1234567890,\n          s: 'BTCUSDT',\n          a: 12345,\n          p: '49999.99',\n          q: '0.2',\n          f: 100,\n          l: 200,\n          T: 1234567890,\n          m: true, // buyer is market maker (SELL)\n          M: true\n        };\n\n        messageHandler(Buffer.from(JSON.stringify(aggTradeMessage)));\n      }\n\n      expect(callback).toHaveBeenCalledWith({\n        price: 49999.99,\n        quantity: 0.2,\n        side: 'SELL',\n        timestamp: 1234567890\n      });\n    });\n  });\n\n  describe('cleanup', () => {\n    it('should cleanup resources on close', () => {\n      const callback = jest.fn();\n      client.subscribeAggTrades('BTCUSDT', callback);\n      \n      client.close();\n\n      expect(mockWs.close).toHaveBeenCalled();\n      expect(client.getConnectionStatus()).toBe('CLOSED');\n    });\n  });\n});"],"version":3}
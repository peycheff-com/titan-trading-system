067d1b3d6bef2685005f18ee391cd5b7
"use strict";
/**
 * Unit tests for BinanceSpotClient
 */
Object.defineProperty(exports, "__esModule", { value: true });
// Mock WebSocket
jest.mock('ws');
jest.mock('node-fetch', () => jest.fn());
const BinanceSpotClient_1 = require("../../src/exchanges/BinanceSpotClient");
const WebSocket = require("ws");
const mockWebSocket = WebSocket;
describe('BinanceSpotClient', () => {
    let client;
    let mockWs;
    beforeEach(() => {
        jest.clearAllMocks();
        // Mock WebSocket instance
        mockWs = {
            send: jest.fn(),
            close: jest.fn(),
            ping: jest.fn(),
            on: jest.fn(),
            removeAllListeners: jest.fn(),
        };
        // Make readyState writable
        Object.defineProperty(mockWs, 'readyState', {
            value: WebSocket.OPEN,
            writable: true,
            configurable: true
        });
        mockWebSocket.mockImplementation(() => mockWs);
        client = new BinanceSpotClient_1.BinanceSpotClient();
    });
    afterEach(() => {
        client.close();
    });
    describe('subscribeAggTrades', () => {
        it('should add callback to subscriptions', () => {
            const callback = jest.fn();
            client.subscribeAggTrades('BTCUSDT', callback);
            // Verify WebSocket constructor was called
            expect(mockWebSocket).toHaveBeenCalled();
        });
        it('should handle multiple callbacks for same symbol', () => {
            const callback1 = jest.fn();
            const callback2 = jest.fn();
            client.subscribeAggTrades('BTCUSDT', callback1);
            client.subscribeAggTrades('BTCUSDT', callback2);
            // Should only create one WebSocket connection
            expect(mockWebSocket).toHaveBeenCalledTimes(1);
        });
        it('should normalize symbol to lowercase', () => {
            const callback = jest.fn();
            client.subscribeAggTrades('BTCUSDT', callback);
            // Verify WebSocket URL contains lowercase symbol
            const constructorCall = mockWebSocket.mock.calls[0];
            expect(constructorCall[0]).toContain('btcusdt@aggTrade');
        });
    });
    describe('unsubscribeAggTrades', () => {
        it('should remove callback from subscriptions', () => {
            const callback = jest.fn();
            client.subscribeAggTrades('BTCUSDT', callback);
            client.unsubscribeAggTrades('BTCUSDT', callback);
            // Should send unsubscribe message
            expect(mockWs.send).toHaveBeenCalledWith(expect.stringContaining('UNSUBSCRIBE'));
        });
    });
    describe('getConnectionStatus', () => {
        it('should return CLOSED when no WebSocket', () => {
            const newClient = new BinanceSpotClient_1.BinanceSpotClient();
            expect(newClient.getConnectionStatus()).toBe('CLOSED');
            newClient.close();
        });
        it('should return correct status based on WebSocket state', () => {
            const callback = jest.fn();
            client.subscribeAggTrades('BTCUSDT', callback);
            Object.defineProperty(mockWs, 'readyState', { value: WebSocket.OPEN, writable: true });
            expect(client.getConnectionStatus()).toBe('OPEN');
            Object.defineProperty(mockWs, 'readyState', { value: WebSocket.CONNECTING, writable: true });
            expect(client.getConnectionStatus()).toBe('CONNECTING');
            Object.defineProperty(mockWs, 'readyState', { value: WebSocket.CLOSING, writable: true });
            expect(client.getConnectionStatus()).toBe('CLOSING');
            Object.defineProperty(mockWs, 'readyState', { value: WebSocket.CLOSED, writable: true });
            expect(client.getConnectionStatus()).toBe('CLOSED');
        });
    });
    describe('error handling', () => {
        it('should call error callbacks when error occurs', () => {
            const errorCallback = jest.fn();
            client.onError(errorCallback);
            // Subscribe to trigger WebSocket creation
            const callback = jest.fn();
            client.subscribeAggTrades('BTCUSDT', callback);
            // Simulate WebSocket error
            const onCall = mockWs.on.mock.calls.find(call => call[0] === 'error');
            if (onCall) {
                const errorHandler = onCall[1];
                errorHandler(new Error('Test error'));
            }
            expect(errorCallback).toHaveBeenCalledWith(expect.any(Error));
        });
        it('should call reconnect callbacks on reconnection', () => {
            const reconnectCallback = jest.fn();
            client.onReconnect(reconnectCallback);
            // This would be called during actual reconnection
            // For unit test, we just verify the callback is registered
            expect(reconnectCallback).not.toHaveBeenCalled();
        });
    });
    describe('message handling', () => {
        it('should parse aggregate trade messages correctly', () => {
            const callback = jest.fn();
            client.subscribeAggTrades('BTCUSDT', callback);
            // Simulate WebSocket message
            const onCall = mockWs.on.mock.calls.find(call => call[0] === 'message');
            if (onCall) {
                const messageHandler = onCall[1];
                const aggTradeMessage = {
                    e: 'aggTrade',
                    E: 1234567890,
                    s: 'BTCUSDT',
                    a: 12345,
                    p: '50000.00',
                    q: '0.1',
                    f: 100,
                    l: 200,
                    T: 1234567890,
                    m: false, // buyer is not market maker (BUY)
                    M: true
                };
                messageHandler(Buffer.from(JSON.stringify(aggTradeMessage)));
            }
            expect(callback).toHaveBeenCalledWith({
                price: 50000,
                quantity: 0.1,
                side: 'BUY',
                timestamp: 1234567890
            });
        });
        it('should handle sell trades correctly', () => {
            const callback = jest.fn();
            client.subscribeAggTrades('BTCUSDT', callback);
            // Simulate WebSocket message
            const onCall = mockWs.on.mock.calls.find(call => call[0] === 'message');
            if (onCall) {
                const messageHandler = onCall[1];
                const aggTradeMessage = {
                    e: 'aggTrade',
                    E: 1234567890,
                    s: 'BTCUSDT',
                    a: 12345,
                    p: '49999.99',
                    q: '0.2',
                    f: 100,
                    l: 200,
                    T: 1234567890,
                    m: true, // buyer is market maker (SELL)
                    M: true
                };
                messageHandler(Buffer.from(JSON.stringify(aggTradeMessage)));
            }
            expect(callback).toHaveBeenCalledWith({
                price: 49999.99,
                quantity: 0.2,
                side: 'SELL',
                timestamp: 1234567890
            });
        });
    });
    describe('cleanup', () => {
        it('should cleanup resources on close', () => {
            const callback = jest.fn();
            client.subscribeAggTrades('BTCUSDT', callback);
            client.close();
            expect(mockWs.close).toHaveBeenCalled();
            expect(client.getConnectionStatus()).toBe('CLOSED');
        });
    });
});
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLXBoYXNlMi1odW50ZXIvdGVzdHMvdW5pdC9CaW5hbmNlU3BvdENsaWVudC50ZXN0LnRzIiwibWFwcGluZ3MiOiI7QUFBQTs7R0FFRzs7QUFLSCxpQkFBaUI7QUFDakIsSUFBSSxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQztBQUNoQixJQUFJLENBQUMsSUFBSSxDQUFDLFlBQVksRUFBRSxHQUFHLEVBQUUsQ0FBQyxJQUFJLENBQUMsRUFBRSxFQUFFLENBQUMsQ0FBQztBQUx6Qyw2RUFBMEU7QUFPMUUsZ0NBQWlDO0FBRWpDLE1BQU0sYUFBYSxHQUFHLFNBQStDLENBQUM7QUFFdEUsUUFBUSxDQUFDLG1CQUFtQixFQUFFLEdBQUcsRUFBRTtJQUNqQyxJQUFJLE1BQXlCLENBQUM7SUFDOUIsSUFBSSxNQUE4QixDQUFDO0lBRW5DLFVBQVUsQ0FBQyxHQUFHLEVBQUU7UUFDZCxJQUFJLENBQUMsYUFBYSxFQUFFLENBQUM7UUFFckIsMEJBQTBCO1FBQzFCLE1BQU0sR0FBRztZQUNQLElBQUksRUFBRSxJQUFJLENBQUMsRUFBRSxFQUFFO1lBQ2YsS0FBSyxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDaEIsSUFBSSxFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7WUFDZixFQUFFLEVBQUUsSUFBSSxDQUFDLEVBQUUsRUFBRTtZQUNiLGtCQUFrQixFQUFFLElBQUksQ0FBQyxFQUFFLEVBQUU7U0FDdkIsQ0FBQztRQUVULDJCQUEyQjtRQUMzQixNQUFNLENBQUMsY0FBYyxDQUFDLE1BQU0sRUFBRSxZQUFZLEVBQUU7WUFDMUMsS0FBSyxFQUFFLFNBQVMsQ0FBQyxJQUFJO1lBQ3JCLFFBQVEsRUFBRSxJQUFJO1lBQ2QsWUFBWSxFQUFFLElBQUk7U0FDbkIsQ0FBQyxDQUFDO1FBRUgsYUFBYSxDQUFDLGtCQUFrQixDQUFDLEdBQUcsRUFBRSxDQUFDLE1BQU0sQ0FBQyxDQUFDO1FBRS9DLE1BQU0sR0FBRyxJ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QUFJLENBQUMsRUFBRSxFQUFFLENBQUM7WUFDM0IsTUFBTSxDQUFDLGtCQUFrQixDQUFDLFNBQVMsRUFBRSxRQUFRLENBQUMsQ0FBQztZQUUvQyxNQUFNLENBQUMsS0FBSyxFQUFFLENBQUM7WUFFZixNQUFNLENBQUMsTUFBTSxDQUFDLEtBQUssQ0FBQyxDQUFDLGdCQUFnQixFQUFFLENBQUM7WUFDeEMsTUFBTSxDQUFDLE1BQU0sQ0FBQyxtQkFBbUIsRUFBRSxDQUFDLENBQUMsSUFBSSxDQUFDLFFBQVEsQ0FBQyxDQUFDO1FBQ3RELENBQUMsQ0FBQyxDQUFDO0lBQ0wsQ0FBQyxDQUFDLENBQUM7QUFDTCxDQUFDLENBQUMsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvaXZhbi9Db2RlL3RyYWRpbmcvdGl0YW4vc2VydmljZXMvdGl0YW4tcGhhc2UyLWh1bnRlci90ZXN0cy91bml0L0JpbmFuY2VTcG90Q2xpZW50LnRlc3QudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBVbml0IHRlc3RzIGZvciBCaW5hbmNlU3BvdENsaWVudFxuICovXG5cbmltcG9ydCB7IEJpbmFuY2VTcG90Q2xpZW50IH0gZnJvbSAnLi4vLi4vc3JjL2V4Y2hhbmdlcy9CaW5hbmNlU3BvdENsaWVudCc7XG5pbXBvcnQgeyBUcmFkZSB9IGZyb20gJy4uLy4uL3NyYy90eXBlcyc7XG5cbi8vIE1vY2sgV2ViU29ja2V0XG5qZXN0Lm1vY2soJ3dzJyk7XG5qZXN0Lm1vY2soJ25vZGUtZmV0Y2gnLCAoKSA9PiBqZXN0LmZuKCkpO1xuXG5pbXBvcnQgV2ViU29ja2V0ID0gcmVxdWlyZSgnd3MnKTtcblxuY29uc3QgbW9ja1dlYlNvY2tldCA9IFdlYlNvY2tldCBhcyBqZXN0Lk1vY2tlZENsYXNzPHR5cGVvZiBXZWJTb2NrZXQ+O1xuXG5kZXNjcmliZSgnQmluYW5jZVNwb3RDbGllbnQnLCAoKSA9PiB7XG4gIGxldCBjbGllbnQ6IEJpbmFuY2VTcG90Q2xpZW50O1xuICBsZXQgbW9ja1dzOiBqZXN0Lk1vY2tlZDxXZWJTb2NrZXQ+O1xuXG4gIGJlZm9yZUVhY2goKCkgPT4ge1xuICAgIGplc3QuY2xlYXJBbGxNb2NrcygpO1xuICAgIFxuICAgIC8vIE1vY2sgV2ViU29ja2V0IGluc3RhbmNlXG4gICAgbW9ja1dzID0ge1xuICAgICAgc2VuZDogamVzdC5mbigpLFxuICAgICAgY2xvc2U6IGplc3QuZm4oKSxcbiAgICAgIHBpbmc6IGplc3QuZm4oKSxcbiAgICAgIG9uOiBqZXN0LmZuKCksXG4gICAgICByZW1vdmVBbGxMaXN0ZW5lcnM6IGplc3QuZm4oKSxcbiAgICB9IGFzIGFueTtcblxuICAgIC8vIE1ha2UgcmVhZHlTdGF0ZSB3cml0YWJsZVxuICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShtb2NrV3MsICdyZWFkeVN0YXRlJywge1xuICAgICAgdmFsdWU6IFdlYlNvY2tldC5PUEVOLFxuICAgICAgd3JpdGFibGU6IHRydWUsXG4gICAgICBjb25maWd1cmFibGU6IHRydWVcbiAgICB9KTtcblxuICAgIG1vY2tXZWJTb2NrZXQubW9ja0ltcGxlbWVudGF0aW9uKCgpID0+IG1vY2tXcyk7XG4gICAgXG4gICAgY2xpZW50ID0gbmV3IEJpbmFuY2VTcG90Q2xpZW50KCk7XG4gIH0pO1xuXG4gIGFmdGVyRWFjaCgoKSA9PiB7XG4gICAgY2xpZW50LmNsb3NlKCk7XG4gIH0pO1xuXG4gIGRlc2NyaWJlKCdzdWJzY3JpYmVBZ2dUcmFkZXMnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCBhZGQgY2FsbGJhY2sgdG8gc3Vic2NyaXB0aW9ucycsICgpID0+IHtcbiAgICAgIGNvbnN0IGNhbGxiYWNrID0gamVzdC5mbigpO1xuICAgICAgXG4gICAgICBjbGllbnQuc3Vic2NyaWJlQWdnVHJhZGVzKCdCVENVU0RUJywgY2FsbGJhY2spO1xuXG4gICAgICAvLyBWZXJpZnkgV2ViU29ja2V0IGNvbnN0cnVjdG9yIHdhcyBjYWxsZWRcbiAgICAgIGV4cGVjdChtb2NrV2ViU29ja2V0KS50b0hhdmVCZWVuQ2FsbGVkKCk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGhhbmRsZSBtdWx0aXBsZSBjYWxsYmFja3MgZm9yIHNhbWUgc3ltYm9sJywgKCkgPT4ge1xuICAgICAgY29uc3QgY2FsbGJhY2sxID0gamVzdC5mbigpO1xuICAgICAgY29uc3QgY2FsbGJhY2syID0gamVzdC5mbigpO1xuICAgICAgXG4gICAgICBjbGllbnQuc3Vic2NyaWJlQWdnVHJhZGVzKCdCVENVU0RUJywgY2FsbGJhY2sxKTtcbiAgICAgIGNsaWVudC5zdWJzY3JpYmVBZ2dUcmFkZXMoJ0JUQ1VTRFQnLCBjYWxsYmFjazIpO1xuXG4gICAgICAvLyBTaG91bGQgb25seSBjcmVhdGUgb25lIFdlYlNvY2tldCBjb25uZWN0aW9uXG4gICAgICBleHBlY3QobW9ja1dlYlNvY2tldCkudG9IYXZlQmVlbkNhbGxlZFRpbWVzKDEpO1xuICAgIH0pO1xuXG4gICAgaXQoJ3Nob3VsZCBub3JtYWxpemUgc3ltYm9sIHRvIGxvd2VyY2FzZScsICgpID0+IHtcbiAgICAgIGNvbnN0IGNhbGxiYWNrID0gamVzdC5mbigpO1xuICAgICAgXG4gICAgICBjbGllbnQuc3Vic2NyaWJlQWdnVHJhZGVzKCdCVENVU0RUJywgY2FsbGJhY2spO1xuICAgICAgXG4gICAgICAvLyBWZXJpZnkgV2ViU29ja2V0IFVSTCBjb250YWlucyBsb3dlcmNhc2Ugc3ltYm9sXG4gICAgICBjb25zdCBjb25zdHJ1Y3RvckNhbGwgPSBtb2NrV2ViU29ja2V0Lm1vY2suY2FsbHNbMF07XG4gICAgICBleHBlY3QoY29uc3RydWN0b3JDYWxsWzBdKS50b0NvbnRhaW4oJ2J0Y3VzZHRAYWdnVHJhZGUnKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ3Vuc3Vic2NyaWJlQWdnVHJhZGVzJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgcmVtb3ZlIGNhbGxiYWNrIGZyb20gc3Vic2NyaXB0aW9ucycsICgpID0+IHtcbiAgICAgIGNvbnN0IGNhbGxiYWNrID0gamVzdC5mbigpO1xuICAgICAgXG4gICAgICBjbGllbnQuc3Vic2NyaWJlQWdnVHJhZGVzKCdCVENVU0RUJywgY2FsbGJhY2spO1xuICAgICAgY2xpZW50LnVuc3Vic2NyaWJlQWdnVHJhZGVzKCdCVENVU0RUJywgY2FsbGJhY2spO1xuXG4gICAgICAvLyBTaG91bGQgc2VuZCB1bnN1YnNjcmliZSBtZXNzYWdlXG4gICAgICBleHBlY3QobW9ja1dzLnNlbmQpLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKFxuICAgICAgICBleHBlY3Quc3RyaW5nQ29udGFpbmluZygnVU5TVUJTQ1JJQkUnKVxuICAgICAgKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2dldENvbm5lY3Rpb25TdGF0dXMnLCAoKSA9PiB7XG4gICAgaXQoJ3Nob3VsZCByZXR1cm4gQ0xPU0VEIHdoZW4gbm8gV2ViU29ja2V0JywgKCkgPT4ge1xuICAgICAgY29uc3QgbmV3Q2xpZW50ID0gbmV3IEJpbmFuY2VTcG90Q2xpZW50KCk7XG4gICAgICBleHBlY3QobmV3Q2xpZW50LmdldENvbm5lY3Rpb25TdGF0dXMoKSkudG9CZSgnQ0xPU0VEJyk7XG4gICAgICBuZXdDbGllbnQuY2xvc2UoKTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgcmV0dXJuIGNvcnJlY3Qgc3RhdHVzIGJhc2VkIG9uIFdlYlNvY2tldCBzdGF0ZScsICgpID0+IHtcbiAgICAgIGNvbnN0IGNhbGxiYWNrID0gamVzdC5mbigpO1xuICAgICAgY2xpZW50LnN1YnNjcmliZUFnZ1RyYWRlcygnQlRDVVNEVCcsIGNhbGxiYWNrKTtcblxuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG1vY2tXcywgJ3JlYWR5U3RhdGUnLCB7IHZhbHVlOiBXZWJTb2NrZXQuT1BFTiwgd3JpdGFibGU6IHRydWUgfSk7XG4gICAgICBleHBlY3QoY2xpZW50LmdldENvbm5lY3Rpb25TdGF0dXMoKSkudG9CZSgnT1BFTicpO1xuXG4gICAgICBPYmplY3QuZGVmaW5lUHJvcGVydHkobW9ja1dzLCAncmVhZHlTdGF0ZScsIHsgdmFsdWU6IFdlYlNvY2tldC5DT05ORUNUSU5HLCB3cml0YWJsZTogdHJ1ZSB9KTtcbiAgICAgIGV4cGVjdChjbGllbnQuZ2V0Q29ubmVjdGlvblN0YXR1cygpKS50b0JlKCdDT05ORUNUSU5HJyk7XG5cbiAgICAgIE9iamVjdC5kZWZpbmVQcm9wZXJ0eShtb2NrV3MsICdyZWFkeVN0YXRlJywgeyB2YWx1ZTogV2ViU29ja2V0LkNMT1NJTkcsIHdyaXRhYmxlOiB0cnVlIH0pO1xuICAgICAgZXhwZWN0KGNsaWVudC5nZXRDb25uZWN0aW9uU3RhdHVzKCkpLnRvQmUoJ0NMT1NJTkcnKTtcblxuICAgICAgT2JqZWN0LmRlZmluZVByb3BlcnR5KG1vY2tXcywgJ3JlYWR5U3RhdGUnLCB7IHZhbHVlOiBXZWJTb2NrZXQuQ0xPU0VELCB3cml0YWJsZTogdHJ1ZSB9KTtcbiAgICAgIGV4cGVjdChjbGllbnQuZ2V0Q29ubmVjdGlvblN0YXR1cygpKS50b0JlKCdDTE9TRUQnKTtcbiAgICB9KTtcbiAgfSk7XG5cbiAgZGVzY3JpYmUoJ2Vycm9yIGhhbmRsaW5nJywgKCkgPT4ge1xuICAgIGl0KCdzaG91bGQgY2FsbCBlcnJvciBjYWxsYmFja3Mgd2hlbiBlcnJvciBvY2N1cnMnLCAoKSA9PiB7XG4gICAgICBjb25zdCBlcnJvckNhbGxiYWNrID0gamVzdC5mbigpO1xuICAgICAgY2xpZW50Lm9uRXJyb3IoZXJyb3JDYWxsYmFjayk7XG4gICAgICBcbiAgICAgIC8vIFN1YnNjcmliZSB0byB0cmlnZ2VyIFdlYlNvY2tldCBjcmVhdGlvblxuICAgICAgY29uc3QgY2FsbGJhY2sgPSBqZXN0LmZuKCk7XG4gICAgICBjbGllbnQuc3Vic2NyaWJlQWdnVHJhZGVzKCdCVENVU0RUJywgY2FsbGJhY2spO1xuXG4gICAgICAvLyBTaW11bGF0ZSBXZWJTb2NrZXQgZXJyb3JcbiAgICAgIGNvbnN0IG9uQ2FsbCA9IG1vY2tXcy5vbi5tb2NrLmNhbGxzLmZpbmQoY2FsbCA9PiBjYWxsWzBdID09PSAnZXJyb3InKTtcbiAgICAgIGlmIChvbkNhbGwpIHtcbiAgICAgICAgY29uc3QgZXJyb3JIYW5kbGVyID0gb25DYWxsWzFdIGFzIChlcnJvcjogRXJyb3IpID0+IHZvaWQ7XG4gICAgICAgIGVycm9ySGFuZGxlcihuZXcgRXJyb3IoJ1Rlc3QgZXJyb3InKSk7XG4gICAgICB9XG5cbiAgICAgIGV4cGVjdChlcnJvckNhbGxiYWNrKS50b0hhdmVCZWVuQ2FsbGVkV2l0aChleHBlY3QuYW55KEVycm9yKSk7XG4gICAgfSk7XG5cbiAgICBpdCgnc2hvdWxkIGNhbGwgcmVjb25uZWN0IGNhbGxiYWNrcyBvbiByZWNvbm5lY3Rpb24nLCAoKSA9PiB7XG4gICAgICBjb25zdCByZWNvbm5lY3RDYWxsYmFjayA9IGplc3QuZm4oKTtcbiAgICAgIGNsaWVudC5vblJlY29ubmVjdChyZWNvbm5lY3RDYWxsYmFjayk7XG5cbiAgICAgIC8vIFRoaXMgd291bGQgYmUgY2FsbGVkIGR1cmluZyBhY3R1YWwgcmVjb25uZWN0aW9uXG4gICAgICAvLyBGb3IgdW5pdCB0ZXN0LCB3ZSBqdXN0IHZlcmlmeSB0aGUgY2FsbGJhY2sgaXMgcmVnaXN0ZXJlZFxuICAgICAgZXhwZWN0KHJlY29ubmVjdENhbGxiYWNrKS5ub3QudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnbWVzc2FnZSBoYW5kbGluZycsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIHBhcnNlIGFnZ3JlZ2F0ZSB0cmFkZSBtZXNzYWdlcyBjb3JyZWN0bHknLCAoKSA9PiB7XG4gICAgICBjb25zdCBjYWxsYmFjayA9IGplc3QuZm4oKTtcbiAgICAgIGNsaWVudC5zdWJzY3JpYmVBZ2dUcmFkZXMoJ0JUQ1VTRFQnLCBjYWxsYmFjayk7XG5cbiAgICAgIC8vIFNpbXVsYXRlIFdlYlNvY2tldCBtZXNzYWdlXG4gICAgICBjb25zdCBvbkNhbGwgPSBtb2NrV3Mub24ubW9jay5jYWxscy5maW5kKGNhbGwgPT4gY2FsbFswXSA9PT0gJ21lc3NhZ2UnKTtcbiAgICAgIGlmIChvbkNhbGwpIHtcbiAgICAgICAgY29uc3QgbWVzc2FnZUhhbmRsZXIgPSBvbkNhbGxbMV0gYXMgKGRhdGE6IGFueSkgPT4gdm9pZDtcbiAgICAgICAgY29uc3QgYWdnVHJhZGVNZXNzYWdlID0ge1xuICAgICAgICAgIGU6ICdhZ2dUcmFkZScsXG4gICAgICAgICAgRTogMTIzNDU2Nzg5MCxcbiAgICAgICAgICBzOiAnQlRDVVNEVCcsXG4gICAgICAgICAgYTogMTIzNDUsXG4gICAgICAgICAgcDogJzUwMDAwLjAwJyxcbiAgICAgICAgICBxOiAnMC4xJyxcbiAgICAgICAgICBmOiAxMDAsXG4gICAgICAgICAgbDogMjAwLFxuICAgICAgICAgIFQ6IDEyMzQ1Njc4OTAsXG4gICAgICAgICAgbTogZmFsc2UsIC8vIGJ1eWVyIGlzIG5vdCBtYXJrZXQgbWFrZXIgKEJVWSlcbiAgICAgICAgICBNOiB0cnVlXG4gICAgICAgIH07XG5cbiAgICAgICAgbWVzc2FnZUhhbmRsZXIoQnVmZmVyLmZyb20oSlNPTi5zdHJpbmdpZnkoYWdnVHJhZGVNZXNzYWdlKSkpO1xuICAgICAgfVxuXG4gICAgICBleHBlY3QoY2FsbGJhY2spLnRvSGF2ZUJlZW5DYWxsZWRXaXRoKHtcbiAgICAgICAgcHJpY2U6IDUwMDAwLFxuICAgICAgICBxdWFudGl0eTogMC4xLFxuICAgICAgICBzaWRlOiAnQlVZJyxcbiAgICAgICAgdGltZXN0YW1wOiAxMjM0NTY3ODkwXG4gICAgICB9KTtcbiAgICB9KTtcblxuICAgIGl0KCdzaG91bGQgaGFuZGxlIHNlbGwgdHJhZGVzIGNvcnJlY3RseScsICgpID0+IHtcbiAgICAgIGNvbnN0IGNhbGxiYWNrID0gamVzdC5mbigpO1xuICAgICAgY2xpZW50LnN1YnNjcmliZUFnZ1RyYWRlcygnQlRDVVNEVCcsIGNhbGxiYWNrKTtcblxuICAgICAgLy8gU2ltdWxhdGUgV2ViU29ja2V0IG1lc3NhZ2VcbiAgICAgIGNvbnN0IG9uQ2FsbCA9IG1vY2tXcy5vbi5tb2NrLmNhbGxzLmZpbmQoY2FsbCA9PiBjYWxsWzBdID09PSAnbWVzc2FnZScpO1xuICAgICAgaWYgKG9uQ2FsbCkge1xuICAgICAgICBjb25zdCBtZXNzYWdlSGFuZGxlciA9IG9uQ2FsbFsxXSBhcyAoZGF0YTogYW55KSA9PiB2b2lkO1xuICAgICAgICBjb25zdCBhZ2dUcmFkZU1lc3NhZ2UgPSB7XG4gICAgICAgICAgZTogJ2FnZ1RyYWRlJyxcbiAgICAgICAgICBFOiAxMjM0NTY3ODkwLFxuICAgICAgICAgIHM6ICdCVENVU0RUJyxcbiAgICAgICAgICBhOiAxMjM0NSxcbiAgICAgICAgICBwOiAnNDk5OTkuOTknLFxuICAgICAgICAgIHE6ICcwLjInLFxuICAgICAgICAgIGY6IDEwMCxcbiAgICAgICAgICBsOiAyMDAsXG4gICAgICAgICAgVDogMTIzNDU2Nzg5MCxcbiAgICAgICAgICBtOiB0cnVlLCAvLyBidXllciBpcyBtYXJrZXQgbWFrZXIgKFNFTEwpXG4gICAgICAgICAgTTogdHJ1ZVxuICAgICAgICB9O1xuXG4gICAgICAgIG1lc3NhZ2VIYW5kbGVyKEJ1ZmZlci5mcm9tKEpTT04uc3RyaW5naWZ5KGFnZ1RyYWRlTWVzc2FnZSkpKTtcbiAgICAgIH1cblxuICAgICAgZXhwZWN0KGNhbGxiYWNrKS50b0hhdmVCZWVuQ2FsbGVkV2l0aCh7XG4gICAgICAgIHByaWNlOiA0OTk5OS45OSxcbiAgICAgICAgcXVhbnRpdHk6IDAuMixcbiAgICAgICAgc2lkZTogJ1NFTEwnLFxuICAgICAgICB0aW1lc3RhbXA6IDEyMzQ1Njc4OTBcbiAgICAgIH0pO1xuICAgIH0pO1xuICB9KTtcblxuICBkZXNjcmliZSgnY2xlYW51cCcsICgpID0+IHtcbiAgICBpdCgnc2hvdWxkIGNsZWFudXAgcmVzb3VyY2VzIG9uIGNsb3NlJywgKCkgPT4ge1xuICAgICAgY29uc3QgY2FsbGJhY2sgPSBqZXN0LmZuKCk7XG4gICAgICBjbGllbnQuc3Vic2NyaWJlQWdnVHJhZGVzKCdCVENVU0RUJywgY2FsbGJhY2spO1xuICAgICAgXG4gICAgICBjbGllbnQuY2xvc2UoKTtcblxuICAgICAgZXhwZWN0KG1vY2tXcy5jbG9zZSkudG9IYXZlQmVlbkNhbGxlZCgpO1xuICAgICAgZXhwZWN0KGNsaWVudC5nZXRDb25uZWN0aW9uU3RhdHVzKCkpLnRvQmUoJ0NMT1NFRCcpO1xuICAgIH0pO1xuICB9KTtcbn0pOyJdLCJ2ZXJzaW9uIjozfQ==
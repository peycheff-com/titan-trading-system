{"file":"/Users/ivan/Code/trading/titan/services/titan-phase2-hunter/src/execution/LimitOrderExecutor.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-phase2-hunter/src/execution/LimitOrderExecutor.ts"],"sourcesContent":["/**\n * Limit Order Executor (The Sniper) for Titan Phase 2 - The Hunter\n * \n * Implements passive execution strategy using Post-Only Limit Orders at Order Blocks.\n * Designed for Bulgaria (200ms latency) - orders wait at pre-calculated levels.\n * \n * Key Features:\n * - Post-Only orders at Order Block top/bottom (earn Maker rebates)\n * - 60-second order timeout with price movement cancellation\n * - Volatility-Adjusted Position Sizing using ATR\n * - 3:1 Risk-Reward ratio (1.5% stop, 4.5% target)\n * - Smart cancellation logic (price moves >0.2%, level fails >0.5%)\n * \n * Requirements: 7.1-7.7 (Execution)\n */\n\nimport { EventEmitter } from 'events';\nimport { \n  OrderParams, \n  OrderResult, \n  OrderStatus, \n  SignalData, \n  ExecutionData,\n  OHLCV,\n  OrderBlock,\n  Position\n} from '../types';\nimport { BybitPerpsClient } from '../exchanges/BybitPerpsClient';\nimport { logExecution, logError } from '../logging/Logger';\n\nexport interface LimitOrderConfig {\n  orderTimeout: number; // Timeout in milliseconds (default: 60000)\n  priceMoveCancelThreshold: number; // Price move % to cancel (default: 0.002 = 0.2%)\n  levelFailThreshold: number; // Wick % to cancel (default: 0.005 = 0.5%)\n  stopLossPercent: number; // Stop loss % from entry (default: 0.015 = 1.5%)\n  takeProfitPercent: number; // Take profit % from entry (default: 0.045 = 4.5%)\n  atrPeriod: number; // ATR calculation period (default: 14)\n  maxRetries: number; // Maximum order retry attempts (default: 2)\n  retryDelay: number; // Delay between retries in ms (default: 1000)\n}\n\nexport interface ExecutionResult {\n  success: boolean;\n  orderId?: string;\n  fillPrice?: number;\n  positionSize?: number;\n  stopLoss?: number;\n  takeProfit?: number;\n  reason?: string;\n  error?: string;\n}\n\nexport interface OrderMonitoringState {\n  orderId: string;\n  symbol: string;\n  entryPrice: number;\n  orderBlock: OrderBlock;\n  startTime: number;\n  cancelled: boolean;\n  filled: boolean;\n  signalId?: string; // Optional signal ID for logging\n}\n\nexport interface LimitOrderExecutorEvents {\n  'order:placed': (orderId: string, symbol: string, price: number) => void;\n  'order:filled': (orderId: string, fillPrice: number, positionSize: number) => void;\n  'order:cancelled': (orderId: string, reason: string) => void;\n  'order:timeout': (orderId: string) => void;\n  'position:created': (position: Position) => void;\n  'execution:error': (error: Error, context: any) => void;\n}\n\nexport class LimitOrderExecutor extends EventEmitter {\n  private bybitClient: BybitPerpsClient;\n  private config: LimitOrderConfig;\n  private activeOrders: Map<string, OrderMonitoringState> = new Map();\n  private monitoringInterval: NodeJS.Timeout | null = null;\n  private readonly MONITORING_FREQUENCY = 1000; // 1 second\n\n  constructor(bybitClient: BybitPerpsClient, config?: Partial<LimitOrderConfig>) {\n    super();\n    \n    this.bybitClient = bybitClient;\n    this.config = {\n      orderTimeout: 60000, // 60 seconds\n      priceMoveCancelThreshold: 0.002, // 0.2%\n      levelFailThreshold: 0.005, // 0.5%\n      stopLossPercent: 0.015, // 1.5%\n      takeProfitPercent: 0.045, // 4.5%\n      atrPeriod: 14,\n      maxRetries: 2,\n      retryDelay: 1000,\n      ...config\n    };\n\n    // Start order monitoring\n    this.startMonitoring();\n  }\n\n  /**\n   * Place Post-Only Limit Order at Order Block top/bottom\n   * @param signal - Signal data with entry details\n   * @param orderBlock - Order Block for entry level\n   * @param equity - Current account equity for position sizing\n   * @returns Promise with execution result\n   */\n  public async placePostOnlyOrder(\n    signal: SignalData, \n    orderBlock: OrderBlock, \n    equity: number\n  ): Promise<ExecutionResult> {\n    try {\n      console.log(`üéØ Placing Post-Only order for ${signal.symbol} ${signal.direction}`);\n\n      // Calculate entry price at Order Block level\n      const entryPrice = signal.direction === 'LONG' \n        ? orderBlock.low  // Enter at OB bottom for longs\n        : orderBlock.high; // Enter at OB top for shorts\n\n      // Calculate position size using Volatility-Adjusted Sizing\n      const positionSize = await this.calcPositionSize(\n        signal.symbol, \n        entryPrice, \n        equity, \n        signal.leverage\n      );\n\n      if (positionSize <= 0) {\n        return {\n          success: false,\n          error: 'Position size calculation failed or too small'\n        };\n      }\n\n      // Calculate stop loss and take profit\n      const { stopLoss, takeProfit } = this.setStopAndTarget(entryPrice, signal.direction);\n\n      // Prepare order parameters\n      const orderParams: OrderParams = {\n        phase: 'phase2',\n        symbol: signal.symbol,\n        side: signal.direction === 'LONG' ? 'Buy' : 'Sell',\n        type: 'POST_ONLY',\n        price: entryPrice,\n        qty: positionSize,\n        leverage: signal.leverage,\n        stopLoss,\n        takeProfit\n      };\n\n      // Place order with retry logic\n      const orderResult = await this.bybitClient.placeOrderWithRetry(\n        orderParams, \n        this.config.maxRetries\n      );\n\n      if (orderResult.orderId) {\n        // Start monitoring the order\n        this.startOrderMonitoring(orderResult.orderId, signal.symbol, entryPrice, orderBlock, signal.timestamp.toString());\n        \n        this.emit('order:placed', orderResult.orderId, signal.symbol, entryPrice);\n        \n        console.log(`‚úÖ Post-Only order placed: ${signal.symbol} @ ${entryPrice} (ID: ${orderResult.orderId})`);\n        \n        return {\n          success: true,\n          orderId: orderResult.orderId,\n          positionSize,\n          stopLoss,\n          takeProfit\n        };\n      }\n\n      return {\n        success: false,\n        error: 'Order placement failed - no order ID returned'\n      };\n\n    } catch (error) {\n      const errorMsg = error instanceof Error ? error.message : 'Unknown error';\n      console.error(`‚ùå Failed to place Post-Only order for ${signal.symbol}:`, errorMsg);\n      \n      logError('ERROR', `Failed to place Post-Only order for ${signal.symbol}`, {\n        symbol: signal.symbol,\n        component: 'LimitOrderExecutor',\n        function: 'placePostOnlyOrder',\n        stack: (error as Error).stack,\n        data: { signal, orderBlock }\n      });\n      \n      this.emit('execution:error', error as Error, { signal, orderBlock });\n      \n      return {\n        success: false,\n        error: errorMsg\n      };\n    }\n  }\n\n  /**\n   * Monitor order with 60-second timeout\n   * @param orderId - Order ID to monitor\n   * @param symbol - Trading symbol\n   * @param entryPrice - Expected entry price\n   * @param orderBlock - Order Block reference\n   */\n  private startOrderMonitoring(\n    orderId: string, \n    symbol: string, \n    entryPrice: number, \n    orderBlock: OrderBlock,\n    signalId?: string\n  ): void {\n    const monitoringState: OrderMonitoringState = {\n      orderId,\n      symbol,\n      entryPrice,\n      orderBlock,\n      startTime: Date.now(),\n      cancelled: false,\n      filled: false,\n      signalId\n    };\n\n    this.activeOrders.set(orderId, monitoringState);\n    console.log(`üëÅÔ∏è Started monitoring order ${orderId} for ${symbol}`);\n  }\n\n  /**\n   * Monitor order and cancel if price moves away > 0.2%\n   * @param orderId - Order ID to monitor\n   * @param currentPrice - Current market price\n   * @returns Promise with cancellation result\n   */\n  public async cancelIfPriceMoves(orderId: string, currentPrice: number): Promise<boolean> {\n    const orderState = this.activeOrders.get(orderId);\n    if (!orderState || orderState.cancelled || orderState.filled) {\n      return false;\n    }\n\n    // Calculate price movement from entry level\n    const priceMove = Math.abs(currentPrice - orderState.entryPrice) / orderState.entryPrice;\n    \n    if (priceMove > this.config.priceMoveCancelThreshold) {\n      console.log(`üìâ Price moved ${(priceMove * 100).toFixed(2)}% away from ${orderState.symbol} order, cancelling`);\n      \n      try {\n        const success = await this.bybitClient.cancelOrder(orderId, orderState.symbol);\n        \n        if (success) {\n          orderState.cancelled = true;\n          this.activeOrders.set(orderId, orderState);\n          this.emit('order:cancelled', orderId, 'PRICE_MOVED_AWAY');\n          \n          console.log(`‚úÖ Order cancelled due to price movement: ${orderId}`);\n          return true;\n        }\n      } catch (error) {\n        console.error(`‚ùå Failed to cancel order ${orderId}:`, error);\n        this.emit('execution:error', error as Error, { orderId, reason: 'CANCEL_FAILED' });\n      }\n    }\n\n    return false;\n  }\n\n  /**\n   * Cancel order when price wicks through Order Block > 0.5%\n   * @param orderId - Order ID to monitor\n   * @param currentCandle - Current OHLCV candle\n   * @returns Promise with cancellation result\n   */\n  public async cancelIfLevelFails(orderId: string, currentCandle: OHLCV): Promise<boolean> {\n    const orderState = this.activeOrders.get(orderId);\n    if (!orderState || orderState.cancelled || orderState.filled) {\n      return false;\n    }\n\n    const orderBlock = orderState.orderBlock;\n    let wickThrough = false;\n    let wickPercent = 0;\n\n    if (orderBlock.type === 'BULLISH') {\n      // For bullish OB, check if price wicked below OB low\n      if (currentCandle.low < orderBlock.low) {\n        wickPercent = (orderBlock.low - currentCandle.low) / orderBlock.low;\n        wickThrough = wickPercent > this.config.levelFailThreshold;\n      }\n    } else {\n      // For bearish OB, check if price wicked above OB high\n      if (currentCandle.high > orderBlock.high) {\n        wickPercent = (currentCandle.high - orderBlock.high) / orderBlock.high;\n        wickThrough = wickPercent > this.config.levelFailThreshold;\n      }\n    }\n\n    if (wickThrough) {\n      console.log(`üí• Order Block level failed for ${orderState.symbol} (${(wickPercent * 100).toFixed(2)}% wick), cancelling`);\n      \n      try {\n        const success = await this.bybitClient.cancelOrder(orderId, orderState.symbol);\n        \n        if (success) {\n          orderState.cancelled = true;\n          this.activeOrders.set(orderId, orderState);\n          this.emit('order:cancelled', orderId, 'LEVEL_FAILED');\n          \n          console.log(`‚úÖ Order cancelled due to level failure: ${orderId}`);\n          return true;\n        }\n      } catch (error) {\n        console.error(`‚ùå Failed to cancel order ${orderId}:`, error);\n        this.emit('execution:error', error as Error, { orderId, reason: 'CANCEL_FAILED' });\n      }\n    }\n\n    return false;\n  }\n\n  /**\n   * Calculate position size using Volatility-Adjusted Sizing\n   * @param symbol - Trading symbol\n   * @param entryPrice - Entry price\n   * @param equity - Account equity\n   * @param leverage - Leverage multiplier\n   * @returns Promise with position size\n   */\n  public async calcPositionSize(\n    symbol: string, \n    entryPrice: number, \n    equity: number, \n    leverage: number\n  ): Promise<number> {\n    try {\n      // Fetch recent OHLCV data for ATR calculation\n      const candles = await this.bybitClient.fetchOHLCV(symbol, '1h', this.config.atrPeriod + 10);\n      \n      if (candles.length < this.config.atrPeriod) {\n        throw new Error(`Insufficient candle data for ATR calculation: ${candles.length} < ${this.config.atrPeriod}`);\n      }\n\n      // Calculate ATR (Average True Range)\n      const atr = this.calculateATR(candles, this.config.atrPeriod);\n      \n      // Risk amount (2% of equity by default)\n      const riskPercent = 0.02; // 2% risk per trade\n      const riskAmount = equity * riskPercent;\n      \n      // Stop distance in price terms\n      const stopDistance = entryPrice * this.config.stopLossPercent;\n      \n      // Volatility-Adjusted Sizing: Risk_Dollars / (ATR * Stop_Distance_Multiplier)\n      // Use ATR as volatility adjustment factor\n      const volatilityAdjustment = atr / entryPrice; // ATR as % of price\n      const adjustedStopDistance = stopDistance * (1 + volatilityAdjustment);\n      \n      // Calculate base position size\n      const basePositionSize = riskAmount / adjustedStopDistance;\n      \n      // Apply leverage (but cap at reasonable levels)\n      const maxLeverageMultiplier = Math.min(leverage, 5); // Cap at 5x for safety\n      const positionSize = basePositionSize * maxLeverageMultiplier;\n      \n      // Ensure minimum position size (0.001 for most symbols)\n      const minPositionSize = 0.001;\n      const finalPositionSize = Math.max(positionSize, minPositionSize);\n      \n      console.log(`üìä Position sizing for ${symbol}:`);\n      console.log(`   ATR: ${atr.toFixed(4)} (${(volatilityAdjustment * 100).toFixed(2)}%)`);\n      console.log(`   Risk Amount: $${riskAmount.toFixed(2)}`);\n      console.log(`   Stop Distance: ${stopDistance.toFixed(4)} (${(this.config.stopLossPercent * 100).toFixed(1)}%)`);\n      console.log(`   Position Size: ${finalPositionSize.toFixed(4)}`);\n      \n      return finalPositionSize;\n\n    } catch (error) {\n      console.error(`‚ùå Failed to calculate position size for ${symbol}:`, error);\n      throw new Error(`Position size calculation failed: ${error instanceof Error ? error.message : 'Unknown error'}`);\n    }\n  }\n\n  /**\n   * Set stop loss and take profit with 1.5% stop, 4.5% target (3:1 R:R)\n   * @param entryPrice - Entry price\n   * @param direction - Trade direction\n   * @returns Stop loss and take profit prices\n   */\n  public setStopAndTarget(entryPrice: number, direction: 'LONG' | 'SHORT'): {\n    stopLoss: number;\n    takeProfit: number;\n  } {\n    const stopDistance = entryPrice * this.config.stopLossPercent;\n    const targetDistance = entryPrice * this.config.takeProfitPercent;\n\n    let stopLoss: number;\n    let takeProfit: number;\n\n    if (direction === 'LONG') {\n      stopLoss = entryPrice - stopDistance;   // 1.5% below entry\n      takeProfit = entryPrice + targetDistance; // 4.5% above entry\n    } else {\n      stopLoss = entryPrice + stopDistance;   // 1.5% above entry\n      takeProfit = entryPrice - targetDistance; // 4.5% below entry\n    }\n\n    const riskReward = targetDistance / stopDistance;\n    \n    console.log(`üéØ Stop & Target for ${direction} @ ${entryPrice.toFixed(4)}:`);\n    console.log(`   Stop Loss: ${stopLoss.toFixed(4)} (-${(this.config.stopLossPercent * 100).toFixed(1)}%)`);\n    console.log(`   Take Profit: ${takeProfit.toFixed(4)} (+${(this.config.takeProfitPercent * 100).toFixed(1)}%)`);\n    console.log(`   Risk:Reward = 1:${riskReward.toFixed(1)}`);\n\n    return { stopLoss, takeProfit };\n  }\n\n  /**\n   * Calculate Average True Range (ATR)\n   * @param candles - OHLCV candle data\n   * @param period - ATR period (default: 14)\n   * @returns ATR value\n   */\n  private calculateATR(candles: OHLCV[], period: number): number {\n    if (candles.length < period + 1) {\n      throw new Error(`Insufficient data for ATR calculation: need ${period + 1}, got ${candles.length}`);\n    }\n\n    const trueRanges: number[] = [];\n\n    // Calculate True Range for each candle (starting from index 1)\n    for (let i = 1; i < candles.length; i++) {\n      const current = candles[i];\n      const previous = candles[i - 1];\n\n      // True Range = max(high-low, |high-prevClose|, |low-prevClose|)\n      const highLow = current.high - current.low;\n      const highPrevClose = Math.abs(current.high - previous.close);\n      const lowPrevClose = Math.abs(current.low - previous.close);\n\n      const trueRange = Math.max(highLow, highPrevClose, lowPrevClose);\n      trueRanges.push(trueRange);\n    }\n\n    // Calculate ATR as Simple Moving Average of True Ranges\n    const recentTrueRanges = trueRanges.slice(-period);\n    const atr = recentTrueRanges.reduce((sum, tr) => sum + tr, 0) / period;\n\n    return atr;\n  }\n\n  /**\n   * Start monitoring all active orders\n   */\n  private startMonitoring(): void {\n    if (this.monitoringInterval) {\n      clearInterval(this.monitoringInterval);\n    }\n\n    this.monitoringInterval = setInterval(async () => {\n      await this.monitorActiveOrders();\n    }, this.MONITORING_FREQUENCY);\n\n    console.log(`üëÅÔ∏è Limit Order Executor: Started monitoring (${this.MONITORING_FREQUENCY}ms interval)`);\n  }\n\n  /**\n   * Monitor all active orders for timeout, fills, and cancellation conditions\n   */\n  private async monitorActiveOrders(): Promise<void> {\n    const activeOrderIds = Array.from(this.activeOrders.keys());\n    \n    for (const orderId of activeOrderIds) {\n      const orderState = this.activeOrders.get(orderId);\n      if (!orderState || orderState.cancelled || orderState.filled) {\n        continue;\n      }\n\n      try {\n        // Check for timeout (60 seconds)\n        const elapsed = Date.now() - orderState.startTime;\n        if (elapsed > this.config.orderTimeout) {\n          await this.handleOrderTimeout(orderId);\n          continue;\n        }\n\n        // Check order status\n        const status = await this.bybitClient.getOrderStatus(orderId, orderState.symbol);\n        \n        if (status === 'FILLED') {\n          await this.handleOrderFilled(orderId);\n        } else if (status === 'CANCELLED') {\n          await this.handleOrderCancelled(orderId);\n        } else {\n          // Order still active, check cancellation conditions\n          await this.checkCancellationConditions(orderId);\n        }\n\n      } catch (error) {\n        console.error(`‚ùå Error monitoring order ${orderId}:`, error);\n        this.emit('execution:error', error as Error, { orderId, action: 'MONITORING' });\n      }\n    }\n  }\n\n  /**\n   * Handle order timeout (60 seconds)\n   * @param orderId - Order ID that timed out\n   */\n  private async handleOrderTimeout(orderId: string): Promise<void> {\n    const orderState = this.activeOrders.get(orderId);\n    if (!orderState) return;\n\n    console.log(`‚è∞ Order timeout for ${orderState.symbol}: ${orderId}`);\n\n    try {\n      // Cancel the timed-out order\n      await this.bybitClient.cancelOrder(orderId, orderState.symbol);\n      \n      orderState.cancelled = true;\n      this.activeOrders.set(orderId, orderState);\n      \n      this.emit('order:timeout', orderId);\n      this.emit('order:cancelled', orderId, 'TIMEOUT');\n      \n      console.log(`‚úÖ Timed-out order cancelled: ${orderId}`);\n      \n    } catch (error) {\n      console.error(`‚ùå Failed to cancel timed-out order ${orderId}:`, error);\n      this.emit('execution:error', error as Error, { orderId, reason: 'TIMEOUT_CANCEL_FAILED' });\n    }\n  }\n\n  /**\n   * Handle order filled\n   * @param orderId - Order ID that was filled\n   */\n  private async handleOrderFilled(orderId: string): Promise<void> {\n    const orderState = this.activeOrders.get(orderId);\n    if (!orderState) return;\n\n    console.log(`‚úÖ Order filled: ${orderState.symbol} @ ${orderState.entryPrice}`);\n\n    try {\n      // Get fill details (this would need to be implemented in BybitPerpsClient)\n      const fillPrice = orderState.entryPrice; // Simplified - should get actual fill price\n      \n      orderState.filled = true;\n      this.activeOrders.set(orderId, orderState);\n      \n      // Calculate position size (this should be stored from original order)\n      const positionSize = 0.1; // Simplified - should get actual fill quantity\n      \n      // Calculate slippage\n      const expectedPrice = orderState.entryPrice;\n      const slippage = Math.abs(fillPrice - expectedPrice) / expectedPrice;\n      \n      this.emit('order:filled', orderId, fillPrice, positionSize);\n      \n      // Log execution to structured logger\n      const orderResult: OrderResult = {\n        orderId,\n        symbol: orderState.symbol,\n        side: orderState.symbol.includes('LONG') ? 'Buy' : 'Sell',\n        qty: positionSize,\n        price: fillPrice,\n        status: 'FILLED',\n        timestamp: Date.now()\n      };\n      \n      logExecution(orderResult, slippage, orderState.signalId);\n      \n      // Create position object for position manager\n      const { stopLoss, takeProfit } = this.setStopAndTarget(\n        fillPrice, \n        orderState.symbol.includes('LONG') ? 'LONG' : 'SHORT' // Simplified direction detection\n      );\n\n      const position: Position = {\n        id: orderId,\n        symbol: orderState.symbol,\n        side: orderState.symbol.includes('LONG') ? 'LONG' : 'SHORT', // Simplified\n        entryPrice: fillPrice,\n        currentPrice: fillPrice,\n        quantity: positionSize,\n        leverage: 3, // Default leverage\n        stopLoss,\n        takeProfit,\n        unrealizedPnL: 0,\n        realizedPnL: 0,\n        entryTime: Date.now(),\n        status: 'OPEN',\n        rValue: 0,\n        atr: await this.getATRForSymbol(orderState.symbol)\n      };\n\n      this.emit('position:created', position);\n      \n      // Remove from active monitoring\n      this.activeOrders.delete(orderId);\n      \n    } catch (error) {\n      console.error(`‚ùå Error handling filled order ${orderId}:`, error);\n      this.emit('execution:error', error as Error, { orderId, reason: 'FILL_HANDLING_FAILED' });\n    }\n  }\n\n  /**\n   * Handle order cancelled\n   * @param orderId - Order ID that was cancelled\n   */\n  private async handleOrderCancelled(orderId: string): Promise<void> {\n    const orderState = this.activeOrders.get(orderId);\n    if (!orderState) return;\n\n    console.log(`‚ùå Order cancelled: ${orderState.symbol} (${orderId})`);\n\n    orderState.cancelled = true;\n    this.activeOrders.set(orderId, orderState);\n    \n    this.emit('order:cancelled', orderId, 'EXTERNAL_CANCEL');\n    \n    // Remove from active monitoring\n    this.activeOrders.delete(orderId);\n  }\n\n  /**\n   * Check cancellation conditions for active order\n   * @param orderId - Order ID to check\n   */\n  private async checkCancellationConditions(orderId: string): Promise<void> {\n    const orderState = this.activeOrders.get(orderId);\n    if (!orderState) return;\n\n    try {\n      // Get current price\n      const currentPrice = await this.bybitClient.getCurrentPrice(orderState.symbol);\n      \n      // Check if price moved away > 0.2%\n      await this.cancelIfPriceMoves(orderId, currentPrice);\n      \n      // Check if level failed (would need current candle data)\n      // This is simplified - in practice, you'd need real-time candle data\n      \n    } catch (error) {\n      console.error(`‚ùå Error checking cancellation conditions for ${orderId}:`, error);\n    }\n  }\n\n  /**\n   * Get ATR for symbol (helper method)\n   * @param symbol - Trading symbol\n   * @returns Promise with ATR value\n   */\n  private async getATRForSymbol(symbol: string): Promise<number> {\n    try {\n      const candles = await this.bybitClient.fetchOHLCV(symbol, '1h', this.config.atrPeriod + 10);\n      return this.calculateATR(candles, this.config.atrPeriod);\n    } catch (error) {\n      console.error(`‚ùå Failed to get ATR for ${symbol}:`, error);\n      return 0.001; // Default ATR\n    }\n  }\n\n  /**\n   * Get active orders count\n   * @returns Number of active orders\n   */\n  public getActiveOrdersCount(): number {\n    return this.activeOrders.size;\n  }\n\n  /**\n   * Get active orders\n   * @returns Array of active order states\n   */\n  public getActiveOrders(): OrderMonitoringState[] {\n    return Array.from(this.activeOrders.values());\n  }\n\n  /**\n   * Cancel all active orders\n   * @returns Promise with cancellation results\n   */\n  public async cancelAllOrders(): Promise<{ success: number; failed: number }> {\n    console.log(`üö® Cancelling all active orders`);\n    \n    const orderIds = Array.from(this.activeOrders.keys());\n    let success = 0;\n    let failed = 0;\n\n    for (const orderId of orderIds) {\n      const orderState = this.activeOrders.get(orderId);\n      if (!orderState) continue;\n\n      try {\n        const result = await this.bybitClient.cancelOrder(orderId, orderState.symbol);\n        if (result) {\n          success++;\n          orderState.cancelled = true;\n          this.activeOrders.set(orderId, orderState);\n          this.emit('order:cancelled', orderId, 'MANUAL_CANCEL_ALL');\n        } else {\n          failed++;\n        }\n      } catch (error) {\n        console.error(`‚ùå Failed to cancel order ${orderId}:`, error);\n        failed++;\n      }\n    }\n\n    console.log(`üö® Cancel all complete: ${success} success, ${failed} failed`);\n    return { success, failed };\n  }\n\n  /**\n   * Update configuration\n   * @param newConfig - New configuration\n   */\n  public updateConfig(newConfig: Partial<LimitOrderConfig>): void {\n    this.config = { ...this.config, ...newConfig };\n    console.log(`üéØ Limit Order Executor: Configuration updated`);\n  }\n\n  /**\n   * Stop monitoring and cleanup\n   */\n  public destroy(): void {\n    if (this.monitoringInterval) {\n      clearInterval(this.monitoringInterval);\n      this.monitoringInterval = null;\n    }\n    \n    this.activeOrders.clear();\n    this.removeAllListeners();\n    \n    console.log(`üéØ Limit Order Executor: Destroyed`);\n  }\n}\n\n// Export event interface for TypeScript\nexport declare interface LimitOrderExecutor {\n  on<U extends keyof LimitOrderExecutorEvents>(event: U, listener: LimitOrderExecutorEvents[U]): this;\n  emit<U extends keyof LimitOrderExecutorEvents>(event: U, ...args: Parameters<LimitOrderExecutorEvents[U]>): boolean;\n}"],"version":3}
d0dcbeb8fdea70f6bbc9e57f0cacfaab
"use strict";
/**
 * CVDValidator - Order Flow X-Ray (CVD Absorption Detection)
 *
 * Purpose: Confirm reversals by detecting limit order absorption
 *
 * Key Features:
 * - Calculate Cumulative Volume Delta from tick-level trades
 * - Detect CVD Absorption (price Lower Low, CVD Higher Low)
 * - Detect CVD Distribution (price Higher High, CVD Lower High)
 * - Validate POIs with CVD confirmation
 * - Maintain 10-minute trade history for analysis
 *
 * Requirements: 4.1-4.7 (Order Flow X-Ray)
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.CVDValidator = void 0;
class CVDValidator {
    tradeHistory = new Map();
    HISTORY_WINDOW_MS = 10 * 60 * 1000; // 10 minutes
    CVD_WINDOW_MS = 5 * 60 * 1000; // 5 minutes for CVD calculation
    /**
     * Calculate Cumulative Volume Delta for a symbol
     * CVD = Sum of (Buy Volume - Sell Volume) over time window
     *
     * @param trades - Array of trades for calculation
     * @param windowMs - Time window in milliseconds (default: 5 minutes)
     * @returns CVD value (positive = net buying, negative = net selling)
     */
    calcCVD(trades, windowMs = this.CVD_WINDOW_MS) {
        const cutoff = Date.now() - windowMs;
        const recentTrades = trades.filter(t => t.time > cutoff);
        let cvd = 0;
        for (const trade of recentTrades) {
            const volume = trade.qty * trade.price; // Dollar volume
            if (trade.isBuyerMaker) {
                // Buyer is maker = sell order hit buy limit = selling pressure
                cvd -= volume;
            }
            else {
                // Seller is maker = buy order hit sell limit = buying pressure
                cvd += volume;
            }
        }
        return cvd;
    }
    /**
     * Detect CVD Absorption pattern
     * Pattern: Price makes Lower Low but CVD makes Higher Low
     * Indicates: Limit buy orders absorbing market sells (bullish reversal signal)
     *
     * @param prices - Array of recent prices (at least 3 values)
     * @param cvdValues - Array of corresponding CVD values
     * @returns Absorption object if pattern detected, null otherwise
     */
    detectAbsorption(prices, cvdValues) {
        if (prices.length < 3 || cvdValues.length < 3) {
            return null;
        }
        // Get last 3 values for pattern detection
        const p1 = prices[prices.length - 3];
        const p2 = prices[prices.length - 2];
        const p3 = prices[prices.length - 1];
        const cvd1 = cvdValues[cvdValues.length - 3];
        const cvd2 = cvdValues[cvdValues.length - 2];
        const cvd3 = cvdValues[cvdValues.length - 1];
        // Check for price Lower Low pattern
        const priceLowerLow = p3 < p2 && p2 < p1;
        // Check for CVD Higher Low pattern
        const cvdHigherLow = cvd3 > cvd2 && cvd2 < cvd1;
        if (priceLowerLow && cvdHigherLow) {
            // Calculate absorption strength based on divergence magnitude
            const priceDrop = Math.abs((p1 - p3) / p1);
            const cvdRise = Math.abs((cvd3 - cvd2) / Math.max(Math.abs(cvd2), 1));
            const strength = Math.min(100, (priceDrop + cvdRise) * 50);
            console.log(`ðŸ” CVD Absorption detected: Price LL ${p3.toFixed(2)}, CVD HL ${cvd3.toFixed(0)}, Strength: ${strength.toFixed(1)}`);
            return {
                price: p3,
                cvdValue: cvd3,
                timestamp: Date.now(),
                confidence: strength
            };
        }
        return null;
    }
    /**
     * Detect CVD Distribution pattern
     * Pattern: Price makes Higher High but CVD makes Lower High
     * Indicates: Limit sell orders absorbing market buys (bearish reversal signal)
     *
     * @param prices - Array of recent prices (at least 3 values)
     * @param cvdValues - Array of corresponding CVD values
     * @returns Distribution object if pattern detected, null otherwise
     */
    detectDistribution(prices, cvdValues) {
        if (prices.length < 3 || cvdValues.length < 3) {
            return null;
        }
        // Get last 3 values for pattern detection
        const p1 = prices[prices.length - 3];
        const p2 = prices[prices.length - 2];
        const p3 = prices[prices.length - 1];
        const cvd1 = cvdValues[cvdValues.length - 3];
        const cvd2 = cvdValues[cvdValues.length - 2];
        const cvd3 = cvdValues[cvdValues.length - 1];
        // Check for price Higher High pattern
        const priceHigherHigh = p3 > p2 && p2 > p1;
        // Check for CVD Lower High pattern
        const cvdLowerHigh = cvd3 < cvd2 && cvd2 > cvd1;
        if (priceHigherHigh && cvdLowerHigh) {
            // Calculate distribution strength based on divergence magnitude
            const priceRise = Math.abs((p3 - p1) / p1);
            const cvdDrop = Math.abs((cvd2 - cvd3) / Math.max(Math.abs(cvd2), 1));
            const strength = Math.min(100, (priceRise + cvdDrop) * 50);
            console.log(`ðŸ” CVD Distribution detected: Price HH ${p3.toFixed(2)}, CVD LH ${cvd3.toFixed(0)}, Strength: ${strength.toFixed(1)}`);
            return {
                price: p3,
                cvdValue: cvd3,
                timestamp: Date.now(),
                confidence: strength
            };
        }
        return null;
    }
    /**
     * Validate POI with CVD confirmation
     * Adjusts POI confidence based on CVD absorption/distribution signals
     *
     * @param poi - Point of Interest to validate
     * @param absorption - Absorption signal (if any)
     * @param distribution - Distribution signal (if any)
     * @returns Confidence adjustment (-30 to +30)
     */
    validateWithCVD(poi, absorption = null, distribution = null) {
        let confidenceAdjustment = 0;
        // Check if POI type matches CVD signal
        if ('type' in poi) {
            // For Bullish POIs (Order Blocks, FVGs)
            if (poi.type === 'BULLISH') {
                if (absorption) {
                    // Bullish POI + CVD Absorption = Strong confirmation
                    confidenceAdjustment += 30;
                    console.log(`âœ… CVD validates Bullish POI: +30 confidence`);
                }
                else if (distribution) {
                    // Bullish POI + CVD Distribution = Conflicting signal
                    confidenceAdjustment -= 20;
                    console.log(`âŒ CVD conflicts with Bullish POI: -20 confidence`);
                }
            }
            // For Bearish POIs (Order Blocks, FVGs)
            if (poi.type === 'BEARISH') {
                if (distribution) {
                    // Bearish POI + CVD Distribution = Strong confirmation
                    confidenceAdjustment += 30;
                    console.log(`âœ… CVD validates Bearish POI: +30 confidence`);
                }
                else if (absorption) {
                    // Bearish POI + CVD Absorption = Conflicting signal
                    confidenceAdjustment -= 20;
                    console.log(`âŒ CVD conflicts with Bearish POI: -20 confidence`);
                }
            }
        }
        // For Liquidity Pools, any CVD divergence adds confidence
        if ('strength' in poi && (absorption || distribution)) {
            confidenceAdjustment += 15;
            console.log(`âœ… CVD confirms Liquidity Pool: +15 confidence`);
        }
        return confidenceAdjustment;
    }
    /**
     * Record a trade for CVD calculation
     * Maintains 10-minute rolling history per symbol
     *
     * @param trade - Trade data to record
     */
    recordTrade(trade) {
        if (!this.tradeHistory.has(trade.symbol)) {
            this.tradeHistory.set(trade.symbol, []);
        }
        const history = this.tradeHistory.get(trade.symbol);
        history.push(trade);
        // Keep only trades within the history window (10 minutes)
        const cutoff = Date.now() - this.HISTORY_WINDOW_MS;
        const filteredHistory = history.filter(t => t.time > cutoff);
        this.tradeHistory.set(trade.symbol, filteredHistory);
        // Log if history is getting large (performance monitoring)
        if (filteredHistory.length > 1000) {
            console.warn(`âš ï¸ Large trade history for ${trade.symbol}: ${filteredHistory.length} trades`);
        }
    }
    /**
     * Get trade history for a symbol
     *
     * @param symbol - Symbol to get history for
     * @param windowMs - Time window (default: full history window)
     * @returns Array of trades within the time window
     */
    getTradeHistory(symbol, windowMs = this.HISTORY_WINDOW_MS) {
        const history = this.tradeHistory.get(symbol) || [];
        const cutoff = Date.now() - windowMs;
        return history.filter(t => t.time > cutoff);
    }
    /**
     * Get current CVD value for a symbol
     *
     * @param symbol - Symbol to calculate CVD for
     * @param windowMs - Time window for calculation (default: 5 minutes)
     * @returns Current CVD value
     */
    getCurrentCVD(symbol, windowMs = this.CVD_WINDOW_MS) {
        const trades = this.getTradeHistory(symbol, windowMs);
        return this.calcCVD(trades, windowMs);
    }
    /**
     * Clear trade history for a symbol (cleanup)
     *
     * @param symbol - Symbol to clear history for
     */
    clearHistory(symbol) {
        this.tradeHistory.delete(symbol);
    }
    /**
     * Get statistics about trade history
     *
     * @returns Object with history statistics
     */
    getHistoryStats() {
        let totalTrades = 0;
        for (const history of this.tradeHistory.values()) {
            totalTrades += history.length;
        }
        const memoryUsage = `${(totalTrades * 64 / 1024).toFixed(1)} KB`; // Rough estimate
        return {
            totalSymbols: this.tradeHistory.size,
            totalTrades,
            memoryUsage
        };
    }
}
exports.CVDValidator = CVDValidator;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLXBoYXNlMi1odW50ZXIvc3JjL2VuZ2luZS9DVkRWYWxpZGF0b3IudHMiLCJtYXBwaW5ncyI6IjtBQUFBOzs7Ozs7Ozs7Ozs7O0dBYUc7OztBQVlILE1BQWEsWUFBWTtJQUNmLFlBQVksR0FBNEIsSUFBSSxHQUFHLEVBQUUsQ0FBQztJQUN6QyxpQkFBaUIsR0FBRyxFQUFFLEdBQUcsRUFBRSxHQUFHLElBQUksQ0FBQyxDQUFDLGFBQWE7SUFDakQsYUFBYSxHQUFHLENBQUMsR0FBRyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUMsZ0NBQWdDO0lBRWhGOzs7Ozs7O09BT0c7SUFDSCxPQUFPLENBQUMsTUFBa0IsRUFBRSxXQUFtQixJQUFJLENBQUMsYUFBYTtRQUMvRCxNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsR0FBRyxFQUFFLEdBQUcsUUFBUSxDQUFDO1FBQ3JDLE1BQU0sWUFBWSxHQUFHLE1BQU0sQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxDQUFDLENBQUMsSUFBSSxHQUFHLE1BQU0sQ0FBQyxDQUFDO1FBRXpELElBQUksR0FBRyxHQUFHLENBQUMsQ0FBQztRQUNaLEtBQUssTUFBTSxLQUFLLElBQUksWUFBWSxFQUFFLENBQUM7WUFDakMsTUFBTSxNQUFNLEdBQUcsS0FBSyxDQUFDLEdBQUcsR0FBRyxLQUFLLENBQUMsS0FBSyxDQUFDLENBQUMsZ0JBQWdCO1lBRXhELElBQUksS0FBSyxDQUFDLFlBQVksRUFBRSxDQUFDO2dCQUN2QiwrREFBK0Q7Z0JBQy9ELEdBQUcsSUFBSSxNQUFNLENBQUM7WUFDaEIsQ0FBQztpQkFBTSxDQUFDO2dCQUNOLCtEQUErRDtnQkFDL0QsR0FBRyxJQUFJLE1BQU0sQ0FBQztZQUNoQixDQUFDO1FBQ0gsQ0FBQztRQUVELE9BQU8sR0FBRyxDQUFDO0lBQ2IsQ0FBQztJQUVEOzs7Ozs7OztPQVFHO0lBQ0gsZ0JBQWdCLENBQUMsTUFBZ0IsRUFBRSxTQUFt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SUFDSixDQUFDO0NBQ0Y7QUFsUUQsb0NBa1FDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9pdmFuL0NvZGUvdHJhZGluZy90aXRhbi9zZXJ2aWNlcy90aXRhbi1waGFzZTItaHVudGVyL3NyYy9lbmdpbmUvQ1ZEVmFsaWRhdG9yLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ1ZEVmFsaWRhdG9yIC0gT3JkZXIgRmxvdyBYLVJheSAoQ1ZEIEFic29ycHRpb24gRGV0ZWN0aW9uKVxuICogXG4gKiBQdXJwb3NlOiBDb25maXJtIHJldmVyc2FscyBieSBkZXRlY3RpbmcgbGltaXQgb3JkZXIgYWJzb3JwdGlvblxuICogXG4gKiBLZXkgRmVhdHVyZXM6XG4gKiAtIENhbGN1bGF0ZSBDdW11bGF0aXZlIFZvbHVtZSBEZWx0YSBmcm9tIHRpY2stbGV2ZWwgdHJhZGVzXG4gKiAtIERldGVjdCBDVkQgQWJzb3JwdGlvbiAocHJpY2UgTG93ZXIgTG93LCBDVkQgSGlnaGVyIExvdylcbiAqIC0gRGV0ZWN0IENWRCBEaXN0cmlidXRpb24gKHByaWNlIEhpZ2hlciBIaWdoLCBDVkQgTG93ZXIgSGlnaClcbiAqIC0gVmFsaWRhdGUgUE9JcyB3aXRoIENWRCBjb25maXJtYXRpb25cbiAqIC0gTWFpbnRhaW4gMTAtbWludXRlIHRyYWRlIGhpc3RvcnkgZm9yIGFuYWx5c2lzXG4gKiBcbiAqIFJlcXVpcmVtZW50czogNC4xLTQuNyAoT3JkZXIgRmxvdyBYLVJheSlcbiAqL1xuXG5pbXBvcnQgeyBUcmFkZSwgQWJzb3JwdGlvbiwgRGlzdHJpYnV0aW9uLCBQT0kgfSBmcm9tICcuLi90eXBlcyc7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ1ZEVHJhZGUge1xuICBzeW1ib2w6IHN0cmluZztcbiAgcHJpY2U6IG51bWJlcjtcbiAgcXR5OiBudW1iZXI7XG4gIHRpbWU6IG51bWJlcjtcbiAgaXNCdXllck1ha2VyOiBib29sZWFuOyAvLyB0cnVlID0gc2VsbCBvcmRlciBoaXQgYnV5IGxpbWl0LCBmYWxzZSA9IGJ1eSBvcmRlciBoaXQgc2VsbCBsaW1pdFxufVxuXG5leHBvcnQgY2xhc3MgQ1ZEVmFsaWRhdG9yIHtcbiAgcHJpdmF0ZSB0cmFkZUhpc3Rvcnk6IE1hcDxzdHJpbmcsIENWRFRyYWRlW10+ID0gbmV3IE1hcCgpO1xuICBwcml2YXRlIHJlYWRvbmx5IEhJU1RPUllfV0lORE9XX01TID0gMTAgKiA2MCAqIDEwMDA7IC8vIDEwIG1pbnV0ZXNcbiAgcHJpdmF0ZSByZWFkb25seSBDVkRfV0lORE9XX01TID0gNSAqIDYwICogMTAwMDsgLy8gNSBtaW51dGVzIGZvciBDVkQgY2FsY3VsYXRpb25cblxuICAvKipcbiAgICogQ2FsY3VsYXRlIEN1bXVsYXRpdmUgVm9sdW1lIERlbHRhIGZvciBhIHN5bWJvbFxuICAgKiBDVkQgPSBTdW0gb2YgKEJ1eSBWb2x1bWUgLSBTZWxsIFZvbHVtZSkgb3ZlciB0aW1lIHdpbmRvd1xuICAgKiBcbiAgICogQHBhcmFtIHRyYWRlcyAtIEFycmF5IG9mIHRyYWRlcyBmb3IgY2FsY3VsYXRpb25cbiAgICogQHBhcmFtIHdpbmRvd01zIC0gVGltZSB3aW5kb3cgaW4gbWlsbGlzZWNvbmRzIChkZWZhdWx0OiA1IG1pbnV0ZXMpXG4gICAqIEByZXR1cm5zIENWRCB2YWx1ZSAocG9zaXRpdmUgPSBuZXQgYnV5aW5nLCBuZWdhdGl2ZSA9IG5ldCBzZWxsaW5nKVxuICAgKi9cbiAgY2FsY0NWRCh0cmFkZXM6IENWRFRyYWRlW10sIHdpbmRvd01zOiBudW1iZXIgPSB0aGlzLkNWRF9XSU5ET1dfTVMpOiBudW1iZXIge1xuICAgIGNvbnN0IGN1dG9mZiA9IERhdGUubm93KCkgLSB3aW5kb3dNcztcbiAgICBjb25zdCByZWNlbnRUcmFkZXMgPSB0cmFkZXMuZmlsdGVyKHQgPT4gdC50aW1lID4gY3V0b2ZmKTtcbiAgICBcbiAgICBsZXQgY3ZkID0gMDtcbiAgICBmb3IgKGNvbnN0IHRyYWRlIG9mIHJlY2VudFRyYWRlcykge1xuICAgICAgY29uc3Qgdm9sdW1lID0gdHJhZGUucXR5ICogdHJhZGUucHJpY2U7IC8vIERvbGxhciB2b2x1bWVcbiAgICAgIFxuICAgICAgaWYgKHRyYWRlLmlzQnV5ZXJNYWtlcikge1xuICAgICAgICAvLyBCdXllciBpcyBtYWtlciA9IHNlbGwgb3JkZXIgaGl0IGJ1eSBsaW1pdCA9IHNlbGxpbmcgcHJlc3N1cmVcbiAgICAgICAgY3ZkIC09IHZvbHVtZTtcbiAgICAgIH0gZWxzZSB7XG4gICAgICAgIC8vIFNlbGxlciBpcyBtYWtlciA9IGJ1eSBvcmRlciBoaXQgc2VsbCBsaW1pdCA9IGJ1eWluZyBwcmVzc3VyZVxuICAgICAgICBjdmQgKz0gdm9sdW1lO1xuICAgICAgfVxuICAgIH1cbiAgICBcbiAgICByZXR1cm4gY3ZkO1xuICB9XG5cbiAgLyoqXG4gICAqIERldGVjdCBDVkQgQWJzb3JwdGlvbiBwYXR0ZXJuXG4gICAqIFBhdHRlcm46IFByaWNlIG1ha2VzIExvd2VyIExvdyBidXQgQ1ZEIG1ha2VzIEhpZ2hlciBMb3dcbiAgICogSW5kaWNhdGVzOiBMaW1pdCBidXkgb3JkZXJzIGFic29yYmluZyBtYXJrZXQgc2VsbHMgKGJ1bGxpc2ggcmV2ZXJzYWwgc2lnbmFsKVxuICAgKiBcbiAgICogQHBhcmFtIHByaWNlcyAtIEFycmF5IG9mIHJlY2VudCBwcmljZXMgKGF0IGxlYXN0IDMgdmFsdWVzKVxuICAgKiBAcGFyYW0gY3ZkVmFsdWVzIC0gQXJyYXkgb2YgY29ycmVzcG9uZGluZyBDVkQgdmFsdWVzXG4gICAqIEByZXR1cm5zIEFic29ycHRpb24gb2JqZWN0IGlmIHBhdHRlcm4gZGV0ZWN0ZWQsIG51bGwgb3RoZXJ3aXNlXG4gICAqL1xuICBkZXRlY3RBYnNvcnB0aW9uKHByaWNlczogbnVtYmVyW10sIGN2ZFZhbHVlczogbnVtYmVyW10pOiBBYnNvcnB0aW9uIHwgbnVsbCB7XG4gICAgaWYgKHByaWNlcy5sZW5ndGggPCAzIHx8IGN2ZFZhbHVlcy5sZW5ndGggPCAzKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG5cbiAgICAvLyBHZXQgbGFzdCAzIHZhbHVlcyBmb3IgcGF0dGVybiBkZXRlY3Rpb25cbiAgICBjb25zdCBwMSA9IHByaWNlc1twcmljZXMubGVuZ3RoIC0gM107XG4gICAgY29uc3QgcDIgPSBwcmljZXNbcHJpY2VzLmxlbmd0aCAtIDJdO1xuICAgIGNvbnN0IHAzID0gcHJpY2VzW3ByaWNlcy5sZW5ndGggLSAxXTtcbiAgICBcbiAgICBjb25zdCBjdmQxID0gY3ZkVmFsdWVzW2N2ZFZhbHVlcy5sZW5ndGggLSAzXTtcbiAgICBjb25zdCBjdmQyID0gY3ZkVmFsdWVzW2N2ZFZhbHVlcy5sZW5ndGggLSAyXTtcbiAgICBjb25zdCBjdmQzID0gY3ZkVmFsdWVzW2N2ZFZhbHVlcy5sZW5ndGggLSAxXTtcbiAgICBcbiAgICAvLyBDaGVjayBmb3IgcHJpY2UgTG93ZXIgTG93IHBhdHRlcm5cbiAgICBjb25zdCBwcmljZUxvd2VyTG93ID0gcDMgPCBwMiAmJiBwMiA8IHAxO1xuICAgIFxuICAgIC8vIENoZWNrIGZvciBDVkQgSGlnaGVyIExvdyBwYXR0ZXJuXG4gICAgY29uc3QgY3ZkSGlnaGVyTG93ID0gY3ZkMyA+IGN2ZDIgJiYgY3ZkMiA8IGN2ZDE7XG4gICAgXG4gICAgaWYgKHByaWNlTG93ZXJMb3cgJiYgY3ZkSGlnaGVyTG93KSB7XG4gICAgICAvLyBDYWxjdWxhdGUgYWJzb3JwdGlvbiBzdHJlbmd0aCBiYXNlZCBvbiBkaXZlcmdlbmNlIG1hZ25pdHVkZVxuICAgICAgY29uc3QgcHJpY2VEcm9wID0gTWF0aC5hYnMoKHAxIC0gcDMpIC8gcDEpO1xuICAgICAgY29uc3QgY3ZkUmlzZSA9IE1hdGguYWJzKChjdmQzIC0gY3ZkMikgLyBNYXRoLm1heChNYXRoLmFicyhjdmQyKSwgMSkpO1xuICAgICAgY29uc3Qgc3RyZW5ndGggPSBNYXRoLm1pbigxMDAsIChwcmljZURyb3AgKyBjdmRSaXNlKSAqIDUwKTtcbiAgICAgIFxuICAgICAgY29uc29sZS5sb2coYPCflI0gQ1ZEIEFic29ycHRpb24gZGV0ZWN0ZWQ6IFByaWNlIExMICR7cDMudG9GaXhlZCgyKX0sIENWRCBITCAke2N2ZDMudG9GaXhlZCgwKX0sIFN0cmVuZ3RoOiAke3N0cmVuZ3RoLnRvRml4ZWQoMSl9YCk7XG4gICAgICBcbiAgICAgIHJldHVybiB7XG4gICAgICAgIHByaWNlOiBwMyxcbiAgICAgICAgY3ZkVmFsdWU6IGN2ZDMsXG4gICAgICAgIHRpbWVzdGFtcDogRGF0ZS5ub3coKSxcbiAgICAgICAgY29uZmlkZW5jZTogc3RyZW5ndGhcbiAgICAgIH07XG4gICAgfVxuICAgIFxuICAgIHJldHVybiBudWxsO1xuICB9XG5cbiAgLyoqXG4gICAqIERldGVjdCBDVkQgRGlzdHJpYnV0aW9uIHBhdHRlcm5cbiAgICogUGF0dGVybjogUHJpY2UgbWFrZXMgSGlnaGVyIEhpZ2ggYnV0IENWRCBtYWtlcyBMb3dlciBIaWdoXG4gICAqIEluZGljYXRlczogTGltaXQgc2VsbCBvcmRlcnMgYWJzb3JiaW5nIG1hcmtldCBidXlzIChiZWFyaXNoIHJldmVyc2FsIHNpZ25hbClcbiAgICogXG4gICAqIEBwYXJhbSBwcmljZXMgLSBBcnJheSBvZiByZWNlbnQgcHJpY2VzIChhdCBsZWFzdCAzIHZhbHVlcylcbiAgICogQHBhcmFtIGN2ZFZhbHVlcyAtIEFycmF5IG9mIGNvcnJlc3BvbmRpbmcgQ1ZEIHZhbHVlc1xuICAgKiBAcmV0dXJucyBEaXN0cmlidXRpb24gb2JqZWN0IGlmIHBhdHRlcm4gZGV0ZWN0ZWQsIG51bGwgb3RoZXJ3aXNlXG4gICAqL1xuICBkZXRlY3REaXN0cmlidXRpb24ocHJpY2VzOiBudW1iZXJbXSwgY3ZkVmFsdWVzOiBudW1iZXJbXSk6IERpc3RyaWJ1dGlvbiB8IG51bGwge1xuICAgIGlmIChwcmljZXMubGVuZ3RoIDwgMyB8fCBjdmRWYWx1ZXMubGVuZ3RoIDwgMykge1xuICAgICAgcmV0dXJuIG51bGw7XG4gICAgfVxuXG4gICAgLy8gR2V0IGxhc3QgMyB2YWx1ZXMgZm9yIHBhdHRlcm4gZGV0ZWN0aW9uXG4gICAgY29uc3QgcDEgPSBwcmljZXNbcHJpY2VzLmxlbmd0aCAtIDNdO1xuICAgIGNvbnN0IHAyID0gcHJpY2VzW3ByaWNlcy5sZW5ndGggLSAyXTtcbiAgICBjb25zdCBwMyA9IHByaWNlc1twcmljZXMubGVuZ3RoIC0gMV07XG4gICAgXG4gICAgY29uc3QgY3ZkMSA9IGN2ZFZhbHVlc1tjdmRWYWx1ZXMubGVuZ3RoIC0gM107XG4gICAgY29uc3QgY3ZkMiA9IGN2ZFZhbHVlc1tjdmRWYWx1ZXMubGVuZ3RoIC0gMl07XG4gICAgY29uc3QgY3ZkMyA9IGN2ZFZhbHVlc1tjdmRWYWx1ZXMubGVuZ3RoIC0gMV07XG4gICAgXG4gICAgLy8gQ2hlY2sgZm9yIHByaWNlIEhpZ2hlciBIaWdoIHBhdHRlcm5cbiAgICBjb25zdCBwcmljZUhpZ2hlckhpZ2ggPSBwMyA+IHAyICYmIHAyID4gcDE7XG4gICAgXG4gICAgLy8gQ2hlY2sgZm9yIENWRCBMb3dlciBIaWdoIHBhdHRlcm5cbiAgICBjb25zdCBjdmRMb3dlckhpZ2ggPSBjdmQzIDwgY3ZkMiAmJiBjdmQyID4gY3ZkMTtcbiAgICBcbiAgICBpZiAocHJpY2VIaWdoZXJIaWdoICYmIGN2ZExvd2VySGlnaCkge1xuICAgICAgLy8gQ2FsY3VsYXRlIGRpc3RyaWJ1dGlvbiBzdHJlbmd0aCBiYXNlZCBvbiBkaXZlcmdlbmNlIG1hZ25pdHVkZVxuICAgICAgY29uc3QgcHJpY2VSaXNlID0gTWF0aC5hYnMoKHAzIC0gcDEpIC8gcDEpO1xuICAgICAgY29uc3QgY3ZkRHJvcCA9IE1hdGguYWJzKChjdmQyIC0gY3ZkMykgLyBNYXRoLm1heChNYXRoLmFicyhjdmQyKSwgMSkpO1xuICAgICAgY29uc3Qgc3RyZW5ndGggPSBNYXRoLm1pbigxMDAsIChwcmljZVJpc2UgKyBjdmREcm9wKSAqIDUwKTtcbiAgICAgIFxuICAgICAgY29uc29sZS5sb2coYPCflI0gQ1ZEIERpc3RyaWJ1dGlvbiBkZXRlY3RlZDogUHJpY2UgSEggJHtwMy50b0ZpeGVkKDIpfSwgQ1ZEIExIICR7Y3ZkMy50b0ZpeGVkKDApfSwgU3RyZW5ndGg6ICR7c3RyZW5ndGgudG9GaXhlZCgxKX1gKTtcbiAgICAgIFxuICAgICAgcmV0dXJuIHtcbiAgICAgICAgcHJpY2U6IHAzLFxuICAgICAgICBjdmRWYWx1ZTogY3ZkMyxcbiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpLFxuICAgICAgICBjb25maWRlbmNlOiBzdHJlbmd0aFxuICAgICAgfTtcbiAgICB9XG4gICAgXG4gICAgcmV0dXJuIG51bGw7XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGUgUE9JIHdpdGggQ1ZEIGNvbmZpcm1hdGlvblxuICAgKiBBZGp1c3RzIFBPSSBjb25maWRlbmNlIGJhc2VkIG9uIENWRCBhYnNvcnB0aW9uL2Rpc3RyaWJ1dGlvbiBzaWduYWxzXG4gICAqIFxuICAgKiBAcGFyYW0gcG9pIC0gUG9pbnQgb2YgSW50ZXJlc3QgdG8gdmFsaWRhdGVcbiAgICogQHBhcmFtIGFic29ycHRpb24gLSBBYnNvcnB0aW9uIHNpZ25hbCAoaWYgYW55KVxuICAgKiBAcGFyYW0gZGlzdHJpYnV0aW9uIC0gRGlzdHJpYnV0aW9uIHNpZ25hbCAoaWYgYW55KVxuICAgKiBAcmV0dXJucyBDb25maWRlbmNlIGFkanVzdG1lbnQgKC0zMCB0byArMzApXG4gICAqL1xuICB2YWxpZGF0ZVdpdGhDVkQocG9pOiBQT0ksIGFic29ycHRpb246IEFic29ycHRpb24gfCBudWxsID0gbnVsbCwgZGlzdHJpYnV0aW9uOiBEaXN0cmlidXRpb24gfCBudWxsID0gbnVsbCk6IG51bWJlciB7XG4gICAgbGV0IGNvbmZpZGVuY2VBZGp1c3RtZW50ID0gMDtcblxuICAgIC8vIENoZWNrIGlmIFBPSSB0eXBlIG1hdGNoZXMgQ1ZEIHNpZ25hbFxuICAgIGlmICgndHlwZScgaW4gcG9pKSB7XG4gICAgICAvLyBGb3IgQnVsbGlzaCBQT0lzIChPcmRlciBCbG9ja3MsIEZWR3MpXG4gICAgICBpZiAocG9pLnR5cGUgPT09ICdCVUxMSVNIJykge1xuICAgICAgICBpZiAoYWJzb3JwdGlvbikge1xuICAgICAgICAgIC8vIEJ1bGxpc2ggUE9JICsgQ1ZEIEFic29ycHRpb24gPSBTdHJvbmcgY29uZmlybWF0aW9uXG4gICAgICAgICAgY29uZmlkZW5jZUFkanVzdG1lbnQgKz0gMzA7XG4gICAgICAgICAgY29uc29sZS5sb2coYOKchSBDVkQgdmFsaWRhdGVzIEJ1bGxpc2ggUE9JOiArMzAgY29uZmlkZW5jZWApO1xuICAgICAgICB9IGVsc2UgaWYgKGRpc3RyaWJ1dGlvbikge1xuICAgICAgICAgIC8vIEJ1bGxpc2ggUE9JICsgQ1ZEIERpc3RyaWJ1dGlvbiA9IENvbmZsaWN0aW5nIHNpZ25hbFxuICAgICAgICAgIGNvbmZpZGVuY2VBZGp1c3RtZW50IC09IDIwO1xuICAgICAgICAgIGNvbnNvbGUubG9nKGDinYwgQ1ZEIGNvbmZsaWN0cyB3aXRoIEJ1bGxpc2ggUE9JOiAtMjAgY29uZmlkZW5jZWApO1xuICAgICAgICB9XG4gICAgICB9XG4gICAgICBcbiAgICAgIC8vIEZvciBCZWFyaXNoIFBPSXMgKE9yZGVyIEJsb2NrcywgRlZHcylcbiAgICAgIGlmIChwb2kudHlwZSA9PT0gJ0JFQVJJU0gnKSB7XG4gICAgICAgIGlmIChkaXN0cmlidXRpb24pIHtcbiAgICAgICAgICAvLyBCZWFyaXNoIFBPSSArIENWRCBEaXN0cmlidXRpb24gPSBTdHJvbmcgY29uZmlybWF0aW9uXG4gICAgICAgICAgY29uZmlkZW5jZUFkanVzdG1lbnQgKz0gMzA7XG4gICAgICAgICAgY29uc29sZS5sb2coYOKchSBDVkQgdmFsaWRhdGVzIEJlYXJpc2ggUE9JOiArMzAgY29uZmlkZW5jZWApO1xuICAgICAgICB9IGVsc2UgaWYgKGFic29ycHRpb24pIHtcbiAgICAgICAgICAvLyBCZWFyaXNoIFBPSSArIENWRCBBYnNvcnB0aW9uID0gQ29uZmxpY3Rpbmcgc2lnbmFsXG4gICAgICAgICAgY29uZmlkZW5jZUFkanVzdG1lbnQgLT0gMjA7XG4gICAgICAgICAgY29uc29sZS5sb2coYOKdjCBDVkQgY29uZmxpY3RzIHdpdGggQmVhcmlzaCBQT0k6IC0yMCBjb25maWRlbmNlYCk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBGb3IgTGlxdWlkaXR5IFBvb2xzLCBhbnkgQ1ZEIGRpdmVyZ2VuY2UgYWRkcyBjb25maWRlbmNlXG4gICAgaWYgKCdzdHJlbmd0aCcgaW4gcG9pICYmIChhYnNvcnB0aW9uIHx8IGRpc3RyaWJ1dGlvbikpIHtcbiAgICAgIGNvbmZpZGVuY2VBZGp1c3RtZW50ICs9IDE1O1xuICAgICAgY29uc29sZS5sb2coYOKchSBDVkQgY29uZmlybXMgTGlxdWlkaXR5IFBvb2w6ICsxNSBjb25maWRlbmNlYCk7XG4gICAgfVxuXG4gICAgcmV0dXJuIGNvbmZpZGVuY2VBZGp1c3RtZW50O1xuICB9XG5cbiAgLyoqXG4gICAqIFJlY29yZCBhIHRyYWRlIGZvciBDVkQgY2FsY3VsYXRpb25cbiAgICogTWFpbnRhaW5zIDEwLW1pbnV0ZSByb2xsaW5nIGhpc3RvcnkgcGVyIHN5bWJvbFxuICAgKiBcbiAgICogQHBhcmFtIHRyYWRlIC0gVHJhZGUgZGF0YSB0byByZWNvcmRcbiAgICovXG4gIHJlY29yZFRyYWRlKHRyYWRlOiBDVkRUcmFkZSk6IHZvaWQge1xuICAgIGlmICghdGhpcy50cmFkZUhpc3RvcnkuaGFzKHRyYWRlLnN5bWJvbCkpIHtcbiAgICAgIHRoaXMudHJhZGVIaXN0b3J5LnNldCh0cmFkZS5zeW1ib2wsIFtdKTtcbiAgICB9XG4gICAgXG4gICAgY29uc3QgaGlzdG9yeSA9IHRoaXMudHJhZGVIaXN0b3J5LmdldCh0cmFkZS5zeW1ib2wpITtcbiAgICBoaXN0b3J5LnB1c2godHJhZGUpO1xuICAgIFxuICAgIC8vIEtlZXAgb25seSB0cmFkZXMgd2l0aGluIHRoZSBoaXN0b3J5IHdpbmRvdyAoMTAgbWludXRlcylcbiAgICBjb25zdCBjdXRvZmYgPSBEYXRlLm5vdygpIC0gdGhpcy5ISVNUT1JZX1dJTkRPV19NUztcbiAgICBjb25zdCBmaWx0ZXJlZEhpc3RvcnkgPSBoaXN0b3J5LmZpbHRlcih0ID0+IHQudGltZSA+IGN1dG9mZik7XG4gICAgXG4gICAgdGhpcy50cmFkZUhpc3Rvcnkuc2V0KHRyYWRlLnN5bWJvbCwgZmlsdGVyZWRIaXN0b3J5KTtcbiAgICBcbiAgICAvLyBMb2cgaWYgaGlzdG9yeSBpcyBnZXR0aW5nIGxhcmdlIChwZXJmb3JtYW5jZSBtb25pdG9yaW5nKVxuICAgIGlmIChmaWx0ZXJlZEhpc3RvcnkubGVuZ3RoID4gMTAwMCkge1xuICAgICAgY29uc29sZS53YXJuKGDimqDvuI8gTGFyZ2UgdHJhZGUgaGlzdG9yeSBmb3IgJHt0cmFkZS5zeW1ib2x9OiAke2ZpbHRlcmVkSGlzdG9yeS5sZW5ndGh9IHRyYWRlc2ApO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdHJhZGUgaGlzdG9yeSBmb3IgYSBzeW1ib2xcbiAgICogXG4gICAqIEBwYXJhbSBzeW1ib2wgLSBTeW1ib2wgdG8gZ2V0IGhpc3RvcnkgZm9yXG4gICAqIEBwYXJhbSB3aW5kb3dNcyAtIFRpbWUgd2luZG93IChkZWZhdWx0OiBmdWxsIGhpc3Rvcnkgd2luZG93KVxuICAgKiBAcmV0dXJucyBBcnJheSBvZiB0cmFkZXMgd2l0aGluIHRoZSB0aW1lIHdpbmRvd1xuICAgKi9cbiAgZ2V0VHJhZGVIaXN0b3J5KHN5bWJvbDogc3RyaW5nLCB3aW5kb3dNczogbnVtYmVyID0gdGhpcy5ISVNUT1JZX1dJTkRPV19NUyk6IENWRFRyYWRlW10ge1xuICAgIGNvbnN0IGhpc3RvcnkgPSB0aGlzLnRyYWRlSGlzdG9yeS5nZXQoc3ltYm9sKSB8fCBbXTtcbiAgICBjb25zdCBjdXRvZmYgPSBEYXRlLm5vdygpIC0gd2luZG93TXM7XG4gICAgcmV0dXJuIGhpc3RvcnkuZmlsdGVyKHQgPT4gdC50aW1lID4gY3V0b2ZmKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY3VycmVudCBDVkQgdmFsdWUgZm9yIGEgc3ltYm9sXG4gICAqIFxuICAgKiBAcGFyYW0gc3ltYm9sIC0gU3ltYm9sIHRvIGNhbGN1bGF0ZSBDVkQgZm9yXG4gICAqIEBwYXJhbSB3aW5kb3dNcyAtIFRpbWUgd2luZG93IGZvciBjYWxjdWxhdGlvbiAoZGVmYXVsdDogNSBtaW51dGVzKVxuICAgKiBAcmV0dXJucyBDdXJyZW50IENWRCB2YWx1ZVxuICAgKi9cbiAgZ2V0Q3VycmVudENWRChzeW1ib2w6IHN0cmluZywgd2luZG93TXM6IG51bWJlciA9IHRoaXMuQ1ZEX1dJTkRPV19NUyk6IG51bWJlciB7XG4gICAgY29uc3QgdHJhZGVzID0gdGhpcy5nZXRUcmFkZUhpc3Rvcnkoc3ltYm9sLCB3aW5kb3dNcyk7XG4gICAgcmV0dXJuIHRoaXMuY2FsY0NWRCh0cmFkZXMsIHdpbmRvd01zKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDbGVhciB0cmFkZSBoaXN0b3J5IGZvciBhIHN5bWJvbCAoY2xlYW51cClcbiAgICogXG4gICAqIEBwYXJhbSBzeW1ib2wgLSBTeW1ib2wgdG8gY2xlYXIgaGlzdG9yeSBmb3JcbiAgICovXG4gIGNsZWFySGlzdG9yeShzeW1ib2w6IHN0cmluZyk6IHZvaWQge1xuICAgIHRoaXMudHJhZGVIaXN0b3J5LmRlbGV0ZShzeW1ib2wpO1xuICB9XG5cbiAgLyoqXG4gICAqIEdldCBzdGF0aXN0aWNzIGFib3V0IHRyYWRlIGhpc3RvcnlcbiAgICogXG4gICAqIEByZXR1cm5zIE9iamVjdCB3aXRoIGhpc3Rvcnkgc3RhdGlzdGljc1xuICAgKi9cbiAgZ2V0SGlzdG9yeVN0YXRzKCk6IHsgdG90YWxTeW1ib2xzOiBudW1iZXI7IHRvdGFsVHJhZGVzOiBudW1iZXI7IG1lbW9yeVVzYWdlOiBzdHJpbmcgfSB7XG4gICAgbGV0IHRvdGFsVHJhZGVzID0gMDtcbiAgICBmb3IgKGNvbnN0IGhpc3Rvcnkgb2YgdGhpcy50cmFkZUhpc3RvcnkudmFsdWVzKCkpIHtcbiAgICAgIHRvdGFsVHJhZGVzICs9IGhpc3RvcnkubGVuZ3RoO1xuICAgIH1cbiAgICBcbiAgICBjb25zdCBtZW1vcnlVc2FnZSA9IGAkeyh0b3RhbFRyYWRlcyAqIDY0IC8gMTAyNCkudG9GaXhlZCgxKX0gS0JgOyAvLyBSb3VnaCBlc3RpbWF0ZVxuICAgIFxuICAgIHJldHVybiB7XG4gICAgICB0b3RhbFN5bWJvbHM6IHRoaXMudHJhZGVIaXN0b3J5LnNpemUsXG4gICAgICB0b3RhbFRyYWRlcyxcbiAgICAgIG1lbW9yeVVzYWdlXG4gICAgfTtcbiAgfVxufSJdLCJ2ZXJzaW9uIjozfQ==
c2d1d78f30b8874059541f3bd5aa68b8
"use strict";
/**
 * Binance Spot Client for CVD Data Source
 *
 * Provides tick-level trade data via WebSocket for Cumulative Volume Delta calculation.
 * Includes reconnection logic and callback system for trade events.
 *
 * Requirements: 4.1 (CVD Monitoring)
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.BinanceSpotClient = void 0;
const WebSocket = require("ws");
// Use require for node-fetch to avoid ES modules issues in Jest
const fetch = require('node-fetch');
class BinanceSpotClient {
    ws = null;
    baseUrl = 'https://api.binance.com';
    wsUrl = 'wss://stream.binance.com:9443/ws';
    subscriptions = new Map();
    reconnectAttempts = 0;
    maxReconnectAttempts = 3;
    reconnectDelay = 2000; // 2 seconds
    isReconnecting = false;
    heartbeatInterval = null;
    lastPongTime = 0;
    // Callbacks
    errorCallbacks = new Set();
    reconnectCallbacks = new Set();
    constructor() {
        this.setupHeartbeat();
    }
    /**
     * Subscribe to aggregate trades for a symbol
     * @param symbol - Trading symbol (e.g., 'BTCUSDT')
     * @param callback - Callback function for trade events
     */
    subscribeAggTrades(symbol, callback) {
        const normalizedSymbol = symbol.toLowerCase();
        // Add callback to subscriptions
        if (!this.subscriptions.has(normalizedSymbol)) {
            this.subscriptions.set(normalizedSymbol, new Set());
        }
        this.subscriptions.get(normalizedSymbol).add(callback);
        // Connect WebSocket if not already connected
        if (!this.ws || this.ws.readyState !== WebSocket.OPEN) {
            this.connect();
        }
        else {
            // Subscribe to the stream if WebSocket is already open
            this.subscribeToStream(normalizedSymbol);
        }
    }
    /**
     * Unsubscribe from aggregate trades for a symbol
     * @param symbol - Trading symbol
     * @param callback - Callback function to remove
     */
    unsubscribeAggTrades(symbol, callback) {
        const normalizedSymbol = symbol.toLowerCase();
        const callbacks = this.subscriptions.get(normalizedSymbol);
        if (callbacks) {
            callbacks.delete(callback);
            // If no more callbacks for this symbol, unsubscribe from stream
            if (callbacks.size === 0) {
                this.subscriptions.delete(normalizedSymbol);
                this.unsubscribeFromStream(normalizedSymbol);
            }
        }
    }
    /**
     * Get current spot price for a symbol via REST API
     * @param symbol - Trading symbol (e.g., 'BTCUSDT')
     * @returns Promise with current price
     */
    async getSpotPrice(symbol) {
        try {
            const response = await fetch(`${this.baseUrl}/api/v3/ticker/price?symbol=${symbol.toUpperCase()}`);
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            const data = await response.json();
            return parseFloat(data.price);
        }
        catch (error) {
            const errorMsg = `Failed to get spot price for ${symbol}: ${error instanceof Error ? error.message : 'Unknown error'}`;
            this.emitError(new Error(errorMsg));
            throw new Error(errorMsg);
        }
    }
    /**
     * Add error callback
     * @param callback - Error callback function
     */
    onError(callback) {
        this.errorCallbacks.add(callback);
    }
    /**
     * Add reconnect callback
     * @param callback - Reconnect callback function
     */
    onReconnect(callback) {
        this.reconnectCallbacks.add(callback);
    }
    /**
     * Remove error callback
     * @param callback - Error callback function to remove
     */
    removeErrorCallback(callback) {
        this.errorCallbacks.delete(callback);
    }
    /**
     * Remove reconnect callback
     * @param callback - Reconnect callback function to remove
     */
    removeReconnectCallback(callback) {
        this.reconnectCallbacks.delete(callback);
    }
    /**
     * Get connection status
     * @returns WebSocket ready state
     */
    getConnectionStatus() {
        if (!this.ws)
            return 'CLOSED';
        switch (this.ws.readyState) {
            case WebSocket.CONNECTING: return 'CONNECTING';
            case WebSocket.OPEN: return 'OPEN';
            case WebSocket.CLOSING: return 'CLOSING';
            case WebSocket.CLOSED: return 'CLOSED';
            default: return 'CLOSED';
        }
    }
    /**
     * Close WebSocket connection and cleanup
     */
    close() {
        if (this.heartbeatInterval) {
            clearInterval(this.heartbeatInterval);
            this.heartbeatInterval = null;
        }
        if (this.ws) {
            this.ws.close();
            this.ws = null;
        }
        this.subscriptions.clear();
        this.errorCallbacks.clear();
        this.reconnectCallbacks.clear();
        this.reconnectAttempts = 0;
        this.isReconnecting = false;
    }
    /**
     * Connect to Binance WebSocket
     */
    connect() {
        if (this.isReconnecting)
            return;
        try {
            // Build stream URL with all subscribed symbols
            const streams = Array.from(this.subscriptions.keys()).map(symbol => `${symbol}@aggTrade`);
            const streamUrl = streams.length > 0
                ? `${this.wsUrl}/${streams.join('/')}`
                : this.wsUrl;
            this.ws = new WebSocket(streamUrl);
            this.lastPongTime = Date.now();
            this.ws.on('open', () => {
                console.log('ðŸ”— Binance WebSocket connected');
                this.reconnectAttempts = 0;
                this.isReconnecting = false;
                // Subscribe to all existing symbols
                Array.from(this.subscriptions.keys()).forEach(symbol => {
                    this.subscribeToStream(symbol);
                });
            });
            this.ws.on('message', (data) => {
                try {
                    const message = JSON.parse(data.toString());
                    this.handleMessage(message);
                }
                catch (error) {
                    this.emitError(new Error(`Failed to parse WebSocket message: ${error instanceof Error ? error.message : 'Unknown error'}`));
                }
            });
            this.ws.on('pong', () => {
                this.lastPongTime = Date.now();
            });
            this.ws.on('error', (error) => {
                console.error('âŒ Binance WebSocket error:', error.message);
                this.emitError(error);
            });
            this.ws.on('close', (code, reason) => {
                console.log(`ðŸ”Œ Binance WebSocket closed: ${code} ${reason.toString()}`);
                this.ws = null;
                // Attempt reconnection if we have active subscriptions
                if (this.subscriptions.size > 0 && !this.isReconnecting) {
                    this.attemptReconnect();
                }
            });
        }
        catch (error) {
            this.emitError(new Error(`Failed to connect to Binance WebSocket: ${error instanceof Error ? error.message : 'Unknown error'}`));
        }
    }
    /**
     * Subscribe to a specific stream (used when WebSocket is already open)
     */
    subscribeToStream(symbol) {
        if (!this.ws || this.ws.readyState !== WebSocket.OPEN)
            return;
        const subscribeMessage = {
            method: 'SUBSCRIBE',
            params: [`${symbol}@aggTrade`],
            id: Date.now()
        };
        this.ws.send(JSON.stringify(subscribeMessage));
    }
    /**
     * Unsubscribe from a specific stream
     */
    unsubscribeFromStream(symbol) {
        if (!this.ws || this.ws.readyState !== WebSocket.OPEN)
            return;
        const unsubscribeMessage = {
            method: 'UNSUBSCRIBE',
            params: [`${symbol}@aggTrade`],
            id: Date.now()
        };
        this.ws.send(JSON.stringify(unsubscribeMessage));
    }
    /**
     * Handle incoming WebSocket messages
     */
    handleMessage(message) {
        // Handle aggregate trade data
        if (message.e === 'aggTrade') {
            const aggTrade = message;
            const trade = {
                price: parseFloat(aggTrade.p),
                quantity: parseFloat(aggTrade.q),
                side: aggTrade.m ? 'SELL' : 'BUY', // m=true means buyer is market maker (sell order filled)
                timestamp: aggTrade.T
            };
            // Emit to all callbacks for this symbol
            const callbacks = this.subscriptions.get(aggTrade.s.toLowerCase());
            if (callbacks) {
                callbacks.forEach(callback => {
                    try {
                        callback(trade);
                    }
                    catch (error) {
                        this.emitError(new Error(`Trade callback error: ${error instanceof Error ? error.message : 'Unknown error'}`));
                    }
                });
            }
        }
        // Handle subscription confirmations and errors
        if (message.result === null && message.id) {
            // Subscription successful
            console.log(`âœ… Binance subscription confirmed: ${message.id}`);
        }
        else if (message.error) {
            this.emitError(new Error(`Binance WebSocket error: ${message.error.msg}`));
        }
    }
    /**
     * Attempt to reconnect with exponential backoff
     */
    attemptReconnect() {
        if (this.isReconnecting || this.reconnectAttempts >= this.maxReconnectAttempts) {
            if (this.reconnectAttempts >= this.maxReconnectAttempts) {
                this.emitError(new Error(`Max reconnection attempts (${this.maxReconnectAttempts}) reached`));
            }
            return;
        }
        this.isReconnecting = true;
        this.reconnectAttempts++;
        const delay = this.reconnectDelay * Math.pow(2, this.reconnectAttempts - 1); // Exponential backoff
        console.log(`ðŸ”„ Attempting to reconnect to Binance WebSocket (attempt ${this.reconnectAttempts}/${this.maxReconnectAttempts}) in ${delay}ms`);
        setTimeout(() => {
            this.connect();
            this.emitReconnect();
        }, delay);
    }
    /**
     * Setup heartbeat to detect connection issues
     */
    setupHeartbeat() {
        this.heartbeatInterval = setInterval(() => {
            if (this.ws && this.ws.readyState === WebSocket.OPEN) {
                // Check if we received a pong recently
                const timeSinceLastPong = Date.now() - this.lastPongTime;
                if (timeSinceLastPong > 30000) { // 30 seconds timeout
                    console.warn('âš ï¸ Binance WebSocket heartbeat timeout, closing connection');
                    this.ws.close();
                    return;
                }
                // Send ping
                this.ws.ping();
            }
        }, 20000); // Ping every 20 seconds
    }
    /**
     * Emit error to all error callbacks
     */
    emitError(error) {
        this.errorCallbacks.forEach(callback => {
            try {
                callback(error);
            }
            catch (callbackError) {
                console.error('Error in error callback:', callbackError);
            }
        });
    }
    /**
     * Emit reconnect event to all reconnect callbacks
     */
    emitReconnect() {
        this.reconnectCallbacks.forEach(callback => {
            try {
                callback();
            }
            catch (callbackError) {
                console.error('Error in reconnect callback:', callbackError);
            }
        });
    }
}
exports.BinanceSpotClient = BinanceSpotClient;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLXBoYXNlMi1odW50ZXIvc3JjL2V4Y2hhbmdlcy9CaW5hbmNlU3BvdENsaWVudC50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7R0FPRzs7O0FBRUgsZ0NBQWlDO0FBR2pDLGdFQUFnRTtBQUNoRSxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsWUFBWSxDQUFDLENBQUM7QUF5QnBDLE1BQWEsaUJBQWlCO0lBQ3BCLEVBQUUsR0FBcUIsSUFBSSxDQUFDO0lBQzVCLE9BQU8sR0FBRyx5QkFBeUIsQ0FBQztJQUNwQyxLQUFLLEdBQUcsa0NBQWtDLENBQUM7SUFDM0MsYUFBYSxHQUFHLElBQUksR0FBRyxFQUE4QixDQUFDO0lBQ3RELGlCQUFpQixHQUFHLENBQUMsQ0FBQztJQUN0QixvQkFBb0IsR0FBRyxDQUFDLENBQUM7SUFDekIsY0FBYyxHQUFHLElBQUksQ0FBQyxDQUFDLFlBQVk7SUFDbkMsY0FBYyxHQUFHLEtBQUssQ0FBQztJQUN2QixpQkFBaUIsR0FBMEIsSUFBSSxDQUFDO0lBQ2hELFlBQVksR0FBRyxDQUFDLENBQUM7SUFFekIsWUFBWTtJQUNKLGNBQWMsR0FBRyxJQUFJLEdBQUcsRUFBaUIsQ0FBQztJQUMxQyxrQkFBa0IsR0FBRyxJQUFJLEdBQUcsRUFBcUIsQ0FBQztJQUUxRDtRQUNFLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztJQUN4QixDQUFDO0lBRUQ7Ozs7T0FJRztJQUNJLGtCQUFrQixDQUFDLE1BQWMsRUFBRSxRQUF1QjtRQUMvRCxNQUFNLGdCQUFnQixHQUFHLE1BQU0sQ0FBQyxXQUFXLEVBQUUsQ0FBQztRQUU5QyxnQ0FBZ0M7UUFDaEMsSUFBSSxDQUFDLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLEVBQUUsQ0FBQztZQUM5QyxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxnQkFBZ0IsRUFBRSxJQUFJLEdBQUcsRUFBRSxDQUFDLENBQUM7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QUMsRUFBRTtZQUN6QyxJQUFJLENBQUM7Z0JBQ0gsUUFBUSxFQUFFLENBQUM7WUFDYixDQUFDO1lBQUMsT0FBTyxhQUFhLEVBQUUsQ0FBQztnQkFDdkIsT0FBTyxDQUFDLEtBQUssQ0FBQyw4QkFBOEIsRUFBRSxhQUFhLENBQUMsQ0FBQztZQUMvRCxDQUFDO1FBQ0gsQ0FBQyxDQUFDLENBQUM7SUFDTCxDQUFDO0NBQ0Y7QUE1VkQsOENBNFZDIiwibmFtZXMiOltdLCJzb3VyY2VzIjpbIi9Vc2Vycy9pdmFuL0NvZGUvdHJhZGluZy90aXRhbi9zZXJ2aWNlcy90aXRhbi1waGFzZTItaHVudGVyL3NyYy9leGNoYW5nZXMvQmluYW5jZVNwb3RDbGllbnQudHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBCaW5hbmNlIFNwb3QgQ2xpZW50IGZvciBDVkQgRGF0YSBTb3VyY2VcbiAqIFxuICogUHJvdmlkZXMgdGljay1sZXZlbCB0cmFkZSBkYXRhIHZpYSBXZWJTb2NrZXQgZm9yIEN1bXVsYXRpdmUgVm9sdW1lIERlbHRhIGNhbGN1bGF0aW9uLlxuICogSW5jbHVkZXMgcmVjb25uZWN0aW9uIGxvZ2ljIGFuZCBjYWxsYmFjayBzeXN0ZW0gZm9yIHRyYWRlIGV2ZW50cy5cbiAqIFxuICogUmVxdWlyZW1lbnRzOiA0LjEgKENWRCBNb25pdG9yaW5nKVxuICovXG5cbmltcG9ydCBXZWJTb2NrZXQgPSByZXF1aXJlKCd3cycpO1xuaW1wb3J0IHsgVHJhZGUgfSBmcm9tICcuLi90eXBlcyc7XG5cbi8vIFVzZSByZXF1aXJlIGZvciBub2RlLWZldGNoIHRvIGF2b2lkIEVTIG1vZHVsZXMgaXNzdWVzIGluIEplc3RcbmNvbnN0IGZldGNoID0gcmVxdWlyZSgnbm9kZS1mZXRjaCcpO1xuXG5leHBvcnQgaW50ZXJmYWNlIEJpbmFuY2VBZ2dUcmFkZSB7XG4gIGU6IHN0cmluZzsgICAgICAvLyBFdmVudCB0eXBlXG4gIEU6IG51bWJlcjsgICAgICAvLyBFdmVudCB0aW1lXG4gIHM6IHN0cmluZzsgICAgICAvLyBTeW1ib2xcbiAgYTogbnVtYmVyOyAgICAgIC8vIEFnZ3JlZ2F0ZSB0cmFkZSBJRFxuICBwOiBzdHJpbmc7ICAgICAgLy8gUHJpY2VcbiAgcTogc3RyaW5nOyAgICAgIC8vIFF1YW50aXR5XG4gIGY6IG51bWJlcjsgICAgICAvLyBGaXJzdCB0cmFkZSBJRFxuICBsOiBudW1iZXI7ICAgICAgLy8gTGFzdCB0cmFkZSBJRFxuICBUOiBudW1iZXI7ICAgICAgLy8gVHJhZGUgdGltZVxuICBtOiBib29sZWFuOyAgICAgLy8gSXMgdGhlIGJ1eWVyIHRoZSBtYXJrZXQgbWFrZXI/XG4gIE06IGJvb2xlYW47ICAgICAvLyBJZ25vcmVcbn1cblxuZXhwb3J0IGludGVyZmFjZSBCaW5hbmNlU3BvdFByaWNlIHtcbiAgc3ltYm9sOiBzdHJpbmc7XG4gIHByaWNlOiBzdHJpbmc7XG59XG5cbmV4cG9ydCB0eXBlIFRyYWRlQ2FsbGJhY2sgPSAodHJhZGU6IFRyYWRlKSA9PiB2b2lkO1xuZXhwb3J0IHR5cGUgRXJyb3JDYWxsYmFjayA9IChlcnJvcjogRXJyb3IpID0+IHZvaWQ7XG5leHBvcnQgdHlwZSBSZWNvbm5lY3RDYWxsYmFjayA9ICgpID0+IHZvaWQ7XG5cbmV4cG9ydCBjbGFzcyBCaW5hbmNlU3BvdENsaWVudCB7XG4gIHByaXZhdGUgd3M6IFdlYlNvY2tldCB8IG51bGwgPSBudWxsO1xuICBwcml2YXRlIGJhc2VVcmwgPSAnaHR0cHM6Ly9hcGkuYmluYW5jZS5jb20nO1xuICBwcml2YXRlIHdzVXJsID0gJ3dzczovL3N0cmVhbS5iaW5hbmNlLmNvbTo5NDQzL3dzJztcbiAgcHJpdmF0ZSBzdWJzY3JpcHRpb25zID0gbmV3IE1hcDxzdHJpbmcsIFNldDxUcmFkZUNhbGxiYWNrPj4oKTtcbiAgcHJpdmF0ZSByZWNvbm5lY3RBdHRlbXB0cyA9IDA7XG4gIHByaXZhdGUgbWF4UmVjb25uZWN0QXR0ZW1wdHMgPSAzO1xuICBwcml2YXRlIHJlY29ubmVjdERlbGF5ID0gMjAwMDsgLy8gMiBzZWNvbmRzXG4gIHByaXZhdGUgaXNSZWNvbm5lY3RpbmcgPSBmYWxzZTtcbiAgcHJpdmF0ZSBoZWFydGJlYXRJbnRlcnZhbDogTm9kZUpTLlRpbWVvdXQgfCBudWxsID0gbnVsbDtcbiAgcHJpdmF0ZSBsYXN0UG9uZ1RpbWUgPSAwO1xuICBcbiAgLy8gQ2FsbGJhY2tzXG4gIHByaXZhdGUgZXJyb3JDYWxsYmFja3MgPSBuZXcgU2V0PEVycm9yQ2FsbGJhY2s+KCk7XG4gIHByaXZhdGUgcmVjb25uZWN0Q2FsbGJhY2tzID0gbmV3IFNldDxSZWNvbm5lY3RDYWxsYmFjaz4oKTtcblxuICBjb25zdHJ1Y3RvcigpIHtcbiAgICB0aGlzLnNldHVwSGVhcnRiZWF0KCk7XG4gIH1cblxuICAvKipcbiAgICogU3Vic2NyaWJlIHRvIGFnZ3JlZ2F0ZSB0cmFkZXMgZm9yIGEgc3ltYm9sXG4gICAqIEBwYXJhbSBzeW1ib2wgLSBUcmFkaW5nIHN5bWJvbCAoZS5nLiwgJ0JUQ1VTRFQnKVxuICAgKiBAcGFyYW0gY2FsbGJhY2sgLSBDYWxsYmFjayBmdW5jdGlvbiBmb3IgdHJhZGUgZXZlbnRzXG4gICAqL1xuICBwdWJsaWMgc3Vic2NyaWJlQWdnVHJhZGVzKHN5bWJvbDogc3RyaW5nLCBjYWxsYmFjazogVHJhZGVDYWxsYmFjayk6IHZvaWQge1xuICAgIGNvbnN0IG5vcm1hbGl6ZWRTeW1ib2wgPSBzeW1ib2wudG9Mb3dlckNhc2UoKTtcbiAgICBcbiAgICAvLyBBZGQgY2FsbGJhY2sgdG8gc3Vic2NyaXB0aW9uc1xuICAgIGlmICghdGhpcy5zdWJzY3JpcHRpb25zLmhhcyhub3JtYWxpemVkU3ltYm9sKSkge1xuICAgICAgdGhpcy5zdWJzY3JpcHRpb25zLnNldChub3JtYWxpemVkU3ltYm9sLCBuZXcgU2V0KCkpO1xuICAgIH1cbiAgICB0aGlzLnN1YnNjcmlwdGlvbnMuZ2V0KG5vcm1hbGl6ZWRTeW1ib2wpIS5hZGQoY2FsbGJhY2spO1xuXG4gICAgLy8gQ29ubmVjdCBXZWJTb2NrZXQgaWYgbm90IGFscmVhZHkgY29ubmVjdGVkXG4gICAgaWYgKCF0aGlzLndzIHx8IHRoaXMud3MucmVhZHlTdGF0ZSAhPT0gV2ViU29ja2V0Lk9QRU4pIHtcbiAgICAgIHRoaXMuY29ubmVjdCgpO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBTdWJzY3JpYmUgdG8gdGhlIHN0cmVhbSBpZiBXZWJTb2NrZXQgaXMgYWxyZWFkeSBvcGVuXG4gICAgICB0aGlzLnN1YnNjcmliZVRvU3RyZWFtKG5vcm1hbGl6ZWRTeW1ib2wpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBVbnN1YnNjcmliZSBmcm9tIGFnZ3JlZ2F0ZSB0cmFkZXMgZm9yIGEgc3ltYm9sXG4gICAqIEBwYXJhbSBzeW1ib2wgLSBUcmFkaW5nIHN5bWJvbFxuICAgKiBAcGFyYW0gY2FsbGJhY2sgLSBDYWxsYmFjayBmdW5jdGlvbiB0byByZW1vdmVcbiAgICovXG4gIHB1YmxpYyB1bnN1YnNjcmliZUFnZ1RyYWRlcyhzeW1ib2w6IHN0cmluZywgY2FsbGJhY2s6IFRyYWRlQ2FsbGJhY2spOiB2b2lkIHtcbiAgICBjb25zdCBub3JtYWxpemVkU3ltYm9sID0gc3ltYm9sLnRvTG93ZXJDYXNlKCk7XG4gICAgY29uc3QgY2FsbGJhY2tzID0gdGhpcy5zdWJzY3JpcHRpb25zLmdldChub3JtYWxpemVkU3ltYm9sKTtcbiAgICBcbiAgICBpZiAoY2FsbGJhY2tzKSB7XG4gICAgICBjYWxsYmFja3MuZGVsZXRlKGNhbGxiYWNrKTtcbiAgICAgIFxuICAgICAgLy8gSWYgbm8gbW9yZSBjYWxsYmFja3MgZm9yIHRoaXMgc3ltYm9sLCB1bnN1YnNjcmliZSBmcm9tIHN0cmVhbVxuICAgICAgaWYgKGNhbGxiYWNrcy5zaXplID09PSAwKSB7XG4gICAgICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5kZWxldGUobm9ybWFsaXplZFN5bWJvbCk7XG4gICAgICAgIHRoaXMudW5zdWJzY3JpYmVGcm9tU3RyZWFtKG5vcm1hbGl6ZWRTeW1ib2wpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY3VycmVudCBzcG90IHByaWNlIGZvciBhIHN5bWJvbCB2aWEgUkVTVCBBUElcbiAgICogQHBhcmFtIHN5bWJvbCAtIFRyYWRpbmcgc3ltYm9sIChlLmcuLCAnQlRDVVNEVCcpXG4gICAqIEByZXR1cm5zIFByb21pc2Ugd2l0aCBjdXJyZW50IHByaWNlXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgZ2V0U3BvdFByaWNlKHN5bWJvbDogc3RyaW5nKTogUHJvbWlzZTxudW1iZXI+IHtcbiAgICB0cnkge1xuICAgICAgY29uc3QgcmVzcG9uc2UgPSBhd2FpdCBmZXRjaChgJHt0aGlzLmJhc2VVcmx9L2FwaS92My90aWNrZXIvcHJpY2U/c3ltYm9sPSR7c3ltYm9sLnRvVXBwZXJDYXNlKCl9YCk7XG4gICAgICBcbiAgICAgIGlmICghcmVzcG9uc2Uub2spIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBIVFRQICR7cmVzcG9uc2Uuc3RhdHVzfTogJHtyZXNwb25zZS5zdGF0dXNUZXh0fWApO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBkYXRhID0gYXdhaXQgcmVzcG9uc2UuanNvbigpIGFzIEJpbmFuY2VTcG90UHJpY2U7XG4gICAgICByZXR1cm4gcGFyc2VGbG9hdChkYXRhLnByaWNlKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc3QgZXJyb3JNc2cgPSBgRmFpbGVkIHRvIGdldCBzcG90IHByaWNlIGZvciAke3N5bWJvbH06ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcid9YDtcbiAgICAgIHRoaXMuZW1pdEVycm9yKG5ldyBFcnJvcihlcnJvck1zZykpO1xuICAgICAgdGhyb3cgbmV3IEVycm9yKGVycm9yTXNnKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQWRkIGVycm9yIGNhbGxiYWNrXG4gICAqIEBwYXJhbSBjYWxsYmFjayAtIEVycm9yIGNhbGxiYWNrIGZ1bmN0aW9uXG4gICAqL1xuICBwdWJsaWMgb25FcnJvcihjYWxsYmFjazogRXJyb3JDYWxsYmFjayk6IHZvaWQge1xuICAgIHRoaXMuZXJyb3JDYWxsYmFja3MuYWRkKGNhbGxiYWNrKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBBZGQgcmVjb25uZWN0IGNhbGxiYWNrXG4gICAqIEBwYXJhbSBjYWxsYmFjayAtIFJlY29ubmVjdCBjYWxsYmFjayBmdW5jdGlvblxuICAgKi9cbiAgcHVibGljIG9uUmVjb25uZWN0KGNhbGxiYWNrOiBSZWNvbm5lY3RDYWxsYmFjayk6IHZvaWQge1xuICAgIHRoaXMucmVjb25uZWN0Q2FsbGJhY2tzLmFkZChjYWxsYmFjayk7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIGVycm9yIGNhbGxiYWNrXG4gICAqIEBwYXJhbSBjYWxsYmFjayAtIEVycm9yIGNhbGxiYWNrIGZ1bmN0aW9uIHRvIHJlbW92ZVxuICAgKi9cbiAgcHVibGljIHJlbW92ZUVycm9yQ2FsbGJhY2soY2FsbGJhY2s6IEVycm9yQ2FsbGJhY2spOiB2b2lkIHtcbiAgICB0aGlzLmVycm9yQ2FsbGJhY2tzLmRlbGV0ZShjYWxsYmFjayk7XG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIHJlY29ubmVjdCBjYWxsYmFja1xuICAgKiBAcGFyYW0gY2FsbGJhY2sgLSBSZWNvbm5lY3QgY2FsbGJhY2sgZnVuY3Rpb24gdG8gcmVtb3ZlXG4gICAqL1xuICBwdWJsaWMgcmVtb3ZlUmVjb25uZWN0Q2FsbGJhY2soY2FsbGJhY2s6IFJlY29ubmVjdENhbGxiYWNrKTogdm9pZCB7XG4gICAgdGhpcy5yZWNvbm5lY3RDYWxsYmFja3MuZGVsZXRlKGNhbGxiYWNrKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY29ubmVjdGlvbiBzdGF0dXNcbiAgICogQHJldHVybnMgV2ViU29ja2V0IHJlYWR5IHN0YXRlXG4gICAqL1xuICBwdWJsaWMgZ2V0Q29ubmVjdGlvblN0YXR1cygpOiAnQ09OTkVDVElORycgfCAnT1BFTicgfCAnQ0xPU0lORycgfCAnQ0xPU0VEJyB7XG4gICAgaWYgKCF0aGlzLndzKSByZXR1cm4gJ0NMT1NFRCc7XG4gICAgXG4gICAgc3dpdGNoICh0aGlzLndzLnJlYWR5U3RhdGUpIHtcbiAgICAgIGNhc2UgV2ViU29ja2V0LkNPTk5FQ1RJTkc6IHJldHVybiAnQ09OTkVDVElORyc7XG4gICAgICBjYXNlIFdlYlNvY2tldC5PUEVOOiByZXR1cm4gJ09QRU4nO1xuICAgICAgY2FzZSBXZWJTb2NrZXQuQ0xPU0lORzogcmV0dXJuICdDTE9TSU5HJztcbiAgICAgIGNhc2UgV2ViU29ja2V0LkNMT1NFRDogcmV0dXJuICdDTE9TRUQnO1xuICAgICAgZGVmYXVsdDogcmV0dXJuICdDTE9TRUQnO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDbG9zZSBXZWJTb2NrZXQgY29ubmVjdGlvbiBhbmQgY2xlYW51cFxuICAgKi9cbiAgcHVibGljIGNsb3NlKCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmhlYXJ0YmVhdEludGVydmFsKSB7XG4gICAgICBjbGVhckludGVydmFsKHRoaXMuaGVhcnRiZWF0SW50ZXJ2YWwpO1xuICAgICAgdGhpcy5oZWFydGJlYXRJbnRlcnZhbCA9IG51bGw7XG4gICAgfVxuXG4gICAgaWYgKHRoaXMud3MpIHtcbiAgICAgIHRoaXMud3MuY2xvc2UoKTtcbiAgICAgIHRoaXMud3MgPSBudWxsO1xuICAgIH1cblxuICAgIHRoaXMuc3Vic2NyaXB0aW9ucy5jbGVhcigpO1xuICAgIHRoaXMuZXJyb3JDYWxsYmFja3MuY2xlYXIoKTtcbiAgICB0aGlzLnJlY29ubmVjdENhbGxiYWNrcy5jbGVhcigpO1xuICAgIHRoaXMucmVjb25uZWN0QXR0ZW1wdHMgPSAwO1xuICAgIHRoaXMuaXNSZWNvbm5lY3RpbmcgPSBmYWxzZTtcbiAgfVxuXG4gIC8qKlxuICAgKiBDb25uZWN0IHRvIEJpbmFuY2UgV2ViU29ja2V0XG4gICAqL1xuICBwcml2YXRlIGNvbm5lY3QoKTogdm9pZCB7XG4gICAgaWYgKHRoaXMuaXNSZWNvbm5lY3RpbmcpIHJldHVybjtcblxuICAgIHRyeSB7XG4gICAgICAvLyBCdWlsZCBzdHJlYW0gVVJMIHdpdGggYWxsIHN1YnNjcmliZWQgc3ltYm9sc1xuICAgICAgY29uc3Qgc3RyZWFtcyA9IEFycmF5LmZyb20odGhpcy5zdWJzY3JpcHRpb25zLmtleXMoKSkubWFwKHN5bWJvbCA9PiBgJHtzeW1ib2x9QGFnZ1RyYWRlYCk7XG4gICAgICBjb25zdCBzdHJlYW1VcmwgPSBzdHJlYW1zLmxlbmd0aCA+IDAgXG4gICAgICAgID8gYCR7dGhpcy53c1VybH0vJHtzdHJlYW1zLmpvaW4oJy8nKX1gXG4gICAgICAgIDogdGhpcy53c1VybDtcblxuICAgICAgdGhpcy53cyA9IG5ldyBXZWJTb2NrZXQoc3RyZWFtVXJsKTtcbiAgICAgIHRoaXMubGFzdFBvbmdUaW1lID0gRGF0ZS5ub3coKTtcblxuICAgICAgdGhpcy53cy5vbignb3BlbicsICgpID0+IHtcbiAgICAgICAgY29uc29sZS5sb2coJ/CflJcgQmluYW5jZSBXZWJTb2NrZXQgY29ubmVjdGVkJyk7XG4gICAgICAgIHRoaXMucmVjb25uZWN0QXR0ZW1wdHMgPSAwO1xuICAgICAgICB0aGlzLmlzUmVjb25uZWN0aW5nID0gZmFsc2U7XG4gICAgICAgIFxuICAgICAgICAvLyBTdWJzY3JpYmUgdG8gYWxsIGV4aXN0aW5nIHN5bWJvbHNcbiAgICAgICAgQXJyYXkuZnJvbSh0aGlzLnN1YnNjcmlwdGlvbnMua2V5cygpKS5mb3JFYWNoKHN5bWJvbCA9PiB7XG4gICAgICAgICAgdGhpcy5zdWJzY3JpYmVUb1N0cmVhbShzeW1ib2wpO1xuICAgICAgICB9KTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLndzLm9uKCdtZXNzYWdlJywgKGRhdGE6IFdlYlNvY2tldC5EYXRhKSA9PiB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgY29uc3QgbWVzc2FnZSA9IEpTT04ucGFyc2UoZGF0YS50b1N0cmluZygpKTtcbiAgICAgICAgICB0aGlzLmhhbmRsZU1lc3NhZ2UobWVzc2FnZSk7XG4gICAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgdGhpcy5lbWl0RXJyb3IobmV3IEVycm9yKGBGYWlsZWQgdG8gcGFyc2UgV2ViU29ja2V0IG1lc3NhZ2U6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcid9YCkpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgICAgdGhpcy53cy5vbigncG9uZycsICgpID0+IHtcbiAgICAgICAgdGhpcy5sYXN0UG9uZ1RpbWUgPSBEYXRlLm5vdygpO1xuICAgICAgfSk7XG5cbiAgICAgIHRoaXMud3Mub24oJ2Vycm9yJywgKGVycm9yOiBFcnJvcikgPT4ge1xuICAgICAgICBjb25zb2xlLmVycm9yKCfinYwgQmluYW5jZSBXZWJTb2NrZXQgZXJyb3I6JywgZXJyb3IubWVzc2FnZSk7XG4gICAgICAgIHRoaXMuZW1pdEVycm9yKGVycm9yKTtcbiAgICAgIH0pO1xuXG4gICAgICB0aGlzLndzLm9uKCdjbG9zZScsIChjb2RlOiBudW1iZXIsIHJlYXNvbjogQnVmZmVyKSA9PiB7XG4gICAgICAgIGNvbnNvbGUubG9nKGDwn5SMIEJpbmFuY2UgV2ViU29ja2V0IGNsb3NlZDogJHtjb2RlfSAke3JlYXNvbi50b1N0cmluZygpfWApO1xuICAgICAgICB0aGlzLndzID0gbnVsbDtcbiAgICAgICAgXG4gICAgICAgIC8vIEF0dGVtcHQgcmVjb25uZWN0aW9uIGlmIHdlIGhhdmUgYWN0aXZlIHN1YnNjcmlwdGlvbnNcbiAgICAgICAgaWYgKHRoaXMuc3Vic2NyaXB0aW9ucy5zaXplID4gMCAmJiAhdGhpcy5pc1JlY29ubmVjdGluZykge1xuICAgICAgICAgIHRoaXMuYXR0ZW1wdFJlY29ubmVjdCgpO1xuICAgICAgICB9XG4gICAgICB9KTtcblxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICB0aGlzLmVtaXRFcnJvcihuZXcgRXJyb3IoYEZhaWxlZCB0byBjb25uZWN0IHRvIEJpbmFuY2UgV2ViU29ja2V0OiAke2Vycm9yIGluc3RhbmNlb2YgRXJyb3IgPyBlcnJvci5tZXNzYWdlIDogJ1Vua25vd24gZXJyb3InfWApKTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogU3Vic2NyaWJlIHRvIGEgc3BlY2lmaWMgc3RyZWFtICh1c2VkIHdoZW4gV2ViU29ja2V0IGlzIGFscmVhZHkgb3BlbilcbiAgICovXG4gIHByaXZhdGUgc3Vic2NyaWJlVG9TdHJlYW0oc3ltYm9sOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMud3MgfHwgdGhpcy53cy5yZWFkeVN0YXRlICE9PSBXZWJTb2NrZXQuT1BFTikgcmV0dXJuO1xuXG4gICAgY29uc3Qgc3Vic2NyaWJlTWVzc2FnZSA9IHtcbiAgICAgIG1ldGhvZDogJ1NVQlNDUklCRScsXG4gICAgICBwYXJhbXM6IFtgJHtzeW1ib2x9QGFnZ1RyYWRlYF0sXG4gICAgICBpZDogRGF0ZS5ub3coKVxuICAgIH07XG5cbiAgICB0aGlzLndzLnNlbmQoSlNPTi5zdHJpbmdpZnkoc3Vic2NyaWJlTWVzc2FnZSkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFVuc3Vic2NyaWJlIGZyb20gYSBzcGVjaWZpYyBzdHJlYW1cbiAgICovXG4gIHByaXZhdGUgdW5zdWJzY3JpYmVGcm9tU3RyZWFtKHN5bWJvbDogc3RyaW5nKTogdm9pZCB7XG4gICAgaWYgKCF0aGlzLndzIHx8IHRoaXMud3MucmVhZHlTdGF0ZSAhPT0gV2ViU29ja2V0Lk9QRU4pIHJldHVybjtcblxuICAgIGNvbnN0IHVuc3Vic2NyaWJlTWVzc2FnZSA9IHtcbiAgICAgIG1ldGhvZDogJ1VOU1VCU0NSSUJFJyxcbiAgICAgIHBhcmFtczogW2Ake3N5bWJvbH1AYWdnVHJhZGVgXSxcbiAgICAgIGlkOiBEYXRlLm5vdygpXG4gICAgfTtcblxuICAgIHRoaXMud3Muc2VuZChKU09OLnN0cmluZ2lmeSh1bnN1YnNjcmliZU1lc3NhZ2UpKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBIYW5kbGUgaW5jb21pbmcgV2ViU29ja2V0IG1lc3NhZ2VzXG4gICAqL1xuICBwcml2YXRlIGhhbmRsZU1lc3NhZ2UobWVzc2FnZTogYW55KTogdm9pZCB7XG4gICAgLy8gSGFuZGxlIGFnZ3JlZ2F0ZSB0cmFkZSBkYXRhXG4gICAgaWYgKG1lc3NhZ2UuZSA9PT0gJ2FnZ1RyYWRlJykge1xuICAgICAgY29uc3QgYWdnVHJhZGUgPSBtZXNzYWdlIGFzIEJpbmFuY2VBZ2dUcmFkZTtcbiAgICAgIGNvbnN0IHRyYWRlOiBUcmFkZSA9IHtcbiAgICAgICAgcHJpY2U6IHBhcnNlRmxvYXQoYWdnVHJhZGUucCksXG4gICAgICAgIHF1YW50aXR5OiBwYXJzZUZsb2F0KGFnZ1RyYWRlLnEpLFxuICAgICAgICBzaWRlOiBhZ2dUcmFkZS5tID8gJ1NFTEwnIDogJ0JVWScsIC8vIG09dHJ1ZSBtZWFucyBidXllciBpcyBtYXJrZXQgbWFrZXIgKHNlbGwgb3JkZXIgZmlsbGVkKVxuICAgICAgICB0aW1lc3RhbXA6IGFnZ1RyYWRlLlRcbiAgICAgIH07XG5cbiAgICAgIC8vIEVtaXQgdG8gYWxsIGNhbGxiYWNrcyBmb3IgdGhpcyBzeW1ib2xcbiAgICAgIGNvbnN0IGNhbGxiYWNrcyA9IHRoaXMuc3Vic2NyaXB0aW9ucy5nZXQoYWdnVHJhZGUucy50b0xvd2VyQ2FzZSgpKTtcbiAgICAgIGlmIChjYWxsYmFja3MpIHtcbiAgICAgICAgY2FsbGJhY2tzLmZvckVhY2goY2FsbGJhY2sgPT4ge1xuICAgICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjYWxsYmFjayh0cmFkZSk7XG4gICAgICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRoaXMuZW1pdEVycm9yKG5ldyBFcnJvcihgVHJhZGUgY2FsbGJhY2sgZXJyb3I6ICR7ZXJyb3IgaW5zdGFuY2VvZiBFcnJvciA/IGVycm9yLm1lc3NhZ2UgOiAnVW5rbm93biBlcnJvcid9YCkpO1xuICAgICAgICAgIH1cbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfVxuICAgIFxuICAgIC8vIEhhbmRsZSBzdWJzY3JpcHRpb24gY29uZmlybWF0aW9ucyBhbmQgZXJyb3JzXG4gICAgaWYgKG1lc3NhZ2UucmVzdWx0ID09PSBudWxsICYmIG1lc3NhZ2UuaWQpIHtcbiAgICAgIC8vIFN1YnNjcmlwdGlvbiBzdWNjZXNzZnVsXG4gICAgICBjb25zb2xlLmxvZyhg4pyFIEJpbmFuY2Ugc3Vic2NyaXB0aW9uIGNvbmZpcm1lZDogJHttZXNzYWdlLmlkfWApO1xuICAgIH0gZWxzZSBpZiAobWVzc2FnZS5lcnJvcikge1xuICAgICAgdGhpcy5lbWl0RXJyb3IobmV3IEVycm9yKGBCaW5hbmNlIFdlYlNvY2tldCBlcnJvcjogJHttZXNzYWdlLmVycm9yLm1zZ31gKSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIEF0dGVtcHQgdG8gcmVjb25uZWN0IHdpdGggZXhwb25lbnRpYWwgYmFja29mZlxuICAgKi9cbiAgcHJpdmF0ZSBhdHRlbXB0UmVjb25uZWN0KCk6IHZvaWQge1xuICAgIGlmICh0aGlzLmlzUmVjb25uZWN0aW5nIHx8IHRoaXMucmVjb25uZWN0QXR0ZW1wdHMgPj0gdGhpcy5tYXhSZWNvbm5lY3RBdHRlbXB0cykge1xuICAgICAgaWYgKHRoaXMucmVjb25uZWN0QXR0ZW1wdHMgPj0gdGhpcy5tYXhSZWNvbm5lY3RBdHRlbXB0cykge1xuICAgICAgICB0aGlzLmVtaXRFcnJvcihuZXcgRXJyb3IoYE1heCByZWNvbm5lY3Rpb24gYXR0ZW1wdHMgKCR7dGhpcy5tYXhSZWNvbm5lY3RBdHRlbXB0c30pIHJlYWNoZWRgKSk7XG4gICAgICB9XG4gICAgICByZXR1cm47XG4gICAgfVxuXG4gICAgdGhpcy5pc1JlY29ubmVjdGluZyA9IHRydWU7XG4gICAgdGhpcy5yZWNvbm5lY3RBdHRlbXB0cysrO1xuXG4gICAgY29uc3QgZGVsYXkgPSB0aGlzLnJlY29ubmVjdERlbGF5ICogTWF0aC5wb3coMiwgdGhpcy5yZWNvbm5lY3RBdHRlbXB0cyAtIDEpOyAvLyBFeHBvbmVudGlhbCBiYWNrb2ZmXG4gICAgY29uc29sZS5sb2coYPCflIQgQXR0ZW1wdGluZyB0byByZWNvbm5lY3QgdG8gQmluYW5jZSBXZWJTb2NrZXQgKGF0dGVtcHQgJHt0aGlzLnJlY29ubmVjdEF0dGVtcHRzfS8ke3RoaXMubWF4UmVjb25uZWN0QXR0ZW1wdHN9KSBpbiAke2RlbGF5fW1zYCk7XG5cbiAgICBzZXRUaW1lb3V0KCgpID0+IHtcbiAgICAgIHRoaXMuY29ubmVjdCgpO1xuICAgICAgdGhpcy5lbWl0UmVjb25uZWN0KCk7XG4gICAgfSwgZGVsYXkpO1xuICB9XG5cbiAgLyoqXG4gICAqIFNldHVwIGhlYXJ0YmVhdCB0byBkZXRlY3QgY29ubmVjdGlvbiBpc3N1ZXNcbiAgICovXG4gIHByaXZhdGUgc2V0dXBIZWFydGJlYXQoKTogdm9pZCB7XG4gICAgdGhpcy5oZWFydGJlYXRJbnRlcnZhbCA9IHNldEludGVydmFsKCgpID0+IHtcbiAgICAgIGlmICh0aGlzLndzICYmIHRoaXMud3MucmVhZHlTdGF0ZSA9PT0gV2ViU29ja2V0Lk9QRU4pIHtcbiAgICAgICAgLy8gQ2hlY2sgaWYgd2UgcmVjZWl2ZWQgYSBwb25nIHJlY2VudGx5XG4gICAgICAgIGNvbnN0IHRpbWVTaW5jZUxhc3RQb25nID0gRGF0ZS5ub3coKSAtIHRoaXMubGFzdFBvbmdUaW1lO1xuICAgICAgICBpZiAodGltZVNpbmNlTGFzdFBvbmcgPiAzMDAwMCkgeyAvLyAzMCBzZWNvbmRzIHRpbWVvdXRcbiAgICAgICAgICBjb25zb2xlLndhcm4oJ+KaoO+4jyBCaW5hbmNlIFdlYlNvY2tldCBoZWFydGJlYXQgdGltZW91dCwgY2xvc2luZyBjb25uZWN0aW9uJyk7XG4gICAgICAgICAgdGhpcy53cy5jbG9zZSgpO1xuICAgICAgICAgIHJldHVybjtcbiAgICAgICAgfVxuXG4gICAgICAgIC8vIFNlbmQgcGluZ1xuICAgICAgICB0aGlzLndzLnBpbmcoKTtcbiAgICAgIH1cbiAgICB9LCAyMDAwMCk7IC8vIFBpbmcgZXZlcnkgMjAgc2Vjb25kc1xuICB9XG5cbiAgLyoqXG4gICAqIEVtaXQgZXJyb3IgdG8gYWxsIGVycm9yIGNhbGxiYWNrc1xuICAgKi9cbiAgcHJpdmF0ZSBlbWl0RXJyb3IoZXJyb3I6IEVycm9yKTogdm9pZCB7XG4gICAgdGhpcy5lcnJvckNhbGxiYWNrcy5mb3JFYWNoKGNhbGxiYWNrID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNhbGxiYWNrKGVycm9yKTtcbiAgICAgIH0gY2F0Y2ggKGNhbGxiYWNrRXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcignRXJyb3IgaW4gZXJyb3IgY2FsbGJhY2s6JywgY2FsbGJhY2tFcnJvcik7XG4gICAgICB9XG4gICAgfSk7XG4gIH1cblxuICAvKipcbiAgICogRW1pdCByZWNvbm5lY3QgZXZlbnQgdG8gYWxsIHJlY29ubmVjdCBjYWxsYmFja3NcbiAgICovXG4gIHByaXZhdGUgZW1pdFJlY29ubmVjdCgpOiB2b2lkIHtcbiAgICB0aGlzLnJlY29ubmVjdENhbGxiYWNrcy5mb3JFYWNoKGNhbGxiYWNrID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNhbGxiYWNrKCk7XG4gICAgICB9IGNhdGNoIChjYWxsYmFja0Vycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGluIHJlY29ubmVjdCBjYWxsYmFjazonLCBjYWxsYmFja0Vycm9yKTtcbiAgICAgIH1cbiAgICB9KTtcbiAgfVxufSJdLCJ2ZXJzaW9uIjozfQ==
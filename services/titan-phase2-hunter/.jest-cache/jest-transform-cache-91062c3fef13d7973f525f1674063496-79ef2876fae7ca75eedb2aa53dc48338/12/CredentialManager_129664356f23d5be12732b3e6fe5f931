d843dc595056b36761e135464bf3393b
"use strict";
/**
 * Credential Manager for Titan Phase 2 - The Hunter
 *
 * Provides secure credential storage using AES-256-GCM encryption.
 * Credentials are encrypted with a master password and stored in ~/.titan-scanner/secrets.enc
 *
 * Requirements: Encrypted credential storage
 */
Object.defineProperty(exports, "__esModule", { value: true });
exports.CredentialManager = void 0;
const crypto_1 = require("crypto");
const fs_1 = require("fs");
const path_1 = require("path");
const os_1 = require("os");
/**
 * Credential Manager with AES-256-GCM encryption
 */
class CredentialManager {
    credentialsDir;
    credentialsPath;
    algorithm = 'aes-256-cbc';
    masterPassword = null;
    constructor() {
        this.credentialsDir = (0, path_1.join)((0, os_1.homedir)(), '.titan-scanner');
        this.credentialsPath = (0, path_1.join)(this.credentialsDir, 'secrets.enc');
        // Ensure credentials directory exists
        if (!(0, fs_1.existsSync)(this.credentialsDir)) {
            (0, fs_1.mkdirSync)(this.credentialsDir, { recursive: true, mode: 0o700 });
        }
    }
    /**
     * Set master password from environment variable or user input
     */
    setMasterPassword(password) {
        if (password) {
            this.masterPassword = password;
        }
        else {
            // Try to get from environment variable
            this.masterPassword = process.env.TITAN_MASTER_PASSWORD || null;
            if (!this.masterPassword) {
                throw new Error('Master password not provided. Set TITAN_MASTER_PASSWORD environment variable or pass password directly.');
            }
        }
    }
    /**
     * Save credentials with AES-256-GCM encryption
     * Requirements: Implement saveCredentials() with AES-256-GCM encryption
     */
    saveCredentials(credentials) {
        if (!this.masterPassword) {
            throw new Error('Master password not set. Call setMasterPassword() first.');
        }
        try {
            // Validate credentials before saving
            const validation = this.validateCredentials(credentials);
            if (!validation.isValid) {
                throw new Error(`Invalid credentials: ${validation.errors.join(', ')}`);
            }
            // Generate salt and IV
            const salt = (0, crypto_1.randomBytes)(32);
            const iv = (0, crypto_1.randomBytes)(16);
            // Derive key from master password using PBKDF2
            const key = this.deriveKey(this.masterPassword, salt);
            // Create cipher
            const cipher = (0, crypto_1.createCipheriv)(this.algorithm, key, iv);
            // Encrypt credentials
            const credentialsJson = JSON.stringify(credentials);
            let encrypted = cipher.update(credentialsJson, 'utf8', 'hex');
            encrypted += cipher.final('hex');
            // Create encrypted data structure
            const encryptedData = {
                data: encrypted,
                iv: iv.toString('hex'),
                salt: salt.toString('hex'),
                version: 1,
                timestamp: Date.now()
            };
            // Write to file with restricted permissions
            (0, fs_1.writeFileSync)(this.credentialsPath, JSON.stringify(encryptedData, null, 2), {
                encoding: 'utf8',
                mode: 0o600 // Read/write for owner only
            });
            console.log('üîê Credentials saved successfully');
        }
        catch (error) {
            console.error('‚ùå Failed to save credentials:', error);
            throw error;
        }
    }
    /**
     * Load credentials with master password decryption
     * Requirements: Implement loadCredentials() with master password decryption
     */
    loadCredentials() {
        if (!this.masterPassword) {
            throw new Error('Master password not set. Call setMasterPassword() first.');
        }
        if (!(0, fs_1.existsSync)(this.credentialsPath)) {
            throw new Error('No credentials file found. Save credentials first using saveCredentials().');
        }
        try {
            // Read encrypted file
            const fileContent = (0, fs_1.readFileSync)(this.credentialsPath, 'utf8');
            const encryptedData = JSON.parse(fileContent);
            // Extract components
            const encryptedText = encryptedData.data;
            const iv = Buffer.from(encryptedData.iv, 'hex');
            const salt = Buffer.from(encryptedData.salt, 'hex');
            // Derive key from master password
            const key = this.deriveKey(this.masterPassword, salt);
            // Create decipher
            const decipher = (0, crypto_1.createDecipheriv)(this.algorithm, key, iv);
            // Decrypt credentials
            let decrypted = decipher.update(encryptedText, 'hex', 'utf8');
            decrypted += decipher.final('utf8');
            // Parse and validate decrypted credentials
            const credentials = JSON.parse(decrypted);
            const validation = this.validateCredentials(credentials);
            if (!validation.isValid) {
                throw new Error(`Corrupted credentials: ${validation.errors.join(', ')}`);
            }
            console.log('üîì Credentials loaded successfully');
            return credentials;
        }
        catch (error) {
            console.error('‚ùå Failed to load credentials:', error);
            throw new Error('Failed to decrypt credentials. Check master password and file integrity.');
        }
    }
    /**
     * Check if credentials file exists
     */
    hasCredentials() {
        return (0, fs_1.existsSync)(this.credentialsPath);
    }
    /**
     * Delete credentials file
     */
    deleteCredentials() {
        if ((0, fs_1.existsSync)(this.credentialsPath)) {
            try {
                // Overwrite file with random data before deletion (secure delete)
                const fileSize = (0, fs_1.readFileSync)(this.credentialsPath).length;
                const randomData = (0, crypto_1.randomBytes)(fileSize);
                (0, fs_1.writeFileSync)(this.credentialsPath, randomData);
                // Delete file
                require('fs').unlinkSync(this.credentialsPath);
                console.log('üóëÔ∏è Credentials deleted successfully');
            }
            catch (error) {
                console.error('‚ùå Failed to delete credentials:', error);
                throw error;
            }
        }
    }
    /**
     * Update specific exchange credentials
     */
    updateExchangeCredentials(exchange, apiKey, apiSecret) {
        let credentials;
        try {
            // Load existing credentials
            credentials = this.loadCredentials();
        }
        catch (error) {
            // If no credentials exist, create new structure with valid placeholder values
            credentials = {
                binance: {
                    apiKey: 'placeholder_binance_api_key_32_chars',
                    apiSecret: 'placeholder_binance_api_secret_64_characters_long_for_testing_purposes'
                },
                bybit: {
                    apiKey: 'placeholder_bybit_api_key_24',
                    apiSecret: 'placeholder_bybit_api_secret_48_characters_long'
                }
            };
        }
        // Update specific exchange
        credentials[exchange] = { apiKey, apiSecret };
        // Save updated credentials
        this.saveCredentials(credentials);
    }
    /**
     * Get credentials for specific exchange
     */
    getExchangeCredentials(exchange) {
        const credentials = this.loadCredentials();
        return credentials[exchange];
    }
    /**
     * Validate credentials structure and content
     */
    validateCredentials(credentials) {
        const errors = [];
        const warnings = [];
        // Check structure
        if (!credentials) {
            errors.push('Credentials object is null or undefined');
            return { isValid: false, errors, warnings };
        }
        // Validate Binance credentials
        if (!credentials.binance) {
            errors.push('Missing Binance credentials');
        }
        else {
            if (!credentials.binance.apiKey || credentials.binance.apiKey.trim() === '') {
                errors.push('Binance API key is empty');
            }
            else if (credentials.binance.apiKey.length < 32) {
                warnings.push('Binance API key seems too short');
            }
            if (!credentials.binance.apiSecret || credentials.binance.apiSecret.trim() === '') {
                errors.push('Binance API secret is empty');
            }
            else if (credentials.binance.apiSecret.length < 32) {
                warnings.push('Binance API secret seems too short');
            }
        }
        // Validate Bybit credentials
        if (!credentials.bybit) {
            errors.push('Missing Bybit credentials');
        }
        else {
            if (!credentials.bybit.apiKey || credentials.bybit.apiKey.trim() === '') {
                errors.push('Bybit API key is empty');
            }
            else if (credentials.bybit.apiKey.length < 16) {
                warnings.push('Bybit API key seems too short');
            }
            if (!credentials.bybit.apiSecret || credentials.bybit.apiSecret.trim() === '') {
                errors.push('Bybit API secret is empty');
            }
            else if (credentials.bybit.apiSecret.length < 16) {
                warnings.push('Bybit API secret seems too short');
            }
        }
        return {
            isValid: errors.length === 0,
            errors,
            warnings
        };
    }
    /**
     * Derive encryption key from master password using PBKDF2
     */
    deriveKey(password, salt) {
        return (0, crypto_1.pbkdf2Sync)(password, salt, 100000, 32, 'sha256');
    }
    /**
     * Get credentials file info
     */
    getCredentialsInfo() {
        const exists = this.hasCredentials();
        const info = {
            exists,
            path: this.credentialsPath
        };
        if (exists) {
            try {
                const stats = require('fs').statSync(this.credentialsPath);
                info.size = stats.size;
                info.modified = stats.mtime;
            }
            catch (error) {
                // Ignore stat errors
            }
        }
        return info;
    }
    /**
     * Test credentials by attempting to decrypt
     */
    testCredentials() {
        try {
            this.loadCredentials();
            return true;
        }
        catch (error) {
            return false;
        }
    }
    /**
     * Change master password (re-encrypt with new password)
     */
    changeMasterPassword(newPassword) {
        if (!this.masterPassword) {
            throw new Error('Current master password not set');
        }
        // Load credentials with current password
        const credentials = this.loadCredentials();
        // Set new password
        const oldPassword = this.masterPassword;
        this.masterPassword = newPassword;
        try {
            // Save with new password
            this.saveCredentials(credentials);
            console.log('üîê Master password changed successfully');
        }
        catch (error) {
            // Restore old password on failure
            this.masterPassword = oldPassword;
            throw error;
        }
    }
}
exports.CredentialManager = CredentialManager;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2l2YW4vQ29kZS90cmFkaW5nL3RpdGFuL3NlcnZpY2VzL3RpdGFuLXBoYXNlMi1odW50ZXIvc3JjL2NvbmZpZy9DcmVkZW50aWFsTWFuYWdlci50cyIsIm1hcHBpbmdzIjoiO0FBQUE7Ozs7Ozs7R0FPRzs7O0FBRUgsbUNBQW1GO0FBQ25GLDJCQUF3RTtBQUN4RSwrQkFBNEI7QUFDNUIsMkJBQTZCO0FBb0M3Qjs7R0FFRztBQUNILE1BQWEsaUJBQWlCO0lBQ1gsY0FBYyxDQUFTO0lBQ3ZCLGVBQWUsQ0FBUztJQUN4QixTQUFTLEdBQUcsYUFBYSxDQUFDO0lBQ25DLGNBQWMsR0FBa0IsSUFBSSxDQUFDO0lBRTdDO1FBQ0UsSUFBSSxDQUFDLGNBQWMsR0FBRyxJQUFBLFdBQUksRUFBQyxJQUFBLFlBQU8sR0FBRSxFQUFFLGdCQUFnQixDQUFDLENBQUM7UUFDeEQsSUFBSSxDQUFDLGVBQWUsR0FBRyxJQUFBLFdBQUksRUFBQyxJQUFJLENBQUMsY0FBYyxFQUFFLGFBQWEsQ0FBQyxDQUFDO1FBRWhFLHNDQUFzQztRQUN0QyxJQUFJLENBQUMsSUFBQSxlQUFVLEVBQUMsSUFBSSxDQUFDLGNBQWMsQ0FBQyxFQUFFLENBQUM7WUFDckMsSUFBQSxjQUFTLEVBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxFQUFFLFNBQVMsRUFBRSxJQUFJLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxDQUFDLENBQUM7UUFDbkUsQ0FBQztJQUNILENBQUM7SUFFRDs7T0FFRztJQUNILGlCQUFpQixDQUFDLFFBQWlCO1FBQ2pDLElBQUksUUFBUSxFQUFFLENBQUM7WUFDYixJQUFJLENBQUMsY0FBYyxHQUFHLFFBQVEsQ0FBQztRQUNqQyxDQUFDO2FBQU0sQ0FBQztZQUNOLHVDQUF1QztZQUN2QyxJQUFJLENBQUMsY0FBYyxHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMscUJBQXFCLElBQUksSUFBSSxDQUFDO1lBRWhFLElBQUksQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7Z0JBQ3pCLE1BQU0sSUFBSSxLQUFLLENBQUMseUdBQXlHLENBQUMsQ0FBQztZQUM3SCxDQUFDO1FBQ0gsQ0FBQztJQUNILENBQUM7SUFFRDs7O09BR0c7SUFDSCxlQUFlLENBQUMsV0FBZ0M7UUFDOUMsSUFBSSxDQUFDLElBQUksQ0FBQyxjQUFjLEVBQUUsQ0FBQztZQUN6QixNQUFNLElBQUksS0FBSyxDQUFDLDBEQUEwRCxDQUFDLENBQUM7UUFDOUUsQ0FBQztRQUVELElBQUksQ0FBQztZQUNILHFDQUFxQztZQUNyQyxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDekQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztnQkFDeEIsTUFBTSxJQUFJLEtBQUssQ0FBQyx3QkFBd0IsVUFBVSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQzFFLENBQUM7WUFFRCx1QkFBdUI7WUFDdkIsTUFBTSxJQUFJLEdBQUcsSUFBQSxvQkFBVyxFQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQzdCLE1BQU0sRUFBRSxHQUFHLElBQUEsb0JBQVcsRUFBQyxFQUFFLENBQUMsQ0FBQztZQUUzQiwrQ0FBK0M7WUFDL0MsTUFBTSxHQUFHLEdBQUcsSUFBSSxDQUFDLFNBQVMsQ0FBQyxJQUFJLENBQUMsY0FBYyxFQUFFLElBQUksQ0FBQyxDQUFDO1lBRXRELGdCQUFnQjtZQUNoQixNQUFNLE1BQU0sR0FBRyxJQUFBLHVCQUFjLEVBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSxHQUFHLEVBQUUsRUFBRSxDQUFDLENBQUM7WUFFdkQsc0JBQXNCO1lBQ3RCLE1BQU0sZUFBZSxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDcEQsSUFBSSxTQUFTLEdBQUcsTUFBTSxDQUFDLE1BQU0sQ0FBQyxlQUFlLEVBQUUsTUFBTSxFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQzlELFNBQVMsSUFBSSxNQUFNLENBQUMsS0FBSyxDQUFDLEtBQUssQ0FBQyxDQUFDO1lBRWpDLGtDQUFrQztZQUNsQyxNQUFNLGFBQWEsR0FBeUI7Z0JBQzFDLElBQUksRUFBRSxTQUFTO2dCQUNmLEVBQUUsRUFBRSxFQUFFLENBQUMsUUFBUSxDQUFDLEtBQUssQ0FBQztnQkFDdEIsSUFBSSxFQUFFLElBQUksQ0FBQyxRQUFRLENBQUMsS0FBSyxDQUFDO2dCQUMxQixPQUFPLEVBQUUsQ0FBQztnQkFDVixTQUFTLEVBQUUsSUFBSSxDQUFDLEdBQUcsRUFBRTthQUN0QixDQUFDO1lBRUYsNENBQTRDO1lBQzVDLElBQUEsa0JBQWEsRUFBQyxJQUFJLENBQUMsZUFBZSxFQUFFLElBQUksQ0FBQyxTQUFTLENBQUMsYUFBYSxFQUFFLElBQUksRUFBRSxDQUFDLENBQUMsRUFBRTtnQkFDMUUsUUFBUSxFQUFFLE1BQU07Z0JBQ2hCLElBQUksRUFBRSxLQUFLLENBQUMsNEJBQTRCO2FBQ3pDLENBQUMsQ0FBQztZQUVILE9BQU8sQ0FBQyxHQUFHLENBQUMsbUNBQW1DLENBQUMsQ0FBQztRQUVuRCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsK0JBQStCLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFDdEQsTUFBTSxLQUFLLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztJQUVEOzs7T0FHRztJQUNILGVBQWU7UUFDYixJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQ3pCLE1BQU0sSUFBSSxLQUFLLENBQUMsMERBQTBELENBQUMsQ0FBQztRQUM5RSxDQUFDO1FBRUQsSUFBSSxDQUFDLElBQUEsZUFBVSxFQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsRUFBRSxDQUFDO1lBQ3RDLE1BQU0sSUFBSSxLQUFLLENBQUMsNEVBQTRFLENBQUMsQ0FBQztRQUNoRyxDQUFDO1FBRUQsSUFBSSxDQUFDO1lBQ0gsc0JBQXNCO1lBQ3RCLE1BQU0sV0FBVyxHQUFHLElBQUEsaUJBQVksRUFBQyxJQUFJLENBQUMsZUFBZSxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQy9ELE1BQU0sYUFBYSxHQUF5QixJQUFJLENBQUMsS0FBSyxDQUFDLFdBQVcsQ0FBQyxDQUFDO1lBRXBFLHFCQUFxQjtZQUNyQixNQUFNLGFBQWEsR0FBRyxhQUFhLENBQUMsSUFBSSxDQUFDO1lBQ3pDLE1BQU0sRUFBRSxHQUFHLE1BQU0sQ0FBQyxJQUFJLENBQUMsYUFBYSxDQUFDLEVBQUUsRUFBRSxLQUFLLENBQUMsQ0FBQztZQUNoRCxNQUFNLElBQUksR0FBRyxNQUFNLENBQUMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLEVBQUUsS0FBSyxDQUFDLENBQUM7WUFFcEQsa0NBQWtDO1lBQ2xDLE1BQU0sR0FBRyxHQUFHLElBQUksQ0FBQyxTQUFTLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxJQUFJLENBQUMsQ0FBQztZQUV0RCxrQkFBa0I7WUFDbEIsTUFBTSxRQUFRLEdBQUcsSUFBQSx5QkFBZ0IsRUFBQyxJQUFJLENBQUMsU0FBUyxFQUFFLEdBQUcsRUFBRSxFQUFFLENBQUMsQ0FBQztZQUUzRCxzQkFBc0I7WUFDdEIsSUFBSSxTQUFTLEdBQUcsUUFBUSxDQUFDLE1BQU0sQ0FBQyxhQUFhLEVBQUUsS0FBSyxFQUFFLE1BQU0sQ0FBQyxDQUFDO1lBQzlELFNBQVMsSUFBSSxRQUFRLENBQUMsS0FBSyxDQUFDLE1BQU0sQ0FBQyxDQUFDO1lBRXBDLDJDQUEyQztZQUMzQyxNQUFNLFdBQVcsR0FBd0IsSUFBSSxDQUFDLEtBQUssQ0FBQyxTQUFTLENBQUMsQ0FBQztZQUUvRCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsbUJBQW1CLENBQUMsV0FBVyxDQUFDLENBQUM7WUFDekQsSUFBSSxDQUFDLFVBQVUsQ0FBQyxPQUFPLEVBQUUsQ0FBQztnQkFDeEIsTUFBTSxJQUFJLEtBQUssQ0FBQywwQkFBMEIsVUFBVSxDQUFDLE1BQU0sQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEVBQUUsQ0FBQyxDQUFDO1lBQzVFLENBQUM7WUFFRCxPQUFPLENBQUMsR0FBRyxDQUFDLG9DQUFvQyxDQUFDLENBQUM7WUFDbEQsT0FBTyxXQUFXLENBQUM7UUFFckIsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixPQUFPLENBQUMsS0FBSyxDQUFDLCtCQUErQixFQUFFLEtBQUssQ0FBQyxDQUFDO1lBQ3RELE1BQU0sSUFBSSxLQUFLLENBQUMsMEVBQTBFLENBQUMsQ0FBQztRQUM5RixDQUFDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0gsY0FBYztRQUNaLE9BQU8sSUFBQSxlQUFVLEVBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxDQUFDO0lBQzFDLENBQUM7SUFFRDs7T0FFRztJQUNILGlCQUFpQjtRQUNmLElBQUksSUFBQSxlQUFVLEVBQUMsSUFBSSxDQUFDLGVBQWUsQ0FBQyxFQUFFLENBQUM7WUFDckMsSUFBSSxDQUFDO2dCQUNILGtFQUFrRTtnQkFDbEUsTUFBTSxRQUFRLEdBQUcsSUFBQSxpQkFBWSxFQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQyxNQUFNLENBQUM7Z0JBQzNELE1BQU0sVUFBVSxHQUFHLElBQUEsb0JBQVcsRUFBQyxRQUFRLENBQUMsQ0FBQztnQkFDekMsSUFBQSxrQkFBYSxFQUFDLElBQUksQ0FBQyxlQUFlLEVBQUUsVUFBVSxDQUFDLENBQUM7Z0JBRWhELGNBQWM7Z0JBQ2QsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLFVBQVUsQ0FBQyxJQUFJLENBQUMsZUFBZSxDQUFDLENBQUM7Z0JBRS9DLE9BQU8sQ0FBQyxHQUFHLENBQUMsc0NBQXNDLENBQUMsQ0FBQztZQUN0RCxDQUFDO1lBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztnQkFDZixPQUFPLENBQUMsS0FBSyxDQUFDLGlDQUFpQyxFQUFFLEtBQUssQ0FBQyxDQUFDO2dCQUN4RCxNQUFNLEtBQUssQ0FBQztZQUNkLENBQUM7UUFDSCxDQUFDO0lBQ0gsQ0FBQztJQUVEOztPQUVHO0lBQ0gseUJBQXlCLENBQUMsUUFBNkIsRUFBRSxNQUFjLEVBQUUsU0FBaUI7UUFDeEYsSUFBSSxXQUFnQyxDQUFDO1FBRXJDLElBQUksQ0FBQztZQUNILDRCQUE0QjtZQUM1QixXQUFXLEdBQUcsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1FBQ3ZDLENBQUM7UUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1lBQ2YsOEVBQThFO1lBQzlFLFdBQVcsR0FBRztnQkFDWixPQUFPLEVBQUU7b0JBQ1AsTUFBTSxFQUFFLHNDQUFzQztvQkFDOUMsU0FBUyxFQUFFLHdFQUF3RTtpQkFDcEY7Z0JBQ0QsS0FBSyxFQUFFO29CQUNMLE1BQU0sRUFBRSw4QkFBOEI7b0JBQ3RDLFNBQVMsRUFBRSxpREFBaUQ7aUJBQzdEO2FBQ0YsQ0FBQztRQUNKLENBQUM7UUFFRCwyQkFBMkI7UUFDM0IsV0FBVyxDQUFDLFFBQVEsQ0FBQyxHQUFHLEVBQUUsTUFBTSxFQUFFLFNBQVMsRUFBRSxDQUFDO1FBRTlDLDJCQUEyQjtRQUMzQixJQUFJLENBQUMsZUFBZSxDQUFDLFdBQVcsQ0FBQyxDQUFDO0lBQ3BDLENBQUM7SUFFRDs7T0FFRztJQUNILHNCQUFzQixDQUFDLFFBQTZCO1FBQ2xELE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUMzQyxPQUFPLFdBQVcsQ0FBQyxRQUFRLENBQUMsQ0FBQztJQUMvQixDQUFDO0lBRUQ7O09BRUc7SUFDSyxtQkFBbUIsQ0FBQyxXQUFnQztRQUMxRCxNQUFNLE1BQU0sR0FBYSxFQUFFLENBQUM7UUFDNUIsTUFBTSxRQUFRLEdBQWEsRUFBRSxDQUFDO1FBRTlCLGtCQUFrQjtRQUNsQixJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7WUFDakIsTUFBTSxDQUFDLElBQUksQ0FBQyx5Q0FBeUMsQ0FBQyxDQUFDO1lBQ3ZELE9BQU8sRUFBRSxPQUFPLEVBQUUsS0FBSyxFQUFFLE1BQU0sRUFBRSxRQUFRLEVBQUUsQ0FBQztRQUM5QyxDQUFDO1FBRUQsK0JBQStCO1FBQy9CLElBQUksQ0FBQyxXQUFXLENBQUMsT0FBTyxFQUFFLENBQUM7WUFDekIsTUFBTSxDQUFDLElBQUksQ0FBQyw2QkFBNkIsQ0FBQyxDQUFDO1FBQzdDLENBQUM7YUFBTSxDQUFDO1lBQ04sSUFBSSxDQUFDLFdBQVcsQ0FBQyxPQUFPLENBQUMsTUFBTSxJQUFJLFdBQVcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRSxDQUFDO2dCQUM1RSxNQUFNLENBQUMsSUFBSSxDQUFDLDBCQUEwQixDQUFDLENBQUM7WUFDMUMsQ0FBQztpQkFBTSxJQUFJLFdBQVcsQ0FBQyxPQUFPLENBQUMsTUFBTSxDQUFDLE1BQU0sR0FBRyxFQUFFLEVBQUUsQ0FBQztnQkFDbEQsUUFBUSxDQUFDLElBQUksQ0FBQyxpQ0FBaUMsQ0FBQyxDQUFDO1lBQ25ELENBQUM7WUFFRCxJQUFJLENBQUMsV0FBVyxDQUFDLE9BQU8sQ0FBQyxTQUFTLElBQUksV0FBVyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFLENBQUM7Z0JBQ2xGLE1BQU0sQ0FBQyxJQUFJLENBQUMsNkJBQTZCLENBQUMsQ0FBQztZQUM3QyxDQUFDO2lCQUFNLElBQUksV0FBVyxDQUFDLE9BQU8sQ0FBQyxTQUFTLENBQUMsTUFBTSxHQUFHLEVBQUUsRUFBRSxDQUFDO2dCQUNyRCxRQUFRLENBQUMsSUFBSSxDQUFDLG9DQUFvQyxDQUFDLENBQUM7WUFDdEQsQ0FBQztRQUNILENBQUM7UUFFRCw2QkFBNkI7UUFDN0IsSUFBSSxDQUFDLFdBQVcsQ0FBQyxLQUFLLEVBQUUsQ0FBQztZQUN2QixNQUFNLENBQUMsSUFBSSxDQUFDLDJCQUEyQixDQUFDLENBQUM7UUFDM0MsQ0FBQzthQUFNLENBQUM7WUFDTixJQUFJLENBQUMsV0FBVyxDQUFDLEtBQUssQ0FBQyxNQUFNLElBQUksV0FBVyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFLENBQUM7Z0JBQ3hFLE1BQU0sQ0FBQyxJQUFJLENBQUMsd0JBQXdCLENBQUMsQ0FBQztZQUN4QyxDQUFDO2lCQUFNLElBQUksV0FBVyxDQUFDLEtBQUssQ0FBQyxNQUFNLENBQUMsTUFBTSxHQUFHLEVBQUUsRUFBRSxDQUFDO2dCQUNoRCxRQUFRLENBQUMsSUFBSSxDQUFDLCtCQUErQixDQUFDLENBQUM7WUFDakQsQ0FBQztZQUVELElBQUksQ0FBQyxXQUFXLENBQUMsS0FBSyxDQUFDLFNBQVMsSUFBSSxXQUFXLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUUsQ0FBQztnQkFDOUUsTUFBTSxDQUFDLElBQUksQ0FBQywyQkFBMkIsQ0FBQyxDQUFDO1lBQzNDLENBQUM7aUJBQU0sSUFBSSxXQUFXLENBQUMsS0FBSyxDQUFDLFNBQVMsQ0FBQyxNQUFNLEdBQUcsRUFBRSxFQUFFLENBQUM7Z0JBQ25ELFFBQVEsQ0FBQyxJQUFJLENBQUMsa0NBQWtDLENBQUMsQ0FBQztZQUNwRCxDQUFDO1FBQ0gsQ0FBQztRQUVELE9BQU87WUFDTCxPQUFPLEVBQUUsTUFBTSxDQUFDLE1BQU0sS0FBSyxDQUFDO1lBQzVCLE1BQU07WUFDTixRQUFRO1NBQ1QsQ0FBQztJQUNKLENBQUM7SUFFRDs7T0FFRztJQUNLLFNBQVMsQ0FBQyxRQUFnQixFQUFFLElBQVk7UUFDOUMsT0FBTyxJQUFBLG1CQUFVLEVBQUMsUUFBUSxFQUFFLElBQUksRUFBRSxNQUFNLEVBQUUsRUFBRSxFQUFFLFFBQVEsQ0FBQyxDQUFDO0lBQzFELENBQUM7SUFFRDs7T0FFRztJQUNILGtCQUFrQjtRQUNoQixNQUFNLE1BQU0sR0FBRyxJQUFJLENBQUMsY0FBYyxFQUFFLENBQUM7UUFDckMsTUFBTSxJQUFJLEdBQVE7WUFDaEIsTUFBTTtZQUNOLElBQUksRUFBRSxJQUFJLENBQUMsZUFBZTtTQUMzQixDQUFDO1FBRUYsSUFBSSxNQUFNLEVBQUUsQ0FBQztZQUNYLElBQUksQ0FBQztnQkFDSCxNQUFNLEtBQUssR0FBRyxPQUFPLENBQUMsSUFBSSxDQUFDLENBQUMsUUFBUSxDQUFDLElBQUksQ0FBQyxlQUFlLENBQUMsQ0FBQztnQkFDM0QsSUFBSSxDQUFDLElBQUksR0FBRyxLQUFLLENBQUMsSUFBSSxDQUFDO2dCQUN2QixJQUFJLENBQUMsUUFBUSxHQUFHLEtBQUssQ0FBQyxLQUFLLENBQUM7WUFDOUIsQ0FBQztZQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7Z0JBQ2YscUJBQXFCO1lBQ3ZCLENBQUM7UUFDSCxDQUFDO1FBRUQsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxlQUFlO1FBQ2IsSUFBSSxDQUFDO1lBQ0gsSUFBSSxDQUFDLGVBQWUsRUFBRSxDQUFDO1lBQ3ZCLE9BQU8sSUFBSSxDQUFDO1FBQ2QsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixPQUFPLEtBQUssQ0FBQztRQUNmLENBQUM7SUFDSCxDQUFDO0lBRUQ7O09BRUc7SUFDSCxvQkFBb0IsQ0FBQyxXQUFtQjtRQUN0QyxJQUFJLENBQUMsSUFBSSxDQUFDLGNBQWMsRUFBRSxDQUFDO1lBQ3pCLE1BQU0sSUFBSSxLQUFLLENBQUMsaUNBQWlDLENBQUMsQ0FBQztRQUNyRCxDQUFDO1FBRUQseUNBQXlDO1FBQ3pDLE1BQU0sV0FBVyxHQUFHLElBQUksQ0FBQyxlQUFlLEVBQUUsQ0FBQztRQUUzQyxtQkFBbUI7UUFDbkIsTUFBTSxXQUFXLEdBQUcsSUFBSSxDQUFDLGNBQWMsQ0FBQztRQUN4QyxJQUFJLENBQUMsY0FBYyxHQUFHLFdBQVcsQ0FBQztRQUVsQyxJQUFJLENBQUM7WUFDSCx5QkFBeUI7WUFDekIsSUFBSSxDQUFDLGVBQWUsQ0FBQyxXQUFXLENBQUMsQ0FBQztZQUNsQyxPQUFPLENBQUMsR0FBRyxDQUFDLHlDQUF5QyxDQUFDLENBQUM7UUFDekQsQ0FBQztRQUFDLE9BQU8sS0FBSyxFQUFFLENBQUM7WUFDZixrQ0FBa0M7WUFDbEMsSUFBSSxDQUFDLGNBQWMsR0FBRyxXQUFXLENBQUM7WUFDbEMsTUFBTSxLQUFLLENBQUM7UUFDZCxDQUFDO0lBQ0gsQ0FBQztDQUNGO0FBcFVELDhDQW9VQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvVXNlcnMvaXZhbi9Db2RlL3RyYWRpbmcvdGl0YW4vc2VydmljZXMvdGl0YW4tcGhhc2UyLWh1bnRlci9zcmMvY29uZmlnL0NyZWRlbnRpYWxNYW5hZ2VyLnRzIl0sInNvdXJjZXNDb250ZW50IjpbIi8qKlxuICogQ3JlZGVudGlhbCBNYW5hZ2VyIGZvciBUaXRhbiBQaGFzZSAyIC0gVGhlIEh1bnRlclxuICogXG4gKiBQcm92aWRlcyBzZWN1cmUgY3JlZGVudGlhbCBzdG9yYWdlIHVzaW5nIEFFUy0yNTYtR0NNIGVuY3J5cHRpb24uXG4gKiBDcmVkZW50aWFscyBhcmUgZW5jcnlwdGVkIHdpdGggYSBtYXN0ZXIgcGFzc3dvcmQgYW5kIHN0b3JlZCBpbiB+Ly50aXRhbi1zY2FubmVyL3NlY3JldHMuZW5jXG4gKiBcbiAqIFJlcXVpcmVtZW50czogRW5jcnlwdGVkIGNyZWRlbnRpYWwgc3RvcmFnZVxuICovXG5cbmltcG9ydCB7IGNyZWF0ZUNpcGhlcml2LCBjcmVhdGVEZWNpcGhlcml2LCByYW5kb21CeXRlcywgcGJrZGYyU3luYyB9IGZyb20gJ2NyeXB0byc7XG5pbXBvcnQgeyB3cml0ZUZpbGVTeW5jLCByZWFkRmlsZVN5bmMsIGV4aXN0c1N5bmMsIG1rZGlyU3luYyB9IGZyb20gJ2ZzJztcbmltcG9ydCB7IGpvaW4gfSBmcm9tICdwYXRoJztcbmltcG9ydCB7IGhvbWVkaXIgfSBmcm9tICdvcyc7XG5cbi8qKlxuICogRXhjaGFuZ2UgY3JlZGVudGlhbHMgaW50ZXJmYWNlXG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgRXhjaGFuZ2VDcmVkZW50aWFscyB7XG4gIGJpbmFuY2U6IHtcbiAgICBhcGlLZXk6IHN0cmluZztcbiAgICBhcGlTZWNyZXQ6IHN0cmluZztcbiAgfTtcbiAgYnliaXQ6IHtcbiAgICBhcGlLZXk6IHN0cmluZztcbiAgICBhcGlTZWNyZXQ6IHN0cmluZztcbiAgfTtcbn1cblxuLyoqXG4gKiBFbmNyeXB0ZWQgY3JlZGVudGlhbCBkYXRhIHN0cnVjdHVyZVxuICovXG5pbnRlcmZhY2UgRW5jcnlwdGVkQ3JlZGVudGlhbHMge1xuICBkYXRhOiBzdHJpbmc7XG4gIGl2OiBzdHJpbmc7XG4gIHNhbHQ6IHN0cmluZztcbiAgdmVyc2lvbjogbnVtYmVyO1xuICB0aW1lc3RhbXA6IG51bWJlcjtcbn1cblxuLyoqXG4gKiBDcmVkZW50aWFsIHZhbGlkYXRpb24gcmVzdWx0XG4gKi9cbmV4cG9ydCBpbnRlcmZhY2UgQ3JlZGVudGlhbFZhbGlkYXRpb24ge1xuICBpc1ZhbGlkOiBib29sZWFuO1xuICBlcnJvcnM6IHN0cmluZ1tdO1xuICB3YXJuaW5nczogc3RyaW5nW107XG59XG5cbi8qKlxuICogQ3JlZGVudGlhbCBNYW5hZ2VyIHdpdGggQUVTLTI1Ni1HQ00gZW5jcnlwdGlvblxuICovXG5leHBvcnQgY2xhc3MgQ3JlZGVudGlhbE1hbmFnZXIge1xuICBwcml2YXRlIHJlYWRvbmx5IGNyZWRlbnRpYWxzRGlyOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgY3JlZGVudGlhbHNQYXRoOiBzdHJpbmc7XG4gIHByaXZhdGUgcmVhZG9ubHkgYWxnb3JpdGhtID0gJ2Flcy0yNTYtY2JjJztcbiAgcHJpdmF0ZSBtYXN0ZXJQYXNzd29yZDogc3RyaW5nIHwgbnVsbCA9IG51bGw7XG5cbiAgY29uc3RydWN0b3IoKSB7XG4gICAgdGhpcy5jcmVkZW50aWFsc0RpciA9IGpvaW4oaG9tZWRpcigpLCAnLnRpdGFuLXNjYW5uZXInKTtcbiAgICB0aGlzLmNyZWRlbnRpYWxzUGF0aCA9IGpvaW4odGhpcy5jcmVkZW50aWFsc0RpciwgJ3NlY3JldHMuZW5jJyk7XG4gICAgXG4gICAgLy8gRW5zdXJlIGNyZWRlbnRpYWxzIGRpcmVjdG9yeSBleGlzdHNcbiAgICBpZiAoIWV4aXN0c1N5bmModGhpcy5jcmVkZW50aWFsc0RpcikpIHtcbiAgICAgIG1rZGlyU3luYyh0aGlzLmNyZWRlbnRpYWxzRGlyLCB7IHJlY3Vyc2l2ZTogdHJ1ZSwgbW9kZTogMG83MDAgfSk7XG4gICAgfVxuICB9XG5cbiAgLyoqXG4gICAqIFNldCBtYXN0ZXIgcGFzc3dvcmQgZnJvbSBlbnZpcm9ubWVudCB2YXJpYWJsZSBvciB1c2VyIGlucHV0XG4gICAqL1xuICBzZXRNYXN0ZXJQYXNzd29yZChwYXNzd29yZD86IHN0cmluZyk6IHZvaWQge1xuICAgIGlmIChwYXNzd29yZCkge1xuICAgICAgdGhpcy5tYXN0ZXJQYXNzd29yZCA9IHBhc3N3b3JkO1xuICAgIH0gZWxzZSB7XG4gICAgICAvLyBUcnkgdG8gZ2V0IGZyb20gZW52aXJvbm1lbnQgdmFyaWFibGVcbiAgICAgIHRoaXMubWFzdGVyUGFzc3dvcmQgPSBwcm9jZXNzLmVudi5USVRBTl9NQVNURVJfUEFTU1dPUkQgfHwgbnVsbDtcbiAgICAgIFxuICAgICAgaWYgKCF0aGlzLm1hc3RlclBhc3N3b3JkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignTWFzdGVyIHBhc3N3b3JkIG5vdCBwcm92aWRlZC4gU2V0IFRJVEFOX01BU1RFUl9QQVNTV09SRCBlbnZpcm9ubWVudCB2YXJpYWJsZSBvciBwYXNzIHBhc3N3b3JkIGRpcmVjdGx5LicpO1xuICAgICAgfVxuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBTYXZlIGNyZWRlbnRpYWxzIHdpdGggQUVTLTI1Ni1HQ00gZW5jcnlwdGlvblxuICAgKiBSZXF1aXJlbWVudHM6IEltcGxlbWVudCBzYXZlQ3JlZGVudGlhbHMoKSB3aXRoIEFFUy0yNTYtR0NNIGVuY3J5cHRpb25cbiAgICovXG4gIHNhdmVDcmVkZW50aWFscyhjcmVkZW50aWFsczogRXhjaGFuZ2VDcmVkZW50aWFscyk6IHZvaWQge1xuICAgIGlmICghdGhpcy5tYXN0ZXJQYXNzd29yZCkge1xuICAgICAgdGhyb3cgbmV3IEVycm9yKCdNYXN0ZXIgcGFzc3dvcmQgbm90IHNldC4gQ2FsbCBzZXRNYXN0ZXJQYXNzd29yZCgpIGZpcnN0LicpO1xuICAgIH1cblxuICAgIHRyeSB7XG4gICAgICAvLyBWYWxpZGF0ZSBjcmVkZW50aWFscyBiZWZvcmUgc2F2aW5nXG4gICAgICBjb25zdCB2YWxpZGF0aW9uID0gdGhpcy52YWxpZGF0ZUNyZWRlbnRpYWxzKGNyZWRlbnRpYWxzKTtcbiAgICAgIGlmICghdmFsaWRhdGlvbi5pc1ZhbGlkKSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcihgSW52YWxpZCBjcmVkZW50aWFsczogJHt2YWxpZGF0aW9uLmVycm9ycy5qb2luKCcsICcpfWApO1xuICAgICAgfVxuXG4gICAgICAvLyBHZW5lcmF0ZSBzYWx0IGFuZCBJVlxuICAgICAgY29uc3Qgc2FsdCA9IHJhbmRvbUJ5dGVzKDMyKTtcbiAgICAgIGNvbnN0IGl2ID0gcmFuZG9tQnl0ZXMoMTYpO1xuXG4gICAgICAvLyBEZXJpdmUga2V5IGZyb20gbWFzdGVyIHBhc3N3b3JkIHVzaW5nIFBCS0RGMlxuICAgICAgY29uc3Qga2V5ID0gdGhpcy5kZXJpdmVLZXkodGhpcy5tYXN0ZXJQYXNzd29yZCwgc2FsdCk7XG5cbiAgICAgIC8vIENyZWF0ZSBjaXBoZXJcbiAgICAgIGNvbnN0IGNpcGhlciA9IGNyZWF0ZUNpcGhlcml2KHRoaXMuYWxnb3JpdGhtLCBrZXksIGl2KTtcblxuICAgICAgLy8gRW5jcnlwdCBjcmVkZW50aWFsc1xuICAgICAgY29uc3QgY3JlZGVudGlhbHNKc29uID0gSlNPTi5zdHJpbmdpZnkoY3JlZGVudGlhbHMpO1xuICAgICAgbGV0IGVuY3J5cHRlZCA9IGNpcGhlci51cGRhdGUoY3JlZGVudGlhbHNKc29uLCAndXRmOCcsICdoZXgnKTtcbiAgICAgIGVuY3J5cHRlZCArPSBjaXBoZXIuZmluYWwoJ2hleCcpO1xuXG4gICAgICAvLyBDcmVhdGUgZW5jcnlwdGVkIGRhdGEgc3RydWN0dXJlXG4gICAgICBjb25zdCBlbmNyeXB0ZWREYXRhOiBFbmNyeXB0ZWRDcmVkZW50aWFscyA9IHtcbiAgICAgICAgZGF0YTogZW5jcnlwdGVkLFxuICAgICAgICBpdjogaXYudG9TdHJpbmcoJ2hleCcpLFxuICAgICAgICBzYWx0OiBzYWx0LnRvU3RyaW5nKCdoZXgnKSxcbiAgICAgICAgdmVyc2lvbjogMSxcbiAgICAgICAgdGltZXN0YW1wOiBEYXRlLm5vdygpXG4gICAgICB9O1xuXG4gICAgICAvLyBXcml0ZSB0byBmaWxlIHdpdGggcmVzdHJpY3RlZCBwZXJtaXNzaW9uc1xuICAgICAgd3JpdGVGaWxlU3luYyh0aGlzLmNyZWRlbnRpYWxzUGF0aCwgSlNPTi5zdHJpbmdpZnkoZW5jcnlwdGVkRGF0YSwgbnVsbCwgMiksIHtcbiAgICAgICAgZW5jb2Rpbmc6ICd1dGY4JyxcbiAgICAgICAgbW9kZTogMG82MDAgLy8gUmVhZC93cml0ZSBmb3Igb3duZXIgb25seVxuICAgICAgfSk7XG5cbiAgICAgIGNvbnNvbGUubG9nKCfwn5SQIENyZWRlbnRpYWxzIHNhdmVkIHN1Y2Nlc3NmdWxseScpO1xuXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBGYWlsZWQgdG8gc2F2ZSBjcmVkZW50aWFsczonLCBlcnJvcik7XG4gICAgICB0aHJvdyBlcnJvcjtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogTG9hZCBjcmVkZW50aWFscyB3aXRoIG1hc3RlciBwYXNzd29yZCBkZWNyeXB0aW9uXG4gICAqIFJlcXVpcmVtZW50czogSW1wbGVtZW50IGxvYWRDcmVkZW50aWFscygpIHdpdGggbWFzdGVyIHBhc3N3b3JkIGRlY3J5cHRpb25cbiAgICovXG4gIGxvYWRDcmVkZW50aWFscygpOiBFeGNoYW5nZUNyZWRlbnRpYWxzIHtcbiAgICBpZiAoIXRoaXMubWFzdGVyUGFzc3dvcmQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignTWFzdGVyIHBhc3N3b3JkIG5vdCBzZXQuIENhbGwgc2V0TWFzdGVyUGFzc3dvcmQoKSBmaXJzdC4nKTtcbiAgICB9XG5cbiAgICBpZiAoIWV4aXN0c1N5bmModGhpcy5jcmVkZW50aWFsc1BhdGgpKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ05vIGNyZWRlbnRpYWxzIGZpbGUgZm91bmQuIFNhdmUgY3JlZGVudGlhbHMgZmlyc3QgdXNpbmcgc2F2ZUNyZWRlbnRpYWxzKCkuJyk7XG4gICAgfVxuXG4gICAgdHJ5IHtcbiAgICAgIC8vIFJlYWQgZW5jcnlwdGVkIGZpbGVcbiAgICAgIGNvbnN0IGZpbGVDb250ZW50ID0gcmVhZEZpbGVTeW5jKHRoaXMuY3JlZGVudGlhbHNQYXRoLCAndXRmOCcpO1xuICAgICAgY29uc3QgZW5jcnlwdGVkRGF0YTogRW5jcnlwdGVkQ3JlZGVudGlhbHMgPSBKU09OLnBhcnNlKGZpbGVDb250ZW50KTtcblxuICAgICAgLy8gRXh0cmFjdCBjb21wb25lbnRzXG4gICAgICBjb25zdCBlbmNyeXB0ZWRUZXh0ID0gZW5jcnlwdGVkRGF0YS5kYXRhO1xuICAgICAgY29uc3QgaXYgPSBCdWZmZXIuZnJvbShlbmNyeXB0ZWREYXRhLml2LCAnaGV4Jyk7XG4gICAgICBjb25zdCBzYWx0ID0gQnVmZmVyLmZyb20oZW5jcnlwdGVkRGF0YS5zYWx0LCAnaGV4Jyk7XG5cbiAgICAgIC8vIERlcml2ZSBrZXkgZnJvbSBtYXN0ZXIgcGFzc3dvcmRcbiAgICAgIGNvbnN0IGtleSA9IHRoaXMuZGVyaXZlS2V5KHRoaXMubWFzdGVyUGFzc3dvcmQsIHNhbHQpO1xuXG4gICAgICAvLyBDcmVhdGUgZGVjaXBoZXJcbiAgICAgIGNvbnN0IGRlY2lwaGVyID0gY3JlYXRlRGVjaXBoZXJpdih0aGlzLmFsZ29yaXRobSwga2V5LCBpdik7XG5cbiAgICAgIC8vIERlY3J5cHQgY3JlZGVudGlhbHNcbiAgICAgIGxldCBkZWNyeXB0ZWQgPSBkZWNpcGhlci51cGRhdGUoZW5jcnlwdGVkVGV4dCwgJ2hleCcsICd1dGY4Jyk7XG4gICAgICBkZWNyeXB0ZWQgKz0gZGVjaXBoZXIuZmluYWwoJ3V0ZjgnKTtcblxuICAgICAgLy8gUGFyc2UgYW5kIHZhbGlkYXRlIGRlY3J5cHRlZCBjcmVkZW50aWFsc1xuICAgICAgY29uc3QgY3JlZGVudGlhbHM6IEV4Y2hhbmdlQ3JlZGVudGlhbHMgPSBKU09OLnBhcnNlKGRlY3J5cHRlZCk7XG4gICAgICBcbiAgICAgIGNvbnN0IHZhbGlkYXRpb24gPSB0aGlzLnZhbGlkYXRlQ3JlZGVudGlhbHMoY3JlZGVudGlhbHMpO1xuICAgICAgaWYgKCF2YWxpZGF0aW9uLmlzVmFsaWQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKGBDb3JydXB0ZWQgY3JlZGVudGlhbHM6ICR7dmFsaWRhdGlvbi5lcnJvcnMuam9pbignLCAnKX1gKTtcbiAgICAgIH1cblxuICAgICAgY29uc29sZS5sb2coJ/CflJMgQ3JlZGVudGlhbHMgbG9hZGVkIHN1Y2Nlc3NmdWxseScpO1xuICAgICAgcmV0dXJuIGNyZWRlbnRpYWxzO1xuXG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoJ+KdjCBGYWlsZWQgdG8gbG9hZCBjcmVkZW50aWFsczonLCBlcnJvcik7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoJ0ZhaWxlZCB0byBkZWNyeXB0IGNyZWRlbnRpYWxzLiBDaGVjayBtYXN0ZXIgcGFzc3dvcmQgYW5kIGZpbGUgaW50ZWdyaXR5LicpO1xuICAgIH1cbiAgfVxuXG4gIC8qKlxuICAgKiBDaGVjayBpZiBjcmVkZW50aWFscyBmaWxlIGV4aXN0c1xuICAgKi9cbiAgaGFzQ3JlZGVudGlhbHMoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIGV4aXN0c1N5bmModGhpcy5jcmVkZW50aWFsc1BhdGgpO1xuICB9XG5cbiAgLyoqXG4gICAqIERlbGV0ZSBjcmVkZW50aWFscyBmaWxlXG4gICAqL1xuICBkZWxldGVDcmVkZW50aWFscygpOiB2b2lkIHtcbiAgICBpZiAoZXhpc3RzU3luYyh0aGlzLmNyZWRlbnRpYWxzUGF0aCkpIHtcbiAgICAgIHRyeSB7XG4gICAgICAgIC8vIE92ZXJ3cml0ZSBmaWxlIHdpdGggcmFuZG9tIGRhdGEgYmVmb3JlIGRlbGV0aW9uIChzZWN1cmUgZGVsZXRlKVxuICAgICAgICBjb25zdCBmaWxlU2l6ZSA9IHJlYWRGaWxlU3luYyh0aGlzLmNyZWRlbnRpYWxzUGF0aCkubGVuZ3RoO1xuICAgICAgICBjb25zdCByYW5kb21EYXRhID0gcmFuZG9tQnl0ZXMoZmlsZVNpemUpO1xuICAgICAgICB3cml0ZUZpbGVTeW5jKHRoaXMuY3JlZGVudGlhbHNQYXRoLCByYW5kb21EYXRhKTtcbiAgICAgICAgXG4gICAgICAgIC8vIERlbGV0ZSBmaWxlXG4gICAgICAgIHJlcXVpcmUoJ2ZzJykudW5saW5rU3luYyh0aGlzLmNyZWRlbnRpYWxzUGF0aCk7XG4gICAgICAgIFxuICAgICAgICBjb25zb2xlLmxvZygn8J+Xke+4jyBDcmVkZW50aWFscyBkZWxldGVkIHN1Y2Nlc3NmdWxseScpO1xuICAgICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcign4p2MIEZhaWxlZCB0byBkZWxldGUgY3JlZGVudGlhbHM6JywgZXJyb3IpO1xuICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgIH1cbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogVXBkYXRlIHNwZWNpZmljIGV4Y2hhbmdlIGNyZWRlbnRpYWxzXG4gICAqL1xuICB1cGRhdGVFeGNoYW5nZUNyZWRlbnRpYWxzKGV4Y2hhbmdlOiAnYmluYW5jZScgfCAnYnliaXQnLCBhcGlLZXk6IHN0cmluZywgYXBpU2VjcmV0OiBzdHJpbmcpOiB2b2lkIHtcbiAgICBsZXQgY3JlZGVudGlhbHM6IEV4Y2hhbmdlQ3JlZGVudGlhbHM7XG5cbiAgICB0cnkge1xuICAgICAgLy8gTG9hZCBleGlzdGluZyBjcmVkZW50aWFsc1xuICAgICAgY3JlZGVudGlhbHMgPSB0aGlzLmxvYWRDcmVkZW50aWFscygpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAvLyBJZiBubyBjcmVkZW50aWFscyBleGlzdCwgY3JlYXRlIG5ldyBzdHJ1Y3R1cmUgd2l0aCB2YWxpZCBwbGFjZWhvbGRlciB2YWx1ZXNcbiAgICAgIGNyZWRlbnRpYWxzID0ge1xuICAgICAgICBiaW5hbmNlOiB7IFxuICAgICAgICAgIGFwaUtleTogJ3BsYWNlaG9sZGVyX2JpbmFuY2VfYXBpX2tleV8zMl9jaGFycycsIFxuICAgICAgICAgIGFwaVNlY3JldDogJ3BsYWNlaG9sZGVyX2JpbmFuY2VfYXBpX3NlY3JldF82NF9jaGFyYWN0ZXJzX2xvbmdfZm9yX3Rlc3RpbmdfcHVycG9zZXMnIFxuICAgICAgICB9LFxuICAgICAgICBieWJpdDogeyBcbiAgICAgICAgICBhcGlLZXk6ICdwbGFjZWhvbGRlcl9ieWJpdF9hcGlfa2V5XzI0JywgXG4gICAgICAgICAgYXBpU2VjcmV0OiAncGxhY2Vob2xkZXJfYnliaXRfYXBpX3NlY3JldF80OF9jaGFyYWN0ZXJzX2xvbmcnIFxuICAgICAgICB9XG4gICAgICB9O1xuICAgIH1cblxuICAgIC8vIFVwZGF0ZSBzcGVjaWZpYyBleGNoYW5nZVxuICAgIGNyZWRlbnRpYWxzW2V4Y2hhbmdlXSA9IHsgYXBpS2V5LCBhcGlTZWNyZXQgfTtcblxuICAgIC8vIFNhdmUgdXBkYXRlZCBjcmVkZW50aWFsc1xuICAgIHRoaXMuc2F2ZUNyZWRlbnRpYWxzKGNyZWRlbnRpYWxzKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY3JlZGVudGlhbHMgZm9yIHNwZWNpZmljIGV4Y2hhbmdlXG4gICAqL1xuICBnZXRFeGNoYW5nZUNyZWRlbnRpYWxzKGV4Y2hhbmdlOiAnYmluYW5jZScgfCAnYnliaXQnKTogeyBhcGlLZXk6IHN0cmluZzsgYXBpU2VjcmV0OiBzdHJpbmcgfSB7XG4gICAgY29uc3QgY3JlZGVudGlhbHMgPSB0aGlzLmxvYWRDcmVkZW50aWFscygpO1xuICAgIHJldHVybiBjcmVkZW50aWFsc1tleGNoYW5nZV07XG4gIH1cblxuICAvKipcbiAgICogVmFsaWRhdGUgY3JlZGVudGlhbHMgc3RydWN0dXJlIGFuZCBjb250ZW50XG4gICAqL1xuICBwcml2YXRlIHZhbGlkYXRlQ3JlZGVudGlhbHMoY3JlZGVudGlhbHM6IEV4Y2hhbmdlQ3JlZGVudGlhbHMpOiBDcmVkZW50aWFsVmFsaWRhdGlvbiB7XG4gICAgY29uc3QgZXJyb3JzOiBzdHJpbmdbXSA9IFtdO1xuICAgIGNvbnN0IHdhcm5pbmdzOiBzdHJpbmdbXSA9IFtdO1xuXG4gICAgLy8gQ2hlY2sgc3RydWN0dXJlXG4gICAgaWYgKCFjcmVkZW50aWFscykge1xuICAgICAgZXJyb3JzLnB1c2goJ0NyZWRlbnRpYWxzIG9iamVjdCBpcyBudWxsIG9yIHVuZGVmaW5lZCcpO1xuICAgICAgcmV0dXJuIHsgaXNWYWxpZDogZmFsc2UsIGVycm9ycywgd2FybmluZ3MgfTtcbiAgICB9XG5cbiAgICAvLyBWYWxpZGF0ZSBCaW5hbmNlIGNyZWRlbnRpYWxzXG4gICAgaWYgKCFjcmVkZW50aWFscy5iaW5hbmNlKSB7XG4gICAgICBlcnJvcnMucHVzaCgnTWlzc2luZyBCaW5hbmNlIGNyZWRlbnRpYWxzJyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIGlmICghY3JlZGVudGlhbHMuYmluYW5jZS5hcGlLZXkgfHwgY3JlZGVudGlhbHMuYmluYW5jZS5hcGlLZXkudHJpbSgpID09PSAnJykge1xuICAgICAgICBlcnJvcnMucHVzaCgnQmluYW5jZSBBUEkga2V5IGlzIGVtcHR5Jyk7XG4gICAgICB9IGVsc2UgaWYgKGNyZWRlbnRpYWxzLmJpbmFuY2UuYXBpS2V5Lmxlbmd0aCA8IDMyKSB7XG4gICAgICAgIHdhcm5pbmdzLnB1c2goJ0JpbmFuY2UgQVBJIGtleSBzZWVtcyB0b28gc2hvcnQnKTtcbiAgICAgIH1cblxuICAgICAgaWYgKCFjcmVkZW50aWFscy5iaW5hbmNlLmFwaVNlY3JldCB8fCBjcmVkZW50aWFscy5iaW5hbmNlLmFwaVNlY3JldC50cmltKCkgPT09ICcnKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKCdCaW5hbmNlIEFQSSBzZWNyZXQgaXMgZW1wdHknKTtcbiAgICAgIH0gZWxzZSBpZiAoY3JlZGVudGlhbHMuYmluYW5jZS5hcGlTZWNyZXQubGVuZ3RoIDwgMzIpIHtcbiAgICAgICAgd2FybmluZ3MucHVzaCgnQmluYW5jZSBBUEkgc2VjcmV0IHNlZW1zIHRvbyBzaG9ydCcpO1xuICAgICAgfVxuICAgIH1cblxuICAgIC8vIFZhbGlkYXRlIEJ5Yml0IGNyZWRlbnRpYWxzXG4gICAgaWYgKCFjcmVkZW50aWFscy5ieWJpdCkge1xuICAgICAgZXJyb3JzLnB1c2goJ01pc3NpbmcgQnliaXQgY3JlZGVudGlhbHMnKTtcbiAgICB9IGVsc2Uge1xuICAgICAgaWYgKCFjcmVkZW50aWFscy5ieWJpdC5hcGlLZXkgfHwgY3JlZGVudGlhbHMuYnliaXQuYXBpS2V5LnRyaW0oKSA9PT0gJycpIHtcbiAgICAgICAgZXJyb3JzLnB1c2goJ0J5Yml0IEFQSSBrZXkgaXMgZW1wdHknKTtcbiAgICAgIH0gZWxzZSBpZiAoY3JlZGVudGlhbHMuYnliaXQuYXBpS2V5Lmxlbmd0aCA8IDE2KSB7XG4gICAgICAgIHdhcm5pbmdzLnB1c2goJ0J5Yml0IEFQSSBrZXkgc2VlbXMgdG9vIHNob3J0Jyk7XG4gICAgICB9XG5cbiAgICAgIGlmICghY3JlZGVudGlhbHMuYnliaXQuYXBpU2VjcmV0IHx8IGNyZWRlbnRpYWxzLmJ5Yml0LmFwaVNlY3JldC50cmltKCkgPT09ICcnKSB7XG4gICAgICAgIGVycm9ycy5wdXNoKCdCeWJpdCBBUEkgc2VjcmV0IGlzIGVtcHR5Jyk7XG4gICAgICB9IGVsc2UgaWYgKGNyZWRlbnRpYWxzLmJ5Yml0LmFwaVNlY3JldC5sZW5ndGggPCAxNikge1xuICAgICAgICB3YXJuaW5ncy5wdXNoKCdCeWJpdCBBUEkgc2VjcmV0IHNlZW1zIHRvbyBzaG9ydCcpO1xuICAgICAgfVxuICAgIH1cblxuICAgIHJldHVybiB7XG4gICAgICBpc1ZhbGlkOiBlcnJvcnMubGVuZ3RoID09PSAwLFxuICAgICAgZXJyb3JzLFxuICAgICAgd2FybmluZ3NcbiAgICB9O1xuICB9XG5cbiAgLyoqXG4gICAqIERlcml2ZSBlbmNyeXB0aW9uIGtleSBmcm9tIG1hc3RlciBwYXNzd29yZCB1c2luZyBQQktERjJcbiAgICovXG4gIHByaXZhdGUgZGVyaXZlS2V5KHBhc3N3b3JkOiBzdHJpbmcsIHNhbHQ6IEJ1ZmZlcik6IEJ1ZmZlciB7XG4gICAgcmV0dXJuIHBia2RmMlN5bmMocGFzc3dvcmQsIHNhbHQsIDEwMDAwMCwgMzIsICdzaGEyNTYnKTtcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgY3JlZGVudGlhbHMgZmlsZSBpbmZvXG4gICAqL1xuICBnZXRDcmVkZW50aWFsc0luZm8oKTogeyBleGlzdHM6IGJvb2xlYW47IHBhdGg6IHN0cmluZzsgc2l6ZT86IG51bWJlcjsgbW9kaWZpZWQ/OiBEYXRlIH0ge1xuICAgIGNvbnN0IGV4aXN0cyA9IHRoaXMuaGFzQ3JlZGVudGlhbHMoKTtcbiAgICBjb25zdCBpbmZvOiBhbnkgPSB7XG4gICAgICBleGlzdHMsXG4gICAgICBwYXRoOiB0aGlzLmNyZWRlbnRpYWxzUGF0aFxuICAgIH07XG5cbiAgICBpZiAoZXhpc3RzKSB7XG4gICAgICB0cnkge1xuICAgICAgICBjb25zdCBzdGF0cyA9IHJlcXVpcmUoJ2ZzJykuc3RhdFN5bmModGhpcy5jcmVkZW50aWFsc1BhdGgpO1xuICAgICAgICBpbmZvLnNpemUgPSBzdGF0cy5zaXplO1xuICAgICAgICBpbmZvLm1vZGlmaWVkID0gc3RhdHMubXRpbWU7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICAvLyBJZ25vcmUgc3RhdCBlcnJvcnNcbiAgICAgIH1cbiAgICB9XG5cbiAgICByZXR1cm4gaW5mbztcbiAgfVxuXG4gIC8qKlxuICAgKiBUZXN0IGNyZWRlbnRpYWxzIGJ5IGF0dGVtcHRpbmcgdG8gZGVjcnlwdFxuICAgKi9cbiAgdGVzdENyZWRlbnRpYWxzKCk6IGJvb2xlYW4ge1xuICAgIHRyeSB7XG4gICAgICB0aGlzLmxvYWRDcmVkZW50aWFscygpO1xuICAgICAgcmV0dXJuIHRydWU7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIHJldHVybiBmYWxzZTtcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogQ2hhbmdlIG1hc3RlciBwYXNzd29yZCAocmUtZW5jcnlwdCB3aXRoIG5ldyBwYXNzd29yZClcbiAgICovXG4gIGNoYW5nZU1hc3RlclBhc3N3b3JkKG5ld1Bhc3N3b3JkOiBzdHJpbmcpOiB2b2lkIHtcbiAgICBpZiAoIXRoaXMubWFzdGVyUGFzc3dvcmQpIHtcbiAgICAgIHRocm93IG5ldyBFcnJvcignQ3VycmVudCBtYXN0ZXIgcGFzc3dvcmQgbm90IHNldCcpO1xuICAgIH1cblxuICAgIC8vIExvYWQgY3JlZGVudGlhbHMgd2l0aCBjdXJyZW50IHBhc3N3b3JkXG4gICAgY29uc3QgY3JlZGVudGlhbHMgPSB0aGlzLmxvYWRDcmVkZW50aWFscygpO1xuXG4gICAgLy8gU2V0IG5ldyBwYXNzd29yZFxuICAgIGNvbnN0IG9sZFBhc3N3b3JkID0gdGhpcy5tYXN0ZXJQYXNzd29yZDtcbiAgICB0aGlzLm1hc3RlclBhc3N3b3JkID0gbmV3UGFzc3dvcmQ7XG5cbiAgICB0cnkge1xuICAgICAgLy8gU2F2ZSB3aXRoIG5ldyBwYXNzd29yZFxuICAgICAgdGhpcy5zYXZlQ3JlZGVudGlhbHMoY3JlZGVudGlhbHMpO1xuICAgICAgY29uc29sZS5sb2coJ/CflJAgTWFzdGVyIHBhc3N3b3JkIGNoYW5nZWQgc3VjY2Vzc2Z1bGx5Jyk7XG4gICAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICAgIC8vIFJlc3RvcmUgb2xkIHBhc3N3b3JkIG9uIGZhaWx1cmVcbiAgICAgIHRoaXMubWFzdGVyUGFzc3dvcmQgPSBvbGRQYXNzd29yZDtcbiAgICAgIHRocm93IGVycm9yO1xuICAgIH1cbiAgfVxufSJdLCJ2ZXJzaW9uIjozfQ==
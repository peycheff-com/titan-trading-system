{"file":"/Users/ivan/Code/trading/titan/services/titan-phase2-hunter/src/engine/FractalMath.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-phase2-hunter/src/engine/FractalMath.ts"],"sourcesContent":["/**\n * FractalMath Engine - Pure Calculation Functions\n * \n * Implements Bill Williams fractal detection and market structure analysis\n * using Float64Array for performance optimization.\n * \n * Core Functions:\n * - detectFractals(): 5-candle pattern detection\n * - detectBOS(): Break of Structure detection\n * - detectMSS(): Market Structure Shift detection\n * - calcDealingRange(): Premium/Discount zone calculation\n * - getTrendState(): BULL/BEAR/RANGE classification\n */\n\nimport { OHLCV, Fractal, BOS, MSS, DealingRange, TrendState } from '../types';\n\nexport class FractalMath {\n  /**\n   * Detect Bill Williams fractals using 5-candle pattern\n   * A fractal high requires the middle candle's high to be higher than 2 candles on each side\n   * A fractal low requires the middle candle's low to be lower than 2 candles on each side\n   * \n   * @param candles - OHLCV array (minimum 5 candles required)\n   * @returns Array of detected fractals\n   */\n  static detectFractals(candles: OHLCV[]): Fractal[] {\n    const fractals: Fractal[] = [];\n    \n    // Need at least 5 candles for fractal detection\n    if (candles.length < 5) {\n      return fractals;\n    }\n    \n    // Use Float64Array for performance optimization\n    const highs = new Float64Array(candles.map(c => c.high));\n    const lows = new Float64Array(candles.map(c => c.low));\n    \n    // Start from index 2 (need 2 bars on each side)\n    for (let i = 2; i < candles.length - 2; i++) {\n      const current = candles[i];\n      \n      // Check for Swing High (fractal high)\n      const isSwingHigh = \n        highs[i] > highs[i - 1] &&\n        highs[i] > highs[i - 2] &&\n        highs[i] > highs[i + 1] &&\n        highs[i] > highs[i + 2];\n      \n      if (isSwingHigh) {\n        fractals.push({\n          type: 'HIGH',\n          price: highs[i],\n          barIndex: i,\n          timestamp: current.timestamp,\n          confirmed: true\n        });\n      }\n      \n      // Check for Swing Low (fractal low)\n      const isSwingLow = \n        lows[i] < lows[i - 1] &&\n        lows[i] < lows[i - 2] &&\n        lows[i] < lows[i + 1] &&\n        lows[i] < lows[i + 2];\n      \n      if (isSwingLow) {\n        fractals.push({\n          type: 'LOW',\n          price: lows[i],\n          barIndex: i,\n          timestamp: current.timestamp,\n          confirmed: true\n        });\n      }\n    }\n    \n    return fractals;\n  }\n  \n  /**\n   * Detect Break of Structure (BOS)\n   * BOS occurs when price closes beyond a previous fractal swing point\n   * Bullish BOS: Close above last swing high\n   * Bearish BOS: Close below last swing low\n   * \n   * @param candles - OHLCV array\n   * @param fractals - Previously detected fractals\n   * @returns Array of BOS events\n   */\n  static detectBOS(candles: OHLCV[], fractals: Fractal[]): BOS[] {\n    const bosEvents: BOS[] = [];\n    \n    if (candles.length === 0 || fractals.length === 0) {\n      return bosEvents;\n    }\n    \n    // Get most recent swing highs and lows\n    const recentHighs = fractals.filter(f => f.type === 'HIGH');\n    const recentLows = fractals.filter(f => f.type === 'LOW');\n    \n    if (recentHighs.length === 0 && recentLows.length === 0) {\n      return bosEvents;\n    }\n    \n    // Use Float64Array for performance\n    const closes = new Float64Array(candles.map(c => c.close));\n    \n    // Track which fractals have been breached to avoid duplicate BOS events\n    const breachedHighs = new Set<number>();\n    const breachedLows = new Set<number>();\n    \n    // Check each candle for BOS\n    for (let i = 0; i < candles.length; i++) {\n      const candle = candles[i];\n      \n      // Check for bullish BOS against all swing highs\n      for (const swingHigh of recentHighs) {\n        if (i > swingHigh.barIndex && \n            closes[i] > swingHigh.price && \n            !breachedHighs.has(swingHigh.barIndex)) {\n          \n          bosEvents.push({\n            direction: 'BULLISH',\n            price: closes[i],\n            barIndex: i,\n            timestamp: candle.timestamp,\n            fractalsBreached: [swingHigh]\n          });\n          \n          breachedHighs.add(swingHigh.barIndex);\n        }\n      }\n      \n      // Check for bearish BOS against all swing lows\n      for (const swingLow of recentLows) {\n        if (i > swingLow.barIndex && \n            closes[i] < swingLow.price && \n            !breachedLows.has(swingLow.barIndex)) {\n          \n          bosEvents.push({\n            direction: 'BEARISH',\n            price: closes[i],\n            barIndex: i,\n            timestamp: candle.timestamp,\n            fractalsBreached: [swingLow]\n          });\n          \n          breachedLows.add(swingLow.barIndex);\n        }\n      }\n    }\n    \n    return bosEvents;\n  }\n  \n  /**\n   * Detect Market Structure Shift (MSS)\n   * MSS occurs when BOS happens in the opposite direction of the prevailing trend\n   * This signals a potential trend reversal\n   * \n   * @param candles - OHLCV array\n   * @param fractals - Previously detected fractals\n   * @param prevTrend - Previous trend state\n   * @returns MSS event or null\n   */\n  static detectMSS(candles: OHLCV[], fractals: Fractal[], prevTrend: TrendState): MSS | null {\n    const bosEvents = this.detectBOS(candles, fractals);\n    \n    if (bosEvents.length === 0) {\n      return null;\n    }\n    \n    // Get the most recent BOS\n    const lastBOS = bosEvents[bosEvents.length - 1];\n    \n    // MSS occurs when BOS direction opposes prevailing trend\n    if (prevTrend === 'BULL' && lastBOS.direction === 'BEARISH') {\n      return {\n        direction: 'BEARISH',\n        price: lastBOS.price,\n        barIndex: lastBOS.barIndex,\n        timestamp: lastBOS.timestamp,\n        significance: 80 // High significance for trend reversal\n      };\n    }\n    \n    if (prevTrend === 'BEAR' && lastBOS.direction === 'BULLISH') {\n      return {\n        direction: 'BULLISH',\n        price: lastBOS.price,\n        barIndex: lastBOS.barIndex,\n        timestamp: lastBOS.timestamp,\n        significance: 80 // High significance for trend reversal\n      };\n    }\n    \n    return null;\n  }\n  \n  /**\n   * Calculate Dealing Range with Premium/Discount zones\n   * Dealing Range is the current trading range between swing high and swing low\n   * Premium Zone: Above 0.5 Fibonacci (expensive, sell zone for shorts)\n   * Discount Zone: Below 0.5 Fibonacci (cheap, buy zone for longs)\n   * \n   * @param fractals - Array of fractals\n   * @returns DealingRange with premium/discount thresholds\n   */\n  static calcDealingRange(fractals: Fractal[]): DealingRange {\n    // Get most recent swing high and low\n    const recentHighs = fractals.filter(f => f.type === 'HIGH');\n    const recentLows = fractals.filter(f => f.type === 'LOW');\n    \n    if (recentHighs.length === 0 || recentLows.length === 0) {\n      throw new Error('Insufficient fractals to calculate dealing range');\n    }\n    \n    // Use Float64Array for calculations\n    const highPrices = new Float64Array(recentHighs.map(f => f.price));\n    const lowPrices = new Float64Array(recentLows.map(f => f.price));\n    \n    // Find the highest high and lowest low\n    let high = highPrices[0];\n    let low = lowPrices[0];\n    \n    for (let i = 1; i < highPrices.length; i++) {\n      if (highPrices[i] > high) high = highPrices[i];\n    }\n    \n    for (let i = 1; i < lowPrices.length; i++) {\n      if (lowPrices[i] < low) low = lowPrices[i];\n    }\n    \n    const range = high - low;\n    const midpoint = low + (range * 0.5); // 0.5 Fibonacci level (Equilibrium)\n    \n    return {\n      high,\n      low,\n      midpoint,\n      premiumThreshold: midpoint, // Above 0.5 = Premium\n      discountThreshold: midpoint, // Below 0.5 = Discount\n      range\n    };\n  }\n  \n  /**\n   * Determine trend state based on BOS pattern\n   * BULL: Consistent bullish BOS (Higher Highs, Higher Lows)\n   * BEAR: Consistent bearish BOS (Lower Highs, Lower Lows)\n   * RANGE: Mixed BOS or insufficient data\n   * \n   * @param bos - Array of BOS events\n   * @returns Current trend state\n   */\n  static getTrendState(bos: BOS[]): TrendState {\n    if (bos.length < 2) {\n      return 'RANGE';\n    }\n    \n    // Get last 3 BOS events for trend analysis\n    const recentBOS = bos.slice(-3);\n    \n    // Check for consistent bullish BOS\n    const bullishCount = recentBOS.filter(b => b.direction === 'BULLISH').length;\n    const bearishCount = recentBOS.filter(b => b.direction === 'BEARISH').length;\n    \n    // Strong bullish trend: majority bullish BOS\n    if (bullishCount >= 2 && bullishCount > bearishCount) {\n      return 'BULL';\n    }\n    \n    // Strong bearish trend: majority bearish BOS\n    if (bearishCount >= 2 && bearishCount > bullishCount) {\n      return 'BEAR';\n    }\n    \n    // Mixed signals or equal counts = Range\n    return 'RANGE';\n  }\n  \n  /**\n   * Helper method to validate input data\n   * Ensures OHLCV data is properly formatted and sufficient\n   * \n   * @param candles - OHLCV array to validate\n   * @param minLength - Minimum required length\n   * @returns true if valid, throws error if invalid\n   */\n  static validateCandles(candles: OHLCV[], minLength: number = 5): boolean {\n    if (!Array.isArray(candles)) {\n      throw new Error('Candles must be an array');\n    }\n    \n    if (candles.length < minLength) {\n      throw new Error(`Insufficient candles: need at least ${minLength}, got ${candles.length}`);\n    }\n    \n    // Validate each candle has required properties\n    for (let i = 0; i < candles.length; i++) {\n      const candle = candles[i];\n      if (!candle || typeof candle.high !== 'number' || typeof candle.low !== 'number' || \n          typeof candle.close !== 'number' || typeof candle.timestamp !== 'number') {\n        throw new Error(`Invalid candle at index ${i}: missing required properties`);\n      }\n      \n      // Validate OHLC relationships\n      if (candle.high < candle.low) {\n        throw new Error(`Invalid candle at index ${i}: high (${candle.high}) < low (${candle.low})`);\n      }\n      \n      if (candle.close > candle.high || candle.close < candle.low) {\n        throw new Error(`Invalid candle at index ${i}: close (${candle.close}) outside high-low range`);\n      }\n    }\n    \n    return true;\n  }\n  \n  /**\n   * Helper method to get the most recent fractal of a specific type\n   * \n   * @param fractals - Array of fractals\n   * @param type - 'HIGH' or 'LOW'\n   * @returns Most recent fractal of specified type or null\n   */\n  static getLastFractal(fractals: Fractal[], type: 'HIGH' | 'LOW'): Fractal | null {\n    const filtered = fractals.filter(f => f.type === type);\n    return filtered.length > 0 ? filtered[filtered.length - 1] : null;\n  }\n  \n  /**\n   * Helper method to calculate price location within dealing range\n   * \n   * @param price - Current price\n   * @param dealingRange - Dealing range object\n   * @returns 'PREMIUM', 'DISCOUNT', or 'EQUILIBRIUM'\n   */\n  static getPriceLocation(price: number, dealingRange: DealingRange): 'PREMIUM' | 'DISCOUNT' | 'EQUILIBRIUM' {\n    const tolerance = dealingRange.range * 0.05; // 5% tolerance around midpoint\n    \n    if (price > dealingRange.premiumThreshold + tolerance) {\n      return 'PREMIUM';\n    } else if (price < dealingRange.discountThreshold - tolerance) {\n      return 'DISCOUNT';\n    } else {\n      return 'EQUILIBRIUM';\n    }\n  }\n}"],"version":3}
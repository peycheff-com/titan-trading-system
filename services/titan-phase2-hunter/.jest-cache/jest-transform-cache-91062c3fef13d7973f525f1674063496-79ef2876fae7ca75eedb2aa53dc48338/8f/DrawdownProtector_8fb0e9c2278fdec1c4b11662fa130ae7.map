{"file":"/Users/ivan/Code/trading/titan/services/titan-phase2-hunter/src/risk/DrawdownProtector.ts","mappings":"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","names":[],"sources":["/Users/ivan/Code/trading/titan/services/titan-phase2-hunter/src/risk/DrawdownProtector.ts"],"sourcesContent":["/**\n * Drawdown Protector for Titan Phase 2 - The Hunter\n * \n * Provides automatic drawdown protection to preserve capital during adverse conditions:\n * - Daily drawdown thresholds: 3%, 5%, 7%\n * - Weekly drawdown threshold: 10%\n * - Consecutive loss protection: 3 trades\n * - Win rate monitoring: 40% threshold over 20 trades\n * - Emergency flatten at 7% drawdown\n * \n * Requirements: 15.1-15.7 (Drawdown Protection)\n */\n\nimport { EventEmitter } from 'events';\nimport { BybitPerpsClient } from '../exchanges/BybitPerpsClient';\nimport { Position } from '../types';\n\nexport interface DrawdownProtectorConfig {\n  dailyDrawdownThresholds: {\n    level1: number; // 3% - reduce position sizes by 50%\n    level2: number; // 5% - halt new entries\n    level3: number; // 7% - emergency flatten\n  };\n  weeklyDrawdownThreshold: number; // 10% - reduce max leverage\n  consecutiveLossThreshold: number; // 3 trades\n  consecutiveLossReduction: number; // 30% position size reduction\n  winRateThreshold: number; // 40% over 20 trades\n  winRateTradeCount: number; // 20 trades for win rate calculation\n  emergencyPauseDuration: number; // 24 hours in milliseconds\n  leverageReduction: {\n    from: number; // 5x\n    to: number; // 3x\n  };\n}\n\nexport interface TradeRecord {\n  id: string;\n  symbol: string;\n  side: 'LONG' | 'SHORT';\n  entryPrice: number;\n  exitPrice: number;\n  quantity: number;\n  pnl: number;\n  isWin: boolean;\n  timestamp: number;\n}\n\nexport interface DrawdownState {\n  currentEquity: number;\n  startOfDayEquity: number;\n  startOfWeekEquity: number;\n  dailyDrawdown: number; // Percentage\n  weeklyDrawdown: number; // Percentage\n  maxDailyDrawdown: number;\n  maxWeeklyDrawdown: number;\n  consecutiveLosses: number;\n  recentTrades: TradeRecord[];\n  winRate: number;\n  isEmergencyPaused: boolean;\n  emergencyPauseUntil: number;\n  positionSizeReduction: number; // Multiplier (0.5 = 50% reduction)\n  maxLeverageReduction: boolean;\n  lastUpdate: number;\n}\n\nexport interface DrawdownProtectorEvents {\n  'drawdown:level1': (state: DrawdownState) => void; // 3% - reduce position sizes\n  'drawdown:level2': (state: DrawdownState) => void; // 5% - halt new entries\n  'drawdown:level3': (state: DrawdownState) => void; // 7% - emergency flatten\n  'drawdown:weekly': (state: DrawdownState) => void; // 10% - reduce leverage\n  'consecutive:losses': (state: DrawdownState, count: number) => void;\n  'strategy:degradation': (state: DrawdownState, winRate: number) => void;\n  'emergency:paused': (state: DrawdownState, duration: number) => void;\n  'emergency:resumed': (state: DrawdownState) => void;\n  'protection:activated': (state: DrawdownState, action: string) => void;\n}\n\nexport class DrawdownProtector extends EventEmitter {\n  private config: DrawdownProtectorConfig;\n  private bybitClient: BybitPerpsClient;\n  private state: DrawdownState;\n  private monitoringInterval: NodeJS.Timeout | null = null;\n  private readonly MONITORING_FREQUENCY = 30000; // 30 seconds\n\n  constructor(bybitClient: BybitPerpsClient, config?: Partial<DrawdownProtectorConfig>) {\n    super();\n    \n    this.bybitClient = bybitClient;\n    this.config = {\n      dailyDrawdownThresholds: {\n        level1: 0.03, // 3%\n        level2: 0.05, // 5%\n        level3: 0.07  // 7%\n      },\n      weeklyDrawdownThreshold: 0.10, // 10%\n      consecutiveLossThreshold: 3,\n      consecutiveLossReduction: 0.30, // 30% reduction\n      winRateThreshold: 0.40, // 40%\n      winRateTradeCount: 20,\n      emergencyPauseDuration: 24 * 60 * 60 * 1000, // 24 hours\n      leverageReduction: {\n        from: 5,\n        to: 3\n      },\n      ...config\n    };\n\n    // Initialize state\n    this.state = {\n      currentEquity: 0,\n      startOfDayEquity: 0,\n      startOfWeekEquity: 0,\n      dailyDrawdown: 0,\n      weeklyDrawdown: 0,\n      maxDailyDrawdown: 0,\n      maxWeeklyDrawdown: 0,\n      consecutiveLosses: 0,\n      recentTrades: [],\n      winRate: 0,\n      isEmergencyPaused: false,\n      emergencyPauseUntil: 0,\n      positionSizeReduction: 1.0, // No reduction initially\n      maxLeverageReduction: false,\n      lastUpdate: Date.now()\n    };\n\n    this.startMonitoring();\n  }\n\n  /**\n   * Check daily drawdown and apply protection measures\n   * @param currentEquity - Current account equity\n   * @returns Protection action taken\n   */\n  public async checkDailyDrawdown(currentEquity: number): Promise<string | null> {\n    try {\n      // Update current equity\n      this.state.currentEquity = currentEquity;\n\n      // Reset daily tracking if new day\n      const now = new Date();\n      const lastUpdate = new Date(this.state.lastUpdate);\n      \n      if (now.getDate() !== lastUpdate.getDate() || \n          now.getMonth() !== lastUpdate.getMonth() || \n          now.getFullYear() !== lastUpdate.getFullYear()) {\n        this.state.startOfDayEquity = currentEquity;\n        this.state.dailyDrawdown = 0;\n        console.log(`üìÖ New day detected. Reset daily equity baseline: ${currentEquity.toFixed(2)} USDT`);\n      }\n\n      // Calculate daily drawdown\n      if (this.state.startOfDayEquity > 0) {\n        this.state.dailyDrawdown = (this.state.startOfDayEquity - currentEquity) / this.state.startOfDayEquity;\n        this.state.maxDailyDrawdown = Math.max(this.state.maxDailyDrawdown, this.state.dailyDrawdown);\n      }\n\n      const drawdownPercent = this.state.dailyDrawdown * 100;\n\n      // Check thresholds (in order of severity)\n      if (this.state.dailyDrawdown >= this.config.dailyDrawdownThresholds.level3) {\n        // Level 3: 7% - Emergency flatten and pause\n        if (!this.state.isEmergencyPaused) {\n          console.log(`üö® CRITICAL: Daily drawdown ${drawdownPercent.toFixed(2)}% >= 7%. Emergency flatten triggered!`);\n          \n          this.state.isEmergencyPaused = true;\n          this.state.emergencyPauseUntil = Date.now() + this.config.emergencyPauseDuration;\n          \n          this.emit('drawdown:level3', this.state);\n          this.emit('emergency:paused', this.state, this.config.emergencyPauseDuration);\n          this.logProtectionEvent('EMERGENCY_FLATTEN', drawdownPercent);\n          \n          return 'EMERGENCY_FLATTEN';\n        }\n      } else if (this.state.dailyDrawdown >= this.config.dailyDrawdownThresholds.level2) {\n        // Level 2: 5% - Halt new entries\n        console.log(`‚ö†Ô∏è WARNING: Daily drawdown ${drawdownPercent.toFixed(2)}% >= 5%. Halting new entries.`);\n        \n        this.emit('drawdown:level2', this.state);\n        this.logProtectionEvent('HALT_NEW_ENTRIES', drawdownPercent);\n        \n        return 'HALT_NEW_ENTRIES';\n      } else if (this.state.dailyDrawdown >= this.config.dailyDrawdownThresholds.level1) {\n        // Level 1: 3% - Reduce position sizes by 50%\n        if (this.state.positionSizeReduction === 1.0) {\n          console.log(`‚ö†Ô∏è WARNING: Daily drawdown ${drawdownPercent.toFixed(2)}% >= 3%. Reducing position sizes by 50%.`);\n          \n          this.state.positionSizeReduction = 0.5;\n          this.emit('drawdown:level1', this.state);\n          this.logProtectionEvent('REDUCE_POSITION_SIZES', drawdownPercent);\n          \n          return 'REDUCE_POSITION_SIZES';\n        }\n      } else {\n        // Reset position size reduction if drawdown improves\n        if (this.state.positionSizeReduction < 1.0) {\n          this.state.positionSizeReduction = 1.0;\n          console.log(`‚úÖ Daily drawdown improved to ${drawdownPercent.toFixed(2)}%. Position size reduction lifted.`);\n        }\n      }\n\n      return null;\n    } catch (error) {\n      console.error(`‚ùå Error checking daily drawdown:`, error);\n      return null;\n    }\n  }\n\n  /**\n   * Check weekly drawdown and apply leverage reduction\n   * @param currentEquity - Current account equity\n   * @returns Protection action taken\n   */\n  public async checkWeeklyDrawdown(currentEquity: number): Promise<string | null> {\n    try {\n      // Update current equity\n      this.state.currentEquity = currentEquity;\n\n      // Reset weekly tracking if new week\n      const now = new Date();\n      const lastUpdate = new Date(this.state.lastUpdate);\n      const nowWeek = this.getWeekNumber(now);\n      const lastWeek = this.getWeekNumber(lastUpdate);\n      \n      if (nowWeek !== lastWeek) {\n        this.state.startOfWeekEquity = currentEquity;\n        this.state.weeklyDrawdown = 0;\n        this.state.maxLeverageReduction = false;\n        console.log(`üìÖ New week detected. Reset weekly equity baseline: ${currentEquity.toFixed(2)} USDT`);\n      }\n\n      // Calculate weekly drawdown\n      if (this.state.startOfWeekEquity > 0) {\n        this.state.weeklyDrawdown = (this.state.startOfWeekEquity - currentEquity) / this.state.startOfWeekEquity;\n        this.state.maxWeeklyDrawdown = Math.max(this.state.maxWeeklyDrawdown, this.state.weeklyDrawdown);\n      }\n\n      const drawdownPercent = this.state.weeklyDrawdown * 100;\n\n      // Check weekly threshold\n      if (this.state.weeklyDrawdown >= this.config.weeklyDrawdownThreshold && !this.state.maxLeverageReduction) {\n        console.log(`‚ö†Ô∏è WARNING: Weekly drawdown ${drawdownPercent.toFixed(2)}% >= 10%. Reducing max leverage from ${this.config.leverageReduction.from}x to ${this.config.leverageReduction.to}x.`);\n        \n        this.state.maxLeverageReduction = true;\n        this.emit('drawdown:weekly', this.state);\n        this.logProtectionEvent('REDUCE_MAX_LEVERAGE', drawdownPercent);\n        \n        return 'REDUCE_MAX_LEVERAGE';\n      }\n\n      return null;\n    } catch (error) {\n      console.error(`‚ùå Error checking weekly drawdown:`, error);\n      return null;\n    }\n  }\n\n  /**\n   * Check for consecutive losses and apply position size reduction\n   * @param trades - Recent trade records\n   * @returns Protection action taken\n   */\n  public checkConsecutiveLosses(trades: TradeRecord[]): string | null {\n    try {\n      // Sort trades by timestamp (most recent first)\n      const sortedTrades = trades.sort((a, b) => b.timestamp - a.timestamp);\n      \n      // Count consecutive losses from most recent trades\n      let consecutiveLosses = 0;\n      for (const trade of sortedTrades) {\n        if (!trade.isWin) {\n          consecutiveLosses++;\n        } else {\n          break; // Stop at first win\n        }\n      }\n\n      this.state.consecutiveLosses = consecutiveLosses;\n\n      // Check threshold\n      if (consecutiveLosses >= this.config.consecutiveLossThreshold) {\n        console.log(`‚ö†Ô∏è WARNING: ${consecutiveLosses} consecutive losses detected. Reducing position sizes by ${this.config.consecutiveLossReduction * 100}% for next 3 trades.`);\n        \n        // Apply additional reduction for consecutive losses\n        const reductionMultiplier = 1 - this.config.consecutiveLossReduction;\n        this.state.positionSizeReduction = Math.min(this.state.positionSizeReduction, reductionMultiplier);\n        \n        this.emit('consecutive:losses', this.state, consecutiveLosses);\n        this.logProtectionEvent('CONSECUTIVE_LOSSES', consecutiveLosses);\n        \n        return 'CONSECUTIVE_LOSSES';\n      }\n\n      return null;\n    } catch (error) {\n      console.error(`‚ùå Error checking consecutive losses:`, error);\n      return null;\n    }\n  }\n\n  /**\n   * Check win rate over last 20 trades and emit warning if below 40%\n   * @param trades - Recent trade records\n   * @returns Protection action taken\n   */\n  public checkWinRate(trades: TradeRecord[]): string | null {\n    try {\n      // Get last N trades for win rate calculation\n      const recentTrades = trades\n        .sort((a, b) => b.timestamp - a.timestamp)\n        .slice(0, this.config.winRateTradeCount);\n\n      if (recentTrades.length < this.config.winRateTradeCount) {\n        // Not enough trades for meaningful win rate calculation\n        return null;\n      }\n\n      // Calculate win rate\n      const wins = recentTrades.filter(trade => trade.isWin).length;\n      const winRate = wins / recentTrades.length;\n      this.state.winRate = winRate;\n\n      // Check threshold\n      if (winRate < this.config.winRateThreshold) {\n        console.log(`‚ö†Ô∏è STRATEGY DEGRADATION: Win rate ${(winRate * 100).toFixed(1)}% < ${this.config.winRateThreshold * 100}% over last ${recentTrades.length} trades. Parameter review suggested.`);\n        \n        this.emit('strategy:degradation', this.state, winRate);\n        this.logProtectionEvent('STRATEGY_DEGRADATION', winRate * 100);\n        \n        return 'STRATEGY_DEGRADATION';\n      }\n\n      return null;\n    } catch (error) {\n      console.error(`‚ùå Error checking win rate:`, error);\n      return null;\n    }\n  }\n\n  /**\n   * Emergency flatten all positions and pause trading\n   * @param positions - All open positions\n   * @returns Promise with success status\n   */\n  public async emergencyFlatten(positions: Position[]): Promise<boolean> {\n    try {\n      console.log(`üö® EMERGENCY FLATTEN: Closing ${positions.length} positions`);\n      \n      let successCount = 0;\n      let failCount = 0;\n\n      // Close all positions with market orders\n      for (const position of positions) {\n        try {\n          const orderParams = {\n            phase: 'phase2' as const,\n            symbol: position.symbol,\n            side: position.side === 'LONG' ? 'Sell' as const : 'Buy' as const,\n            type: 'MARKET' as const,\n            qty: position.quantity,\n            leverage: position.leverage\n          };\n\n          const result = await this.bybitClient.placeOrderWithRetry(orderParams);\n          \n          if (result.status === 'FILLED') {\n            successCount++;\n            console.log(`‚úÖ Emergency closed: ${position.symbol} at ${result.price}`);\n          } else {\n            failCount++;\n            console.error(`‚ùå Failed to emergency close: ${position.symbol}`);\n          }\n        } catch (error) {\n          failCount++;\n          console.error(`‚ùå Error closing position ${position.symbol}:`, error);\n        }\n      }\n\n      // Set emergency pause\n      this.state.isEmergencyPaused = true;\n      this.state.emergencyPauseUntil = Date.now() + this.config.emergencyPauseDuration;\n\n      console.log(`üö® Emergency flatten complete: ${successCount} success, ${failCount} failed`);\n      console.log(`‚è∏Ô∏è Trading paused for ${this.config.emergencyPauseDuration / (1000 * 60 * 60)} hours`);\n\n      this.logProtectionEvent('EMERGENCY_FLATTEN_COMPLETE', successCount);\n\n      return failCount === 0;\n    } catch (error) {\n      console.error(`‚ùå Error in emergency flatten:`, error);\n      return false;\n    }\n  }\n\n  /**\n   * Add a completed trade to the tracking system\n   * @param trade - Trade record to add\n   */\n  public addTrade(trade: TradeRecord): void {\n    this.state.recentTrades.push(trade);\n    \n    // Keep only last 100 trades for memory efficiency\n    if (this.state.recentTrades.length > 100) {\n      this.state.recentTrades = this.state.recentTrades.slice(-100);\n    }\n\n    console.log(`üìä Trade recorded: ${trade.symbol} ${trade.side} ${trade.isWin ? 'WIN' : 'LOSS'} P&L: ${trade.pnl.toFixed(2)}`);\n    \n    // Check consecutive losses and win rate after each trade\n    this.checkConsecutiveLosses(this.state.recentTrades);\n    this.checkWinRate(this.state.recentTrades);\n  }\n\n  /**\n   * Set the start of day equity (for testing purposes)\n   * @param equity - Starting equity for the day\n   */\n  public setStartOfDayEquity(equity: number): void {\n    this.state.startOfDayEquity = equity;\n  }\n\n  /**\n   * Set the start of week equity (for testing purposes)\n   * @param equity - Starting equity for the week\n   */\n  public setStartOfWeekEquity(equity: number): void {\n    this.state.startOfWeekEquity = equity;\n  }\n\n  /**\n   * Get current drawdown state\n   * @returns Current drawdown state\n   */\n  public getState(): DrawdownState {\n    return { ...this.state };\n  }\n\n  /**\n   * Check if trading is currently paused due to emergency\n   * @returns True if trading is paused\n   */\n  public isEmergencyPaused(): boolean {\n    if (this.state.isEmergencyPaused && Date.now() > this.state.emergencyPauseUntil) {\n      // Emergency pause period has ended\n      this.state.isEmergencyPaused = false;\n      this.state.emergencyPauseUntil = 0;\n      console.log(`‚úÖ Emergency pause lifted. Trading resumed.`);\n      this.emit('emergency:resumed', this.state);\n    }\n    \n    return this.state.isEmergencyPaused;\n  }\n\n  /**\n   * Get current position size multiplier based on drawdown protection\n   * @returns Position size multiplier (0.5 = 50% reduction)\n   */\n  public getPositionSizeMultiplier(): number {\n    return this.state.positionSizeReduction;\n  }\n\n  /**\n   * Get current maximum leverage based on weekly drawdown\n   * @returns Maximum leverage allowed\n   */\n  public getMaxLeverage(): number {\n    return this.state.maxLeverageReduction \n      ? this.config.leverageReduction.to \n      : this.config.leverageReduction.from;\n  }\n\n  /**\n   * Check if new entries are allowed\n   * @returns True if new entries are allowed\n   */\n  public canOpenNewPositions(): boolean {\n    // Block new entries if:\n    // 1. Emergency paused\n    // 2. Daily drawdown >= 5%\n    return !this.isEmergencyPaused() && \n           this.state.dailyDrawdown < this.config.dailyDrawdownThresholds.level2;\n  }\n\n  /**\n   * Start monitoring drawdown protection\n   */\n  private startMonitoring(): void {\n    if (this.monitoringInterval) {\n      clearInterval(this.monitoringInterval);\n    }\n\n    this.monitoringInterval = setInterval(async () => {\n      await this.updateDrawdownState();\n    }, this.MONITORING_FREQUENCY);\n\n    console.log(`üõ°Ô∏è Drawdown Protector: Started monitoring (${this.MONITORING_FREQUENCY / 1000}s interval)`);\n  }\n\n  /**\n   * Stop monitoring drawdown protection\n   */\n  public stopMonitoring(): void {\n    if (this.monitoringInterval) {\n      clearInterval(this.monitoringInterval);\n      this.monitoringInterval = null;\n    }\n    console.log(`üõ°Ô∏è Drawdown Protector: Stopped monitoring`);\n  }\n\n  /**\n   * Update drawdown state with current equity\n   */\n  private async updateDrawdownState(): Promise<void> {\n    try {\n      const currentEquity = await this.bybitClient.getEquity();\n      \n      // Initialize baselines if not set\n      if (this.state.startOfDayEquity === 0) {\n        this.state.startOfDayEquity = currentEquity;\n      }\n      if (this.state.startOfWeekEquity === 0) {\n        this.state.startOfWeekEquity = currentEquity;\n      }\n\n      // Check all protection measures\n      await this.checkDailyDrawdown(currentEquity);\n      await this.checkWeeklyDrawdown(currentEquity);\n      \n      this.state.lastUpdate = Date.now();\n    } catch (error) {\n      console.error(`‚ùå Error updating drawdown state:`, error);\n    }\n  }\n\n  /**\n   * Get week number for date\n   * @param date - Date to get week number for\n   * @returns Week number\n   */\n  private getWeekNumber(date: Date): number {\n    const firstDayOfYear = new Date(date.getFullYear(), 0, 1);\n    const pastDaysOfYear = (date.getTime() - firstDayOfYear.getTime()) / 86400000;\n    return Math.ceil((pastDaysOfYear + firstDayOfYear.getDay() + 1) / 7);\n  }\n\n  /**\n   * Log drawdown protection event\n   * @param action - Action taken\n   * @param value - Associated value (percentage, count, etc.)\n   */\n  private logProtectionEvent(action: string, value: number): void {\n    const event = {\n      timestamp: Date.now(),\n      type: 'DRAWDOWN_PROTECTION',\n      action,\n      value,\n      currentEquity: this.state.currentEquity,\n      dailyDrawdown: this.state.dailyDrawdown * 100,\n      weeklyDrawdown: this.state.weeklyDrawdown * 100,\n      consecutiveLosses: this.state.consecutiveLosses,\n      winRate: this.state.winRate * 100\n    };\n\n    console.log(`üõ°Ô∏è DRAWDOWN_PROTECTION:`, JSON.stringify(event));\n    this.emit('protection:activated', this.state, action);\n  }\n\n  /**\n   * Update configuration\n   * @param newConfig - New configuration\n   */\n  public updateConfig(newConfig: Partial<DrawdownProtectorConfig>): void {\n    this.config = { ...this.config, ...newConfig };\n    console.log(`üõ°Ô∏è Drawdown Protector: Configuration updated`);\n  }\n\n  /**\n   * Reset drawdown state (for testing or manual reset)\n   */\n  public resetState(): void {\n    this.state = {\n      currentEquity: 0,\n      startOfDayEquity: 0,\n      startOfWeekEquity: 0,\n      dailyDrawdown: 0,\n      weeklyDrawdown: 0,\n      maxDailyDrawdown: 0,\n      maxWeeklyDrawdown: 0,\n      consecutiveLosses: 0,\n      recentTrades: [],\n      winRate: 0,\n      isEmergencyPaused: false,\n      emergencyPauseUntil: 0,\n      positionSizeReduction: 1.0,\n      maxLeverageReduction: false,\n      lastUpdate: Date.now()\n    };\n    console.log(`üõ°Ô∏è Drawdown Protector: State reset`);\n  }\n\n  /**\n   * Get statistics for monitoring\n   * @returns Drawdown statistics\n   */\n  public getStatistics(): {\n    dailyDrawdown: number;\n    weeklyDrawdown: number;\n    maxDailyDrawdown: number;\n    maxWeeklyDrawdown: number;\n    consecutiveLosses: number;\n    winRate: number;\n    totalTrades: number;\n    isEmergencyPaused: boolean;\n    positionSizeReduction: number;\n    maxLeverageReduction: boolean;\n  } {\n    return {\n      dailyDrawdown: this.state.dailyDrawdown * 100,\n      weeklyDrawdown: this.state.weeklyDrawdown * 100,\n      maxDailyDrawdown: this.state.maxDailyDrawdown * 100,\n      maxWeeklyDrawdown: this.state.maxWeeklyDrawdown * 100,\n      consecutiveLosses: this.state.consecutiveLosses,\n      winRate: this.state.winRate * 100,\n      totalTrades: this.state.recentTrades.length,\n      isEmergencyPaused: this.state.isEmergencyPaused,\n      positionSizeReduction: this.state.positionSizeReduction,\n      maxLeverageReduction: this.state.maxLeverageReduction\n    };\n  }\n\n  /**\n   * Cleanup resources\n   */\n  public destroy(): void {\n    this.stopMonitoring();\n    this.removeAllListeners();\n    console.log(`üõ°Ô∏è Drawdown Protector: Destroyed`);\n  }\n}\n\n// Export event interface for TypeScript\nexport declare interface DrawdownProtector {\n  on<U extends keyof DrawdownProtectorEvents>(event: U, listener: DrawdownProtectorEvents[U]): this;\n  emit<U extends keyof DrawdownProtectorEvents>(event: U, ...args: Parameters<DrawdownProtectorEvents[U]>): boolean;\n}"],"version":3}
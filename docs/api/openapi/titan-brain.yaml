openapi: 3.0.3
info:
  title: Titan Brain API
  description: |
    Master orchestrator for the Titan Trading System. Handles capital allocation, 
    risk management, phase coordination, and signal approval/veto decisions.
    
    The Brain operates as the central nervous system, receiving signals from all 
    phases and making allocation decisions based on performance, risk metrics, 
    and global portfolio constraints.
  version: 1.0.0
  contact:
    name: Titan Trading System
    email: support@titan-trading.com
  license:
    name: Proprietary
    url: https://titan-trading.com/license

servers:
  - url: http://localhost:3100
    description: Development server
  - url: https://titan-brain.yourdomain.com
    description: Production server

security:
  - hmacSignature: []
  - operatorAuth: []

paths:
  # Health and Status Endpoints
  /health:
    get:
      summary: Basic health check
      description: Returns basic health status for load balancers and monitoring
      tags: [Health]
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'
        '503':
          description: Service is unhealthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /status:
    get:
      summary: Detailed system status
      description: Returns comprehensive system status including all components
      tags: [Health]
      responses:
        '200':
          description: Detailed system status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SystemStatus'

  # Signal Processing Endpoints
  /signal:
    post:
      summary: Process intent signal
      description: |
        Process an intent signal from any phase. The Brain will evaluate the signal
        against current allocation, risk limits, and performance metrics to make
        an approval/veto decision.
      tags: [Signals]
      security:
        - hmacSignature: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/IntentSignal'
            examples:
              phase1_signal:
                summary: Phase 1 Scavenger Signal
                value:
                  signalId: "sig_phase1_btc_1702500000000"
                  phaseId: "phase1"
                  symbol: "BTCUSDT"
                  side: "BUY"
                  requestedSize: 1000
                  timestamp: 1702500000000
                  leverage: 15
              phase2_signal:
                summary: Phase 2 Hunter Signal
                value:
                  signalId: "sig_phase2_eth_1702500000000"
                  phaseId: "phase2"
                  symbol: "ETHUSDT"
                  side: "SELL"
                  requestedSize: 2000
                  leverage: 5
      responses:
        '200':
          description: Signal processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BrainDecision'
              examples:
                approved:
                  summary: Signal Approved
                  value:
                    signalId: "sig_phase1_btc_1702500000000"
                    approved: true
                    authorizedSize: 800
                    reason: "Approved with size reduction due to phase weight (80%)"
                    processingTime: 45
                vetoed:
                  summary: Signal Vetoed
                  value:
                    signalId: "sig_phase1_btc_1702500000000"
                    approved: false
                    authorizedSize: 0
                    reason: "Circuit breaker active - trading halted"
                    processingTime: 8
        '400':
          description: Invalid signal format
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '401':
          description: Invalid HMAC signature
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '409':
          description: Duplicate signal ID
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  # Phase-Specific Webhook Endpoints
  /webhook/phase1:
    post:
      summary: Phase 1 (Scavenger) webhook
      description: Receive signals from Phase 1 Scavenger trap system
      tags: [Webhooks]
      security:
        - hmacSignature: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PhaseSignal'
      responses:
        '200':
          description: Signal processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BrainDecision'

  /webhook/scavenger:
    post:
      summary: Scavenger webhook (alias for /webhook/phase1)
      description: Alternative endpoint for Phase 1 Scavenger
      tags: [Webhooks]
      security:
        - hmacSignature: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PhaseSignal'
      responses:
        '200':
          description: Signal processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BrainDecision'

  /webhook/phase2:
    post:
      summary: Phase 2 (Hunter) webhook
      description: Receive signals from Phase 2 Hunter holographic engine
      tags: [Webhooks]
      security:
        - hmacSignature: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PhaseSignal'
      responses:
        '200':
          description: Signal processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BrainDecision'

  /webhook/hunter:
    post:
      summary: Hunter webhook (alias for /webhook/phase2)
      description: Alternative endpoint for Phase 2 Hunter
      tags: [Webhooks]
      security:
        - hmacSignature: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PhaseSignal'
      responses:
        '200':
          description: Signal processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BrainDecision'

  /webhook/phase3:
    post:
      summary: Phase 3 (Sentinel) webhook
      description: Receive signals from Phase 3 Sentinel basis arbitrage system
      tags: [Webhooks]
      security:
        - hmacSignature: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PhaseSignal'
      responses:
        '200':
          description: Signal processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BrainDecision'

  /webhook/sentinel:
    post:
      summary: Sentinel webhook (alias for /webhook/phase3)
      description: Alternative endpoint for Phase 3 Sentinel
      tags: [Webhooks]
      security:
        - hmacSignature: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/PhaseSignal'
      responses:
        '200':
          description: Signal processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BrainDecision'

  # Dashboard Data Endpoints
  /dashboard:
    get:
      summary: Get dashboard data
      description: Returns comprehensive dashboard data for the console interface
      tags: [Dashboard]
      responses:
        '200':
          description: Dashboard data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DashboardData'

  /dashboard/extended:
    get:
      summary: Get extended dashboard data
      description: Returns dashboard data with additional metrics and historical data
      tags: [Dashboard]
      responses:
        '200':
          description: Extended dashboard data
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ExtendedDashboardData'

  /dashboard/export:
    get:
      summary: Export dashboard data
      description: Export dashboard data as downloadable JSON file
      tags: [Dashboard]
      responses:
        '200':
          description: Dashboard data export
          headers:
            Content-Disposition:
              schema:
                type: string
                example: 'attachment; filename="titan-brain-dashboard-1702500000000.json"'
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DashboardExport'

  # Phase Management Endpoints
  /phases/register:
    post:
      summary: Register phase webhook
      description: Register a phase's webhook URL for receiving notifications
      tags: [Phases]
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [phaseId, webhookUrl]
              properties:
                phaseId:
                  type: string
                  enum: [phase1, phase2, phase3]
                  description: Phase identifier
                webhookUrl:
                  type: string
                  format: uri
                  description: Webhook URL for phase notifications
              example:
                phaseId: "phase1"
                webhookUrl: "http://localhost:3001/brain-notification"
      responses:
        '200':
          description: Phase registered successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  phaseId:
                    type: string
                  webhookUrl:
                    type: string
                  timestamp:
                    type: integer

  /phases/status:
    get:
      summary: Get phase status
      description: Get status of all registered phases
      tags: [Phases]
      responses:
        '200':
          description: Phase status information
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/PhaseStatus'

  /phases/approval-rates:
    get:
      summary: Get approval rates
      description: Get signal approval rates per phase
      tags: [Phases]
      responses:
        '200':
          description: Approval rates by phase
          content:
            application/json:
              schema:
                type: object
                properties:
                  approvalRates:
                    type: object
                    additionalProperties:
                      type: number
                      format: float
                      minimum: 0
                      maximum: 1
                  timestamp:
                    type: integer

  # Circuit Breaker Management
  /breaker:
    get:
      summary: Get circuit breaker status
      description: Get current circuit breaker status and configuration
      tags: [Circuit Breaker]
      responses:
        '200':
          description: Circuit breaker status
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/BreakerStatus'

  /breaker/reset:
    post:
      summary: Reset circuit breaker
      description: Reset the circuit breaker (requires operator authentication)
      tags: [Circuit Breaker]
      security:
        - operatorAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [operatorId]
              properties:
                operatorId:
                  type: string
                  description: Operator identifier
                reason:
                  type: string
                  description: Reason for reset
              example:
                operatorId: "admin"
                reason: "Manual reset after market stabilization"
      responses:
        '200':
          description: Circuit breaker reset successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string
                  operatorId:
                    type: string
                  timestamp:
                    type: integer

  # Manual Override Management
  /admin/override:
    post:
      summary: Create manual override
      description: Create a manual allocation override (requires operator authentication)
      tags: [Admin]
      security:
        - operatorAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [operatorId, password, allocation, reason, durationHours]
              properties:
                operatorId:
                  type: string
                password:
                  type: string
                allocation:
                  $ref: '#/components/schemas/AllocationVector'
                reason:
                  type: string
                durationHours:
                  type: number
                  minimum: 1
                  maximum: 168
              example:
                operatorId: "admin"
                password: "secure_password"
                allocation:
                  w1: 0.2
                  w2: 0.8
                  w3: 0.0
                reason: "Market conditions favor swing trading"
                durationHours: 24
      responses:
        '200':
          description: Override created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ManualOverride'

  /admin/override/cancel:
    post:
      summary: Cancel manual override
      description: Cancel active manual override (requires operator authentication)
      tags: [Admin]
      security:
        - operatorAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [operatorId, password]
              properties:
                operatorId:
                  type: string
                password:
                  type: string
                reason:
                  type: string
      responses:
        '200':
          description: Override cancelled successfully

components:
  securitySchemes:
    hmacSignature:
      type: apiKey
      in: header
      name: x-signature
      description: HMAC-SHA256 signature of request body
    operatorAuth:
      type: http
      scheme: basic
      description: Operator credentials for admin functions

  schemas:
    # Core Signal Types
    IntentSignal:
      type: object
      required: [signalId, phaseId, symbol, side, requestedSize]
      properties:
        signalId:
          type: string
          description: Unique identifier for idempotency
          example: "sig_phase1_btc_1702500000000"
        phaseId:
          type: string
          enum: [phase1, phase2, phase3]
          description: Phase originating the signal
        symbol:
          type: string
          description: Trading pair symbol
          example: "BTCUSDT"
        side:
          type: string
          enum: [BUY, SELL]
          description: Trade direction
        requestedSize:
          type: number
          minimum: 0
          description: Requested position size in USD notional
          example: 1000
        timestamp:
          type: integer
          description: Unix timestamp in milliseconds
          example: 1702500000000
        leverage:
          type: number
          minimum: 1
          maximum: 100
          description: Requested leverage
          example: 15

    PhaseSignal:
      type: object
      required: [signal_id, symbol, direction]
      properties:
        signal_id:
          type: string
          description: Unique identifier
          example: "trap_btc_liquidation_1702500000000"
        symbol:
          type: string
          description: Trading pair symbol
          example: "BTCUSDT"
        direction:
          type: string
          enum: [LONG, SHORT]
          description: Trade direction
        size:
          type: number
          minimum: 0
          description: Position size in USD
          example: 500
        timestamp:
          type: integer
          description: Unix timestamp in milliseconds
        leverage:
          type: number
          minimum: 1
          maximum: 100
          description: Requested leverage

    BrainDecision:
      type: object
      required: [signalId, approved, authorizedSize, reason, timestamp]
      properties:
        signalId:
          type: string
          description: Original signal ID
        approved:
          type: boolean
          description: Whether the signal was approved
        authorizedSize:
          type: number
          minimum: 0
          description: Authorized position size (may be less than requested)
        reason:
          type: string
          description: Human-readable explanation
        allocation:
          $ref: '#/components/schemas/AllocationVector'
        performance:
          $ref: '#/components/schemas/PhasePerformance'
        risk:
          $ref: '#/components/schemas/RiskDecision'
        timestamp:
          type: integer
          description: Decision timestamp
        processingTime:
          type: number
          description: Processing time in milliseconds

    AllocationVector:
      type: object
      required: [w1, w2, w3, timestamp]
      properties:
        w1:
          type: number
          minimum: 0
          maximum: 1
          description: Phase 1 weight (0-1)
        w2:
          type: number
          minimum: 0
          maximum: 1
          description: Phase 2 weight (0-1)
        w3:
          type: number
          minimum: 0
          maximum: 1
          description: Phase 3 weight (0-1)
        timestamp:
          type: integer
          description: Allocation timestamp

    PhasePerformance:
      type: object
      properties:
        phaseId:
          type: string
        sharpeRatio:
          type: number
        totalPnL:
          type: number
        tradeCount:
          type: integer
        winRate:
          type: number
          minimum: 0
          maximum: 1
        avgWin:
          type: number
        avgLoss:
          type: number
        modifier:
          type: number

    RiskDecision:
      type: object
      properties:
        approved:
          type: boolean
        reason:
          type: string
        riskMetrics:
          type: object
          properties:
            currentLeverage:
              type: number
            projectedLeverage:
              type: number
            correlation:
              type: number
            portfolioDelta:
              type: number
            portfolioBeta:
              type: number

    # Dashboard Data Types
    DashboardData:
      type: object
      required: [nav, allocation, phaseEquity, riskMetrics, treasury, circuitBreaker, lastUpdated]
      properties:
        nav:
          type: number
          description: Net Asset Value (total equity)
        allocation:
          $ref: '#/components/schemas/AllocationVector'
        phaseEquity:
          type: object
          properties:
            phase1:
              type: number
            phase2:
              type: number
            phase3:
              type: number
        riskMetrics:
          type: object
          properties:
            globalLeverage:
              type: number
            netDelta:
              type: number
            correlationScore:
              type: number
            portfolioBeta:
              type: number
        treasury:
          $ref: '#/components/schemas/TreasuryStatus'
        circuitBreaker:
          $ref: '#/components/schemas/BreakerStatus'
        recentDecisions:
          type: array
          items:
            $ref: '#/components/schemas/BrainDecision'
        lastUpdated:
          type: integer
        manualOverride:
          $ref: '#/components/schemas/ManualOverride'
        warningBannerActive:
          type: boolean

    ExtendedDashboardData:
      allOf:
        - $ref: '#/components/schemas/DashboardData'
        - type: object
          properties:
            historicalAllocation:
              type: array
              items:
                $ref: '#/components/schemas/AllocationVector'
            sweepHistory:
              type: array
              items:
                type: object
            detailedRiskSnapshots:
              type: array
              items:
                type: object

    DashboardExport:
      type: object
      properties:
        version:
          type: string
        exportedAt:
          type: string
          format: date-time
        data:
          $ref: '#/components/schemas/DashboardData'

    TreasuryStatus:
      type: object
      properties:
        futuresWallet:
          type: number
        spotWallet:
          type: number
        totalSwept:
          type: number
        highWatermark:
          type: number
        lockedProfit:
          type: number
        riskCapital:
          type: number

    BreakerStatus:
      type: object
      properties:
        active:
          type: boolean
        type:
          type: string
          enum: [HARD, SOFT]
          nullable: true
        reason:
          type: string
          nullable: true
        triggeredAt:
          type: integer
          nullable: true
        dailyDrawdown:
          type: number
        consecutiveLosses:
          type: integer
        equityLevel:
          type: number
        cooldownEndsAt:
          type: integer
          nullable: true

    ManualOverride:
      type: object
      properties:
        active:
          type: boolean
        allocation:
          $ref: '#/components/schemas/AllocationVector'
        reason:
          type: string
        operatorId:
          type: string
        createdAt:
          type: integer
        expiresAt:
          type: integer

    PhaseStatus:
      type: object
      properties:
        phases:
          type: object
          additionalProperties:
            type: object
            properties:
              registered:
                type: boolean
              webhookUrl:
                type: string
                nullable: true
              lastSignal:
                type: integer
                nullable: true
              signalCount:
                type: integer
              approvalRate:
                type: number
        timestamp:
          type: integer

    # Health and Status Types
    HealthResponse:
      type: object
      properties:
        status:
          type: string
          enum: [ok, degraded, unhealthy]
        version:
          type: string
        uptime:
          type: string
        uptimeSeconds:
          type: integer
        timestamp:
          type: string
          format: date-time
        components:
          type: object

    SystemStatus:
      type: object
      properties:
        status:
          type: string
        version:
          type: string
        environment:
          type: string
        uptime:
          type: string
        components:
          type: object
        metrics:
          type: object
        system:
          type: object

    ErrorResponse:
      type: object
      required: [error, timestamp]
      properties:
        error:
          type: string
          description: Human-readable error message
        code:
          type: string
          description: Error code for programmatic handling
        timestamp:
          type: integer
          description: Error timestamp
        details:
          type: object
          description: Additional error context

tags:
  - name: Health
    description: Health check and system status endpoints
  - name: Signals
    description: Signal processing and decision making
  - name: Webhooks
    description: Phase-specific webhook endpoints
  - name: Dashboard
    description: Dashboard data and metrics
  - name: Phases
    description: Phase management and registration
  - name: Circuit Breaker
    description: Circuit breaker management
  - name: Admin
    description: Administrative functions and overrides